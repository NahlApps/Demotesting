<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Maison Hikari • الطلب</title>

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

  <!-- Bootstrap & Intl Tel Input -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/css/intlTelInput.css" rel="stylesheet"/>

  <meta name="theme-color" content="#0A0A0A" />
  <meta name="description" content="Maison Hikari — اطلب الآن" />

  <style>
    /* ===== Base from your last version ===== */
    :root{
      --bg:#FAFAFA; --ink:#0B0D13; --muted:#6B7280; --rule:#EAEAEA;
      --radius:14px; --radius-pill:999px; --shadow:0 10px 30px rgba(0,0,0,.08);
      --topbar-h:56px; --stepper-h:44px; --chips-h:56px;
    }
    html,body{height:100%}
    html{scroll-behavior:smooth;}
    body{
      font-family:'Cairo',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--ink); background:var(--bg); display:flex; flex-direction:column;
      -webkit-tap-highlight-color:transparent;
    }

    /* Header */
    .app-header{position:sticky;top:0;z-index:90;background:#fff;border-bottom:1px solid var(--rule);backdrop-filter:saturate(1.15) blur(6px)}
    .brand{font-weight:900}
    .cart-btn{position:relative;min-width:44px;min-height:44px;border-radius:var(--radius-pill);border:1px solid var(--rule);background:#fff}
    .cart-badge{position:absolute;top:-6px;inset-inline-start:-6px;background:#111;color:#fff;border-radius:999px;font-size:.75rem;padding:2px 7px;font-weight:900;box-shadow:0 6px 16px rgba(0,0,0,.18)}

    /* Stepper */
    .stepper-wrap{position:sticky; top:var(--topbar-h); z-index:85; background:#fff; border-bottom:1px solid var(--rule)}
    .stepper.nav{gap:8px;align-items:center;overflow:auto;padding:8px 0}
    .step.nav-link{display:flex;align-items:center;gap:8px;font-weight:800;color:#6b7280;white-space:nowrap}
    .step .dot{width:28px;height:28px;border-radius:999px;border:2px solid #d1d5db;display:inline-grid;place-items:center;font-size:.9rem}
    .step.active{color:#111}.step.active .dot{border-color:#111;color:#111}
    .step.done{color:#16a34a}.step.done .dot{border-color:#16a34a;color:#16a34a}
    .step .sep{width:24px;height:2px;background:#e5e7eb}

    /* Chips */
    .chips-wrap{
      position: sticky;
      top: calc(var(--topbar-h) + var(--stepper-h));
      z-index: 80;
      background:#fff;
      border-bottom:1px solid var(--rule);
      box-shadow: none;
    }
    body.scrolled .chips-wrap{ box-shadow:0 6px 16px rgba(0,0,0,.06); }
    #chips{ display:flex; flex-wrap:wrap; gap:8px; padding-block:10px; align-items:center; overflow:visible; }
    .chip{
      background:#F2F2F2;color:#111;border:1px solid var(--rule);
      border-radius:var(--radius-pill);padding:10px 14px;
      font-weight:800;font-size:.95rem;min-height:44px;transition:.18s; flex:0 0 auto;
    }
    .chip.active{background:#111;color:#fff;border-color:#111}
    .pill-clear{background:#fff;border:1px dashed #bbb}
    .searchbox{border:1px solid var(--rule);border-radius:var(--radius-pill);overflow:hidden;background:#fff}
    .searchbox input{border:0;padding:12px 16px;min-height:46px}

    /* Sections */
    .menu-section{ scroll-margin-top: calc(var(--topbar-h) + var(--stepper-h) + var(--chips-h) + 12px); padding-top: 8px; }
    .sec-title{margin:8px 0 12px 0;font-weight:900}

    .menu-grid{display:grid;gap:14px;grid-template-columns:repeat(1,minmax(0,1fr))}
    @media(min-width:640px){.menu-grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media(min-width:992px){.menu-grid{grid-template-columns:repeat(3,minmax(0,1fr))}}

    /* Cards */
    .dish{background:#fff;border:1px solid var(--rule);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);display:flex;flex-direction:column}
    .dish-img{width:100%;aspect-ratio:16/9;object-fit:cover;background:#f3f4f6}
    .dish-body{padding:12px 12px 14px}
    .dish h6{font-weight:900;margin:0 0 4px}
    .price{font-weight:900}
    .tags{display:flex;flex-wrap:wrap;gap:6px}
    .tag{border:1px solid var(--rule);border-radius:999px;padding:4px 8px;font-size:.8rem;color:#555}
    .add-wrap{margin-top:8px}
    .add-btn{width:100%;min-height:46px;border-radius:999px;border:1px solid #111;background:#111;color:#fff;font-weight:900}

    /* Cart & forms */
    .cart-card,.card-paper{background:#fff;border:1px solid var(--rule);border-radius:var(--radius);box-shadow:var(--shadow)}
    .line{display:flex;align-items:center;gap:10px;justify-content:space-between;padding:10px 0;border-bottom:1px dashed var(--rule)}
    .seg{display:inline-grid;grid-auto-flow:column;gap:8px;background:#F6F6F6;padding:6px;border-radius:999px;border:1px solid var(--rule)}
    .seg button{background:#fff;border:1px solid var(--rule);border-radius:999px;padding:11px 16px;min-height:46px;font-weight:900}
    .seg button[aria-pressed="true"]{background:#0A0A0A;color:#fff;border-color:#0A0A0A}
    #etaBadge{background:#E6F6FE;color:#0369A1;padding:4px 10px;border-radius:999px;font-weight:800}
    .inp-wrap{position:relative}
    .inp-wrap .ico{position:absolute;inset-inline-start:12px;inset-block-start:50%;transform:translateY(-50%);color:#6b7280;pointer-events:none}
    .pad-icon{padding-inline-start:42px}
    .form-control,.form-select{min-height:56px}

    /* Mini bar */
    .mini-bar{position:sticky;bottom:0;z-index:70;background:#0A0A0A;color:#fff;padding:10px 12px;border-top:1px solid rgba(255,255,255,.12);padding-bottom:calc(14px + env(safe-area-inset-bottom))}
    .mini-btn{min-height:52px;border-radius:999px;font-weight:900}

    /* Toast */
    #toasts{position:fixed;inset-block-start:14px;left:50%;transform:translateX(-50%);z-index:200;display:flex;flex-direction:column;gap:8px}
    .toast-msg{background:#111;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 14px 40px rgba(0,0,0,.25);font-weight:800}

    /* Overlays */
    .overlay{position:fixed; inset:0; z-index:999; display:none; align-items:center; justify-content:center; text-align:center; background:rgba(255,255,255,.92); backdrop-filter:blur(6px)}
    .overlay.show{display:flex}
    .overlay .box{background:#fff;border:1px solid var(--rule);border-radius:16px;padding:18px 20px;box-shadow:var(--shadow);min-width:220px}
    .overlay .msg{margin-top:.5rem;color:#555;font-weight:800}

    /* ===== Color system (gold/indigo) from last patch ===== */
    :root{
      --brand-50:#FFF8D9; --brand-300:#F7DC72; --brand-600:#F4CE14; --brand-800:#B38705; --brand-900:#8A6F00;
      --sakura-600:#E11D48; --indigo-600:#223554;
      --bg:#FAFAF9; --surface:#FFFFFF; --surface-2:#F5F5F4; --ink-900:#0B0D13; --ink-700:#2B2F36; --rule:#E7E5E4;
      --success-600:#16A34A; --warn-600:#F59E0B; --error-600:#DC2626; --info-600:#0369A1;
      --shadow:0 10px 30px rgba(0,0,0,.06);
    }
    body{ background:var(--bg); color:var(--ink-900); }
    .app-header,.stepper-wrap,.chips-wrap{ background:var(--surface); border-color:var(--rule); }
    .btn-dark,.add-btn,#optAddBtn,#confirmBtn,.mini-bar .btn,#thBackMenu{
      background:var(--brand-800)!important;border-color:var(--brand-800)!important;color:#fff!important;
    }
    .btn-dark:hover,.add-btn:hover,#optAddBtn:hover,#confirmBtn:hover,.mini-bar .btn:hover,#thBackMenu:hover{
      background:var(--brand-900)!important;border-color:var(--brand-900)!important;
    }
    .btn-outline-dark,#thBackCart{ color:var(--brand-800)!important;border-color:var(--brand-300)!important;background:transparent!important; }
    .btn-outline-dark:hover,#thBackCart:hover{ background:var(--brand-50)!important;border-color:var(--brand-600)!important;color:var(--ink-900)!important; }
    .chip{ background:var(--surface-2); border-color:var(--rule); color:var(--ink-900); }
    .chip.active{ background:var(--brand-800); border-color:var(--brand-800); color:#fff; }
    .pill-clear{ background:var(--surface); border-color:var(--brand-300); color:var(--brand-800); }
    .seg{ background:var(--surface-2); border-color:var(--rule); }
    .seg button[aria-pressed="true"]{ background:var(--brand-800); border-color:var(--brand-800); color:#fff; }
    .cart-badge{ background:var(--sakura-600); }
    .mini-bar{ background:linear-gradient(0deg, rgba(0,0,0,.72), rgba(0,0,0,.72)), var(--ink-900); }
    #etaBadge{ background:color-mix(in oklab, var(--indigo-600) 14%, white); color:var(--indigo-600); }
    a.link-dark{ color:var(--indigo-600) !important; } a.link-dark:hover{ text-decoration:underline; }
    .dish,.cart-card,.card-paper{ background:var(--surface); border-color:var(--rule); box-shadow:var(--shadow); }
    .line{ border-bottom-color:var(--rule); }
    .tag{ border-color:var(--rule); color:var(--ink-700); background:var(--surface); }
    @media (prefers-color-scheme: dark){
      :root{ --bg:#0D0F13; --surface:#111318; --surface-2:#1A1D23; --ink-900:#F5F6F7; --ink-700:#D6D8DC; --rule:#252930; --shadow:0 12px 34px rgba(0,0,0,.4); }
      .chip{ color:var(--ink-900); }
      .chip.active{ color:#111; background:var(--brand-600); border-color:var(--brand-600); }
      .btn-outline-dark{ color:var(--brand-600)!important; border-color:color-mix(in oklab, var(--brand-600) 40%, white); }
      .btn-outline-dark:hover{ background:color-mix(in oklab, var(--brand-600) 12%, white); }
    }

    /* ===== New: Cinematic layer (particles) ===== */
    #motionCanvas{
      position:fixed; inset:0; z-index:0; pointer-events:none; opacity:.25; mix-blend-mode:normal;
    }
    main, .app-header, .chips-wrap, .stepper-wrap{ position:relative; z-index:1; }

    /* ===== New: Countdown bar ===== */
    .countdown-bar{
      position:sticky; top:0; inset-inline:0; z-index:95;
      background:linear-gradient(90deg, var(--brand-800), var(--brand-900));
      color:#fff; padding:6px 0; border-bottom:1px solid rgba(255,255,255,.25);
    }
    .countdown-bar small{ opacity:.9 }
    .t-nums{ font-weight:900; letter-spacing:.5px; }

    /* ===== New: Orientation + Scroll-lock prompts ===== */
    #orientOverlay .box{ text-align:center }
    #scrollLockBtn{
      position:fixed; inset-inline-end:12px; inset-block-end:calc(14px + env(safe-area-inset-bottom));
      z-index:120; border-radius:999px; padding:.6rem .9rem; border:1px solid var(--brand-300);
      background:var(--surface); color:var(--ink-900); box-shadow:var(--shadow); font-weight:800;
    }
    #scrollLockBtn.locked{ background:var(--brand-800); color:#fff; border-color:var(--brand-800); }

    /* ===== New: KPI tiles (count up) ===== */
    .kpi-wrap{ display:grid; gap:12px; grid-template-columns:repeat(2,minmax(0,1fr)); }
    @media(min-width:768px){ .kpi-wrap{ grid-template-columns:repeat(4,1fr); } }
    .kpi{
      background:var(--surface); border:1px solid var(--rule); border-radius:16px; padding:14px; box-shadow:var(--shadow);
      transform:translateY(8px); opacity:0; transition:.5s ease;
    }
    .kpi.reveal{ transform:none; opacity:1; }
    .kpi .num{ font-size:1.8rem; font-weight:900; line-height:1; }
    .kpi .lbl{ color:var(--muted); font-weight:800; }

    /* ===== New: Calendar toggle (Track ↔ List) ===== */
    .cal-toggle{ display:inline-grid; grid-auto-flow:column; gap:6px; background:var(--surface-2); border:1px solid var(--rule); border-radius:999px; padding:6px; }
    .cal-toggle button{ border:1px solid var(--rule); background:#fff; border-radius:999px; padding:.55rem .9rem; font-weight:800; }
    .cal-toggle button[aria-pressed="true"]{ background:var(--brand-800); border-color:var(--brand-800); color:#fff; }
    .cal-views{ position:relative; min-height:180px; }
    .cal-view{ position:absolute; inset:0; opacity:0; transform:scale(.98); transition:.35s ease; pointer-events:none; }
    .cal-view.show{ opacity:1; transform:none; pointer-events:auto; }

    /* Track visualiser mock */
    .track{
      width:100%; height:100%; background:
        radial-gradient(60% 60% at 50% 50%, color-mix(in oklab, var(--brand-50) 50%, #fff) 0%, transparent 70%),
        linear-gradient(180deg, var(--surface), var(--surface));
      border:1px dashed var(--brand-300); border-radius:16px; position:relative; overflow:hidden;
    }
    .dot{ position:absolute; width:10px; height:10px; border-radius:999px; background:var(--sakura-600); box-shadow:0 0 0 6px color-mix(in oklab, var(--sakura-600) 20%, transparent); }

    /* ===== New: Gallery (lazy + reveal) ===== */
    .gallery{ display:grid; gap:10px; grid-template-columns:repeat(2,1fr); }
    @media(min-width:768px){ .gallery{ grid-template-columns:repeat(4,1fr); } }
    .gimg{
      width:100%; aspect-ratio:1/1; object-fit:cover; border-radius:12px; border:1px solid var(--rule);
      transform:translateY(10px); opacity:0; transition:.45s ease;
    }
    .gimg.reveal{ transform:none; opacity:1; }

    /* ===== Reduced motion friendly ===== */
    @media (prefers-reduced-motion: reduce){
      #motionCanvas{ display:none; }
      .kpi, .gimg{ transition:none; transform:none; opacity:1; }
      .cal-view{ transition:none; }
    }
  </style>
</head>
<body>
  <!-- Cinematic: lightweight particles canvas -->
  <canvas id="motionCanvas" aria-hidden="true"></canvas>

  <!-- Countdown bar -->
  <div class="countdown-bar" id="countdownBar" role="status" aria-live="polite">
    <div class="container d-flex gap-2 align-items-center justify-content-between">
      <div class="d-flex gap-2 align-items-center">
        <i class="fa-regular fa-clock"></i>
        <small>الحدث القادم يبدأ بعد:</small>
      </div>
      <div class="t-nums" id="countdownTxt">— يوم —:—:—</div>
    </div>
  </div>

  <!-- Overlays -->
  <div id="appLoading" class="overlay" aria-live="polite" aria-busy="true">
    <div class="box"><div class="spinner-border" role="status" aria-label="جارِ التحميل"></div><div class="msg">جاري تحميل القائمة…</div></div>
  </div>
  <div id="submitLoading" class="overlay" aria-live="polite" aria-busy="true">
    <div class="box"><div class="spinner-border" role="status" aria-label="جارِ المعالجة"></div><div class="msg">جارِ تأكيد الطلب…</div></div>
  </div>
  <div id="orientOverlay" class="overlay" aria-hidden="true">
    <div class="box">
      <div class="display-6">↻</div>
      <div class="msg">فضلاً قم بتدوير جهازك إلى الوضع الطولي</div>
      <button id="closeOrient" class="btn btn-dark mt-2">حسناً</button>
    </div>
  </div>
  <button id="scrollLockBtn" type="button" aria-pressed="false" title="قفل التمرير">قفل التمرير</button>

  <div id="toasts" aria-live="polite" aria-atomic="true"></div>

  <!-- Header -->
  <header class="app-header" id="topbar">
    <div class="container py-2 d-flex align-items-center justify-content-between gap-2">
      <div class="d-flex align-items-center gap-3">
        <img src="https://images.unsplash.com/photo-1544025162-d76694265947?q=80&w=120&auto=format&fit=crop" alt="" width="44" height="44" style="border-radius:12px;object-fit:cover" loading="lazy">
        <div>
          <div class="brand">Maison Hikari</div>
          <small class="text-secondary">الياباني المعاصر</small>
        </div>
      </div>
      <button id="openCart" class="cart-btn px-3" aria-label="السلة (الخطوة 2)">
        <i class="fa-solid fa-bag-shopping"></i>
        <span id="badge" class="cart-badge" aria-live="polite">0</span>
      </button>
    </div>
  </header>

  <!-- Stepper -->
  <div class="stepper-wrap" id="stepperWrap">
    <div class="container">
      <div class="nav stepper" aria-label="خطوات الطلب" role="tablist">
        <a class="nav-link step active" data-step="menu"   data-bs-toggle="tab" href="#tab-menu"   role="tab"><span class="dot">1</span> القائمة  <span class="sep"></span></a>
        <a class="nav-link step"          data-step="cart"   data-bs-toggle="tab" href="#tab-cart"   role="tab"><span class="dot">2</span> السلة   <span class="sep"></span></a>
        <a class="nav-link step"          data-step="data"   data-bs-toggle="tab" href="#tab-data"   role="tab"><span class="dot">3</span> البيانات<span class="sep"></span></a>
        <a class="nav-link step"          data-step="thanks" data-bs-toggle="tab" href="#tab-thanks" role="tab"><span class="dot">4</span> تمّ</a>
      </div>
    </div>
  </div>

  <!-- Chips + Search -->
  <div class="chips-wrap" id="chipsWrap">
    <div class="container">
      <div id="chips" aria-label="تصنيفات">
        <button class="chip active" data-target="#topOfMenu">الكل</button>
        <button class="chip" data-target="#sec-sushi">سوشي</button>
        <button class="chip" data-target="#sec-don">دون</button>
        <button class="chip" data-target="#sec-meat">لحوم</button>
        <button class="chip" data-target="#sec-drinks">مشروبات</button>

        <div class="ms-auto" style="min-width:260px;flex:1 1 260px">
          <div class="searchbox d-flex" role="search">
            <input id="q" type="search" class="form-control" placeholder="ابحث عن طبق … (سالمون، واجيو…)" autocomplete="off" aria-label="بحث"/>
            <button class="btn" aria-label="بحث"><i class="fa-solid fa-magnifying-glass"></i></button>
          </div>
        </div>

        <button id="clearFilters" class="chip pill-clear d-none" type="button">مسح التصفية</button>
      </div>
    </div>
  </div>

  <!-- Content -->
  <main id="topOfMenu">
    <div class="tab-content flex-1">
      <!-- MENU -->
      <section id="tab-menu" class="tab-pane fade show active">
        <div class="container py-3" id="menuContainer">
          <!-- KPIs -->
          <div class="kpi-wrap mb-3" id="kpis">
            <div class="kpi"><div class="num" data-countup="4.9" data-suffix="/5">0</div><div class="lbl">تقييم الضيوف</div></div>
            <div class="kpi"><div class="num" data-countup="42" data-suffix="+">0</div><div class="lbl">أطباق مميزة</div></div>
            <div class="kpi"><div class="num" data-countup="28" data-suffix="د">0</div><div class="lbl">متوسط التوصيل</div></div>
            <div class="kpi"><div class="num" data-countup="120" data-suffix="+">0</div><div class="lbl">طلبات اليوم</div></div>
          </div>

          <div id="menuSections"></div>
          <p id="emptyMsg" class="text-secondary text-center my-5 d-none">لا توجد أطباق مطابقة — جرّب كلمة بحث مختلفة</p>

          <!-- Gallery-led strip -->
          <h6 class="mt-4 mb-2 fw-bold">من أجوائنا</h6>
          <div class="gallery" id="gallery">
            <img class="gimg" loading="lazy" src="https://images.unsplash.com/photo-1553621042-f6e147245754?q=80&w=600&auto=format&fit=crop" alt="">
            <img class="gimg" loading="lazy" src="https://images.unsplash.com/photo-1515003197210-e0cd71810b5f?q=80&w=600&auto=format&fit=crop" alt="">
            <img class="gimg" loading="lazy" src="https://images.unsplash.com/photo-1553621042-4c1a2cd1b5b9?q=80&w=600&auto=format&fit=crop" alt="">
            <img class="gimg" loading="lazy" src="https://images.unsplash.com/photo-1607305387299-5c6f0a64a2ad?q=80&w=600&auto=format&fit=crop" alt="">
          </div>

          <div style="height:18vh"></div>
        </div>

        <!-- Mini checkout bar -->
        <div class="mini-bar">
          <div class="container d-flex align-items-center gap-2">
            <div class="flex-grow-1">
              <div class="d-flex align-items-baseline gap-2">
                <strong id="miniCount" aria-live="polite" aria-atomic="true">0 عنصر</strong>
                <span class="text-white-50">•</span>
                <strong id="miniTotal" aria-live="polite" aria-atomic="true">0.00 ر.س</strong>
              </div>
              <small class="text-white-50" id="miniHint">الضريبة ورسوم التوصيل تُضاف لاحقاً</small>
            </div>
            <a id="goCartBtn" href="#tab-cart" class="btn btn-light mini-btn text-dark disabled" aria-disabled="true">الانتقال للسلة</a>
          </div>
        </div>
      </section>

      <!-- CART -->
      <section id="tab-cart" class="tab-pane fade">
        <div class="container py-3">
          <div class="cart-card p-3 p-md-4">
            <h5 class="mb-3"><i class="fa-solid fa-bag-shopping"></i> السلة</h5>
            <div id="cartList" class="mb-3"></div>
            <div class="d-flex justify-content-between border-top pt-3">
              <span>الإجمالي</span> <strong id="cartTotal">0.00 ر.س</strong>
            </div>
            <div class="d-flex gap-2 mt-3">
              <a href="#tab-menu" class="btn btn-outline-dark flex-fill py-3 fw-bold" data-go="menu">رجوع للقائمة</a>
              <a id="toDataBtn" href="#tab-data" class="btn btn-dark flex-fill py-3 fw-bold disabled" aria-disabled="true" data-go="data">متابعة</a>
            </div>
          </div>
        </div>
      </section>

      <!-- CUSTOMER DATA -->
      <section id="tab-data" class="tab-pane fade">
        <div class="container py-4">
          <div class="d-flex align-items-center gap-2 mb-3">
            <div class="seg" aria-label="نوع الطلب">
              <button id="segPickup" class="btn" aria-pressed="true" type="button">استلام</button>
              <button id="segDelivery" class="btn" aria-pressed="false" type="button">توصيل</button>
            </div>
            <span id="etaBadge">ETA ~ 15</span>
          </div>

          <!-- Calendar toggle -->
          <div class="d-flex align-items-center justify-content-between mb-2">
            <h6 class="fw-bold mb-0">المواعيد المتاحة اليوم</h6>
            <div class="cal-toggle" role="tablist" aria-label="تبديل العرض">
              <button id="btnTrack" aria-pressed="true"  class="btn" type="button">المسار</button>
              <button id="btnList"  aria-pressed="false" class="btn" type="button">قائمة</button>
            </div>
          </div>
          <div class="cal-views mb-3">
            <div class="cal-view show" id="viewTrack" role="tabpanel" aria-hidden="false">
              <div class="track">
                <!-- dots placed via JS -->
              </div>
            </div>
            <div class="cal-view" id="viewList" role="tabpanel" aria-hidden="true">
              <div class="card-paper p-3">
                <div class="d-flex flex-wrap gap-2">
                  <!-- times via JS -->
                </div>
              </div>
            </div>
          </div>

          <div class="card-paper p-3 p-md-4">
            <div class="row g-3">
              <div class="col-12 col-md-6">
                <label class="form-label fw-bold" for="custName">الاسم</label>
                <div class="inp-wrap">
                  <i class="fa-regular fa-user ico"></i>
                  <input id="custName" class="form-control pad-icon" placeholder="اسمك الكامل" autocomplete="name"/>
                </div>
                <div id="err-name" class="text-danger small d-none mt-2">يرجى إدخال الاسم</div>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label fw-bold" for="custPhone">رقم الجوال</label>
                <input id="custPhone" class="form-control" type="tel" placeholder="5XXXXXXXX" inputmode="tel" autocomplete="tel"/>
                <div id="ok-phone" class="text-success small d-none mt-2">رقم صحيح ✅</div>
                <div id="err-phone" class="text-danger small d-none mt-2">رقم غير صالح</div>
              </div>
              <div class="col-12" id="addressWrap" style="display:none">
                <label class="form-label fw-bold" for="address">العنوان</label>
                <div class="inp-wrap">
                  <i class="fa-solid fa-location-dot ico"></i>
                  <input id="address" class="form-control pad-icon" placeholder="الحي، الشارع، علامة مميزة" autocomplete="street-address"/>
                </div>
                <div id="err-address" class="text-danger small d-none mt-2">أدخل العنوان للتوصيل</div>
                <div class="mt-2 text-secondary small"><i class="fa-regular fa-clock"></i> التوصيل عادة 30–45 دقيقة حسب الموقع.</div>
              </div>
              <div class="col-12">
                <label class="form-label fw-bold" for="notes">ملاحظات (اختياري)</label>
                <textarea id="notes" class="form-control" maxlength="140" placeholder="لا ثلج، حار، بدون بصل …"></textarea>
                <div class="d-flex small text-secondary mt-2">
                  <span>نحاول تنفيذ تفضيلاتك بقدر الإمكان</span>
                  <span class="ms-auto">(<span id="notesCount">0</span>/140)</span>
                </div>
              </div>
            </div>
          </div>

          <div class="d-flex gap-2 mt-3">
            <a href="#tab-cart" class="btn btn-outline-dark flex-fill py-3 fw-bold" data-go="cart">رجوع للسلة</a>
            <button id="confirmBtn" class="btn btn-dark flex-fill py-3 fw-bold" aria-label="تأكيد الطلب">تأكيد الطلب</button>
          </div>

          <div class="mt-3 small text-secondary d-flex gap-2 align-items-center">
            <i class="fa-brands fa-whatsapp"></i>
            <a class="link-dark" target="_blank" rel="noopener" href="https://wa.me/966509027172">محتاج مساعدة؟ تواصل عبر واتساب</a>
          </div>
        </div>
        <div style="height:18vh"></div>
      </section>

      <!-- THANKS -->
      <section id="tab-thanks" class="tab-pane fade">
        <div class="container py-5">
          <div class="card-paper p-4 text-center">
            <div class="display-6 mb-2">🎉 شكراً لطلبك</div>
            <p class="text-secondary mb-4">تم استلام طلبك بنجاح</p>
            <div class="d-flex flex-column align-items-center gap-3">
              <div class="ticket" id="thTicket">----</div>
              <div class="d-inline-flex flex-wrap gap-2 justify-content-center">
                <span class="badge bg-light text-dark border"><i class="fa-regular fa-calendar"></i> <span id="thDate">—</span></span>
                <span class="badge bg-light text-dark border"><strong>رقم الطلب:</strong>&nbsp;<span id="thOrderId">—</span></span>
                <span class="badge bg-light text-dark border"><strong>الإجمالي:</strong>&nbsp;<span id="thTotal">—</span></span>
                <span class="badge bg-light text-dark border" id="thType">—</span>
              </div>
              <div class="d-flex gap-2 mt-1">
                <button type="button" id="copyTicket" class="btn btn-outline-dark btn-sm"><i class="fa-regular fa-copy"></i> نسخ التذكرة</button>
                <button type="button" id="copySummary" class="btn btn-outline-dark btn-sm"><i class="fa-regular fa-clipboard"></i> نسخ الملخص</button>
              </div>
            </div>
            <div class="d-flex gap-2 justify-content-center mt-3">
              <a href="#tab-menu" id="thBackMenu" class="btn btn-dark" data-go="menu">طلب جديد</a>
              <a href="#tab-cart" id="thBackCart" class="btn btn-outline-dark" data-go="cart">عرض السلة</a>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- Options Modal -->
  <div class="modal fade" id="optModal" tabindex="-1" aria-labelledby="optTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title fw-bold" id="optTitle">خيارات إضافية</h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
        </div>
        <div class="modal-body">
          <div id="optSummary" class="mb-2 text-secondary small"></div>
          <div id="optForm" class="vstack gap-3"></div>
          <div class="d-flex align-items-center justify-content-between mt-3">
            <div class="input-group" style="width:150px">
              <button class="btn btn-outline-dark" id="optMinus" type="button" aria-label="إنقاص">−</button>
              <input id="optQty" class="form-control text-center" type="number" min="1" step="1" value="1">
              <button class="btn btn-dark" id="optPlus" type="button" aria-label="زيادة">+</button>
            </div>
            <div class="fw-bold"><span>السعر:</span> <span id="optPrice">0.00 ر.س</span></div>
          </div>
          <div class="mt-3">
            <label class="form-label fw-bold" for="optNotes">ملاحظات للطبق (اختياري)</label>
            <input id="optNotes" class="form-control" maxlength="100" placeholder="بدون بصل، صوص أقل …">
          </div>
        </div>
        <div class="modal-footer">
          <button id="optAddBtn" class="btn btn-dark w-100 fw-bold" type="button">إضافة للسلة</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Templates -->
  <template id="dishTpl">
    <div class="dish" data-cat="">
      <img class="dish-img" alt="" width="1200" height="675" loading="lazy"/>
      <div class="dish-body">
        <div class="d-flex align-items-center justify-content-between mb-1">
          <strong class="price"></strong>
          <div class="tags"></div>
        </div>
        <h6 class="title"></h6>
        <div class="text-secondary small mb-1 desc"></div>
        <div class="add-wrap">
          <button class="add-btn" type="button" aria-label="أضف للسلة">أضف للسلة</button>
        </div>
      </div>
    </div>
  </template>

  <template id="cartLineTpl">
    <div class="line">
      <div class="d-flex align-items-center gap-2">
        <button class="btn btn-sm btn-outline-dark rounded-pill minus" aria-label="إنقاص">−</button>
        <strong class="qty" aria-live="polite">1</strong>
        <button class="btn btn-sm btn-dark rounded-pill plus" aria-label="زيادة">+</button>
      </div>
      <div class="flex-grow-1 text-truncate text-end">
        <div class="fw-bold name"></div>
        <div class="small text-secondary">× <span class="unit">0.00</span> ر.س</div>
      </div>
      <div class="text-nowrap fw-bold total">0.00 ر.س</div>
    </div>
  </template>

  <!-- JS libs -->
  <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/intlTelInputWithUtils.js"></script>

  <script>
  const GAS_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxyGwCUJRwjVfJDtq5bxqN9Thm_KU4zOfNiNt0ENtW2jbDonr_yp3W2xDZCNXkmSHZNLw/exec';
  const FREE_SHIP = 79;

  // === Cinematic particles (very light) ===
  function initCinematic(){
    const canvas = document.getElementById('motionCanvas');
    const ctx = canvas.getContext('2d');
    let w=canvas.width=innerWidth*devicePixelRatio, h=canvas.height=innerHeight*devicePixelRatio;
    let particles = Array.from({length: 36}, ()=>({
      x: Math.random()*w, y: Math.random()*h, r: 1 + Math.random()*2,
      vx: (Math.random()-.5)*0.08*devicePixelRatio, vy: (Math.random()-.5)*0.08*devicePixelRatio
    }));
    const gold = getComputedStyle(document.documentElement).getPropertyValue('--brand-800').trim() || '#B38705';

    function draw(){
      ctx.clearRect(0,0,w,h);
      ctx.globalAlpha = .35;
      particles.forEach(p=>{
        p.x+=p.vx; p.y+=p.vy;
        if(p.x<0||p.x>w) p.vx*=-1; if(p.y<0||p.y>h) p.vy*=-1;
        ctx.beginPath(); ctx.fillStyle=gold; ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
      });
      requestAnimationFrame(draw);
    }
    addEventListener('resize', ()=>{ w=canvas.width=innerWidth*devicePixelRatio; h=canvas.height=innerHeight*devicePixelRatio; }, {passive:true});
    if(!matchMedia('(prefers-reduced-motion: reduce)').matches) draw();
  }

  // === Countdown (edit date/time below) ===
  const NEXT_EVENT_ISO = '2025-11-01T20:00:00+03:00'; // Riyadh time
  function initCountdown(){
    const box=document.getElementById('countdownTxt');
    function tick(){
      const now=new Date();
      const target=new Date(NEXT_EVENT_ISO);
      let diff = Math.max(0, target-now);
      const d = Math.floor(diff/86400000); diff%=86400000;
      const h = Math.floor(diff/3600000);  diff%=3600000;
      const m = Math.floor(diff/60000);    diff%=60000;
      const s = Math.floor(diff/1000);
      box.textContent = `${d} يوم ${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }
    tick(); setInterval(tick,1000);
  }

  // === Orientation overlay + Scroll lock ===
  function initPrompts(){
    const overlay=document.getElementById('orientOverlay');
    const closeBtn=document.getElementById('closeOrient');
    function check(){
      const isPortrait = innerHeight>innerWidth;
      overlay.classList.toggle('show', isPortrait);
    }
    closeBtn.onclick=()=>overlay.classList.remove('show');
    addEventListener('resize', check, {passive:true});
    check();

    const btn=document.getElementById('scrollLockBtn');
    btn.addEventListener('click', ()=>{
      const locked = btn.getAttribute('aria-pressed')==='true';
      if(locked){
        document.body.style.overflow=''; btn.setAttribute('aria-pressed','false'); btn.classList.remove('locked'); btn.textContent='قفل التمرير';
      }else{
        document.body.style.overflow='hidden'; btn.setAttribute('aria-pressed','true'); btn.classList.add('locked'); btn.textContent='عودة للتمرير';
      }
    });
  }

  // === Reveal on scroll for KPI + Gallery ===
  function initReveals(){
    const obs = new IntersectionObserver((entries)=>{
      entries.forEach(e=>{
        if(e.isIntersecting){
          e.target.classList.add('reveal');
          if(e.target.dataset.countup) countUp(e.target);
          obs.unobserve(e.target);
        }
      });
    }, {threshold:.35});
    document.querySelectorAll('.kpi, .gimg').forEach(el=>obs.observe(el));
  }
  function countUp(numEl){
    const target = parseFloat(numEl.dataset.countup||'0') || 0;
    const suffix = numEl.dataset.suffix||'';
    let cur = 0; const dur=900; const start=performance.now();
    function step(t){
      const p=Math.min(1,(t-start)/dur);
      cur = target * (0.5 - Math.cos(Math.PI*p)/2); // ease
      numEl.textContent = (target%1?cur.toFixed(1):Math.round(cur)) + suffix;
      if(p<1) requestAnimationFrame(step);
      else numEl.textContent = (target%1?target.toFixed(1):Math.round(target)) + suffix;
    }
    requestAnimationFrame(step);
  }

  // === Calendar toggle mock ===
  function initCalendar(){
    const btnTrack=document.getElementById('btnTrack');
    const btnList=document.getElementById('btnList');
    const vTrack=document.getElementById('viewTrack');
    const vList =document.getElementById('viewList');

    function show(track){
      btnTrack.setAttribute('aria-pressed', String(track));
      btnList .setAttribute('aria-pressed', String(!track));
      vTrack.classList.toggle('show', track); vTrack.setAttribute('aria-hidden', String(!track));
      vList .classList.toggle('show', !track); vList .setAttribute('aria-hidden', String(track));
    }
    btnTrack.onclick=()=>show(true);
    btnList .onclick=()=>show(false);
    show(true);

    // place dots along a pseudo-track
    const track=vTrack.querySelector('.track');
    const dots = Array.from({length: 10}, (_,i)=> i);
    dots.forEach(i=>{
      const d=document.createElement('div'); d.className='dot';
      d.style.insetInlineStart= (10 + i*8) + '%';
      d.style.insetBlockStart = (30 + Math.sin(i/1.5)*12 + 10) + '%';
      d.title = `الساعة ${12+i}:00`;
      track.appendChild(d);
    });

    // times list
    const list=vList.querySelector('.d-flex');
    ['12:00','13:00','14:00','15:00','16:00','17:00','18:00','19:00','20:00'].forEach(t=>{
      const b=document.createElement('button');
      b.className='btn btn-outline-dark';
      b.textContent=t;
      list.appendChild(b);
    });
  }

  // === Original App Logic ===
  window.addEventListener('DOMContentLoaded', () => {
    // cinematic + prompts + countdown + reveals + calendar
    initCinematic(); initPrompts(); initCountdown(); initReveals(); initCalendar();

    const state = { q:'', cart:{}, menu:[], unlockThanks:false, active:'menu' };
    const fmt = new Intl.NumberFormat('ar-SA', { style:'currency', currency:'SAR' });

    /* Sticky helpers */
    const topbarEl   = document.getElementById('topbar');
    const stepperEl  = document.getElementById('stepperWrap');
    const chipsWrap  = document.getElementById('chipsWrap');
    const setStickyVars = () => {
      const topH   = Math.round(topbarEl?.getBoundingClientRect().height || 56);
      const stepH  = Math.round(stepperEl?.getBoundingClientRect().height || 0);
      const chipsH = Math.round(chipsWrap?.getBoundingClientRect().height || 56);
      document.documentElement.style.setProperty('--topbar-h', topH + 'px');
      document.documentElement.style.setProperty('--stepper-h', stepH + 'px');
      document.documentElement.style.setProperty('--chips-h', chipsH + 'px');
    };
    window.addEventListener('resize', setStickyVars, {passive:true});
    window.addEventListener('scroll', ()=>document.body.classList.toggle('scrolled', window.scrollY>6), {passive:true});

    /* Stepper guards */
    const steps=['menu','cart','data','thanks'];
    function setStep(active){
      state.active=active;
      document.querySelectorAll('.stepper .step').forEach((el,idx)=>{
        const id=el.dataset.step;
        el.classList.remove('active','done'); if(id===active) el.classList.add('active');
        const i=steps.indexOf(active); if(idx<i) el.classList.add('done');
      });
      setStickyVars();
    }
    function showTab(href){ const a=document.querySelector(`[data-bs-toggle="tab"][href="${href}"]`); if(a) bootstrap.Tab.getOrCreateInstance(a).show(); }
    function cartCount(){ return Object.values(state.cart).reduce((a,b)=>a+b.qty,0); }
    function canGo(t){ if(t==='menu') return true; if(t==='cart'||t==='data') return cartCount()>0; if(t==='thanks') return state.unlockThanks; return false;}
    function toast(msg){ const box=document.getElementById('toasts'); const el=document.createElement('div'); el.className='toast-msg'; el.textContent=msg; box.appendChild(el); setTimeout(()=>{el.style.opacity='0'; el.style.transform='translateY(-6px)'; setTimeout(()=>el.remove(),180);},2200); }
    function safeGo(t){ if(!canGo(t)){ toast(t==='thanks'?'أكمل تأكيد الطلب أولاً':'أضِف عناصر للسلة أولاً'); showTab('#tab-'+state.active); return false;} showTab('#tab-'+t); return true; }
    document.addEventListener('shown.bs.tab', e=>{ const href=e.target?.getAttribute('href'); if(href==='#tab-menu') setStep('menu'); if(href==='#tab-cart') setStep('cart'); if(href==='#tab-data') setStep('data'); if(href==='#tab-thanks') setStep('thanks'); history.replaceState(null,'',href); setStickyVars(); });
    document.body.addEventListener('click', (e)=>{ const a=e.target.closest('a[href^="#tab-"],[data-go]'); if(!a) return; e.preventDefault(); const to=a.dataset.go||(a.getAttribute('href')||'').replace('#tab-',''); if(['menu','cart','data','thanks'].includes(to)) safeGo(to); });

    /* DOM refs */
    const clearFilters=document.getElementById('clearFilters');
    const search=document.getElementById('q');
    const sectionsRoot=document.getElementById('menuSections');
    const emptyMsg=document.getElementById('emptyMsg');
    const dishTpl=document.getElementById('dishTpl');
    const cartList=document.getElementById('cartList');
    const cartLineTpl=document.getElementById('cartLineTpl');
    const badge=document.getElementById('badge');
    const miniCount=document.getElementById('miniCount');
    const miniTotal=document.getElementById('miniTotal');
    const miniHint=document.getElementById('miniHint');
    const goCartBtn=document.getElementById('goCartBtn');
    const toDataBtn=document.getElementById('toDataBtn');
    const cartTotal=document.getElementById('cartTotal');

    /* Menu fetch */
    async function fetchMenu(){
      try{ const r=await fetch(GAS_WEBAPP_URL+'?action=menu.list'); const j=await r.json(); return j.ok?(j.data||[]):[]; }
      catch{ return []; }
    }

    /* Categories */
    const ORDERED_CATS = [
      {key:'sushi',  label:'سوشي'},
      {key:'don',    label:'دون'},
      {key:'meat',   label:'لحوم'},
      {key:'drinks', label:'مشروبات'}
    ];
    function groupByCat(menu){
      const groups = {};
      menu.forEach(d=>{
        const key = (d.cat||'').toLowerCase();
        groups[key] = groups[key] || [];
        groups[key].push(d);
      });
      return groups;
    }

    function imgFallback(el){
      el.src='data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="675"><rect width="100%" height="100%" fill="#f3f4f6"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#9ca3af" font-family="Arial" font-size="28">لا صورة</text></svg>`);
    }

    /* Render sections */
    function renderSections(){
      const q=(state.q||'').trim().toLowerCase();
      const groups = groupByCat(state.menu);
      sectionsRoot.innerHTML='';
      let totalMatches=0;

      ORDERED_CATS.forEach(({key,label})=>{
        const items = (groups[key]||[]).filter(d=>{
          const inTxt = !q || [d.title||'',d.desc||''].join(' ').toLowerCase().includes(q);
          return inTxt;
        });
        if(!items.length) return;

        const sec = document.createElement('section');
        sec.className = 'menu-section';
        sec.id = 'sec-'+key;

        const title = document.createElement('h5');
        title.className = 'sec-title';
        title.textContent = label;
        sec.appendChild(title);

        const grid = document.createElement('div');
        grid.className = 'menu-grid';

        items.forEach(d=>{
          const node=dishTpl.content.firstElementChild.cloneNode(true);
          node.dataset.cat = key;

          const img=node.querySelector('.dish-img');
          img.alt=d.title||''; img.addEventListener('error',()=>imgFallback(img));
          if(d.img && /^https?:\/\//.test(d.img)) img.src=d.img; else imgFallback(img);

          node.querySelector('.title').textContent=d.title||'—';
          node.querySelector('.desc').textContent=d.desc||'';
          node.querySelector('.price').textContent=fmt.format(Number(d.price||0));
          const tags=node.querySelector('.tags'); (d.tags||[]).slice(0,2).forEach(t=>{ const s=document.createElement('span'); s.className='tag'; s.textContent=t; tags.appendChild(s); });
          node.querySelector('.add-btn').addEventListener('click', ()=> addLine(d,1));

          grid.appendChild(node);
        });

        sec.appendChild(grid);
        sectionsRoot.appendChild(sec);
        totalMatches += items.length;
      });

      emptyMsg.classList.toggle('d-none', totalMatches>0);
      clearFilters.classList.toggle('d-none', !state.q.trim());

      setStickyVars();
      setupScrollspy();
    }

    /* Chips: click -> scroll */
    document.getElementById('chips').addEventListener('click',(e)=>{
      const b=e.target.closest('.chip[data-target]');
      if(!b) return;
      document.querySelector(b.dataset.target)?.scrollIntoView({behavior:'smooth', block:'start'});
    });

    /* Scrollspy */
    let spyObserver=null;
    function setupScrollspy(){
      if(spyObserver){ spyObserver.disconnect(); spyObserver=null; }
      const chips = [...document.querySelectorAll('#chips .chip[data-target]')];

      spyObserver = new IntersectionObserver((entries)=>{
        const visible = entries.filter(e=>e.isIntersecting)
                               .sort((a,b)=>b.intersectionRatio - a.intersectionRatio)[0];
        if(!visible) return;
        const id = '#'+visible.target.id;
        chips.forEach(c=>c.classList.toggle('active', c.dataset.target===id || (id==='#topOfMenu' && c.dataset.target==='#topOfMenu')));
      },{
        rootMargin: '-40% 0px -50% 0px',
        threshold: [0.2,0.4,0.6,0.8,1]
      });

      document.querySelectorAll('.menu-section').forEach(sec=>spyObserver.observe(sec));
      const top = document.getElementById('topOfMenu'); if(top) spyObserver.observe(top);
    }

    /* Search */
    let t=null;
    search.addEventListener('input', e=>{
      clearTimeout(t);
      t=setTimeout(()=>{ state.q=e.target.value||''; renderSections(); }, 160);
    });
    clearFilters.addEventListener('click', ()=>{
      state.q=''; search.value='';
      renderSections();
      document.getElementById('topOfMenu').scrollIntoView({behavior:'smooth',block:'start'});
    });

    /* Cart */
    function stableId(str){ let h=0; for(let i=0;i<str.length;i++){ h=((h<<5)-h)+str.charCodeAt(i); h|=0;} return 'l_'+Math.abs(h).toString(36); }
    function cartArr(){ return Object.values(state.cart); }
    function totals(){ const arr=cartArr(); return {count:arr.reduce((a,b)=>a+b.qty,0), total:arr.reduce((a,b)=>a+b.qty*b.unitPrice,0), arr}; }
    function bump(){
      const t=totals();
      badge.textContent=t.count; miniCount.textContent=`${t.count} عنصر`; miniTotal.textContent=fmt.format(t.total); cartTotal.textContent=fmt.format(t.total);
      const need=Math.max(0, FREE_SHIP - t.total); miniHint.textContent = need>0 ? `تبقى ${need.toFixed(2)} ر.س للتوصيل المجاني 🎁` : `🎁 حصلت على توصيل مجاني`;
      localStorage.setItem('hk_cart_v3', JSON.stringify(state.cart));
      const has=t.count>0; goCartBtn.classList.toggle('disabled',!has); goCartBtn.setAttribute('aria-disabled',String(!has)); toDataBtn.classList.toggle('disabled',!has); toDataBtn.setAttribute('aria-disabled',String(!has));
      renderCartList();
    }
    function addLine(item, qty=1){
      const key=stableId(JSON.stringify({id:item.id, price:item.price}));
      const exist=state.cart[key];
      if(exist) exist.qty+=qty;
      else state.cart[key]={lineId:key, id:item.id, title:item.title, unitPrice:Number(item.price||0), qty};
      bump(); toast(`أُضيف ${item.title} ✅`);
    }
    function renderCartList(){
      cartList.innerHTML='';
      const {arr}=totals();
      if(!arr.length){ const p=document.createElement('p'); p.className='text-secondary text-center my-4'; p.textContent='السلة فارغة'; cartList.appendChild(p); return; }
      arr.forEach(it=>{
        const row=cartLineTpl.content.firstElementChild.cloneNode(true);
        row.querySelector('.name').textContent=it.title;
        row.querySelector('.unit').textContent=Number(it.unitPrice||0).toFixed(2);
        row.querySelector('.qty').textContent=it.qty;
        row.querySelector('.total').textContent=fmt.format(it.qty*it.unitPrice);
        row.querySelector('.minus').addEventListener('click', ()=>{ if(state.cart[it.lineId].qty>1) state.cart[it.lineId].qty--; else delete state.cart[it.lineId]; bump(); });
        row.querySelector('.plus').addEventListener('click',  ()=>{ state.cart[it.lineId].qty++; bump(); });
        cartList.appendChild(row);
      });
    }
    const saved=localStorage.getItem('hk_cart_v3'); if(saved){ try{ state.cart=JSON.parse(saved)||{}; }catch{} }
    document.getElementById('openCart').addEventListener('click', ()=>safeGo('cart'));

    /* Data form */
    const segPick=document.getElementById('segPickup');
    const segDel=document.getElementById('segDelivery');
    const addrWrap=document.getElementById('addressWrap');
    const nameEl=document.getElementById('custName');
    const phoneEl=document.getElementById('custPhone');
    const addrEl=document.getElementById('address');
    const notesEl=document.getElementById('notes');
    const confirmBtn=document.getElementById('confirmBtn');
    const iti=window.intlTelInput(phoneEl,{ initialCountry:'sa', onlyCountries:['sa','ae','bh','kw','om','qa'], utilsScript:'https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/utils.js', separateDialCode:true });
    function setType(delivery){ segPick.setAttribute('aria-pressed',String(!delivery)); segDel.setAttribute('aria-pressed',String(delivery)); addrWrap.style.display=delivery?'':'none'; if(delivery) setTimeout(()=>addrEl.focus(),80); }
    segPick.onclick=()=>setType(false); segDel.onclick=()=>setType(true); setType(false);
    notesEl.addEventListener('input', ()=>{ document.getElementById('notesCount').textContent=(notesEl.value||'').length; });
    function validate(){
      const nameOk=(nameEl.value||'').trim().length>1;
      let phoneOk=false; try{ phoneOk=iti.isValidNumber(); }catch(_){ phoneOk=(phoneEl.value||'').trim().length>=8; }
      const delivery=segDel.getAttribute('aria-pressed')==='true';
      const addressOk=!delivery || (addrEl.value||'').trim().length>3;
      document.getElementById('err-name').classList.toggle('d-none',nameOk);
      document.getElementById('ok-phone').classList.toggle('d-none',!phoneOk);
      document.getElementById('err-phone').classList.toggle('d-none',phoneOk);
      document.getElementById('err-address').classList.toggle('d-none',addressOk);
      return nameOk && phoneOk && addressOk;
    }
    ['input','blur'].forEach(ev=>{
      nameEl.addEventListener(ev, validate);
      phoneEl.addEventListener(ev, ()=>setTimeout(validate, ev==='blur'?0:120));
      addrEl.addEventListener(ev, validate);
    });

    /* Thanks */
    const thOrderId=document.getElementById('thOrderId');
    const thTotal=document.getElementById('thTotal');
    const thType=document.getElementById('thType');
    const thTicket=document.getElementById('thTicket');
    const thDate=document.getElementById('thDate');

    function todayKey(){
      const d=new Date(); const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }
    function nextDailyTicketLocal(){
      const key=todayKey(); const savedDay=localStorage.getItem('hk_ticket_day'); let seq=Number(localStorage.getItem('hk_ticket_seq')||0);
      if(savedDay!==key) seq=0; seq=(seq%9999)+1; localStorage.setItem('hk_ticket_day',key); localStorage.setItem('hk_ticket_seq',String(seq)); return String(seq).padStart(4,'0');
    }
    function setThankDate(){ const d=new Date(); thDate.textContent=d.toLocaleDateString('ar-SA',{ weekday:'short', year:'numeric', month:'2-digit', day:'2-digit'}); }
    async function copy(text){ try{ await navigator.clipboard.writeText(text); toast('تم النسخ ✅'); }catch{ toast('تعذّر النسخ'); } }

    async function createOrder(payload){
      const r=await fetch(GAS_WEBAPP_URL+'?action=order.create',{ method:'POST', headers:{'Content-Type':'text/plain'}, body:JSON.stringify(payload) });
      return r.json();
    }

    function renderThanks({orderId, totals, payload}){
      const t4 = nextDailyTicketLocal(); thTicket.textContent=t4; setThankDate();
      thOrderId.textContent = orderId || '—';
      thTotal.textContent = typeof totals?.total === 'number' ? fmt.format(totals.total) : fmt.format(totals || 0);
      thType.textContent  = payload.type==='delivery'?'نوع الطلب: توصيل':'نوع الطلب: استلام';
      document.getElementById('copyTicket').onclick = ()=>copy(`تذكرة ${t4} • ${todayKey()}`);
      document.getElementById('copySummary').onclick = ()=>copy(`طلب Maison Hikari\nتذكرة: ${t4}\n${thType.textContent}\nالإجمالي: ${thTotal.textContent}`);
    }

    confirmBtn.onclick=async()=>{
      const t=totals();
      if(t.count===0){ toast('السلة فارغة'); safeGo('menu'); return; }
      if(!validate()){ window.scrollTo({top:0,behavior:'smooth'}); toast('أكمل البيانات المطلوبة'); return; }

      let phone=phoneEl.value.trim(); try{ phone=iti.getNumber(); }catch(_){}
      const payload={
        type: segDel.getAttribute('aria-pressed')==='true'?'delivery':'pickup',
        name: nameEl.value.trim(), phone, address: addrEl.value.trim(), notes: notesEl.value.trim(),
        items: t.arr.map(x=>({ id:x.id, title:x.title, qty:x.qty, price:x.unitPrice }))
      };

      const submitLoading=document.getElementById('submitLoading');
      submitLoading.classList.add('show');
      confirmBtn.disabled=true; confirmBtn.classList.add('disabled');

      try{
        const res=await createOrder(payload);
        if(res && res.ok){
          localStorage.setItem('hk_user_v1', JSON.stringify({name:payload.name, phone:phoneEl.value, address:payload.address}));
          state.cart={}; bump();
          renderThanks({ orderId:res.orderId, totals:res.totals||t.total, payload });
          state.unlockThanks = true; safeGo('thanks');
        } else { toast('تعذر إرسال الطلب، حاول لاحقًا'); }
      }catch{ toast('خطأ في الاتصال بالخدمة'); }
      finally{
        confirmBtn.disabled=false; confirmBtn.classList.remove('disabled');
        submitLoading.classList.remove('show');
      }
    };

    /* INIT */
    (async()=>{
      const appLoading=document.getElementById('appLoading');
      appLoading.classList.add('show');
      try{
        const savedInfo=JSON.parse(localStorage.getItem('hk_user_v1')||'{}');
        if(savedInfo.name) document.getElementById('custName').value=savedInfo.name;
        if(savedInfo.phone) document.getElementById('custPhone').value=savedInfo.phone;
        if(savedInfo.address){ document.getElementById('address').value=savedInfo.address; setType(true); }
      }catch{}
      state.menu=await fetchMenu();
      if(!state.menu.length) setTimeout(()=>toast('لم يتم إعداد القائمة من الخلفية بعد'),600);
      renderSections(); setStickyVars(); bump(); setStep('menu');

      // Reveal gallery items progressively
      requestAnimationFrame(()=>document.querySelectorAll('.gimg').forEach((img,i)=>setTimeout(()=>img.classList.add('reveal'), 60*i)));

      appLoading.classList.remove('show');
    })();
  });

  // Theme color sync for PWA bar
  const themeMeta = document.querySelector('meta[name="theme-color"]');
  function setThemeColorMeta(){
    const el = document.querySelector('.mini-bar');
    const cs = el ? getComputedStyle(el).backgroundColor : null;
    if(themeMeta && cs) themeMeta.setAttribute('content', cs);
  }
  window.addEventListener('load', setThemeColorMeta, {once:true});
  matchMedia('(prefers-color-scheme: dark)').addEventListener?.('change', setThemeColorMeta);
  </script>
</body>
</html>
