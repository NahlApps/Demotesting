<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Primary Meta Tags -->
  <title>حجوزات المواعيد</title>
  <meta name="title" content="حجوزات المواعيد" />
  <meta
    name="description"
    content="1.	بنغسل سيارتك بخلطة خاصة مدعّمة بالواكس تحميها من الغبار والخدوش.  2.	فوطنا دايمًا نظيفة. 3.	ونستخدم إسفنجة مخصوصة للكفرات عشان نهتم بكل تفاصيل سيارتك.
#غسيل_بدون_طوابير"
  />

  <!-- Google / Search Engine Tags -->
  <meta itemprop="name" content="حجوزات المواعيد" />
  <meta
    itemprop="description"
    content="1.	بنغسل سيارتك بخلطة خاصة مدعّمة بالواكس تحميها من الغبار والخدوش.  2.	فوطنا دايمًا نظيفة. 3.	ونستخدم إسفنجة مخصوصة للكفرات عشان نهتم بكل تفاصيل سيارتك.
#غسيل_بدون_طوابير"
  />
  <meta
    itemprop="image"
    content="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/Logo%20-%20Sponge%20and%20Soap%20-%201.png"
  />

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://www.spongnsoap.com" />
  <meta property="og:title" content="حجوزات المواعيد" />
  <meta
    property="og:description"
    content="1.	بنغسل سيارتك بخلطة خاصة مدعّمة بالواكس تحميها من الغبار والخدوش.  2.	فوطنا دايمًا نظيفة. 3.	ونستخدم إسفنجة مخصوصة للكفرات عشان نهتم بكل تفاصيل سيارتك.
#غسيل_بدون_طوابير"
  />
  <meta
    property="og:image"
    content="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/Logo%20-%20Sponge%20and%20Soap%20-%201.png"
  />
  <meta
    property="og:image:src"
    content="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/Logo%20-%20Sponge%20and%20Soap%20-%201.png"
  />

  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image" />
  <meta property="twitter:url" content="https://www.spongnsoap.com" />
  <meta property="twitter:title" content="حجوزات المواعيد" />
  <meta
    property="twitter:description"
    content="1.	بنغسل سيارتك بخلطة خاصة مدعّمة بالواكس تحميها من الغبار والخدوش.  2.	فوطنا دايمًا نظيفة. 3.	ونستخدم إسفنجة مخصوصة للكفرات عشان نهتم بكل تفاصيل سيارتك.
#غسيل_بدون_طوابير"
  />
  <meta
    property="twitter:image"
    content="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/Logo%20-%20Sponge%20and%20Soap%20-%201.png"
  />
  <meta
    property="twitter:image:src"
    content="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/Logo%20-%20Sponge%20and%20Soap%20-%201.png"
  />
  <link
    rel="shortcut icon"
    href="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/Logo%20-%20Sponge%20and%20Soap%20-%201.png"
    type="image/x-icon"
  />
  <link rel="icon" type="image/png" sizes="32x32" href="" />
  <link rel="icon" type="image/png" sizes="16x16" href="" />

  <meta
    name="keywords"
    content="المدينة,المنورة,الشرقية,القطيف,الخبر,الدمام,سيهات,car,سيارة,mobile,موبيل,موبايل,لكزس,lexus,واش,wash,car wash,غسيل,غسيل_بدون_طوابير,طابور,بدون,طوابير,موسم,داخلي,خارجي,نظيف,تلميع,تظليل,clean,internal,حجز,موعد,reserve,appointment,ticket,work,عمل,riyad,dahran,dhahran,تنظيف,نظافة,بخار,ماء,ماي,مويه,صابون,نحل,nahl,nahl.app,أزرق,نيلي,Blue,Last clean,اسفجنة وصابون,sponge, soap, spongnsoap,spongensoap,اخر نظافة,مايكلين"
  />
  <meta name="robots" content="index, follow" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="language" content="Arabic" />
  <title>حجز موعد</title>

  <script
    src="https://code.jquery.com/jquery-3.6.3.slim.min.js"
    integrity="sha256-ZwqZIVdD3iXNyGHbSYdsmWP//UBokj2FHAxKuSBKDSo="
    crossorigin="anonymous"
  ></script>
  <link
    href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
    rel="stylesheet"
  />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  <!-- date-fns -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <!-- luxon -->
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>

  <!-- Font Awesome -->
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    rel="stylesheet"
  />
  <!-- Google Fonts -->
  <link
    href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap"
    rel="stylesheet"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Tinos:ital,wght@0,400;0,700;1,400;1,700&display=swap"
    rel="stylesheet"
  />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD"
    crossorigin="anonymous"
  />
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
    crossorigin="anonymous"
  ></script>
  <!-- country codes -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/css/intlTelInput.css"
  />
  <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/intlTelInputWithUtils.js"></script>
</head>

<style>
  /* … your existing CSS unchanged … */
</style>

<body>
  <!-- … your existing HTML markup unchanged … -->
  <!-- (The big markup block you shared above stays exactly the same) -->
</body>

<script>
/* -------------------- IMPORTANT: ORIGINAL METHOD CONFIG -------------------- */
// 👉 Set this to your Apps Script Web App URL (Deploy > Web app)
const defaultLink = 'https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec';

/* -------------------- Your existing JS (mostly unchanged) -------------------- */
function addService(element) {
  element.classList.toggle("active");
  let selectedServices = [];
  document.querySelectorAll(".chip.active").forEach(function(chip) {
    selectedServices.push(chip.textContent.trim());
  });
  document.getElementById("locationDescription").value = selectedServices.join(", ");
}

/* intl-tel-input init ... (unchanged) */

let countryCodeInput; // make it available to other functions

document.addEventListener('DOMContentLoaded', function () {
  const input = document.getElementById('mobile');
  if (!input) {
    console.warn('⚠️ #mobile input not found when initializing intl-tel-input');
    return;
  }

  countryCodeInput = window.intlTelInput(input, {
    utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/utils.js",
    countryOrder:["sa","qa"],
    initialCountry:"sa",
    onlyCountries:["sa","qa","ae","om","kw","bh"],
    excludeCountries:["il"],
    strictMode:true,
    i18n: /* your i18n map here */,
  });

  const errorMap = ["رقم غير صحيح", "رمز دولة غير صحيح", "المُدخل أقصر من المتوقع", "المُدخل أطول من المتوقع", "رقم غير صحيح"];

  input.addEventListener("change", () => {
    // safe to reference countryCodeInput now
    console.log(countryCodeInput.getNumber().substring(1));
    console.log(countryCodeInput.isValidNumber());
    const msg = errorMap[countryCodeInput.getValidationError()] || "رقم غير صحيح";
    console.log(msg);
    console.log(countryCodeInput.getSelectedCountryData().dialCode);
  });
});



/* ==================== ORIGINAL METHOD HELPERS ==================== */
let controllers = [];
async function callContent(routText, callback, abortable = false){
  let signal = '';
  if (abortable) {
    if (controllers.length > 0) {
      for (let i = 0; i < controllers.length; i++) controllers[i][0].abort();
      controllers = [];
    }
    const controller = new AbortController();
    signal = controller.signal;
    controllers.push([controller, signal]);
  }
  await new Promise(resolve => setTimeout(resolve, 1000));
  fetch(defaultLink + `?content=${routText}`, {
    redirect: "follow",
    method: "GET",
    ...(abortable && { signal }),
  }).then(async (response) => {
    const json = await response.json();
    callback(json);
  }).catch(err => console.log("Error:", err));
}

/* ==================== DATA LOAD USING ORIGINAL METHOD ==================== */
// Locations
document.getElementById("page2-spinner").style.display = "block";
callContent('locations', (data) => {
  if (!data.success) return;
  const locations = data.data;
  const selectData = locations
    .map(l => ({ id: l.id, text: l.TS_location_arabic_name }))
    .sort((a, b) => a.id - b.id);

  $('.js-example-basic-single').select2({ data: selectData, width: "90%" });
  $('#area').trigger('change');

  // translations caches (unchanged)
  document.getElementById("page2-spinner").style.display = "none";
});

/* Services when location changes */
$("#area").on("change", () => {
  document.getElementById("page3-1-spinner").style.display = "block";
  document.getElementById("page3-2-spinner").style.display = "block";
  document.getElementById('serviceCat').innerHTML = '';
  document.getElementById('service').innerHTML = '';

  const locId = document.getElementById("area").value;
  callContent(`services&location=${encodeURIComponent(locId)}`, (data) => {
    const services = data.data.services;
    const serviceCategories = data.data.servicesCat;
    // Build categoriesWithServices (unchanged)
    const categoriesWithServices = {};
    services.forEach(service => {
      const categoryID = service.TS_category_id;
      if (!categoriesWithServices[categoryID]) {
        categoriesWithServices[categoryID] = {
          category: serviceCategories.find(cat => cat.TS_category_id === categoryID),
          services: [],
          locations: new Set()
        };
      }
      categoriesWithServices[categoryID].services.push(service);
      service.location.forEach(location => categoriesWithServices[categoryID].locations.add(location));
    });
    servicesDropdownLoader2(categoriesWithServices);
    document.getElementById("page3-1-spinner").style.display = "none";
    document.getElementById("page3-2-spinner").style.display = "none";
  }, true);
});

/* Appointments when date or service changes */
document.getElementById('date').onchange = () => {
  document.getElementById('date').disabled = true;
  $("#time-contaier").empty();
  document.getElementById('time-container').innerHTML = `
    <div id="department-spinner" class="spinner-border" role="status" style="grid-column-start: span 3;justify-self: center;">
      <span class="sr-only">Loading...</span>
    </div>`;

  ActualTimes = [[],[],[]];
  appointments = [[],[],[]];
  timesLoaded = false;

  day1 = DateTime.fromISO(document.getElementById('date').value);
  day2 = day1.plus({days:1});
  day3 = day1.plus({days:2});

  for(let i = 1; i <= 3 ; i ++){
    const d = i===1?day1:i===2?day2:day3;
    document.getElementById(`day${i}`).innerText = weekdays[d.weekday];
    document.getElementById(`day${i}date`).innerText = d.toFormat('yyyy-MM-dd');
  }

  const loc = document.getElementById("area").value;
  const svc = document.getElementById("service").value;
  const start = day1.toFormat('yyyy-MM-dd');

  callContent(`appointments&startDate=${encodeURIComponent(start)}&location=${encodeURIComponent(loc)}&service=${encodeURIComponent(svc)}`, (data) => {
    document.getElementById('time-container').innerHTML = `
      <div id="department-spinner" class="spinner-border" role="status" style="grid-column-start: span 3;justify-self: center;">
        <span class="sr-only">Loading...</span>
      </div>`;

    const recievedDates = data.data.appointments || [];
    const tempActualTimes = [];
    for (let i = 0; i < recievedDates.length; i++) {
      const x = DateTime.fromISO(recievedDates[i]['TS_appointment_date'], { setZone: true });
      const y = DateTime.fromISO(recievedDates[i]['TS_appointment_time'], { setZone: true });
      recievedDates[i]['TS_appointment_date'] = x.toISODate();
      recievedDates[i]['TS_appointment_time'] = y.toLocaleString(DateTime.TIME_SIMPLE).replace(" ", " ");
      tempActualTimes[i] = y.toFormat('hh:mm a');
    }

    for (let i = 0; i < recievedDates.length; i++) {
      const d = recievedDates[i]["TS_appointment_date"];
      if (d === day1.toFormat('yyyy-MM-dd')) { appointments[0].push(recievedDates[i]['TS_appointment_time']); ActualTimes[0].push(tempActualTimes[i]); }
      else if (d === day2.toFormat('yyyy-MM-dd')) { appointments[1].push(recievedDates[i]['TS_appointment_time']); ActualTimes[1].push(tempActualTimes[i]); }
      else if (d === day3.toFormat('yyyy-MM-dd')) { appointments[2].push(recievedDates[i]['TS_appointment_time']); ActualTimes[2].push(tempActualTimes[i]); }
    }

    timesLoaded = true;
    timesSetter(0); // first day
    document.getElementById('date').disabled = false;
  }, true);
};

document.getElementById('date').value = DateTime.now().toFormat('yyyy-MM-dd');

/* timesSetter unchanged except uses choosedDate correctly */
function timesSetter (index) {
  const timeContainer = document.getElementById("time-container");
  $("#time-container").empty();
  timeContainer.innerHTML = "";
  if (appointments[index].length === 0) {
    timeContainer.innerHTML = `
      <div id="department-spinner" style="grid-column-start: span 3;justify-self: center;">
        <span>لا توجد مواعيد متاحة</span>
      </div>`;
    return;
  }
  for (let y = 0; y < appointments[index].length; y++) {
    timeContainer.innerHTML += `
      <button onclick="choosedDate('${ActualTimes[index][y]}','${document.getElementById('day${index+1}date').innerText}',${4})"
              class="time-button" dir="ltr">
        ${appointments[index][y]}
      </button>`;
  }
}

/* … the rest of your page navigation / validation code remains unchanged … */

/* ===== PAGE 6 SUBMIT (reserveAppointment via ORIGINAL METHOD) ===== */
(function wirePage6Submit(){
  const pb1 = document.getElementById('page6-button');
  if (!pb1) return;

  pb1.onclick = () => {
    if (position == "") {
      infoWindow.setPosition(map.getCenter());
      infoWindow.setContent("الرجاء تحديد الموقع");
      infoWindow.open(map);
      return;
    }

    // open terms modal (your existing modal code)
    const termsModalEl = document.getElementById('termsModal');
    const termsModal = new bootstrap.Modal(termsModalEl);
    const acceptCheckbox = document.getElementById('termsAccept');
    const confirmBtn = document.getElementById('confirmTerms');
    acceptCheckbox.checked = false;
    confirmBtn.disabled = true;
    acceptCheckbox.onchange = () => confirmBtn.disabled = !acceptCheckbox.checked;
    termsModal.show();

    confirmBtn.onclick = () => {
      termsModal.hide();

      document.getElementById(`page6-return`).style.display = "none";
      pb1.style.display = "none";
      const pageSpinner = document.getElementById(`page6-spinner`);
      const failAlert = document.getElementById(`fail-alert-5`);
      failAlert.style.display = "none";
      pageSpinner.style.display = "flex";
      pageSpinner.children[0].style.display = "block";
      pageSpinner.children[1].style.display = "block";

      // nForm is already filled earlier in your code; we just POST it using original method
      nForm.urlLocation = position;
      nForm.locationDescription = document.getElementById("locationDescription").value;

      fetch(defaultLink + `?content=reserveAppointment`, {
        redirect: "follow",
        method: "POST",
        body: JSON.stringify(nForm)
      }).then(async (response) => {
        pageSpinner.style.display = 'none';
        if (!response.ok) throw Object.assign(new Error('Custom error'), { response });
        const res = await response.json();
        if (res.success){
          const p1 = document.getElementById(`page6`);
          const p2 = document.getElementById(`page7`);
          p1.classList.remove("fadeIn"); p1.classList.add("fadeOut");
          p2.classList.remove("fadeOut"); p2.classList.add("fadeIn");
          setTimeout(() => {
            p1.style.display = "none";
            p2.style.display = "flex";
            if(confirm(`عزيزنا/عزيزتنا, ودك نتذكر بياناتك على هذا الجهاز لتسهيل الغسلات الجاية ؟`)){
              localStorage.setItem("name", document.getElementById("name").value);
              localStorage.setItem("mobile", countryCodeInput.getNumber().substring(1));
            } else {
              localStorage.removeItem("name");
              localStorage.removeItem("mobile");
            }
          }, 1000);
        }
      }).catch(async err => {
        console.log("Error:", err.message);
        if (err.response) {
          const body = await err.response.json();
          const failAlert3 = document.getElementById(`fail-alert-3`);
          failAlert3.style.display = "block";
          failAlert3.children[0].innerHTML = body.msgAR || "عذرًا حصل خطأ غير متوقع الرجاء التواصل معنا";
        }
        document.getElementById(`page6-return`).style.display = "inline-block";
        pb1.style.display = "inline-block";
        const p1 = document.getElementById(`page6`);
        p1.classList.remove("fadeIn");
        p1.classList.add("fadeOut");
        p1.style.display = "none";
        const p2 = document.getElementById(`page4`);
        p2.classList.remove("fadeOut");
        p2.classList.add("fadeIn");
        p2.style.display = "flex";
        $('#date').trigger('change');
      });
    }
  }
})();

/* servicesDropdownLoader2, choosedDate, map helpers, etc. — unchanged from your version */

/* Google Maps bits (unchanged) */
</script>

<!-- Google Maps API (callback must be global: myMap) -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBBHLoO038vsCovHN-SLUgAXqexlA2v0_4&callback=myMap&libraries=geometry" async defer></script>
</html>
