<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>حجوزات المواعيد</title>
  <meta name="title" content="حجوزات المواعيد" />
  <meta name="description" content="1. بنغسل سيارتك بخلطة خاصة مدعّمة بالواكس تحميها من الغبار والخدوش. 2. فوطنا دايمًا نظيفة. 3. ونستخدم إسفنجة مخصوصة للكفرات عشان نهتم بكل تفاصيل سيارتك. #غسيل_بدون_طوابير" />

  <!-- Sharing -->
  <meta itemprop="name" content="حجوزات المواعيد" />
  <meta itemprop="description" content="1. بنغسل سيارتك بخلطة خاصة مدعّمة بالواكس تحميها من الغبار والخدوش. 2. فوطنا دايمًا نظيفة. 3. ونستخدم إسفنجة مخصوصة للكفرات عشان نهتم بكل تفاصيل سيارتك. #غسيل_بدون_طوابير" />
  <meta itemprop="image" content="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/Logo%20-%20Sponge%20and%20Soap%20-%201.png" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://www.spongnsoap.com" />
  <meta property="og:title" content="حجوزات المواعيد" />
  <meta property="og:description" content="1. بنغسل سيارتك بخلطة خاصة مدعّمة بالواكس تحميها من الغبار والخدوش. 2. فوطنا دايمًا نظيفة. 3. ونستخدم إسفنجة مخصوصة للكفرات عشان نهتم بكل تفاصيل سيارتك. #غسيل_بدون_طوابير" />
  <meta property="og:image" content="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/Logo%20-%20Sponge%20and%20Soap%20-%201.png" />
  <meta property="twitter:card" content="summary_large_image" />
  <meta property="twitter:url" content="https://www.spongnsoap.com" />
  <meta property="twitter:title" content="حجوزات المواعيد" />
  <meta property="twitter:description" content="1. بنغسل سيارتك بخلطة خاصة مدعّمة بالواكس تحميها من الغبار والخدوش. 2. فوطنا دايمًا نظيفة. 3. ونستخدم إسفنجة مخصوصة للكفرات عشان نهتم بكل تفاصيل سيارتك. #غسيل_بدون_طوابير" />
  <meta property="twitter:image" content="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/Logo%20-%20Sponge%20and%20Soap%20-%201.png" />
  <link rel="shortcut icon" href="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/Logo%20-%20Sponge%20and%20Soap%20-%201.png" type="image/x-icon" />

  <!-- Libs -->
  <script src="https://code.jquery.com/jquery-3.6.3.slim.min.js" crossorigin="anonymous"></script>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/css/intlTelInput.css" />
  <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/intlTelInputWithUtils.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');
    :root{
      --brand-300:#48b5d0; --brand-500:#0394b6; --brand-600:#027790;
      --bg:#F5F7F8; --surface:#FFFFFF; --surface-2:#FAFBFC; --border:#E7EBEF;
      --text:#1f2328;
      --ring: 0 0 0 3px rgba(3,148,182,.25);
      --shadow-1: 0 2px 10px rgba(0,0,0,.08); --shadow-2: 0 6px 18px rgba(0,0,0,.12);
      --radius-s:8px; --radius-m:12px; --gap-3:16px;
      --control-h: 42px;
    }
    html, body{ margin:0; min-height:100dvh; background:var(--bg); color:var(--text); font-family:"Cairo", system-ui; }
    .bg-image{ position:fixed; inset:0; background:url("https://www.dropbox.com/s/s9bxuykl0w49dqa/background2.jpg?raw=1") center/cover no-repeat; filter:blur(8px); z-index:-1;}
    .container-page{ max-width:1200px; margin-inline:auto; padding:16px; }
    #form{ background: #48b5d0e0; color:#fff; min-height:100dvh; display:flex; align-items:center; }
    #form-content{ width:100%; display:flex; flex-direction:column; }
    #page1,#page2,#page3,#page4,#page5,#page6,#page7{ display:none; flex-direction:column; align-items:center; justify-content:center; min-height:70dvh; padding:16px; }
    #page1{ display:flex; }
    .filter-button{ display:inline-flex; align-items:center; justify-content:center; min-height:var(--control-h); padding:0 18px; border-radius:12px; background:var(--brand-500); color:#fff; font-weight:700; border:0; cursor:pointer; box-shadow:var(--shadow-1); transition:.25s; width:100%; }
    .filter-button:hover{ background:var(--brand-600); transform:translateY(-1px); box-shadow:var(--shadow-2);}
    input,select,.select2-container .select2-selection{ background:#fff; color:#0f1419; border:1px solid var(--border); border-radius:12px; min-height:var(--control-h); padding-inline:12px; }
    input:focus, select:focus { outline:none; box-shadow:var(--ring); }
    .select2-container .select2-selection--single{ height:var(--control-h)!important; border-radius:12px!important;}
    .select2-container .select2-selection__rendered{ line-height:calc(var(--control-h) - 12px)!important; }
    .select2-container .select2-selection__arrow{ height:var(--control-h)!important; }
    .time-container{ display:grid; gap:16px; grid-template-columns: repeat(3,1fr); background:#fff; border:1px solid var(--border); border-radius:12px; padding:16px; height:23rem; overflow:auto;}
    @media (max-width:900px){ .time-container{ grid-template-columns: repeat(2,1fr);} }
    @media (max-width:560px){ .time-container{ grid-template-columns: 1fr;} }
    .time-button{ background:#fafbfc; border:1px solid var(--border); border-radius:12px; min-height:56px; display:flex; align-items:center; justify-content:center; font-weight:700; cursor:pointer; transition:.25s;}
    .time-button:hover{ background:#fff; transform:translateY(-1px); box-shadow:var(--shadow-2); }
    .social-fab{ position: fixed; left: 15px; z-index: 999; width: 56px; height: 56px; border-radius: 50%; display:flex; align-items:center; justify-content:center; color:#fff; background: rgba(34,34,34,.55); backdrop-filter: blur(6px); box-shadow: 0 8px 20px rgba(0,0,0,.35), 0 0 0 2px rgba(255,255,255,.10) inset; transition:.18s; }
    .social-fab:hover{ transform: translateY(-2px); }
    .whatsapp-button{ bottom:15px; } .instagram-button{ bottom:74px; } .tiktok-button{ bottom:133px; }
    .drag-hint{ position:absolute; inset-inline:50%; transform:translateX(-50%); top:12px; background:#fff; border:1px solid var(--border); border-radius:999px; padding:6px 12px; display:flex; align-items:center; gap:8px; color:#333; box-shadow:var(--shadow-1);}
  </style>
</head>
<body>
  <div class="bg-image" aria-hidden="true"></div>

  <div id="form" class="container-page">
    <div id="form-content">
      <!-- Page 1 -->
      <div id="page1">
        <div style="text-align:center; margin-bottom:16px;">
          <img src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/spong&Soap%20-%20logo.png" alt="Sponge & Soap" loading="lazy" style="width:200px; margin-bottom:12px;" />
          <h3 style="line-height:2;">
            ✨ واكس يحمي سيارتك<br />
            🧼 فوط نظيفة & لمعان مضمون<br />
            🛞 إسفنجة للكفرات<br /><br />
            ... نهتم بكل التفاصيل
          </h3>
          <p><span style="font-weight:bold; font-size:18px;">#غسيل_بدون_طوابير</span></p>
        </div>
        <div style="max-width:320px; width:100%;">
          <button id="page1-button" class="filter-button">احجز موعدك</button>
        </div>
      </div>

      <!-- Page 2 -->
      <div id="page2" role="region" aria-labelledby="p2title">
        <h1 id="p2title">وين تحب نجيك؟<br/>اختيار المنطقة</h1>
        <form onsubmit="handleSubmit(event)" id="page2-form" style="width:100%; max-width:720px;">
          <div id="select2-container" style="position:relative; margin-bottom:16px;">
            <label style="width:100%; display:block;">
              <span style="font-size:12px;font-weight:700;display:block;margin-bottom:6px;">المنطقة</span>
              <select id="area" class="js-example-basic-single" style="width:100%;" required></select>
            </label>
            <div id="page2-spinner" style="position:absolute; inset-inline-start:50%; transform:translateX(-50%); display:none;">
              <div class="spinner-border" role="status" style="width:1.5rem; height:1.5rem;"></div>
            </div>
          </div>

          <div style="margin-bottom:16px; position:relative;">
            <label style="width:100%; display:block;">
              <span style="font-size:12px;font-weight:700;display:block;margin-bottom:6px;">الخدمة</span>
              <select id="service" style="width:100%;" required></select>
            </label>
            <div id="page3-2-spinner" style="position:absolute; inset-inline-start:50%; transform:translateX(-50%); display:none;">
              <div class="spinner-border" role="status" style="width:1.5rem; height:1.5rem;"></div>
            </div>
          </div>
        </form>

        <div style="max-width:320px; width:100%;">
          <button id="page2-button" class="filter-button" type="button">التالي</button>
        </div>
      </div>

      <!-- Page 3 (loading) -->
      <div id="page3" role="region" aria-labelledby="p3title" style="position:relative;">
        <div id="page3-wait" style="display:flex; position:absolute; inset:0; background: rgba(0,0,0,.6); z-index:10; justify-content:center; align-items:center; flex-direction:column;">
          <div class="spinner-border text-light" role="status"><span class="visually-hidden">Loading...</span></div>
          <p style="color:#fff; margin-top:1em; font-size:1.2em;">جاري جلب المواعيد…</p>
        </div>
      </div>

      <!-- Page 4 -->
      <div id="page4" role="region" aria-labelledby="p4title">
        <h1 id="p4title">متى تحب نجيك؟<br/>اختيار الموعد</h1>

        <input type="date" id="date" name="date" class="form-control" style="text-align:center; width:min(420px,90%);" />

        <div class="time-date-box" style="width:100%; max-width:900px; margin-top:16px;">
          <div id="time-date-header" class="time-date-header" hidden>
            <div id="dayHeader1" class="choosed" style="border-radius:0 10px 0 0;"><span id="day1">—</span><br/><span id="day1date">—</span></div>
            <div id="dayHeader2"><span id="day2">—</span><br/><span id="day2date">—</span></div>
            <div id="dayHeader3" style="border-radius: 10px 0 0 0;"><span id="day3">—</span><br/><span id="day3date">—</span></div>
          </div>

          <div id="time-container" class="time-container" dir="rtl"></div>

          <div id="fail-alert-3" class="alert alert-danger" role="alert" style="display:none; margin-top:16px;">
            <span></span><br/><span></span>
          </div>
        </div>

        <div style="max-width:320px; width:100%;">
          <button id="page4-return" class="filter-button" style="background:#fff; color:var(--brand-500); border:1px solid var(--brand-500);" type="button">السابق</button>
        </div>
      </div>

      <!-- Page 5 -->
      <div id="page5" role="region" aria-labelledby="p5title" style="width:100%; max-width:720px;">
        <h2 id="p5title">معلومات الاتصال</h2>

        <form onsubmit="handleSubmit(event)" id="page5-form" style="width:100%;">
          <label style="width:100%; display:block; margin-bottom:12px;">
            <span style="font-size:12px;font-weight:700;display:block;margin-bottom:6px;">الإسم</span>
            <input id="name" type="text" required />
          </label>

          <label style="width:100%; display:block; margin-bottom:12px;">
            <span style="font-size:12px;font-weight:700;display:block;margin-bottom:6px;">رقم الجوال</span>
            <input type="tel" id="mobile" style="width:100%;" />
          </label>

          <h2 style="margin-bottom:12px;">معلومات المركبة</h2>

          <div style="width:100%; margin-bottom:12px;">
            <label style="width:100%; display:block;">
              <span style="font-size:12px;font-weight:700;display:block;margin-bottom:6px;">🚘 ماركة السيارة</span>
              <select id="carBrand" style="width:100%;"></select>
            </label>
          </div>

          <div style="display:flex; gap:16px; flex-wrap:wrap; width:100%;">
            <div style="flex:1; min-width:240px;">
              <label style="width:100%; display:block;">
                <span style="font-size:12px;font-weight:700;display:block;margin-bottom:6px;">اسم السيارة</span>
                <input type="text" id="carName" placeholder="GT-R, كامري، إلنترا" />
              </label>
            </div>
            <div style="flex:1; min-width:240px;">
              <label style="width:100%; display:block;">
                <span style="font-size:12px;font-weight:700;display:block;margin-bottom:6px;">رقم اللوحة</span>
                <input type="text" id="plateNumber" maxlength="4" placeholder="🔢 مثال: 1234" inputmode="numeric" pattern="^\\d{1,4}$" required />
              </label>
              <div id="plateError" class="text-danger" style="display:none; font-size:13px; margin-top:6px;">الرجاء إدخال رقم لوحة صحيح (1–4 أرقام).</div>
            </div>
          </div>

          <div hidden>
            <input type="text" id="locationDescription" readonly placeholder="ماركة السيارة, اسم السيارة, رقم اللوحة" />
          </div>

          <h2 style="margin-top:16px; margin-bottom:12px;">طريقة الدفع</h2>
          <div style="display:flex; gap:12px; flex-wrap:wrap;">
            <label style="flex:1; min-width:160px; display:flex; align-items:center; justify-content:center; border:1px solid var(--border); border-radius:12px; background:#fff; padding:14px; min-height:64px; cursor:pointer;">
              <input type="radio" name="payingMethod" value="Cash" required style="position:absolute; opacity:0;" />
              <img src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/CASH%20LOGO.png" alt="Cash" width="125" height="40" loading="lazy" />
            </label>
            <label style="flex:1; min-width:160px; display:flex; align-items:center; justify-content:center; border:1px solid var(--border); border-radius:12px; background:#fff; padding:14px; min-height:64px; cursor:pointer;">
              <input type="radio" name="payingMethod" value="STC Pay" required style="position:absolute; opacity:0;" />
              <img src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/STC%20PAY%20LOGO.png" alt="STC Pay" width="125" height="40" loading="lazy" />
            </label>
            <label style="flex:1; min-width:160px; display:flex; align-items:center; justify-content:center; border:1px solid var(--border); border-radius:12px; background:#fff; padding:14px; min-height:64px; cursor:pointer;">
              <input type="radio" name="payingMethod" value="MADA" required style="position:absolute; opacity:0;" />
              <img src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/MADA%20LOGO.png" alt="MADA" width="125" height="40" loading="lazy" />
            </label>
          </div>
        </form>

        <div style="max-width:320px; width:100%; margin-top:16px;">
          <button id="page5-button" class="filter-button" type="button">التالي</button>
          <div style="height:12px;"></div>
          <button id="page5-return" class="filter-button" style="background:#fff; color:var(--brand-500); border:1px solid var(--brand-500);" type="button">السابق</button>
        </div>
      </div>

      <!-- Page 6 -->
      <div id="page6" role="region" aria-labelledby="p6title" style="width:100%; max-width:900px;">
        <h2 id="p6title" style="margin-bottom:12px;">الموقع على خريطة قوقل</h2>

        <div id="drag-instructions" class="drag-hint">
          <i class="fas fa-hand-point-right" aria-hidden="true"></i>
          <span>📍 اسحب الخريطة لتغيير الموقع</span>
        </div>

        <div style="border:1px solid var(--border); border-radius:16px; overflow:hidden; box-shadow: var(--shadow-1); background:#fff; margin-bottom:12px;">
          <div id="googleMap" style="width:100%; height:400px;"></div>
        </div>

        <p style="text-align:center; font-size:14px; color:#333; margin-bottom:10px;">
          📍 <strong>قم بسحب المؤشر أو اضغط على اظهار موقعي</strong>
        </p>

        <div style="max-width:320px; width:100%;">
          <button class="filter-button" id="show-my-location" type="button" style="background:#fff; color:var(--brand-500); border:1px solid var(--brand-500);">اظهار موقعي</button>
        </div>

        <div style="max-width:320px; width:100%; margin-top:16px;">
          <button id="page6-button" class="filter-button" type="button">التالي</button>
          <div style="height:12px;"></div>
          <button id="page6-return" class="filter-button" style="background:#fff; color:var(--brand-500); border:1px solid var(--brand-500);" type="button">السابق</button>
        </div>

        <div id="page6-spinner" style="display:none; flex-direction:column; align-items:center; margin-top:1em;">
          <span class="mt-3"></span>
          <div class="spinner-border" role="status" style="display:none; margin-top:30px;">
            <span class="sr-only">Loading...</span>
          </div>
        </div>

        <div id="fail-alert-5" class="alert alert-danger" role="alert" style="display:none; margin-top:16px;">
          <span></span><br/><span></span>
        </div>
      </div>

      <!-- Page 7 -->
      <div id="page7" dir="rtl" role="region" aria-live="polite">
        <h1>شكراً لكم</h1>
        <h2>تم حجز الموعد، وراح نأكده لكم على الواتساب</h2>
        <h3>متحمسين نجيكم!!</h3>
        <div style="max-width:320px; width:100%;">
          <button id="rebook" class="filter-button">🔁 حجز جديد</button>
        </div>
      </div>

      <footer dir="rtl" style="text-align:center; margin-top:20px;">
        <p>Sponge & Soap</p>
        <a target="_blank" href="https://www.instagram.com/nahl.app?igsh=Y3YyOW05MGI5bnNv&utm_source=qr" style="color:inherit; text-decoration:none; border-bottom:1px dotted rgba(0,0,0,.3);">Made with Nahl Perfection</a>
      </footer>
    </div>
  </div>

  <!-- FABs -->
  <a target="_blank" href="https://wa.me/966503668222" class="social-fab whatsapp-button" aria-label="تواصل عبر واتساب"><i class="fab fa-whatsapp" aria-hidden="true"></i></a>
  <a target="_blank" href="https://www.instagram.com/sponge.soap_sa?igsh=MWRtOHI5OHZpbWpvdA==" class="social-fab instagram-button" aria-label="تابعنا على إنستغرام"><i class="fab fa-instagram" aria-hidden="true"></i></a>
  <a target="_blank" href="https://www.tiktok.com/@sponge.soap_sa?_t=ZS-8zaj1CA4aJg&_r=1" class="social-fab tiktok-button" aria-label="تابعنا على تيك توك"><i class="fab fa-tiktok" aria-hidden="true"></i></a>

  <!-- Terms Modal -->
  <div class="modal fade" id="termsModal" tabindex="-1" aria-hidden="true" dir="rtl">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">الشروط والأحكام – مغسلة سيارات متنقلة</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
        </div>
        <div class="modal-body" style="text-align:right;">
          <ol style="padding-right:1rem;">
            <li><strong>الخدمات المقدمة</strong><ul><li>تقدم المغسلة خدمات غسيل وتنظيف السيارات وفق الباقات المعروضة على الموقع أو حسب الاتفاق المسبق.</li></ul></li>
            <li><strong>حجز المواعيد</strong><ul><li>يتم الحجز عبر الموقع أو من خلال التواصل المباشر.</li><li>يحق للمغسلة تعديل أو إلغاء الموعد في حال وجود ظرف طارئ مع إشعار العميل.</li></ul></li>
            <li><strong>الدفع</strong><ul><li>يتم الدفع عبر الوسائل المتاحة (تحويل بنكي، مدى، بطاقة إئتمانية، STC Bank، Apple Pay، نقدًا).</li><li>يجب سداد المبلغ كاملاً قبل بدء الخدمة. وفي حال عدم السداد يحق للمغسلة إلغاء الموعد.</li></ul></li>
            <li><strong>إلغاء الخدمة واسترجاع المبلغ</strong><ul><li>في حال إلغاء الحجز قبل 3 ساعات من الموعد، يحق للعميل استرداد المبلغ أو إعادة جدولة الموعد.</li><li>لا يحق للعميل طلب استرداد المبلغ أو جدولة الموعد في حال تم الإلغاء خلال أقل من 3 ساعات.</li></ul></li>
            <li><strong>مسؤولية المغسلة</strong><ul><li>تلتزم المغسلة بتقديم الخدمة بأفضل جودة ممكنة باستخدام مواد آمنة.</li><li>المغسلة غير مسؤولة عن أي أعطال ميكانيكية أو كهربائية أو تلفيات سابقة في السيارة.</li><li>في حال وقوع ضرر ناتج عن خطأ مباشر من فريق العمل، تتحمل المغسلة مسؤولية تعويض عادل يقتصر على قيمة الضرر المباشر.</li></ul></li>
            <li><strong>مسؤولية العميل</strong><ul><li>إخلاء السيارة من المتعلقات الشخصية قبل بدء الخدمة.</li><li>المغسلة غير مسؤولة عن فقدان/تلف أغراض شخصية تُترك داخل السيارة.</li><li>توفير مكان مناسب وآمن لإتمام الخدمة.</li></ul></li>
            <li><strong>التعديلات على الشروط والأحكام</strong><ul><li>يجوز تحديث الشروط في أي وقت.</li><li>الموافقة على الخدمة تعني القبول بهذه الشروط.</li></ul></li>
            <li><strong>القانون المعمول به</strong><ul><li>تخضع لأنظمة المملكة العربية السعودية.</li></ul></li>
          </ol>

          <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" id="termsAccept" />
            <label class="form-check-label" for="termsAccept">أوافق على الشروط والأحكام</label>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn" style="background:#fff; color:#0394b6; border:1px solid #0394b6;" data-bs-dismiss="modal">إلغاء</button>
          <button class="btn" id="confirmTerms" disabled style="background:#0394b6; color:#fff;">تأكيد ومتابعة</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const { DateTime } = luxon;

    // API base
    const defaultLink2 = `https://nahl-platform.vercel.app/api/app/AM/general/${'33e0d05d-d771-46f4-a7e7-7c634b4e3a9e'}/form`;

    // State
    let services;
    let appointments = [[],[],[]];
    let ActualTimes = [[],[],[]];
    let map, infoWindow, marker, polygon = null;
    let position = "";
    let defaultLocation = { lat: 26.34165524787632, lng: 50.11524831545726 };
    const prePosition = "https://www.google.com/maps/search/?api=1&query=";
    const weekdaysAR = ["الأحد","الإثنين","الثلاثاء","الأربعاء","الخميس","الجمعة","السبت"];
    let iti, errorMap;

    function handleSubmit(e){ e.preventDefault(); }

    /* ---- intl-tel-input ---- */
    function initPhoneInput(){
      const input = document.getElementById("mobile");
      iti = window.intlTelInput(input, {
        utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/utils.js",
        countryOrder:["sa","qa"],
        initialCountry:"sa",
        onlyCountries:["sa","qa","ae","om","kw","bh"],
        excludeCountries:["il"],
        strictMode:true,
        i18n:{ ae:"الإمارات العربية المتحدة", bh:"البحرين", kw:"الكويت", sa:"المملكة العربية السعودية" }
      });
      errorMap = ["رقم غير صحيح", "رمز دولة غير صحيح", "المُدخل أقصر من المتوقع", "المُدخل أطول من المتوقع", "رقم غير صحيح"];
    }
    function checkNumberValidity(){
      const number = document.getElementById("mobile");
      const phoneNumber = iti.getNumber().substring(1);
      if (isNaN(phoneNumber) || !iti.isValidNumber() || phoneNumber === ""){
        const msg = errorMap[iti.getValidationError()] || "رقم غير صحيح";
        number.setCustomValidity(msg);
        return false;
      }
      number.setCustomValidity("");
      return true;
    }

    /* ---- fetch helper ---- */
    let controllers = [];
    async function callContent2(routText, callback, abortable = false, retries=3){
      let signal = '';
      if (abortable) {
        controllers.forEach(([c])=>c.abort()); controllers = [];
        const controller = new AbortController();
        signal = controller.signal;
        controllers.push([controller, signal]);
      }
      await new Promise(r => setTimeout(r, 150));
      const url = defaultLink2 + `${routText}`;
      fetch(url, { redirect:"follow", method:"GET", ...(abortable && {signal}) })
        .then(async (response) => {
          if (!response.ok) {
            const bodyText = await response.text().catch(()=> '');
            console.error('API error', response.status, url, bodyText);
            if (retries > 0) return callContent2(routText, callback, abortable, retries-1);
            throw new Error(`HTTP ${response.status} on ${url}`);
          }
          const json = await response.json();
          callback(json);
        })
        .catch(err => {
          if(!String(err.message).includes("aborted")){
            console.error('Fetch failed:', url, err);
            setTimeout(()=>{ if (retries > 0) return callContent2(routText, callback, abortable, retries-1); }, 900);
          }
        });
    }

    /* ---- locations + services ---- */
    function loadLocations(){
      document.getElementById("page2-spinner").style.display = "block";
      callContent2(`/locations`,(data)=>{
        const select = $('#area'); select.empty();
        const locations = data?.data || [];
        const selectData = locations.map(loc => ({ id: loc.id, text: loc.TS_location_arabic_name }));
        select.select2({ data: selectData.sort((a,b)=>a.id-b.id), width: "100%", dir:'rtl', placeholder: "اختر المنطقة" });
        document.getElementById("page2-spinner").style.display = "none";
      }, true);
    }

    // on area change → load services
    $("#area").on("change", () => {
      document.getElementById("page3-2-spinner").style.display = "block";
      $("#service").empty();
      const locId = document.getElementById("area").value;
      if(!locId){ document.getElementById("page3-2-spinner").style.display = "none"; return; }

      callContent2(`/services?location=${locId}`, (data) => {
        services = data?.data?.services || [];
        const svcSelect = $('#service');
        services
          .filter(s => (s.location||[]).includes(Number(locId)))
          .sort((a,b)=> a.TS_service_id - b.TS_service_id)
          .forEach(s => {
            const name = s.TS_service_arabic_name || s.TS_service_english_name || ("خدمة " + s.TS_service_id);
            svcSelect.append(new Option(name, s.TS_service_id));
          });
        $('#service').trigger('change');
        document.getElementById("page3-2-spinner").style.display = "none";

        // if user already on page4, refresh slots now
        if (document.getElementById('page4').style.display !== 'none') {
          document.getElementById('date').dispatchEvent(new Event('change'));
        }
      }, true);
    });

    // when service changes on page4, reload slots
    document.addEventListener('change', (e)=>{
      if (e.target && e.target.id === 'service'){
        if (document.getElementById('page4').style.display !== 'none'){
          document.getElementById('date').dispatchEvent(new Event('change'));
        }
      }
    });

    /* ---- date & slots ---- */
    function setMinToday(){
      document.getElementById("date").setAttribute("min", DateTime.now().toFormat("yyyy-LL-dd"));
      document.getElementById('date').value = DateTime.now().toFormat('yyyy-LL-dd');
    }
    function setupDate(){
      const d1 = DateTime.fromISO(document.getElementById('date').value);
      const d2 = d1.plus({days:1}), d3 = d1.plus({days:2});
      document.getElementById('day1').innerText = weekdaysAR[d1.weekday%7]; document.getElementById('day1date').innerText = d1.toFormat('yyyy-LL-dd');
      document.getElementById('day2').innerText = weekdaysAR[d2.weekday%7]; document.getElementById('day2date').innerText = d2.toFormat('yyyy-LL-dd');
      document.getElementById('day3').innerText = weekdaysAR[d3.weekday%7]; document.getElementById('day3date').innerText = d3.toFormat('yyyy-LL-dd');
    }
    function timesSetter(index){
      let timeContainer = document.getElementById("time-container");
      timeContainer.innerHTML = "";
      if(appointments[index].length === 0){
        timeContainer.innerHTML = `<div style="grid-column: 1/-1; text-align:center; color:#555;">لا توجد مواعيد متاحة</div>`;
        return;
      }
      for (let y = 0; y < appointments[index].length; y++){
        timeContainer.innerHTML += `<button onclick="choosedDate('${ActualTimes[index][y]}','${document.getElementById('day'+(index+1)+'date').innerText}',4)" class="time-button" dir="ltr">${appointments[index][y]}</button>`;
      }
    }

    // SAFE: only request slots when area+service are set
    document.getElementById('date').onchange = () => {
      const dateEl = document.getElementById('date');
      const loc = document.getElementById("area")?.value;
      const svc = document.getElementById("service")?.value;

      if (!loc || !svc) {
        // if we were on loader page, go back to page2 to complete inputs
        if (document.getElementById('page3').style.display !== 'none') {
          document.getElementById('page3-wait').style.display = 'none';
          document.getElementById('page3').style.display = 'none';
          document.getElementById('page2').style.display = 'flex';
        }
        return;
      }

      dateEl.disabled = true;
      document.getElementById('time-container').innerHTML =
        `<div class="spinner-border" role="status" style="grid-column:1/-1; justify-self:center;">
           <span class="visually-hidden">Loading...</span>
         </div>`;

      appointments = [[],[],[]];
      ActualTimes  = [[],[],[]];

      setupDate();

      if (document.getElementById('page3').style.display !== 'none') {
        document.getElementById('page3-wait').style.display = 'flex';
      }

      const start = DateTime.fromISO(dateEl.value).toFormat('yyyy-LL-dd');

      callContent2(`/appointments?startDate=${start}&location=${loc}&service=${svc}`, (data) => {
        try {
          const recievedDates = data?.data?.appointments || [];
          const tmp = [];
          for (let i=0;i<recievedDates.length;i++){
            const d = luxon.DateTime.fromISO(recievedDates[i]['TS_appointment_date'], { setZone:true });
            const t = luxon.DateTime.fromISO(recievedDates[i]['TS_appointment_time'], { setZone:true });
            recievedDates[i]['TS_appointment_date'] = d.toISODate();
            recievedDates[i]['TS_appointment_time'] = t.toLocaleString(luxon.DateTime.TIME_SIMPLE).replace(" ", " ");
            tmp[i] = t.toFormat('hh:mm a');
          }

          const d1s = start;
          const d2s = luxon.DateTime.fromISO(start).plus({days:1}).toFormat('yyyy-LL-dd');
          const d3s = luxon.DateTime.fromISO(start).plus({days:2}).toFormat('yyyy-LL-dd');

          for (let i=0;i<recievedDates.length;i++){
            const it = recievedDates[i];
            if (it.TS_appointment_date === d1s){ appointments[0].push(it.TS_appointment_time); ActualTimes[0].push(tmp[i]); }
            else if (it.TS_appointment_date === d2s){ appointments[1].push(it.TS_appointment_time); ActualTimes[1].push(tmp[i]); }
            else if (it.TS_appointment_date === d3s){ appointments[2].push(it.TS_appointment_time); ActualTimes[2].push(tmp[i]); }
          }

          timesSetter(0);
        } finally {
          document.getElementById('page3-wait').style.display = 'none';
          dateEl.disabled = false;
          // if we were on page3 (loader), move to page4
          const p3 = document.getElementById('page3');
          if (window.getComputedStyle(p3).display !== 'none'){
            p3.style.display = 'none';
            document.getElementById('page4').style.display = 'flex';
          }
        }
      }, true);
    };

    /* ---- flow model ---- */
    var nForm = { date:'', time:'', location:'', service:'', serviceCount:'', serviceCat:'', customerM:'', customerN:'', paymentMethod:'', urlLocation:'', locationDescription:'' };

    // Page 1 → 2
    document.getElementById('page1-button').onclick = ()=>{ document.getElementById('page1').style.display='none'; document.getElementById('page2').style.display='flex'; };

    // Page 2 → 3 (loader → triggers date change → auto goes to 4)
    document.getElementById('page2-button').onclick = () => {
      const area = document.getElementById("area");
      const service = document.getElementById("service");
      if (!area.value || !service.value){
        document.getElementById("page2-form").reportValidity();
        return;
      }
      nForm.location = area.value;
      nForm.service  = service.value;

      document.getElementById('page2').style.display = 'none';
      document.getElementById('page3').style.display = 'flex';
      document.getElementById('page3-wait').style.display = 'flex';

      // now that both inputs exist, load slots
      document.getElementById('date').dispatchEvent(new Event('change'));
    };

    // Page 4 back → 2
    document.getElementById('page4-return').onclick = ()=>{ document.getElementById('page4').style.display='none'; document.getElementById('page2').style.display='flex'; };

    // Choose time → go to page5
    function choosedDate(time, date, i){
      nForm.date = date;
      const parsedTime = luxon.DateTime.fromFormat(String(time), "h:mm a");
      nForm.time = parsedTime.isValid ? parsedTime.toFormat("HH:mm") : String(time);
      document.getElementById(`page${i}`).style.display = "none";
      document.getElementById(`page${i+1}`).style.display = "flex";
    }
    window.choosedDate = choosedDate;

    // Page 5 → 6 (validate)
    document.getElementById('page5-button').onclick = ()=>{
      const name = document.getElementById("name");
      const form = document.getElementById("page5-form");
      const plate = document.getElementById("plateNumber");
      let payingMethod = '';
      try {
        payingMethod = document.querySelector('input[name="payingMethod"]:checked').value;
        if (name.value.trim() === ""){
          name.setCustomValidity("يُرجى ملء هذا الحقل");
          throw new Error("no name");
        } else { name.setCustomValidity(""); }
      } catch (e) { form.reportValidity(); return; }
      if (!checkNumberValidity()){ form.reportValidity(); return; }

      const isPlateOk = /^\d{1,4}$/.test(plate.value);
      document.getElementById("plateError").style.display = isPlateOk ? "none" : "block";
      if (!isPlateOk){
        plate.setCustomValidity("الرجاء إدخال رقم لوحة صحيح (1–4 أرقام)");
        form.reportValidity();
        return;
      }
      plate.setCustomValidity("");

      nForm.paymentMethod = payingMethod;
      nForm.customerN = name.value.trim();
      nForm.customerM = iti.getNumber().substring(1);

      document.getElementById('page5').style.display = "none";
      document.getElementById('page6').style.display = "flex";
    };

    // Page 5 back → 4
    document.getElementById('page5-return').onclick = ()=>{ document.getElementById('page5').style.display='none'; document.getElementById('page4').style.display='flex'; };

    // Page 6 → submit (terms first)
    document.getElementById('page6-button').onclick = ()=>{
      if (!position) {
        const failAlert = document.getElementById('fail-alert-5');
        failAlert.style.display = "block";
        failAlert.children[0].innerText = "الرجاء تحديد الموقع";
        return;
      }
      const termsModalEl = document.getElementById('termsModal');
      const termsModal = new bootstrap.Modal(termsModalEl);
      const acceptCheckbox = document.getElementById('termsAccept');
      const confirmBtn = document.getElementById('confirmTerms');
      acceptCheckbox.checked = false; confirmBtn.disabled = true;
      acceptCheckbox.onchange = () => { confirmBtn.disabled = !acceptCheckbox.checked; };
      termsModal.show();

      confirmBtn.onclick = () => {
        termsModal.hide();

        const pageSpinner = document.getElementById('page6-spinner');
        const btnPrev = document.getElementById('page6-return');
        const btnNext = document.getElementById('page6-button');
        const failAlert = document.getElementById('fail-alert-5');

        btnPrev.style.display = "none"; btnNext.style.display = "none";
        failAlert.style.display = "none";
        pageSpinner.style.display = "flex"; pageSpinner.children[1].style.display = "block";

        const desc = document.getElementById("locationDescription");
        if ((desc.value||"").trim().length > 200){
          desc.setCustomValidity("الوصف أطول من المتوقع");
          document.getElementById("page6-form")?.reportValidity();
          btnPrev.style.display = "inline-block"; btnNext.style.display = "inline-block";
          pageSpinner.style.display = "none"; pageSpinner.children[1].style.display = "none";
          return;
        } else { desc.setCustomValidity(""); }

        nForm.urlLocation = position;
        nForm.locationDescription = desc.value || "";

        fetch(defaultLink2 + `/reserveAppointment`, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify(nForm)
        })
        .then(async (res) => {
          if (!res.ok) {
            const payload = await res.text().catch(()=> '');
            console.error('Reserve error', res.status, payload);
            throw Object.assign(new Error('submit failed'), { response: payload });
          }
          return res.json();
        })
        .then((data)=>{
          pageSpinner.style.display = "none";
          if (data.success){
            document.getElementById('page6').style.display = "none";
            document.getElementById('page7').style.display = "flex";
            if(confirm(`تود حفظ بياناتك لتسهيل الحجز القادم؟`)){
              localStorage.setItem("name", document.getElementById("name").value);
              localStorage.setItem("mobile", iti.getNumber().substring(1));
            } else {
              localStorage.removeItem("name"); localStorage.removeItem("mobile");
            }
          } else {
            throw new Error('submit not success');
          }
        })
        .catch(()=>{
          btnPrev.style.display = "inline-block"; btnNext.style.display = "inline-block";
          pageSpinner.style.display = "none"; pageSpinner.children[1].style.display = "none";
          document.getElementById('page6').style.display = "none";
          const p4 = document.getElementById('page4'); p4.style.display = "flex";
          const failAlert3 = document.getElementById('fail-alert-3');
          const msg = "عذرًا حصل خطأ غير متوقع الرجاء التواصل معنا";
          failAlert3.style.display = "block"; failAlert3.children[0].innerText = msg;
          document.getElementById('date').dispatchEvent(new Event('change'));
        });
      };
    };

    // Page 6 back → 5
    document.getElementById('page6-return').onclick = ()=>{ document.getElementById('page6').style.display='none'; document.getElementById('page5').style.display='flex'; };

    // Page 7 rebook
    document.getElementById("rebook")?.addEventListener("click", ()=> { window.location.href = "https://www.spongnsoap.com/"; });

    /* ---- car brands ---- */
    const carBrands = ["Acura","Alfa Romeo","Aston Martin","Audi","Bentley","BMW","Bugatti","Buick","Cadillac","Chevrolet","Chrysler","Citroën","Dacia","Daewoo","Daihatsu","Dodge","Ferrari","Fiat","Ford","Genesis","GMC","Haval","Holden","Honda","Hummer","Hyundai","Infiniti","Isuzu","Jaguar","Jeep","Kia","Koenigsegg","Lada","Lamborghini","Lancia","Land Rover","Lexus","Lincoln","Lotus","Maserati","Maybach","Mazda","McLaren","Mercedes-Benz","Mercury","MG","Mini","Mitsubishi","Nissan","Opel","Pagani","Peugeot","Plymouth","Pontiac","Porsche","RAM","Renault","Rolls-Royce","Saab","Saturn","Scion","Seat","Skoda","Smart","SsangYong","Subaru","Suzuki","Tata","Tesla","Toyota","Volkswagen","Volvo","Wiesmann","Zotye","Other"];
    function initCarBrands(){
      const sel = $('#carBrand'); sel.empty();
      carBrands.sort().forEach(b => sel.append(new Option(b,b)));
      sel.select2({ placeholder: "🚘 اختر ماركة السيارة", allowClear:true, dir:'rtl', width: '100%' });
      sel.on('change', updateLocationDescription);
    }
    function updateLocationDescription(){
      const carBrand = document.getElementById("carBrand").value || "";
      const carName = document.getElementById("carName").value || "";
      const plateNumber = document.getElementById("plateNumber").value || "";
      const description = [carBrand, carName, plateNumber].filter(Boolean).join(", ");
      const out = document.getElementById("locationDescription");
      if (out) out.value = description;
    }
    document.addEventListener('input', (e)=>{
      if (e.target && e.target.id === 'plateNumber'){
        const el = e.target;
        el.value = el.value.replace(/\D/g, '').slice(0,4);
        el.setCustomValidity('');
        updateLocationDescription();
        document.getElementById("plateError").style.display = "none";
      }
      if (e.target && e.target.id === 'carName'){ updateLocationDescription(); }
    });

    /* ---- map ---- */
    function myMap(){
      map = new google.maps.Map(document.getElementById("googleMap"), { center: defaultLocation, zoom: 12, disableDoubleClickZoom: true });
      infoWindow = new google.maps.InfoWindow();
      marker = new google.maps.Marker({ position: defaultLocation, map, draggable: true, title: "اضغط أو اسحب لتحديد الموقع" });
      google.maps.event.addListener(marker, "dragend", (e)=> validateAndSetPosition(e.latLng));
      google.maps.event.addListener(map, "click", (e)=> validateAndSetPosition(e.latLng));

      const dragHint = document.getElementById("drag-instructions");
      setTimeout(()=> dragHint.style.display="none", 5000);
      google.maps.event.addListener(map, "dragstart", ()=> dragHint.style.display="none");
    }
    window.myMap = myMap;

    function validateAndSetPosition(latLng){
      if (polygon && !google.maps.geometry.poly.containsLocation(latLng, polygon)) {
        alert("⚠️ عذرًا، موقعك خارج نطاق الخدمة");
        position = "";
        infoWindow.setContent("🚫 موقع خارج الخدمة");
        infoWindow.open(map);
        return;
      }
      marker.setPosition(latLng);
      map.panTo(latLng);
      map.setZoom(17);
      position = `${prePosition}${latLng.lat()},${latLng.lng()}`;
      infoWindow.setContent("✅ تم تحديث موقعك هنا");
      infoWindow.open(map, marker);
    }

    function detectMyLocation(){
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const userPos = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
            if (polygon && !google.maps.geometry.poly.containsLocation(userPos, polygon)) {
              alert("⚠️ عذرًا، موقعك خارج نطاق الخدمة");
              return;
            }
            marker.setPosition(userPos);
            map.panTo(userPos);
            map.setZoom(17);
            position = `${prePosition}${pos.coords.latitude},${pos.coords.longitude}`;
            infoWindow.close();
          },
          () => handleLocationError(true)
        );
      } else { handleLocationError(false); }
    }
    function handleLocationError(browserHasGeolocation) {
      infoWindow.setPosition(map.getCenter());
      infoWindow.setContent(browserHasGeolocation ? "⚠️ تعذر الحصول على موقعك. يرجى السماح بالوصول للموقع." : "⚠️ جهازك لا يدعم تحديد الموقع.");
      infoWindow.open(map);
    }
    document.addEventListener("DOMContentLoaded", function () {
      document.getElementById('show-my-location')?.addEventListener("click", detectMyLocation);
    });

    /* ---- restore ---- */
    function restoreUser(){
      try {
        const savedName = localStorage.getItem("name");
        const savedMobile = localStorage.getItem("mobile");
        if (savedName) document.getElementById("name").value = savedName;
        if (savedMobile && iti) iti.setNumber("+"+savedMobile);
      } catch(e){}
    }

    /* ---- boot ---- */
    document.addEventListener('DOMContentLoaded', ()=>{
      initPhoneInput();
      initCarBrands();
      loadLocations();
      setMinToday();
      restoreUser();
    });
  </script>

  <!-- Google Maps -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBBHLoO038vsCovHN-SLUgAXqexlA2v0_4&callback=myMap&libraries=geometry" async defer></script>
</body>
</html>
