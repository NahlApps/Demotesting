<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Primary Meta Tags -->
  <title>حجوزات المواعيد</title>
  <meta name="title" content="حجوزات المواعيد" />
  <meta name="description" content="1. بنغسل سيارتك بخلطة خاصة مدعّمة بالواكس تحميها من الغبار والخدوش. 2. فوطنا دايمًا نظيفة. 3. ونستخدم إسفنجة مخصوصة للكفرات عشان نهتم بكل تفاصيل سيارتك. #غسيل_بدون_طوابير" />

  <!-- SEO / Sharing -->
  <meta itemprop="name" content="حجوزات المواعيد" />
  <meta itemprop="description" content="1. بنغسل سيارتك بخلطة خاصة مدعّمة بالواكس تحميها من الغبار والخدوش. 2. فوطنا دايمًا نظيفة. 3. ونستخدم إسفنجة مخصوصة للكفرات عشان نهتم بكل تفاصيل سيارتك. #غسيل_بدون_طوابير" />
  <meta itemprop="image" content="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/Logo%20-%20Sponge%20and%20Soap%20-%201.png" />

  <!-- Open Graph -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://www.spongnsoap.com" />
  <meta property="og:title" content="حجوزات المواعيد" />
  <meta property="og:description" content="1. بنغسل سيارتك بخلطة خاصة مدعّمة بالواكس تحميها من الغبار والخدوش. 2. فوطنا دايمًا نظيفة. 3. ونستخدم إسفنجة مخصوصة للكفرات عشان نهتم بكل تفاصيل سيارتك. #غسيل_بدون_طوابير" />
  <meta property="og:image" content="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/Logo%20-%20Sponge%20and%20Soap%20-%201.png" />

  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image" />
  <meta property="twitter:url" content="https://www.spongnsoap.com" />
  <meta property="twitter:title" content="حجوزات المواعيد" />
  <meta property="twitter:description" content="1. بنغسل سيارتك بخلطة خاصة مدعّمة بالواكس تحميها من الغبار والخدوش. 2. فوطنا دايمًا نظيفة. 3. ونستخدم إسفنجة مخصوصة للكفرات عشان نهتم بكل تفاصيل سيارتك. #غسيل_بدون_طوابير" />
  <meta property="twitter:image" content="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/Logo%20-%20Sponge%20and%20Soap%20-%201.png" />

  <link rel="shortcut icon" href="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/Logo%20-%20Sponge%20and%20Soap%20-%201.png" type="image/x-icon" />

  <!-- Libs -->
  <script src="https://code.jquery.com/jquery-3.6.3.slim.min.js" crossorigin="anonymous"></script>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  <!-- Luxon -->
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>

  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

  <!-- intl-tel-input -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/css/intlTelInput.css" />
  <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/intlTelInputWithUtils.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');
    :root{
      --brand-300:#48b5d0; --brand-500:#0394b6; --brand-600:#027790;
      --accent-500:#F4CE14;
      --success-500:#2BA24C; --warning-500:#F3A100; --danger-500:#D64545; --info-500:#3A7AFE;
      --bg:#F5F7F8; --surface:#FFFFFF; --surface-2:#FAFBFC; --border:#E7EBEF;
      --text:#45474B; --text-muted:#6B7075; --text-inverse:#FFFFFF;
      --gradient-primary: linear-gradient(135deg, var(--brand-500), var(--brand-300));
      --shadow-1: 0 2px 10px rgba(0,0,0,.08); --shadow-2: 0 6px 18px rgba(0,0,0,.12);
      --radius-s:8px; --radius-m:12px; --radius-l:16px;
      --gap-1:8px; --gap-2:12px; --gap-3:16px; --gap-4:24px; --gap-5:32px;
      --ring: 0 0 0 3px color-mix(in srgb, var(--brand-500) 25%, transparent);
      --speed-fast:150ms; --speed:250ms; --speed-slow:350ms;
      --control-h: 42px; --fab-size:56px;
      --font: "Cairo", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans";
    }
    [data-theme="dark"]{
      --bg:#121418; --surface:#161A1F; --surface-2:#1B2026; --border:#2A2F35;
      --text:#E7ECEF; --text-muted:#AAB2BB;
      --shadow-1: 0 2px 10px rgba(0,0,0,.5);
      --ring: 0 0 0 3px color-mix(in srgb, var(--brand-300) 35%, transparent);
    }
    html, body{ margin:0; min-height:100dvh; width:100%; overflow-x:hidden; background: var(--bg); color: var(--text); font-family: var(--font); font-weight: 500; }
    h1,h2,h3,h4{ margin:0 0 var(--gap-3); line-height:1.25; font-weight:700; }
    h1{ font-size: clamp(24px, 2vw + 18px, 32px); }
    h2{ font-size: clamp(20px, 1.5vw + 14px, 26px); }
    h3{ font-size: clamp(18px, 1.2vw + 12px, 22px); }
    :focus-visible{ outline: none; box-shadow: var(--ring); border-radius: var(--radius-s); }
    .container-page{ max-width: 1200px; margin-inline:auto; padding-inline: clamp(12px, 3vw, 24px); }
    .filter-button{ display:inline-flex; align-items:center; justify-content:center; gap:10px; min-height: var(--control-h); padding-inline: 18px; border-radius: var(--radius-m); border:1px solid transparent; background: var(--brand-500); color:#fff; font-weight:700; cursor:pointer; text-align:center; box-shadow: var(--shadow-1); transition: transform var(--speed), box-shadow var(--speed), background var(--speed); width: 100%; }
    .filter-button:hover{ background: var(--brand-600); transform: translateY(-1px); box-shadow: var(--shadow-2); }
    .input, input[type="text"], input[type="tel"], input[type="date"], select, textarea, .select2-container .select2-selection{ background: var(--surface); color: var(--text); border:1px solid var(--border); border-radius: var(--radius-m); min-height: var(--control-h); padding-inline: 12px; transition: box-shadow var(--speed), border-color var(--speed), background var(--speed); }
    input:focus, select:focus, textarea:focus, .select2-container--default .select2-selection--single:focus{ border-color: var(--brand-500); box-shadow: var(--ring); }
    .select2-container .select2-selection__rendered{ line-height: calc(var(--control-h) - 12px)!important; }
    .select2-container .select2-selection--single{ height: var(--control-h)!important; }
    .select2-container .select2-selection__arrow{ height: var(--control-h)!important; }
    .time-container{ display:grid; gap: var(--gap-3); grid-template-columns: repeat(3, 1fr); background: var(--surface); border:1px solid var(--border); border-radius: var(--radius-m); padding: var(--gap-3); height: 23rem; overflow-y:auto; }
    @media (max-width: 900px){ .time-container{ grid-template-columns: repeat(2,1fr);} }
    @media (max-width: 560px){ .time-container{ grid-template-columns: 1fr; } }
    .time-button{ background: var(--surface-2); border:1px solid var(--border); border-radius: var(--radius-m); min-height:56px; display:flex; align-items:center; justify-content:center; font-weight:700; cursor:pointer; transition: transform var(--speed), box-shadow var(--speed), background var(--speed), border-color var(--speed); }
    .time-button:hover{ background:#fff; transform: translateY(-1px); box-shadow: var(--shadow-2); border-color: var(--brand-300); }
    .bg-image{ position: fixed; inset: 0; z-index: -1; background: url("https://www.dropbox.com/s/s9bxuykl0w49dqa/background2.jpg?raw=1") center/cover no-repeat; filter: blur(8px); }
    #form{ background: var(--brand-300); color:#fff; box-shadow: 0 0 5px 10px rgba(5,28,59,0.18), 10px 0 70px 0 rgba(5,28,59,0.18); display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:100dvh; }
    #form-content{ width:100%; display:flex; flex-direction:column; }
    #page1,#page2,#page3,#page4,#page5,#page6,#page7{ display:none; flex-direction:column; align-items:center; justify-content:center; min-height:70dvh; padding: 12px; }
    #page1{ display:flex; }
    .drag-hint{ position:absolute; inset-inline:50%; transform: translateX(-50%); top: 12px; z-index: 5; background: color-mix(in srgb, #fff 90%, transparent); border:1px solid var(--border); border-radius: 999px; padding: 6px 12px; display:flex; align-items:center; gap:8px; box-shadow: var(--shadow-1); }
    .social-fab{ position: fixed; left: 15px; z-index: 999; width: 56px; height: 56px; border-radius: 50%; display:flex; align-items:center; justify-content:center; color:#fff; text-decoration:none; background: rgba(34,34,34,.55); backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px); box-shadow: 0 8px 20px rgba(0,0,0,.35), 0 0 0 2px rgba(255,255,255,.10) inset; transition: transform 150ms, box-shadow 150ms, opacity 150ms; }
    .social-fab:hover{ transform: translateY(-2px); box-shadow: 0 12px 26px rgba(0,0,0,.45), 0 0 0 2px var(--brand-500) inset, 0 0 14px var(--brand-500); }
    .social-fab.whatsapp-button{ bottom:15px; } .social-fab.instagram-button{ bottom:74px; } .social-fab.tiktok-button{ bottom:133px; }
  </style>
</head>

<body>
  <div class="bg-image" aria-hidden="true"></div>

  <div id="banner">
    <div class="header" style="text-align:center; color:#fff; font-weight:700; padding: 24px 0; background: linear-gradient(135deg, #0394b6, #48b5d0);">
      <img src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/spong&Soap%20-%20logo.png" alt="Sponge & Soap" loading="lazy" style="width:220px;" />
    </div>
  </div>

  <div id="form" class="container-page">
    <div id="form-content">

      <!-- Page 1 -->
      <div id="page1">
        <div style="text-align:center; margin-bottom:16px;">
          <h3 style="line-height:2;">
            ✨ واكس يحمي سيارتك<br />
            🧼 فوط نظيفة & لمعان مضمون<br />
            🛞 إسفنجة للكفرات<br /><br />
            ... نهتم بكل التفاصيل
          </h3>
          <p><span style="font-weight:bold; font-size:18px;">#غسيل_بدون_طوابير</span></p>
        </div>
        <div style="max-width:320px; width:100%;">
          <button id="page1-button" class="filter-button">احجز موعدك</button>
        </div>
      </div>

      <!-- Page 2 -->
      <div id="page2" role="region" aria-labelledby="p2title">
        <h1 id="p2title">وين تحب نجيك؟<br/>اختيار المنطقة</h1>

        <form onsubmit="handleSubmit(event)" id="page2-form" style="width:100%; max-width:720px;">
          <div id="select2-container" style="position:relative; margin-bottom:16px;">
            <label style="width:100%; display:block;">
              <span style="font-size:12px;font-weight:700;display:block;margin-bottom:6px;">المنطقة</span>
              <select id="area" class="js-example-basic-single" style="width:100%;" required onchange="setBoundries()"></select>
            </label>
            <div id="page2-spinner" style="position:absolute; inset-inline-start:50%; transform:translateX(-50%); display:none;">
              <div class="spinner-border" role="status" style="width:1.5rem; height:1.5rem;"></div>
            </div>
          </div>

          <div style="margin-bottom:16px; position:relative;">
            <label style="width:100%; display:block;">
              <span style="font-size:12px;font-weight:700;display:block;margin-bottom:6px;">الخدمة</span>
              <select id="service" style="width:100%;" required></select>
            </label>
            <div id="page3-2-spinner" style="position:absolute; inset-inline-start:50%; transform:translateX(-50%); display:none;">
              <div class="spinner-border" role="status" style="width:1.5rem; height:1.5rem;"></div>
            </div>
          </div>
        </form>

        <div style="max-width:320px; width:100%;">
          <button id="page2-button" class="filter-button" type="button">التالي</button>
        </div>
      </div>

      <!-- Page 3 (loading step) -->
      <div id="page3" role="region" aria-labelledby="p3title" style="position:relative;">
        <div id="page3-wait" style="display:flex; position:absolute; inset:0; background: rgba(0,0,0,.6); z-index:10; justify-content:center; align-items:center; flex-direction:column;">
          <div class="spinner-border text-light" role="status"><span class="visually-hidden">Loading...</span></div>
          <p style="color:#fff; margin-top:1em; font-size:1.2em;">جاري جلب المواعيد…</p>
        </div>
      </div>

      <!-- Page 4 -->
      <div id="page4" role="region" aria-labelledby="p4title">
        <h1 id="p4title">متى تحب نجيك؟<br/>اختيار الموعد</h1>

        <input type="date" id="date" name="date" class="form-control input" style="text-align:center; width: min(420px, 90%);" />

        <div class="time-date-box" style="width:100%; max-width:900px; margin-top:16px;">
          <div id="time-date-header" class="time-date-header" hidden>
            <div id="dayHeader1" class="choosed" style="border-radius:0 10px 0 0;"><span id="day1">sunday</span><br/><span id="day1date">—</span></div>
            <div id="dayHeader2"><span id="day2">monday</span><br/><span id="day2date">—</span></div>
            <div id="dayHeader3" style="border-radius: 10px 0 0 0;"><span id="day3">tuesday</span><br/><span id="day3date">—</span></div>
          </div>

          <div id="time-container" class="time-container" dir="rtl"></div>

          <div id="fail-alert-3" class="alert alert-danger" role="alert" style="display:none; margin-top:16px;">
            <span></span><br/><span></span>
          </div>
        </div>

        <div style="max-width:320px; width:100%;">
          <button id="page4-return" class="filter-button" style="background:#fff; color:var(--brand-500); border:1px solid var(--brand-500);" type="button">السابق</button>
        </div>
      </div>

      <!-- Page 5 -->
      <div id="page5" role="region" aria-labelledby="p5title" style="width:100%; max-width:720px;">
        <h2 id="p5title">معلومات الاتصال</h2>

        <form onsubmit="handleSubmit(event)" id="page5-form" style="width:100%;">
          <label style="width:100%; display:block; margin-bottom:12px;">
            <span style="font-size:12px;font-weight:700;display:block;margin-bottom:6px;">الإسم</span>
            <input id="name" type="text" class="input" required />
          </label>

          <label style="width:100%; display:block; margin-bottom:12px;">
            <span style="font-size:12px;font-weight:700;display:block;margin-bottom:6px;">رقم الجوال</span>
            <input type="tel" id="mobile" class="input" style="width:100%;" />
          </label>

          <h2 style="margin-bottom:12px;">معلومات المركبة</h2>

          <div style="width:100%; margin-bottom:12px;">
            <label style="width:100%; display:block;">
              <span style="font-size:12px;font-weight:700;display:block;margin-bottom:6px;">🚘 ماركة السيارة</span>
              <select id="carBrand" style="width:100%;"></select>
            </label>
          </div>

          <div style="display:flex; gap:16px; flex-wrap:wrap; width:100%;">
            <div style="flex:1; min-width:240px;">
              <label style="width:100%; display:block;">
                <span style="font-size:12px;font-weight:700;display:block;margin-bottom:6px;">اسم السيارة</span>
                <input type="text" id="carName" class="input" placeholder="GT-R, كامري، إلنترا" oninput="updateLocationDescription()" />
              </label>
            </div>
            <div style="flex:1; min-width:240px;">
              <label style="width:100%; display:block;">
                <span style="font-size:12px;font-weight:700;display:block;margin-bottom:6px;">رقم اللوحة</span>
                <input type="text" id="plateNumber" class="input" maxlength="4" placeholder="🔢 مثال: 1234" inputmode="numeric" pattern="^\\d{1,4}$" required />
              </label>
              <div id="plateError" class="text-danger" style="display:none; font-size:13px; margin-top:6px;">الرجاء إدخال رقم لوحة صحيح (1–4 أرقام).</div>
            </div>
          </div>

          <div hidden>
            <input type="text" id="locationDescription" class="input" readonly placeholder="ماركة السيارة, اسم السيارة, رقم اللوحة" />
          </div>

          <h2 style="margin-top:16px; margin-bottom:12px;">طريقة الدفع</h2>
          <div style="display:flex; gap:12px; flex-wrap:wrap;">
            <label style="flex:1; min-width:160px; display:flex; align-items:center; justify-content:center; border:1px solid var(--border); border-radius:12px; background:#fff; padding:14px; min-height:64px; cursor:pointer;">
              <input type="radio" name="payingMethod" value="Cash" required style="position:absolute; opacity:0;" />
              <img src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/CASH%20LOGO.png" alt="Cash" width="125" height="40" loading="lazy" />
            </label>
            <label style="flex:1; min-width:160px; display:flex; align-items:center; justify-content:center; border:1px solid var(--border); border-radius:12px; background:#fff; padding:14px; min-height:64px; cursor:pointer;">
              <input type="radio" name="payingMethod" value="STC Pay" required style="position:absolute; opacity:0;" />
              <img src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/STC%20PAY%20LOGO.png" alt="STC Pay" width="125" height="40" loading="lazy" />
            </label>
            <label style="flex:1; min-width:160px; display:flex; align-items:center; justify-content:center; border:1px solid var(--border); border-radius:12px; background:#fff; padding:14px; min-height:64px; cursor:pointer;">
              <input type="radio" name="payingMethod" value="MADA" required style="position:absolute; opacity:0;" />
              <img src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/MADA%20LOGO.png" alt="MADA" width="125" height="40" loading="lazy" />
            </label>
          </div>
        </form>

        <div style="max-width:320px; width:100%; margin-top:16px;">
          <button id="page5-button" class="filter-button" type="button">التالي</button>
          <div style="height:12px;"></div>
          <button id="page5-return" class="filter-button" style="background:#fff; color:var(--brand-500); border:1px solid var(--brand-500);" type="button">السابق</button>
        </div>
      </div>

      <!-- Page 6 -->
      <div id="page6" role="region" aria-labelledby="p6title" style="width:100%; max-width:900px;">
        <h2 id="p6title" style="margin-bottom:12px;">الموقع على خريطة قوقل</h2>

        <div id="drag-instructions" class="drag-hint">
          <i class="fas fa-hand-point-right" aria-hidden="true"></i>
          <span>📍 اسحب الخريطة لتغيير الموقع</span>
        </div>

        <div style="border:1px solid var(--border); border-radius:16px; overflow:hidden; box-shadow: var(--shadow-1); background:#fff; margin-bottom:12px;">
          <div id="googleMap" style="width:100%; height:400px;"></div>
        </div>

        <p style="text-align:center; font-size:14px; color:#333; margin-bottom:10px;">
          📍 <strong>قم بسحب المؤشر أو اضغط على اظهار موقعي</strong>
        </p>

        <div style="max-width:320px; width:100%;">
          <button class="filter-button" id="show-my-location" type="button" style="background:#fff; color:var(--brand-500); border:1px solid var(--brand-500);">اظهار موقعي</button>
        </div>

        <div style="max-width:320px; width:100%; margin-top:16px;">
          <button id="page6-button" class="filter-button" type="button">التالي</button>
          <div style="height:12px;"></div>
          <button id="page6-return" class="filter-button" style="background:#fff; color:var(--brand-500); border:1px solid var(--brand-500);" type="button">السابق</button>
        </div>

        <div id="page6-spinner" style="display:none; flex-direction:column; align-items:center; margin-top:1em;">
          <span class="mt-3"></span>
          <div class="spinner-border" role="status" style="display:none; margin-top:30px;">
            <span class="sr-only">Loading...</span>
          </div>
        </div>

        <div id="fail-alert-5" class="alert alert-danger" role="alert" style="display:none; margin-top:16px;">
          <span></span><br/><span></span>
        </div>
      </div>

      <!-- Page 7 -->
      <div id="page7" dir="rtl" role="region" aria-live="polite">
        <h1>شكراً لكم</h1>
        <h2>تم حجز الموعد، وراح نأكده لكم على الواتساب</h2>
        <h3>متحمسين نجيكم!!</h3>
        <div style="max-width:320px; width:100%;">
          <button id="rebook" class="filter-button">🔁 حجز جديد</button>
        </div>
      </div>

      <footer dir="rtl" style="text-align:center; margin-top:20px;">
        <p>Sponge & Soap</p>
        <a target="_blank" href="https://www.instagram.com/nahl.app?igsh=Y3YyOW05MGI5bnNv&utm_source=qr" style="color:inherit; text-decoration:none; border-bottom:1px dotted rgba(0,0,0,.3);">Made with Nahl Perfection</a>
      </footer>
    </div>
  </div>

  <!-- Social FABs -->
  <a target="_blank" href="https://wa.me/966503668222" class="social-fab whatsapp-button" aria-label="تواصل عبر واتساب"><i class="fab fa-whatsapp" aria-hidden="true"></i></a>
  <a target="_blank" href="https://www.instagram.com/sponge.soap_sa?igsh=MWRtOHI5OHZpbWpvdA==" class="social-fab instagram-button" aria-label="تابعنا على إنستغرام"><i class="fab fa-instagram" aria-hidden="true"></i></a>
  <a target="_blank" href="https://www.tiktok.com/@sponge.soap_sa?_t=ZS-8zaj1CA4aJg&_r=1" class="social-fab tiktok-button" aria-label="تابعنا على تيك توك"><i class="fab fa-tiktok" aria-hidden="true"></i></a>

  <!-- Terms Modal -->
  <div class="modal fade" id="termsModal" tabindex="-1" aria-hidden="true" dir="rtl">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">الشروط والأحكام – مغسلة سيارات متنقلة</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
        </div>
        <div class="modal-body" style="text-align:right;">
          <ol style="padding-right:1rem;">
            <li><strong>الخدمات المقدمة</strong><ul><li>تقدم المغسلة خدمات غسيل وتنظيف السيارات وفق الباقات المعروضة على الموقع أو حسب الاتفاق المسبق.</li></ul></li>
            <li><strong>حجز المواعيد</strong><ul><li>يتم الحجز عبر الموقع أو من خلال التواصل المباشر.</li><li>يحق للمغسلة تعديل أو إلغاء الموعد في حال وجود ظرف طارئ مع إشعار العميل.</li></ul></li>
            <li><strong>الدفع</strong><ul><li>يتم الدفع عبر الوسائل المتاحة (تحويل بنكي، مدى، بطاقة إئتمانية، STC Bank، Apple Pay، نقدًا).</li><li>يجب سداد المبلغ كاملاً قبل بدء الخدمة. وفي حال عدم السداد يحق للمغسلة إلغاء الموعد.</li></ul></li>
            <li><strong>إلغاء الخدمة واسترجاع المبلغ</strong><ul><li>في حال إلغاء الحجز قبل 3 ساعات من الموعد، يحق للعميل استرداد المبلغ أو إعادة جدولة الموعد.</li><li>لا يحق للعميل طلب استرداد المبلغ أو جدولة الموعد في حال تم الإلغاء خلال أقل من 3 ساعات.</li></ul></li>
            <li><strong>مسؤولية المغسلة</strong><ul><li>تلتزم المغسلة بتقديم الخدمة بأفضل جودة ممكنة باستخدام مواد آمنة.</li><li>المغسلة غير مسؤولة عن أي أعطال ميكانيكية أو كهربائية أو تلفيات سابقة في السيارة.</li><li>في حال وقوع ضرر ناتج عن خطأ مباشر من فريق العمل، تتحمل المغسلة مسؤولية تعويض عادل يقتصر على قيمة الضرر المباشر.</li></ul></li>
            <li><strong>مسؤولية العميل</strong><ul><li>يجب على العميل إزالة أو إخلاء السيارة من أي متعلقات شخصية أو ثمينة قبل بدء الخدمة.</li><li>المغسلة غير مسؤولة عن فقدان أو تلف أي أغراض شخصية تُترك داخل السيارة.</li><li>توفير مكان مناسب وآمن لإتمام الخدمة (موقف، تصريح دخول، إلخ).</li></ul></li>
            <li><strong>الوقت والتأخير</strong><ul><li>مدة الخدمة تقريبية وقد تختلف حسب حالة السيارة.</li><li>يلتزم العميل بالتواجد في الموقع بالوقت المحدد، والتأخير عن الموعد كحد اقصى 15 دقيقة ويعتبر الموعد لاغيًا بعد هذه المدة.</li></ul></li>
            <li><strong>التعديلات على الشروط والأحكام</strong><ul><li>تحتفظ المغسلة بحق تعديل أو تحديث هذه الشروط والأحكام في أي وقت.</li><li>تعتبر موافقة العميل على الخدمة قبولًا لهذه الشروط والأحكام.</li></ul></li>
            <li><strong>القانون المعمول به</strong><ul><li>تخضع هذه الشروط والأحكام لأنظمة وقوانين المملكة العربية السعودية.</li></ul></li>
          </ol>

          <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" id="termsAccept" />
            <label class="form-check-label" for="termsAccept">أوافق على الشروط والأحكام</label>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn" style="background:#fff; color:var(--brand-500); border:1px solid var(--brand-500);" data-bs-dismiss="modal">إلغاء</button>
          <button class="btn" id="confirmTerms" disabled style="background:var(--brand-500); color:#fff;">تأكيد ومتابعة</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const { DateTime } = luxon;

    // API endpoints
    const defaultLink2 = `https://nahl-platform.vercel.app/api/app/AM/general/${'33e0d05d-d771-46f4-a7e7-7c634b4e3a9e'}/form`;
    const defaultLink = defaultLink2; // legacy alias

    // State
    let services, serviceCategories;
    let day1 = DateTime.now();
    let appointments = [[],[],[]];
    let ActualTimes = [[],[],[]];
    let map, infoWindow, marker, polygon = null;
    let position = "";
    let defaultLocation = { lat: 26.34165524787632, lng: 50.11524831545726 };
    const prePosition = "https://www.google.com/maps/search/?api=1&query=";
    const weekdaysAR = ["الأحد","الإثنين","الثلاثاء","الأربعاء","الخميس","الجمعة","السبت","الأحد"];
    let iti, errorMap;

    function handleSubmit(e){ e.preventDefault(); }

    function initPhoneInput(){
      const input = document.querySelector("#mobile");
      iti = window.intlTelInput(input, {
        utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/utils.js",
        countryOrder:["sa","qa"],
        initialCountry:"sa",
        onlyCountries:["sa","qa","ae","om","kw","bh"],
        excludeCountries:["il"],
        strictMode:true,
        i18n:{ ae:"الإمارات العربية المتحدة", bh:"البحرين", kw:"الكويت", sa:"المملكة العربية السعودية" }
      });
      errorMap = ["رقم غير صحيح", "رمز دولة غير صحيح", "المُدخل أقصر من المتوقع", "المُدخل أطول من المتوقع", "رقم غير صحيح"];
    }
    function checkNumberValidity(){
      const number = document.getElementById("mobile");
      const phoneNumber = iti.getNumber().substring(1);
      if (isNaN(phoneNumber) || !iti.isValidNumber() || phoneNumber === ""){
        const msg = errorMap[iti.getValidationError()] || "رقم غير صحيح";
        number.setCustomValidity(msg);
        return false;
      }
      number.setCustomValidity("");
      return true;
    }

    // Fetch helper
    let controllers = [];
    async function callContent2(routText, callback, abortable = false, retries=3){
      let signal = '';
      if (abortable) {
        if( controllers.length > 0 ){
          for (let i = 0; i < controllers.length; i++) controllers[i][0].abort();
          controllers = [];
        }
        const controller = new AbortController();
        signal = controller.signal;
        controllers.push([controller, signal]);
      }
      await new Promise(r => setTimeout(r, 200));
      fetch(defaultLink2 + `${routText}`, { redirect:"follow", method:"GET", ...(abortable && {signal}) })
      .then(async (response) => {
        if (!response.ok) {
          if (retries > 0) return callContent2(routText, callback, abortable, retries-1);
          throw new Error('Network response was not ok');
        }
        const json = await response.json();
        callback(json);
      })
      .catch(err => {
        if(!String(err.message).includes("aborted")){
          setTimeout(()=>{ if (retries > 0) return callContent2(routText, callback, abortable, retries-1); }, 900);
        }
      });
    }

    // Locations
    function loadLocations(){
      document.getElementById("page2-spinner").style.display = "block";
      callContent2(`/locations`,(data)=>{
        const select = $('#area'); select.empty();
        const locations = data?.data || [];
        const selectData = locations.map(loc => ({ id: loc.id, text: loc.TS_location_arabic_name }));
        select.select2({ data: selectData.sort((a,b)=>a.id-b.id), width: "100%", dir:'rtl', placeholder: "اختر المنطقة" });
        $('#area').trigger('change');
        document.getElementById("page2-spinner").style.display = "none";
      }, true);
    }

    // Area → services
    $("#area").on("change", () => {
      document.getElementById("page3-2-spinner").style.display = "block";
      $("#service").empty();
      callContent2(`/services?location=${document.getElementById("area").value}`, (data) => {
        services = data.data.services || [];
        serviceCategories = data.data.servicesCat || [];
        const myServices = services
          .filter(s => (s.location||[]).includes(Number(document.getElementById("area").value)))
          .sort((a,b)=> a.TS_service_id - b.TS_service_id);

        const svcSelect = $('#service');
        myServices.forEach(s => {
          const name = s.TS_service_arabic_name || s.TS_service_english_name || ("خدمة " + s.TS_service_id);
          svcSelect.append(new Option(name, s.TS_service_id));
        });
        $('#service').trigger('change');
        document.getElementById("page3-2-spinner").style.display = "none";
      }, true);
    });

    // ✅ FIX: when service changes, refresh slots immediately
    document.addEventListener('change', (e)=>{
      if (e.target && e.target.id === 'service'){
        // if user is already on date/slots, just reload; otherwise it will load when navigating
        if (document.getElementById('page4').style.display !== 'none'){
          document.getElementById('date').dispatchEvent(new Event('change'));
        }
      }
    });

    function setMinToday(){
      document.getElementById("date").setAttribute("min", DateTime.now().toFormat("yyyy-LL-dd"));
      document.getElementById('date').value = DateTime.now().toFormat('yyyy-LL-dd');
    }
    function setupDate(){
      const d1 = DateTime.fromISO(document.getElementById('date').value);
      const d2 = d1.plus({days:1}), d3 = d1.plus({days:2});
      for(let i=1;i<=3;i++){
        const d = i===1?d1:i===2?d2:d3;
        document.getElementById(`day${i}`).innerText = weekdaysAR[ d.weekday % 7 ];
        document.getElementById(`day${i}date`).innerText = d.toFormat('yyyy-LL-dd');
      }
    }
    function timesSetter(index){
      let timeContainer = document.getElementById("time-container");
      timeContainer.innerHTML = "";
      if(appointments[index].length === 0){
        timeContainer.innerHTML = `<div style="grid-column: 1/-1; text-align:center; color:#555;">لا توجد مواعيد متاحة</div>`;
        return;
      }
      for (let y = 0; y < appointments[index].length; y++){
        timeContainer.innerHTML += `<button onclick="choosedDate('${ActualTimes[index][y]}','${document.getElementById('day'+(index+1)+'date').innerText}',4)" class="time-button" dir="ltr">${appointments[index][y]}</button>`;
      }
    }

    // ✅ Page 3 → 4 auto-navigation after slots load
    function goToPage4IfOnPage3(){
      const p3 = document.getElementById('page3');
      const p4 = document.getElementById('page4');
      if (window.getComputedStyle(p3).display !== 'none'){
        p3.style.display = 'none';
        p4.style.display = 'flex';
      }
    }

    document.getElementById('date').onchange = () => {
      const dateEl = document.getElementById('date');
      dateEl.disabled = true;

      document.getElementById('time-container').innerHTML = `<div class="spinner-border" role="status" style="grid-column:1/-1; justify-self:center;"><span class="visually-hidden">Loading...</span></div>`;
      appointments = [[],[],[]]; ActualTimes = [[],[],[]];

      setupDate();

      // show loader overlay if we're on page3 (first load coming from page2)
      if (document.getElementById('page3').style.display !== 'none'){
        document.getElementById('page3-wait').style.display = 'flex';
      }

      const loc = document.getElementById("area").value;
      const svc = document.getElementById("service").value;
      const start = DateTime.fromISO(dateEl.value).toFormat('yyyy-LL-dd');

      callContent2(`/appointments?startDate=${start}&location=${loc}&service=${svc}`, (data) => {
        const recievedDates = data?.data?.appointments || [];
        const tempActualTimes = [];
        for (let i = 0; i < recievedDates.length; i++){
          const d = luxon.DateTime.fromISO(recievedDates[i]['TS_appointment_date'], { setZone:true });
          const t = luxon.DateTime.fromISO(recievedDates[i]['TS_appointment_time'], { setZone:true });
          recievedDates[i]['TS_appointment_date'] = d.toISODate();
          recievedDates[i]['TS_appointment_time'] = t.toLocaleString(luxon.DateTime.TIME_SIMPLE).replace(" ", " ");
          tempActualTimes[i] = t.toFormat('hh:mm a');
        }

        const d1s = start, d2s = DateTime.fromISO(start).plus({days:1}).toFormat('yyyy-LL-dd'), d3s = DateTime.fromISO(start).plus({days:2}).toFormat('yyyy-LL-dd');
        for (let i=0;i<recievedDates.length;i++){
          const item = recievedDates[i];
          if (item.TS_appointment_date === d1s){ appointments[0].push(item.TS_appointment_time); ActualTimes[0].push(tempActualTimes[i]); }
          else if (item.TS_appointment_date === d2s){ appointments[1].push(item.TS_appointment_time); ActualTimes[1].push(tempActualTimes[i]); }
          else if (item.TS_appointment_date === d3s){ appointments[2].push(item.TS_appointment_time); ActualTimes[2].push(tempActualTimes[i]); }
        }

        timesSetter(0);
        document.getElementById('page3-wait').style.display = 'none';
        dateEl.disabled = false;

        // ✅ move forward automatically if we were on the loading step
        goToPage4IfOnPage3();
      }, true);
    };

    // Form model
    var nForm = { date:'', time:'', location:'', service:'', serviceCount:'', serviceCat:'', customerM:'', customerN:'', paymentMethod:'', urlLocation:'', locationDescription:'' };

    // Navigation
    for (let i = 1; i < 7; i++) {
      if (i === 4) continue;
      const nextBtn = document.getElementById(`page${i}-button`);
      const page = document.getElementById(`page${i}`);
      const nextPage = document.getElementById(`page${i+1}`);
      if (!nextBtn || !page || !nextPage) continue;

      if (i === 2){
        nextBtn.onclick = () => {
          const area = document.getElementById("area");
          const service = document.getElementById("service");
          if (!area.value || !service.value){
            document.getElementById("page2-form").reportValidity();
            return;
          }
          nForm.location = area.value;
          nForm.service = service.value;

          // Show Page 3 (loader)
          page.style.display = "none";
          document.getElementById('page3').style.display = "flex";
          document.getElementById('page3-wait').style.display = "flex";

          // Trigger date load → will auto-navigate to Page 4 once loaded
          document.getElementById('date').dispatchEvent(new Event('change'));
        };
      } else if (i === 5){
        nextBtn.onclick = () => {
          const name = document.getElementById("name");
          const form = document.getElementById("page5-form");
          const plate = document.getElementById("plateNumber");
          let payingMethod = '';

          try {
            payingMethod = document.querySelector('input[name="payingMethod"]:checked').value;
            if (name.value.trim() === ""){
              name.setCustomValidity("يُرجى ملء هذا الحقل");
              throw new Error("no name");
            } else { name.setCustomValidity(""); }
          } catch (e) { form.reportValidity(); return; }

          if (!checkNumberValidity()){ form.reportValidity(); return; }

          const isPlateOk = /^\d{1,4}$/.test(plate.value);
          document.getElementById("plateError").style.display = isPlateOk ? "none" : "block";
          if (!isPlateOk){
            plate.setCustomValidity("الرجاء إدخال رقم لوحة صحيح (1–4 أرقام)");
            form.reportValidity();
            return;
          }
          plate.setCustomValidity("");

          nForm.paymentMethod = payingMethod;
          nForm.customerN = name.value.trim();
          nForm.customerM = iti.getNumber().substring(1);

          page.style.display = "none"; nextPage.style.display = "flex";
        };
      } else if (i === 6){
        nextBtn.onclick = () => {
          if (!position) {
            const failAlert = document.getElementById('fail-alert-5');
            failAlert.style.display = "block";
            failAlert.children[0].innerText = "الرجاء تحديد الموقع";
            return;
          }

          const termsModalEl = document.getElementById('termsModal');
          const termsModal = new bootstrap.Modal(termsModalEl);
          const acceptCheckbox = document.getElementById('termsAccept');
          const confirmBtn = document.getElementById('confirmTerms');
          acceptCheckbox.checked = false; confirmBtn.disabled = true;
          acceptCheckbox.onchange = () => { confirmBtn.disabled = !acceptCheckbox.checked; };
          termsModal.show();

          confirmBtn.onclick = () => {
            termsModal.hide();

            const pageSpinner = document.getElementById('page6-spinner');
            const btnPrev = document.getElementById('page6-return');
            const btnNext = document.getElementById('page6-button');
            const failAlert = document.getElementById('fail-alert-5');

            btnPrev.style.display = "none"; btnNext.style.display = "none";
            failAlert.style.display = "none";
            pageSpinner.style.display = "flex"; pageSpinner.children[1].style.display = "block";

            nForm.urlLocation = position;
            const desc = document.getElementById("locationDescription");
            if ((desc.value||"").trim().length > 200){
              desc.setCustomValidity("الوصف أطول من المتوقع");
              document.getElementById("page6-form")?.reportValidity();
              btnPrev.style.display = "inline-block"; btnNext.style.display = "inline-block";
              pageSpinner.style.display = "none"; pageSpinner.children[1].style.display = "none";
              return;
            } else { desc.setCustomValidity(""); }
            nForm.locationDescription = desc.value || "";

            fetch(defaultLink2 + `/reserveAppointment`, {
              method: "POST", redirect: "follow", headers: { "Content-Type":"application/json" },
              body: JSON.stringify(nForm)
            })
            .then(async (res) => {
              pageSpinner.style.display = "none";
              if (!res.ok) throw Object.assign(new Error('submit failed'), { response: await res.json() });
              const data = await res.json();
              if (data.success){
                const p = document.getElementById('page6'), np = document.getElementById('page7');
                p.style.display = "none"; np.style.display = "flex";
                if(confirm(`تود حفظ بياناتك لتسهيل الحجز القادم؟`)){
                  localStorage.setItem("name", document.getElementById("name").value);
                  localStorage.setItem("mobile", iti.getNumber().substring(1));
                } else {
                  localStorage.removeItem("name"); localStorage.removeItem("mobile");
                }
              } else {
                throw Object.assign(new Error('submit not success'), { response: data });
              }
            })
            .catch(async (err)=>{
              btnPrev.style.display = "inline-block"; btnNext.style.display = "inline-block";
              pageSpinner.style.display = "none"; pageSpinner.children[1].style.display = "none";
              document.getElementById('page6').style.display = "none";
              const p4 = document.getElementById('page4'); p4.style.display = "flex";
              const failAlert3 = document.getElementById('fail-alert-3');
              const msg = err?.response?.msgAR || "عذرًا حصل خطأ غير متوقع الرجاء التواصل معنا";
              failAlert3.style.display = "block"; failAlert3.children[0].innerText = msg; if (failAlert3.children[2]) failAlert3.children[2].innerText = "";
              document.getElementById('date').dispatchEvent(new Event('change'));
            });
          };
        };
      } else {
        nextBtn.onclick = () => { page.style.display = "none"; nextPage.style.display = "flex"; };
      }
    }

    // Back buttons
    for (let i = 3; i < 7; i++) {
      const backBtn = document.getElementById(`page${i}-return`);
      const page = document.getElementById(`page${i}`);
      const prev = (i === 4) ? document.getElementById(`page2`) : document.getElementById(`page${i-1}`);
      if (backBtn) backBtn.onclick = () => { page.style.display = "none"; prev.style.display = "flex"; };
    }

    function choosedDate(time, date, i){
      nForm.date = date;
      // accept both '7:00 AM' and '07:00 AM'
      const parsedTime = luxon.DateTime.fromFormat(String(time), "h:mm a");
      nForm.time = parsedTime.isValid ? parsedTime.toFormat("HH:mm") : String(time);
      document.getElementById(`page${i}`).style.display = "none";
      document.getElementById(`page${i+1}`).style.display = "flex";
    }
    window.choosedDate = choosedDate;

    // Plate input restriction + live description
    document.addEventListener('input', (e)=>{
      if (e.target && e.target.id === 'plateNumber'){
        const el = e.target;
        el.value = el.value.replace(/\D/g, '').slice(0,4);
        el.setCustomValidity('');
        updateLocationDescription();
        document.getElementById("plateError").style.display = "none";
      }
    });
    function updateLocationDescription(){
      const carBrand = document.getElementById("carBrand").value || "";
      const carName = document.getElementById("carName").value || "";
      const plateNumber = document.getElementById("plateNumber").value || "";
      const description = [carBrand, carName, plateNumber].filter(Boolean).join(", ");
      const out = document.getElementById("locationDescription");
      if (out) out.value = description;
    }
    window.updateLocationDescription = updateLocationDescription;

    // Car brands + Select2
    const carBrands = ["Acura","Alfa Romeo","Aston Martin","Audi","Bentley","BMW","Bugatti","Buick","Cadillac","Chevrolet","Chrysler","Citroën","Dacia","Daewoo","Daihatsu","Dodge","Ferrari","Fiat","Ford","Genesis","GMC","Haval","Holden","Honda","Hummer","Hyundai","Infiniti","Isuzu","Jaguar","Jeep","Kia","Koenigsegg","Lada","Lamborghini","Lancia","Land Rover","Lexus","Lincoln","Lotus","Maserati","Maybach","Mazda","McLaren","Mercedes-Benz","Mercury","MG","Mini","Mitsubishi","Nissan","Opel","Pagani","Peugeot","Plymouth","Pontiac","Porsche","RAM","Renault","Rolls-Royce","Saab","Saturn","Scion","Seat","Skoda","Smart","SsangYong","Subaru","Suzuki","Tata","Tesla","Toyota","Volkswagen","Volvo","Wiesmann","Zotye","Other"];
    function initCarBrands(){
      const sel = $('#carBrand');
      sel.empty(); carBrands.sort().forEach(b => sel.append(new Option(b,b)));
      sel.select2({ placeholder: "🚘 اختر ماركة السيارة", allowClear:true, dir:'rtl', width: '100%' });
      sel.on('change', updateLocationDescription);
    }

    // Map
    function myMap(){
      map = new google.maps.Map(document.getElementById("googleMap"), { center: defaultLocation, zoom: 12, disableDoubleClickZoom: true });
      infoWindow = new google.maps.InfoWindow();
      marker = new google.maps.Marker({ position: defaultLocation, map, draggable: true, title: "اضغط أو اسحب لتحديد الموقع" });
      marker.addListener("dragend", (e) => validateAndSetPosition(e.latLng));
      map.addEventListener?.("click", (e)=> validateAndSetPosition(e.latLng)); // safe check
      google.maps.event.addListener(map, "click", (e)=> validateAndSetPosition(e.latLng)); // fallback

      const dragHint = document.getElementById("drag-instructions");
      setTimeout(()=> dragHint.style.display="none", 5000);
      google.maps.event.addListener(map, "dragstart", ()=> dragHint.style.display="none");

      if (document.getElementById("area").value) setBoundries();
    }
    window.myMap = myMap;

    function validateAndSetPosition(latLng){
      if (polygon && !google.maps.geometry.poly.containsLocation(latLng, polygon)) {
        alert("⚠️ عذرًا، موقعك خارج نطاق الخدمة");
        position = "";
        infoWindow.setContent("🚫 موقع خارج الخدمة");
        infoWindow.open(map);
        return;
      }
      marker.setPosition(latLng);
      map.panTo(latLng);
      map.setZoom(17);
      position = `${prePosition}${latLng.lat()},${latLng.lng()}`;
      infoWindow.setContent("✅ تم تحديث موقعك هنا");
      infoWindow.open(map, marker);
    }

    function setBoundries(){
      const areaSelect = document.getElementById("area");
      const selectedArea = (areaSelect.options[areaSelect.selectedIndex]?.text || "").trim();
      let APP_Location, polygonCoords;

      if (selectedArea === "العزيزية"){
        APP_Location = { north:26.237892901838705, south:26.15102181049713, west:50.090294685184475, east:50.234894203935546 };
        polygonCoords = [
          { lng:50.215045355428195, lat:26.219724394350184 },
          { lng:50.2135291654911,   lat:26.1870383495685   },
          { lng:50.137875179099595, lat:26.069703060741347 },
          { lng:50.10628808282646,  lat:26.15001891083389  },
          { lng:50.143828288837895, lat:26.21660551929113  },
          { lng:50.19603263782255,  lat:26.21897351180097  },
        ];
      } else if (selectedArea === "أجيال - أرامكو"){
        APP_Location = { north:26.289037271670438, south:26.237817336683204, west:50.05143566513406, east:50.096905737932595 };
        polygonCoords = [
          { lng:50.06256215323989, lat:26.275519772515292 },
          { lng:50.070562455580834, lat:26.277608292466685 },
          { lng:50.08514528516432,  lat:26.257720425641132 },
          { lng:50.06822454797902,  lat:26.24524748257814  },
          { lng:50.06115405632103,  lat:26.262628935642045 },
          { lng:50.05894452767791,  lat:26.267950423932856 },
        ];
      } else if (selectedArea === "الدوحة و الدانة"){
        APP_Location = { north:26.37969652644046, south:26.277002257490476, west:50.11899625151807, east:50.195753733969404 };
        polygonCoords = [
          { lng:50.11488540829821, lat:26.341056543806932 },
          { lng:50.136645122501264, lat:26.353671078060277 },
          { lng:50.14577577434936,  lat:26.363004767230812 },
          { lng:50.178697561294584,  lat:26.3329268498157454 },
          { lng:50.17972636713662,  lat:26.31448441448552 },
          { lng:50.16468008169681,  lat:26.29799900302895 },
        ];
      } else { return; }

      defaultLocation = { lat:(APP_Location.north + APP_Location.south)/2, lng:(APP_Location.east + APP_Location.west)/2 };

      if (!map || !marker) return;

      if (polygon) polygon.setMap(null);
      polygon = new google.maps.Polygon({ paths: polygonCoords, strokeColor:"#ff0000", strokeOpacity:0.4, strokeWeight:2, fillColor:"#00ff00", fillOpacity:0.1 });
      polygon.setMap(map);

      map.setCenter(defaultLocation);
      map.setZoom(14);
      marker.setPosition(defaultLocation);
      position = `${prePosition}${defaultLocation.lat},${defaultLocation.lng}`;
    }
    window.setBoundries = setBoundries;

    function detectMyLocation(){
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const userPos = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
            if (polygon && !google.maps.geometry.poly.containsLocation(userPos, polygon)) {
              alert("⚠️ عذرًا، موقعك خارج نطاق الخدمة");
              return;
            }
            marker.setPosition(userPos);
            map.panTo(userPos);
            map.setZoom(17);
            position = `${prePosition}${pos.coords.latitude},${pos.coords.longitude}`;
            infoWindow.close();
          },
          () => handleLocationError(true)
        );
      } else { handleLocationError(false); }
    }
    function handleLocationError(browserHasGeolocation) {
      infoWindow.setPosition(map.getCenter());
      infoWindow.setContent(browserHasGeolocation ? "⚠️ تعذر الحصول على موقعك. يرجى السماح بالوصول للموقع." : "⚠️ جهازك لا يدعم تحديد الموقع.");
      infoWindow.open(map);
    }

    // Save/restore user data
    function restoreUser(){
      try {
        const savedName = localStorage.getItem("name");
        const savedMobile = localStorage.getItem("mobile");
        if (savedName) document.getElementById("name").value = savedName;
        if (savedMobile && iti) iti.setNumber("+"+savedMobile);
      } catch(e){}
    }

    document.getElementById("rebook")?.addEventListener("click", ()=> { window.location.href = "https://www.spongnsoap.com/"; });

    // DOM Ready init
    document.addEventListener('DOMContentLoaded', ()=>{
      initPhoneInput();
      restoreUser();
      initCarBrands();
      loadLocations();
      setMinToday();
      // preload header dates
      (function presetDates(){ const ev = new Event('change'); document.getElementById('date').dispatchEvent(ev); })();

      document.getElementById('show-my-location').addEventListener('click', detectMyLocation);
      document.getElementById('page4-return').addEventListener('click', ()=>{ document.getElementById('page4').style.display='none'; document.getElementById('page2').style.display='flex'; });
    });
  </script>

  <!-- Google Maps -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBBHLoO038vsCovHN-SLUgAXqexlA2v0_4&callback=myMap&libraries=geometry" async defer></script>
</body>
</html>
