<script>
/* ---------------- TIMES (Selected date only | AVAILABLE ONLY) ---------------- */

// حالة محلية
let dayTimes = [];       // [{label, actual12, hhmm}]
let timesLoaded = false;

// فلاتر التحقق من "متاح"
function isAvailable(row){
  const raw =
    row?.TS_appintment_status ??
    row?.TS_appointment_status ??
    row?.TS_status ??
    row?.status ??
    row?.TS_available ??
    row?.available ??
    row?.TS_appointment_available;

  if (typeof raw === 'boolean') return raw;
  if (typeof raw === 'number')  return raw === 1;

  const s = String(raw || '').trim().toLowerCase();
  if (!s) return false;

  // نعتبر هذه الكلمات/القيم كـ "متاح"
  return (
    s.includes('avail') ||         // available
    s.includes('open')  ||         // open
    s.includes('free')  ||         // free
    s.includes('empty') ||         // empty
    s.includes('متاح')  ||         // Arabic
    s.includes('متاحة')
  );
}

// ربط الأحداث
document.getElementById('date').addEventListener('change', fetchTimesForSelectedDate);
document.getElementById('service').addEventListener('change', () => {
  if (typeof getActiveIndex === 'function' && getActiveIndex() === 2) fetchTimesForSelectedDate();
});
document.getElementById('area').addEventListener('change', () => {
  if (typeof getActiveIndex === 'function' && getActiveIndex() === 2) fetchTimesForSelectedDate();
});

// تأمين تاريخ اليوم كحد أدنى
(function initDateMin(){
  const DateTime = luxon.DateTime;
  const today = DateTime.now().toFormat('yyyy-LL-dd');
  const dateEl = document.getElementById('date');
  if (!dateEl.value) dateEl.value = today;
  dateEl.setAttribute('min', today);
})();

// جلب أوقات يوم واحد (ومتاحة فقط)
function fetchTimesForSelectedDate(){
  const DateTime = luxon.DateTime;
  const dateEl = document.getElementById('date');
  const timeContainer = document.getElementById('time-container');
  const loc = document.getElementById('area').value || '';
  const srv = document.getElementById('service').value || '';
  const selectedISO = (dateEl.value || DateTime.now().toFormat('yyyy-LL-dd')).trim();

  if (!loc || !srv) {
    timeContainer.innerHTML = `<div style="grid-column:1/-1;justify-self:center" class="text-muted">اختر المنطقة والخدمة لعرض المواعيد</div>`;
    window.selectedTime = null; selectedTime = null;
    updateNextAvailability?.();
    return;
  }

  // UI: لودينغ
  dateEl.disabled = true;
  setLoadingTimes?.(true);
  timeContainer.innerHTML = `
    <div class="spinner-border text-info" role="status" style="grid-column:1/-1;justify-self:center;">
      <span class="visually-hidden">Loading...</span>
    </div>`;

  const qs = `/appointments?startDate=${encodeURIComponent(selectedISO)}`
           + `&location=${encodeURIComponent(loc)}`
           + `&service=${encodeURIComponent(srv)}`;

  // Log معطيات الاستعلام
  console.log('[Times] Request →', { startDate: selectedISO, location: loc, service: srv });

  callContent2(qs, (res) => {
    const rows = (res?.data?.appointments || []);
    console.log('[Times] Raw rows:', rows);

    const list = [];

    rows.forEach((r) => {
      // نحتفظ فقط بالمواعيد لنفس التاريخ + المتاحة فقط
      const d = luxon.DateTime.fromISO(r.TS_appointment_date, { setZone: true });
      if (!d.isValid || d.toISODate() !== selectedISO) return;
      if (!isAvailable(r)) return;

      // Parse الوقت بصيغ متعددة
      const raw = String(r.TS_appointment_time || '').trim();
      let t = luxon.DateTime.fromISO(raw, { setZone: true });
      if (!t.isValid) t = luxon.DateTime.fromFormat(raw, 'HH:mm:ss', { setZone: true });
      if (!t.isValid) t = luxon.DateTime.fromFormat(raw, 'H:mm a',   { setZone: true });
      if (!t.isValid) t = luxon.DateTime.fromFormat(raw, 'H:mm',     { setZone: true });
      if (!t.isValid) return;

      list.push({
        label: t.toLocaleString(luxon.DateTime.TIME_SIMPLE), // 3:30 PM
        actual12: t.toFormat('hh:mm a'),                     // 03:30 PM
        hhmm: t.toFormat('HH:mm')                            // 15:30 (للفرز)
      });
    });

    // De-dup + Sort
    const seen = new Set();
    dayTimes = list
      .filter(x => { if (seen.has(x.hhmm)) return false; seen.add(x.hhmm); return true; })
      .sort((a,b)=> a.hhmm.localeCompare(b.hhmm));

    // Logs مفيدة
    console.log('[Times] Available (same date) count:', dayTimes.length);
    console.table(dayTimes.map(x => ({ label: x.label, hhmm: x.hhmm })));
    console.log('[Times] Final labels:', dayTimes.map(x => x.label));

    timesLoaded = true;
    renderSelectedDateTimes(selectedISO);
    dateEl.disabled = false;
    setLoadingTimes?.(false);
  }, true);
}

// رسم الأزرار
function renderSelectedDateTimes(selectedISO){
  const timeContainer = document.getElementById('time-container');
  timeContainer.innerHTML = '';

  if (!timesLoaded) {
    timeContainer.innerHTML = `
      <div class="spinner-border text-info" role="status" style="grid-column:1/-1;justify-self:center;">
        <span class="visually-hidden">Loading...</span>
      </div>`;
    return;
  }

  if (!dayTimes.length) {
    timeContainer.innerHTML = `
      <div style="grid-column:1/-1;justify-self:center" class="text-muted">
        لا توجد مواعيد متاحة
      </div>`;
    window.selectedTime = null;
    selectedTime = null;
    updateNextAvailability?.();
    return;
  }

  dayTimes.forEach((t) => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'time-option';
    btn.setAttribute('role','radio');
    btn.setAttribute('aria-checked','false');
    btn.setAttribute('dir','ltr');
    btn.textContent = t.label;

    btn.addEventListener('click', () => {
      [...timeContainer.children].forEach(el => el.setAttribute('aria-checked','false'));
      btn.setAttribute('aria-checked','true');

      const parsed = luxon.DateTime.fromFormat(t.actual12, 'h:mm a');
      nForm.date = selectedISO;
      nForm.time = parsed.isValid ? parsed.toFormat('HH:mm') : t.hhmm;

      // مهم لتفعيل "التالي"
      window.selectedTime = { ui: t.label, iso: nForm.time };
      selectedTime        = window.selectedTime;

      // Log الاختيار
      console.log('[Times] Selected →', { date: nForm.date, timeLabel: t.label, time24: nForm.time });

      updateNextAvailability?.();
    });

    timeContainer.appendChild(btn);
  });
}

// دالة توافقية إذا كان في كود يعتمد عليها
function choosedDate(time12, dateISO /*, i */) {
  const parsed = luxon.DateTime.fromFormat(time12, "h:mm a");
  nForm.date = dateISO;
  nForm.time = parsed.isValid ? parsed.toFormat("HH:mm") : time12;
  window.selectedTime = { ui: time12, iso: nForm.time };
  selectedTime        = window.selectedTime;
  console.log('[Times] choosedDate()', { date: nForm.date, timeLabel: time12, time24: nForm.time });
  updateNextAvailability?.();
}
</script>
