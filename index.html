<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Maison Hikari â€¢ Ø§Ù„Ø·Ù„Ø¨</title>

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Didact+Gothic&family=Cairo:wght@400;700;900&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

  <!-- Bootstrap & Intl Tel Input -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/css/intlTelInput.css" rel="stylesheet"/>

  <meta name="theme-color" content="#141414" />
  <meta name="description" content="Maison Hikari â€” Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†" />

  <style>
    :root{
      --charcoal:#141414; --porcelain:#adadad; --gold:#D4AF37;
      --ink-on-dark:#EDEBE6; --ink-on-light:#1A1A1A;
      --border-on-dark: rgba(237,235,230,.15); --border-on-light: rgba(20,20,20,.12);
      --radius:14px; --radius-pill:999px; --shadow:0 10px 30px rgba(0,0,0,.25);
      --topbar-h:56px; --chips-h:0px;
      --focus: var(--gold);
    }
    html,body{height:100%}
    html{scroll-behavior:smooth;}
    body{
      font-family:'Cairo','Didact Gothic','Perandory',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--ink-on-dark); background:var(--charcoal);
      display:flex; flex-direction:column; -webkit-tap-highlight-color:transparent;
    }
    :where(a,button,[role="button"],input,select,textarea):focus-visible{
      outline:2px solid var(--focus); outline-offset:2px; box-shadow:0 0 0 4px rgba(212,175,55,.25);
    }

    /* Header */
    .app-header{position:sticky;top:0;z-index:70;background:color-mix(in srgb, var(--charcoal) 88%, black);border-bottom:1px solid var(--border-on-dark);backdrop-filter:saturate(1.05) blur(6px)}
    .brand{font-family:'Perandory','Didact Gothic','Cairo',sans-serif;font-weight:900;letter-spacing:.3px;color:var(--ink-on-dark)}
    .cart-btn{position:relative;min-width:44px;min-height:44px;border-radius:var(--radius-pill);border:1px solid var(--border-on-dark);background:transparent;color:var(--ink-on-dark)}
    .cart-badge{position:absolute;top:-6px;inset-inline-start:-6px;background:var(--gold);color:#141414;border-radius:999px;font-size:.75rem;padding:2px 7px;font-weight:900;box-shadow:0 6px 16px rgba(0,0,0,.4)}
    @media (prefers-reduced-motion:no-preference){ .cart-badge.bump{ animation:bump .4s } @keyframes bump{0%{transform:scale(1)}30%{transform:scale(1.18)}100%{transform:scale(1)}} }

    /* Chips strip in flow (we'll affix a clone on scroll) */
    .chips-wrap{background:color-mix(in srgb, var(--charcoal) 86%, black);border-bottom:1px solid var(--border-on-dark)}
    #chips{display:flex;flex-wrap:wrap;gap:8px;padding-block:10px;align-items:center}
    .chip{background:var(--porcelain);color:var(--ink-on-light);border:1px solid var(--border-on-light);border-radius:var(--radius-pill);padding:10px 14px;min-height:44px;font-weight:800;font-size:.95rem;transition:.18s}
    .chip:hover{filter:saturate(1.02) brightness(1.02)}
    .chip.active{background:var(--gold);color:#141414;border-color:color-mix(in srgb, var(--gold) 70%, #000)}
    .pill-clear{background:transparent;border:1px dashed var(--border-on-dark);color:var(--ink-on-dark)}
    .search-wrap{margin-inline-start:auto}
    .searchbox{display:flex;align-items:center;gap:6px;border:1px solid var(--border-on-dark);border-radius:var(--radius-pill);background:color-mix(in srgb, var(--charcoal) 70%, #000);padding-inline:8px;transition:.18s;color:var(--ink-on-dark)}
    .searchbox .btn{min-width:36px;color:var(--ink-on-dark)}
    .searchbox input{border:0;min-height:46px;color:var(--ink-on-dark);background:transparent;width:0;min-width:0;padding:0;opacity:0;pointer-events:none;transition:.18s}
    .searchbox.open{box-shadow:0 8px 28px rgba(0,0,0,.45)}
    .searchbox.open input{width:66vw;opacity:1;pointer-events:auto;padding:12px 16px}
    @media (min-width:768px){.searchbox.open input{width:320px}}

    /* Affixed clone */
    #chipsAffix{position:fixed;inset-inline:0;top:var(--topbar-h);z-index:90;background:color-mix(in srgb, var(--charcoal) 86%, black);border-bottom:1px solid var(--border-on-dark);display:none}
    #chipsAffix.visible{display:block;box-shadow:0 8px 24px rgba(0,0,0,.35);animation:fadeSlide .18s ease}
    @keyframes fadeSlide{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:none}}

    /* Sections */
    .menu-section{scroll-margin-top:calc(var(--topbar-h) + var(--chips-h) + 12px);padding-top:8px}
    .sec-title{margin:12px 0;font-weight:900;color:var(--ink-on-dark);position:relative;display:inline-block;padding-inline:8px;padding-block:2px;background:linear-gradient(90deg, color-mix(in srgb, var(--gold) 35%, transparent), transparent 60%);border-radius:6px}

    .menu-grid{display:grid;gap:14px;grid-template-columns:repeat(1,minmax(0,1fr))}
    @media(min-width:640px){.menu-grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media(min-width:992px){.menu-grid{grid-template-columns:repeat(3,minmax(0,1fr))}}

    .dish{background:var(--porcelain);color:var(--ink-on-light);border:1px solid var(--border-on-light);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);display:flex;flex-direction:column}
    .dish-img{width:100%;aspect-ratio:16/9;object-fit:cover;background:#e9e6df}
    .dish-body{padding:12px 12px 14px}
    .dish h6{font-family:'Perandory','Didact Gothic','Cairo',sans-serif;font-weight:900;margin:0 0 4px;color:var(--ink-on-light)}
    .desc{color:rgba(26,26,26,.72)}
    .price{font-weight:900;color:var(--gold)}
    .tags{display:flex;flex-wrap:wrap;gap:6px}
    .tag{background:#EFECE6;color:#2b2b2b;border:1px solid var(--border-on-light);border-radius:999px;padding:4px 8px;font-size:.8rem}
    .add-wrap{margin-top:8px}
    .add-btn{width:100%;min-height:46px;border-radius:999px;border:1px solid var(--gold);background:var(--gold);color:#141414;font-weight:900}
    .add-btn:hover{background:color-mix(in srgb, var(--gold) 85%, #000 15%);border-color:color-mix(in srgb, var(--gold) 85%, #000 15%)}

    .cart-card,.card-paper{background:var(--porcelain);color:var(--ink-on-light);border:1px solid var(--border-on-light);border-radius:var(--radius);box-shadow:var(--shadow)}
    .line{display:flex;align-items:center;gap:10px;justify-content:space-between;padding:10px 0;border-bottom:1px dashed var(--border-on-light)}
    .seg{display:inline-grid;grid-auto-flow:column;gap:8px;background:#EFECE6;padding:6px;border-radius:999px;border:1px solid var(--border-on-light)}
    .seg button{background:#fff;border:1px solid var(--border-on-light);border-radius:999px;padding:11px 16px;min-height:46px;font-weight:900;color:#1a1a1a}
    .seg button[aria-pressed="true"]{background:var(--gold);color:#141414;border-color:var(--gold)}
    #etaBadge{background:color-mix(in srgb, var(--gold) 18%, #fff);color:#141414;padding:4px 10px;border-radius:999px;font-weight:800;border:1px solid var(--gold)}
    .inp-wrap{position:relative}.inp-wrap .ico{position:absolute;inset-inline-start:12px;inset-block-start:50%;transform:translateY(-50%);color:#6b6760;pointer-events:none}
    .pad-icon{padding-inline-start:42px}
    .form-control,.form-select{min-height:56px;border-color:var(--border-on-light);color:#1a1a1a}
    .iti{direction:ltr}.iti input{text-align:left}

    .mini-bar{position:sticky;bottom:0;z-index:55;background:var(--charcoal);color:var(--ink-on-dark);padding:10px 12px;border-top:1px solid var(--border-on-dark);padding-bottom:calc(14px + env(safe-area-inset-bottom))}
    .mini-btn{min-height:52px;border-radius:999px;font-weight:900}

    #toasts{position:fixed;inset-block-start:14px;left:50%;transform:translateX(-50%);z-index:200;display:flex;flex-direction:column;gap:8px}
    .toast-msg{background:#171717;color:var(--ink-on-dark);padding:10px 14px;border-radius:12px;box-shadow:0 14px 40px rgba(0,0,0,.5);font-weight:800;border:1px solid var(--border-on-dark)}

    #appLoading,#submitLoading{position:fixed;inset:0;z-index:999;display:none;align-items:center;justify-content:center;text-align:center;background:rgba(20,20,20,.9);backdrop-filter:blur(6px);color:var(--ink-on-dark)}
    .overlay.show{display:flex}
    .overlay .box{background:var(--porcelain);color:var(--ink-on-light);border:1px solid var(--border-on-light);border-radius:16px;padding:18px 20px;box-shadow:var(--shadow);min-width:220px}
    .overlay .msg{margin-top:.5rem;color:#2b2b2b;font-weight:800}

    .btn-dark,#optAddBtn,#confirmBtn,#thBackMenu{background:var(--gold)!important;border-color:var(--gold)!important;color:#141414!important}
    .btn-dark:hover,#optAddBtn:hover,#confirmBtn:hover,#thBackMenu:hover{background:color-mix(in srgb, var(--gold) 85%, #000 15%)!important;border-color:color-mix(in srgb, var(--gold) 85%, #000 15%)!important;color:#141414!important}
    .btn-outline-dark,#thBackCart{color:var(--ink-on-light)!important;border-color:var(--border-on-light)!important;background:transparent!important}
    .btn-outline-dark:hover,#thBackCart:hover{background:#EFECE6!important;border-color:var(--gold)!important;color:#141414!important}
  </style>

  <!-- Reels (optional) -->
  <style>
    #reels{position:fixed;inset:0;z-index:1100;display:none;background:#000;color:#fff}
    #reels.show{display:block}
    #reelsHeader{position:absolute;inset-inline:0;inset-block-start:0;display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:linear-gradient(180deg,rgba(0,0,0,.6),rgba(0,0,0,0));pointer-events:none;z-index:2}
    #reelsHeader .btn,#reelsHeader .chip{pointer-events:auto}
    .reels-list{height:100vh;overflow-y:auto;overscroll-behavior:contain;scroll-snap-type:y mandatory;-webkit-overflow-scrolling:touch;outline:none;touch-action:pan-y}
    .reel{position:relative;height:100vh;display:grid;grid-template-rows:1fr auto;isolation:isolate;scroll-snap-align:start;scroll-snap-stop:always}
    .reel .media{position:relative;background:#000;min-height:0;display:grid;place-items:center}
    .reel img{width:100%;height:100%;object-fit:cover;background:#111}
    .reel .glass{position:absolute;inset-inline:0;inset-block-end:0;padding:14px 12px 18px;background:linear-gradient(0deg,rgba(0,0,0,.65),rgba(0,0,0,0));color:#fff;z-index:1}
    .reel .title{font-family:'Perandory','Didact Gothic','Cairo',sans-serif;font-weight:900;margin:0 0 6px}
    .reel .desc{opacity:.9;font-size:.95rem}
    .reel .tagbox{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
    .reel .tag{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18);color:#fff;border-radius:999px;padding:4px 8px;font-size:.8rem}
    .reel .cta{position:absolute;inset-inline:12px;inset-block-end:12px;z-index:2;display:flex;gap:8px}
    .reel .cta .btn{border-radius:999px;font-weight:900;min-height:46px}
    #reelsLoading{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:3;background:linear-gradient(180deg,rgba(0,0,0,.5),rgba(0,0,0,.35))}
    #reelsLoading[hidden]{display:none}
  </style>
</head>
<body>
  <!-- Overlays -->
  <div id="appLoading" class="overlay" aria-live="polite" aria-busy="true">
    <div class="box">
      <div class="spinner-border text-gold" role="status" aria-label="Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„"></div>
      <div class="msg">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©â€¦</div>
    </div>
  </div>
  <div id="submitLoading" class="overlay" aria-live="polite" aria-busy="true">
    <div class="box">
      <div class="spinner-border text-gold" role="status" aria-label="Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©"></div>
      <div class="msg">Ø¬Ø§Ø±Ù ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨â€¦</div>
    </div>
  </div>
  <div id="toasts" aria-live="polite" aria-atomic="true"></div>

  <!-- Header -->
  <header class="app-header" id="topbar">
    <div class="container py-2 d-flex align-items-center justify-content-between gap-2">
      <div class="d-flex align-items-center gap-3">
        <img src="https://images.unsplash.com/photo-1544025162-d76694265947?q=80&w=120&auto=format&fit=crop" alt="" width="44" height="44" style="border-radius:12px;object-fit:cover" loading="lazy" fetchpriority="high" decoding="async">
        <div>
          <div class="brand">Maison Hikari</div>
          <small class="text-secondary" style="color:#c9c6bf !important">Ø§Ù„ÙŠØ§Ø¨Ø§Ù†ÙŠ Ø§Ù„Ù…Ø¹Ø§ØµØ±</small>
        </div>
      </div>
      <button id="openCart" class="cart-btn px-3" aria-label="Ø§Ù„Ø³Ù„Ø©">
        <i class="fa-solid fa-bag-shopping"></i>
        <span id="badge" class="cart-badge" aria-live="polite">0</span>
      </button>
    </div>
  </header>

  <!-- Chips + Search (in flow) -->
  <div class="chips-wrap" id="chipsWrap" hidden aria-hidden="true">
    <div class="container">
      <div id="chips" aria-label="ØªØµÙ†ÙŠÙØ§Øª">
        <button class="chip active" data-target="#topOfMenu">Ø§Ù„ÙƒÙ„</button>
        <button class="chip" data-target="#sec-sushi">Ø³ÙˆØ´ÙŠ</button>
        <button class="chip" data-target="#sec-don">Ø¯ÙˆÙ†</button>
        <button class="chip" data-target="#sec-meat">Ù„Ø­ÙˆÙ…</button>
        <button class="chip" data-target="#sec-drinks">Ù…Ø´Ø±ÙˆØ¨Ø§Øª</button>
        <div class="search-wrap">
          <div class="searchbox d-flex" role="search" aria-label="Ø¨Ø­Ø«">
            <button class="btn js-search-toggle" aria-label="Ø¨Ø­Ø«"><i class="fa-solid fa-magnifying-glass"></i></button>
            <input id="q" data-role="menu-search" type="search" class="form-control" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø·Ø¨Ù‚ â€¦ (Ø³Ø§Ù„Ù…ÙˆÙ†ØŒ ÙˆØ§Ø¬ÙŠÙˆâ€¦)" autocomplete="off" aria-label="Ø¨Ø­Ø«"/>
          </div>
        </div>
        <button id="openReels" class="chip js-open-reels" type="button" aria-haspopup="dialog">Ø¹Ø±Ø¶ Ø±ÙŠÙŠÙ„</button>
        <button class="chip pill-clear js-clear-filters d-none" type="button">Ù…Ø³Ø­ Ø§Ù„ØªØµÙÙŠØ©</button>
      </div>
    </div>
  </div>

  <!-- Affixed clone + sentinel -->
  <div id="chipsAffix" aria-hidden="true"></div>
  <div id="chipsSentinel"></div>

  <!-- Content -->
  <main id="topOfMenu">
    <div class="tab-content flex-1">
      <!-- MENU -->
      <section id="tab-menu" class="tab-pane fade show active">
        <div class="container py-3" id="menuContainer">
          <div id="menuSections"></div>
          <p id="emptyMsg" class="text-secondary text-center my-5 d-none" style="color:#c9c6bf !important">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø·Ø¨Ø§Ù‚ Ù…Ø·Ø§Ø¨Ù‚Ø© â€” Ø¬Ø±Ù‘Ø¨ ÙƒÙ„Ù…Ø© Ø¨Ø­Ø« Ù…Ø®ØªÙ„ÙØ©</p>
          <div style="height:18vh"></div>
        </div>

        <!-- Mini checkout bar -->
        <div class="mini-bar">
          <div class="container d-flex align-items-center gap-2">
            <div class="flex-grow-1">
              <div class="d-flex align-items-baseline gap-2">
                <strong id="miniCount" aria-live="polite" aria-atomic="true">0 Ø¹Ù†ØµØ±</strong>
                <span class="text-white-50">â€¢</span>
                <strong id="miniTotal" aria-live="polite" aria-atomic="true">0.00 Ø±.Ø³</strong>
              </div>
              <small class="text-white-50" id="miniHint">Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© ÙˆØ±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„ ØªÙØ¶Ø§Ù Ù„Ø§Ø­Ù‚Ø§Ù‹</small>
            </div>
            <a id="goCartBtn" href="#tab-cart" class="btn btn-light mini-btn text-dark disabled" aria-disabled="true">Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø³Ù„Ø©</a>
          </div>
        </div>
      </section>

      <!-- CART -->
      <section id="tab-cart" class="tab-pane fade">
        <div class="container py-3">
          <div class="cart-card p-3 p-md-4">
            <h5 class="mb-3"><i class="fa-solid fa-bag-shopping"></i> Ø§Ù„Ø³Ù„Ø©</h5>
            <div id="cartList" class="mb-3"></div>
            <div class="d-flex justify-content-between border-top pt-3" style="border-color:var(--border-on-light)!important">
              <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span> <strong id="cartTotal">0.00 Ø±.Ø³</strong>
            </div>
            <div class="d-flex gap-2 mt-3">
              <a href="#tab-menu" class="btn btn-outline-dark flex-fill py-3 fw-bold" data-go="menu">Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</a>
              <a id="toDataBtn" href="#tab-data" class="btn btn-dark flex-fill py-3 fw-bold disabled" aria-disabled="true" data-go="data">Ù…ØªØ§Ø¨Ø¹Ø©</a>
            </div>
          </div>
        </div>
      </section>

      <!-- CUSTOMER DATA -->
      <section id="tab-data" class="tab-pane fade">
        <div class="container py-4">
          <div class="d-flex align-items-center gap-2 mb-3">
            <div class="seg" aria-label="Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨">
              <button id="segPickup" class="btn" aria-pressed="true" type="button">Ø§Ø³ØªÙ„Ø§Ù…</button>
              <button id="segDelivery" class="btn" aria-pressed="false" type="button">ØªÙˆØµÙŠÙ„</button>
            </div>
            <span id="etaBadge">ETA ~ 15</span>
          </div>

          <div class="card-paper p-3 p-md-4">
            <div class="row g-3">
              <div class="col-12 col-md-6">
                <label class="form-label fw-bold" for="custName">Ø§Ù„Ø§Ø³Ù…</label>
                <div class="inp-wrap">
                  <i class="fa-regular fa-user ico"></i>
                  <input id="custName" class="form-control pad-icon" placeholder="Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„" autocomplete="name" required/>
                </div>
                <div id="err-name" class="text-danger small d-none mt-2">ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù…</div>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label fw-bold" for="custPhone">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
                <input id="custPhone" class="form-control" type="tel" placeholder="5XXXXXXXX" inputmode="tel" autocomplete="tel" required/>
                <div id="ok-phone" class="text-success small d-none mt-2">Ø±Ù‚Ù… ØµØ­ÙŠØ­ âœ…</div>
                <div id="err-phone" class="text-danger small d-none mt-2">Ø±Ù‚Ù… ØºÙŠØ± ØµØ§Ù„Ø­</div>
              </div>
              <div class="col-12" id="addressWrap" style="display:none">
                <label class="form-label fw-bold" for="address">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                <div class="inp-wrap">
                  <i class="fa-solid fa-location-dot ico"></i>
                  <input id="address" class="form-control pad-icon" placeholder="Ø§Ù„Ø­ÙŠØŒ Ø§Ù„Ø´Ø§Ø±Ø¹ØŒ Ø¹Ù„Ø§Ù…Ø© Ù…Ù…ÙŠØ²Ø©" autocomplete="street-address"/>
                </div>
                <div id="err-address" class="text-danger small d-none mt-2">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù„Ù„ØªÙˆØµÙŠÙ„</div>
                <div class="mt-2 small" style="color:#4a4741"><i class="fa-regular fa-clock"></i> Ø§Ù„ØªÙˆØµÙŠÙ„ Ø¹Ø§Ø¯Ø© 30â€“45 Ø¯Ù‚ÙŠÙ‚Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹.</div>
              </div>
              <div class="col-12">
                <label class="form-label fw-bold" for="notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <textarea id="notes" class="form-control" maxlength="140" placeholder="Ù„Ø§ Ø«Ù„Ø¬ØŒ Ø­Ø§Ø±ØŒ Ø¨Ø¯ÙˆÙ† Ø¨ØµÙ„ â€¦"></textarea>
                <div class="d-flex small mt-2" style="color:#4a4741">
                  <span>Ù†Ø­Ø§ÙˆÙ„ ØªÙ†ÙÙŠØ° ØªÙØ¶ÙŠÙ„Ø§ØªÙƒ Ø¨Ù‚Ø¯Ø± Ø§Ù„Ø¥Ù…ÙƒØ§Ù†</span>
                  <span class="ms-auto">(<span id="notesCount">0</span>/140)</span>
                </div>
              </div>
            </div>
          </div>

          <div class="d-flex gap-2 mt-3">
            <a href="#tab-cart" class="btn btn-outline-dark flex-fill py-3 fw-bold" data-go="cart">Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø³Ù„Ø©</a>
            <button id="confirmBtn" class="btn btn-dark flex-fill py-3 fw-bold" aria-label="ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</button>
          </div>

          <div class="mt-3 small d-flex gap-2 align-items-center" style="color:#4a4741">
            <i class="fa-brands fa-whatsapp"></i>
            <a class="link-light" target="_blank" rel="noopener" href="https://wa.me/966509027172" style="color:#EDEBE6">Ù…Ø­ØªØ§Ø¬ Ù…Ø³Ø§Ø¹Ø¯Ø©ØŸ ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</a>
          </div>
        </div>
        <div style="height:18vh"></div>
      </section>

      <!-- THANKS -->
      <section id="tab-thanks" class="tab-pane fade">
        <div class="container py-5">
          <div class="card-paper p-4 text-center">
            <div class="display-6 mb-2" style="color:#141414">ğŸ‰ Ø´ÙƒØ±Ø§Ù‹ Ù„Ø·Ù„Ø¨Ùƒ</div>
            <p class="mb-4" style="color:#4a4741">ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­</p>
            <div class="d-flex flex-column align-items-center gap-3">
              <div class="ticket" id="thTicket">----</div>
              <div class="d-inline-flex flex-wrap gap-2 justify-content:center">
                <span class="badge bg-light text-dark border"><i class="fa-regular fa-calendar"></i> <span id="thDate">â€”</span></span>
                <span class="badge bg-light text-dark border"><strong>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</strong>&nbsp;<span id="thOrderId">â€”</span></span>
                <span class="badge bg-light text-dark border"><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong>&nbsp;<span id="thTotal">â€”</span></span>
                <span class="badge bg-light text-dark border" id="thType">â€”</span>
              </div>
              <div class="d-flex gap-2 mt-1">
                <button type="button" id="copyTicket" class="btn btn-outline-dark btn-sm"><i class="fa-regular fa-copy"></i> Ù†Ø³Ø® Ø§Ù„ØªØ°ÙƒØ±Ø©</button>
                <button type="button" id="copySummary" class="btn btn-outline-dark btn-sm"><i class="fa-regular fa-clipboard"></i> Ù†Ø³Ø® Ø§Ù„Ù…Ù„Ø®Øµ</button>
              </div>
            </div>
            <div class="d-flex gap-2 justify-content-center mt-3">
              <a href="#tab-menu" id="thBackMenu" class="btn btn-dark" data-go="menu">Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</a>
              <a href="#tab-cart" id="thBackCart" class="btn btn-outline-dark" data-go="cart">Ø¹Ø±Ø¶ Ø§Ù„Ø³Ù„Ø©</a>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- Options Modal -->
  <div class="modal fade" id="optModal" tabindex="-1" aria-labelledby="optTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title fw-bold" id="optTitle">Ø®ÙŠØ§Ø±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Ø¥ØºÙ„Ø§Ù‚"></button>
        </div>
        <div class="modal-body">
          <div id="optSummary" class="mb-2 small" style="color:#4a4741"></div>
          <div id="optForm" class="vstack gap-3"></div>
          <div class="d-flex align-items-center justify-content-between mt-3">
            <div class="input-group" style="width:150px">
              <button class="btn btn-outline-dark" id="optMinus" type="button" aria-label="Ø¥Ù†Ù‚Ø§Øµ">âˆ’</button>
              <input id="optQty" class="form-control text-center" type="number" min="1" step="1" value="1">
              <button class="btn btn-dark" id="optPlus" type="button" aria-label="Ø²ÙŠØ§Ø¯Ø©">+</button>
            </div>
            <div class="fw-bold"><span>Ø§Ù„Ø³Ø¹Ø±:</span> <span id="optPrice" style="color:var(--gold)">0.00 Ø±.Ø³</span></div>
          </div>
          <div class="mt-3">
            <label class="form-label fw-bold" for="optNotes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„Ù„Ø·Ø¨Ù‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input id="optNotes" class="form-control" maxlength="100" placeholder="Ø¨Ø¯ÙˆÙ† Ø¨ØµÙ„ØŒ ØµÙˆØµ Ø£Ù‚Ù„ â€¦">
          </div>
        </div>
        <div class="modal-footer">
          <button id="optAddBtn" class="btn btn-dark w-100 fw-bold" type="button">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Reels overlay -->
  <div id="reels" role="dialog" aria-modal="true" aria-label="Ø§Ø³ØªØ¹Ø±Ø§Ø¶ Ø§Ù„Ø£Ø·Ø¨Ø§Ù‚ Ø¨Ø´ÙƒÙ„ Ø±ÙŠÙŠÙ„" aria-hidden="true">
    <div id="reelsHeader" dir="rtl">
      <button id="closeReels" class="chip" type="button" aria-label="Ø¥ØºÙ„Ø§Ù‚">Ø¥ØºÙ„Ø§Ù‚</button>
      <span class="small text-white-50 me-auto ms-2">Ø§Ø³Ø­Ø¨ Ù„Ù„Ø£Ø¹Ù„Ù‰/Ø§Ù„Ø£Ø³ÙÙ„</span>
      <button id="reelsToCart" class="chip" type="button" aria-label="ÙØªØ­ Ø§Ù„Ø³Ù„Ø©">Ø§Ù„Ø³Ù„Ø©</button>
    </div>
    <div id="reelsLoading">
      <div class="spinner-border text-gold" role="status" aria-label="Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„"></div>
    </div>
    <div class="reels-list" id="reelsList" tabindex="0" aria-live="polite"></div>
  </div>

  <!-- Templates -->
  <template id="dishTpl">
    <div class="dish reveal" data-cat="">
      <img class="dish-img" alt="" width="1200" height="675" loading="lazy" decoding="async" fetchpriority="low"/>
      <div class="dish-body">
        <div class="d-flex align-items-center justify-content-between mb-1">
          <strong class="price"></strong>
          <div class="tags"></div>
        </div>
        <h6 class="title"></h6>
        <div class="small mb-1 desc"></div>
        <div class="add-wrap">
          <button class="add-btn" type="button" aria-label="Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©">Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©</button>
        </div>
      </div>
    </div>
  </template>

  <template id="cartLineTpl">
    <div class="line">
      <div class="d-flex align-items-center gap-2">
        <button class="btn btn-sm btn-outline-dark rounded-pill minus" aria-label="Ø¥Ù†Ù‚Ø§Øµ">âˆ’</button>
        <strong class="qty" aria-live="polite">1</strong>
        <button class="btn btn-sm btn-dark rounded-pill plus" aria-label="Ø²ÙŠØ§Ø¯Ø©">+</button>
      </div>
      <div class="flex-grow-1 text-truncate text-end">
        <div class="fw-bold name"></div>
        <div class="small">Ã— <span class="unit">0.00</span> Ø±.Ø³</div>
      </div>
      <div class="text-nowrap fw-bold total">0.00 Ø±.Ø³</div>
    </div>
  </template>

  <!-- JS libs -->
  <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/intlTelInputWithUtils.js"></script>

  <!-- App -->
  <script>
  const GAS_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxyGwCUJRwjVfJDtq5bxqN9Thm_KU4zOfNiNt0ENtW2jbDonr_yp3W2xDZCNXkmSHZNLw/exec';
  const FREE_SHIP = 79;

  window.addEventListener('DOMContentLoaded', () => {
    const state = { q:'', cart:{}, menu:[], unlockThanks:false, active:'menu' };
    const fmt = new Intl.NumberFormat('ar-SA', { style:'currency', currency:'SAR' });

    /* ===== Helpers ===== */
    const topbarEl=document.getElementById('topbar'), chipsWrap=document.getElementById('chipsWrap'), chipsAffix=document.getElementById('chipsAffix');
    function measure(el){return Math.round(el?.getBoundingClientRect().height||0)}
    function setStickyVars(){
      const h = chipsAffix.classList.contains('visible') ? measure(chipsAffix) : (!chipsWrap.hidden?measure(chipsWrap):0);
      document.documentElement.style.setProperty('--topbar-h', measure(topbarEl)+'px');
      document.documentElement.style.setProperty('--chips-h', h+'px');
    }
    window.addEventListener('resize', setStickyVars, {passive:true});
    window.addEventListener('scroll', ()=>document.body.classList.toggle('scrolled', window.scrollY>6), {passive:true});

    function toast(msg){const box=document.getElementById('toasts');const el=document.createElement('div');el.className='toast-msg';el.textContent=msg;box.appendChild(el);setTimeout(()=>{el.style.opacity='0';el.style.transform='translateY(-6px)';setTimeout(()=>el.remove(),180);},2200)}
    function cartCount(){return Object.values(state.cart).reduce((a,b)=>a+b.qty,0)}
    function bumpBadge(){const b=document.getElementById('badge');b.classList.remove('bump');void b.offsetWidth;b.classList.add('bump')}

    /* ===== Chips visible only on Menu + affix clone ===== */
    function setStep(active){
      state.active=active;
      const onMenu = active==='menu';
      chipsWrap.hidden=!onMenu; chipsWrap.setAttribute('aria-hidden', String(!onMenu));
      onMenu ? chipsWrap.removeAttribute('inert') : chipsWrap.setAttribute('inert','');
      setStickyVars();
    }
    function switchTab(to){
      const tabs=['menu','cart','data','thanks'];
      if(!tabs.includes(to)) return;
      if((to==='cart'||to==='data') && cartCount()===0){ toast('Ø£Ø¶ÙÙ Ø¹Ù†Ø§ØµØ± Ù„Ù„Ø³Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹'); return; }
      if(to==='thanks' && !state.unlockThanks){ toast('Ø£ÙƒÙ…Ù„ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ Ø£ÙˆÙ„Ø§Ù‹'); return; }
      document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('show','active'));
      document.getElementById('tab-'+to)?.classList.add('show','active');
      setStep(to); history.replaceState(null,'','#tab-'+to); setStickyVars();
    }
    document.body.addEventListener('click',(e)=>{const a=e.target.closest('a[href^="#tab-"],[data-go]');if(!a) return;e.preventDefault();switchTab(a.dataset.go||(a.getAttribute('href')||'').replace('#tab-',''));});
    document.getElementById('openCart').addEventListener('click', ()=>switchTab('cart'));

    const sentinel=document.getElementById('chipsSentinel');
    function buildAffix(){
      chipsAffix.innerHTML='';
      const wrap=document.createElement('div'); wrap.className='container';
      const clone=document.getElementById('chips').cloneNode(true);
      clone.id='chipsClone'; clone.querySelectorAll('[id]').forEach(n=>n.removeAttribute('id'));
      // Wire clone chips clicks
      clone.addEventListener('click',(e)=>{const b=e.target.closest('.chip[data-target]');if(!b) return;e.preventDefault(); scrollToSelector(b.dataset.target);});
      // Sync search value + toggle between bars
      const mainBox=document.querySelector('.chips-wrap .searchbox'); const cloneBox=clone.querySelector('.searchbox');
      const mainInput=document.querySelector('.chips-wrap [data-role="menu-search"]'); const cloneInput=clone.querySelector('[data-role="menu-search"]');
      if(cloneInput && mainInput){ cloneInput.value=mainInput.value; cloneInput.addEventListener('input',e=>{ if(mainInput.value!==e.target.value){ mainInput.value=e.target.value; mainInput.dispatchEvent(new Event('input',{bubbles:true})); } });}
      clone.querySelectorAll('.js-search-toggle').forEach(btn=>btn.addEventListener('click',(e)=>{e.preventDefault();const open=!cloneBox.classList.contains('open');[mainBox,cloneBox].forEach(b=>{b.classList.toggle('open',open);const i=b.querySelector('[data-role="menu-search"]'); if(open&&i) setTimeout(()=>i.focus(),10);});}));
      // Clear filters sync
      clone.querySelectorAll('.js-clear-filters').forEach(btn=>btn.addEventListener('click',(e)=>{e.preventDefault(); clearAll();}));
      // Reels
      clone.querySelector('.js-open-reels')?.addEventListener('click', ()=>document.getElementById('openReels')?.click());
      wrap.appendChild(clone); chipsAffix.appendChild(wrap);
    }
    let io=null;
    function observeAffix(){
      if(io) io.disconnect();
      io=new IntersectionObserver(([entry])=>{
        const show = entry.intersectionRatio===0;
        chipsAffix.classList.toggle('visible', show);
        chipsAffix.setAttribute('aria-hidden', String(!show));
        setStickyVars();
      },{rootMargin:`-${measure(topbarEl)}px 0px 0px 0px`,threshold:[0,1]});
      io.observe(sentinel);
    }

    /* ===== Menu & Options (from SHEET) ===== */

    // NORMALIZE options from Google Sheet:
    // Supported in each menu row under any of these columns: options | opts | Options | options_raw
    // 1) JSON string:
    //    [{"title":"Ø§Ù„Ø­Ø¬Ù…","type":"single","required":true,"items":[{"label":"ØµØºÙŠØ±","price":0},{"label":"ÙƒØ¨ÙŠØ±","price":5}]}]
    // 2) DSL string (groups separated by ; or newline):
    //    Ø§Ù„Ø­Ø¬Ù…|single|required|ØµØºÙŠØ±:0, ÙƒØ¨ÙŠØ±:5; Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª|multi|ÙˆØ§Ø³Ø§Ø¨ÙŠ:0, Ø£ÙÙˆÙƒØ§Ø¯Ùˆ:4
    function parseOptionsRaw(raw){
      try{
        if(!raw) return [];
        if(Array.isArray(raw)) return normalizeGroups(raw);
        if(typeof raw==='object') return normalizeGroups(raw.options||raw.groups||[]);
        const text = String(raw).trim();
        if(!text) return [];
        if(/^(\[|\{)/.test(text)){ const j=JSON.parse(text); return Array.isArray(j)?normalizeGroups(j):normalizeGroups(j.options||j.groups||[]); }
        return parseDSL(text);
      }catch{ return []; }
    }
    function normalizeGroups(arr){
      const out=[];
      (arr||[]).forEach((g,gi)=>{
        if(!g) return;
        const items = (g.items||g.choices||[]).map((it,ii)=>({
          id: it.id ?? String(ii),
          label: it.label ?? it.title ?? ('Ø®ÙŠØ§Ø± '+(ii+1)),
          price: Number(it.price ?? it.add ?? 0)
        }));
        out.push({
          id: g.id ?? ('g'+gi),
          title: g.title ?? g.name ?? 'Ø§Ø®ØªÙŠØ§Ø±',
          type: (g.type||'single').toLowerCase()==='multi' ? 'multi' : 'single',
          required: !!g.required,
          items
        });
      });
      return out;
    }
    function parseDSL(text){
      const lines = text.split(/\n|;/).map(s=>s.trim()).filter(Boolean);
      const groups=[];
      for(let li=0; li<lines.length; li++){
        const line = lines[li];
        const parts = line.split('|').map(s=>s.trim()).filter(Boolean);
        if(parts.length===0) continue;
        const g={ id:'g'+li, title:parts[0]||'Ø§Ø®ØªÙŠØ§Ø±', type:'single', required:false, items:[] };
        // read flags
        for(let i=1;i<parts.length;i++){
          const tk = parts[i];
          if(/^(single|multi)$/i.test(tk)) g.type = tk.toLowerCase()==='multi'?'multi':'single';
          else if(/^\*|required|Ø¥Ù„Ø²Ø§Ù…ÙŠ/i.test(tk)) g.required = true;
          else if(/:/.test(tk) || /=/.test(tk)){ // items segment
            const seg = parts.slice(i).join('|'); // join rest
            seg.split(/,|ØŒ/).forEach((pair,ii)=>{
              const [labelRaw, priceRaw] = pair.split(/:|=/).map(s=> (s??'').trim());
              if(!labelRaw) return;
              const price = Number((priceRaw||'0').replace(/[^\d.\-]/g,'') || 0);
              g.items.push({ id:String(ii), label:labelRaw, price:isNaN(price)?0:price });
            });
            break;
          }
        }
        groups.push(g);
      }
      return groups;
    }

    async function fetchMenu(){
      try{
        const r=await fetch(GAS_WEBAPP_URL+'?action=menu.list');
        const j=await r.json();
        const data = j.ok?(j.data||[]):[];
        // attach parsed options for each row from possible columns
        return data.map((row,idx)=>{
          const raw = row.options ?? row.opts ?? row.Options ?? row.options_raw ?? row.OPTIONS ?? '';
          const groups = parseOptionsRaw(raw);
          return { ...row, id: row.id ?? ('item_'+idx), _opts: groups };
        });
      }catch{ return []; }
    }
    // Optional: if you keep options in a separate sheet keyed by item id, enable this:
    async function fetchOptionsMap(){ // returns Map<itemId, groups[]>
      try{
        const r=await fetch(GAS_WEBAPP_URL+'?action=options.list');
        const j=await r.json();
        if(!j.ok) return new Map();
        const map=new Map();
        (j.data||[]).forEach(row=>{
          const id = String(row.itemId ?? row.id ?? '').trim();
          if(!id) return;
          const groups = parseOptionsRaw(row.options ?? row.opts ?? row.Options ?? row.options_raw);
          if(groups.length) map.set(id, groups);
        });
        return map;
      }catch{ return new Map(); }
    }

    function dishOptionGroups(d){
      // prefer parsed groups from current row, then from joined optionsMap, then fallback
      return Array.isArray(d._opts) && d._opts.length ? d._opts
           : Array.isArray(d.options) ? normalizeGroups(d.options)
           : Array.isArray(d.opts) ? normalizeGroups(d.opts)
           : [];
    }

    /* ===== Render menu ===== */
    const ORDERED_CATS=[{key:'sushi',label:'Ø³ÙˆØ´ÙŠ'},{key:'don',label:'Ø¯ÙˆÙ†'},{key:'meat',label:'Ù„Ø­ÙˆÙ…'},{key:'drinks',label:'Ù…Ø´Ø±ÙˆØ¨Ø§Øª'}];
    const sectionsRoot=document.getElementById('menuSections');
    const dishTpl=document.getElementById('dishTpl');
    const emptyMsg=document.getElementById('emptyMsg');
    const badge=document.getElementById('badge');
    const miniCount=document.getElementById('miniCount');
    const miniTotal=document.getElementById('miniTotal');
    const miniHint=document.getElementById('miniHint');
    const goCartBtn=document.getElementById('goCartBtn');
    const toDataBtn=document.getElementById('toDataBtn');
    const cartTotal=document.getElementById('cartTotal');
    const cartList=document.getElementById('cartList');
    function fmtSAR(n){return fmt.format(Number(n||0))}
    function imgFallback(el){el.src='data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="675"><rect width="100%" height="100%" fill="#e9e6df"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#8b877e" font-family="Arial" font-size="28">Ù„Ø§ ØµÙˆØ±Ø©</text></svg>`)}

    function revealObserve(){
      const ro=new IntersectionObserver(es=>{es.forEach(e=>{if(e.isIntersecting){e.target.classList.add('in'); ro.unobserve(e.target);}})},{threshold:.2});
      document.querySelectorAll('.reveal').forEach(el=>ro.observe(el));
    }
    function groupByCat(menu){const g={};menu.forEach(d=>{const k=(d.cat||'').toLowerCase();(g[k]=g[k]||[]).push(d)});return g}

    // OPTIONS MODAL
    const optModalEl=document.getElementById('optModal');
    const optModal=bootstrap.Modal.getOrCreateInstance(optModalEl);
    const optTitle=document.getElementById('optTitle');
    const optSummary=document.getElementById('optSummary');
    const optForm=document.getElementById('optForm');
    const optMinus=document.getElementById('optMinus');
    const optPlus=document.getElementById('optPlus');
    const optQty=document.getElementById('optQty');
    const optPrice=document.getElementById('optPrice');
    const optNotes=document.getElementById('optNotes');
    const optAddBtn=document.getElementById('optAddBtn');
    let currentDish=null;

    function renderOptionGroups(d){
      optForm.innerHTML='';
      const groups = dishOptionGroups(d);
      if(!groups.length){
        const hint=document.createElement('div');hint.className='small';hint.style.color='#4a4741';hint.textContent='Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¶Ø§ÙØ§Øª â€” ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± Ø§Ù„ÙƒÙ…ÙŠØ© ÙˆÙƒØªØ§Ø¨Ø© Ù…Ù„Ø§Ø­Ø¸Ø© Ø¥Ù† Ø±ØºØ¨Øª.';optForm.appendChild(hint);return;
      }
      groups.forEach((g,gi)=>{
        const fs=document.createElement('fieldset'); fs.className='vstack gap-2'; fs.dataset.required = g.required ? '1':'0';
        const legend=document.createElement('legend'); legend.className='fw-bold'; legend.textContent=(g.title||'Ø§Ø®ØªÙŠØ§Ø±')+(g.required?' *':''); fs.appendChild(legend);
        const name='opt_'+(g.id||('g'+gi));
        (g.items||[]).forEach((it,ii)=>{
          const id = `${name}_${ii}`;
          const row=document.createElement('div'); row.className='form-check d-flex align-items-center justify-content-between border rounded-3 px-3 py-2'; row.style.borderColor='var(--border-on-light)';
          const left=document.createElement('div'); left.className='d-flex align-items-center gap-2';
          const input=document.createElement('input'); input.className='form-check-input'; input.type=g.type==='multi'?'checkbox':'radio'; input.name=name; input.id=id; input.value=it.id??String(ii); input.dataset.price=Number(it.price||0); input.dataset.label=it.label||it.title||('Ø®ÙŠØ§Ø± '+(ii+1));
          if(g.type!=='multi' && ii===0) input.checked=true;
          const label=document.createElement('label'); label.className='form-check-label'; label.htmlFor=id; label.textContent=input.dataset.label;
          left.append(input,label);
          const price=document.createElement('span'); price.className='small'; price.style.color='#141414'; const p=Number(it.price||0); price.textContent=p>0?('+'+fmtSAR(p)):'Ù…Ø¬Ø§Ù†ÙŠ';
          row.append(left,price); fs.appendChild(row);
        });
        optForm.appendChild(fs);
      });
    }
    function selectedOptions(){
      return [...optForm.querySelectorAll('input[type="checkbox"],input[type="radio"]')].filter(i=>i.checked).map(i=>({id:i.value,label:i.dataset.label,price:Number(i.dataset.price||0),name:i.name}));
    }
    function validateRequired(){
      const sets=[...optForm.querySelectorAll('fieldset[data-required="1"]')];
      for(const fs of sets){
        const any=fs.querySelector('input:checked'); if(any) continue;
        toast('Ø§Ø®ØªØ± Ø®ÙŠØ§Ø±Ø§Ù‹ Ù…Ø·Ù„ÙˆØ¨Ø§Ù‹'); const focusEl=fs.querySelector('input'); if(focusEl) focusEl.focus(); return false;
      }
      return true;
    }
    function calcUnitPrice(d){return Number(d?.price||0)+selectedOptions().reduce((s,o)=>s+(o.price||0),0)}
    function updateOptPrice(){ if(!currentDish) return; const unit=calcUnitPrice(currentDish); const qty=Math.max(1,Number(optQty.value||1)); optPrice.textContent=fmtSAR(unit*qty);}
    function openOptions(d){
      currentDish=d; optTitle.textContent=d.title||'Ø®ÙŠØ§Ø±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©'; optSummary.textContent=`Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ: ${fmtSAR(Number(d.price||0))}`; optNotes.value=''; optQty.value=1;
      renderOptionGroups(d); optForm.addEventListener('change', updateOptPrice, {once:false}); updateOptPrice(); optModal.show();
    }
    optMinus.addEventListener('click',()=>{optQty.value=Math.max(1,Number(optQty.value||1)-1);updateOptPrice()});
    optPlus.addEventListener('click',()=>{optQty.value=Math.max(1,Number(optQty.value||1)+1);updateOptPrice()});
    optQty.addEventListener('input',()=>{if(Number(optQty.value)<1) optQty.value=1; updateOptPrice()});
    optAddBtn.addEventListener('click',()=>{
      if(!currentDish) return;
      if(!validateRequired()) return;
      const chosen=selectedOptions(); const notes=optNotes.value.trim(); const qty=Math.max(1,Number(optQty.value||1));
      addConfiguredLine(currentDish, qty, chosen, notes);
      optModal.hide();
    });

    function renderSections(){
      const q=(state.q||'').trim().toLowerCase();
      const groups=groupByCat(state.menu); sectionsRoot.innerHTML=''; let totalMatches=0;
      ORDERED_CATS.forEach(({key,label})=>{
        const items=(groups[key]||[]).filter(d=>!q || [d.title||'',d.desc||''].join(' ').toLowerCase().includes(q));
        if(!items.length) return;
        const sec=document.createElement('section'); sec.className='menu-section'; sec.id='sec-'+key;
        const title=document.createElement('h5'); title.className='sec-title'; title.textContent=label; sec.appendChild(title);
        const grid=document.createElement('div'); grid.className='menu-grid';
        items.forEach(d=>{
          const node=dishTpl.content.firstElementChild.cloneNode(true); node.dataset.cat=key;
          const img=node.querySelector('.dish-img'); img.alt=d.title||''; img.addEventListener('error',()=>imgFallback(img)); if(d.img && /^https?:\/\//.test(d.img)) img.src=d.img; else imgFallback(img);
          node.querySelector('.title').textContent=d.title||'â€”';
          node.querySelector('.desc').textContent=d.desc||'';
          node.querySelector('.price').textContent=fmtSAR(Number(d.price||0));
          const tags=node.querySelector('.tags'); (d.tags||[]).slice(0,3).forEach(t=>{const s=document.createElement('span');s.className='tag';s.textContent=t;tags.appendChild(s);});
          // Always open options (taken from sheet) when adding
          node.querySelector('.add-btn').addEventListener('click',()=>openOptions(d));
          grid.appendChild(node);
        });
        sec.appendChild(grid); sectionsRoot.appendChild(sec); totalMatches+=items.length;
      });
      emptyMsg.classList.toggle('d-none', totalMatches>0);
      document.querySelectorAll('.js-clear-filters').forEach(btn=>btn.classList.toggle('d-none', !(state.q||'').trim()));
      setupScrollspy(); revealObserve(); setStickyVars();
    }

    /* Chips: click -> smooth scroll */
    function totalFixedHeight(){return (parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--topbar-h'))||0)+(parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--chips-h'))||0)}
    function scrollToSelector(sel){const t=document.querySelector(sel); if(!t) return; const y=t.getBoundingClientRect().top+window.scrollY-totalFixedHeight()-8; window.scrollTo({top:Math.max(0,y),behavior:'smooth'})}
    document.getElementById('chips').addEventListener('click',(e)=>{const b=e.target.closest('.chip[data-target]'); if(!b) return; e.preventDefault(); scrollToSelector(b.dataset.target);});

    /* Scrollspy */
    let spy=null;
    function setupScrollspy(){
      if(spy){spy.disconnect(); spy=null;}
      const chips=[...document.querySelectorAll('#chips .chip[data-target], #chipsAffix .chip[data-target]')];
      spy=new IntersectionObserver((entries)=>{
        const first=entries.filter(e=>e.isIntersecting).sort((a,b)=>b.intersectionRatio-a.intersectionRatio)[0];
        if(!first) return; const id='#'+first.target.id;
        chips.forEach(c=>c.classList.toggle('active', c.dataset.target===id || (id==='#topOfMenu' && c.dataset.target==='#topOfMenu')));
      },{rootMargin:'-40% 0px -50% 0px',threshold:[0.2,0.4,0.6,0.8,1]});
      document.querySelectorAll('.menu-section').forEach(sec=>spy.observe(sec));
      const top=document.getElementById('topOfMenu'); if(top) spy.observe(top);
    }

    /* Search */
    const mainBox=document.querySelector('.chips-wrap .searchbox');
    document.querySelectorAll('.js-search-toggle').forEach(btn=>btn.addEventListener('click',(e)=>{e.preventDefault();const open=!mainBox.classList.contains('open');const cloneBox=chipsAffix.querySelector('.searchbox');[mainBox,cloneBox].forEach(b=>{b.classList.toggle('open',open);const i=b?.querySelector('[data-role="menu-search"]'); if(open&&i) setTimeout(()=>i.focus(),10);});}));
    const mainInput=document.querySelector('.chips-wrap [data-role="menu-search"]');
    let t=null;
    function onSearch(val){state.q=val||''; renderSections();}
    mainInput.addEventListener('input',e=>{clearTimeout(t); const val=e.target.value; const aff=chipsAffix.querySelector('[data-role="menu-search"]'); if(aff && aff.value!==val) aff.value=val; t=setTimeout(()=>onSearch(val),160)});
    function clearAll(){state.q=''; mainInput.value=''; const aff=chipsAffix.querySelector('[data-role="menu-search"]'); if(aff) aff.value=''; renderSections(); document.getElementById('topOfMenu').scrollIntoView({behavior:'smooth',block:'start'});}
    document.querySelectorAll('.js-clear-filters').forEach(btn=>btn.addEventListener('click',(e)=>{e.preventDefault(); clearAll();}));

    /* Cart */
    function stableId(str){let h=0; for(let i=0;i<str.length;i++){h=((h<<5)-h)+str.charCodeAt(i); h|=0;} return 'l_'+Math.abs(h).toString(36)}
    function cartArr(){return Object.values(state.cart)}
    function totals(){const arr=cartArr(); return {count:arr.reduce((a,b)=>a+b.qty,0), total:arr.reduce((a,b)=>a+b.qty*b.unitPrice,0), arr}}
    function bump(){
      const t=totals(); badge.textContent=t.count; miniCount.textContent=`${t.count} Ø¹Ù†ØµØ±`; miniTotal.textContent=fmtSAR(t.total); cartTotal.textContent=fmtSAR(t.total);
      const need=Math.max(0, FREE_SHIP - t.total); miniHint.textContent = need>0 ? `ØªØ¨Ù‚Ù‰ ${fmtSAR(need)} Ù„Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ ğŸ` : `ğŸ Ø­ØµÙ„Øª Ø¹Ù„Ù‰ ØªÙˆØµÙŠÙ„ Ù…Ø¬Ø§Ù†ÙŠ`;
      localStorage.setItem('hk_cart_v3', JSON.stringify(state.cart));
      const has=t.count>0; goCartBtn.classList.toggle('disabled',!has); goCartBtn.setAttribute('aria-disabled',String(!has)); toDataBtn.classList.toggle('disabled',!has); toDataBtn.setAttribute('aria-disabled',String(!has));
      renderCartList();
    }
    function addConfiguredLine(dish, qty, chosen, notes){
      const unit = Number(dish.price||0) + (chosen||[]).reduce((s,o)=>s+(Number(o.price)||0),0);
      const optText = (chosen||[]).length ? ' â€” '+chosen.map(o=>o.label).join('ØŒ ') : '';
      const title = (dish.title||'â€”') + optText + (notes?` (${notes})`:'');
      const key=stableId(JSON.stringify({id:dish.id, unit, opts:(chosen||[]).map(o=>o.id), notes:notes||''}));
      const ex=state.cart[key]; if(ex) ex.qty+=qty; else state.cart[key]={lineId:key,id:dish.id,title,unitPrice:unit,qty,notes:notes||''};
      bump(); bumpBadge(); toast(`Ø£ÙØ¶ÙŠÙ ${dish.title} âœ…`);
    }
    function renderCartList(){
      cartList.innerHTML=''; const {arr}=totals();
      if(!arr.length){ const p=document.createElement('p'); p.className='text-secondary text-center my-4'; p.style.color='#4a4741'; p.textContent='Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©'; cartList.appendChild(p); return; }
      arr.forEach(it=>{
        const row=cartLineTpl.content.firstElementChild.cloneNode(true);
        row.querySelector('.name').textContent=it.title;
        row.querySelector('.unit').textContent=Number(it.unitPrice||0).toFixed(2);
        row.querySelector('.qty').textContent=it.qty;
        row.querySelector('.total').textContent=fmtSAR(it.qty*it.unitPrice);
        row.querySelector('.minus').addEventListener('click',()=>{ if(state.cart[it.lineId].qty>1) state.cart[it.lineId].qty--; else delete state.cart[it.lineId]; bump(); });
        row.querySelector('.plus').addEventListener('click',()=>{ state.cart[it.lineId].qty++; bump(); });
        cartList.appendChild(row);
      });
    }
    const saved=localStorage.getItem('hk_cart_v3'); if(saved){try{state.cart=JSON.parse(saved)||{}}catch{}}

    /* Data form + confirm */
    const segPick=document.getElementById('segPickup'), segDel=document.getElementById('segDelivery'), addrWrap=document.getElementById('addressWrap');
    const nameEl=document.getElementById('custName'), phoneEl=document.getElementById('custPhone'), addrEl=document.getElementById('address'), notesEl=document.getElementById('notes'), confirmBtn=document.getElementById('confirmBtn');
    const iti=window.intlTelInput(phoneEl,{ initialCountry:'sa', onlyCountries:['sa','ae','bh','kw','om','qa'], separateDialCode:true });
    function setType(delivery){segPick.setAttribute('aria-pressed',String(!delivery));segDel.setAttribute('aria-pressed',String(delivery));addrWrap.style.display=delivery?'':'none'; if(delivery) setTimeout(()=>addrEl.focus(),80)}
    segPick.onclick=()=>setType(false); segDel.onclick=()=>setType(true); setType(false);
    notesEl.addEventListener('input',()=>{document.getElementById('notesCount').textContent=(notesEl.value||'').length});
    function validate(){
      const nameOk=(nameEl.value||'').trim().length>1; let phoneOk=false; try{phoneOk=iti.isValidNumber();}catch{phoneOk=(phoneEl.value||'').trim().length>=8}
      const delivery=segDel.getAttribute('aria-pressed')==='true'; const addressOk=!delivery || (addrEl.value||'').trim().length>3;
      document.getElementById('err-name').classList.toggle('d-none',nameOk);
      document.getElementById('ok-phone').classList.toggle('d-none',!phoneOk);
      document.getElementById('err-phone').classList.toggle('d-none',phoneOk);
      document.getElementById('err-address').classList.toggle('d-none',addressOk);
      return nameOk && phoneOk && addressOk;
    }
    ['input','blur'].forEach(ev=>{nameEl.addEventListener(ev,validate);phoneEl.addEventListener(ev,()=>setTimeout(validate,ev==='blur'?0:120));addrEl.addEventListener(ev,validate);});

    async function createOrder(payload){
      const r=await fetch(GAS_WEBAPP_URL+'?action=order.create',{ method:'POST', headers:{'Content-Type':'text/plain'}, body:JSON.stringify(payload) });
      return r.json();
    }
    const thOrderId=document.getElementById('thOrderId'), thTotal=document.getElementById('thTotal'), thType=document.getElementById('thType'), thTicket=document.getElementById('thTicket'), thDate=document.getElementById('thDate');
    function todayKey(){const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`}
    function nextDailyTicketLocal(){const key=todayKey(); const savedDay=localStorage.getItem('hk_ticket_day'); let seq=Number(localStorage.getItem('hk_ticket_seq')||0); if(savedDay!==key) seq=0; seq=(seq%9999)+1; localStorage.setItem('hk_ticket_day',key); localStorage.setItem('hk_ticket_seq',String(seq)); return String(seq).padStart(4,'0')}
    function setThankDate(){ const d=new Date(); thDate.textContent=d.toLocaleDateString('ar-SA',{weekday:'short',year:'numeric',month:'2-digit',day:'2-digit'})}
    async function copy(text){ try{await navigator.clipboard.writeText(text); toast('ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…')}catch{toast('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ù†Ø³Ø®')} }
    function renderThanks({orderId, totals, payload}){const t4=nextDailyTicketLocal(); thTicket.textContent=t4; setThankDate(); thOrderId.textContent=orderId||'â€”'; thTotal.textContent=typeof totals?.total==='number'?fmtSAR(totals.total):fmtSAR(totals||0); thType.textContent=payload.type==='delivery'?'Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨: ØªÙˆØµÙŠÙ„':'Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨: Ø§Ø³ØªÙ„Ø§Ù…'; document.getElementById('copyTicket').onclick=()=>copy(`ØªØ°ÙƒØ±Ø© ${t4} â€¢ ${todayKey()}`); document.getElementById('copySummary').onclick=()=>copy(`Ø·Ù„Ø¨ Maison Hikari\nØªØ°ÙƒØ±Ø©: ${t4}\n${thType.textContent}\nØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${thTotal.textContent}`)}

    const submitLoading=document.getElementById('submitLoading');
    confirmBtn.onclick=async()=>{
      const t=totals(); if(t.count===0){toast('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©'); switchTab('menu'); return;}
      if(!validate()){window.scrollTo({top:0,behavior:'smooth'}); toast('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©'); return;}
      let phone=phoneEl.value.trim(); try{phone=iti.getNumber();}catch{}
      const payload={ type: segDel.getAttribute('aria-pressed')==='true'?'delivery':'pickup', name:nameEl.value.trim(), phone, address:addrEl.value.trim(), notes:notesEl.value.trim(), items:t.arr.map(x=>({id:x.id,title:x.title,qty:x.qty,price:x.unitPrice})) };
      const prevHTML=confirmBtn.innerHTML; confirmBtn.disabled=true; confirmBtn.classList.add('btn-loading'); confirmBtn.innerHTML=`Ø¬Ø§Ø±Ù Ø§Ù„ØªØ£ÙƒÙŠØ¯ <span class="spinner-border" role="status" aria-hidden="true"></span>`;
      submitLoading.classList.add('show');
      try{ const res=await createOrder(payload); if(res && res.ok){ localStorage.setItem('hk_user_v1', JSON.stringify({name:payload.name, phone:phoneEl.value, address:payload.address})); state.cart={}; bump(); renderThanks({orderId:res.orderId, totals:res.totals||t.total, payload}); state.unlockThanks=true; switchTab('thanks'); } else { toast('ØªØ¹Ø°Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§'); } }
      catch{ toast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø¯Ù…Ø©'); }
      finally{ confirmBtn.disabled=false; confirmBtn.classList.remove('btn-loading'); confirmBtn.innerHTML=prevHTML; submitLoading.classList.remove('show'); }
    };

    /* INIT */
    (async()=>{
      const appLoading=document.getElementById('appLoading'); appLoading.classList.add('show');
      try{ const savedInfo=JSON.parse(localStorage.getItem('hk_user_v1')||'{}'); if(savedInfo.name) document.getElementById('custName').value=savedInfo.name; if(savedInfo.phone) document.getElementById('custPhone').value=savedInfo.phone; if(savedInfo.address){ document.getElementById('address').value=savedInfo.address; setType(true);} }catch{}
      // Load menu + (optional) separate options sheet and merge
      const [menu, optMap] = await Promise.all([fetchMenu(), fetchOptionsMap()]);
      if(optMap && optMap.size){ menu.forEach(d=>{ const g=optMap.get(String(d.id)); if(g && g.length) d._opts=g; }); }
      state.menu = menu;
      if(!state.menu.length) setTimeout(()=>toast('Ù„Ù… ÙŠØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…Ù† Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¨Ø¹Ø¯'),600);

      // Show menu
      renderSections(); setStep('menu'); buildAffix(); observeAffix(); bump(); appLoading.classList.remove('show');
    })();

    /* Reels quick module (open) */
    (function(){
      const reels=document.getElementById('reels'), list=document.getElementById('reelsList'), open=document.getElementById('openReels'), closeBtn=document.getElementById('closeReels'), toCart=document.getElementById('reelsToCart'), reelsLoading=document.getElementById('reelsLoading');
      function reelNode(d){
        const div=document.createElement('section'); div.className='reel';
        const media=document.createElement('div'); media.className='media';
        const img=document.createElement('img'); img.loading='lazy'; img.decoding='async'; img.alt=d.title||''; if(d.img && /^https?:\/\//.test(d.img)) img.dataset.src=d.img; media.appendChild(img);
        const glass=document.createElement('div'); glass.className='glass'; const h3=document.createElement('h3'); h3.className='title'; h3.textContent=d.title||'â€”'; const dsc=document.createElement('div'); dsc.className='desc'; dsc.textContent=d.desc||''; const tagbox=document.createElement('div'); tagbox.className='tagbox'; (d.tags||[]).slice(0,3).forEach(t=>{const s=document.createElement('span');s.className='tag';s.textContent=t;tagbox.appendChild(s)}); glass.append(h3,dsc,tagbox);
        const cta=document.createElement('div'); cta.className='cta'; const add=document.createElement('button'); add.className='btn btn-dark flex-fill'; add.type='button'; add.textContent=`Ø£Ø¶Ù â€” ${fmtSAR(Number(d.price||0))}`; add.onclick=()=>openOptions(d); const more=document.createElement('button'); more.className='btn btn-outline-light'; more.type='button'; more.textContent='ØªÙØ§ØµÙŠÙ„'; cta.append(add,more);
        div.append(media,glass,cta); return div;
      }
      function loadImgIn(el){const img=el.querySelector('img[data-src]'); if(img && !img.src) img.src=img.dataset.src;}
      let idxObs=null; function openReels(){
        const q=(state.q||'').toLowerCase(); const filtered=(state.menu||[]).filter(d=>!q || [d.title||'',d.desc||''].join(' ').toLowerCase().includes(q));
        if(!filtered.length){ toast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø·Ø¨Ø§Ù‚ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±ÙŠÙŠÙ„'); return; }
        list.innerHTML=''; reels.classList.add('show'); reels.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; reelsLoading.hidden=false;
        filtered.forEach(d=>list.appendChild(reelNode(d)));
        const firstImg=list.querySelector('img[data-src]')||list.querySelector('img'); let done=false; const hide=()=>{if(done) return; done=true; reelsLoading.hidden=true}; if(firstImg){firstImg.addEventListener('load',hide,{once:true}); firstImg.addEventListener('error',hide,{once:true});} setTimeout(hide,900);
        idxObs=new IntersectionObserver(es=>{es.forEach(e=>{if(e.isIntersecting) loadImgIn(e.target);})},{root:list,threshold:.6}); [...list.children].forEach(n=>idxObs.observe(n));
      }
      function closeReels(){reels.classList.remove('show'); reels.setAttribute('aria-hidden','true'); document.body.style.overflow=''; reelsLoading.hidden=true; if(idxObs){idxObs.disconnect(); idxObs=null;}}
      open?.addEventListener('click', openReels); closeBtn?.addEventListener('click', closeReels); toCart?.addEventListener('click', ()=>{closeReels(); document.getElementById('openCart').click();});
    })();

    /* Theme meta sync */
    const themeMeta=document.querySelector('meta[name="theme-color"]'); function setThemeColorMeta(){const cs=getComputedStyle(document.documentElement).getPropertyValue('--charcoal').trim(); if(themeMeta && cs) themeMeta.setAttribute('content', cs);} window.addEventListener('load', setThemeColorMeta, {once:true});
  });
  </script>
</body>
</html>
