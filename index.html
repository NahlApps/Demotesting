<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>حجوزات المواعيد — نحل</title>

  <!-- Fonts & Icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800&display=swap" rel="stylesheet"/>

  <!-- UI libs -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/css/intlTelInput.css" rel="stylesheet"/>

  <style>
/* =========================
   Nahl Booking – UI System
   ========================= */
:root{
  --brand-700:#01657A; --brand-600:#027A93; --brand-200:#BFE6F0; --brand-050:#F0FAFC;
  --ink-900:#0B2630; --surface-000:#FFF; --border-300:#D4E0E6;

  --radius-md:14px; --radius-pill:999px;
  --shadow-xs:0 2px 6px rgba(11,38,48,.07);
  --shadow-sm:0 3px 12px rgba(11,38,48,.09);
  --shadow-md:0 10px 28px rgba(11,38,48,.14);

  --ease:cubic-bezier(.22,.61,.36,1);
  --dur-xs:160ms; --dur-sm:220ms; --dur-md:460ms;

  --header-h:76px; --footer-h:118px;

  --page-bg:url("https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Nahl%20Time%20Headers/NahlBG-2.jpg");
}

/* Base layout */
html,body{height:100%}
body{
  margin:0; font-family:'Cairo',sans-serif; color:#fff;
  background-color:#0B2630;
  background-image:
    linear-gradient(180deg, rgba(11,38,48,.58), rgba(11,38,48,.34)),
    var(--page-bg);
  background-position:center,center;
  background-size:cover,cover;
  background-repeat:no-repeat,no-repeat;
  background-attachment:scroll,scroll;
  min-height:100vh; min-height:100dvh;
  display:flex; flex-direction:column;
  padding-top:var(--header-h); padding-bottom:var(--footer-h);
}
@media (pointer:fine){ body{ background-attachment: scroll, fixed; } }

/* Header */
header{ position:fixed; top:0; left:0; right:0; z-index:999;
  background:rgba(11,38,48,.36); backdrop-filter:blur(10px);
  border-bottom:1px solid rgba(255,255,255,.15); }
.header-inner{ max-width:1120px; width:100%; margin:0 auto; padding:10px 12px;
  display:flex; align-items:center; gap:12px; justify-content:space-between; }
.brand img{height:64px; width:auto; object-fit:contain; filter:drop-shadow(0 6px 20px rgba(0,0,0,.25));}
.mini-progress{display:flex; gap:10px; align-items:center}
.mini-progress .bar{flex:1; height:8px; background:rgba(255,255,255,.25); border-radius:999px; overflow:hidden}
.mini-progress .bar>span{display:block; height:100%; width:0%; background:linear-gradient(90deg, var(--brand-600), var(--brand-200)); transition:width var(--dur-md) var(--ease)}
.summary-chips{display:flex; flex-wrap:wrap; gap:6px}

/* Stage/pages */
main{flex:1 0 auto; display:flex; justify-content:center; padding:8px 12px 0}
#app{width:100%; max-width:1120px}
.stage{position:relative; min-height:560px; padding:8px 0 20px}
.page{
  position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; gap:20px;
  padding:24px 12px 28px; overflow:auto; opacity:0; transform:translateY(12px) scale(.992); pointer-events:none;
  content-visibility:auto; contain-intrinsic-size:800px;
}
.page.active{ pointer-events:auto; animation:pageIn var(--dur-md) var(--ease) both }
.page.exit  { animation:pageOut var(--dur-sm) var(--ease) both }
@keyframes pageIn{ from{opacity:0; transform:translateY(12px) scale(.992)} to{opacity:1; transform:translateY(0) scale(1)} }
@keyframes pageOut{ from{opacity:1; transform:translateY(0) scale(1)} to{opacity:0; transform:translateY(14px) scale(.985)} }

.card{
  background:rgba(255,255,255,.92); color:#0B2630; border-radius:14px;
  box-shadow:var(--shadow-md); padding:24px; width:100%; max-width:920px; backdrop-filter:blur(6px);
}

/* Inputs / selects */
.form-control, select, .select2-selection{
  background:#fff; color:#0B2630; border:1px solid var(--border-300)!important; border-radius:14px!important;
  min-height:52px; text-align:center; font-size:16px;
  transition:border-color var(--dur-xs) var(--ease), box-shadow var(--dur-xs) var(--ease);
}
.form-control:focus{ box-shadow:0 0 0 4px rgba(2,122,147,.12) }
.form-label{display:inline-block; margin-bottom:6px; font-size:.9rem; font-weight:800; color:#224652}
.field-error{display:none; color:#dc2626; font-size:.85rem; margin-top:6px;}
.field-error[data-show="true"]{display:block}

/* Chips */
.chip{ display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px;
  background:#f3f7f9; font-size:.8rem; color:#0B2630; border:1px solid var(--border-300); cursor:pointer; }
.chip.current{ outline:2px dashed var(--brand-600); outline-offset:2px; }

/* Tabs + Cards */
.visually-hidden{position:absolute!important;width:1px!important;height:1px!important;padding:0!important;margin:-1px!important;overflow:hidden!important;clip:rect(0,0,0,0)!important;border:0!important}
#srvTabs{ display:flex; gap:8px; flex-wrap:nowrap; overflow:auto; -webkit-overflow-scrolling:touch; margin-top:14px; padding-bottom:4px; }
.srv-tab{
  background:#fff; color:#0B2630; border:1px solid var(--border-300); border-radius:999px;
  padding:8px 12px; font-weight:800; white-space:nowrap; cursor:pointer;
  transition:transform var(--dur-xs) var(--ease), box-shadow var(--dur-xs) var(--ease), background var(--dur-xs) var(--ease);
}
.srv-tab[aria-selected="true"]{ background:var(--brand-600); color:#fff; border-color:var(--brand-600); box-shadow:var(--shadow-sm); }

/* Grid */
#srvCards{ display:grid; grid-template-columns:1fr; gap:12px; margin-top:12px }
@media(min-width:560px){ #srvCards{ grid-template-columns:repeat(2,1fr) } }
@media(min-width:900px){ #srvCards{ grid-template-columns:repeat(3,1fr) } }

/* Card */
.srv-card{
  position:relative; background:#fff; color:#0B2630; border:1px solid var(--border-300); border-radius:14px; box-shadow:var(--shadow-xs);
  padding:0; min-height:180px; display:flex; flex-direction:column; overflow:hidden;
  transition:transform var(--dur-xs) var(--ease), box-shadow var(--dur-xs) var(--ease), border-color var(--dur-xs) var(--ease), background var(--dur-xs) var(--ease);
  outline:none;
}
.srv-card:hover{ transform:translateY(-2px); box-shadow:var(--shadow-sm); }
.srv-card.selected{ outline:3px solid var(--brand-600); outline-offset:2px; }
.srv-thumb{ width:100%; height:120px; background:#eaf5f8 center/cover no-repeat; border-bottom:1px solid var(--border-300); }
.srv-body{ padding:12px 12px 14px; display:flex; flex-direction:column; gap:8px; flex:1; }
.srv-title{ font-size:1rem; font-weight:800; margin:0; display:flex; align-items:center; gap:8px; }
.srv-badges{ display:flex; flex-wrap:wrap; gap:6px; }
.s-badge{
  display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; border:1px solid var(--border-300); font-size:.78rem; background:#fff;
}
.s-badge.popular{ background:var(--brand-050); border-color:var(--brand-600); }
.srv-meta{ display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
.chip.price{ font-weight:800; }
.srv-desc{ font-size:.86rem; color:#365563; line-height:1.5; }

/* clamp desc on mobile */
@media (max-width:640px){
  .srv-desc{
    display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden;
  }
}

.srv-actions{ margin-top:auto; display:flex; gap:8px; padding:12px; border-top:1px solid var(--border-300); }
.btn-add, .btn-remove{
  flex:1; border:1px solid var(--border-300); border-radius:12px; padding:10px 12px; font-weight:800; min-height:44px;
  background:#fff; color:#027A93;
}
.btn-add:hover, .btn-remove:hover{ background:var(--brand-050) }
.btn-remove{ color:#0B2630 }

/* Addons (desktop) */
.addon-title{ font-weight:800; color:#224652; margin-top:16px; margin-bottom:8px; }
.addon-chips{ display:flex; flex-wrap:wrap; gap:8px; }
.addon-chip{ display:inline-flex; align-items:center; gap:8px; border:1px solid var(--border-300); background:#fff; border-radius:999px; padding:8px 12px; min-height:40px; cursor:pointer; }
.addon-chip[aria-pressed="true"]{ background:var(--brand-050); outline:2px solid var(--brand-600); outline-offset:2px; }

/* Description Panel */
.service-desc{ margin-top:12px; border:1px solid var(--border-300); border-radius:14px; background:#fff; color:#0B2630; padding:16px; }
.service-desc .title{ font-weight:800; color:#224652; margin-bottom:6px; }
.skeleton{ height:12px; background:linear-gradient(90deg,#eef5f8,#fff,#eef5f8); background-size:180% 100%; border-radius:8px; animation:s 1.2s var(--ease) infinite; }
@keyframes s{ 0%{background-position:0% 0} 100%{background-position:-180% 0} }

/* Time grid */
.time-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(110px,1fr)); gap:10px; }
.time-option {
  border:1px solid var(--border-300); background:#fff; color:#0B2630; border-radius:12px;
  min-height:44px; padding:10px 12px; font-weight:800; cursor:pointer;
  transition:box-shadow var(--dur-xs) var(--ease), transform var(--dur-xs) var(--ease), background var(--dur-xs) var(--ease);
}
.time-option[aria-checked="true"] { outline:3px solid var(--brand-600); outline-offset:2px; background:var(--brand-050); }
.time-option:focus-visible { box-shadow:0 0 0 4px rgba(2,122,147,.18); }

/* Loading overlays */
.load-overlay {
  position:absolute; inset:0; display:none; align-items:center; justify-content:center; gap:10px;
  background:rgba(255,255,255,.65); backdrop-filter:blur(3px); border-radius:14px; color:#0B2630;
}
.load-overlay.show { display:flex; }

/* Pay grid */
.pay-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); gap:10px; }
.pay-card {
  display:flex; align-items:center; justify-content:center; gap:10px; cursor:pointer;
  border:1px solid var(--border-300); background:#fff; color:#0B2630; border-radius:14px; min-height:64px; padding:8px 12px;
  transition:box-shadow var(--dur-xs) var(--ease), transform var(--dur-xs) var(--ease), background var(--dur-xs) var(--ease);
}
.pay-card img { max-height:28px; width:auto; object-fit:contain; }
.pay-card[aria-checked="true"] { outline:3px solid var(--brand-600); outline-offset:2px; background:var(--brand-050); }

/* Map */
#googleMap { width:100%; min-height:360px; border-radius:14px; border:1px solid var(--border-300); box-shadow:var(--shadow-xs); }
.map-search { position:relative; }
.map-search i { position:absolute; left:14px; top:50%; transform:translateY(-50%); color:#405a66; }

/* Footer: sticky nav + mini-cart */
.sticky-nav{
  position:fixed; bottom:0; left:0; right:0;
  background:rgba(11,38,48,.36); backdrop-filter:blur(8px);
  border-top:1px solid rgba(255,255,255,.15);
}
.footer-inner{
  max-width:1120px; margin:0 auto; padding:10px 12px;
  display:grid; grid-template-columns:1fr auto; align-items:center; gap:10px; color:#fff;
}
.btn-footer{
  min-height:48px; border-radius:12px; padding:10px 16px; font-weight:800;
  background:#fff; color:var(--brand-600); border:1px solid var(--border-300); box-shadow:var(--shadow-xs);
  transition:transform var(--dur-xs) var(--ease), box-shadow var(--dur-xs) var(--ease);
  flex:1;
}
.btn-footer.primary{ background:var(--brand-600); color:#fff; border-color:var(--brand-600); }
.btn-footer.disabled, .btn-footer:disabled{ opacity:.6; pointer-events:none; }
.hidden{ display:none!important; }
#footer-wait{ display:none; align-items:center; gap:8px; }
#footer-wait.show{ display:flex; }

/* Mini-cart */
.footer-cart{
  background:rgba(255,255,255,.92); color:#0B2630;
  border:1px solid var(--border-300); border-radius:12px; padding:10px 12px;
  box-shadow:var(--shadow-sm); display:flex; flex-direction:column; gap:4px; min-width:0;
}
.footer-cart .fc-line{ display:flex; justify-content:space-between; gap:8px; font-weight:800 }
.footer-cart .fc-title{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
.footer-cart .fc-total{ white-space:nowrap }
.footer-cart .fc-sub{ color:#365563; font-size:.85rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }

/* Mobile polish */
@media (max-width:640px){
  header .brand img{ height:56px }
  .card{ padding:16px; border-radius:12px }

  #srvCards{
    display:flex; overflow-x:auto; gap:10px; padding:2px 2px 6px;
    scroll-snap-type:x mandatory; -webkit-overflow-scrolling:touch;
  }
  .srv-card{
    min-width:84%; flex:0 0 auto; scroll-snap-align:center;
    box-shadow:0 2px 8px rgba(11,38,48,.08); border-color:#E5EFF4
  }
  .srv-thumb{ height:96px }
  .srv-actions{ padding:10px }
  .btn-add,.btn-remove{ min-height:48px; border-radius:10px }

  .summary-chips{ gap:6px; overflow:auto; padding-bottom:2px }
  .summary-chips .chip{
    border:0; background:rgba(255,255,255,.14); color:#fff; font-size:.78rem;
    padding:6px 10px; border-radius:999px; white-space:nowrap
  }

  .time-option{ min-height:48px; font-size:15px }
}

/* Modal (addons) */
.modal-wrap{ position:fixed; inset:0; display:none; z-index:1200 }
.modal-wrap[aria-hidden="false"]{ display:block }
.modal-backdrop{
  position:absolute; inset:0; background:rgba(0,0,0,.45); backdrop-filter:blur(2px);
}
.modal-sheet{
  position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
  width:min(92vw,520px); background:#fff; color:#0B2630; border-radius:16px; box-shadow:0 20px 60px rgba(11,38,48,.28);
  padding:16px;
}
.modal-title{ font-weight:800; color:#224652; margin:0 0 10px }
.modal-body{ display:flex; flex-wrap:wrap; gap:8px; max-height:56vh; overflow:auto; }
.modal-actions{ display:flex; gap:8px; justify-content:space-between; margin-top:12px }
.modal-actions .btn{ min-height:44px; border-radius:10px; font-weight:800 }
.modal-actions .btn.secondary{ background:#fff; color:#0B2630; border:1px solid var(--border-300) }
.modal-actions .btn.primary{ background:var(--brand-600); color:#fff; border:1px solid var(--brand-600) }
  </style>
</head>
<body>
  <div id="toastWrap" style="position:fixed;top:10px;left:50%;transform:translateX(-50%);z-index:1050;display:flex;flex-direction:column;gap:8px" aria-live="assertive" aria-atomic="true"></div>

  <!-- ===== Header ===== -->
  <header id="siteHeader">
    <div class="header-inner">
      <div class="brand">
        <img id="brandLogo" alt="Nahl Time"
             src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/NahlTimeProFrom/NahlTime%20Logo%20Design%20(2).png"
             onerror="handleLogoError(this)" decoding="async"/>
      </div>

      <div class="header-right" style="flex:1">
        <div class="mini-progress" aria-hidden="true">
          <div class="bar"><span id="miniBarFill" style="width:0%"></span></div>
          <div class="step" id="miniStepTitle">الترحيب</div>
        </div>
        <div id="summaryChips" class="summary-chips" aria-live="polite"></div>
      </div>
    </div>
  </header>

  <!-- ===== Main / Stages ===== -->
  <main>
    <div id="app">
      <div class="stage">

        <!-- 1) Welcome -->
        <section id="page1" class="page active" aria-label="الترحيب">
          <h1>✨ غسيل بدون طوابير</h1>

          <div class="card text-center" style="max-width:860px">
            <p class="mb-0" style="color:#224652">ابدأ — الخطوة التالية لاختيار المنطقة والخدمة</p>
          </div>
        </section>

        <!-- 2) Service & Location -->
        <section id="page2" class="page" aria-label="اختيار المنطقة والخدمة">
          <h1>وين تحب نجيك؟</h1>

          <div class="card position-relative" id="servicesCard">
            <!-- Legacy selects (kept for accessibility) -->
            <div id="legacySelects">
              <label class="form-label" for="area">اختيار المنطقة</label>
              <select id="area" style="width:100%"></select>
              <div class="field-error" id="err-area" role="alert">يرجى اختيار المنطقة</div>

              <div class="row g-3 mt-3">
                <div class="col-12 col-md-6">
                  <label class="form-label" for="serviceCat">التصنيف</label>
                  <select id="serviceCat" style="width:100%"></select>
                  <div class="field-error" id="err-serviceCat" role="alert">يرجى اختيار التصنيف</div>
                </div>
                <div class="col-12 col-md-6">
                  <label class="form-label" for="service">الخدمة</label>
                  <select id="service" style="width:100%"></select>
                  <div class="field-error" id="err-service" role="alert">يرجى اختيار الخدمة</div>
                </div>
                <div class="col-12">
                  <label class="form-label" for="serviceCount">عدد السيارات</label>
                  <select id="serviceCount" class="form-select">
                    <option value="1" selected>1</option><option value="2">2</option>
                    <option value="3">3</option><option value="4">4</option><option value="5">5</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Tabs + Cards -->
            <div id="srvTabs" class="visually-hidden" role="tablist" aria-label="التصنيفات"></div>
            <div id="srvCards" class="visually-hidden" role="list" aria-label="الخدمات"></div>

            <!-- Desktop addon chips (mobile uses popup) -->
            <div class="addon-wrap d-none d-md-block">
              <div class="addon-title"><i class="fa-solid fa-plus"></i> خدمات إضافية (اختياري)</div>
              <div id="addonChips" class="addon-chips" role="group" aria-label="خدمات إضافية"></div>
            </div>

            <!-- Service description pane -->
            <div id="serviceDesc" class="service-desc" style="display:none">
              <div class="title"><i class="fa-regular fa-file-lines"></i> وصف الخدمة</div>
              <div id="serviceDescBody" class="body"></div>
            </div>

            <div id="servicesLoading" class="load-overlay" aria-hidden="true">
              <div class="spinner-border text-info" role="status" aria-hidden="true"></div>
              <strong>جاري تحميل الخدمات…</strong>
            </div>
          </div>
        </section>

        <!-- 3) Time -->
        <section id="page3" class="page" aria-label="اختيار الموعد">
          <h1>متى تحب نجيك؟</h1>
          <div class="card position-relative" id="timeCard">
            <div class="row g-3">
              <div class="col-12 col-md-5">
                <label class="form-label" for="date">التاريخ</label>
                <input id="date" type="date" class="form-control" aria-describedby="err-date"/>
                <div class="field-error" id="err-date" role="alert">يرجى اختيار تاريخ صحيح</div>
              </div>
            </div>

            <div class="time-toolbar mt-3">
              <div>
                <label class="form-label" for="timeFilter">فلترة الوقت</label>
                <select id="timeFilter" class="form-select">
                  <option value="all" selected>كل الأوقات المتاحة</option>
                  <option value="morning">الصباح (06:00–11:00)</option>
                  <option value="afternoon">الظهيرة (11:00–16:00)</option>
                  <option value="evening">المساء (16:00–21:00)</option>
                  <option value="night">ليلًا (21:00–23:59)</option>
                </select>
              </div>
            </div>

            <div class="position-relative mt-3">
              <div id="time-container" class="time-grid" role="radiogroup" aria-label="اختيار الوقت"></div>
              <div id="timeLoading" class="load-overlay">
                <div class="spinner-border text-info" role="status" aria-hidden="true"></div>
                <strong>جاري جلب المواعيد…</strong>
              </div>
            </div>
          </div>
        </section>

        <!-- 4) Contact -->
        <section id="page4" class="page" aria-label="معلومات الاتصال">
          <h1>معلومات الاتصال</h1>
          <div class="card">
            <div class="row g-3">
              <div class="col-12 col-md-6">
                <label for="name" class="form-label">الاسم</label>
                <input id="name" type="text" class="form-control" placeholder="الاسم كما سيظهر في الفاتورة" autocomplete="name" aria-describedby="err-name"/>
                <div class="field-error" id="err-name" role="alert">يرجى إدخال الاسم</div>
              </div>
              <div class="col-12 col-md-6">
                <label for="mobile" class="form-label">رقم الجوال</label>
                <input id="mobile" type="tel" class="form-control" placeholder="رقم التواصل — مثال 5XXXXXXXX" autocomplete="tel" aria-describedby="err-mobile"/>
                <div class="field-error" id="err-mobile" role="alert">يفضل إدخال رقم صحيح لتأكيد الحجز عبر واتساب</div>
              </div>
            </div>
          </div>

          <h1>معلومات المركبة</h1>
          <div class="card">
            <div class="row g-3">
              <div class="col-12 col-md-4">
                <label class="form-label" for="carBrand">ماركة السيارة 🚘</label>
                <select id="carBrand" style="width:100%"></select>
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label" for="carName">اسم السيارة</label>
                <input id="carName" type="text" class="form-control" placeholder="الموديل/الفئة — مثال: S-Class، LX 570" autocomplete="off"/>
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label" for="plateNumber">رقم اللوحة (اختياري)</label>
                <input id="plateNumber" type="text" inputmode="numeric" class="form-control" placeholder="أرقام اللوحة — اختياري" autocomplete="off"/>
                <small id="plateHelp" class="text-muted d-block mt-1" style="opacity:.9">اختياري — يساعد فريقنا على التعرف على مركبتك بسرعة</small>
                <div class="field-error" id="err-plate" style="display:none"></div>
              </div>
              <input id="locationDescription" type="text" hidden/>
            </div>
          </div>
        </section>

        <!-- 5) Payment -->
        <section id="page5" class="page" aria-label="طريقة الدفع">
          <h1>طريقة الدفع</h1>
          <div class="pay-grid" role="radiogroup" aria-label="طريقة الدفع" id="payGroup">
            <label class="pay-card" tabindex="0" role="radio" aria-checked="false">
              <input type="radio" name="payingMethod" value="stc pay" class="visually-hidden"/>
              <img src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/STC%20PAY%20LOGO.png" alt="STC Pay" loading="lazy" decoding="async">
            </label>
            <label class="pay-card" tabindex="-1" role="radio" aria-checked="false">
              <input type="radio" name="payingMethod" value="cash" class="visually-hidden"/>
              <strong>كاش</strong>
            </label>
            <label class="pay-card" style="grid-column:1/-1" tabindex="-1" role="radio" aria-checked="false">
              <input type="radio" name="payingMethod" value="mada" class="visually-hidden"/>
              <img src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/MADA%20LOGO.png" alt="Mada" loading="lazy" decoding="async">
            </label>
          </div>
          <div class="field-error" id="err-pay" style="text-align:center" role="alert">يرجى اختيار طريقة الدفع</div>
          <small class="d-block text-center text-muted mt-2">مدفوعات آمنة — لا رسوم خفية</small>
        </section>

        <!-- 6) Map -->
        <section id="page6" class="page" aria-label="اختيار الموقع">
          <h1>الموقع على خريطة قوقل</h1>
          <div class="card">
            <div class="map-search">
              <input id="mapSearch" class="form-control" type="text" placeholder="ابحث عن برج، حي، أو عنوان داخل السعودية"/>
              <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
            </div>
            <div id="googleMap" aria-describedby="err-map"></div>
          </div>
          <div class="card text-center">
            <button id="show-my-location" class="btn btn-outline-primary" type="button">إظهار موقعي</button>
          </div>
          <small id="mapHint" class="text-muted d-block mt-2" style="text-align:center">اضغط على الخريطة أو اسحب العلامة لتحديد موقعك</small>
          <div class="field-error" id="err-map" style="text-align:center" role="alert">الرجاء تحديد الموقع على الخريطة</div>
        </section>

        <!-- 7) Done -->
        <section id="page7" class="page" aria-label="تم الحجز">
          <h1>شكراً لكم 🌟</h1>
          <div class="card text-center" style="max-width:720px">
            <p class="mb-3" style="color:#224652">تم استلام طلبكم، وسنؤكد الموعد على واتساب قريبًا.</p>

            <div id="thanks-summary" class="text-start mx-auto" style="max-width:520px">
              <div class="d-flex justify-content-between py-2 border-bottom"><span>المنطقة</span><strong id="ts-area">—</strong></div>
              <div class="d-flex justify-content-between py-2 border-bottom"><span>الخدمة</span><strong id="ts-service">—</strong></div>
              <div class="d-flex justify-content-between py-2 border-bottom"><span>الموعد</span><strong id="ts-dt">—</strong></div>
              <div class="d-flex justify-content-between py-2"><span>طريقة الدفع</span><strong id="ts-pay">—</strong></div>
            </div>

            <div class="d-flex gap-2 justify-content-center mt-3 flex-wrap">
              <a id="ts-whatsapp" class="btn btn-success" target="_blank" rel="noopener"><i class="fa-brands fa-whatsapp"></i> مشاركة عبر واتساب</a>
              <button id="rebook" class="btn btn-primary" type="button" style="min-height:52px;font-weight:800;border-radius:12px;padding:12px 18px">🔁 احجز نفس الخدمة</button>
            </div>
          </div>
        </section>

      </div>
    </div>
  </main>

  <!-- ===== Footer: Mini Cart + CTA ===== -->
  <footer id="siteFooter" class="sticky-nav" aria-label="التنقل بين الخطوات">
    <div class="footer-inner">
      <!-- Mini cart lives here -->
      <div id="footer-cart" class="footer-cart" aria-live="polite">
        <div class="fc-line">
          <span class="fc-title" id="fc-title">السلة — لم يتم اختيار خدمة</span>
          <span class="fc-total" id="fc-total">—</span>
        </div>
        <div class="fc-sub" id="fc-sub">اختر خدمة ثم أكمل الخطوات</div>
      </div>

      <div class="footer-actions" style="display:flex; gap:10px; align-items:center">
        <button id="footer-prev" type="button" class="btn-footer hidden">السابق</button>
        <button id="footer-next" type="button" class="btn-footer primary disabled" disabled>ابدأ الآن</button>

        <div id="footer-wait" class="">
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          <span>يتم إرسال الطلب…</span>
        </div>
      </div>
    </div>
  </footer>

  <!-- ===== Addons Popup (small window) ===== -->
  <div id="addonModal" class="modal-wrap" aria-hidden="true">
    <div class="modal-backdrop" data-close="1"></div>
    <div class="modal-sheet" role="dialog" aria-modal="true" aria-labelledby="addonTitle">
      <h3 id="addonTitle" class="modal-title"><i class="fa-solid fa-plus"></i> اختر خدمات إضافية (اختياري)</h3>
      <div id="addonList" class="modal-body"></div>
      <div class="modal-actions">
        <button type="button" id="addonCancel" class="btn secondary">لا شكرًا</button>
        <button type="button" id="addonApply" class="btn primary">تأكيد الإضافات</button>
      </div>
    </div>
  </div>

  <!-- libs -->
  <script src="https://code.jquery.com/jquery-3.6.3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/intlTelInputWithUtils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
/* =========================================================
   Config + Flags (NO shorthand/NO spread inside objects)
   ========================================================= */
var USE_TABS_AND_CARDS = true;
var SOFT_PHONE_VALIDATION = true;

// IDs & URLs
var APP_ID = '21eddbf5-efe5-4a5d-9134-b581717b17ff';

// Platform (kept for appointments/time)
var defaultLink2 = 'https://nahl-platform.vercel.app/api/app/AM/general/' + APP_ID + '/form';
var RESERVE_URL_PRIMARY  = defaultLink2 + '/reserveAppointment';
var RESERVE_URL_FALLBACK = defaultLink2.replace(/\/form\/?$/,'') + '/reserveAppointment';

// GAS Web App (update to your deployment URL)
var GAS_BASE_URL = 'https://script.google.com/macros/s/AKfycbzJeAv7NCQuxQGEcMa-P5mzuZCWFVaV88DeRCwY5d-Zhg4ckZsfw0_uwV8qhEGbDke0/exec';

/* =========================================================
   Utilities (compat safe)
   ========================================================= */
function handleLogoError(img){
  var fallbacks = [
    "https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20%20%20Soap/spong&Soap%20-%20logo.png",
    "https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20%26%20Soap/spong%26Soap%20-%20logo.png",
    "https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20%26%20Soap/logo.png",
    "https://dummyimage.com/180x54/027A93/ffffff.png&text=Sponge+%26+Soap"
  ];
  var i = Number(img.dataset.fidx||0);
  if (i < fallbacks.length){ img.dataset.fidx = String(i+1); img.src = fallbacks[i]; }
  else { img.style.display = 'none'; }
}

function showToast(type, msg){
  var wrap=document.getElementById('toastWrap');
  var div=document.createElement('div');
  div.style.minWidth='260px'; div.style.color='#fff'; div.style.padding='10px 14px';
  div.style.borderRadius='10px'; div.style.boxShadow='0 10px 28px rgba(11,38,48,.14)';
  div.style.background = type==='error' ? '#dc2626' : type==='success' ? '#16a34a' : '#0284c7';
  div.setAttribute('role','status');
  div.textContent=msg||'';
  wrap.appendChild(div);
  setTimeout(function(){ div.style.opacity='0'; div.style.transform='translateY(-6px)'; setTimeout(function(){div.remove();}, 180); }, 2400);
}

function escapeHTML(s){
  return String(s || '').replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); });
}

function currencyFormat(n){
  try{
    return new Intl.NumberFormat('ar-SA',{style:'currency',currency:'SAR', maximumFractionDigits:2}).format(n);
  }catch(_){ return String(n) + ' ر.س'; }
}

function parseNumberFromPrice(val){
  if(val==null) return NaN;
  var n = Number(String(val).replace(/[^\d.]/g,''));
  return isFinite(n) ? n : NaN;
}

/* =========================================================
   API – GAS (NO spread/NO shorthand)
   ========================================================= */
async function api(route, params){
  var obj = Object.assign({ route: route }, params || {});
  var qs  = new URLSearchParams(obj);
  var url = GAS_BASE_URL + '?' + qs.toString();
  var res = await fetch(url, { headers: { 'Accept':'application/json' }, method:'GET', cache:'no-store', mode:'cors' });
  if(!res.ok) throw new Error('Network');
  return res.json();
}

/* =========================================================
   Platform calls – for appointments + reservation (unchanged)
   ========================================================= */
var controllers=[];
async function callContent2(path, cb, abortable, retries){
  if(typeof retries!=='number') retries=3;
  var signal = null;
  if(abortable){
    controllers.forEach(function(pair){ try{pair[0].abort();}catch(_){}}); controllers=[];
    var controller=new AbortController(); signal=controller.signal; controllers.push([controller,signal]);
  }
  try{
    await new Promise(function(r){ setTimeout(r,200); });
    var res=await fetch(defaultLink2+path,{method:'GET',redirect:'follow',cache:'no-store',signal:signal});
    if(!res.ok){ if(retries>0) return callContent2(path,cb,abortable,retries-1); throw new Error('Network'); }
    cb(await res.json());
  }catch(e){
    if(String(e).indexOf('AbortError')===-1 && retries>0){
      setTimeout(function(){ callContent2(path,cb,abortable,retries-1); },600);
    }
  }
}
async function postReservationTry(url, payload, contentType){
  if(!contentType) contentType='text/plain;charset=UTF-8';
  try{
    var res=await fetch(url,{method:'POST',mode:'cors',cache:'no-store',credentials:'omit',referrerPolicy:'no-referrer',headers:{'Content-Type':contentType,'Accept':'application/json'},body:JSON.stringify(payload)});
    var raw=await res.text(); var data=null; try{ data=JSON.parse(raw);}catch(_){}
    return {ok:res.ok,status:res.status,data:data,raw:raw};
  }catch(err){ return {ok:false,status:0,error:String(err)}; }
}
async function postReservation(payload){
  var r=await postReservationTry(RESERVE_URL_PRIMARY,payload,'text/plain;charset=UTF-8');
  if(!r.ok && (r.status===415||r.status===406||r.status===0)) r=await postReservationTry(RESERVE_URL_PRIMARY,payload,'application/json;charset=UTF-8');
  if(!r.ok && r.status===404) r=await postReservationTry(RESERVE_URL_FALLBACK,payload,'text/plain;charset=UTF-8');
  return r;
}

/* =========================================================
   STATE
   ========================================================= */
var DateTime = luxon.DateTime;
var orderedPages=["page1","page2","page3","page4","page5","page6","page7"];
var STEPS_LABELS=["الترحيب","الخدمة","الوقت","البيانات","الدفع","الموقع","تم"];
var NEXT_LABELS={ page1:'ابدأ الآن', page2:'عرض المواعيد', page3:'معلومات العميل', page4:'اختيار الدفع', page5:'تحديد الموقع', page6:'تأكيد الحجز' };

var PAGE_BACKGROUNDS={
  page1:"https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Nahl%20Time%20Headers/NahlBG-1.jpg",
  page2:"https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Nahl%20Time%20Headers/NahlBG-2.jpg",
  page3:"https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Nahl%20Time%20Headers/NahlBG-3.jpg",
  page4:"https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Nahl%20Time%20Headers/NahlBG-4.jpg",
  page5:"https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Nahl%20Time%20Headers/NahlBG-5.jpg",
  page6:"https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Nahl%20Time%20Headers/NahlBG-6.jpg",
  page7:"https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Nahl%20Time%20Headers/NahlBG-7.jpg"
};

var selectedTime=null, servicesCache=null, categoriesCache=null, itiPhone=null, positionUrl="";
var lastSelectedISO=""; var isSubmitting=false;
var currentTimeFilter='all';

var nForm={date:'',time:'',location:'',service:'',serviceCount:'1',serviceCat:'',customerM:'',customerN:'',paymentMethod:'',urlLocation:'',locationDescription:'', addons:[], locale:'ar'};

var activeCatId=null;
var selectedServiceId=null;
var syncingFromCards=false;

function setPageBackground(id){
  document.documentElement.style.setProperty('--page-bg', 'url("' + (PAGE_BACKGROUNDS[id]||PAGE_BACKGROUNDS.page1) + '")');
}

function showPage(idx){
  var cur=document.querySelector('.page.active');
  var next=document.getElementById(orderedPages[idx]); if(!next||cur===next) return;
  if(cur){ cur.classList.remove('active'); cur.classList.add('exit'); }
  next.style.display='flex';
  requestAnimationFrame(function(){ next.classList.add('active'); setTimeout(function(){ if(cur){cur.classList.remove('exit'); cur.style.display='none';} }, 240); });
  syncProgress(idx); setPageBackground(next.id); renderSummary(next.id); updateNextAvailability();
}

function getActiveIndex(){ var id=document.querySelector('.page.active')?document.querySelector('.page.active').id:null; return Math.max(0, orderedPages.indexOf(id)); }

function syncProgress(i){
  var pct=((i+1)/orderedPages.length)*100;
  document.getElementById('miniBarFill').style.width=pct+'%';
  document.getElementById('miniStepTitle').textContent=STEPS_LABELS[Math.min(i,STEPS_LABELS.length-1)];
  var prev=document.getElementById('footer-prev');
  var next=document.getElementById('footer-next');
  var wait=document.getElementById('footer-wait');
  var onThanks=(orderedPages[i]==='page7');
  prev.classList.toggle('hidden', i===0 || onThanks);
  next.classList.toggle('hidden', onThanks);
  wait.classList.remove('show');
  var id=orderedPages[i];
  if(!onThanks) next.textContent = NEXT_LABELS[id] || 'التالي';
}

function renderSummary(){
  var wrap=document.getElementById('summaryChips'); if(!wrap) return;
  var activeId=(document.querySelector('.page.active') && document.querySelector('.page.active').id) || 'page1';
  var STEP_GROUP_INDEX={page1:0,page2:1,page3:2,page4:3,page5:4,page6:5,page7:6};
  var currGroup=STEP_GROUP_INDEX[activeId] || 0;

  wrap.style.display = currGroup === 0 ? 'none' : 'flex';
  if(currGroup===0){ wrap.innerHTML=''; return; }

  var areaTxt=$('#area').find(':selected').text()||'';
  var srvTxt=$('#service').find(':selected').text()||'';
  var dt=nForm.date ? DateTime.fromISO(nForm.date).toFormat('d LLL yyyy') : '';
  var tm=nForm.time||'';
  var pay=(nForm.paymentMethod||'');
  var locOk=!!positionUrl;

  var chips=[
    {i:'fa-location-dot',t:'المنطقة',v:areaTxt,g:1, target:'page2'},
    {i:'fa-screwdriver-wrench',t:'الخدمة',v:srvTxt,g:1, target:'page2'},
    {i:'fa-clock',t:'الموعد',v:(dt&&tm)?(dt+' • '+tm):'',g:2, target:'page3'},
    {i:'fa-credit-card',t:'الدفع',v:(pay?pay.toUpperCase():''),g:4, target:'page5'},
    {i:'fa-map-pin',t:'الموقع',v:(locOk?'تم التحديد':''),g:5, target:'page6'}
  ];

  wrap.innerHTML='';
  for(var i=0;i<chips.length;i++){
    var c=chips[i]; if(!(c.v && c.g<=currGroup)) continue;
    var el=document.createElement('div');
    el.className='chip'+(c.g===currGroup?' current':'');
    el.setAttribute('data-target', c.target || '');
    el.innerHTML='<i class="fa-solid '+c.i+'"></i><span class="title">'+c.t+':</span><span class="value">'+escapeHTML(c.v)+'</span>';
    wrap.appendChild(el);
  }
}

function setLoadingTimes(on){ document.getElementById('timeLoading').classList.toggle('show', !!on); }
function setLoadingServices(on){ document.getElementById('servicesLoading').classList.toggle('show', !!on); }

/* Plate helpers */
function isSpecialPlate(num){
  if(!/^\d+$/.test(num) || num.length < 3) return false;
  var same=/^(\d)\1+$/.test(num);
  var asc=('01234567890123456789').indexOf(num)!==-1;
  var desc=('98765432109876543210').indexOf(num)!==-1;
  var pal=num===num.split('').reverse().join('');
  var pairRepeat=(num.length%2===0)&&/^(\d{2})\1+$/.test(num);
  return same||asc||desc||pal||pairRepeat;
}
function updatePlateHint(){
  var raw=($('#plateNumber').val()||'');
  var v=String(raw).replace(/\D/g,'');
  $('#plateNumber').val(v);
  var txt = v ? (isSpecialPlate(v) ? 'رقم مميز 👌 — ممتاز للتوثيق السريع.' : 'اختياري — يساعد فريقنا على التعرف على مركبتك.')
              : 'اختياري — يساعد فريقنا على التعرف على مركبتك';
  $('#plateHelp').text(txt);
  var pe=document.getElementById('err-plate'); if(pe) pe.style.display='none';
}

/* Time helpers */
function parseTimeToLuxon(raw){
  var t=DateTime.fromISO(String(raw||'').trim(),{setZone:true});
  if(!t.isValid) t=DateTime.fromFormat(String(raw||''),'HH:mm:ss',{setZone:true});
  if(!t.isValid) t=DateTime.fromFormat(String(raw||''),'H:mm a',{setZone:true});
  if(!t.isValid) t=DateTime.fromFormat(String(raw||''),'H:mm',{setZone:true});
  return t.isValid?t:null;
}

var dayTimes=[]; var timesLoaded=false;
function timeInMins(h, m){ return (h*60)+m; }
function passesFilter(mins){
  if(currentTimeFilter==='all') return true;
  if(currentTimeFilter==='morning')   return mins>=timeInMins(6,0)  && mins<timeInMins(11,0);
  if(currentTimeFilter==='afternoon') return mins>=timeInMins(11,0) && mins<timeInMins(16,0);
  if(currentTimeFilter==='evening')   return mins>=timeInMins(16,0) && mins<timeInMins(21,0);
  if(currentTimeFilter==='night')     return mins>=timeInMins(21,0) && mins<timeInMins(24,0);
  return true;
}

function normalizeAvailability(r){
  var s=String(r.TS_status||r.status||r.TS_appointment_status||'').toLowerCase();
  var f=(typeof r.isAvailable==='boolean')?r.isAvailable:undefined;
  var b=Number(r.TS_booked || r.booked); var c=Number(r.TS_capacity || r.capacity);
  var rem=Number(r.TS_remaining || r.remaining);
  if(!isFinite(rem)&&isFinite(c)&&isFinite(b)) rem=c-b;
  var open=f===true||['available','open','free','empty','vacant','canceled'].indexOf(s)!==-1||(isFinite(rem)?rem>0:(f!==false&&!s));
  return {looksOpen:open,remaining:rem};
}

function fetchTimesForSelectedDate(){
  var dateEl=document.getElementById('date');
  var timeContainer=document.getElementById('time-container');
  var loc=$('#area').val()||''; var srv=$('#service').val()||'';
  var selectedISO=(dateEl.value||DateTime.now().toFormat('yyyy-LL-dd')).trim();
  lastSelectedISO=selectedISO;

  if(!loc||!srv){
    timeContainer.innerHTML='<div style="grid-column:1/-1;justify-self:center" class="text-muted">اختر المنطقة والخدمة لعرض المواعيد</div>';
    window.selectedTime=null; selectedTime=null; updateNextAvailability(); return;
  }

  dateEl.disabled=true; setLoadingTimes(true);
  timeContainer.innerHTML='<div class="spinner-border text-info" role="status" style="grid-column:1/-1;justify-self:center;"></div>';

  var now=DateTime.now().setZone('Asia/Riyadh');
  var isToday=selectedISO===now.toISODate();

  var qs='/appointments?startDate='+encodeURIComponent(selectedISO)+'&location='+encodeURIComponent(loc)+'&service='+encodeURIComponent(srv)+'&onlyAvailable=1';
  callContent2(qs,function(res){
    var rows=(res && res.data && res.data.appointments) ? res.data.appointments : [];
    var filtered=rows.filter(function(r){
      var d=DateTime.fromISO(r.TS_appointment_date,{setZone:true}); if(!d.isValid||d.toISODate()!==selectedISO) return false;
      var t=parseTimeToLuxon(r.TS_appointment_time); if(!t) return false;
      var na=normalizeAvailability(r); if(!na.looksOpen) return false;
      if(isToday){ var slot=now.set({hour:t.hour,minute:t.minute,second:0}); if(slot<now.plus({minutes:5})) return false; }
      return true;
    });

    var list=filtered.map(function(r){
      var t=parseTimeToLuxon(r.TS_appointment_time);
      var mins = t.hour*60 + t.minute;
      return {label:t.toLocaleString(DateTime.TIME_SIMPLE), h:t.hour, m:t.minute, mins:mins};
    });

    var seen={};
    dayTimes=list.filter(function(x){ if(seen[x.mins]) return false; seen[x.mins]=1; return true; });
    timesLoaded=true;

    renderSelectedDateTimes(selectedISO);
    dateEl.disabled=false; setLoadingTimes(false);
  }, true);
}

function renderSelectedDateTimes(selectedISO){
  var timeContainer=document.getElementById('time-container');
  timeContainer.innerHTML='';

  if(!timesLoaded){
    timeContainer.innerHTML='<div class="spinner-border text-info" role="status" style="grid-column:1/-1;justify-self:center;"></div>';
    return;
  }

  var viewList = dayTimes.filter(function(x){return passesFilter(x.mins);} ).sort(function(a,b){ return a.mins - b.mins; });

  if(!viewList.length){
    timeContainer.innerHTML='<div style="grid-column:1/-1;justify-self:center" class="text-muted">لا توجد مواعيد ضمن الفلتر المحدد</div>';
    return;
  }

  var preselect = !selectedTime || !viewList.some(function(v){
    var d = DateTime.fromFormat((selectedTime && selectedTime.iso) || '','HH:mm'); 
    return (v.h*60+v.m) === (d.hour*60 + d.minute);
  });

  var firstBtn=null;
  viewList.forEach(function(t, idx){
    var btn=document.createElement('button');
    btn.type='button'; btn.className='time-option'; btn.setAttribute('role','radio'); btn.setAttribute('aria-checked','false'); btn.setAttribute('dir','ltr'); btn.textContent=t.label;
    btn.addEventListener('click',function(){
      var kids=[].slice.call(timeContainer.children); kids.forEach(function(el){ el.setAttribute('aria-checked','false'); });
      btn.setAttribute('aria-checked','true');
      var parsed=DateTime.fromObject({hour:t.h,minute:t.m});
      nForm.date=selectedISO; nForm.time=parsed.toFormat('HH:mm');
      window.selectedTime={ui:t.label,iso:nForm.time}; selectedTime=window.selectedTime;
      renderSummary('page3'); updateNextAvailability();
    });
    timeContainer.appendChild(btn);
    if(idx===0) firstBtn=btn;
  });

  if(preselect && firstBtn){
    var t=viewList[0];
    firstBtn.setAttribute('aria-checked','true');
    var parsed=DateTime.fromObject({hour:t.h,minute:t.m});
    nForm.date=selectedISO; nForm.time=parsed.toFormat('HH:mm');
    window.selectedTime={ui:t.label,iso:nForm.time}; selectedTime=window.selectedTime;
    renderSummary('page3'); updateNextAvailability();
  }
}

/* =========================================================
   Services Cards (from GAS only)
   ========================================================= */
function buildBadges(s){
  var out=[];
  if(s.TS_badges){
    String(s.TS_badges).split(',').map(function(b){return b.trim();}).filter(Boolean).forEach(function(b){ out.push({text:b, popular:false}); });
  }
  if(String(s.TS_popular||'').toLowerCase()==='true'){ out.unshift({text:'الأكثر طلبًا', popular:true}); }
  return out;
}

function serviceCardTemplate(s, selected){
  var id=String(s.TS_service_id);
  var title=s.TS_service_arabic_name || ('خدمة '+id);
  var priceText = s.TS_price ? String(s.TS_price) : '';
  var duration = s.TS_duration ? String(s.TS_duration) : '';
  var badges = buildBadges(s);
  var thumb = s.TS_thumb_url || '';
  var desc = String(s.TS_service_description_ar || s.TS_short_desc || '').trim();

  var metaHTML = '';
  if(priceText){ metaHTML += '<span class="chip price"><i class="fa-solid fa-tag"></i> '+escapeHTML(priceText)+'</span>'; }
  if(duration){ metaHTML += '<span class="chip"><i class="fa-regular fa-clock"></i> '+escapeHTML(duration)+'</span>'; }

  var badgesHTML = badges.map(function(b){
    return '<span class="s-badge '+(b.popular?'popular':'')+'"><i class="fa-solid fa-star'+(b.popular?'':'-half-stroke')+'"></i> '+escapeHTML(b.text)+'</span>';
  }).join('');

  return ''+
    '<div class="srv-card '+(selected?'selected':'')+'" role="listitem" aria-selected="'+(selected?'true':'false')+'" data-id="'+id+'" tabindex="-1" title="'+escapeHTML(title)+'">'+
      '<div class="srv-thumb" style="'+(thumb ? ('background-image:url(\''+thumb+'\')') : '')+'"></div>'+
      '<div class="srv-body">'+
        '<div class="srv-title">'+escapeHTML(title)+'</div>'+
        '<div class="srv-meta">'+metaHTML+'</div>'+
        (desc?('<div class="srv-desc">'+escapeHTML(desc)+'</div>'):'')+
        '<div class="srv-badges">'+badgesHTML+'</div>'+
      '</div>'+
      '<div class="srv-actions">'+
        '<button class="btn-add" type="button">'+(selected?'تم الاختيار':'إضافة إلى السلة')+'</button>'+
        (selected?'<button class="btn-remove" type="button">إزالة</button>':'')+
      '</div>'+
    '</div>';
}

/* Footer mini-cart */
function updateFooterCartSummary(){
  var titleEl = document.getElementById('fc-title');
  var totalEl = document.getElementById('fc-total');
  var subEl   = document.getElementById('fc-sub');

  var cntSel = document.getElementById('serviceCount');
  var qty = Number((cntSel && cntSel.value) || 1);
  var svc = (Array.isArray(servicesCache)?servicesCache:[]).find(function(s){ return String(s.TS_service_id)===String(selectedServiceId); });

  if(!svc){
    titleEl.textContent = 'السلة — لم يتم اختيار خدمة';
    totalEl.textContent = '—';
    subEl.textContent = 'اختر خدمة ثم أكمل الخطوات';
    return;
  }

  var title = svc.TS_service_arabic_name || ('خدمة '+selectedServiceId);
  var unitPrice = parseNumberFromPrice(svc && svc.TS_price);
  var hasPrice = isFinite(unitPrice);
  var total = hasPrice ? unitPrice * qty : NaN;

  titleEl.textContent = title;
  totalEl.textContent = hasPrice ? currencyFormat(total) : 'سيتم الإبلاغ بالسعر';
  var addonsTxt = (nForm.addons && nForm.addons.length) ? (' • إضافات: ' + nForm.addons.join('، ')) : '';
  subEl.textContent = 'الكمية × ' + qty + addonsTxt;
}

/* Cart summary (side) – purely for logic; footer is the primary surface */
function renderCartSummary(){
  updateFooterCartSummary();
}

/* Addons popup */
function openAddonModal(){
  var modal = document.getElementById('addonModal');
  var list  = document.getElementById('addonList');
  if(!modal || !list) return;

  // Build chips from fetched options
  list.innerHTML = '';
  var options = (nForm._addonsOptions || []);
  if(!options.length){ list.innerHTML = '<span class="text-muted">لا توجد خدمات إضافية حالياً</span>'; }

  options.forEach(function(label){
    var b = document.createElement('button');
    b.type='button';
    b.className='addon-chip';
    var pressed = (nForm.addons.indexOf(label)!==-1);
    b.setAttribute('aria-pressed', pressed?'true':'false');
    b.innerHTML = '<i class="fa-solid fa-circle-plus"></i><span>'+escapeHTML(label)+'</span>';
    b.onclick = function(){
      var on = b.getAttribute('aria-pressed')==='true';
      b.setAttribute('aria-pressed', on?'false':'true');
    };
    list.appendChild(b);
  });

  modal.setAttribute('aria-hidden','false');

  var apply = document.getElementById('addonApply');
  var cancel= document.getElementById('addonCancel');
  var close = function(){ modal.setAttribute('aria-hidden','true'); };

  apply.onclick = function(){
    var chosen = [].slice.call(list.querySelectorAll('.addon-chip[aria-pressed="true"]')).map(function(x){ return x.textContent.trim(); });
    nForm.addons = chosen;
    renderCartSummary();
    close();
  };
  cancel.onclick = close;
  var bdrop = modal.querySelector('.modal-backdrop');
  if(bdrop){ bdrop.addEventListener('click', close); }
}

/* =========================================================
   GAS-backed features
   ========================================================= */
function showServiceDescSkeleton(){
  var card = document.getElementById('serviceDesc');
  var body = document.getElementById('serviceDescBody');
  if(!card || !body) return;
  card.style.display = 'block';
  body.innerHTML = '<div class="skeleton" style="width:90%"></div><div class="skeleton" style="width:70%"></div><div class="skeleton" style="width:82%"></div>';
}
function clearServiceDescriptionUI(){
  var card = document.getElementById('serviceDesc');
  var body = document.getElementById('serviceDescBody');
  if(!card || !body) return;
  body.innerHTML = '';
  card.style.display = 'none';
}
async function fetchServiceDescription(serviceId, serviceName){
  if(!GAS_BASE_URL || GAS_BASE_URL==='YOUR_GAS_WEBAPP_URL'){ clearServiceDescriptionUI(); return; }
  showServiceDescSkeleton();
  try{
    var params = new URLSearchParams();
    params.set('route','serviceDescription');
    params.set('appId', APP_ID);
    if (serviceId) params.set('serviceId', serviceId);
    if (serviceName) params.set('serviceName', serviceName);
    var url = GAS_BASE_URL + '?' + params.toString();

    var res = await fetch(url, { method:'GET', mode:'cors', cache:'no-store', headers:{ 'Accept':'application/json' }});
    var data = null; try{ data=await res.json(); }catch(_){}
    var card = document.getElementById('serviceDesc');
    var body = document.getElementById('serviceDescBody');
    if(!card || !body) return;

    if(res.ok && data && data.success && data.data){
      var desc = data.data.description || '—';
      body.innerHTML = '<p style="margin:0; white-space:pre-wrap">'+escapeHTML(desc)+'</p>';
      card.style.display='block';
    } else {
      body.innerHTML = '<span class="text-muted">لا يوجد وصف متاح لهذه الخدمة</span>';
      card.style.display='block';
    }
  }catch(_e){
    var card = document.getElementById('serviceDesc');
    var body = document.getElementById('serviceDescBody');
    if(card && body){
      body.innerHTML = '<span class="text-muted">تعذر تحميل وصف الخدمة حالياً</span>';
      card.style.display='block';
    }
  }
}

async function fetchAdditionalServicesAndRender(){
  var wrap = document.getElementById('addonChips');
  if(!wrap) return;
  wrap.innerHTML = '<span class="text-muted">...تحميل الإضافات</span>';
  try{
    var data = await api('additionalServices', { appId: APP_ID });
    var list = (data && data.success && Array.isArray(data.data)) ? data.data : [];
    var options = list.map(function(x){ return String((x && x.label) || '').trim(); }).filter(Boolean);
    if(!options.length){ wrap.innerHTML='<span class="text-muted">لا توجد خدمات إضافية</span>'; return; }
    // Desktop chips
    wrap.innerHTML='';
    options.forEach(function(label){
      var btn=document.createElement('button');
      btn.type='button'; btn.className='addon-chip';
      btn.setAttribute('aria-pressed', nForm.addons.indexOf(label)!==-1 ? 'true' : 'false');
      btn.setAttribute('data-value', label);
      btn.innerHTML='<i class="fa-solid fa-circle-plus"></i><span>'+escapeHTML(label)+'</span>';
      btn.addEventListener('click', function(){
        var val = String(btn.getAttribute('data-value')||'').trim();
        var selected = (nForm.addons.indexOf(val)!==-1);
        if(selected){
          nForm.addons = nForm.addons.filter(function(x){return x!==val;});
          btn.setAttribute('aria-pressed','false');
        }else{
          nForm.addons = nForm.addons.concat([val]);
          btn.setAttribute('aria-pressed','true');
        }
        renderCartSummary(); updateFooterCartSummary(); updateNextAvailability();
      });
      wrap.appendChild(btn);
    });
    // Keep for popup
    nForm._addonsOptions = options.slice();
  }catch(_){
    wrap.innerHTML='<span class="text-muted">تعذر تحميل الخدمات الإضافية</span>';
  }
}

/* Tabs + Cards rendering */
function enableCartUI(on){
  var legacy = document.getElementById('legacySelects');
  var tabs = document.getElementById('srvTabs');
  var cards = document.getElementById('srvCards');
  if(on){
    legacy.classList.add('visually-hidden');
    tabs.classList.remove('visually-hidden');
    cards.classList.remove('visually-hidden');
  }else{
    legacy.classList.remove('visually-hidden');
    tabs.classList.add('visually-hidden');
    cards.classList.add('visually-hidden');
  }
}

function renderCategoryTabs(cats){
  var wrap=document.getElementById('srvTabs'); if(!wrap) return;
  wrap.innerHTML='';
  if(!Array.isArray(cats) || !cats.length){ wrap.innerHTML='<span class="text-muted">لا توجد تصنيفات</span>'; return; }

  cats.forEach(function(c,idx){
    var btn=document.createElement('button');
    btn.type='button';
    btn.className='srv-tab';
    btn.setAttribute('role','tab');
    btn.setAttribute('aria-selected', String(c.TS_category_id)===String(activeCatId) ? 'true' : 'false');
    btn.dataset.id=c.TS_category_id;
    btn.textContent=c.TS_category_arabic_name || ('تصنيف '+c.TS_category_id);
    btn.addEventListener('click', function(){
      activeCatId=String(c.TS_category_id);
      renderCategoryTabs(cats);
      renderServiceCards();
    });
    wrap.appendChild(btn);
    if(activeCatId==null && idx===0){ activeCatId=String(c.TS_category_id); }
  });
}

function renderServiceCards(){
  var grid=document.getElementById('srvCards'); if(!grid) return;
  grid.innerHTML='';
  if(!Array.isArray(servicesCache) || !servicesCache.length){ grid.innerHTML='<div class="text-muted">لا توجد خدمات</div>'; return; }
  var list=servicesCache.filter(function(s){ return String(s.TS_category_id)===String(activeCatId); });
  if(!list.length){ grid.innerHTML='<div class="text-muted">لا توجد خدمات ضمن هذا التصنيف</div>'; return; }

  grid.innerHTML = list.map(function(s){ return serviceCardTemplate(s, String(selectedServiceId)===String(s.TS_service_id)); }).join('');

  [].slice.call(grid.querySelectorAll('.srv-card')).forEach(function(card){
    var id = card.dataset.id;
    var svc = (servicesCache||[]).find(function(x){ return String(x.TS_service_id)===String(id); });
    var title = (svc && (svc.TS_service_arabic_name || ('خدمة '+id))) || ('خدمة '+id);

    var addBtn = card.querySelector('.btn-add');
    if(addBtn){
      addBtn.addEventListener('click', function(){
        selectedServiceId=id;
        syncingFromCards=true;
        $('#serviceCat').val(activeCatId).trigger('change.select2');
        $('#service').val(id).trigger('change.select2');
        nForm.serviceCat=String(activeCatId);
        nForm.service=String(id);
        syncingFromCards=false;

        fetchServiceDescription(id, title);
        renderSummary('page2'); renderServiceCards(); renderCartSummary(); updateNextAvailability();

        // mobile hint + popup
        addBtn.textContent='✓ تمت الإضافة';
        addBtn.classList.add('is-selected');
        openAddonModal();
      });
    }

    var rm=card.querySelector('.btn-remove');
    if(rm){
      rm.addEventListener('click', function(){
        if(selectedServiceId===id){
          selectedServiceId=null; nForm.service='';
          $('#service').val(null).trigger('change.select2');
          clearServiceDescriptionUI();
          renderServiceCards(); renderCartSummary(); renderSummary('page2'); updateNextAvailability();
        }
      });
    }
  });
}

/* =========================================================
   Init + Wiring
   ========================================================= */
function updateNextAvailability(){
  var i=getActiveIndex(); var nextBtn=document.getElementById('footer-next'); var enable=true;
  if(i===0){ enable=true; }
  else if(i===1){ enable=!!($('#area').val()&&$('#service').val()); }
  else if(i===2){ enable=!!selectedTime; }
  else if(i===3){ var nameOk=($('#name').val()||'').trim().length>0; enable=nameOk; }
  else if(i===4){ enable=!!(document.querySelector('#payGroup input:checked') || nForm.paymentMethod); }
  else if(i===5){ enable=!!positionUrl; }
  nextBtn.disabled=!enable; nextBtn.classList.toggle('disabled',!enable);
}

function buildPayload(){
  var loc=$('#area').val(); var svcC=$('#serviceCat').val(); var svc=$('#service').val(); var cnt=$('#serviceCount').val()||'1';
  var phoneDigits= itiPhone && itiPhone.getNumber ? itiPhone.getNumber().replace(/^\+/, '') : '';
  return {
    date:nForm.date, time:nForm.time,
    location:(loc!==null&&loc!=='')?String(loc):undefined,
    service:(svc!==null&&svc!=='')?String(svc):undefined,
    serviceCount:String(cnt),
    serviceCat:(svcC!==null&&svcC!=='')?String(svcC):undefined,
    customerM:phoneDigits, customerN:nForm.customerN,
    paymentMethod:(nForm.paymentMethod||'').toLowerCase(),
    urlLocation:nForm.urlLocation, locationDescription:nForm.locationDescription||'', locale:'ar'
  };
}

function installResizeObservers(){
  var header=document.getElementById('siteHeader');
  var footer=document.getElementById('siteFooter');
  if(typeof ResizeObserver==='function'){
    var ro=new ResizeObserver(function(entries){
      entries.forEach(function(entry){
        if(entry.target.id==='siteHeader') document.documentElement.style.setProperty('--header-h', entry.contentRect.height+'px');
        if(entry.target.id==='siteFooter') document.documentElement.style.setProperty('--footer-h', entry.contentRect.height+'px');
      });
    });
    if(header) ro.observe(header); if(footer) ro.observe(footer);
  }
}

/* Map settings from GAS */
var map, marker, autocomplete, allowedPoly;
var SA_BOUNDS = { north: 25.0500, south: 24.3000, west: 46.2000, east: 47.1000 };
var ALLOWED_POLY_PATH = [
  {lat:24.9550, lng:46.4630},{lat:25.0000, lng:46.6400},{lat:24.9900, lng:46.8200},
  {lat:24.9000, lng:46.9500},{lat:24.7200, lng:46.9800},{lat:24.5600, lng:46.8800},
  {lat:24.4700, lng:46.7200},{lat:24.4600, lng:46.5400},{lat:24.5600, lng:46.4200},
  {lat:24.7400, lng:46.3900}
];
async function loadMapSettingsFromGAS(){
  try{
    var data = await api('mapSettings', { appId: APP_ID });
    if(data && data.success && data.data){
      var ms=data.data;
      if(ms.SA_BOUNDS && isFinite(ms.SA_BOUNDS.north) && isFinite(ms.SA_BOUNDS.south) && isFinite(ms.SA_BOUNDS.west) && isFinite(ms.SA_BOUNDS.east)){
        SA_BOUNDS = { north:Number(ms.SA_BOUNDS.north), south:Number(ms.SA_BOUNDS.south), west:Number(ms.SA_BOUNDS.west), east:Number(ms.SA_BOUNDS.east) };
      }
      if(Array.isArray(ms.ALLOWED_POLY_PATH) && ms.ALLOWED_POLY_PATH.length){
        ALLOWED_POLY_PATH = ms.ALLOWED_POLY_PATH.map(function(p){ return {lat:Number(p.lat), lng:Number(p.lng)}; }).filter(function(p){return isFinite(p.lat)&&isFinite(p.lng);});
      }
    }
  }catch(_){}
}

function initMap(){
  // ensure settings before initializing
  loadMapSettingsFromGAS().then(function(){
    var def={lat:24.7136,lng:46.6753};
    map=new google.maps.Map(document.getElementById('googleMap'),{
      center:def, zoom:12, disableDoubleClickZoom:true, mapTypeControl:false, fullscreenControl:true,
      restriction:{latLngBounds: SA_BOUNDS, strictBounds:false}
    });

    if(Array.isArray(ALLOWED_POLY_PATH) && ALLOWED_POLY_PATH.length >= 3){
      allowedPoly = new google.maps.Polygon({
        map:map,
        paths: ALLOWED_POLY_PATH,
        strokeColor: '#027A93',
        strokeOpacity: 0.9,
        strokeWeight: 1.5,
        fillColor: '#027A93',
        fillOpacity: 0.05
      });
    }

    var polyBounds = null;
    if(allowedPoly){
      polyBounds = new google.maps.LatLngBounds();
      ALLOWED_POLY_PATH.forEach(function(p){ polyBounds.extend(p); });
      map.fitBounds(polyBounds);
      map.setOptions({ restriction: { latLngBounds: polyBounds, strictBounds: false } });
    }

    marker=new google.maps.Marker({position:def,map:map,draggable:true,title:'اسحب أو اضغط لتحديد الموقع'});

    function setPos(latLng,pan){
      if(!latLng) return;
      if (allowedPoly && !google.maps.geometry.poly.containsLocation(latLng, allowedPoly)) {
        showToast('error','خارج النطاق المسموح للخدمة');
        var hint = document.getElementById('mapHint');
        if(hint) hint.innerHTML = 'الموقع خارج نطاق الخدمة. رجاءً ابحث عن حي/عنوان داخل النطاق المظلل ثم حدده.';
        return;
      }
      marker.setPosition(latLng);
      if(pan){ map.panTo(latLng); }
      map.setZoom(17);
      positionUrl='https://www.google.com/maps/search/?api=1&query='+latLng.lat()+','+latLng.lng();
      var hint=document.getElementById('mapHint');
      if(hint) hint.innerHTML='تم اختيار الموقع: <strong>'+latLng.lat().toFixed(5)+', '+latLng.lng().toFixed(5)+'</strong>';
      renderSummary('page6'); updateNextAvailability();
    }

    marker.addListener('dragend',function(ev){ setPos(ev.latLng); });
    map.addListener('click',function(ev){ setPos(ev.latLng,true); });

    var input=document.getElementById('mapSearch');
    var opts={ fields:['geometry','name'], componentRestrictions:{country:'sa'}, strictBounds:true };
    autocomplete=new google.maps.places.Autocomplete(input, opts);
    autocomplete.bindTo('bounds', map);
    if(polyBounds){ autocomplete.setBounds(polyBounds); }
    autocomplete.addListener('place_changed', function(){
      var place=autocomplete.getPlace(); if(!place || !place.geometry) return;
      var loc=place.geometry.location;
      if (allowedPoly && !google.maps.geometry.poly.containsLocation(loc, allowedPoly)) {
        showToast('error','الموقع المحدد خارج نطاق الخدمة');
        var hint = document.getElementById('mapHint');
        if(hint) hint.innerHTML = 'الموقع خارج نطاق الخدمة. رجاءً ابحث عن حي/عنوان داخل النطاق المظلل ثم حدده.';
        return;
      }
      map.panTo(loc); map.setZoom(16); setPos(loc,true);
    });

    var btn=document.getElementById('show-my-location');
    if(btn){
      btn.addEventListener('click',function(){
        if(!navigator.geolocation){ showToast('error','المتصفح لا يدعم تحديد الموقع'); return; }
        navigator.geolocation.getCurrentPosition(
          function(pos){
            var here = new google.maps.LatLng(pos.coords.latitude,pos.coords.longitude);
            if (allowedPoly && !google.maps.geometry.poly.containsLocation(here, allowedPoly)) {
              showToast('error','موقعك الحالي خارج نطاق الخدمة');
              var hint = document.getElementById('mapHint');
              if(hint) hint.innerHTML = 'الموقع خارج نطاق الخدمة. رجاءً ابحث عن حي/عنوان داخل النطاق المظلل ثم حدده.';
              return;
            }
            setPos(here,true);
          },
          function(){ showToast('error','تعذر تحديد موقعك'); },
          { enableHighAccuracy:true, timeout:10000, maximumAge:30000 }
        );
      });
    }
  });
}
// IMPORTANT: expose before Maps script callback tries to call it
window.initMap = initMap;

/* =========================================================
   DOM Ready
   ========================================================= */
$(function(){
  installResizeObservers();

  // Preload BGS
  var pbg = Object.keys(PAGE_BACKGROUNDS).map(function(k){return PAGE_BACKGROUNDS[k];});
  pbg.forEach(function(src){ var i=new Image(); i.decoding='async'; i.src=src; });

  // Select2
  $('#area').select2({width:'100%',placeholder:'اختر المنطقة لخدمة العناية الفاخرة', dir:'rtl'});
  $('#serviceCat').select2({width:'100%',placeholder:'فئة الخدمة', dir:'rtl'});
  $('#service').select2({width:'100%',placeholder:'باقتك المختارة', dir:'rtl'});
  $('#carBrand').select2({width:'100%',placeholder:'اختر ماركة المركبة', dir:'rtl'});
  $('#area, #serviceCat, #service, #carBrand').on('select2:open', function(){ $('.select2-search__field').attr('dir','rtl'); });

  // Phone
  var mobileEl=document.getElementById('mobile');
  if(mobileEl){
    itiPhone=window.intlTelInput(mobileEl,{
      initialCountry:'sa', onlyCountries:['sa','ae','bh','kw','om','qa'],
      separateDialCode:true, placeholderNumberType:'MOBILE',
      utilsScript:'https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/utils.js'
    });
    $('#mobile')
      .attr({placeholder:'رقم التواصل الخاص — مثال 5XXXXXXXX', inputmode:'tel', autocomplete:'tel'})
      .on('blur', function(){
        var ok = itiPhone && itiPhone.isValidNumber();
        var el=document.getElementById('err-mobile');
        el.dataset.show = (ok ? 'false' : (SOFT_PHONE_VALIDATION?'true':'false'));
      });
  }

  // Errors aria-describedby
  [['area','err-area'],['serviceCat','err-serviceCat'],['service','err-service'],['date','err-date'],['name','err-name'],['mobile','err-mobile'],['googleMap','err-map']]
  .forEach(function(p){ var input=document.getElementById(p[0]), err=document.getElementById(p[1]); if(input&&err){ input.setAttribute('aria-describedby', p[1]); } });

  // Summary chip jump
  document.getElementById('summaryChips') && document.getElementById('summaryChips').addEventListener('click',function(e){
    var chip=e.target.closest('.chip'); if(!chip) return;
    var target=chip.getAttribute('data-target')||''; var idx=orderedPages.indexOf(target);
    if(idx>=0) showPage(idx);
  });

  // Inputs update state
  $('#name').on('input', function(){ nForm.customerN=this.value.trim(); renderSummary('page4'); updateNextAvailability(); });
  $('#mobile').on('input', function(){ renderSummary('page4'); updateNextAvailability(); });
  $('#carName').on('input', function(){ updateNextAvailability(); });
  $('#serviceCount').on('change', function(){ nForm.serviceCount=this.value||'1'; renderSummary('page2'); renderCartSummary(); updateNextAvailability(); });
  $('#plateNumber').on('input', function(){ updatePlateHint(); renderSummary('page4'); updateNextAvailability(); });

  // Date defaults
  var today=DateTime.now().toFormat('yyyy-LL-dd');
  $('#date').val(today).attr('min',today);

  var debounceT=null;
  $('#date').on('input', function(){ clearTimeout(debounceT); debounceT=setTimeout(function(){ fetchTimesForSelectedDate(); renderSummary('page3'); },220); });
  $('#date').on('change', function(){ fetchTimesForSelectedDate(); renderSummary('page3'); });

  // Load Addons (GAS)
  fetchAdditionalServicesAndRender();

  // Load Areas (from platform just to populate — if you want to lock to GAS, you can hardcode or sheet-drive areas)
  setLoadingServices(true);
  callContent2('/locations', function(res){
    var list=(res && res.data) || [];
    var ds=list.map(function(l){ return {id:l.id,text:l.TS_location_arabic_name}; });
    $('#area').empty().select2({data:ds,width:'100%',placeholder:'اختر المنطقة لخدمة العناية الفاخرة', dir:'rtl'});
    if(ds.length) $('#area').val(ds[0].id).trigger('change'); else { setLoadingServices(false); showToast('error','لا توجد مناطق متاحة حالياً'); }
    renderSummary('page2');
  });

  // When Area changes → fetch Services/Categories **from GAS only**
  $('#area').on('change', function(){
    nForm.location=this.value; setLoadingServices(true);
    clearServiceDescriptionUI();
    (async function(){
      try{
        var data = await api('services', { appId: APP_ID });
        servicesCache   = (data && data.success && data.data && Array.isArray(data.data.services))   ? data.data.services   : [];
        categoriesCache = (data && data.success && data.data && Array.isArray(data.data.servicesCat))? data.data.servicesCat: [];

        // Legacy selects
        var cats=categoriesCache.map(function(c){ return {id:c.TS_category_id,text:c.TS_category_arabic_name}; });
        $('#serviceCat').empty().select2({data:cats,width:'100%',placeholder:'فئة الخدمة', dir:'rtl'});
        if(cats.length) $('#serviceCat').val(cats[0].id).trigger('change');

        // Tabs + Cards
        if(USE_TABS_AND_CARDS){
          enableCartUI(true);
          activeCatId = cats.length ? String(cats[0].id) : null;
          selectedServiceId = nForm.service || null;
          renderCategoryTabs(categoriesCache);
          renderServiceCards();
          renderCartSummary();
        }

        setLoadingServices(false);
        renderSummary('page2');
        updateNextAvailability();
      }catch(_e){
        setLoadingServices(false);
        servicesCache=[]; categoriesCache=[];
        showToast('error','تعذر تحميل الخدمات من GAS');
      }
    })();
  });

  $('#serviceCat').on('change', function(){
    if(syncingFromCards) return;
    nForm.serviceCat=this.value;
    clearServiceDescriptionUI();
    var cid=Number(this.value);
    var items=(servicesCache||[]).filter(function(s){return Number(s.TS_category_id)===cid;})
      .sort(function(a,b){return Number(a.TS_service_id)-Number(b.TS_service_id);})
      .map(function(s){return {id:s.TS_service_id,text:s.TS_service_arabic_name};});
    $('#service').empty().select2({data:items,width:'100%',placeholder:'باقتك المختارة', dir:'rtl'});
    if(items.length) $('#service').val(items[0].id).trigger('change');
    renderSummary('page2'); updateNextAvailability();

    if(USE_TABS_AND_CARDS){
      activeCatId=String(this.value||'');
      renderCategoryTabs(categoriesCache);
      renderServiceCards();
      renderCartSummary();
    }
  });

  $('#service').on('change', function(){
    if(syncingFromCards){
      var selectedText = $('#service').find(':selected').text() || '';
      if (this.value || selectedText) fetchServiceDescription(this.value, selectedText);
      return;
    }
    nForm.service=this.value||'';
    selectedServiceId = this.value || null;
    renderSummary('page2'); updateNextAvailability();
    var selectedText = $('#service').find(':selected').text() || '';
    if (this.value || selectedText) fetchServiceDescription(this.value, selectedText);
    else clearServiceDescriptionUI();

    if(USE_TABS_AND_CARDS){
      renderServiceCards();
      renderCartSummary();
    }
  });

  // Brands
  var brands = [
    'Rolls-Royce','Bentley','Mercedes-Benz (Maybach)','Aston Martin','Ferrari','Lamborghini','McLaren','Maserati','Bugatti',
    'Porsche','Land Rover (Range Rover)','Mercedes-Benz','BMW','Audi','Lexus','Genesis','Jaguar','Cadillac','Infiniti','Volvo',
    'Toyota','Nissan','Hyundai','Kia','Honda','Mitsubishi','Mazda','GMC','Chevrolet','Ford','Jeep','Dodge','RAM',
    'Volkswagen','Peugeot','Renault','Skoda','Subaru','Suzuki','Isuzu','Mini','Opel','Citroën',
    'MG','Geely','Haval','GWM (Great Wall)','TANK','ORA','BYD','Changan','Oshan','GAC','JAC','Chery','Exeed','Omoda','Jetour',
    'Hongqi','BAIC','DFSK (Glory)','Foton','Maxus','Roewe','Lynk & Co','Zeekr','Neta (Hozon)','Seres','NIO','XPeng','Leapmotor','Other'
  ].map(function(b){ return {id:b,text:b};});
  $('#carBrand').empty().select2({data:brands,width:'100%',placeholder:'اختر ماركة المركبة', dir:'rtl'});

  $('#timeFilter').on('change', function(){ currentTimeFilter=this.value; renderSelectedDateTimes(lastSelectedISO); });

  // Footer nav
  var $prev=document.getElementById('footer-prev');
  var $next=document.getElementById('footer-next');
  var $wait=document.getElementById('footer-wait');

  async function gotoNext(){
    var i=getActiveIndex(); var id=orderedPages[i];
    if(id==='page1'){ showPage(1); return; }

    if(id==='page2'){
      var areaOk=!!$('#area').val(), catOk=!!$('#serviceCat').val(), svcOk=!!$('#service').val();
      document.getElementById('err-area').dataset.show=areaOk?'false':'true';
      document.getElementById('err-serviceCat').dataset.show=catOk?'false':'true';
      document.getElementById('err-service').dataset.show=svcOk?'false':'true';
      if(!areaOk||!catOk||!svcOk){ showToast('error','يرجى إكمال اختيار المنطقة/التصنيف/الخدمة'); return; }
      showPage(2); document.getElementById('date').dispatchEvent(new Event('change')); return;
    }

    if(id==='page3'){ if(!selectedTime){ showToast('error','الرجاء اختيار وقت'); return; } showPage(3); return; }

    if(id==='page4'){
      var nameOk=($('#name').val()||'').trim().length>0;
      var phoneOk= itiPhone ? itiPhone.isValidNumber() : true; // soft
      document.getElementById('err-name').dataset.show=nameOk?'false':'true';
      document.getElementById('err-mobile').dataset.show=(!phoneOk && SOFT_PHONE_VALIDATION)?'true':'false';
      if(!nameOk){ showToast('error','يرجى إدخال الاسم'); return; }
      nForm.customerN=$('#name').val().trim();
      nForm.customerM= itiPhone && itiPhone.getNumber ? itiPhone.getNumber().replace(/^\+/, '') : ($('#mobile').val()||'').replace(/\D/g,'');
      showPage(4); return;
    }

    if(id==='page5'){
      if(!nForm.paymentMethod){ document.getElementById('err-pay').dataset.show='true'; showToast('error','اختر طريقة الدفع'); return; }
      document.getElementById('err-pay').dataset.show='false'; showPage(5); return;
    }

    if(id==='page6'){
      if(!positionUrl){ document.getElementById('err-map').dataset.show='true'; showToast('error','الرجاء تحديد الموقع'); return; }
      document.getElementById('err-map').dataset.show='false'; nForm.urlLocation=positionUrl;

      if(isSubmitting) return;
      isSubmitting=true;
      $next.style.display='none';
      $prev.style.display='none';
      $wait.classList.add('show');

      var r=await postReservation(buildPayload());
      if(r.ok && r.data && r.data.success){
        showToast('success','تم إنشاء الحجز');
        document.getElementById('ts-area').textContent = $('#area').find(':selected').text()||'—';
        document.getElementById('ts-service').textContent = $('#service').find(':selected').text()||'—';
        document.getElementById('ts-dt').textContent = (nForm.date?DateTime.fromISO(nForm.date).toFormat('d LLL yyyy'):'') + (nForm.time?(' • '+nForm.time):'');
        document.getElementById('ts-pay').textContent = (nForm.paymentMethod||'').toUpperCase()||'—';
        var waMsg = encodeURIComponent('تم إرسال طلب حجز: \nالخدمة: '+($('#service').find(':selected').text())+'\nالتاريخ: '+nForm.date+' '+nForm.time+'\nالرابط: '+location.href);
        document.getElementById('ts-whatsapp').href = 'https://wa.me/?text='+waMsg;
        showPage(6);
      } else {
        var msg=(r && r.data && r.data.msgAR) || (r.status===404?'المسار غير موجود':'تعذر إنشاء الحجز');
        showToast('error',msg);
        isSubmitting=false; $wait.classList.remove('show'); $next.style.display=''; $prev.style.display='';
        return;
      }
      return;
    }
    showPage(Math.min(i+1, orderedPages.length-1));
  }
  document.getElementById('footer-next').addEventListener('click', gotoNext);
  document.getElementById('footer-prev').addEventListener('click', function(){ var i=getActiveIndex(); showPage(Math.max(i-1,0)); });

  // Payment radio group – roving focus & state
  (function installRoving(groupEl, itemSelector){
    if(!groupEl) return;
    var items = [].slice.call(groupEl.querySelectorAll(itemSelector));
    if(!items.length) return;
    function setActive(el){
      items.forEach(function(i){
        i.setAttribute('aria-checked','false'); i.setAttribute('tabindex','-1'); var input=i.querySelector('input'); if(input){ input.checked=false; }
      });
      el.setAttribute('aria-checked','true'); el.setAttribute('tabindex','0'); var input=el.querySelector('input');
      if(input){ input.checked=true; nForm.paymentMethod=input.value; renderSummary('page5'); updateNextAvailability(); }
    }
    items.forEach(function(el,i){ if(i===0) el.setAttribute('tabindex','0'); else el.setAttribute('tabindex','-1'); el.addEventListener('click',function(){ setActive(el); }); el.addEventListener('keydown',function(e){ if(e.key===' '||e.key==='Enter'){ e.preventDefault(); setActive(el);} }); });
    groupEl.addEventListener('keydown', function(e){
      var cur = document.activeElement.closest(itemSelector);
      if(!cur) return;
      var idx = items.indexOf(cur);
      if(e.key==='ArrowLeft' || e.key==='ArrowUp'){ e.preventDefault(); var p=items[Math.max(0, idx-1)]; if(p){ p.focus(); } }
      if(e.key==='ArrowRight'|| e.key==='ArrowDown'){ e.preventDefault(); var n=items[Math.min(items.length-1, idx+1)]; if(n){ n.focus(); } }
    }, {passive:false});
  })(document.getElementById('payGroup'), '.pay-card');

  // Addons popup shortcuts
  document.addEventListener('click', function(e){
    var addBtn = e.target.closest('.srv-card .btn-add');
    var rmBtn  = e.target.closest('.srv-card .btn-remove');

    if(addBtn){
      // Already handled in renderServiceCards -> click; keep text state
      updateFooterCartSummary();
    }
    if(rmBtn){
      var add = rmBtn.parentElement.querySelector('.btn-add');
      if(add){ add.textContent='إضافة إلى السلة'; add.classList.remove('is-selected'); }
      updateFooterCartSummary();
    }
  });

  // ESC closes addon popup
  document.addEventListener('keydown', function(e){
    if(e.key==='Escape'){
      var modal = document.getElementById('addonModal');
      if(modal && modal.getAttribute('aria-hidden')==='false'){
        modal.setAttribute('aria-hidden','true');
      }
    }
  });

  // Thanks actions
  $('#rebook').on('click', function(){ location.href='/'; });

  // Initial
  setPageBackground('page1'); renderSummary('page1'); syncProgress(0);
  updateNextAvailability();

  // CTA labeling / RTL
  (function(){
    var next = document.getElementById('footer-next');
    var prev = document.getElementById('footer-prev');
    var labels = NEXT_LABELS;
    function sync(){
      var active = (document.querySelector('.page.active') && document.querySelector('.page.active').id) || 'page1';
      next.textContent = labels[active] || 'التالي';
      prev.style.order = '1'; next.style.order = '2';
    }
    var mo = new MutationObserver(sync);
    mo.observe(document.querySelector('.stage'), { attributes:true, subtree:true, attributeFilter:['class'] });
    sync();
  })();

});
/* Debug helper without shorthand */
window._nahl_debug_state = function(){
  return {
    form: nForm,
    selectedServiceId: selectedServiceId,
    services: servicesCache,
    categories: categoriesCache,
    addonsOptions: nForm._addonsOptions || [],
    positionUrl: positionUrl
  };
};
  </script>

  <!-- Google Maps (with Places + Geometry) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBBHLoO038vsCovHN-SLUgAXqexlA2v0_4&callback=initMap&v=weekly&loading=async&libraries=places,geometry&language=ar&region=SA" async defer></script>
</body>
</html>
