<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</title>

  <!-- UI libs -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800&display=swap" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/css/intlTelInput.css" rel="stylesheet"/>

  <style>
    :root{
      --brand-700:#01657A; --brand-600:#027A93; --brand-200:#BFE6F0; --brand-050:#F0FAFC;
      --ink-900:#0B2630; --ink-700:#224652; --surface-000:#FFF; --surface-100:#EDF3F6; --border-300:#D4E0E6;
      --radius-md:14px; --radius-pill:999px;
      --shadow-sm:0 2px 8px rgba(11,38,48,.08); --shadow-md:0 10px 28px rgba(11,38,48,.14);
      --ease:cubic-bezier(.22,.61,.36,1); --t-med:.28s var(--ease);
      --fs-xl:1.375rem; --fs-md:1rem; --fs-sm:.9rem; --fw-bold:800;
      --sp-2:8px; --sp-3:12px; --sp-4:16px; --sp-5:20px; --sp-6:24px; --sp-7:32px;
      --header-h:76px; --footer-h:78px;
    }
    html,body{height:100%}
    body{
      margin:0; font-family:'Cairo',sans-serif; color:#fff;
      background:
        linear-gradient(180deg, rgba(11,38,48,.65), rgba(11,38,48,.35)),
        url("https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/lorenzo-hamers-n1SRvkP6bEk-unsplash%20(1).jpg") center/cover fixed;
      min-height:100vh; display:flex; flex-direction:column;
      padding-top:var(--header-h); padding-bottom:var(--footer-h);
    }

    /* Header */
    header{
      position:sticky; top:0; z-index:50; height:var(--header-h);
      background:rgba(11,38,48,.36); backdrop-filter:blur(10px);
      border-bottom:1px solid rgba(255,255,255,.15);
      display:flex; align-items:center; justify-content:center;
    }
    .header-inner{max-width:1120px; width:100%; padding:0 var(--sp-3); display:flex; align-items:center; justify-content:space-between}
    .brand{display:flex; align-items:center; gap:10px}
    .brand img{height:54px; width:auto; object-fit:contain; filter:drop-shadow(0 6px 20px rgba(0,0,0,.25))}
    .mini-progress{display:flex; align-items:center; gap:var(--sp-3); width:60%}
    .mini-progress .bar{flex:1; height:8px; background:rgba(255,255,255,.25); border-radius:999px; overflow:hidden}
    .mini-progress .bar>span{display:block; height:100%; width:0%; background:linear-gradient(90deg, var(--brand-600), var(--brand-200)); transition:width var(--t-med)}
    .mini-progress .step{font-weight:var(--fw-bold); font-size:var(--fs-md)}

    /* Main */
    main{flex:1 0 auto; display:flex; justify-content:center; padding:var(--sp-2) var(--sp-3) 0}
    #app{width:100%; max-width:1120px}

    /* Stage & pages */
    .stage{position:relative; min-height:540px; padding:8px 0 20px}
    .page{
      position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; gap:var(--sp-5);
      padding:var(--sp-5) var(--sp-3) var(--sp-6); overflow:auto; opacity:0; transform:translateY(14px) scale(.99);
      pointer-events:none; transition:opacity var(--t-med), transform var(--t-med);
    }
    .page.active{position:relative; opacity:1; transform:translateY(0) scale(1); pointer-events:auto}
    .page.exit{opacity:0; transform:translateY(18px) scale(.985)}
    .page h1{font-size:var(--fs-xl); font-weight:var(--fw-bold); margin:0; text-align:center}

    .card{background:var(--surface-000); color:var(--ink-900); border-radius:var(--radius-md); box-shadow:var(--shadow-md); padding:var(--sp-6); width:100%; max-width:920px}

    .form-control, select, .select2-selection{
      background:var(--surface-000); color:#0B2630;
      border:1px solid var(--border-300) !important; border-radius:var(--radius-md)!important;
      min-height:48px; text-align:center; font-size:var(--fs-md);
    }
    .select2-selection{height:48px !important; display:flex; align-items:center}
    .select2-selection__rendered{line-height:48px !important}

    /* Time grid */
    .time-grid{display:grid; grid-template-columns:repeat(2,1fr); gap:var(--sp-4)}
    @media (min-width:540px){ .time-grid{grid-template-columns:repeat(3,1fr)} }
    .time-option{
      background:#fff; color:#0B2630; font-weight:var(--fw-bold);
      border:1px solid var(--border-300); border-radius:var(--radius-md);
      padding:14px 10px; min-height:56px; box-shadow:var(--shadow-sm); transition:.18s var(--ease);
      display:flex; flex-direction:column; align-items:center; justify-content:center;
    }
    .time-option:hover{transform:translateY(-1px); background:var(--brand-050)}
    .time-option[aria-checked="true"]{outline:3px solid var(--brand-600); outline-offset:2px}

    /* Overlays */
    .load-overlay{
      position:absolute; inset:0; background:rgba(255,255,255,.85); color:#0B2630;
      display:none; align-items:center; justify-content:center; gap:12px; border-radius:var(--radius-md);
    }
    .load-overlay.show{display:flex}

    /* Payment */
    .pay-grid{display:grid; grid-template-columns:1fr 1fr; gap:var(--sp-4); width:100%; max-width:920px}
    .pay-card{
      background:#fff; color:#0B2630; border:1px solid var(--border-300); border-radius:var(--radius-md);
      padding:var(--sp-6); display:flex; justify-content:center; align-items:center; gap:var(--sp-4);
      min-height:64px; cursor:pointer; transition:.18s var(--ease);
    }
    .pay-card img{max-width:120px; height:auto}
    .pay-card[aria-checked="true"]{outline:3px solid var(--brand-600); outline-offset:2px}

    /* Footer */
    footer.sticky-nav{
      position:sticky; bottom:0; z-index:40; height:var(--footer-h);
      background:rgba(11,38,48,.45); backdrop-filter:blur(10px);
      border-top:1px solid rgba(255,255,255,.15);
      display:flex; align-items:center; justify-content:center;
    }
    .footer-inner{
      max-width:1120px; width:100%; padding:8px 12px;
      display:flex; align-items:center; justify-content:space-between;
    }
    .footer-brand{ font-size:.95rem; color:#fff; opacity:.92 }
    .footer-actions{display:flex; gap:12px}
    .btn-footer{
      flex:1; border:1px solid var(--border-300); border-radius:var(--radius-md);
      padding:12px 16px; min-height:48px; font-size:var(--fs-md); font-weight:var(--fw-bold);
      background:#fff; color:#027A93;
    }
    .btn-footer.primary{background:#027A93; color:#fff; border-color:#027A93}
    .btn-footer.hidden{visibility:hidden}

    .form-block{margin-bottom:var(--sp-5)}
    .form-label{display:inline-block; margin-bottom:6px; font-size:var(--fs-sm); font-weight:var(--fw-bold); color:#224652}
    .iti{width:100%!important}
    #mobile.form-control{height:48px; line-height:48px; text-align:center}
    html[dir="rtl"] .iti--allow-dropdown .iti__flag-container{right:0}
    html[dir="rtl"] .iti--allow-dropdown input#mobile.form-control{padding-right:62px}

    /* Toast */
    .toast-wrap{position:fixed; top:10px; left:50%; transform:translateX(-50%); z-index:1050; display:flex; flex-direction:column; gap:8px}
    .toast-msg{min-width:260px; color:#fff; padding:10px 14px; border-radius:10px; box-shadow:var(--shadow-md)}
    .toast-success{background:#16a34a}
    .toast-error{background:#dc2626}
    .toast-info{background:#0284c7}
    .visually-hidden{position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px);white-space:nowrap;border:0;margin:-1px}

    /* serviceCount full width */
    #serviceCount{ width:100% !important; }

    /* ---------------- Opening Motion (Soft Zoom + Fade + Stagger) ---------------- */
    @media (prefers-reduced-motion: no-preference) {
      .will-anim { will-change: transform, opacity; }

      @keyframes introSlideDown { from { opacity:0; transform:translateY(-10px) } to { opacity:1; transform:none } }
      @keyframes introFadeIn    { from { opacity:0 } to { opacity:1 } }
      @keyframes introRiseZoom  { from { opacity:0; transform:translateY(14px) scale(.985) } to { opacity:1; transform:none } }
      @keyframes introSlideUp   { from { opacity:0; transform:translateY(12px) } to { opacity:1; transform:none } }
      @keyframes barGrow        { from { width:0% } to { width:16.7% } }

      /* Play only on first load when .intro-play is on <body> */
      body.intro-play header .mini-progress { animation:introSlideDown 420ms var(--ease) 40ms both; }
      body.intro-play header .mini-progress .bar>span { animation:barGrow 480ms var(--ease) 80ms both; }

      body.intro-play #page1 h1 { animation:introFadeIn 360ms var(--ease) 80ms both; }
      body.intro-play #page1 .card { animation:introRiseZoom 520ms var(--ease) 120ms both; }

      body.intro-play footer .footer-actions { animation:introSlideUp 420ms var(--ease) 180ms both; }
      body.intro-play footer .footer-brand   { animation:introFadeIn 360ms var(--ease) 220ms both; }
    }
    @media (prefers-reduced-motion: reduce) {
      body.intro-play header .mini-progress,
      body.intro-play #page1 h1,
      body.intro-play #page1 .card,
      body.intro-play footer .footer-actions,
      body.intro-play footer .footer-brand { animation:none !important; opacity:1; }
    }
  </style>
</head>
<body>
  <!-- Toasts -->
  <div id="toastWrap" class="toast-wrap" aria-live="polite" aria-atomic="true"></div>

  <!-- Header -->
  <header>
    <div class="header-inner">
      <div class="mini-progress will-anim" aria-hidden="true">
        <div class="bar"><span id="miniBarFill" style="width:0%"></span></div>
        <div class="step" id="miniStepTitle">Ø§Ù„ØªØ±Ø­ÙŠØ¨</div>
      </div>
      <div class="brand">
        <img alt="Sponge & Soap" src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20%20Soap/spong&Soap%20-%20logo.png"
             onerror="this.src='https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20%20Soap/spong&Soap%20-%20logo.png'"/>
      </div>
    </div>
  </header>

  <!-- Body -->
  <main>
    <div id="app">
      <div class="stage">
        <!-- 1) Welcome -->
        <section id="page1" class="page active" aria-label="Ø§Ù„ØªØ±Ø­ÙŠØ¨">
          <h1 class="will-anim">âœ¨ ØºØ³ÙŠÙ„ Ø¨Ø¯ÙˆÙ† Ø·ÙˆØ§Ø¨ÙŠØ±</h1>
          <div class="card text-center will-anim">
            <p class="mb-3" style="color:#224652">ÙˆØ§ÙƒØ³ ÙŠØ­Ù…ÙŠ Ø³ÙŠØ§Ø±ØªÙƒ â€¢ ÙÙˆØ· Ù†Ø¸ÙŠÙØ© â€¢ Ø¥Ø³ÙÙ†Ø¬Ø© Ù„Ù„ÙƒÙØ±Ø§Øª</p>
            <!-- ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø²Ø± Ø§Ù„ØªØ±Ø­ÙŠØ¨Ø› Ø³Ù†Ø³ØªØ®Ø¯Ù… Ø²Ø± Ø§Ù„ÙÙˆØªØ± -->
          </div>
        </section>

        <!-- 2) Service & Location -->
        <section id="page2" class="page" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†Ø·Ù‚Ø© ÙˆØ§Ù„Ø®Ø¯Ù…Ø©">
          <h1>ÙˆÙŠÙ† ØªØ­Ø¨ Ù†Ø¬ÙŠÙƒØŸ</h1>

          <div class="card position-relative" id="servicesCard">
            <label class="form-label">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
            <select id="area" class="js-example-basic-single" style="width:100%"></select>

            <div class="row g-3 mt-3">
              <div class="col-12 col-md-6">
                <label class="form-label">Ø§Ù„ØªØµÙ†ÙŠÙ</label>
                <select id="serviceCat" style="width:100%"></select>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label">Ø§Ù„Ø®Ø¯Ù…Ø©</label>
                <select id="service" style="width:100%"></select>
              </div>
              <div class="col-12">
                <label class="form-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</label>
                <select id="serviceCount" class="form-select">
                  <option value="1" selected>1</option><option value="2">2</option>
                  <option value="3">3</option><option value="4">4</option><option value="5">5</option>
                </select>
              </div>
            </div>

            <!-- Spinner while service loads -->
            <div id="servicesLoading" class="load-overlay">
              <div class="spinner-border text-info" role="status" aria-hidden="true"></div>
              <strong>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øªâ€¦</strong>
            </div>
          </div>
        </section>

        <!-- 3) Time -->
        <section id="page4" class="page" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ¹Ø¯">
          <h1>Ù…ØªÙ‰ ØªØ­Ø¨ Ù†Ø¬ÙŠÙƒØŸ</h1>
          <div class="card position-relative" id="timeCard">
            <div class="row g-3">
              <div class="col-12 col-md-5">
                <label class="form-label">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                <input id="date" type="date" class="form-control"/>
              </div>
            </div>

            <div class="position-relative mt-3">
              <div id="time-container" class="time-grid"></div>
              <div id="timeLoading" class="load-overlay">
                <div class="spinner-border text-info" role="status" aria-hidden="true"></div>
                <strong>Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯â€¦</strong>
              </div>
            </div>
          </div>
        </section>

        <!-- 4) Contact -->
        <section id="page5" class="page" aria-label="Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„">
          <h1>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„</h1>
          <div class="card">
            <div class="row g-3">
              <div class="col-12 col-md-6 form-block">
                <label for="name" class="form-label">Ø§Ù„Ø¥Ø³Ù…</label>
                <input id="name" type="text" class="form-control" placeholder="Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ±ÙŠÙ…"/>
              </div>
              <div class="col-12 col-md-6 form-block">
                <label for="mobile" class="form-label">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
                <input id="mobile" type="tel" class="form-control" placeholder="+9665â€¦"/>
              </div>
            </div>
          </div>

          <h1>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</h1>
          <div class="card">
            <div class="row g-3">
              <div class="col-12 col-md-4">
                <label class="form-label">Ù…Ø§Ø±ÙƒØ© Ø§Ù„Ø³ÙŠØ§Ø±Ø© ğŸš˜</label>
                <select id="carBrand" style="width:100%"></select>
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label>
                <input id="carName" type="text" class="form-control" placeholder="ÙƒØ§Ù…Ø±ÙŠØŒ Ø¥Ù„Ù†ØªØ±Ø§â€¦"/>
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©</label>
                <input id="plateNumber" type="text" inputmode="numeric" maxlength="4" class="form-control" placeholder="1234"/>
              </div>
              <input id="locationDescription" type="text" hidden/>
            </div>
          </div>

          <h1>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</h1>
          <div class="pay-grid">
            <label class="pay-card" tabindex="0">
              <input type="radio" name="payingMethod" value="STC Pay" class="visually-hidden"/>
              <img src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/STC%20PAY%20LOGO.png" alt="STC Pay">
            </label>
            <label class="pay-card" tabindex="0">
              <input type="radio" name="payingMethod" value="Cash" class="visually-hidden"/>
              <strong>Cash</strong>
            </label>
            <label class="pay-card" style="grid-column:1/-1" tabindex="0">
              <input type="radio" name="payingMethod" value="MADA" class="visually-hidden"/>
              <img src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/MADA%20LOGO.png" alt="Mada">
            </label>
          </div>
        </section>

        <!-- 5) Map -->
        <section id="page6" class="page" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹">
          <h1>Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø®Ø±ÙŠØ·Ø© Ù‚ÙˆÙ‚Ù„</h1>
          <div class="card">
            <div id="googleMap" style="width:100%;height:420px;border-radius:14px;overflow:hidden"></div>
          </div>
          <div class="card text-center">
            <button id="show-my-location" class="btn btn-outline-primary" type="button">Ø¥Ø¸Ù‡Ø§Ø± Ù…ÙˆÙ‚Ø¹ÙŠ</button>
          </div>
        </section>

        <!-- 6) Done -->
        <section id="page7" class="page" aria-label="ØªÙ… Ø§Ù„Ø­Ø¬Ø²">
          <h1>Ø´ÙƒØ±Ø§Ù‹ Ù„ÙƒÙ…</h1>
          <div class="card text-center">
            <p class="mb-3" style="color:#224652">ØªÙ… Ø­Ø¬Ø² Ø§Ù„Ù…ÙˆØ¹Ø¯ØŒ ÙˆØ±Ø§Ø­ Ù†Ø£ÙƒØ¯Ù‡ Ù„ÙƒÙ… Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</p>
            <button id="rebook" class="btn btn-primary" type="button">ğŸ” Ø­Ø¬Ø² Ø¬Ø¯ÙŠØ¯</button>
          </div>
        </section>
      </div>
    </div>
  </main>

  <!-- Footer nav (with Nahl marking) -->
  <footer class="sticky-nav" aria-label="Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø®Ø·ÙˆØ§Øª">
    <div class="footer-inner">
      <div class="footer-brand will-anim" aria-label="Nahl Marking">
        <span>Ù†Ø­Ù„ â€¢ <a href="https://nahl.app" target="_blank" rel="noopener" style="color:#fff;text-decoration:none">Nahl.app</a></span>
      </div>
      <div class="footer-actions will-anim">
        <button id="footer-prev" type="button" class="btn-footer hidden">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
        <button id="footer-next" type="button" class="btn-footer primary">Ø§Ù„ØªØ§Ù„ÙŠ</button>
      </div>
    </div>
  </footer>

  <!-- JS libs -->
  <script src="https://code.jquery.com/jquery-3.6.3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/intlTelInputWithUtils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /* ---------------- API ---------------- */
    const defaultLink2 = `https://nahl-platform.vercel.app/api/app/AM/general/${'33e0d05d-d771-46f4-a7e7-7c634b4e3a9e'}/form`;
    let controllers=[];
    async function callContent2(path, cb, abortable=false, retries=3){
      let signal='';
      if(abortable){
        controllers.forEach(([c])=>c.abort()); controllers=[];
        const controller=new AbortController(); signal=controller.signal; controllers.push([controller,signal]);
      }
      try{
        const res=await fetch(defaultLink2+path,{method:'GET',redirect:'follow',...(abortable&&{signal})});
        if(!res.ok){ if(retries>0) return callContent2(path,cb,abortable,retries-1); throw new Error('Network'); }
        cb(await res.json());
      }catch(e){
        if(!String(e).includes('AbortError') && retries>0) setTimeout(()=>callContent2(path,cb,abortable,retries-1),700);
      }
    }

    /* ---------------- Toast ---------------- */
    function showToast(type='info', msg=''){
      const wrap=document.getElementById('toastWrap');
      const div=document.createElement('div');
      div.className='toast-msg '+(type==='error'?'toast-error':type==='success'?'toast-success':'toast-info');
      div.textContent=msg; wrap.appendChild(div);
      setTimeout(()=>{ div.style.opacity='0'; setTimeout(()=>div.remove(),300); }, 2200);
    }

    /* ---------------- STATE ---------------- */
    const DateTime=luxon.DateTime;
    const orderedPages=["page1","page2","page4","page5","page6","page7"];
    const STEPS_LABELS=["Ø§Ù„ØªØ±Ø­ÙŠØ¨","Ø§Ù„Ø®Ø¯Ù…Ø©","Ø§Ù„ÙˆÙ‚Øª","Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª","Ø§Ù„Ù…ÙˆÙ‚Ø¹","Ø§Ù„ØªØ£ÙƒÙŠØ¯"];
    let selectedTime=null, positionUrl="";
    let servicesCache=null, categoriesCache=null, itiPhone=null;

    const nForm={date:'',time:'',location:'',service:'',serviceCount:'1',serviceCat:'',customerM:'',customerN:'',paymentMethod:'',urlLocation:'',locationDescription:''};

    function showPage(idx){
      const cur=document.querySelector('.page.active');
      const next=document.getElementById(orderedPages[idx]); if(!next||cur===next) return;
      if(cur){ cur.classList.remove('active'); cur.classList.add('exit'); }
      next.style.display='flex';
      requestAnimationFrame(()=>{ next.classList.add('active'); setTimeout(()=>{ if(cur){cur.classList.remove('exit'); cur.style.display='none';} },280); });
      syncProgress(idx);
    }
    function getActiveIndex(){ const id=document.querySelector('.page.active')?.id; return Math.max(0, orderedPages.indexOf(id)); }
    function syncProgress(i){
      const pct=((i+1)/orderedPages.length)*100;
      document.getElementById('miniBarFill').style.width=pct+'%';
      document.getElementById('miniStepTitle').textContent=STEPS_LABELS[Math.min(i,STEPS_LABELS.length-1)];
      document.getElementById('footer-prev').classList.toggle('hidden', i===0);

      // ØªØ¨Ø¯ÙŠÙ„ Ù†Øµ Ø²Ø± Ø§Ù„ÙÙˆØªØ± ÙÙŠ ØµÙØ­Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨
      const nextBtn=document.getElementById('footer-next');
      nextBtn.textContent = (i===0) ? 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø­Ø¬Ø²' : 'Ø§Ù„ØªØ§Ù„ÙŠ';
    }

    /* ---------------- Availability logic ---------------- */
    function isAvailable(row){
      const raw = row?.TS_appintment_status ?? row?.TS_status ?? row?.status ?? '';
      const norm = String(raw).trim().toLowerCase();
      return norm === 'available';
    }

    function setLoadingTimes(on){ document.getElementById('timeLoading').classList.toggle('show', !!on); }
    function setLoadingServices(on){ document.getElementById('servicesLoading').classList.toggle('show', !!on); }

    function buildDatesWindowFromInput() {
      const dateEl = document.getElementById('date');
      const start = DateTime.fromISO(dateEl.value || DateTime.now().toFormat('yyyy-LL-dd'));
      return [start, start.plus({ days: 1 }), start.plus({ days: 2 })];
    }

    function prepareTimeBuckets(apiJson, datesWindow) {
      const bucketsDisplay = [[], [], []];
      const bucketsActual  = [[], [], []];

      if (!apiJson || !apiJson.data || !Array.isArray(apiJson.data.appointments)) {
        return { appointments: bucketsDisplay, actualTimes: bucketsActual };
      }

      const rows = apiJson.data.appointments;

      for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        if (!isAvailable(row)) continue;

        const d = luxon.DateTime.fromISO(row.TS_appointment_date ?? row.date ?? '', { setZone: true });
        let t = luxon.DateTime.fromISO(row.TS_appointment_time ?? row.time ?? '', { setZone: true });

        if (!t.isValid && row.TS_appointment_time) {
          t = luxon.DateTime.fromFormat(String(row.TS_appointment_time), 'HH:mm:ss', { setZone: true });
          if (!t.isValid) t = luxon.DateTime.fromFormat(String(row.TS_appointment_time), 'H:mm', { setZone: true });
        }

        if (!d.isValid || !t.isValid) continue;

        const isoDate = d.toISODate();
        const display = t.toLocaleString(luxon.DateTime.TIME_SIMPLE);
        const actual  = t.toFormat('hh:mm a');

        for (let idx = 0; idx < 3; idx++) {
          if (isoDate === datesWindow[idx].toFormat('yyyy-LL-dd')) {
            bucketsDisplay[idx].push(display);
            bucketsActual[idx].push(actual);
            break;
          }
        }
      }

      for (let i = 0; i < 3; i++) {
        const zip = bucketsDisplay[i].map((d, k) => ({ d, a: bucketsActual[i][k] }));
        zip.sort((A,B) => A.a.localeCompare(B.a));
        bucketsDisplay[i] = zip.map(z => z.d);
        bucketsActual[i]  = zip.map(z => z.a);
      }

      return { appointments: bucketsDisplay, actualTimes: bucketsActual };
    }

    function renderTimes(items){
      const cont = document.getElementById('time-container');
      cont.innerHTML = '';
      selectedTime = null;

      if (!items.length){
        cont.innerHTML = '<div class="text-center text-muted" style="grid-column:1/-1">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ù…ØªØ§Ø­Ø©</div>';
        return;
      }

      items.forEach(t=>{
        const btn = document.createElement('button');
        btn.className = 'time-option';
        btn.type = 'button';
        btn.setAttribute('role','radio');
        btn.textContent = t.ui;
        btn.addEventListener('click', ()=>{
          [...cont.children].forEach(x=>x.setAttribute('aria-checked','false'));
          btn.setAttribute('aria-checked','true');
          selectedTime = t;
          nForm.time = t.iso.slice(0,5);
        });
        cont.appendChild(btn);
      });
    }

    function fetchAndRenderTimes(){
      setLoadingTimes(true);
      const startDate=document.getElementById('date').value||DateTime.now().toFormat('yyyy-LL-dd');
      const loc=document.getElementById('area').value||'';
      const srv=document.getElementById('service').value||'';
      if(!loc || !srv){
        document.getElementById('time-container').innerHTML='<div class="text-center text-muted" style="grid-column:1/-1">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø© ÙˆØ§Ù„Ø®Ø¯Ù…Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</div>';
        setLoadingTimes(false);
        return;
      }
      callContent2(`/appointments?startDate=${startDate}&location=${encodeURIComponent(loc)}&service=${encodeURIComponent(srv)}`, (res)=>{
        const appts=(res?.data?.appointments||[]);
        const prepared = appts.map(a=>{
          if(!isAvailable(a)) return null;
          let t = luxon.DateTime.fromISO(a.TS_appointment_time || a.time || a.TS_time, { setZone:true });
          if (!t.isValid && a.TS_appointment_time) {
            t = luxon.DateTime.fromFormat(String(a.TS_appointment_time), 'HH:mm:ss', { setZone:true });
            if (!t.isValid) t = luxon.DateTime.fromFormat(String(a.TS_appointment_time), 'H:mm', { setZone:true });
          }
          if(!t.isValid) return null;

          return { ui: t.toLocaleString(luxon.DateTime.TIME_SIMPLE), iso: t.toFormat('HH:mm') };
        }).filter(Boolean);

        const uniq = {};
        prepared.forEach(it=>{ if(!uniq[it.iso]) uniq[it.iso]=it; });
        const items = Object.values(uniq).sort((a,b)=>a.iso.localeCompare(b.iso));

        renderTimes(items);
        setLoadingTimes(false);
      }, true);
    }

    function validateMobile(){
      if(!itiPhone || !itiPhone.isValidNumber()){ showToast('error','Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ ØµØ­ÙŠØ­'); return false; }
      return true;
    }

    /* ---------------- Init & bindings ---------------- */
    $(function(){
      const today=DateTime.now().toFormat('yyyy-LL-dd');
      $('#date').val(today).attr('min',today);

      $('#area').select2({width:'100%',placeholder:'Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©'});
      $('#serviceCat').select2({width:'100%',placeholder:'Ø§Ù„ØªØµÙ†ÙŠÙ'});
      $('#service').select2({width:'100%',placeholder:'Ø§Ù„Ø®Ø¯Ù…Ø©'});
      $('#carBrand').select2({width:'100%',placeholder:'Ù…Ø§Ø±ÙƒØ© Ø§Ù„Ø³ÙŠØ§Ø±Ø©'});

      itiPhone=window.intlTelInput(document.querySelector('#mobile'),{
        initialCountry:'sa', onlyCountries:['sa','ae','bh','kw','om','qa'],
        utilsScript:'https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/utils.js'
      });

      // load locations
      setLoadingServices(true);
      callContent2(`/locations`, res=>{
        const list=res?.data||[]; const ds=list.map(l=>({id:l.id,text:l.TS_location_arabic_name}));
        $('#area').empty().select2({data:ds,width:'100%'}); 
        if(ds.length){ $('#area').val(ds[0].id).trigger('change'); }
        else { setLoadingServices(false); showToast('error','Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§Ø·Ù‚ Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹'); }
      });

      // area -> services
      $('#area').on('change', function(){
        nForm.location=this.value; setLoadingServices(true);
        callContent2(`/services?location=${encodeURIComponent(this.value)}`, res=>{
          servicesCache=res?.data?.services||[]; categoriesCache=res?.data?.servicesCat||[];
          const cats=categoriesCache.map(c=>({id:c.TS_category_id,text:c.TS_category_arabic_name}));
          $('#serviceCat').empty().select2({data:cats,width:'100%'}); 
          if(cats.length){ $('#serviceCat').val(cats[0].id).trigger('change'); }
          setLoadingServices(false);
        }, true);
      });

      // category -> service
      $('#serviceCat').on('change', function(){
        nForm.serviceCat=this.value; const cid=Number(this.value);
        const items=servicesCache?.filter(s=>Number(s.TS_category_id)===cid)?.sort((a,b)=>a.TS_service_id-b.TS_service_id)?.map(s=>({id:s.TS_service_id,text:s.TS_service_arabic_name}))||[];
        $('#service').empty().select2({data:items,width:'100%'}); 
        if(items.length){ $('#service').val(items[0].id).trigger('change'); }
      });

      // on service/date change, refresh times if on time page
      $('#service, #date').on('change', ()=>{ if(getActiveIndex()===2) fetchAndRenderTimes(); });

      // brands
      const brands=["Toyota","Nissan","Hyundai","Kia","Honda","Lexus","BMW","Mercedes-Benz","Chevrolet","Ford","Mazda","Mitsubishi","Aston Martin","Other"].sort().map(b=>({id:b,text:b}));
      $('#carBrand').empty().select2({data:brands,width:'100%'});

      // payments
      document.querySelectorAll('.pay-card').forEach(card=>{
        card.addEventListener('click', ()=>{
          document.querySelectorAll('.pay-card').forEach(c=>{c.setAttribute('aria-checked','false'); c.querySelector('input').checked=false;});
          card.setAttribute('aria-checked','true'); card.querySelector('input').checked=true; nForm.paymentMethod=card.querySelector('input').value;
        });
      });

      // rebook
      $('#rebook').on('click', ()=>location.href='/');

      // initial progress state
      syncProgress(0);
    });

    // Footer nav
    (function(){
      const $prev=document.getElementById('footer-prev');
      const $next=document.getElementById('footer-next');

      $next.addEventListener('click', async ()=>{
        const i=getActiveIndex(); const id=orderedPages[i];

        if(id==='page1'){ showPage(1); return; }

        if(id==='page2'){
          if(!$('#area').val()){ showToast('error','ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©'); return; }
          if(!$('#service').val()){ showToast('error','ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø®Ø¯Ù…Ø©'); return; }
          nForm.service=$('#service').val(); nForm.serviceCount=$('#serviceCount').val()||'1';
          showPage(2);
          fetchAndRenderTimes();
          return;
        }

        if(id==='page4'){
          if(!selectedTime){ showToast('error','Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ÙˆÙ‚Øª'); return; }
          nForm.date=$('#date').val();
          showPage(3);
          return;
        }

        if(id==='page5'){
          const name=$('#name').val().trim();
          if(!name){ showToast('error','ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù…'); return; }
          if(!validateMobile()) return;
          if(!nForm.paymentMethod){ showToast('error','ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹'); return; }

          nForm.customerN=name;
          nForm.customerM=itiPhone.getNumber().replace(/^\+/,'');
          nForm.locationDescription=[$('#carBrand').val()||'', $('#carName').val()||'', $('#plateNumber').val()||''].filter(Boolean).join(', ');

          showPage(4);
          return;
        }

        if(id==='page6'){
          if(!positionUrl){ showToast('error','Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©'); return; }
          nForm.urlLocation=positionUrl;

          try{
            const res=await fetch(defaultLink2 + '/reserveAppointment',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(nForm)});
            const json=await res.json();
            if(json?.success){ showToast('success','ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø¬Ø²'); showPage(5); }
            else { showToast('error', json?.msgAR || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹'); }
          }catch(e){
            showToast('error','Ø¹Ø°Ø±Ù‹Ø§ Ø­ØµÙ„ Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§');
          }
          return;
        }

        showPage(Math.min(i+1, orderedPages.length-1));
      });

      $prev.addEventListener('click', ()=>{ const i=getActiveIndex(); showPage(Math.max(i-1,0)); });
    })();

    /* ---------------- Opening Motion trigger + date min ---------------- */
    document.addEventListener('DOMContentLoaded', ()=>{
      // Play intro motion once
      document.body.classList.add('intro-play');
      setTimeout(()=>document.body.classList.remove('intro-play'), 800);

      // ensure date min = today (safety if earlier init didn't run)
      const today= luxon.DateTime.now().toFormat('yyyy-LL-dd');
      const dateEl=document.getElementById('date');
      if(dateEl){ dateEl.setAttribute('min',today); }
    });

    /* ---------------- Google Map ---------------- */
    let map, marker;
    function initMap(){
      const def={lat:26.34165524787632,lng:50.11524831545726};
      map=new google.maps.Map(document.getElementById('googleMap'),{center:def,zoom:12,disableDoubleClickZoom:true});
      marker=new google.maps.Marker({position:def,map,draggable:true,title:'Ø§Ø³Ø­Ø¨ Ø£Ùˆ Ø§Ø¶ØºØ· Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹'});
      const setPos=(latLng,pan=false)=>{ marker.setPosition(latLng); if(pan) map.panTo(latLng); map.setZoom(17); positionUrl=`https://www.google.com/maps/search/?api=1&query=${latLng.lat()},${latLng.lng()}`; };
      marker.addEventListener?.('dragend',e=>setPos(e.latLng));
      google.maps.event.addListener(marker,'dragend',e=>setPos(e.latLng));
      google.maps.event.addListener(map,'click',e=>setPos(e.latLng));
      document.getElementById('show-my-location').addEventListener('click', ()=>{
        if(navigator.geolocation){
          navigator.geolocation.getCurrentPosition(pos=>setPos(new google.maps.LatLng(pos.coords.latitude,pos.coords.longitude),true));
        }
      });
    }
    window.initMap=initMap;
  </script>

  <!-- Google Maps -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBBHLoO038vsCovHN-SLUgAXqexlA2v0_4&callback=initMap" async defer></script>
</body>
</html>
