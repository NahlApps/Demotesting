<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Primary Meta Tags -->
    <title>حجوزات المواعيد</title>
    <meta name="title" content="حجوزات المواعيد">
<meta name="description" content="1.	بنغسل سيارتك بخلطة خاصة مدعّمة بالواكس تحميها من الغبار والخدوش.  2.	فوطنا دايمًا نظيفة. 3.	ونستخدم إسفنجة مخصوصة للكفرات عشان نهتم بكل تفاصيل سيارتك.
#غسيل_بدون_طوابير">

<!-- Google / Search Engine Tags -->
<meta itemprop="name" content="حجوزات المواعيد">
<meta itemprop="description" content="1.	بنغسل سيارتك بخلطة خاصة مدعّمة بالواكس تحميها من الغبار والخدوش.  2.	فوطنا دايمًا نظيفة. 3.	ونستخدم إسفنجة مخصوصة للكفرات عشان نهتم بكل تفاصيل سيارتك.
#غسيل_بدون_طوابير">
<meta itemprop="image" content="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/Logo%20-%20Sponge%20and%20Soap%20-%201.png">

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website">
<meta property="og:url" content="https://www.spongnsoap.com">
<meta property="og:title" content="حجوزات المواعيد">
<meta property="og:description" content="1.	بنغسل سيارتك بخلطة خاصة مدعّمة بالواكس تحميها من الغبار والخدوش.  2.	فوطنا دايمًا نظيفة. 3.	ونستخدم إسفنجة مخصوصة للكفرات عشان نهتم بكل تفاصيل سيارتك.
#غسيل_بدون_طوابير">
<meta property="og:image" content="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/Logo%20-%20Sponge%20and%20Soap%20-%201.png">
<meta property="og:image:src" content="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/Logo%20-%20Sponge%20and%20Soap%20-%201.png">

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:url" content="https://www.spongnsoap.com">
<meta property="twitter:title" content="حجوزات المواعيد">
<meta property="twitter:description" content="1.	بنغسل سيارتك بخلطة خاصة مدعّمة بالواكس تحميها من الغبار والخدوش.  2.	فوطنا دايمًا نظيفة. 3.	ونستخدم إسفنجة مخصوصة للكفرات عشان نهتم بكل تفاصيل سيارتك.
#غسيل_بدون_طوابير">
<meta property="twitter:image" content="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/Logo%20-%20Sponge%20and%20Soap%20-%201.png">
<meta property="twitter:image:src" content="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/Logo%20-%20Sponge%20and%20Soap%20-%201.png">
<link rel="shortcut icon" href="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/Logo%20-%20Sponge%20and%20Soap%20-%201.png" type="image/x-icon">
<link rel="icon" type="image/png" sizes="32x32" href="">
<link rel="icon" type="image/png" sizes="16x16" href="">

<meta name="keywords" content="المدينة,المنورة,الشرقية,القطيف,الخبر,الدمام,سيهات,car,سيارة,mobile,موبيل,موبايل,لكزس,lexus,واش,wash,car wash,غسيل,غسيل_بدون_طوابير,طابور,بدون,طوابير,موسم,داخلي,خارجي,نظيف,تلميع,تظليل,clean,internal,حجز,موعد,reserve,appointment,ticket,work,عمل,riyad,dahran,dhahran,تنظيف,نظافة,بخار,ماء,ماي,مويه,صابون,نحل,nahl,nahl.app,أزرق,نيلي,Blue,Last clean,اسفجنة وصابون,sponge, soap, spongnsoap,spongensoap,اخر نظافة,مايكلين">
<meta name="robots" content="index, follow">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="language" content="Arabic">
    <title>حجز موعد</title>

    <script src="https://code.jquery.com/jquery-3.6.3.slim.min.js" integrity="sha256-ZwqZIVdD3iXNyGHbSYdsmWP//UBokj2FHAxKuSBKDSo=" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  <!-- date-fns -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <!-- luxon -->
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>

  
    <!-- Font Awesome -->
<link
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
  rel="stylesheet"
/>
<!-- Google Fonts -->
<link
  href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap"
  rel="stylesheet"
/>
<link href="https://fonts.googleapis.com/css2?family=Tinos:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>
<!-- country codes -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/css/intlTelInput.css">
<script src="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/intlTelInputWithUtils.js"></script>



</head>
<style>
  /* … your original CSS unchanged … */
  /* (kept exactly as you provided) */
</style>
<body>
    <div class="bg-image">
    </div>
    <div id="banner" >
        <!-- … unchanged banner … -->
    </div>
    <div id="form">

        <div id="form-content">
          <div class="header">
            <!-- … unchanged header … -->
          </div>

          <!-- ===== Page 1..5 as-is (UNCHANGED HTML) ===== -->
          <!-- (All markup down to page5 remains exactly as you supplied) -->

            <div id="page1" style="display: flex;">
              <!-- … unchanged … -->
            </div>  
            <div id="page2" class="fadeIn" style="display: none;">
              <!-- … unchanged … -->
            </div>
            <div id="page3" class="fadeIn" style="display: none;" >
              <!-- … unchanged … -->
            </div>
            <div id="page4" class="fadeIn" style="display: none;">
              <!-- … unchanged … -->
            </div>

            <div id="page5" class="fadeIn" style="display: none;" >
              <!-- … UNCHANGED contact & payment method HTML … -->
              <!-- (Your three radios: Cash, STC Pay, MADA — kept exactly) -->
              <!-- Buttons block unchanged -->
            </div>

            <!-- ========== NEW: Payment Gateway Page (#pagePayment) ========== -->
            <div id="pagePayment" class="fadeIn" style="display:none; align-items:center; justify-content:center; height:70%;">
              <div style="text-align:center; color:#fff;">
                <div class="spinner-border" role="status" style="width: 3rem; height: 3rem; margin-bottom:1rem;">
                  <span class="sr-only">Loading...</span>
                </div>
                <h2>جارِ تهيئة الدفع عبر مدى</h2>
                <p style="opacity:.9">سيتم تحويلك لصفحة Telr الآمنة لإتمام عملية الدفع.</p>
                <div id="payError" class="alert alert-danger mt-3" style="display:none;"></div>
                <button id="payCancel" class="filter-button" style="margin-top:12px;">الرجوع</button>
              </div>
            </div>
            <!-- ========== /NEW: Payment Gateway Page ========== -->

<div id="page6" class="fadeIn" style="display: none;">
  <!-- … unchanged map & form & buttons … -->
</div>

            
            <div id="page7" class="fadeIn" style="display: none;" dir="rtl" >
               <!-- … unchanged thank-you page … -->
            </div>  
            <footer dir="rtl" style="text-align: center; margin-top: 20px;">
              <!-- … unchanged footer … -->
            </footer>
        </div>

    </div>

<!-- … your social buttons & Terms modal (unchanged) … -->

</body>
<script>
/* =========================
   CONFIG (replace base URL)
   ========================= */
const APPS_SCRIPT_BASE = 'https://script.google.com/macros/s/REPLACE_WITH_YOUR_DEPLOYMENT_ID/exec'; // ← CHANGE THIS

function addService(element) {
  element.classList.toggle("active");

  // Collect selected chips
  let selectedServices = [];
  document.querySelectorAll(".chip.active").forEach(function(chip) {
    selectedServices.push(chip.textContent.trim());
  });

  // Update the textarea with selected services
  document.getElementById("locationDescription").value = selectedServices.join(", ");
}

const input = document.querySelector("#mobile");
const countryCodeInput = window.intlTelInput(input, {
  utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/utils.js",
  countryOrder:["sa","qa"],
  initialCountry:"sa",
  onlyCountries:["sa","qa","ae","om","kw","bh"],
  excludeCountries:["il"],
  strictMode:true,
  i18n:{
    ac:"جزيرة أسينشين",
    ad: "أندورا",
    ae: "الإمارات العربية المتحدة",
    af: "أفغانستان",
    ag: "أنتيغوا وبربودا",
    ai: "أنغويلا",
    al: "ألبانيا",
    am: "أرمينيا",
    ao: "أنغولا",
    ar: "الأرجنتين",
    as: "ساموا الأمريكية",
    at: "النمسا",
    au: "أستراليا",
    aw: "أروبا",
    ax: "جزر آلاند",
    az: "أذربيجان",
    ba: "البوسنة والهرسك",
    bb: "بربادوس",
    bd: "بنغلاديش",
    be: "بلجيكا",
    bf: "بوركينا فاسو",
    bg: "بلغاريا",
    bh: "البحرين",
    bi: "بوروندي",
    bj: "بنين",
    bl: "سان بارتليمي",
    bm: "برمودا",
    bn: "بروناي",
    bo: "بوليفيا",
    bq: "هولندا الكاريبية",
    br: "البرازيل",
    bs: "جزر البهاما",
    bt: "بوتان",
    bw: "بوتسوانا",
    by: "بيلاروس",
    bz: "بليز",
    ca: "كندا",
    cc: "جزر كوكوس (كيلينغ)",
    cd: "الكونغو - كينشاسا",
    cf: "جمهورية أفريقيا الوسطى",
    cg: "الكونغو - برازافيل",
    ch: "سويسرا",
    ci: "ساحل العاج",
    ck: "جزر كوك",
    cl: "تشيلي",
    cm: "الكاميرون",
    cn: "الصين",
    co: "كولومبيا",
    cr: "كوستاريكا",
    cu: "كوبا",
    cv: "الرأس الأخضر",
    cw: "كوراساو",
    cx: "جزيرة كريسماس",
    cy: "قبرص",
    cz: "التشيك",
    de: "ألمانيا",
    dj: "جيبوتي",
    dk: "الدانمرك",
    dm: "دومينيكا",
    do: "جمهورية الدومينيكان",
    dz: "الجزائر",
    ec: "الإكوادور",
    ee: "إستونيا",
    eg: "مصر",
    eh: "الصحراء الغربية",
    er: "إريتريا",
    es: "إسبانيا",
    et: "إثيوبيا",
    fi: "فنلندا",
    fj: "فيجي",
    fk: "جزر فوكلاند",
    fm: "ميكرونيزيا",
    fo: "جزر فارو",
    fr: "فرنسا",
    ga: "الغابون",
    gb: "المملكة المتحدة",
    gd: "غرينادا",
    ge: "جورجيا",
    gf: "غويانا الفرنسية",
    gg: "غيرنزي",
    gh: "غانا",
    gi: "جبل طارق",
    gl: "غرينلاند",
    gm: "غامبيا",
    gn: "غينيا",
    gp: "غوادلوب",
    gq: "غينيا الاستوائية",
    gr: "اليونان",
    gt: "غواتيمالا",
    gu: "غوام",
    gw: "غينيا بيساو",
    gy: "غيانا",
    hk: "هونغ كونغ الصينية (منطقة إدارية خاصة)",
    hn: "هندوراس",
    hr: "كرواتيا",
    ht: "هايتي",
    hu: "هنغاريا",
    id: "إندونيسيا",
    ie: "أيرلندا",
    im: "جزيرة مان",
    in: "الهند",
    io: "الإقليم البريطاني في المحيط الهندي",
    iq: "العراق",
    ir: "إيران",
    is: "آيسلندا",
    it: "إيطاليا",
    je: "جيرسي",
    jm: "جامايكا",
    jo: "الأردن",
    jp: "اليابان",
    ke: "كينيا",
    kg: "قيرغيزستان",
    kh: "كمبوديا",
    ki: "كيريباتي",
    km: "جزر القمر",
    kn: "سانت كيتس ونيفيس",
    kp: "كوريا الشمالية",
    kr: "كوريا الجنوبية",
    kw: "الكويت",
    ky: "جزر كايمان",
    kz: "كازاخستان",
    la: "لاوس",
    lb: "لبنان",
    lc: "سانت لوسيا",
    li: "ليختنشتاين",
    lk: "سريلانكا",
    lr: "ليبيريا",
    ls: "ليسوتو",
    lt: "ليتوانيا",
    lu: "لوكسمبورغ",
    lv: "لاتفيا",
    ly: "ليبيا",
    ma: "المغرب",
    mc: "موناكو",
    md: "مولدوفا",
    me: "الجبل الأسود",
    mf: "سان مارتن",
    mg: "مدغشقر",
    mh: "جزر مارشال",
    mk: "مقدونيا الشمالية",
    ml: "مالي",
    mm: "ميانمار (بورما)",
    mn: "منغوليا",
    mo: "منطقة ماكاو الإدارية الخاصة",
    mp: "جزر ماريانا الشمالية",
    mq: "جزر المارتينيك",
    mr: "موريتانيا",
    ms: "مونتسرات",
    mt: "مالطا",
    mu: "موريشيوس",
    mv: "جزر المالديف",
    mw: "ملاوي",
    mx: "المكسيك",
    my: "ماليزيا",
    mz: "موزمبيق",
    na: "ناميبيا",
    nc: "كاليدونيا الجديدة",
    ne: "النيجر",
    nf: "جزيرة نورفولك",
    ng: "نيجيريا",
    ni: "نيكاراغوا",
    nl: "هولندا",
    no: "النرويج",
    np: "نيبال",
    nr: "ناورو",
    nu: "نيوي",
    nz: "نيوزيلندا",
    om: "عُمان",
    pa: "بنما",
    pe: "بيرو",
    pf: "بولينيزيا الفرنسية",
    pg: "بابوا غينيا الجديدة",
    ph: "الفلبين",
    pk: "باكستان",
    pl: "بولندا",
    pm: "سان بيير ومكويلون",
    pr: "بورتوريكو",
    ps: "الأراضي الفلسطينية",
    pt: "البرتغال",
    pw: "بالاو",
    py: "باراغواي",
    qa: "قطر",
    re: "روينيون",
    ro: "رومانيا",
    rs: "صربيا",
    ru: "روسيا",
    rw: "رواندا",
    sa: "المملكة العربية السعودية",
    sb: "جزر سليمان",
    sc: "سيشل",
    sd: "السودان",
    se: "السويد",
    sg: "سنغافورة",
    sh: "سانت هيلينا",
    si: "سلوفينيا",
    sj: "سفالبارد وجان ماين",
    sk: "سلوفاكيا",
    sl: "سيراليون",
    sm: "سان مارينو",
    sn: "السنغال",
    so: "الصومال",
    sr: "سورينام",
    ss: "جنوب السودان",
    st: "ساو تومي وبرينسيبي",
    sv: "السلفادور",
    sx: "سانت مارتن",
    sy: "سوريا",
    sz: "إسواتيني",
    tc: "جزر توركس وكايكوس",
    td: "تشاد",
    tg: "توغو",
    th: "تايلاند",
    tj: "طاجيكستان",
    tk: "توكيلو",
    tl: "تيمور - ليشتي",
    tm: "تركمانستان",
    tn: "تونس",
    to: "تونغا",
    tr: "تركيا",
    tt: "ترينيداد وتوباغو",
    tv: "توفالو",
    tw: "تايوان",
    tz: "تنزانيا",
    ua: "أوكرانيا",
    ug: "أوغندا",
    us: "الولايات المتحدة",
    uy: "أورغواي",
    uz: "أوزبكستان",
    va: "الفاتيكان",
    vc: "سانت فنسنت وجزر غرينادين",
    ve: "فنزويلا",
    vg: "جزر فيرجن البريطانية",
    vi: "جزر فيرجن التابعة للولايات المتحدة",
    vn: "فيتنام",
    vu: "فانواتو",
    wf: "جزر والس وفوتونا",
    ws: "ساموا",
    xk:"كوسوفو",
    ye: "اليمن",
    yt: "مايوت",
    za: "جنوب أفريقيا",
    zm: "زامبيا",
    zw: "زيمبابوي"
  },
});
const errorMap = ["رقم غير صحيح", "رمز دولة غير صحيح", "المُدخل أقصر من المتوقع", "المُدخل أطول من المتوقع", "رقم غير صحيح"];
input.addEventListener("change", () =>{
  console.log(countryCodeInput.getNumber().substring(1))
  console.log(countryCodeInput.isValidNumber())
  const msg = errorMap[countryCodeInput.getValidationError()] || "رقم غير صحيح";
  console.log(msg);
  console.log(countryCodeInput.getSelectedCountryData().dialCode)
})

var DateTime = luxon.DateTime;
var userLang = navigator.language || navigator.userLanguage; 
if(userLang.includes("ar")){
  document.getElementById("date").setAttribute("dir","rtl")
} else{
  document.getElementById("date").setAttribute("dir","ltr")
}
let locale = "ar"
const translations = {
  "en": {
    "app-title": "Departements List",
    "add-new": "Add new",
    "show-added": "Show Added",
    "search-box": {"attribute":"placeholder","search" : "Search"},
    "service-category-id": "Service Category ID",
    "cat-num": "Category No.",
    "arabic-name": "Arabic Name",
    "english-name": "English Name",
    "service-name-ar": "Service Name in Arabic",
    "service-name-en": "Service Name in English",
    "cat-name": "Category Name",
    "price": "Price",
    "price-no-vat":"Service Price w/o VAT",
    "vat":"VAT",  
    "vat-amount":"VAT Amount",
    "price-with-vat": "Price with VAT",
    "serial-num":"Serial Number",
    "data-submitted":"Data Has Been Submitted Successfully",
    "cancel" : "Cancel",
    "save" : "Save",
    "edit": "Edit",
    "delete": "Delete",
    "deleted":"Deleted",
    "confirm-deletion":"Confirm Deletion",
    "add-loc" :"Add Location",
    "location" : "Location",
    "locations" : "Locations",
    "servicesCat":{},
    "services":{},
    "locationsTrans":{},
  },
  "ar": {
    "app-title": "قائمة الأقسام",
    "add-new": "اضافة قسم",
    "show-added": "عرض الأقسم",
    "search-box": {"attribute":"placeholder","search" : "ابحث"},
    "service-category-id": "رقم الصنف",
    "cat-num": "رقم القسم",
    "arabic-name": "الاسم باللغة العربية",
    "english-name": "الاسم باللغة الانجليزية",
    "service-name-ar": "اسم الخدمة باللغة العربية",
    "service-name-en": "اسم الخدمة باللغة الإنجليزية",
    "cat-name": "اسم الصنف",
    "price": "السعر",
    "price-no-vat":"سعر الخدمة بدون الضريبة",
    "vat":"الضريبة",
    "vat-amount":"قيمة الضريبة",
    "price-with-vat": "السعر مع الضريبة",
    "serial-num":"الرقم التسلسلي",
    "data-submitted":"تم إرسال البيانات بنجاح",
    "cancel" : "إلغاء",
    "save" : "حفظ",
    "edit": "تعديل",
    "delete": "حذف",
    "deleted":"تم الحذف",
    "confirm-deletion":"تأكيد الحذف",
    "add-loc" :"اضافة منطقة",
    "location" : "منطقة",
    "locations" : "المناطق",
    "servicesCat":{},
    "services":{},
    "locationsTrans":{},
  },
};
// load user data 
try {
  document.getElementById("name").value = localStorage.getItem("name")
  if(localStorage.getItem("mobile")){
    countryCodeInput.setNumber("+"+ localStorage.getItem("mobile"))
  }
} catch (error) {
  console.log("new uesr")
}

document.getElementById("date").setAttribute("min", new Date().toLocaleDateString("fr-ca"))
const defaultLink2 = `https://nahl-platform.vercel.app/api/app/AM/general/${'33e0d05d-d771-46f4-a7e7-7c634b4e3a9e'}/form`
const acceptedHourdiff = 1;
const acceptedMindiff = 30;
var mydata = ""
let controllers = []
let services 
let serviceCategories
async function callContent(routText, callback,abortable = false){
  let signal = ''
  if (abortable) {
    if( controllers.length > 0 ){
    for (let i = 0; i < controllers.length; i++) {
      const element = controllers[i];

      element[0].abort()
    }
    controllers = []
    }
    const controller = new AbortController()
    signal = controller.signal
    controllers.push([controller, signal])
  }
  await new Promise(resolve => setTimeout(resolve, 1000)); 

	fetch(defaultLink +`?content=${routText}`, { // NOTE: defaultLink must exist in your environment
		   redirect: "follow",
		   method: "GET",
       ...(abortable && { signal }), 
		 }).then(async (response) => {
	
     let originalResponse = response
	
     let jsonresponse = await originalResponse.json()

		 
		  callback(jsonresponse);
	 }).catch(err => {
		 console.log("Error:" + err);
	 });
}
async function callContent2(routText, callback,abortable = false, retries=3){
  let signal = ''
  if (abortable) {
    if( controllers.length > 0 ){
    for (let i = 0; i < controllers.length; i++) {
      const element = controllers[i];
      element[0].abort()
    }
    controllers = []
    }
    const controller = new AbortController()
    signal = controller.signal
    controllers.push([controller, signal])
  }
  await new Promise(resolve => setTimeout(resolve, 1000)); // Sleep for 1 seconds (1000 milliseconds)

	fetch(defaultLink2 +`${routText}`, {
		   redirect: "follow",
		   method: "GET",
       ...(abortable && { signal }),
		 }).then(async (response) => {
      if (!response.ok) {
        if (retries > 0) {
          console.log("retry: ", retries)
          return callContent2(routText, callback, abortable, retries-1)
        }else {
          throw new Error('Network response was not ok');
        }
      }
		
     let originalResponse = response
	
     let jsonresponse = await originalResponse.json()
 
		 
		  callback(jsonresponse);
	 }).catch(err => {
		 console.log("Error:" + err);
     if(!err.message.includes("aborted")){
      setTimeout(()=>{
      if (retries > 0) {
          console.log("retry: ", retries)
          return callContent2(routText, callback, abortable, retries-1)
        }else {
          throw new Error('Network response was not ok');
        }
     }, 2000);
     }
	 });
}
// gets active locations
document.getElementById("page2-spinner").style.display = "block"
let nLocations = callContent2(`/locations`,(data) => {

  console.log(data);
   
    if(!data.success){

    }
    let locations = data.data
    let selectData = [{id:0, text:"test"}]
    for(let i=0; i<locations.length; i++){
        selectData[i] = {id:locations[i]["id"], text:locations[i]["TS_location_arabic_name"]}
      }
      selectData.sort((a, b) => a.id - b.id);
    $('.js-example-basic-single').select2({
          data:selectData,
          width: "90%",
      });
      $('#area').trigger('change')
    for(let i=0; i<locations.length; i++){
      translations.en["locationsTrans"][locations[i]["TS_location_english_name"].toLowerCase()] = locations[i]["TS_location_english_name"];
      translations.ar["locationsTrans"][locations[i]["TS_location_english_name"].toLowerCase()] = locations[i]["TS_location_arabic_name"]; 
    }
    document.getElementById("page2-spinner").style.display = "none"
})

var formData = [];
var nForm =  {
  date:'' ,
  time:'' ,
  location:'',
  service: '',
  serviceCount:'',
  serviceCat: '',
  customerM: '',
  customerN: '',
  paymentMethod:'',
  urlLocation:'',
  locationDescription:''
}
let day1 = dayjs()
day1 = DateTime.now()
let day2 = day1.plus({days:1})
let day3 = day1.plus({days:2})
let dates =[day1,day2,day3]
let weekdays = [];
weekdays[0] = "الأحد";
weekdays[1] = "الإثنين";
weekdays[2] = "الثلاثاء";
weekdays[3] = "الأربعاء";
weekdays[4] = "الخميس";
weekdays[5] = "الجمعة";
weekdays[6] = "السبت";
weekdays[7] = "الأحد";

let weekdaysEn = [];
weekdaysEn[0] = "Sunday";
weekdaysEn[1] = "Monday";
weekdaysEn[2] = "Tuesday";
weekdaysEn[3] = "Wednesday";
weekdaysEn[4] = "Thursday";
weekdaysEn[5] = "Friday";
weekdaysEn[6] = "Saturday";
let appointments = [[],[],[]]
let ActualTimes = [[],[],[]]
let timesLoaded = false;
document.getElementById('date').onchange = () => {
  document.getElementById('date').disabled = true;
  $("#time-contaier").empty()
  document.getElementById('time-container').innerHTML =''
  document.getElementById('time-container').innerHTML = `
  <div id="department-spinner" class="spinner-border" role="status" style="grid-column-start: span 3;justify-self: center;">
              <span class="sr-only">Loading...</span>
            </div>
            `
  ActualTimes = [[],[],[]]            
  appointments = [[],[],[]]
  timesLoaded = false;

  day1 = DateTime.fromISO(document.getElementById('date').value)
  day2 = day1.plus({days:1})
  day3 = day1.plus({days:2})
  let datesSet = [day1,day2,day3]

  for(let i = 1; i <= 3 ; i ++){
    document.getElementById(`day${i}`).innerText = weekdays[datesSet[i-1].weekday];
    document.getElementById(`day${i}date`).innerText = datesSet[i-1].toFormat('yyyy-MM-dd');
 
  }

  callContent2(`/appointments?startDate=${day1.toFormat('yyyy-MM-dd')}&location=${document.getElementById("area").value}&service=${document.getElementById("service").value}`, (data) => {

    // set loading 
    document.getElementById('time-container').innerHTML = `
  <div id="department-spinner" class="spinner-border" role="status" style="grid-column-start: span 3;justify-self: center;">
              <span class="sr-only">Loading...</span>
            </div>
            `
    appointments = [[],[],[]]
      let recievedDates = data.data.appointments; 

      console.log(data);
      let tempActualTimes = []
      for(let i = 0; i < recievedDates.length ; i ++){
        let x = DateTime.fromISO(recievedDates[i]['TS_appointment_date'], { setZone: true });
        let y = DateTime.fromISO(recievedDates[i]['TS_appointment_time'], { setZone: true });
        recievedDates[i]['TS_appointment_date'] = x.toISODate()
        recievedDates[i]['TS_appointment_time'] = y.toLocaleString(DateTime.TIME_SIMPLE).replace(" ", " ")
        tempActualTimes[i] = y.toFormat('hh:mm a')

      }
      console.log(day1.toFormat('yyyy-MM-dd'),day2.toFormat('yyyy-MM-dd'),day3.toFormat('yyyy-MM-dd'));
      console.log(recievedDates);

      for(let i = 0; i < recievedDates.length ; i ++){

        if (recievedDates[i]["TS_appointment_date"] == day1.toFormat('yyyy-MM-dd')){
          appointments[0].push(recievedDates[i]['TS_appointment_time'])
          ActualTimes[0].push(tempActualTimes[i])
        }else if (recievedDates[i]["TS_appointment_date"] == day2.toFormat('yyyy-MM-dd')){
          appointments[1].push(recievedDates[i]['TS_appointment_time'])
          ActualTimes[1].push(tempActualTimes[i])
        }else if (recievedDates[i]["TS_appointment_date"] == day3.toFormat('yyyy-MM-dd')){
          appointments[2].push(recievedDates[i]['TS_appointment_time'])
          ActualTimes[2].push(tempActualTimes[i])
        }
      }
      // Only render first day by default
      timesLoaded = true;
      timesSetter(0);
      document.getElementById('date').disabled = false;

  }, abortable = true )

}

document.getElementById('date').value = DateTime.now().toFormat('yyyy-MM-dd');

$("#area").on("change", () => {

  document.getElementById("page3-1-spinner").style.display = "block"
  document.getElementById("page3-2-spinner").style.display = "block"
  document.getElementById('serviceCat').innerHTML = ''
  document.getElementById('service').innerHTML = ''
  callContent2(`/services?location=${document.getElementById("area").value}`, (data) => {

      services = data.data.services
      serviceCategories = data.data.servicesCat

      const categoriesWithServices = {};

      services.forEach(service => {
        const categoryID = service.TS_category_id;
        if (!categoriesWithServices[categoryID]) {

          categoriesWithServices[categoryID] = {
            category: serviceCategories.find(cat => cat.TS_category_id === categoryID),
            services: [],
            locations: new Set()
          };
        }
        categoriesWithServices[categoryID].services.push(service);
        service.location.forEach(location => {
          categoriesWithServices[categoryID].locations.add(location);
        });
      });
      for (let j = 0; j < services.length; j++) {
        const element = services[j];
        translations.ar['services'][element.TS_service_english_name.toLowerCase()] = element.TS_service_arabic_name
        translations.en['services'][element.TS_service_english_name.toLowerCase()] = element.TS_service_english_name
      }
      for (let j = 0; j < serviceCategories.length; j++) {
        const element = serviceCategories[j];
        translations.ar['servicesCat'][element.TS_category_english_name.toLowerCase()] = element.TS_category_arabic_name
        translations.en['servicesCat'][element.TS_category_english_name.toLowerCase()] = element.TS_category_english_name
      }
      // now update the services and category based on the choosen location
      servicesDropdownLoader2(categoriesWithServices)
      document.getElementById("page3-1-spinner").style.display = "none"
      document.getElementById("page3-2-spinner").style.display = "none"
  }, abortable = true )
    // $('#date').trigger('change'); 
})

function timesSetter (index) {
  // change times here
    let timeContainer = document.getElementById("time-container");
    $("#time-container").empty()
    timeContainer.innerHTML = "";
    if(appointments[index].length == 0){
        document.getElementById('time-container').innerHTML = `
  <div id="department-spinner" class="" role="status" style="grid-column-start: span 3;justify-self: center;">
              <span class="color:">لا توجد مواعيد متاحة</span>
            </div>
            `
    }
 
    for (let y = 0; y < appointments[index].length; y++) {

        timeContainer.innerHTML += `<button onclick="choosedDate('${ActualTimes[index][y]}','${document.getElementById(`day${index+1}date`).innerText}',${4})" class="time-button" dir="ltr">
                    ${appointments[index][y]}
                </button>`;

}}

// set initial day labels
for(let i = 1; i <= 3 ; i ++){
  document.getElementById(`day${i}`).innerText = weekdays[dates[i-1].weekday];
  document.getElementById(`day${i}date`).innerText = dates[i-1].toFormat('yyyy-MM-dd');; 
}

$(document).ready(function() {});

$('#test').on('click', function(event) { 
  $('.select2').select2({width: '100%'});
})

/* =======================
   PAYMENT INTEGRATION HELPERS
   ======================= */
function isMadaSelected() {
  const checked = document.querySelector('input[name="payingMethod"]:checked');
  if (!checked) return false;
  const label = checked.closest('label');
  const img = label ? label.querySelector('img') : null;
  if (!img) return false;
  // Identify MADA radio by its image URL (no HTML change needed)
  return /MADA%20LOGO\.png/i.test(img.src) || /MADA\s*LOGO\.png/i.test(img.src);
}

function saveTelrSession(s) { sessionStorage.setItem('telr_req', JSON.stringify(s || {})); }
function readTelrSession() { try { return JSON.parse(sessionStorage.getItem('telr_req') || '{}'); } catch(e){ return {}; } }
function clearTelrSession() { sessionStorage.removeItem('telr_req'); }

async function startTelrPayment(orderPayload) {
  const errBox = document.getElementById('payError');
  if (errBox) errBox.style.display = 'none';
  try {
    const res = await fetch(`${APPS_SCRIPT_BASE}?path=createTelrPayment`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ order: orderPayload })
    });
    if (!res.ok) throw new Error('Network error');
    const data = await res.json();
    if (!data || !data.ok || !data.paymentUrl) {
      throw new Error(data && data.message ? data.message : 'Failed to create payment session');
    }
    saveTelrSession({ requestId: data.requestId, order_ref: data.order_ref, status: 'initiated' });
    window.location.href = data.paymentUrl;
  } catch (e) {
    if (errBox) {
      errBox.textContent = 'تعذر تهيئة الدفع. الرجاء المحاولة لاحقاً أو اختيار طريقة دفع مختلفة.';
      errBox.style.display = 'block';
    }
  }
}

(function handleTelrReturn(){
  const params = new URLSearchParams(window.location.search);
  const payStatus = params.get('pay_status');
  const orderRef = params.get('order_ref');

  if (!payStatus) return;

  const telr = readTelrSession();
  if (orderRef && telr && telr.order_ref === orderRef) {
    telr.status = payStatus;
    saveTelrSession(telr);
  }

  // Clean URL
  if (history.replaceState) {
    const clean = window.location.pathname + window.location.hash;
    history.replaceState(null, '', clean);
  }

  if (payStatus === 'success') {
    showOnly('page6');
  } else {
    showOnly('page5');
    // Try to surface error on page5 if container exists
    const fail = document.querySelector('#page5 #fail-alert-4');
    if (fail) {
      fail.style.display = 'block';
      fail.children[0].textContent = 'عملية الدفع فشلت. يرجى اختيار طريقة أخرى أو المحاولة مرة ثانية.';
    }
    clearTelrSession();
  }
})();

function showOnly(id){
  const pages = ['page1','page2','page3','page4','page5','pagePayment','page6','page7'];
  pages.forEach(pid => { const el = document.getElementById(pid); if (el) el.style.display = (pid===id?'flex':'none'); });
}

/* ====== NEXT BUTTONS (keep logic, with MADA branch on Page 5 and Terms modal on Page 6) ====== */
for (let i = 1; i < 7; i++) {
  if (i == 4) continue;
  let pb1 = document.getElementById(`page${i}-button`);
  let p1 = document.getElementById(`page${i}`);
  let p2 = document.getElementById(`page${i+1}`);

  if ( i == 2){
    pb1.onclick = async () => {
      let field1 = document.getElementById("area")
      if (field1.value == "" ){
        infoWindow.setPosition(map.getCenter());
        infoWindow.setContent("الرجاء تحديد الموقع");
        infoWindow.open(map);
        document.getElementById("page2-form").reportValidity()
        return
      }
      p1.classList.remove("fadeIn");
      p1.classList.add("fadeOut");
      p2.classList.remove("fadeOut");
      p2.classList.add("fadeIn");
      setTimeout(() => {
          p1.style.display = "none";
          p2.style.display = "flex";
      }, "1000")
      formData[0] = field1.value
      nForm.location = document.getElementById("area").value
    }
  } else if ( i == 3){
    pb1.onclick = () => {
      let field3 = document.getElementById("serviceCat")
      let field4 = document.getElementById("service")
      let serviceCount = document.getElementById("serviceCount")
      let payingMethod = ''
      let form = document.getElementById("page3-form")
      try {
        if(parseInt(serviceCount.value) <=0 || parseInt(serviceCount.value) >10 ){
          if(locale == "en"){ serviceCount.setCustomValidity("Must be between 1 and 10"); }
          else { serviceCount.setCustomValidity("لابد أن يكون بين 1 و 10"); }
          throw new Error("bad count")
        }
      } catch (error) {
        form.reportValidity()
        return
      }
      if (field3.value == "" || field4.value == "" ){
        if ( field3.value == ""){ field3.style.borderColor='red'; field3.style.borderWidth='thin'; }
        else{ field3.style.borderColor='green'; field3.style.borderWidth='thin'; }
        if ( field4.value == ""){ field4.style.borderColor='red'; field4.style.borderWidth='thin'; }
        else{ field4.style.borderColor='green'; field4.style.borderWidth='thin'; }
        return
      }else {
        field3.style.borderColor='green';
        field3.style.borderWidth='thin';
        field4.style.borderColor='green';
        field4.style.borderWidth='thin';
      }
      formData[5] = countryCodeInput.getNumber().substring(1)
      formData[6] = field3.value
      formData[7] = field4.value
      formData[8] = payingMethod

      nForm.customerN = document.getElementById("name").value.trim()
      nForm.serviceCat = document.getElementById("serviceCat").value
      nForm.service = document.getElementById("service").value
      nForm.serviceCount = serviceCount.value

      p1.classList.remove("fadeIn");
      p1.classList.add("fadeOut");
      p2.classList.remove("fadeOut");
      p2.classList.add("fadeIn");
      setTimeout(() => { p1.style.display = "none"; p2.style.display = "flex"; }, "1000")
    }
  } else if ( i == 5){
    pb1.onclick = () => {
      let field1 = document.getElementById("name")
      let field2 = document.getElementById("mobile")
      let payingMethod = ''
      let form = document.getElementById("page5-form")
      try {
        payingMethod = document.querySelector('input[name="payingMethod"]:checked').value;
        if(field1.value.trim() == ""){
          if(locale == "en"){ field1.setCustomValidity("Required field"); }
          else { field1.setCustomValidity("يُرجى ملئ هذا الحقل"); }
          throw new Error("no name")
        }
      } catch (error) {
        form.reportValidity()
        return
      }
      if (!checkNumberValidity() ){
          form.reportValidity()
          return
      }
      nForm.paymentMethod = payingMethod
      
      formData[4] = field1.value
      formData[5] = countryCodeInput.getNumber().substring(1)
      formData[8] = payingMethod
      
      nForm.customerN = document.getElementById("name").value.trim()
      nForm.customerM = countryCodeInput.getNumber().substring(1)

      // ===== PAYMENT BRANCH (MADA) =====
      if (isMadaSelected()) {
        // go to payment page and start Telr session
        const payPage = document.getElementById('pagePayment');
        p1.classList.remove("fadeIn"); p1.classList.add("fadeOut");
        setTimeout(() => { p1.style.display = "none"; payPage.style.display = "flex"; }, 600);
        startTelrPayment(nForm);
        const payCancel = document.getElementById('payCancel');
        if (payCancel) payCancel.onclick = () => { showOnly('page5'); };
        return;
      }
      // ================================

      p1.classList.remove("fadeIn");
      p1.classList.add("fadeOut");
      p2.classList.remove("fadeOut");
      p2.classList.add("fadeIn");
      setTimeout(() => { p1.style.display = "none"; p2.style.display = "flex"; }, "1000")
    }
  } 
  else if ( i == 6){
    pb1.onclick = () => {
      // Must have a chosen map position first
      if (position == "") {
        infoWindow.setPosition(map.getCenter());
        infoWindow.setContent("الرجاء تحديد الموقع");
        infoWindow.open(map);
        return;
      }

      // Open Terms modal
      const termsModalEl = document.getElementById('termsModal');
      const termsModal = new bootstrap.Modal(termsModalEl);
      const acceptCheckbox = document.getElementById('termsAccept');
      const confirmBtn = document.getElementById('confirmTerms');

      // reset state each time
      acceptCheckbox.checked = false;
      confirmBtn.disabled = true;

      acceptCheckbox.onchange = () => {
        confirmBtn.disabled = !acceptCheckbox.checked;
      };

      termsModal.show();

      // When confirmed, proceed with the original submit flow
      confirmBtn.onclick = () => {
        termsModal.hide();

        document.getElementById(`page${i}-return`).style.display = "none";
        pb1.style.display = "none";
        let pageSpinner = document.getElementById(`page${i}-spinner`);
        let failAlert = document.getElementById(`fail-alert-5`)
        failAlert.style.display = "none";
        pageSpinner.style.display = "flex"
        pageSpinner.children[0].style.display = "block"
        pageSpinner.children[1].style.display = "block"

        formData[1] = position
        nForm.urlLocation = position
        try {
          let x = document.getElementById("locationDescription");
          if(x.value.trim().length > 200 ){
            if(locale == "en"){ x.setCustomValidity("Description is too long"); }
            else { x.setCustomValidity("الوصف أطول من المتوقع"); }
            throw new Error("desc too long")
          }
        } catch (error) {
          document.getElementById("page6-form").reportValidity()
          document.getElementById(`page${i}-return`).style.display = "inline-block";
          pb1.style.display = "inline-block";
          pageSpinner.style.display = "none"
          pageSpinner.children[0].style.display = "none"
          pageSpinner.children[1].style.display = "none"
          return
        }          
        
        nForm.locationDescription = document.getElementById("locationDescription").value

        // Attach Telr session if exists
        const telr = readTelrSession();
        if (telr && telr.requestId) {
          nForm.telr_request_id = telr.requestId;
          nForm.telr_order_ref  = telr.order_ref;
          nForm.telr_status     = telr.status || 'unknown';
        }

        formData[9] = ""
        formData[10] = ""

        fetch(defaultLink2 +`${'/reserveAppointment'}`, {
          redirect: "follow",
          method: "POST",
          body: JSON.stringify(nForm)
        }).then(async (response) => {
            pageSpinner.style.display = 'none';
            if (!response.ok) {
              throw Object.assign(new Error('Custom error message'), { response });
            }
            response = await response.json()
            if (response.success){
              clearTelrSession(); // clear used Telr context

              let p1 = document.getElementById(`page${i}`);
              let p2 = document.getElementById(`page${i+1}`);
              p1.classList.remove("fadeIn");
              p1.classList.add("fadeOut");
              p2.classList.remove("fadeOut");
              p2.classList.add("fadeIn");
              setTimeout(() => {
                  p1.style.display = "none";
                  p2.style.display = "flex";
                  pageSpinner.style.display = "none"
                  if(confirm(`عزيزنا/عزيزتنا, ودك نتذكر بياناتك على هذا الجهاز لتسهيل الغسلات الجاية ؟`)){
                    localStorage.setItem("name", document.getElementById("name").value);
                    localStorage.setItem("mobile", countryCodeInput.getNumber().substring(1));
                  }else {
                    localStorage.removeItem("name")
                    localStorage.removeItem("mobile")
                  }
              }, "1000")
            }
        }).catch(async err => {
          console.log("Error:" + err.message);
          console.log(err.response);
          err.response =  await err.response.json()
          document.getElementById(`page${i}-return`).style.display = "inline-block";
          pb1.style.display = "inline-block";
          let p1 = document.getElementById(`page${i}`);
          p1.classList.remove("fadeIn");
          p1.classList.add("fadeOut");
          p1.style.display = "none"
          let p2 = document.getElementById(`page4`);
          p2.classList.remove("fadeOut");
          p2.classList.add("FadeIn");
          p2.style.display = "flex"
          let failAlert3 = document.getElementById(`fail-alert-3`)
          failAlert3.style.display = "block";
          if(locale == "en"){
            failAlert3.children[0].innerHTML = err.response.msgEN ? err.response.msgEN : "Unexpected error, Please contact us"
          }else if (locale == "ar") {
            failAlert3.children[0].innerHTML = err.response.msgAR ? err.response.msgAR : "عذرًا حصل خطأ غير متوقع الرجاء التواصل معنا"
          }           
          failAlert3.children[2].innerHTML = ""
          $('#date').trigger('change');
          setTimeout(() => {
              p1.style.display = "none";
              p2.style.display = "flex";
          }, "1000")
        });
      };
    }
  } else {
    pb1.onclick = () => {
      p1.classList.remove("fadeIn");
      p1.classList.add("fadeOut");
      p2.classList.remove("fadeOut");
      p2.classList.add("fadeIn");
      setTimeout(() => {
          p1.style.display = "none";
          p2.style.display = "flex";
      }, "1000")
    }
  }
}

/* back buttons */
for (let i = 3; i < 7; i++) {
  let pb1 = document.getElementById(`page${i}-return`);
  let p1 = document.getElementById(`page${i}`);
  let p2 = (i === 4) ? document.getElementById(`page2`) : document.getElementById(`page${i-1}`);
  pb1.onclick = () => {
      p1.classList.remove("fadeIn");
      p1.classList.add("fadeOut");
      p2.classList.remove("fadeOut");
      p2.classList.add("fadeIn");
      setTimeout(() => {
          p1.style.display = "none";
          p2.style.display = "flex";
      }, "1000")
  }
}
 
function resendData({submitFormData,pageSpinner,p1,p2,pb1,failAlert,failAlert3,failAlert5}){
  document.getElementById("resend-objects").style.display = "none"
  try {
    document.getElementById("page6-resend").remove()
  } catch (error) {}
  pageSpinner.style.display = "inline-block"
  failAlert.style.display = "none";
  callContent(`formSubmit&data=${submitFormData}`,(reply)=> {
    pageSpinner.style.display = 'none';
    if(reply.success){
      formData[10] = reply.signature
      startTimer(3*60,document.getElementById("resendTimer"))
    }else{
      failAlert.style.display = "block";
      failAlert.children[0].innerHTML = reply.msg
    }
  })
}
function choosedDate(time,date, i){
  formData[2] = date
  formData[3] = time
  nForm.date = date
  time = time.split(" ")
  let parsedTime = DateTime.fromFormat(time.join(" "), "h:mm a");
  nForm.time =  parsedTime.toFormat("HH:mm");
  let p1 = document.getElementById(`page${i}`);
  let p2 = document.getElementById(`page${i+1}`);
  p1.classList.remove("fadeIn");
  p1.classList.add("fadeOut");
  p2.classList.remove("fadeOut");
  p2.classList.add("fadeIn");
  setTimeout(() => {
      p1.style.display = "none";
      p2.style.display = "flex";
  }, "1000")
}

function checkUrlValidity() {
  const location = document.getElementById("googleMap");
  let reg = /^(https?:\/\/.)[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)$/g;
  let locationValue = location.value.trim()
  if(locationValue == "" || locationValue == undefined){
    if(locale == "en"){
      location.setCustomValidity("Please Enter a URL");
    }else if (locale == "ar") {
      location.setCustomValidity("الرجاء ادخال رابط الموقع بالشكل الصحيح");
    }
    return false;
  }
  const regTest = reg.test(locationValue)
  if(  regTest == false){
    if(locale == "en"){
      location.setCustomValidity("Please Enter a URL");
    }else if (locale == "ar") {
      location.setCustomValidity("الرجاء ادخال رابط الموقع بالشكل الصحيح");
    }
    return false;
  }
  return true;
}
function checkNumberValidity() {
  const number = document.getElementById("mobile");
  const phoneNumber = countryCodeInput.getNumber().substring(1);
  const region = countryCodeInput.getSelectedCountryData().dialCode

  if (isNaN(phoneNumber) || !countryCodeInput.isValidNumber() || phoneNumber == "" ) { 
    const msg = errorMap[countryCodeInput.getValidationError()] || "رقم غير صحيح";
    if(locale == "en"){
      number.setCustomValidity("Please enter a Valid a phone number");
    }else {
      number.setCustomValidity(msg);
    }
    return false;
  }
  if(region == "966"){
   if(countryCodeInput.getNumber().substring(4,6) == "05"){
    if(locale == "en"){
      number.setCustomValidity("Please enter a Valid a phone number");
    }else {
      number.setCustomValidity("الرجاء ادخال رقم الهاتف بطريقة صحيحة");
    }
    return false;
   } 
  }

  number.setCustomValidity("");
  return true;
}

function servicesDropdownLoader2(data) {
  let categoriesID = Object.keys(data)
  let categoriesNames = []
  for (id in categoriesID){
    if(locale == "en"){
      categoriesNames.push(data[categoriesID[id]].category.TS_category_english_name)
    }else if(locale == "ar"){
      categoriesNames.push(data[categoriesID[id]].category.TS_category_arabic_name)
    }
  } 
  add_dropdown_list(categoriesNames, categoriesID,"serviceCat", "disabled", "servicesCat")
  var parentElement = document.getElementById("service");
  parentElement.innerHTML=""
  document.getElementById('serviceCat').addEventListener('change',function(){
    let currentCategory = document.getElementById("serviceCat").value;
    let myServicesID = []
    let myServiceNames = []
    // Sort the services array by TS_service_id
    const sortedServices = data[currentCategory].services.sort((a, b) => a.TS_service_id - b.TS_service_id);

    for (let i = 0; i < sortedServices.length; i++) {
      const element = sortedServices[i];
      myServicesID.push(element.TS_service_id);
      
      if (locale === "en") {
        myServiceNames.push(element.TS_service_english_name);
      } else if (locale === "ar") {
        myServiceNames.push(element.TS_service_arabic_name);
      }
    }

    add_dropdown_list(myServiceNames,myServicesID,"service", "disabled", "services")
  })
  document.getElementById('service').addEventListener('change',function(){
        $('#date').trigger('change'); 
  })
  const event = new Event('change');
  document.getElementById('serviceCat').dispatchEvent(event);
}

function setValuesForByLookUp(arrdropdown_2){
  var tee = document.getElementById("serviceCat").value;
  var dependent_list = valueLookUp(arrdropdown_2,["Active",tee],[1,5],2) 
  var ar_list = valueLookUp(arrdropdown_2,["Active",tee],[1,5],3) 

  if(dependent_list.length!=0){
    add_dropdown_list(ar_list,dependent_list,"service", "disabled", "services")
  }
}

function add_dropdown_list(show_list,value_list,element_id,first_option_disabled, key=null){
  var parentElement = document.getElementById(element_id);
  parentElement.innerHTML="";
  var opti = document.createElement("option");
  opti.text = show_list[0];
  opti.value= value_list[0];
  if( key != null){
    opti.setAttribute("data-i18n-key", key)
  }
  opti.setAttribute("selected","selected");
  parentElement.appendChild(opti);
  for(var i=1; i<value_list.length;i++){
    var opt = document.createElement("option");
    opt.text = show_list[i];
    opt.value= value_list[i];
    if( key != null){
      opt.setAttribute("data-i18n-key", key)
    }
    parentElement.appendChild(opt);
  }
  const event = new Event('change');
  parentElement.dispatchEvent(event);
}
function valueLookUp(listOfLookup,lookupValuesList,indexLookupValuesList,targetIndex){
  if(listOfLookup.length!=0 ){
    var lookuped_list = []
    for (var c = 0; c < listOfLookup.length; c++) {
      var success = false;
      for (var s = 0; s < lookupValuesList.length; s++) {
        if (lookupValuesList[s] == listOfLookup[c][indexLookupValuesList[s]]) {
          success = true;
        } else {
          success = false;
          break;
        }
      }
      if (success == true) {
        lookuped_list.push(listOfLookup[c][targetIndex]);
      }
    }
    return lookuped_list;
  }else{
    return [];
  }
}
function getKeyByValue(object, value) { return Object.keys(object).find(key => object[key] === value); }

function handleSubmit(event) { event.preventDefault(); }
  
// ✅ Global Variables
let map, infoWindow, marker, polygon = null;
let position = "";
const prePosition = "https://www.google.com/maps/search/?api=1&query=";
let defaultLocation = { lat: 26.34165524787632, lng: 50.11524831545726 };
function myMap() {
  // ✅ Initialize Map
  map = new google.maps.Map(document.getElementById("googleMap"), {
    center: defaultLocation,
    zoom: 12,
    disableDoubleClickZoom: true,
  });

  infoWindow = new google.maps.InfoWindow();

  // ✅ Create Marker (initially at default location)
  marker = new google.maps.Marker({
    position: defaultLocation,
    map: map,
    draggable: true,
    title: "اضغط أو اسحب لتحديد الموقع",
  });

  // ✅ Dragging
  marker.addListener("dragend", function (e) {
    validateAndSetPosition(e.latLng);
  });

  // ✅ Click map
  map.addListener("click", function (e) {
    validateAndSetPosition(e.latLng);
  });

  // ✅ Double Click
  map.addListener("dblclick", function (e) {
    e.stop();
    validateAndSetPosition(e.latLng);
  });

  // ✅ Long Press (mobile)
  let pressTimer;
  map.addEventListener && map.addEventListener("mousedown", function (e) {
    pressTimer = setTimeout(() => validateAndSetPosition(e.latLng), 600);
  });
  map.addEventListener && map.addEventListener("mouseup", function () { clearTimeout(pressTimer); });

  map.addListener("touchstart", function (e) {
    pressTimer = setTimeout(() => validateAndSetPosition(e.latLng), 600);
  });
  map.addListener("touchend", function () { clearTimeout(pressTimer); });

  const dragHint = document.getElementById("drag-instructions");
  setTimeout(() => { if (dragHint) dragHint.style.display = "none"; }, 5000);
  map.addListener("dragstart", () => { if (dragHint) dragHint.style.display = "none"; });
}

// ✅ Update Position + Move Marker
function validateAndSetPosition(latLng) {
  if (polygon && !google.maps.geometry.poly.containsLocation(latLng, polygon)) {
    alert("⚠️ عذرًا، موقعك خارج نطاق الخدمة");
    position = "";
    infoWindow.setContent("🚫 موقع خارج الخدمة");
    infoWindow.open(map);
    return;
  }

  marker.setPosition(latLng);
  map.panTo(latLng);
  map.setZoom(17);
  position = `https://www.google.com/maps/search/?api=1&query=${latLng.lat()},${latLng.lng()}`;
  infoWindow.setContent("✅ تم تحديث موقعك هنا");
  infoWindow.open(map, marker);
}

function setBoundries() {
  const areaSelect = document.getElementById("area");
  const selectedArea = areaSelect.options[areaSelect.selectedIndex].text.trim();

  let APP_Location, polygonCoords;

  if (selectedArea === "العزيزية - الخبر") {
    APP_Location = {
      north: 26.237892901838705,
      south: 26.15102181049713,
      west: 50.090294685184475,
      east: 50.234894203935546,
    };
    polygonCoords = [
      { lng: 50.215045355428195, lat: 26.219724394350184 },
      { lng: 50.2135291654911,   lat: 26.1870383495685 },
      { lng: 50.137875179099595, lat: 26.069703060741347 },
      { lng: 50.10628808282646,  lat: 26.15001891083389 },
      { lng: 50.143828288837895, lat: 26.21660551929113 },
      { lng: 50.19603263782255,  lat: 26.21897351180097 },
    ];
  } else if (selectedArea === "أجيال - أرامكو") {
    APP_Location = {
      north: 26.289037271670438,
      south: 26.237817336683204,
      west: 50.05143566513406,
      east: 50.096905737932595,
    };
    polygonCoords = [
      { lng: 50.06256215323989, lat: 26.275519772515292 },
      { lng: 50.070562455580834, lat: 26.277608292466685 },
      { lng: 50.08514528516432,  lat: 26.257720425641132 },
      { lng: 50.06822454797902,  lat: 26.24524748257814 },
      { lng: 50.06115405632103,  lat: 26.262628935642045 },
      { lng: 50.05894452767791,  lat: 26.267950423932856 },
    ];
  } else if (selectedArea === "الدوحة و الدانة") {
    APP_Location = {
      north: 26.37969652644046, 
      south: 26.277002257490476, 
      west: 50.11899625151807, 
      east: 50.195753733969404, 
    };
    polygonCoords = [
      { lng: 50.11488540829821, lat: 26.341056543806932 }, 
      { lng: 50.136645122501264, lat: 26.353671078060277 }, 
      { lng: 50.14577577434936,  lat: 26.363004767230812 }, 
      { lng: 50.178697561294584,  lat: 26.3329268498157454 }, 
      { lng: 50.17972636713662,  lat: 26.31448441448552 },
      { lng: 50.16468008169681,  lat: 26.29799900302895 }, 
    ];
  } else {
    alert("⚠️ المنطقة غير معرفة، يرجى الاختيار الصحيح");
    return;
  }

  defaultLocation = {
    lat: (APP_Location.north + APP_Location.south) / 2,
    lng: (APP_Location.east + APP_Location.west) / 2,
  };

  if (polygon) polygon.setMap(map);

  polygon = new google.maps.Polygon({
    paths: polygonCoords,
    strokeColor: "#ff0000",
    strokeOpacity: 0.4,
    strokeWeight: 2,
    fillColor: "#00ff00",
    fillOpacity: 0.1,
  });
  polygon.setMap(map);

  map.setCenter(defaultLocation);
  map.setZoom(14);
  marker.setPosition(defaultLocation);
  position = `${prePosition}${defaultLocation.lat},${defaultLocation.lng}`;
}

function detectMyLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const userPos = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);

        if (polygon && !google.maps.geometry.poly.containsLocation(userPos, polygon)) {
          alert("⚠️ عذرًا، موقعك خارج نطاق الخدمة");
          return;
        }

        marker.setPosition(userPos);
        map.panTo(userPos);
        map.setZoom(17);

        position = `${prePosition}${pos.coords.latitude},${pos.coords.longitude}`;
        infoWindow.close();
      },
      () => handleLocationError(true)
    );
  } else {
    handleLocationError(false);
  }
}

document.addEventListener("DOMContentLoaded", function () {
  const locationBtn = document.getElementById("show-my-location");
  if (locationBtn) {
    locationBtn.addEventListener("click", detectMyLocation);
  }
});

function handleLocationError(browserHasGeolocation) {
  infoWindow.setPosition(map.getCenter());
  infoWindow.setContent(
    browserHasGeolocation
      ? "⚠️ تعذر الحصول على موقعك. يرجى السماح بالوصول للموقع."
      : "⚠️ جهازك لا يدعم تحديد الموقع."
  );
  infoWindow.open(map);
}

function startTimer(duration, display) {
  document.getElementById("resend-objects").style.display = "block"
  try { document.getElementById("page6-resend").remove() } catch (error) {}
  var timer = duration, minutes, seconds;
  var time_counter = setInterval(function () {
    minutes = parseInt(timer / 60, 10);
    seconds = parseInt(timer % 60, 10);

    minutes = minutes < 10 ? "0" + minutes : minutes;
    seconds = seconds < 10 ? "0" + seconds : seconds;
    display.textContent = minutes + ":" + seconds;
    timer = --timer 
    if (timer <0 ){
      clearInterval(time_counter)
      let timerElement = document.getElementById("resend-objects")
      let resendButton = document.createElement("button")
      resendButton.setAttribute("id","page6-resend") 
      resendButton.setAttribute("class","filter-button") 
      resendButton.setAttribute("type","button") 
      let resendSpan = document.createElement("span")
      resendSpan.textContent = "إعادة ارسال"
      resendButton.appendChild(resendSpan)
      timerElement.after(resendButton)
      timerElement.style.display = "none"
      resendButton.onclick = () => {
        resendData(mydata)
      }
      document.getElementById("page6-contact").style.display = "block";
    }
  }, 1000);
}

// ✅ دالة التحقق لرقم اللوحة
function validatePlateNumber(input) {
  const v = input.value.replace(/\D/g, '').slice(0, 4);
  input.value = v;
  if (v && !/^\d{1,4}$/.test(v)) {
    input.setCustomValidity("رقم اللوحة يجب أن يكون من 1 إلى 4 أرقام");
  } else {
    input.setCustomValidity("");
  }
}

function updateLocationDescription() {
  const carBrand = document.getElementById("carBrand").value || "";
  const carName = document.getElementById("carName").value || "";
  const plateNumber = document.getElementById("plateNumber").value || "";
  const description = [carBrand, carName, plateNumber].filter(Boolean).join(", ");
  document.getElementById("locationDescription").value = description;
}

// ✅ تنظيف رسالة الخطأ عند الكتابة + قصر الإدخال على أرقام حتى 4 أرقام
document.getElementById('plateNumber').addEventListener('input', function(){
  this.value = this.value.replace(/\D/g, '').slice(0,4);
  this.setCustomValidity('');
  updateLocationDescription();
});

// List of car brands
const carBrands = [
  "Acura", "Alfa Romeo", "Aston Martin", "Audi", "Bentley", "BMW", "Bugatti", "Buick", 
  "Cadillac", "Chevrolet", "Chrysler", "Citroën", "Dacia", "Daewoo", "Daihatsu", "Dodge", 
  "Ferrari", "Fiat", "Ford", "Genesis", "GMC", "Haval", "Holden", "Honda", "Hummer", 
  "Hyundai", "Infiniti", "Isuzu", "Jaguar", "Jeep", "Kia", "Koenigsegg", "Lada", 
  "Lamborghini", "Lancia", "Land Rover", "Lexus", "Lincoln", "Lotus", "Maserati", 
  "Maybach", "Mazda", "McLaren", "Mercedes-Benz", "Mercury", "MG", "Mini", "Mitsubishi", 
  "Nissan", "Opel", "Pagani", "Peugeot", "Plymouth", "Pontiac", "Porsche", "RAM", 
  "Renault", "Rolls-Royce", "Saab", "Saturn", "Scion", "Seat", "Skoda", "Smart", 
  "SsangYong", "Subaru", "Suzuki", "Tata", "Tesla", "Toyota", "Volkswagen", 
  "Volvo", "Wiesmann", "Zotye"
];

// Populate the car brand select dropdown
carBrands.sort().forEach(brand => {
  $('#carBrand').append(`<option value="${brand}">${brand}</option>`);
});

// Enable Select2 for search functionality
$(document).ready(function () {
  $('#carBrand').select2({
    placeholder: "Select a car brand",
    allowClear: true
  });
});

// Auto-transition from #page3 to #page4 after 5 seconds
;(function(){
  const page3 = document.getElementById('page3');
  const nextBtn = document.getElementById('page3-button');
  if (!page3 || !nextBtn) return;

  // Watch for style changes on page3
  const obs = new MutationObserver(() => {
    if (page3.style.display === 'flex') {
      setTimeout(() => nextBtn.click(), 5000);
    }
  });
  obs.observe(page3, { attributes: true, attributeFilter: ['style'] });
})();

document.getElementById("rebook")?.addEventListener("click", function () {
  window.location.href = "https://www.spongnsoap.com/";
});
</script>


<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBBHLoO038vsCovHN-SLUgAXqexlA2v0_4&callback=myMap&libraries=geometry" async defer></script>
</html>
