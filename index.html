<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Nahl • Rate Location</title>

  <!-- Fonts (Cairo for AR, Inter for EN) -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&family=Inter:wght@400;600;800&display=swap" rel="stylesheet"/>

  <style>
    :root {
      --bg: #f4f6f8;
      --card: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --primary: #2563eb;
      --primary-600: #1d4ed8;
      --accent: #F4CE14;
      --success: #16a34a;
      --danger: #dc2626;
      --border: #e5e7eb;
      --chip: #eef2ff;
      --chip-text: #1e40af;
      --shadow: 0 8px 24px rgba(0,0,0,.08);
      --radius: 16px;
    }
    [dir="ltr"] body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    [dir="rtl"] body { font-family: "Cairo", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    * { box-sizing: border-box; }
    body { margin: 0; background: var(--bg); color: var(--text); -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
    .wrap { max-width: 760px; margin: 0 auto; padding: 20px 16px 64px; }

    header.site { display: flex; align-items: center; gap: 12px; padding: 16px; margin: 8px 0 16px; background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); }
    .brand { width: 44px; height: 44px; border-radius: 10px; background: linear-gradient(135deg, var(--accent), #ffd95c); display: grid; place-items: center; font-weight: 800; color: #111827; }
    .title { font-size: 18px; font-weight: 800; }
    .subtitle { color: var(--muted); font-size: 13px; }

    .card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); padding: 16px; margin: 12px 0; }
    h2.section { font-size: 16px; margin: 0 0 10px; }
    .row { display: grid; gap: 12px; }
    @media (min-width: 640px) { .row.cols-2 { grid-template-columns: 1fr 1fr; } }

    label.lbl { display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; }
    .help { font-size: 12px; color: var(--muted); }

    textarea, select, input[type="text"], input[type="date"], input[type="number"] {
      width: 100%; padding: 12px 12px; border-radius: 12px; border: 1px solid var(--border);
      background: #fff; color: var(--text); font-size: 14px; outline: none;
    }
    textarea:focus, select:focus, input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,.12); }
    textarea { min-height: 110px; resize: vertical; }

    /* Stars */
    .stars { display: inline-flex; flex-direction: row-reverse; gap: 6px; }
    .stars input { display: none; }
    .stars label { cursor: pointer; font-size: 28px; line-height: 1; color: #c7ced9; transition: transform .05s ease; }
    .stars label:hover, .stars label:hover ~ label { color: #ffd95c; transform: scale(1.02); }
    .stars input:checked ~ label { color: #f7c948; }

    /* Chips */
    .chips { display: flex; flex-wrap: wrap; gap: 8px; }
    .chip {
      background: var(--chip); color: var(--chip-text); border: 1px dashed #c7d2fe;
      padding: 6px 10px; border-radius: 999px; font-size: 13px; cursor: pointer; user-select: none;
      transition: transform .05s ease, background .2s ease;
    }
    .chip.active { background: #dbeafe; border-style: solid; }
    .chip:active { transform: translateY(1px); }

    /* Likert */
    .likert { display: grid; gap: 6px; }
    .likert input[type="range"] { width: 100%; }

    /* Radios / toggles */
    .radio-row, .toggle-row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .radio { padding: 8px 12px; border: 1px solid var(--border); border-radius: 999px; cursor: pointer; }
    .radio input { margin-inline-end: .5rem; }

    /* Buttons */
    .btns { display: flex; gap: 10px; flex-wrap: wrap; }
    .btn { border: 1px solid transparent; padding: 12px 16px; border-radius: 12px; cursor: pointer; font-weight: 700; font-size: 14px; }
    .btn.primary { background: var(--primary); color: #fff; }
    .btn.primary:hover { background: var(--primary-600); }

    /* Toast */
    .toast { position: fixed; inset-inline: 16px; bottom: 16px; z-index: 50; display: none; padding: 12px 14px; border-radius: 12px; border: 1px solid var(--border); background: var(--card); box-shadow: var(--shadow); font-size: 14px; }
    .toast.show { display: block; }
    .toast.ok { border-color: #bbf7d0; }
    .toast.err { border-color: #fecaca; }

    footer.note { text-align: center; color: var(--muted); font-size: 12px; margin-top: 18px; }
    .lang-switch { margin-inline-start: auto; display:flex; gap:8px; align-items:center; }
    .lang-switch button { font-size: 12px; padding: 6px 10px; border-radius: 999px; border:1px solid var(--border); background:#fff; cursor:pointer; }
    .lang-switch button.active { border-color: var(--primary); color: var(--primary); }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Header -->
    <header class="site">
      <div class="brand" aria-hidden="true">N</div>
      <div>
        <div class="title" data-i18n="app_title">قيّم تجربتك</div>
        <div class="subtitle" data-i18n="app_subtitle">استبيان رضا الخدمة • Service satisfaction survey</div>
      </div>
      <div class="lang-switch" role="group" aria-label="Language">
        <button id="btnAr" class="active">عربي</button>
        <button id="btnEn">EN</button>
      </div>
    </header>

    <!-- Rating -->
    <section class="card">
      <h2 class="section" data-i18n="overall_rating">التقييم العام</h2>
      <div class="stars" role="radiogroup" aria-label="Rating">
        <input type="radio" id="star5" name="rating" value="5"><label for="star5" aria-label="5">★</label>
        <input type="radio" id="star4" name="rating" value="4"><label for="star4" aria-label="4">★</label>
        <input type="radio" id="star3" name="rating" value="3"><label for="star3" aria-label="3">★</label>
        <input type="radio" id="star2" name="rating" value="2"><label for="star2" aria-label="2">★</label>
        <input type="radio" id="star1" name="rating" value="1"><label for="star1" aria-label="1">★</label>
      </div>
      <p class="help" data-i18n="rating_help">اختر من نجمة إلى خمس نجوم • Choose 1–5 stars</p>
      <label class="lbl" for="reviewText" data-i18n="write_review">اكتب رأيك</label>
      <textarea id="reviewText" placeholder="اكتب رأيك هنا… / Write your review here…" aria-label="Review"></textarea>
    </section>

    <!-- Quick tags -->
    <section class="card">
      <h2 class="section" data-i18n="highlights">ما الذي أعجبك؟</h2>
      <div class="chips" id="chipsRow"></div>
      <p class="help" data-i18n="chips_help">انقر للإضافة أو الإزالة • Tap to add/remove</p>
    </section>

    <!-- Service context -->
    <section class="card">
      <h2 class="section" data-i18n="service_context">تفاصيل الخدمة</h2>
      <div class="row cols-2">
        <div>
          <label class="lbl" for="serviceSelect" data-i18n="service_received">الخدمة</label>
          <select id="serviceSelect"></select>
        </div>
        <div>
          <label class="lbl" for="vehicleSize" data-i18n="vehicle_size">حجم المركبة</label>
          <select id="vehicleSize"></select>
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <div>
          <label class="lbl" for="visitDate" data-i18n="visit_date">تاريخ الزيارة</label>
          <input type="date" id="visitDate"/>
        </div>
      </div>
    </section>

    <!-- Satisfaction details -->
    <section class="card">
      <h2 class="section" data-i18n="details_title">تفاصيل الرضا</h2>
      <div class="row cols-2">
        <div class="likert">
          <label class="lbl" for="qQuality" data-i18n="q_quality">جودة التنظيف</label>
          <input id="qQuality" type="range" min="1" max="5" step="1" value="4" />
          <span class="help" data-i18n="scale_1_5">1 سيئة جدًا ← 5 ممتازة</span>
        </div>
        <div class="likert">
          <label class="lbl" for="qSpeed" data-i18n="q_speed">سرعة الخدمة</label>
          <input id="qSpeed" type="range" min="1" max="5" step="1" value="4" />
          <span class="help" data-i18n="scale_1_5">1 بطيئة جدًا ← 5 سريعة جدًا</span>
        </div>
        <div class="likert">
          <label class="lbl" for="qStaff" data-i18n="q_staff">احترافية الموظفين</label>
          <input id="qStaff" type="range" min="1" max="5" step="1" value="4" />
          <span class="help" data-i18n="scale_1_5">1 سيئة جدًا ← 5 ممتازة</span>
        </div>
        <div class="likert">
          <label class="lbl" for="qValue" data-i18n="q_value">القيمة مقابل السعر</label>
          <input id="qValue" type="range" min="1" max="5" step="1" value="4" />
          <span class="help" data-i18n="scale_1_5">1 سيئة جدًا ← 5 ممتازة</span>
        </div>
      </div>
    </section>

    <!-- Would return + NPS -->
    <section class="card">
      <h2 class="section" data-i18n="loyalty_title">الولاء</h2>
      <div class="row cols-2">
        <div>
          <label class="lbl" data-i18n="would_return">هل ستعود مرة أخرى؟</label>
          <div class="radio-row" role="radiogroup">
            <label class="radio"><input type="radio" name="return" value="yes" checked> <span data-i18n="yes">نعم</span></label>
            <label class="radio"><input type="radio" name="return" value="no"> <span data-i18n="no">لا</span></label>
          </div>
        </div>
        <div>
          <label class="lbl" for="nps" data-i18n="nps_label">التوصية بنا (0–10)</label>
          <input id="nps" type="number" min="0" max="10" value="9" />
          <span class="help" data-i18n="nps_help">0 لن أوصي إطلاقًا ← 10 أوصي بقوة</span>
        </div>
      </div>
    </section>

    <!-- Optional contact -->
    <section class="card">
      <h2 class="section" data-i18n="followup_title">متابعة اختيارية</h2>
      <div class="row cols-2">
        <div>
          <label class="lbl" for="contactName" data-i18n="name">الاسم</label>
          <input type="text" id="contactName" placeholder="الاسم / Name"/>
        </div>
        <div>
          <label class="lbl" for="contactPhone" data-i18n="phone">الهاتف</label>
          <input type="text" id="contactPhone" placeholder="+9665XXXXXXXX"/>
        </div>
      </div>
      <div class="toggle-row" style="margin-top:10px">
        <label class="radio"><input type="checkbox" id="allowContact" checked/> <span data-i18n="allow_contact">أوافق على التواصل معي بشأن تقييمي</span></label>
      </div>
    </section>

    <!-- Actions -->
    <section class="card">
      <h2 class="section" data-i18n="actions_title">الإرسال</h2>
      <p class="help" data-i18n="actions_help">سيتم حفظ تقييمك لدينا فقط.</p>
      <div class="btns">
        <button id="btnSubmit" class="btn primary" data-i18n="btn_submit">حفظ التقييم</button>
      </div>
    </section>

    <footer class="note">
      <span data-i18n="footer_note">تصميم نحل • Nahl design • يعمل دون مكتبات خارجية</span>
    </footer>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    const DEBUG = false; // اجعله true أثناء التشخيص

    /* ===== Config & i18n ===== */
    const CONFIG = {
      // Not using Google; keep empty OR set a fixed label and add it to PLACE_IDS_ALLOWED in GAS if you enforce allowlist.
      // Example to enforce allowlist safely: set placeId to "LOCAL_SURVEY" here AND add it in GAS PLACE_IDS_ALLOWED.
      PLACE_ID: "",
      defaultLang: "ar",
      tags: [
        { ar: "السرعة", en: "Speed" },
        { ar: "الجودة", en: "Quality" },
        { ar: "السعر",  en: "Price" },
        { ar: "الموظفون", en: "Staff" },
        { ar: "دقة الوصول", en: "Punctual (Mobile)" },
        { ar: "نظافة الأدوات", en: "Clean tools" },
        { ar: "الحفاظ على الطلاء", en: "Gentle on paint" }
      ],
      services: [
        { ar: "غسيل خارجي", en: "Exterior wash" },
        { ar: "تنظيف داخلي", en: "Interior cleaning" },
        { ar: "تلميع", en: "Detailing" },
        { ar: "واكس", en: "Wax" },
        { ar: "تنظيف المحرك", en: "Engine cleaning" },
        { ar: "غسيل متنقل", en: "Mobile wash" },
        { ar: "أخرى", en: "Other" }
      ],
      vehicleSizes: [
        { ar: "صغير", en: "Small" },
        { ar: "متوسط", en: "Medium" },
        { ar: "كبير", en: "Large" },
        { ar: "دفع رباعي", en: "SUV" },
        { ar: "فان", en: "Van" }
      ]
    };

    const I18N = {
      ar: { app_title:"قيّم تجربتك", app_subtitle:"استبيان رضا الخدمة • Service satisfaction survey",
        overall_rating:"التقييم العام", rating_help:"اختر من نجمة إلى خمس نجوم • Choose 1–5 stars",
        write_review:"اكتب رأيك", highlights:"ما الذي أعجبك؟", chips_help:"انقر للإضافة أو الإزالة • Tap to add/remove",
        service_context:"تفاصيل الخدمة", service_received:"الخدمة", vehicle_size:"حجم المركبة", visit_date:"تاريخ الزيارة",
        details_title:"تفاصيل الرضا", q_quality:"جودة التنظيف", q_speed:"سرعة الخدمة", q_staff:"احترافية الموظفين", q_value:"القيمة مقابل السعر",
        scale_1_5:"1 سيئة جدًا ← 5 ممتازة", loyalty_title:"الولاء", would_return:"هل ستعود مرة أخرى؟",
        yes:"نعم", no:"لا", nps_label:"التوصية بنا (0–10)", nps_help:"0 لن أوصي إطلاقًا ← 10 أوصي بقوة",
        followup_title:"متابعة اختيارية", name:"الاسم", phone:"الهاتف", allow_contact:"أوافق على التواصل معي بشأن تقييمي",
        actions_title:"الإرسال", actions_help:"سيتم حفظ تقييمك لدينا فقط.",
        btn_submit:"حفظ التقييم", footer_note:"تصميم نحل • Nahl design • يعمل دون مكتبات خارجية",
        toast_saved:"تم الحفظ بنجاح", toast_error:"تعذّر الحفظ، حاول مرة أخرى",
        toast_missing_rating:"الرجاء اختيار التقييم بالنجوم",
        toast_missing_text:"الرجاء كتابة التقييم النصي"
      },
      en: { app_title:"Rate your experience", app_subtitle:"Service satisfaction survey",
        overall_rating:"Overall rating", rating_help:"Choose 1–5 stars", write_review:"Write a review",
        highlights:"What stood out?", chips_help:"Tap to add/remove", service_context:"Service details",
        service_received:"Service received", vehicle_size:"Vehicle size", visit_date:"Visit date",
        details_title:"Satisfaction details", q_quality:"Quality of cleaning", q_speed:"Speed of service",
        q_staff:"Staff professionalism", q_value:"Value for money", scale_1_5:"1 Very poor ← 5 Excellent",
        loyalty_title:"Loyalty", would_return:"Would you visit again?", yes:"Yes", no:"No",
        nps_label:"Recommend us (0–10)", nps_help:"0 Not at all likely ← 10 Extremely likely",
        followup_title:"Optional follow-up", name:"Name", phone:"Phone", allow_contact:"I agree to be contacted about my review",
        actions_title:"Submit", actions_help:"Your review will be saved locally.",
        btn_submit:"Save review", footer_note:"Nahl design • No external libraries",
        toast_saved:"Saved successfully", toast_error:"Save failed, please try again",
        toast_missing_rating:"Please choose a star rating",
        toast_missing_text:"Please write your review text"
      }
    };

    /* ===== DOM helpers (safe) ===== */
    const $  = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const el = (sel) => { const n=$(sel); if(!n && DEBUG) console.warn("Missing node:", sel); return n; };
    const val = (sel, fallback="") => { const n=el(sel); return (n && "value" in n) ? n.value : fallback; };

    function showToast(msg, ok=true){
      const t = el('#toast'); if (!t) return;
      t.textContent = msg;
      t.className = 'toast show ' + (ok ? 'ok' : 'err');
      setTimeout(()=> t.classList.remove('show'), 2500);
    }

    function getRating(){
      const r = $$('input[name="rating"]').find(i => i.checked);
      return r ? Number(r.value) : 0;
    }

    function setLang(lang){
      const dir = (lang === 'ar') ? 'rtl' : 'ltr';
      document.documentElement.lang = lang;
      document.documentElement.dir  = dir;
      el('#btnAr')?.classList.toggle('active', lang==='ar');
      el('#btnEn')?.classList.toggle('active', lang==='en');
      const dict = I18N[lang];
      $$('[data-i18n]').forEach(n => {
        const k = n.getAttribute('data-i18n');
        if (dict && dict[k]) n.textContent = dict[k];
      });
      hydrateOptions(lang);
    }

    function hydrateOptions(lang){
      // chips
      const chipsRow = el('#chipsRow');
      if (chipsRow){
        chipsRow.innerHTML = '';
        CONFIG.tags.forEach((t, idx) => {
          const b = document.createElement('button');
          b.type = 'button';
          b.className = 'chip';
          b.dataset.key = String(idx);
          b.textContent = t[lang];
          b.addEventListener('click', ()=> b.classList.toggle('active'));
          chipsRow.appendChild(b);
        });
      }

      // services
      const svc = el('#serviceSelect');
      if (svc){
        svc.innerHTML = '';
        CONFIG.services.forEach((o,i) => {
          const opt = document.createElement('option');
          opt.value = String(i);
          opt.textContent = o[lang];
          svc.appendChild(opt);
        });
        if (svc.options.length && svc.selectedIndex < 0) svc.selectedIndex = 0;
      }

      // vehicle sizes
      const vs = el('#vehicleSize');
      if (vs){
        vs.innerHTML = '';
        CONFIG.vehicleSizes.forEach((o,i) => {
          const opt = document.createElement('option');
          opt.value = String(i);
          opt.textContent = o[lang];
          vs.appendChild(opt);
        });
        if (vs.options.length && vs.selectedIndex < 0) vs.selectedIndex = 0;
      }
    }

    function collectPayload(){
      const lang = document.documentElement.lang || CONFIG.defaultLang;
      const rating = getRating();
      const text = val('#reviewText', '').trim();
      const chips = $$('.chip.active').map(ch => ch.textContent);

      // Safe reads with defaults
      let serviceIdx = val('#serviceSelect', '0');
      let sizeIdx    = val('#vehicleSize', '0');

      const service =
        CONFIG.services[serviceIdx] ? CONFIG.services[serviceIdx][lang] :
        (CONFIG.services[0] ? CONFIG.services[0][lang] : '');

      const vehicleSize =
        CONFIG.vehicleSizes[sizeIdx] ? CONFIG.vehicleSizes[sizeIdx][lang] :
        (CONFIG.vehicleSizes[0] ? CONFIG.vehicleSizes[0][lang] : '');

      return {
        ts: new Date().toISOString(),
        lang,
        placeId: "", // not used (keep empty unless you configure GAS allowlist)
        rating,
        reviewText: text,
        tags: chips,
        service,
        vehicleSize,
        visitDate: val('#visitDate', '') || null,
        q: {
          quality: Number(val('#qQuality', 0)),
          speed:   Number(val('#qSpeed',   0)),
          staff:   Number(val('#qStaff',   0)),
          value:   Number(val('#qValue',   0)),
        },
        wouldReturn: $$('input[name="return"]').find(r => r.checked)?.value || 'yes',
        nps: Number(val('#nps', 0)),
        contact: {
          name:  val('#contactName', '').trim(),
          phone: val('#contactPhone', '').trim(),
          allow: !!el('#allowContact')?.checked
        }
      };
    }

    // Same-origin proxy call (Next.js: /api/gas-proxy)
    async function saveToGAS(payload){
      const res = await fetch("/api/gas-proxy", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const raw = await res.text();
      let json; try { json = JSON.parse(raw); }
      catch { json = { ok:false, error:"bad_json", raw: raw ? raw.slice(0,500) : "" }; }
      return { status: res.status, ...json };
    }

    function validate(){
      const rating = getRating();
      const txt = val('#reviewText','').trim();
      if (!rating){ showToast(I18N[document.documentElement.lang].toast_missing_rating, false); return false; }
      if (!txt){ showToast(I18N[document.documentElement.lang].toast_missing_text, false); return false; }
      return true;
    }

    async function onSubmit(){
      if (!validate()) return;
      const btn = el('#btnSubmit');
      if (btn){ btn.disabled = true; btn.textContent = document.documentElement.lang==='ar' ? 'جارٍ الحفظ…' : 'Saving…'; }
      const lang = document.documentElement.lang;

      try{
        const payload = collectPayload();
        const result = await saveToGAS(payload);
        if (result && result.ok){
          showToast(I18N[lang].toast_saved, true);
          const checked = $('input[name="rating"]:checked'); if (checked) checked.checked = false;
          const rt = el('#reviewText'); if (rt) rt.value = '';
          $$('.chip.active').forEach(ch => ch.classList.remove('active'));
        } else {
          const fallback = I18N[lang].toast_error;
          const detail = result && result.error ? result.error : '';
          showToast(fallback + (detail ? ` • ${detail}` : ''), false);
          if (DEBUG) console.error("Save error:", result);
        }
      } catch(err){
        if (DEBUG) console.error(err);
        showToast(I18N[lang].toast_error, false);
      } finally {
        if (btn){ btn.disabled = false; btn.textContent = I18N[lang].btn_submit; }
      }
    }

    (function init(){
      el('#btnAr')?.addEventListener('click', ()=> setLang('ar'));
      el('#btnEn')?.addEventListener('click', ()=> setLang('en'));

      // First hydrate then translate (setLang re-hydrates with localized labels)
      hydrateOptions(CONFIG.defaultLang);
      setLang(CONFIG.defaultLang);

      // Default visit date = today
      const v = el('#visitDate');
      if (v) v.value = new Date().toISOString().slice(0,10);

      el('#btnSubmit')?.addEventListener('click', onSubmit);
    })();
  </script>
</body>
</html>
