<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>حجوزات المواعيد</title>

  <!-- UI libs -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800&display=swap" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/css/intlTelInput.css" rel="stylesheet"/>

  <style>
    :root{
      --brand-700:#015a6c; --brand-600:#027A93; --brand-200:#BFE6F0; --brand-050:#F0FAFC;
      --ink-900:#0B2630; --ink-700:#224652;
      --surface-000:#fff; --border-300:#D4E0E6;

      --radius-md:14px; --radius-pill:999px;
      --shadow-xs:0 2px 6px rgba(11,38,48,.08);
      --shadow-sm:0 3px 12px rgba(11,38,48,.12);
      --shadow-md:0 10px 28px rgba(11,38,48,.16);

      --ease:cubic-bezier(.22,.61,.36,1);
      --ease-decel:cubic-bezier(0.2,0,0,1);
      --ease-accel:cubic-bezier(0.3,1,0.8,1);
      --dur-xs:160ms; --dur-sm:220ms; --dur-md:460ms;

      --fs-xxl:1.6rem; --fs-xl:1.375rem; --fs-md:1rem; --fs-sm:.9rem; --fw-bold:800;
      --sp-2:8px; --sp-3:12px; --sp-4:16px; --sp-5:20px; --sp-6:24px; --sp-7:32px;

      --header-h:120px;
      --footer-h:96px;

      --card-alpha:.86; --card-blur:8px; --card-border:rgba(255,255,255,.55);
    }
    @media (max-width:640px){ :root{ --footer-h: calc(118px + env(safe-area-inset-bottom)); } }

    html,body{height:100%; min-height:100vh;}
    @supports (height:100dvh){ html,body{min-height:100dvh;} }

    body{
      margin:0; font-family:'Cairo',sans-serif;
      display:flex; flex-direction:column;
      padding-top:var(--header-h); padding-bottom:var(--footer-h);
      color:#fff; background:#0b2630;
    }

    /* Fullscreen step background */
    #bgStage{
      position:fixed; inset:0; z-index:-1;
      background-position:center; background-size:cover; background-repeat:no-repeat;
      width:100%; height:100vh; background-attachment:fixed;
    }
    @supports (height:100dvh){ #bgStage{height:100dvh;} }
    @media (max-width:768px){ #bgStage{background-attachment:scroll;} }
    #bgStage::after{content:""; position:absolute; inset:0; background:linear-gradient(180deg, rgba(11,38,48,.58), rgba(11,38,48,.34));}

    /* Header */
    header{position:sticky; top:0; z-index:50; background:rgba(11,38,48,.42); backdrop-filter:blur(10px); border-bottom:1px solid rgba(255,255,255,.18); padding-top:env(safe-area-inset-top);}
    .header-inner{max-width:1120px; width:100%; padding:10px var(--sp-3) 12px; display:flex; flex-direction:column; gap:10px;}
    .header-top{ display:flex; align-items:center; justify-content:space-between; gap:12px; }

    /* Brand (logo without frame) */
    .brand{ display:flex; align-items:center; justify-content:flex-end; flex:0 0 auto; }
    .brand img{
      height:92px; width:auto; object-fit:contain; display:block;
      filter: drop-shadow(0 6px 18px rgba(0,0,0,.35)) drop-shadow(0 2px 6px rgba(0,0,0,.25));
    }
    @media (max-width:640px){ .brand img{height:84px} }

    .mini-progress{display:flex; align-items:center; gap:var(--sp-3); flex:1}
    .mini-progress .bar{flex:1; height:8px; background:rgba(255,255,255,.25); border-radius:999px; overflow:hidden}
    .mini-progress .bar>span{display:block; height:100%; width:0%; background:linear-gradient(90deg, var(--brand-600), var(--brand-200)); transition:width var(--dur-md) var(--ease-decel)}
    .mini-progress .step{font-weight:var(--fw-bold); font-size:var(--fs-md)}

    /* Summary chips (under progress) */
    .header-summary{ display:flex; justify-content:center }
    .summary-bar{ display:flex; gap:8px; align-items:center; width:100%; max-width:1120px; background:transparent; border:0; box-shadow:none; flex-wrap:wrap; }
    .summary-bar .chip{ display:inline-flex; align-items:center; gap:6px; background:#fff; border:1px solid var(--border-300); border-radius:999px; padding:6px 10px; font-size:.88rem; color:#0B2630; white-space:nowrap; box-shadow:var(--shadow-xs); }
    .summary-bar i{opacity:.85}
    @media (max-width:560px){
      .summary-bar{ gap:6px }
      .summary-bar .chip{ flex:1 1 calc(50% - 6px); min-width:0; padding:6px 8px; font-size:.82rem; justify-content:center }
      .summary-bar .chip b{ display:inline-block; max-width:12ch; overflow:hidden; text-overflow:ellipsis }
    }
    @media (min-width:561px){ .summary-bar{ flex-wrap:nowrap; overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:none } .summary-bar::-webkit-scrollbar{ display:none } }

    /* Main & pages */
    main{flex:1 0 auto; display:flex; justify-content:center; padding:var(--sp-2) var(--sp-3) 0}
    #app{width:100%; max-width:1120px}
    .stage{position:relative; min-height:540px; padding:8px 0 20px}
    .page{position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; gap:var(--sp-5); padding:var(--sp-5) var(--sp-3) var(--sp-6); overflow:auto; opacity:0; transform:translateY(12px) scale(.992); pointer-events:none;}
    .page.active{animation:pageIn var(--dur-md) var(--ease-decel) both; pointer-events:auto}
    .page.exit{animation:pageOut var(--dur-sm) var(--ease-accel) both}
    @keyframes pageIn{ from{opacity:0; transform:translateY(12px) scale(.992)} to{opacity:1; transform:translateY(0) scale(1)} }
    @keyframes pageOut{ from{opacity:1; transform:translateY(0) scale(1)} to{opacity:0; transform:translateY(14px) scale(.985)} }
    .page h1{font-size:var(--fs-xl); font-weight:var(--fw-bold); margin:0; text-align:center; color:var(--ink-900)}

    /* Cards (glass) */
    .card{
      position:relative;
      background: rgba(255,255,255, var(--card-alpha));
      color:var(--ink-900);
      border-radius:var(--radius-md);
      box-shadow: 0 10px 28px rgba(11,38,48,.16);
      padding:var(--sp-6);
      width:100%; max-width:920px;
      backdrop-filter: blur(var(--card-blur)) saturate(1.05);
      -webkit-backdrop-filter: blur(var(--card-blur)) saturate(1.05);
      border: 1px solid var(--card-border);
    }
    .card.solid{ background:#fff !important; backdrop-filter:none !important; -webkit-backdrop-filter:none !important; border-color:#D4E0E6 !important; }

    .form-control, select, .select2-selection{
      background:#ffffff; color:var(--ink-900);
      border:1px solid var(--border-300) !important; border-radius:var(--radius-md)!important;
      min-height:48px; text-align:center; font-size:var(--fs-md);
      transition:border-color var(--dur-xs) var(--ease), box-shadow var(--dur-xs) var(--ease);
    }
    .form-control::placeholder{color:#6b7280}
    .form-control:focus{ border-color:#0891b2 !important; box-shadow:0 0 0 4px rgba(8,145,178,.2) }

    /* Field errors & notes */
    .field-msg{ margin-top:6px; font-size:.85rem; color:#dc2626; min-height:1.2em; }
    .is-invalid{ border-color:#dc2626 !important; box-shadow:0 0 0 3px rgba(220,38,38,.15) !important; }
    .field-note{ margin-top:6px; font-size:.86rem; padding:8px 10px; border-radius:10px; display:none; align-items:center; gap:8px }
    .note-info{ background:#E6F4F7; border:1px solid #B3E0EA; color:#0B2630; display:flex }
    .field-note i{ opacity:.8 }

    /* Select2 – high contrast */
    .select2-container--default .select2-selection--single{ background:#ffffff !important; border:1px solid var(--border-300) !important; border-radius:var(--radius-md)!important; }
    .select2-container--default .select2-selection--single .select2-selection__rendered{ color:#0B2630 !important; line-height:48px !important; padding-inline:42px 42px !important; }
    .select2-container--default .select2-selection--single .select2-selection__placeholder{ color:#667085 !important; }
    .select2-container--default.select2-container--focus .select2-selection--single{ border-color:#0891b2 !important; box-shadow:0 0 0 4px rgba(8,145,178,.2) !important; }
    .select2-container--default .select2-selection--single .select2-selection__arrow{ height:48px !important; }
    .select2-container--default .select2-selection--single .select2-selection__arrow b{ border-color:#0B2630 transparent transparent transparent !important; }
    .select2-dropdown{ background:#fff !important; color:#0B2630 !important; border:1px solid var(--border-300) !important; box-shadow:var(--shadow-sm); }
    .select2-container--default .select2-results__option{ color:#0B2630 !important; background:#fff !important; padding:10px 12px; }
    .select2-results__options{max-height:280px}
    .select2-container--default .select2-results__option--highlighted[aria-selected],
    .select2-container--default .select2-results__option--highlighted{ background:#DDF2F7 !important; color:#0B2630 !important; }

    /* Time grid */
    .time-grid{display:grid; grid-template-columns:repeat(2,1fr); gap:var(--sp-4)}
    @media (min-width:540px){ .time-grid{grid-template-columns:repeat(3,1fr)} }
    .time-option{ background:#fff; color:#0B2630; font-weight:var(--fw-bold); border:1px solid var(--border-300); border-radius:var(--radius-md); padding:14px 10px; min-height:56px; box-shadow:var(--shadow-xs); transition:transform var(--dur-xs) var(--ease), box-shadow var(--dur-xs) var(--ease), background var(--dur-xs) var(--ease); display:flex; flex-direction:column; align-items:center; justify-content:center; }
    .time-option:hover{transform:translateY(-2px); background:var(--brand-050); box-shadow:var(--shadow-sm)}
    .time-option[aria-checked="true"]{outline:3px solid var(--brand-600); outline-offset:2px}

    /* Overlays */
    .load-overlay{ position:absolute; inset:0; background:rgba(255,255,255,.9); color:#0B2630; display:none; align-items:center; justify-content:center; gap:12px; border-radius:var(--radius-md); }
    .load-overlay.show{display:flex; animation:fadeIn var(--dur-sm) var(--ease) both}
    @keyframes fadeIn{ from{opacity:0} to{opacity:1} }

    /* Payment — adjusted sizing */
    .pay-grid{
      display:grid; gap:var(--sp-4); width:100%; max-width:920px;
      grid-template-columns: 1fr;
    }
    @media (min-width:560px){ .pay-grid{ grid-template-columns: 1fr 1fr; } }
    @media (min-width:900px){ .pay-grid{ grid-template-columns: 1fr 1fr 1fr; } }

    .pay-card{
      background:#fff; color:#0B2630; border:1px solid var(--border-300); border-radius:var(--radius-md);
      padding:22px; display:flex; justify-content:center; align-items:center; gap:var(--sp-4);
      min-height:88px; cursor:pointer; transition:transform var(--dur-xs) var(--ease), box-shadow var(--dur-xs) var(--ease), background var(--dur-xs) var(--ease);
    }
    .pay-card:hover{transform:translateY(-2px); box-shadow:var(--shadow-sm); background:var(--brand-050)}
    .pay-card[aria-checked="true"]{outline:3px solid var(--brand-600); outline-offset:2px}
    .pay-card img{ max-height:38px; width:auto; object-fit:contain; }

    /* Footer (bigger on mobile) */
    footer.sticky-nav{ position:sticky; bottom:0; z-index:40; background:rgba(11,38,48,.62); backdrop-filter:blur(10px); border-top:1px solid rgba(255,255,255,.22); display:flex; align-items:center; justify-content:center; min-height:var(--footer-h); }
    .footer-inner{ max-width:1120px; width:100%; padding:12px 12px calc(10px + env(safe-area-inset-bottom)); display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap }
    .footer-left{display:flex; align-items:center; gap:12px; flex:0 0 auto}
    .footer-brand a{ font-size:.98rem; color:#fff; opacity:.98; text-decoration:none; font-weight:800 }
    .footer-social{ display:flex; gap:10px; align-items:center }
    .footer-social a{ color:#fff; opacity:.95; text-decoration:none; display:inline-flex; align-items:center; justify-content:center; width:38px; height:38px; border-radius:50%; border:1px solid rgba(255,255,255,.28); }
    .footer-social a:hover{ opacity:1; box-shadow:0 2px 10px rgba(0,0,0,.18) }
    .footer-actions{display:flex; gap:12px; flex:1; justify-content:flex-end}
    .btn-footer{ flex:0 0 auto; border:1px solid rgba(255,255,255,.28); border-radius:16px; padding:12px 18px; min-height:54px; font-size:1rem; font-weight:var(--fw-bold); background:#ffffff; color:#015a6c; transition:transform var(--dur-xs) var(--ease), box-shadow var(--dur-xs) var(--ease); }
    .btn-footer:hover{transform:translateY(-2px); box-shadow:var(--shadow-sm)}
    .btn-footer.primary{background:#015a6c; color:#fff; border-color:#015a6c}
    .btn-footer.hidden{display:none !important}
    .btn-footer.disabled, .btn-footer:disabled{opacity:.6; pointer-events:none}
    @media (max-width:640px){
      .footer-left{ width:100%; justify-content:space-between; }
      .footer-actions{ order:3; width:100%; justify-content:space-between; gap:10px }
      .btn-footer{ flex:1 1 48%; min-height:60px; font-size:1.06rem; }
      .footer-social a{ width:42px; height:42px; }
    }

    /* PPT deck */
    .ppt-deck{ position:relative; width:100%; max-width:860px; min-height:220px; margin:8px auto 0; overflow:hidden; border-radius:14px; background:linear-gradient(180deg, rgba(255,255,255,.92), rgba(244,250,252,.92)); border:1px solid rgba(255,255,255,.55); box-shadow:var(--shadow-md); }
    .ppt-slide{ position:absolute; inset:0; padding:28px 18px; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; opacity:0; transform:translateY(10px) scale(.995); }
    .ppt-slide h2{ font-size:var(--fs-xxl); font-weight:800; color:var(--ink-900); margin:0 0 8px; letter-spacing:.2px }
    .ppt-slide p{ font-size:1.05rem; color:#33545f; margin:0; opacity:.92 }
    .ppt-slide.is-active{ animation:pptIn var(--dur-md) var(--ease-decel) both; }
    .ppt-slide.is-exiting{ animation:pptOut var(--dur-sm) var(--ease-accel) both; }
    @keyframes pptIn{ from{opacity:0; transform:translateY(14px) scale(.985)} to{opacity:1; transform:none} }
    @keyframes pptOut{ from{opacity:1; transform:none} to{opacity:0; transform:translateY(-12px) scale(.992)} }

    /* Thank you */
    .success-hero{display:flex;flex-direction:column;align-items:center;gap:14px;margin-bottom:10px}
    .success-icon{width:92px;height:92px;border-radius:50%;background:linear-gradient(135deg,var(--brand-600),#12b3cf);box-shadow:0 10px 24px rgba(2,122,147,.25), inset 0 0 0 6px rgba(255,255,255,.35);position:relative}
    .success-icon::after{content:"\f00c";font-family:"Font Awesome 6 Free";font-weight:900;color:#fff;position:absolute;inset:0;display:grid;place-items:center;font-size:40px;transform:scale(.7);opacity:0;animation:popIn .5s var(--ease-decel) .1s forwards}
    @keyframes popIn{to{transform:scale(1);opacity:1}}
    .thanks-title{font-size:1.35rem;font-weight:800;color:#0b2630;margin:0}
    .thanks-copy{color:#33545f;margin:0;opacity:.95}
    .rebook-btn{display:inline-flex;align-items:center;gap:10px;justify-content:center;background:linear-gradient(135deg,var(--brand-600),var(--brand-700));color:#fff;border:0;border-radius:999px;padding:14px 24px;min-height:52px;font-weight:800;font-size:1.05rem;letter-spacing:.2px;box-shadow:0 10px 24px rgba(2,122,147,.28);transition:transform var(--dur-xs) var(--ease), box-shadow var(--dur-xs) var(--ease), filter var(--dur-xs) var(--ease)}
    .rebook-btn:hover{transform:translateY(-2px);box-shadow:var(--shadow-sm);filter:saturate(1.05)}

    /* Phone input adjustments */
    .iti{ width:100% !important; }
    #mobile.form-control{ height:48px; line-height:48px; direction:ltr; text-align:left; }
    html[dir="rtl"] .iti--allow-dropdown .iti__flag-container{ right:12px; left:auto; }
    html[dir="rtl"] .iti--separate-dial-code .iti__selected-flag{ right:12px; left:auto; border-right:1px solid var(--border-300); }
    html[dir="rtl"] .iti--allow-dropdown input#mobile,
    html[dir="rtl"] .iti--separate-dial-code input#mobile{ padding-right:108px; padding-left:12px; }
    .iti__country-list{ text-align:right; }
    .iti__selected-flag{ background-color:transparent !important; padding:0 10px; }
    .iti__arrow{ border-top-color:#0B2630 !important; }
  </style>

  <!-- Logo fallback -->
  <script>
    function handleLogoError(img){
      var fallbacks = [
        "https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/NahlTimeProFrom/ChatGPT%20Image%20Sep%2013,%202025,%2001_21_33%20PM.png",
        "https://dummyimage.com/240x92/027A93/ffffff.png&text=Nahl.app"
      ];
      var i = Number(img.dataset.fidx||0);
      if (i < fallbacks.length){ img.dataset.fidx = String(i+1); img.src = fallbacks[i]; }
      else { img.style.display = 'none'; }
    }
  </script>
</head>
<body>
  <!-- Fullscreen step background -->
  <div id="bgStage" aria-hidden="true"></div>

  <!-- Toasts -->
  <div id="toastWrap" style="position:fixed;top:10px;left:50%;transform:translateX(-50%);z-index:1050;display:flex;flex-direction:column;gap:8px" aria-live="polite" aria-atomic="true"></div>

  <!-- Header -->
  <header id="siteHeader">
    <div class="header-inner">
      <div class="header-top">
        <div class="mini-progress" aria-hidden="true">
          <div class="bar"><span id="miniBarFill" style="width:0%"></span></div>
          <div class="step" id="miniStepTitle">الترحيب</div>
        </div>
        <div class="brand">
          <img id="brandLogo" alt="Nahl" src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/NahlTimeProFrom/ChatGPT%20Image%20Sep%2013,%202025,%2001_21_33%20PM.png" loading="eager" decoding="async" fetchpriority="high" onerror="handleLogoError(this)"/>
        </div>
      </div>

      <div class="header-summary">
        <div id="bookingSummary" class="summary-bar" aria-live="polite" role="list">
          <span class="chip" data-sum-chip="area"    role="listitem"><i class="fa-solid fa-location-dot"></i> <b id="sumArea">—</b></span>
          <span class="chip" data-sum-chip="service" role="listitem"><i class="fa-solid fa-screwdriver-wrench"></i> <b id="sumService">—</b></span>
          <span class="chip" data-sum-chip="date"    role="listitem"><i class="fa-regular fa-calendar"></i>   <b id="sumDate">—</b></span>
          <span class="chip" data-sum-chip="time"    role="listitem"><i class="fa-regular fa-clock"></i>      <b id="sumTime">—</b></span>
          <span class="chip" data-sum-chip="pay"     role="listitem"><i class="fa-regular fa-credit-card"></i> <b id="sumPay">—</b></span>
        </div>
      </div>
    </div>
  </header>

  <!-- Body -->
  <main>
    <div id="app">
      <div class="stage">
        <!-- 1) Welcome -->
        <section id="page1" class="page active" aria-label="الترحيب">
          <h1 class="visually-hidden">عرض ترحيبي</h1>
          <div class="card text-center" style="background:transparent; box-shadow:none; padding:0;">
            <div id="pptDeck" class="ppt-deck" aria-live="polite">
              <div class="ppt-slide kb"><div class="ppt-hero"><h2>✨ غسيل بدون طوابير</h2><p>نجيك لين باب بيتك — جودة وفخامة بالتفاصيل الصغيرة</p></div></div>
              <div class="ppt-slide kb"><div class="ppt-hero"><h2>🧼 عناية مدروسة</h2><p>واكس يحمي السيارة • فوط نظيفة • إسفنجة للكفرات</p></div></div>
              <div class="ppt-slide kb"><div class="ppt-hero"><h2>⏱️ حجز سريع</h2><p>اختر المنطقة والخدمة والوقت — والباقي علينا</p></div></div>
            </div>
          </div>
        </section>

        <!-- 2) Service & Location -->
        <section id="page2" class="page" aria-label="اختيار المنطقة والخدمة">
          <h1>وين تحب نجيك؟</h1>
          <div class="card position-relative" id="servicesCard">
            <label class="form-label">اختيار المنطقة</label>
            <select id="area" style="width:100%"></select>

            <div class="row g-3 mt-3">
              <div class="col-12 col-md-6">
                <label class="form-label">التصنيف</label>
                <select id="serviceCat" style="width:100%"></select>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label">الخدمة</label>
                <select id="service" style="width:100%"></select>
              </div>
              <div class="col-12">
                <label class="form-label">عدد السيارات</label>
                <select id="serviceCount" class="form-select">
                  <option value="1" selected>1</option><option value="2">2</option>
                  <option value="3">3</option><option value="4">4</option><option value="5">5</option>
                </select>
              </div>
            </div>

            <!-- Spinner صفحة 2 فقط -->
            <div id="servicesLoading" class="load-overlay">
              <div class="spinner-border text-info" role="status" aria-hidden="true"></div>
              <strong>جاري تحميل الخدمات…</strong>
            </div>
          </div>
        </section>

        <!-- 3) Time -->
        <section id="page4" class="page" aria-label="اختيار الموعد">
          <h1>متى تحب نجيك؟</h1>
          <div class="card position-relative" id="timeCard">
            <div class="row g-3">
              <div class="col-12 col-md-5">
                <label class="form-label" for="date">التاريخ</label>
                <input id="date" type="date" class="form-control"/>
                <div id="err-date" class="field-msg" aria-live="polite"></div>
              </div>
            </div>

            <div class="position-relative mt-3">
              <div id="time-container" class="time-grid" role="radiogroup" aria-label="اختيار الوقت"></div>
              <div id="timeLoading" class="load-overlay">
                <div class="spinner-border text-info" role="status" aria-hidden="true"></div>
                <strong>جاري جلب المواعيد…</strong>
              </div>
            </div>
            <div id="err-time" class="field-msg" aria-live="polite"></div>
          </div>
        </section>

        <!-- 4) Contact -->
        <section id="page5" class="page" aria-label="معلومات الاتصال">
          <h1>معلومات الاتصال</h1>
          <div class="card">
            <div class="row g-3">
              <div class="col-12 col-md-6 form-block">
                <label for="name" class="form-label">الإسم</label>
                <input id="name" type="text" class="form-control" placeholder="اسمك الكريم" autocomplete="name"/>
                <div id="err-name" class="field-msg" aria-live="polite"></div>
              </div>
              <div class="col-12 col-md-6 form-block">
                <label for="mobile" class="form-label">رقم الجوال</label>
                <input id="mobile" type="tel" class="form-control" placeholder="+966…" autocomplete="tel" inputmode="tel"/>
                <div id="err-mobile" class="field-msg" aria-live="polite"></div>
                <small id="mobileHelp" class="text-muted d-block mt-1">مثال: 5XXXXXXXX</small>
              </div>
            </div>
          </div>

          <h1>معلومات المركبة</h1>
          <div class="card">
            <div class="row g-3">
              <div class="col-12 col-md-4">
                <label class="form-label" for="carBrand">ماركة السيارة 🚘</label>
                <select id="carBrand" style="width:100%"></select>
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label" for="carName">اسم السيارة</label>
                <input id="carName" type="text" class="form-control" placeholder="كامري، إلنترا…" autocomplete="off"/>
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label" for="plateNumber">آخر 4 أرقام من اللوحة</label>
                <input id="plateNumber" type="text" inputmode="numeric" maxlength="4" class="form-control" placeholder="1234" autocomplete="off"/>
                <div id="err-plate" class="field-msg" aria-live="polite"></div>
                <div id="note-plate" class="field-note note-info" role="status" aria-live="polite">
                  <i class="fa-solid fa-stars"></i>
                  <span id="note-plate-text"></span>
                </div>
                <small class="text-muted d-block mt-1" style="opacity:.9">الحقل اختياري — نستخدم الأرقام كمرجع للتأكيد فقط.</small>
              </div>
              <input id="locationDescription" type="text" hidden/>
            </div>
          </div>
        </section>

        <!-- 4.5) Payment -->
        <section id="page5b" class="page" aria-label="طريقة الدفع">
          <h1>طريقة الدفع</h1>
          <div class="card">
            <div class="pay-grid" role="radiogroup" aria-label="طريقة الدفع" id="payGroup">
              <label class="pay-card" tabindex="0" role="radio" aria-checked="false">
                <input type="radio" name="payingMethod" value="STC Pay" class="visually-hidden"/>
                <img src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/STC%20PAY%20LOGO.png" alt="STC Pay">
              </label>
              <label class="pay-card" tabindex="-1" role="radio" aria-checked="false">
                <input type="radio" name="payingMethod" value="Cash" class="visually-hidden"/>
                <strong>Cash</strong>
              </label>
              <label class="pay-card" tabindex="-1" role="radio" aria-checked="false">
                <input type="radio" name="payingMethod" value="MADA" class="visually-hidden"/>
                <img src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/MADA%20LOGO.png" alt="Mada">
              </label>
            </div>
            <div id="err-pay" class="field-msg" aria-live="polite"></div>
          </div>
        </section>

        <!-- 5) Map -->
        <section id="page6" class="page" aria-label="اختيار الموقع">
          <h1>الموقع على خريطة قوقل</h1>
          <div class="card">
            <div id="googleMap" style="width:100%;height:420px;border-radius:14px;overflow:hidden;position:relative"></div>
          </div>
          <div class="card text-center">
            <button id="show-my-location" class="btn btn-outline-primary" type="button">إظهار موقعي</button>
          </div>
          <small id="mapHint" class="text-muted d-block mt-2" style="text-align:center">اضغط على الخريطة أو اسحب العلامة لتحديد موقعك</small>
        </section>

        <!-- 6) Done -->
        <section id="page7" class="page" aria-label="تم الحجز">
          <div class="card text-center">
            <div class="success-hero">
              <div class="success-icon" aria-hidden="true"></div>
              <div>
                <h2 id="thanksTitle" class="thanks-title">تم حجز موعدك بنجاح 🎉</h2>
                <p id="thanksCopy" class="thanks-copy">راح نرسل لك التأكيد على الواتساب خلال دقائق.</p>
              </div>
            </div>
            <div id="thanksSummary" class="chips-wrap centered" aria-live="polite"></div>
            <div style="margin-top:18px">
              <button id="rebook" class="rebook-btn" type="button"><i class="fa-solid fa-rotate-right"></i> احجز موعدًا آخر</button>
            </div>
          </div>
        </section>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="sticky-nav" aria-label="التنقل بين الخطوات">
    <div class="footer-inner">
      <div class="footer-left">
        <div class="footer-brand">
          <a href="https://nahl.app" target="_blank" rel="noopener">Nahl.app</a>
        </div>
        <div class="footer-social" aria-label="تابعنا">
          <a href="https://wa.me/966509027172" target="_blank" rel="noopener" title="WhatsApp" aria-label="WhatsApp"><i class="fa-brands fa-whatsapp"></i></a>
          <a href="https://www.tiktok.com/@nahl.app?_t=ZS-8zgmzEQTSQW&_r=1" target="_blank" rel="noopener" title="TikTok" aria-label="TikTok"><i class="fa-brands fa-tiktok"></i></a>
          <a href="https://www.instagram.com/nahl.app?igsh=ZmljaXNncGtudjJ2." target="_blank" rel="noopener" title="Instagram" aria-label="Instagram"><i class="fa-brands fa-instagram"></i></a>
        </div>
      </div>
      <div class="footer-actions">
        <button id="footer-prev" type="button" class="btn-footer hidden">السابق</button>
        <button id="footer-next" type="button" class="btn-footer primary disabled" disabled>التالي</button>
        <button id="page1-button" class="btn-footer primary">تخطي العرض</button>
      </div>
    </div>
  </footer>

  <!-- JS libs -->
  <script src="https://code.jquery.com/jquery-3.6.3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/intlTelInputWithUtils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /* ---------- API ---------- */
    const defaultLink2 = `https://nahl-platform.vercel.app/api/app/AM/general/${'21eddbf5-efe5-4a5d-9134-b581717b17ff'}/form`;
    const RESERVE_URL_PRIMARY   = `${defaultLink2}/reserveAppointment`;
    const RESERVE_URL_FALLBACK  = `${defaultLink2.replace(/\/form\/?$/,'')}/reserveAppointment`;

    let controllers=[];
    function callContent2(path, cb, abortable=false, retries=3){
      let signal;
      if(abortable){
        controllers.forEach(c=>c[0].abort());
        controllers=[];
        const controller=new AbortController();
        signal=controller.signal;
        controllers.push([controller,signal]);
      }
      setTimeout(()=>{
        fetch(defaultLink2+path,{method:'GET',redirect:'follow',signal, cache:'no-store'})
          .then(res=>{ if(!res.ok){ if(retries>0){ callContent2(path,cb,abortable,retries-1); return Promise.reject('retry'); } throw new Error('Network'); } return res.json(); })
          .then(json=>cb(json))
          .catch(e=>{ if(e!=='retry') console.error('[GET] failed:', e); setLoadingServices(false); setLoadingTimes(false); });
      }, 120);
    }

    function postReservationTry(url, payload, contentType){
      return fetch(url, {
        method:'POST', mode:'cors', cache:'no-store', credentials:'omit', referrerPolicy:'no-referrer',
        headers:{ 'Content-Type': contentType || 'text/plain;charset=UTF-8', 'Accept':'application/json' },
        body: JSON.stringify(payload)
      }).then(res=>res.text().then(raw=>{ let data=null; try{ data=JSON.parse(raw);}catch(_){ } return { ok:res.ok, status:res.status, data, raw }; }))
      .catch(err=>({ ok:false, status:0, error:String(err) }));
    }
    async function postReservation(payload){
      let r = await postReservationTry(RESERVE_URL_PRIMARY, payload, 'text/plain;charset=UTF-8');
      if(!r.ok && (r.status===415 || r.status===406 || r.status===0)){ r = await postReservationTry(RESERVE_URL_PRIMARY, payload, 'application/json;charset=UTF-8'); }
      if(!r.ok && r.status===404){ r = await postReservationTry(RESERVE_URL_FALLBACK, payload, 'text/plain;charset=UTF-8'); }
      return r;
    }

    /* ---------- Toast ---------- */
    function showToast(type='info', msg=''){
      const wrap=document.getElementById('toastWrap');
      const div=document.createElement('div');
      div.className='toast-msg '+(type==='error'?'toast-error':type==='success'?'toast-success':'toast-info');
      div.style.minWidth='260px'; div.style.color='#fff'; div.style.padding='10px 14px'; div.style.borderRadius='10px'; div.style.boxShadow='0 10px 28px rgba(0,0,0,.18)';
      if(type==='error') div.style.background='#dc2626'; else if(type==='success') div.style.background='#16a34a'; else div.style.background='#0284c7';
      div.textContent=msg; wrap.appendChild(div);
      setTimeout(()=>{ div.style.opacity='0'; div.style.transform='translateY(-6px)'; setTimeout(()=>div.remove(), 180); }, 2400);
    }

    /* ---------- State ---------- */
    const DateTime=luxon.DateTime;
    const orderedPages=["page1","page2","page4","page5","page5b","page6","page7"];
    const STEPS_LABELS=["الترحيب","الخدمة","الوقت","البيانات","الدفع","الموقع","تم"];
    let selectedTime=null;
    let servicesCache=null, categoriesCache=null;

    window.itiPhone = null;

    const nForm={date:'',time:'',location:'',service:'',serviceCount:'1',serviceCat:'',customerM:'',customerN:'',paymentMethod:'',urlLocation:'',locationDescription:''};

    /* Step backgrounds */
    const STEP_BG = [
      "https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/NahlTimeProFrom/NahlDemoBG1.jpg",
      "https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/NahlTimeProFrom/NahlDemoBG2.jpg",
      "https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/NahlTimeProFrom/NahlDemoBG3.jpg",
      "https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/NahlTimeProFrom/NahlDemoBG4.jpg",
      "https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/NahlTimeProFrom/NahlDemoBG5.jpg",
      "https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/NahlTimeProFrom/NahlDemoBG6.jpg",
      "https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/NahlTimeProFrom/NahlDemoBG7.jpg"
    ];
    STEP_BG.forEach(src=>{ const im=new Image(); im.decoding='async'; im.src=src; });
    function setStepBackground(stepIndex){
      const url = STEP_BG[Math.min(stepIndex, STEP_BG.length-1)];
      const stage = document.getElementById('bgStage');
      if(stage){ stage.style.backgroundImage = `url("${url}")`; }
    }

    /* Header ResizeObserver */
    let headerRO;
    function initHeaderRO(){
      const header=document.getElementById('siteHeader');
      if(!header || typeof ResizeObserver==='undefined'){ syncHeaderHeight(); return; }
      headerRO=new ResizeObserver(entries=>{
        if(entries && entries[0]){
          const h=entries[0].contentRect.height;
          document.documentElement.style.setProperty('--header-h', h+'px');
        }
      });
      headerRO.observe(header);
    }
    function syncHeaderHeight(){
      const h=(document.getElementById('siteHeader')||{}).offsetHeight||120;
      document.documentElement.style.setProperty('--header-h', h+'px');
    }

    function hideOverlays(){
      const a=document.getElementById('servicesLoading'); if(a) a.classList.remove('show');
      const b=document.getElementById('timeLoading'); if(b) b.classList.remove('show');
    }

    function showPage(idx){
      const cur=document.querySelector('.page.active');
      const next=document.getElementById(orderedPages[idx]); if(!next||cur===next) return;
      if(cur && cur.id==='page1'){ stopWelcomeDeck(); }
      if(cur){ cur.classList.remove('active'); cur.classList.add('exit'); }
      next.style.display='flex';
      requestAnimationFrame(()=>{ next.classList.add('active'); setTimeout(()=>{ if(cur){cur.classList.remove('exit'); cur.style.display='none';} const h1 = next.querySelector('h1, [role="heading"]'); const firstInput = next.querySelector('input, select, button, [tabindex="0"]'); (h1 || firstInput)?.focus?.(); }, 260); });
      hideOverlays();
      syncProgress(idx);
      updateNextAvailability();
      setStepBackground(idx);
    }
    function getActiveIndex(){ const id=(document.querySelector('.page.active')||{}).id; return Math.max(0, orderedPages.indexOf(id)); }
    function syncProgress(i){
      const pct=((i+1)/orderedPages.length)*100;
      document.getElementById('miniBarFill').style.width=pct+'%';
      document.getElementById('miniStepTitle').textContent=STEPS_LABELS[Math.min(i,STEPS_LABELS.length-1)];
      const prev=document.getElementById('footer-prev');
      const next=document.getElementById('footer-next');
      const start=document.getElementById('page1-button');
      const isWelcome = i===0;
      const isLast = i === (orderedPages.length-1);
      start.classList.toggle('hidden', !isWelcome);
      prev.classList.toggle('hidden', isWelcome || isLast);
      next.classList.toggle('hidden', isWelcome || isLast);
      if(isWelcome){ start.textContent='تخطي العرض'; }
    }

    function enforceDateMinToday(){
      const today = DateTime.now().toFormat('yyyy-LL-dd');
      const dateEl = document.getElementById('date');
      if(!dateEl) return;
      dateEl.setAttribute('min', today);
      if(!dateEl.value || dateEl.value < today) dateEl.value = today;
    }
    function setLoadingTimes(on){ document.getElementById('timeLoading').classList.toggle('show', !!on); }
    function setLoadingServices(on){ document.getElementById('servicesLoading').classList.toggle('show', !!on); }

    /* ---- Inline validation helpers ---- */
    function showFieldError(inputEl, msgEl, msg){ if(inputEl){ inputEl.classList.add('is-invalid'); inputEl.setAttribute('aria-invalid','true'); } if(msgEl){ msgEl.textContent = msg || ''; msgEl.style.display='block'; } }
    function clearFieldError(inputEl, msgEl){ if(inputEl){ inputEl.classList.remove('is-invalid'); inputEl.removeAttribute('aria-invalid'); } if(msgEl){ msgEl.textContent=''; msgEl.style.display=''; } }

    /* ---- Phone helpers (defensive) ---- */
    const GCC_HELP = { sa:'5XXXXXXXX', ae:'5XXXXXXXX', bh:'3XXXXXXX', kw:'5XXXXXXX', om:'9XXXXXXX', qa:'3XXXXXXX' };

    function updateMobileHelp(){
      const help = document.getElementById('mobileHelp');
      if (!window.itiPhone || typeof window.itiPhone.getSelectedCountryData !== 'function'){
        if (help) help.textContent = 'مثال: 5XXXXXXXX';
        return;
      }
      const data = window.itiPhone.getSelectedCountryData();
      const iso2 = (data && data.iso2) ? data.iso2 : 'sa';
      if (help) help.textContent = 'مثال: ' + (GCC_HELP[iso2] || '5XXXXXXXX');
    }
    function sanitizeMobileForCountry(raw){
      const c = (window.itiPhone && typeof window.itiPhone.getSelectedCountryData==='function')
        ? (window.itiPhone.getSelectedCountryData()?.iso2 || 'sa')
        : 'sa';
      let v = (raw||'').replace(/[^\d]/g,'');
      if(c==='sa'){ if(v.startsWith('0')) v = v.replace(/^0+/, ''); }
      return v;
    }
    function mobileValidationMessage(){
      const code = (window.itiPhone && typeof window.itiPhone.getValidationError==='function') ? window.itiPhone.getValidationError() : null;
      if(code===2) return 'الرقم قصير جدًا';
      if(code===3) return 'الرقم طويل جدًا';
      if(code===1) return 'رمز الدولة غير صحيح';
      if(code===4) return 'المدخل ليس رقم هاتف';
      return 'الرجاء إدخال رقم جوال صحيح';
    }
    function validateMobileInline(){
      const el=document.getElementById('mobile');
      const msgEl=document.getElementById('err-mobile');
      if(!window.itiPhone || typeof window.itiPhone.isValidNumber!=='function'){ clearFieldError(el,msgEl); return true; }
      const sanitized = sanitizeMobileForCountry(el.value);
      if(el.value !== sanitized){ el.value = sanitized; }
      const ok = window.itiPhone.isValidNumber();
      if(!ok){ showFieldError(el, msgEl, mobileValidationMessage()); return false; }
      clearFieldError(el, msgEl); return true;
    }

    function validateNameInline(){ const el=document.getElementById('name'); const msgEl=document.getElementById('err-name'); const ok=(el.value||'').trim().length>0; if(!ok){ showFieldError(el,msgEl,'الاسم مطلوب'); return false; } clearFieldError(el,msgEl); return true; }
    function validatePlateInline(){ const el=document.getElementById('plateNumber'); const msgEl=document.getElementById('err-plate'); const val=(el.value||'').trim(); const ok=!val || /^\d{4}$/.test(val); if(!ok){ showFieldError(el,msgEl,'رجاءً أدخل ٤ أرقام أو اتركه فارغًا'); return false; } clearFieldError(el,msgEl); return true; }
    function validateTimeInline(){ const msgEl=document.getElementById('err-time'); if(!selectedTime){ msgEl.textContent='الرجاء اختيار وقت مناسب'; return false; } msgEl.textContent=''; return true; }
    function validatePayInline(){ const msgEl=document.getElementById('err-pay'); if(!nForm.paymentMethod){ msgEl.textContent='الرجاء اختيار طريقة الدفع'; return false; } msgEl.textContent=''; return true; }

    /* Special plate */
    function detectSpecialPlate(s){
      if(!/^\d{4}$/.test(s)) return null;
      const d=[...s].map(x=>+x);
      const allSame = d.every(x=>x===d[0]); if(allSame) return {type:'same', label:'مميّز جدًا (أرقام متطابقة)'};
      const asc = d[1]===d[0]+1 && d[2]===d[1]+1 && d[3]===d[2]+1;
      const desc= d[1]===d[0]-1 && d[2]===d[1]-1 && d[3]===d[2]-1;
      if(asc)  return {type:'asc',  label:'متسلسل تصاعديًا'};
      if(desc) return {type:'desc', label:'متسلسل تنازليًا'};
      const pairs = (d[0]===d[1] && d[2]===d[3] && d[1]!==d[2]); if(pairs) return {type:'pairs', label:'زوجي مكرر (##-##)'};
      const pal = (d[0]===d[3] && d[1]===d[2] && !(d[0]===d[1] && d[1]===d[2])); if(pal) return {type:'pal', label:'متناظر'};
      const counts={}; d.forEach(x=>counts[x]=(counts[x]||0)+1);
      if(Object.values(counts).some(c=>c===3)) return {type:'triple', label:'ثلاثي مكرر'};
      if(d[0]===d[2] && d[1]===d[3] && d[0]!==d[1]) return {type:'alt-pairs', label:'نمط متناوب (ABAB)'};
      return null;
    }
    function updatePlateNote(){
      const el=document.getElementById('plateNumber');
      const note=document.getElementById('note-plate');
      const textEl=document.getElementById('note-plate-text');
      if(!el || !note || !textEl) return;
      const v=(el.value||'').trim();
      const info = detectSpecialPlate(v);
      if(info){
        note.style.display='flex';
        textEl.textContent = `يبدو رقمًا مميّزًا: ${info.label}`;
      }else{
        note.style.display='none';
        textEl.textContent = '';
      }
    }

    /* Welcome deck */
    let deckTimers=[]; let deckIndex=0; let deckRunning=false; const SLIDE_MS=2600; const GAP_MS=180;
    function startWelcomeDeck(){
      const deck=document.getElementById('pptDeck'); if(!deck) return;
      const slides=Array.from(deck.querySelectorAll('.ppt-slide'));
      deckRunning=true; deckIndex=0; if(slides[0]) slides[0].classList.add('is-active');
      function advance(){ if(!deckRunning) return; const prev=deckIndex; deckIndex++; if(deckIndex>=slides.length){ stopWelcomeDeck(); showPage(1); return; } slides.forEach((s,i)=>{ s.classList.remove('is-active','is-exiting'); if(i===prev) s.classList.add('is-exiting'); if(i===deckIndex) s.classList.add('is-active'); }); deckTimers.push(setTimeout(advance, SLIDE_MS+GAP_MS)); }
      deckTimers.push(setTimeout(advance, SLIDE_MS+GAP_MS));
    }
    function stopWelcomeDeck(){ deckRunning=false; deckTimers.forEach(t=>clearTimeout(t)); deckTimers=[]; }

    /* Times */
    let dayTimes=[]; let timesLoaded=false;

    function parseTimeToLuxon(raw){ let t=DateTime.fromISO(String(raw||'').trim(),{setZone:true}); if(!t.isValid) t=DateTime.fromFormat(String(raw||''),'HH:mm:ss',{setZone:true}); if(!t.isValid) t=DateTime.fromFormat(String(raw||''),'H:mm a',{setZone:true}); if(!t.isValid) t=DateTime.fromFormat(String(raw||''),'H:mm',{setZone:true}); return t.isValid?t:null; }
    function normalizeAvailability(r){
      const status=String(r.TS_status||r.status||r.TS_appointment_status||'').toLowerCase();
      const availableFlag=(typeof r.isAvailable==='boolean')?r.isAvailable:undefined;
      const booked=Number(r.booked??r.TS_booked); const capacity=Number(r.capacity??r.TS_capacity); let remaining=Number(r.remaining??r.TS_remaining);
      if(!Number.isFinite(remaining)&&Number.isFinite(capacity)&&Number.isFinite(booked)){ remaining=capacity-booked; }
      const looksOpen=availableFlag===true||['available','open','free','empty','vacant','canceled'].includes(status)||(Number.isFinite(remaining)?remaining>0:(availableFlag!==false&&!status));
      return {looksOpen};
    }

    function fetchTimesForSelectedDate(){
      const dateEl=document.getElementById('date');
      const timeContainer=document.getElementById('time-container');
      const loc=$('#area').val()||'';
      const srv=$('#service').val()||'';
      const selectedISO=(dateEl.value||DateTime.now().toFormat('yyyy-LL-dd')).trim();

      if(!loc || !srv){
        timeContainer.innerHTML = `<div style="grid-column:1/-1;justify-self:center" class="text-muted">اختر المنطقة والخدمة لعرض المواعيد</div>`;
        window.selectedTime = null; selectedTime = null; updateNextAvailability?.(); return;
      }

      dateEl.disabled = true;
      setLoadingTimes(true);
      timeContainer.innerHTML = `<div class="spinner-border text-info" role="status" style="grid-column:1/-1;justify-self:center;"><span class="visually-hidden">Loading...</span></div>`;

      const now = DateTime.now().setZone('Asia/Riyadh');
      const isToday = selectedISO === now.toISODate();

      const qs = `/appointments?startDate=${encodeURIComponent(selectedISO)}&location=${encodeURIComponent(loc)}&service=${encodeURIComponent(srv)}&onlyAvailable=1`;

      callContent2(qs, (res) => {
        const rowsRaw = (res?.data?.appointments || []);
        const filtered = rowsRaw.filter(r => {
          const d = DateTime.fromISO(r.TS_appointment_date, { setZone: true });
          if (!d.isValid || d.toISODate() !== selectedISO) return false;
          const t = parseTimeToLuxon(r.TS_appointment_time);
          if (!t) return false;
          const { looksOpen } = normalizeAvailability(r);
          if (!looksOpen) return false;
          if (isToday) {
            const slot = now.set({ hour: t.hour, minute: t.minute, second: 0 });
            if (slot < now.plus({ minutes: 5 })) return false;
          }
          return true;
        });

        const list = filtered.map(r => {
          const t = parseTimeToLuxon(r.TS_appointment_time);
          return { label: t.toLocaleString(DateTime.TIME_SIMPLE), actual12: t.toFormat('hh:mm a') };
        });

        const seen = new Set();
        dayTimes = list
          .filter(x => { if (seen.has(x.actual12)) return false; seen.add(x.actual12); return true; })
          .sort((a,b)=> a.actual12.localeCompare(b.actual12));

        timesLoaded = true;
        renderSelectedDateTimes(selectedISO);
        dateEl.disabled = false;
        setLoadingTimes(false);
      }, true);
    }

    function renderSelectedDateTimes(selectedISO){
      const timeContainer = document.getElementById('time-container');
      timeContainer.innerHTML = '';

      if (!timesLoaded) {
        timeContainer.innerHTML = `<div class="spinner-border text-info" role="status" style="grid-column:1/-1;justify-self:center;"><span class="visually-hidden">Loading...</span></div>`;
        return;
      }

      if (!dayTimes.length) {
        timeContainer.innerHTML = `<div style="grid-column:1/-1;justify-self:center" class="text-muted">لا توجد مواعيد متاحة</div>`;
        window.selectedTime = null;
        selectedTime = null;
        updateNextAvailability?.();
        return;
      }

      dayTimes.forEach((t) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'time-option';
        btn.setAttribute('role','radio');
        btn.setAttribute('aria-checked','false');
        btn.setAttribute('dir','ltr');
        btn.textContent = t.label;

        btn.addEventListener('click', () => {
          [...timeContainer.children].forEach(el => el.setAttribute('aria-checked','false'));
          btn.setAttribute('aria-checked','true');

          const parsed = luxon.DateTime.fromFormat(t.actual12, 'h:mm a');
          nForm.date = selectedISO;
          nForm.time = parsed.isValid ? parsed.toFormat('HH:mm') : t.actual12;

          window.selectedTime = { ui: t.label, iso: nForm.time };
          selectedTime        = window.selectedTime;

          validateTimeInline();
          updateNextAvailability?.();
        });

        timeContainer.appendChild(btn);
      });
    }

    /* ------------ Locations & Services loader ------------ */
    let servicesVersion = 0;
    function loadLocationsAndFirstServices(){
      setLoadingServices(true);
      callContent2(`/locations`, res=>{
        const list=res?.data||[];
        const ds=list.map(l=>({id:l.id,text:l.TS_location_arabic_name}));
        $('#area').empty().select2({data:ds,width:'100%'});
        if(ds.length){
          const firstId = ds[0].id;
          $('#area').val(firstId).trigger('change.select2');
          nForm.location = firstId;
          servicesVersion++;
          fetchServicesForArea(firstId, servicesVersion, true);
        }else{
          setLoadingServices(false);
          showToast('error','لا توجد مناطق متاحة حالياً');
        }
      });
    }
    function fetchServicesForArea(locationId, versionAtCall, closeSpinner){
      setLoadingServices(true);
      callContent2(`/services?location=${encodeURIComponent(locationId)}`, res=>{
        if(versionAtCall !== servicesVersion){ return; }
        servicesCache=res?.data?.services||[];
        categoriesCache=res?.data?.servicesCat||[];
        const cats=categoriesCache.map(c=>({id:c.TS_category_id,text:c.TS_category_arabic_name}));
        $('#serviceCat').empty().select2({data:cats,width:'100%'});
        if(cats.length){
          $('#serviceCat').val(cats[0].id).trigger('change.select2');
          const cid=Number(cats[0].id);
          const items=servicesCache.filter(s=>Number(s.TS_category_id)===cid)
                                   .sort((a,b)=>a.TS_service_id-b.TS_service_id)
                                   .map(s=>({id:s.TS_service_id,text:s.TS_service_arabic_name}));
          $('#service').empty().select2({data:items,width:'100%'}); 
          if(items.length) $('#service').val(items[0].id).trigger('change.select2');
        }
        if(closeSpinner){ setLoadingServices(false); }
        updateNextAvailability();
      }, true);
    }

    /* Init & bindings */
    document.addEventListener('DOMContentLoaded', function(){
      enforceDateMinToday();
      const today=DateTime.now().toFormat('yyyy-LL-dd');
      const dateEl=document.getElementById('date');
      dateEl.value=today; dateEl.setAttribute('min',today);

      $('#area').select2({width:'100%',placeholder:'اختر المنطقة', dir:'rtl'});
      $('#serviceCat').select2({width:'100%',placeholder:'التصنيف', dir:'rtl'});
      $('#service').select2({width:'100%',placeholder:'الخدمة', dir:'rtl'});
      $('#carBrand').select2({width:'100%',placeholder:'ماركة السيارة', dir:'rtl'});

      // intl-tel-input – defensive init
      const phoneEl=document.querySelector('#mobile');
      if (phoneEl && window.intlTelInput){
        window.itiPhone = window.intlTelInput(phoneEl,{
          initialCountry:'sa',
          onlyCountries:['sa','ae','bh','kw','om','qa'],
          separateDialCode:true,
          nationalMode:false,
          autoPlaceholder:'aggressive',
          setPlaceholderNumberType:'MOBILE',
          formatOnDisplay:true,
          autoInsertDialCode:true,
          useFullscreenPopup:true,
          utilsScript:'https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/utils.js'
        });

        updateMobileHelp();

        phoneEl.addEventListener('input', function(){
          const cur = this.value;
          const clean = cur.replace(/[^\d]/g,'');
          if(cur !== clean) this.value = clean;
          validateMobileInline();
        });
        phoneEl.addEventListener('blur', validateMobileInline);
        phoneEl.addEventListener('countrychange', function(){
          updateMobileHelp();
          validateMobileInline();
        });
      } else {
        updateMobileHelp();
      }

      loadLocationsAndFirstServices();

      $('#area').on('change', function(){
        nForm.location=this.value;
        servicesVersion++;
        fetchServicesForArea(this.value, servicesVersion, true);
        updateNextAvailability();
      });

      $('#serviceCat').on('change', function(){
        nForm.serviceCat=this.value;
        const cid=Number(this.value);
        const items=(servicesCache||[]).filter(s=>Number(s.TS_category_id)===cid)
              .sort((a,b)=>a.TS_service_id-b.TS_service_id)
              .map(s=>({id:s.TS_service_id,text:s.TS_service_arabic_name}));
        $('#service').empty().select2({data:items,width:'100%'}); 
        if(items.length){ $('#service').val(items[0].id).trigger('change.select2'); }
        setLoadingServices(false);
        updateNextAvailability();
      });

      $('#service').on('change', function(){ nForm.service=this.value||''; if(getActiveIndex()===2){ document.getElementById('date').dispatchEvent(new Event('change')); } updateNextAvailability(); });

      const brands=["Toyota","Nissan","Hyundai","Kia","Honda","Lexus","BMW","Mercedes-Benz","Chevrolet","Ford","Mazda","Mitsubishi","Aston Martin","Other"].sort().map(b=>({id:b,text:b}));
      $('#carBrand').empty().select2({data:brands,width:'100%'});

      const payGroup=document.getElementById('payGroup');
      const payCards=[...payGroup.querySelectorAll('.pay-card')];
      payCards.forEach((card, idx)=>{
        const input=card.querySelector('input');
        card.setAttribute('role','radio'); card.setAttribute('aria-checked','false'); card.setAttribute('tabindex', idx===0?'0':'-1');
        const choose=()=>{ payCards.forEach(c=>{ c.setAttribute('aria-checked','false'); c.setAttribute('tabindex','-1'); c.querySelector('input').checked=false; }); card.setAttribute('aria-checked','true'); card.setAttribute('tabindex','0'); input.checked=true; nForm.paymentMethod=input.value; validatePayInline(); updateNextAvailability(); };
        card.addEventListener('click', choose);
        card.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); choose(); } if(['ArrowRight','ArrowDown','ArrowLeft','ArrowUp'].includes(e.key)){ e.preventDefault(); const i=payCards.indexOf(card); const nextI=(e.key==='ArrowRight'||e.key==='ArrowDown')?Math.min(i+1,payCards.length-1):Math.max(i-1,0); payCards[nextI].focus(); } });
      });

      $('#name').on('input', validateNameInline);
      $('#plateNumber').on('input', function(){ this.value=this.value.replace(/\D/g,'').slice(0,4); validatePlateInline(); updatePlateNote(); updateNextAvailability(); });

      $('#serviceCount, #serviceCat, #service, #area, #date').on('change', updateNextAvailability);

      $('#rebook').on('click', ()=>location.href='/');

      syncProgress(0);
      startWelcomeDeck();
      renderSummary();
      initHeaderRO();
      setStepBackground(0);

      document.getElementById('date').addEventListener('change', fetchTimesForSelectedDate);
    });

    /* Footer nav */
    (function(){
      const $prev=document.getElementById('footer-prev');
      const $next=document.getElementById('footer-next');
      const $start=document.getElementById('page1-button');

      $start.addEventListener('click', ()=>{ stopWelcomeDeck(); showPage(1); });

      async function gotoNext(){
        const i=getActiveIndex(); const id=orderedPages[i];

        if(id==='page2'){
          if(!$('#area').val()){ showToast('error','يرجى اختيار المنطقة'); return; }
          if(!$('#service').val()){ showToast('error','يرجى اختيار الخدمة'); return; }
          nForm.service=$('#service').val(); nForm.serviceCount=$('#serviceCount').val()||'1';
          showPage(2); document.getElementById('date').dispatchEvent(new Event('change')); return;
        }

        if(id==='page4'){
          if(!validateTimeInline()) return;
          showPage(3); return;
        }

        if(id==='page5'){
          const okN=validateNameInline(), okM=validateMobileInline(), okP=validatePlateInline();
          if(!(okN && okM && okP)) return;
          nForm.customerN=$('#name').val().trim();
          const phoneNum = (window.itiPhone && typeof window.itiPhone.getNumber==='function') ? window.itiPhone.getNumber().replace(/^\+/,'') : '';
          nForm.customerM=phoneNum;
          nForm.locationDescription=[$('#carBrand').val()||'', $('#carName').val()||'', $('#plateNumber').val()||''].filter(Boolean).join(', ');
          showPage(4); return; // الدفع
        }

        if(id==='page5b'){
          if(!validatePayInline()) return;
          showPage(5); return; // الخريطة
        }

        if(id==='page6'){
          if(!window.positionUrl){ showToast('error','الرجاء تحديد الموقع على الخريطة'); return; }
          nForm.urlLocation=window.positionUrl;

          const payload = {
            date: nForm.date, time: nForm.time, location: nForm.location, service: nForm.service,
            serviceCount: nForm.serviceCount, serviceCat: nForm.serviceCat, customerM: nForm.customerM,
            customerN: nForm.customerN, paymentMethod: nForm.paymentMethod, urlLocation: nForm.urlLocation,
            locationDescription: nForm.locationDescription || '', locale: 'ar'
          };

          const r = await postReservation(payload);

          if(r.ok && r.data?.success){
            if(r.data?.otp){ showToast('error','الخادم يطلب رمز تحقق (OTP). عطّل خيار OTP في إعدادات التطبيق.'); return; }
            showToast('success','تم إنشاء الحجز');
            showPage(6); renderThankYou();
          } else {
            const msg = r?.data?.msgAR
              || (r.status===404 ? 'المسار غير موجود: تأكد من /form/reserveAppointment'
                                 : r.status===0   ? 'تعذر الاتصال بالخادم (تحقق من CORS/الشبكة)'
                                                  : 'تعذر إنشاء الحجز');
            showToast('error', msg);
          }
          return;
        }
      }

      $next.addEventListener('click', gotoNext);
      $prev.addEventListener('click', ()=>{ const i=getActiveIndex(); showPage(Math.max(i-1,0)); });
    })();

    function updateNextAvailability(){
      const i = getActiveIndex();
      const nextBtn = document.getElementById('footer-next');
      let enable = true;
      if(i === 1){ // page2
        enable = !!($('#area').val() && $('#service').val());
      } else if(i === 2){ // page4
        enable = !!selectedTime;
      } else if(i === 3){ // page5
        const nameOk = $('#name').val().trim().length > 0;
        const phoneOk = (window.itiPhone && typeof window.itiPhone.isValidNumber==='function' && window.itiPhone.isValidNumber());
        const plateVal = $('#plateNumber').val()||'';
        const plateOk  = (plateVal.length===0 || /^\d{4}$/.test(plateVal));
        enable = nameOk && phoneOk && plateOk;
      } else if(i === 4){ // page5b
        enable = !!nForm.paymentMethod;
      } else if(i === 5){ // page6
        enable = !!window.positionUrl;
      } else if(i === 6){ // page7
        enable = false;
      }
      nextBtn.disabled = !enable;
      nextBtn.classList.toggle('disabled', !enable);
      renderSummary();
    }

    function setChip(id, text){
      const chip = document.querySelector(`[data-sum-chip="${id}"]`);
      const el = document.getElementById('sum'+id[0].toUpperCase()+id.slice(1));
      const t = (text||'').trim();
      if(!chip || !el) return;
      if(!t || t==='—'){ chip.style.display='none'; el.textContent='—'; }
      else { chip.style.display='inline-flex'; el.textContent=t; chip.title=t; }
    }
    function renderSummary(){
      const areaTxt=$('#area').find(':selected').text()||'';
      const svcTxt =$('#service').find(':selected').text()||'';
      const dateTxt=$('#date').val()||'';
      const timeTxt=(window.selectedTime && window.selectedTime.ui) || '';
      const payTxt =(nForm.paymentMethod||'');
      setChip('area', areaTxt);
      setChip('service', svcTxt);
      setChip('date', dateTxt);
      setChip('time', timeTxt);
      setChip('pay',  payTxt);
    }

    function renderThankYou(){
      const first=(nForm.customerN||'').trim().split(' ')[0];
      const tTitle=document.getElementById('thanksTitle');
      const tCopy=document.getElementById('thanksCopy');
      if(tTitle) tTitle.textContent = first ? ('تم حجز موعدك بنجاح، '+first+'! 🎉') : 'تم حجز موعدك بنجاح 🎉';
      if(tCopy)  tCopy.textContent  = 'وصلنا طلبك، وسنرسل لك التأكيد واللوكيشن على الواتساب قريباً.';
      const info=[
        {icon:'fa-location-dot', text:$('#area').find(':selected').text()||'—'},
        {icon:'fa-screwdriver-wrench', text:$('#service').find(':selected').text()||'—'},
        {icon:'fa-calendar-day', text:nForm.date||$('#date').val()||'—'},
        {icon:'fa-clock', text:(window.selectedTime&&window.selectedTime.ui)||'—'},
        {icon:'fa-credit-card', text:nForm.paymentMethod||'—'}
      ];
      const wrap=document.getElementById('thanksSummary');
      if(wrap) wrap.innerHTML = info.map(i=>`<span class="chip"><i class="fa-solid ${i.icon}"></i> ${i.text}</span>`).join('');
    }
  </script>

  <!-- Google Maps -->
  <script>
    let map, marker;
    window.positionUrl = window.positionUrl ?? "";

    window.initMap = function(){
      const def={lat:26.34165524787632,lng:50.11524831545726};
      const el=document.getElementById('googleMap');
      if(!el) return;

      map=new google.maps.Map(el,{center:def,zoom:12,disableDoubleClickZoom:true});
      marker=new google.maps.Marker({position:def,map,draggable:true,title:'اسحب أو اضغط لتحديد الموقع'});

      const setPos=(latLng,pan=false)=>{
        if(!latLng) return;
        marker.setPosition(latLng);
        if(pan) map.panTo(latLng);
        map.setZoom(17);
        window.positionUrl=`https://www.google.com/maps/search/?api=1&query=${latLng.lat()},${latLng.lng()}`;
        const hint=document.getElementById('mapHint');
        if(hint){ hint.innerHTML=`تم اختيار الموقع: <strong>${latLng.lat().toFixed(5)}, ${latLng.lng().toFixed(5)}</strong>`; }
        if(typeof updateNextAvailability==='function') updateNextAvailability();
      };

      marker.addListener('dragend', ({latLng})=>setPos(latLng));
      map.addListener('click', ({latLng})=>setPos(latLng));

      const btn=document.getElementById('show-my-location');
      if(btn){
        btn.addEventListener('click', ()=>{
          if(!navigator.geolocation){ return; }
          navigator.geolocation.getCurrentPosition(
            pos=>setPos(new google.maps.LatLng(pos.coords.latitude,pos.coords.longitude),true),
            err=>console.warn('Geolocation error:', err),
            { enableHighAccuracy:true, timeout:10000, maximumAge:30000 }
          );
        });
      }
    };
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBBHLoO038vsCovHN-SLUgAXqexlA2v0_4&callback=initMap&v=weekly" async defer></script>
</body>
</html>
