<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>حجوزات المواعيد</title>
  <meta name="description" content="غسيل بدون طوابير – نجيك لموقعك ونخدم سيارتك بواكس ولمعان وفوط نظيفة." />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800&display=swap" rel="stylesheet">

  <!-- Vendor CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/css/intlTelInput.css">

  <style>
    /* ========= THEME TOKENS ========= */
    :root{
      --brand-700:#015E73; --brand-600:#027A93; --brand-300:#69C8DA;
      --brand-100:#D7F0F6; --brand-050:#F0FAFC;
      --ink-900:#0B2630; --ink-700:#214653; --ink-500:#5B7A86;
      --surface-000:#FFFFFF; --surface-050:#F7F9FA; --surface-100:#EDF3F6; --border-300:#D4E0E6;
      --radius-sm:10px; --radius-md:14px; --radius-lg:18px; --radius-pill:999px;
      --shadow-sm:0 2px 8px rgba(11,38,48,.08);
      --shadow-md:0 10px 28px rgba(11,38,48,.14);
      --shadow-lg:0 22px 48px rgba(11,38,48,.18);
      --ease:cubic-bezier(.22,.61,.36,1);
      --t-quick:.18s var(--ease); --t-med:.28s var(--ease);

      --fs-2xl:clamp(1.6rem,2vw+1rem,2.2rem);
      --fs-xl:1.375rem; --fs-lg:1.125rem; --fs-md:1rem; --fs-sm:.9rem;

      --sp-1:4px; --sp-2:8px; --sp-3:12px; --sp-4:16px;
      --sp-5:20px; --sp-6:24px; --sp-7:32px; --sp-8:40px;
    }

    /* ========= BASE ========= */
    html, body { height: 100%; }
    body{
      margin:0;
      font-family:'Cairo', system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--brand-050);
      color: var(--ink-900);
    }

    .container-narrow{ max-width: 960px; margin: 0 auto; padding: 0 var(--sp-4); }

    /* ========= HEADER ========= */
    header.app-header{
      position: sticky; top: 0; z-index: 50;
      background: rgba(2,122,147,.9);
      color: #fff;
      backdrop-filter: blur(8px);
      box-shadow: var(--shadow-sm);
    }
    .brand-row{
      display:flex; align-items:center; justify-content:space-between;
      padding: var(--sp-3) 0 var(--sp-2);
    }
    .brand{
      display:flex; align-items:center; gap: var(--sp-3);
    }
    .brand img{ width: 40px; height: 40px; object-fit: contain; }
    .brand-name{ font-weight: 800; letter-spacing:.5px; }

    /* step pills */
    .steps{
      display:flex; gap: var(--sp-3); padding-bottom: var(--sp-3);
      overflow-x:auto;
    }
    .step-pill{
      padding: 8px 14px; border-radius: var(--radius-pill);
      background: rgba(255,255,255,.18); color:#fff; white-space:nowrap;
      font-weight:700; font-size: var(--fs-sm);
      border:1px solid rgba(255,255,255,.16);
    }
    .step-pill.active{ background:#fff; color: var(--brand-600); }

    /* progress line */
    .progress-track{ height: 6px; background: rgba(255,255,255,.25); border-radius: 999px; overflow:hidden; }
    .progress-bar{ height:100%; width: 0%; background:#fff; transition: width var(--t-med); }

    /* ========= MAIN (PAGES) ========= */
    main{
      min-height: calc(100dvh - 140px - 84px); /* header & footer */
      padding-top: var(--sp-7);
      padding-bottom: var(--sp-8);
    }

    .card-pane{
      background: var(--surface-000);
      border-radius: var(--radius-lg);
      padding: var(--sp-6);
      box-shadow: var(--shadow-md);
    }

    h1.section-title{
      font-size: var(--fs-2xl); font-weight:800; margin-bottom: var(--sp-5);
      color: var(--ink-900);
    }
    .form-label{
      display:block; margin-bottom: var(--sp-2); font-weight:700; color: var(--ink-900);
    }
    .form-control, .select2-selection{
      min-height: 48px;
      border-radius: var(--radius-md)!important;
      border:1px solid var(--border-300)!important;
      text-align:center;
      font-size: var(--fs-md);
      box-shadow:none!important;
    }
    .form-control:focus{
      border-color: var(--brand-600)!important;
      box-shadow: 0 0 0 3px var(--brand-100)!important;
    }

    /* ========= PHONE FIELD NORMALIZATION ========= */
    .iti{ width:100%; }
    .iti input{
      height:48px;
      line-height: 1.5;
      padding-right: 44px !important; /* room for flag (RTL) */
      padding-left: 12px !important;
      border-radius: var(--radius-md);
      border:1px solid var(--border-300);
      font-size: var(--fs-md);
      background: var(--surface-000);
      color: var(--ink-900);
      text-align:center;
    }
    .iti__flag-container{
      top:0; bottom:0; display:flex; align-items:center;
      height:48px; background: var(--surface-000);
      border-left:1px solid var(--border-300);
      border-radius: 0 var(--radius-md) var(--radius-md) 0;
    }

    /* ========= TIME GRID ========= */
    .time-grid{
      display:grid; grid-template-columns: repeat(3, 1fr); gap: var(--sp-3);
    }
    @media (max-width: 520px){ .time-grid{ grid-template-columns: repeat(2, 1fr);} }
    .time-btn{
      border:0; border-radius: var(--radius-md); padding: 14px 10px; font-weight:800;
      background: var(--surface-100); color: var(--ink-900);
      transition: transform var(--t-quick), background var(--t-quick), box-shadow var(--t-quick);
    }
    .time-btn:hover{ background: var(--brand-100); box-shadow: var(--shadow-sm); }
    .time-btn[aria-pressed="true"]{ background: var(--brand-600); color:#fff; }

    /* ========= FOOTER ========= */
    footer.app-footer{
      position: sticky; bottom: 0; z-index: 40;
      background: rgba(255,255,255,.85);
      backdrop-filter: blur(8px);
      border-top:1px solid var(--border-300);
    }
    .footer-actions{
      display:flex; gap: var(--sp-3); padding: var(--sp-3);
    }
    .btn{
      border:0; border-radius: var(--radius-md);
      padding: 14px 16px; font-weight:800;
      transition: background var(--t-quick), transform var(--t-quick), box-shadow var(--t-quick);
    }
    .btn:active{ transform: translateY(1px); }
    .btn-primary{ background: var(--brand-600); color:#fff; }
    .btn-primary:hover{ background: var(--brand-700); }
    .btn-secondary{ background:#fff; color: var(--brand-600); border:1px solid var(--brand-600); }

    /* utility */
    .hidden{ display:none !important; }
  </style>
</head>
<body>

  <!-- ================= HEADER ================= -->
  <header class="app-header">
    <div class="container-narrow">
      <div class="brand-row">
        <div class="brand">
          <img src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/Logo%20-%20Sponge%20and%20Soap%20-%201.png" alt="Sponge & Soap Logo">
          <div class="brand-name">SPONGE & SOAP</div>
        </div>
        <div class="w-50">
          <div class="progress-track">
            <div id="progressBar" class="progress-bar" style="width: 0%"></div>
          </div>
        </div>
      </div>

      <div class="steps" id="steps">
        <span class="step-pill active" data-step="0">الخدمة</span>
        <span class="step-pill" data-step="1">الوقت</span>
        <span class="step-pill" data-step="2">البيانات</span>
        <span class="step-pill" data-step="3">الموقع</span>
        <span class="step-pill" data-step="4">التأكيد</span>
      </div>
    </div>
  </header>

  <!-- ================= MAIN ================= -->
  <main>
    <div class="container-narrow">

      <!-- PAGE 1: Service -->
      <section id="page-service" class="card-pane">
        <h1 class="section-title">وش الخدمة اللي تبيها؟</h1>
        <div class="mb-4">
          <label for="serviceCat" class="form-label">قسم الخدمة</label>
          <select id="serviceCat" class="form-select">
            <option value="" selected disabled>اختر القسم…</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="service" class="form-label">الخدمة</label>
          <select id="service" class="form-select">
            <option value="" selected disabled>اختر الخدمة…</option>
          </select>
        </div>
      </section>

      <!-- PAGE 2: Time -->
      <section id="page-time" class="card-pane hidden">
        <h1 class="section-title">متى تحب نجيك؟</h1>
        <div class="row g-3 align-items-center mb-4">
          <div class="col-12 col-sm-6">
            <label for="date" class="form-label">التاريخ</label>
            <input type="date" id="date" class="form-control">
          </div>
        </div>
        <div id="timeWrap" class="time-grid">
          <!-- times injected -->
        </div>
        <div id="timeLoading" class="text-center py-4 hidden">
          <div class="spinner-border text-info" role="status"></div>
          <div class="mt-2">جاري جلب المواعيد…</div>
        </div>
      </section>

      <!-- PAGE 3: Details -->
      <section id="page-details" class="card-pane hidden">
        <h1 class="section-title">معلومات الاتصال</h1>
        <div class="mb-3">
          <label for="name" class="form-label">الإسم</label>
          <input id="name" class="form-control" type="text" placeholder="اسمك الكريم">
        </div>
        <div class="mb-4">
          <label for="mobile" class="form-label">رقم الجوال</label>
          <input type="tel" id="mobile" />
        </div>

        <h1 class="section-title mt-4">معلومات المركبة</h1>
        <div class="mb-3">
          <label for="carBrand" class="form-label">ماركة السيارة 🚗</label>
          <select id="carBrand" class="form-select">
            <option value="" disabled selected>اختر الماركة…</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="carName" class="form-label">اسم السيارة</label>
          <input id="carName" class="form-control" placeholder="كامري، إلنترا…">
        </div>
        <div class="mb-3">
          <label for="plateNumber" class="form-label">رقم اللوحة</label>
          <input id="plateNumber" class="form-control" inputmode="numeric" maxlength="4" placeholder="1234">
        </div>
      </section>

      <!-- PAGE 4: Location -->
      <section id="page-location" class="card-pane hidden">
        <h1 class="section-title">الموقع على خريطة قوقل</h1>
        <div class="mb-3">
          <input id="locationSearch" class="form-control" placeholder="ابحث بالعنوان أو اسم المكان…">
        </div>
        <div id="googleMap" style="height:380px; border-radius: var(--radius-lg); overflow:hidden; background:#cfe9f1;"></div>
        <div class="text-muted mt-2" style="font-size: var(--fs-sm);">
          📍 اسحب المؤشر أو اضغط على "اظهار موقعي". قد يُرفض الحجز إذا كان الموقع خارج نطاق الخدمة المحدد.
        </div>
        <div class="d-flex gap-2 mt-3">
          <button id="btnMyLocation" class="btn btn-secondary w-100">اظهار موقعي</button>
        </div>
      </section>

      <!-- PAGE 5: Confirm -->
      <section id="page-confirm" class="card-pane hidden">
        <h1 class="section-title">التأكيد</h1>
        <div id="review" class="row gy-3">
          <!-- summary injected -->
        </div>
      </section>

    </div>
  </main>

  <!-- ================= FOOTER (Sticky Nav) ================= -->
  <footer class="app-footer">
    <div class="container-narrow">
      <div class="footer-actions">
        <button id="btnPrev" class="btn btn-secondary w-50">السابق</button>
        <button id="btnNext" class="btn btn-primary w-50">التالي</button>
      </div>
    </div>
  </footer>

  <!-- Vendor JS -->
  <script src="https://code.jquery.com/jquery-3.6.3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/intlTelInputWithUtils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>

  <script>
    /* ================== STATE ================== */
    const state = {
      step: 0,
      totalSteps: 5,
      serviceCat: "", service: "",
      date: "", time: "",
      name: "", phone: "",
      carBrand: "", carName: "", plateNumber: "",
      mapUrl: ""
    };

    const pages = [
      document.getElementById('page-service'),
      document.getElementById('page-time'),
      document.getElementById('page-details'),
      document.getElementById('page-location'),
      document.getElementById('page-confirm')
    ];

    /* ================== INIT ================== */
    // Select2
    $('#serviceCat, #service').select2({ width: '100%', placeholder: 'اختر…' });
    $('#carBrand').select2({ width: '100%', placeholder: 'ماركة السيارة' });

    // Phone
    const phoneInput = window.intlTelInput(document.querySelector("#mobile"), {
      initialCountry: "sa",
      countryOrder:["sa","qa","ae","om","kw","bh"],
      onlyCountries:["sa","qa","ae","om","kw","bh"],
      excludeCountries:["il"],
      strictMode: true,
      i18n:{ ae:"الإمارات", bh:"البحرين", kw:"الكويت", sa:"السعودية" }
    });

    // Car brands (sample)
    ["Aston Martin","Audi","BMW","Chevrolet","Ford","Hyundai","Kia","Lexus","Mercedes-Benz","Nissan","Toyota","Volkswagen"].forEach(b=>{
      $('#carBrand').append(`<option value="${b}">${b}</option>`);
    });

    // Date default
    const todayISO = dayjs().format("YYYY-MM-DD");
    document.getElementById('date').value = todayISO;

    // Render times (placeholder static times for demo; replace with API results)
    function renderTimes(times){
      const wrap = document.getElementById('timeWrap');
      wrap.innerHTML = "";
      times.forEach(t=>{
        const btn = document.createElement('button');
        btn.type="button"; btn.className="time-btn";
        btn.textContent = t;
        btn.addEventListener('click', ()=>{
          Array.from(wrap.querySelectorAll('.time-btn')).forEach(b=>b.setAttribute('aria-pressed','false'));
          btn.setAttribute('aria-pressed','true');
          state.time = t;
        });
        wrap.appendChild(btn);
      });
    }
    renderTimes(["9:15 PM","10:30 PM","11:45 PM","12:15 AM","1:00 AM","1:30 AM"]);

    /* ================== NAV / STEPS ================== */
    function showStep(i){
      state.step = Math.max(0, Math.min(i, state.totalSteps-1));
      pages.forEach((p,idx)=> p.classList.toggle('hidden', idx !== state.step));

      // steps header UI
      document.querySelectorAll('.step-pill').forEach((el,idx)=>{
        el.classList.toggle('active', idx===state.step);
      });
      document.getElementById('progressBar').style.width = ((state.step)/(state.totalSteps-1))*100 + "%";

      // buttons
      document.getElementById('btnPrev').disabled = (state.step===0);
      document.getElementById('btnNext').textContent = (state.step===state.totalSteps-1) ? "تأكيد" : "التالي";

      if(state.step===4){ buildReview(); }
    }

    function validateCurrent(){
      if(state.step===0){
        state.serviceCat = $('#serviceCat').val() || "";
        state.service    = $('#service').val() || "";
        return !!state.service;
      }
      if(state.step===1){
        state.date = document.getElementById('date').value;
        return !!(state.date && state.time);
      }
      if(state.step===2){
        state.name = document.getElementById('name').value.trim();
        if(!state.name) return false;
        if(!phoneInput.isValidNumber()) return false;
        state.phone = phoneInput.getNumber().substring(1);
        state.carBrand = $('#carBrand').val() || "";
        state.carName  = document.getElementById('carName').value.trim();
        state.plateNumber = document.getElementById('plateNumber').value.trim();
        return !!state.carBrand && !!state.plateNumber;
      }
      if(state.step===3){
        return !!state.mapUrl;
      }
      return true;
    }

    document.getElementById('btnNext').addEventListener('click', ()=>{
      if(!validateCurrent()){
        // trigger browser validity where possible
        document.querySelectorAll('#page-details input, #page-service select, #page-time input').forEach(el=>{
          if(el.reportValidity) el.reportValidity();
        });
        return;
      }
      showStep(state.step+1);
    });
    document.getElementById('btnPrev').addEventListener('click', ()=> showStep(state.step-1));

    // jump via pills
    document.getElementById('steps').addEventListener('click', (e)=>{
      const pill = e.target.closest('.step-pill'); if(!pill) return;
      const target = +pill.dataset.step;
      if(target <= state.step) showStep(target); // allow going back
    });

    /* ================== REVIEW ================== */
    function buildReview(){
      const r = document.getElementById('review');
      r.innerHTML = `
        <div class="col-12 col-md-6">
          <div class="p-3 rounded border" style="border-color:var(--border-300)!important;">
            <div class="fw-bold mb-2">الخدمة</div>
            <div>${$('#service').find(':selected').text() || '-'}</div>
          </div>
        </div>
        <div class="col-12 col-md-6">
          <div class="p-3 rounded border" style="border-color:var(--border-300)!important;">
            <div class="fw-bold mb-2">الوقت</div>
            <div>${state.date || '-'} – ${state.time || '-'}</div>
          </div>
        </div>
        <div class="col-12 col-md-6">
          <div class="p-3 rounded border mt-3" style="border-color:var(--border-300)!important;">
            <div class="fw-bold mb-2">العميل</div>
            <div>${state.name || '-'} / ${state.phone ? '+'+state.phone : '-'}</div>
          </div>
        </div>
        <div class="col-12 col-md-6">
          <div class="p-3 rounded border mt-3" style="border-color:var(--border-300)!important;">
            <div class="fw-bold mb-2">المركبة</div>
            <div>${state.carBrand || '-'} – ${state.carName || '-'} – لوحة: ${state.plateNumber || '-'}</div>
          </div>
        </div>
        <div class="col-12">
          <div class="p-3 rounded border mt-3" style="border-color:var(--border-300)!important;">
            <div class="fw-bold mb-2">الموقع</div>
            <a href="${state.mapUrl || '#'}" target="_blank">${state.mapUrl || '-'}</a>
          </div>
        </div>
      `;
    }

    /* ================== MAP (basic) ================== */
    let map, marker, infoWindow;
    function initMap(){
      const defaultLoc = { lat: 26.34165524787632, lng: 50.11524831545726 };
      map = new google.maps.Map(document.getElementById("googleMap"), {
        center: defaultLoc, zoom: 12, mapTypeControl: true,
      });
      infoWindow = new google.maps.InfoWindow();
      marker = new google.maps.Marker({ position: defaultLoc, map, draggable:true });
      state.mapUrl = `https://www.google.com/maps/search/?api=1&query=${defaultLoc.lat},${defaultLoc.lng}`;

      marker.addListener("dragend", (e)=>{
        const {latLng} = e;
        const lat = latLng.lat(), lng = latLng.lng();
        state.mapUrl = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
        infoWindow.setContent("تم تحديد الموقع");
        infoWindow.open(map, marker);
      });
    }
    window.initMap = initMap;

    document.getElementById('btnMyLocation').addEventListener('click', ()=>{
      if (!navigator.geolocation) return;
      navigator.geolocation.getCurrentPosition((pos)=>{
        const lat = pos.coords.latitude, lng = pos.coords.longitude;
        const loc = { lat, lng };
        map.setCenter(loc); map.setZoom(16);
        marker.setPosition(loc);
        state.mapUrl = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
      });
    });

    // start
    showStep(0);
  </script>

  <!-- Google Maps -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBBHLoO038vsCovHN-SLUgAXqexlA2v0_4&callback=initMap" async defer></script>
</body>
</html>
