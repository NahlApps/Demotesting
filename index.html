<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Maison Hikari • الطلب</title>

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

  <!-- Bootstrap & Intl Tel Input -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/css/intlTelInput.css" rel="stylesheet"/>

  <meta name="theme-color" content="#0A0A0A">
  <meta name="description" content="Maison Hikari — اطلب الآن">

  <style>
    :root{
      --bg:#FAFAFA; --ink:#0B0D13; --muted:#6B7280; --rule:#EAEAEA;
      --brand:#111; --chip:#F2F2F2; --chip-ink:#111;
      --radius:14px; --radius-pill:999px; --shadow:0 10px 30px rgba(0,0,0,.08);
      --ease:cubic-bezier(.22,.61,.36,1);
    }
    html,body{height:100%}
    body{
      font-family:'Cairo',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--ink); background:var(--bg); display:flex; flex-direction:column;
      -webkit-tap-highlight-color:transparent;
    }

    /* Header */
    .app-header{position:sticky;top:0;z-index:70;background:#fff;border-bottom:1px solid var(--rule);backdrop-filter:saturate(1.15) blur(6px)}
    .brand{font-weight:900}
    .cart-btn{position:relative;min-width:46px;min-height:46px;border-radius:var(--radius-pill);border:1px solid var(--rule);background:#fff}
    .cart-badge{position:absolute;top:-6px;inset-inline-start:-6px;background:#111;color:#fff;border-radius:999px;font-size:.75rem;padding:2px 7px;font-weight:900;box-shadow:0 6px 16px rgba(0,0,0,.18)}

    /* Stepper */
    .stepper.nav{gap:8px;align-items:center;overflow:auto;padding:8px 0;border-bottom:1px solid var(--rule)}
    .step.nav-link{display:flex;align-items:center;gap:8px;font-weight:800;color:#6b7280;white-space:nowrap}
    .step .dot{width:28px;height:28px;border-radius:999px;border:2px solid #d1d5db;display:inline-grid;place-items:center;font-size:.9rem}
    .step.active{color:#111}
    .step.active .dot{border-color:#111;color:#111}
    .step.done{color:#16a34a}
    .step.done .dot{border-color:#16a34a;color:#16a34a}
    .step .sep{width:24px;height:2px;background:#e5e7eb}

    /* Top chips & search */
    .chips-wrap{position:sticky;top:64px;z-index:60;background:#fff;border-bottom:1px solid var(--rule);padding:10px 0}
    .chip{background:var(--chip);color:var(--chip-ink);border:1px solid var(--rule);border-radius:var(--radius-pill);padding:10px 14px;font-weight:800;font-size:.95rem;min-height:44px;transition:all .18s var(--ease)}
    .chip.active{background:#111;color:#fff;border-color:#111}
    .chip.sm{min-height:auto;padding:6px 10px;font-weight:800;font-size:.84rem}
    .chip.ghost{background:#fff;border-style:dashed}
    .pill-clear{background:#fff;border:1px dashed #bbb}
    .searchbox{border:1px solid var(--rule);border-radius:var(--radius-pill);overflow:hidden;background:#fff}
    .searchbox input{border:0;padding:12px 16px;min-height:46px}

    /* Menu */
    main{flex:1 1 auto;display:flex;flex-direction:column}
    .menu-grid{display:grid;gap:14px;grid-template-columns:repeat(1,minmax(0,1fr))}
    @media(min-width:640px){.menu-grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media(min-width:992px){.menu-grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
    .dish{background:#fff;border:1px solid var(--rule);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);display:grid;grid-template-columns:120px 1fr;gap:12px}
    .dish-img{width:120px;height:120px;object-fit:cover}
    .dish-body{padding:12px 12px 14px}
    .dish h6{font-weight:900;margin:0 0 4px}
    .price{font-weight:900}
    .tags{display:flex;flex-wrap:wrap;gap:6px}
    .tag{border:1px solid var(--rule);border-radius:999px;padding:4px 8px;font-size:.8rem;color:#555}
    .add-wrap{margin-top:8px}
    .add-btn{width:100%;min-height:46px;border-radius:999px;border:1px solid #111;background:#111;color:#fff;font-weight:900}
    .opt-chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}

    /* Cards & forms */
    .cart-card,.card-paper{background:#fff;border:1px solid var(--rule);border-radius:var(--radius);box-shadow:var(--shadow)}
    .line{display:flex;align-items:center;gap:10px;justify-content:space-between;padding:10px 0;border-bottom:1px dashed var(--rule)}
    .seg{display:inline-grid;grid-auto-flow:column;gap:8px;background:#F6F6F6;padding:6px;border-radius:999px;border:1px solid var(--rule)}
    .seg button{background:#fff;border:1px solid var(--rule);border-radius:999px;padding:11px 16px;min-height:46px;font-weight:900}
    .seg button[aria-pressed="true"]{background:#0A0A0A;color:#fff;border-color:#0A0A0A}
    #etaBadge{background:#E6F6FE;color:#0369A1;padding:4px 10px;border-radius:999px;font-weight:800}
    .inp-wrap{position:relative}
    .inp-wrap .ico{position:absolute;inset-inline-start:12px;inset-block-start:50%;transform:translateY(-50%);color:#6b7280;pointer-events:none}
    .pad-icon{padding-inline-start:42px}
    .form-control,.form-select{min-height:56px}

    /* Mini bar */
    .mini-bar{position:sticky;bottom:0;z-index:55;background:#0A0A0A;color:#fff;padding:10px 12px;border-top:1px solid rgba(255,255,255,.12);
      padding-bottom:calc(14px + env(safe-area-inset-bottom))}
    .mini-btn{min-height:52px;border-radius:999px;font-weight:900}

    /* Toast & helpers */
    #toasts{position:fixed;inset-block-start:14px;left:50%;transform:translateX(-50%);z-index:200;display:flex;flex-direction:column;gap:8px}
    .toast-msg{background:#111;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 14px 40px rgba(0,0,0,.25);font-weight:800}
    .spacer{height:18vh}
  </style>
</head>
<body>
  <!-- Toasts -->
  <div id="toasts" aria-live="polite" aria-atomic="true"></div>

  <!-- Header -->
  <header class="app-header">
    <div class="container py-2 d-flex align-items-center justify-content-between gap-2">
      <div class="d-flex align-items-center gap-3">
        <img src="https://images.unsplash.com/photo-1544025162-d76694265947?q=80&w=120&auto=format&fit=crop" alt="" width="44" height="44" style="border-radius:12px;object-fit:cover" loading="lazy">
        <div>
          <div class="brand">Maison Hikari</div>
          <small class="text-secondary">الياباني المعاصر</small>
        </div>
      </div>

      <button id="openCart" class="cart-btn px-3" aria-label="السلة (الخطوة 2)">
        <i class="fa-solid fa-bag-shopping"></i>
        <span id="badge" class="cart-badge" aria-live="polite">0</span>
      </button>
    </div>

    <!-- Stepper -->
    <div class="container">
      <div class="nav stepper" aria-label="خطوات الطلب" role="tablist">
        <a class="nav-link step active" data-bs-toggle="tab" href="#tab-menu"   role="tab"><span class="dot">1</span> القائمة  <span class="sep"></span></a>
        <a class="nav-link step"          data-bs-toggle="tab" href="#tab-cart"   role="tab"><span class="dot">2</span> السلة   <span class="sep"></span></a>
        <a class="nav-link step"          data-bs-toggle="tab" href="#tab-data"   role="tab"><span class="dot">3</span> البيانات<span class="sep"></span></a>
        <a class="nav-link step"          data-bs-toggle="tab" href="#tab-thanks" role="tab"><span class="dot">4</span> تمّ</a>
      </div>
    </div>
  </header>

  <main>
    <div class="tab-content flex-1">

      <!-- 1) MENU -->
      <section id="tab-menu" class="tab-pane fade show active">
        <div class="chips-wrap">
          <div class="container">
            <div class="row g-2 align-items-center">
              <div class="col-12 col-lg-8">
                <div id="chips" class="d-flex flex-nowrap gap-2 overflow-auto pb-1" aria-label="تصنيفات">
                  <button class="chip active" data-cat="all">الكل</button>
                  <button class="chip" data-cat="sushi">سوشي</button>
                  <button class="chip" data-cat="don">دون</button>
                  <button class="chip" data-cat="meat">لحوم</button>
                  <button class="chip" data-cat="drinks">مشروبات</button>
                  <button id="clearFilters" class="chip pill-clear d-none" type="button">مسح التصفية</button>
                </div>
              </div>
              <div class="col-12 col-lg-4">
                <div class="searchbox d-flex" role="search">
                  <input id="q" type="search" class="form-control" placeholder="ابحث عن طبق … (سالمون، واجيو…)" autocomplete="off" aria-label="بحث"/>
                  <button class="btn" aria-label="بحث"><i class="fa-solid fa-magnifying-glass"></i></button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Menu grid -->
        <div class="container py-3">
          <div id="grid" class="menu-grid" aria-live="polite"></div>
          <div class="spacer"></div>
        </div>

        <!-- Mini checkout bar -->
        <div class="mini-bar">
          <div class="container d-flex align-items-center gap-2">
            <div class="flex-grow-1">
              <div class="d-flex align-items-baseline gap-2">
                <strong id="miniCount" aria-live="polite" aria-atomic="true">0 عنصر</strong>
                <span class="text-white-50">•</span>
                <strong id="miniTotal" aria-live="polite" aria-atomic="true">0.00 ر.س</strong>
              </div>
              <small class="text-white-50">الضريبة ورسوم التوصيل تُضاف لاحقاً</small>
            </div>
            <button id="goCartBtn" class="btn btn-light mini-btn text-dark disabled" aria-disabled="true">الانتقال للسلة</button>
          </div>
        </div>
      </section>

      <!-- 2) CART -->
      <section id="tab-cart" class="tab-pane fade">
        <div class="container py-3">
          <div class="cart-card p-3 p-md-4">
            <h5 class="mb-3"><i class="fa-solid fa-bag-shopping"></i> السلة</h5>
            <div id="cartList" class="mb-3"></div>

            <div class="d-flex justify-content-between border-top pt-3">
              <span>الإجمالي</span>
              <strong id="cartTotal">0.00 ر.س</strong>
            </div>

            <div class="d-flex gap-2 mt-3">
              <a href="#tab-menu" class="btn btn-outline-dark flex-fill py-3 fw-bold">رجوع للقائمة</a>
              <a id="toDataBtn" href="#tab-data" class="btn btn-dark flex-fill py-3 fw-bold disabled" aria-disabled="true">متابعة</a>
            </div>
          </div>
        </div>
      </section>

      <!-- 3) CUSTOMER INFO -->
      <section id="tab-data" class="tab-pane fade">
        <div class="container py-4">
          <div class="d-flex align-items-center gap-2 mb-3">
            <div class="seg" aria-label="نوع الطلب">
              <button id="segPickup" class="btn" aria-pressed="true" type="button">استلام</button>
              <button id="segDelivery" class="btn" aria-pressed="false" type="button">توصيل</button>
            </div>
            <span id="etaBadge">ETA ~ 15</span>
          </div>

          <div class="card-paper p-3 p-md-4">
            <div class="row g-3">
              <div class="col-12 col-md-6">
                <label class="form-label fw-bold" for="custName">الاسم</label>
                <div class="inp-wrap">
                  <i class="fa-regular fa-user ico"></i>
                  <input id="custName" class="form-control pad-icon" placeholder="اسمك الكامل" autocomplete="name"/>
                </div>
                <div id="err-name" class="text-danger small d-none mt-2">يرجى إدخال الاسم</div>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label fw-bold" for="custPhone">رقم الجوال</label>
                <input id="custPhone" class="form-control" type="tel" placeholder="5XXXXXXXX" inputmode="tel" autocomplete="tel"/>
                <div id="ok-phone" class="text-success small d-none mt-2">رقم صحيح ✅</div>
                <div id="err-phone" class="text-danger small d-none mt-2">رقم غير صالح</div>
              </div>

              <div class="col-12" id="addressWrap" style="display:none">
                <label class="form-label fw-bold" for="address">العنوان</label>
                <div class="inp-wrap">
                  <i class="fa-solid fa-location-dot ico"></i>
                  <input id="address" class="form-control pad-icon" placeholder="الحي، الشارع، علامة مميزة" autocomplete="street-address"/>
                </div>
                <div id="err-address" class="text-danger small d-none mt-2">أدخل العنوان للتوصيل</div>
                <div class="mt-2 text-secondary small">
                  <i class="fa-regular fa-clock"></i>
                  <span id="typeHint">التوصيل عادة 30–45 دقيقة حسب الموقع.</span>
                </div>
              </div>

              <div class="col-12">
                <label class="form-label fw-bold" for="notes">ملاحظات (اختياري)</label>
                <textarea id="notes" class="form-control" maxlength="140" placeholder="لا ثلج، حار، بدون بصل …"></textarea>
                <div class="d-flex small text-secondary mt-2">
                  <span>نحاول تنفيذ تفضيلاتك بقدر الإمكان</span>
                  <span class="ms-auto">(<span id="notesCount">0</span>/140)</span>
                </div>
              </div>
            </div>
          </div>

          <div class="d-flex gap-2 mt-3">
            <a href="#tab-cart" class="btn btn-outline-dark flex-fill py-3 fw-bold">رجوع للسلة</a>
            <button id="confirmBtn" class="btn btn-dark flex-fill py-3 fw-bold" aria-label="تأكيد الطلب">تأكيد الطلب</button>
          </div>

          <div class="mt-3 small text-secondary d-flex gap-2 align-items-center">
            <i class="fa-brands fa-whatsapp"></i>
            <a class="link-dark" target="_blank" rel="noopener" href="https://wa.me/966509027172">محتاج مساعدة؟ تواصل عبر واتساب</a>
          </div>
        </div>
        <div class="spacer"></div>
      </section>

      <!-- 4) THANK YOU -->
      <section id="tab-thanks" class="tab-pane fade">
        <div class="container py-5">
          <div class="card-paper p-4 text-center">
            <div class="display-6 mb-2">🎉 شكراً لطلبك</div>
            <p class="text-secondary mb-3">تم استلام طلبك بنجاح</p>
            <div class="d-inline-block text-start bg-light p-3 rounded-3" style="min-width:260px">
              <div><strong>رقم الطلب:</strong> <span id="thOrderId">—</span></div>
              <div><strong>الإجمالي:</strong> <span id="thTotal">—</span></div>
              <div class="small text-secondary mt-1" id="thType">—</div>
            </div>
            <div class="mt-4 d-flex gap-2 justify-content-center">
              <a href="#tab-menu" id="thBackMenu" class="btn btn-dark">طلب جديد</a>
              <a href="#tab-cart" id="thBackCart" class="btn btn-outline-dark">عرض السلة</a>
            </div>
          </div>
        </div>
      </section>

    </div>
  </main>

  <!-- Options Modal -->
  <div class="modal fade" id="optModal" tabindex="-1" aria-labelledby="optTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title fw-bold" id="optTitle">خيارات إضافية</h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
        </div>
        <div class="modal-body">
          <div id="optSummary" class="mb-2 text-secondary small"></div>
          <div id="optForm" class="vstack gap-3"></div>
          <div class="d-flex align-items-center justify-content-between mt-3">
            <div class="input-group" style="width:150px">
              <button class="btn btn-outline-dark" id="optMinus" type="button" aria-label="إنقاص">−</button>
              <input id="optQty" class="form-control text-center" type="number" min="1" step="1" value="1">
              <button class="btn btn-dark" id="optPlus" type="button" aria-label="زيادة">+</button>
            </div>
            <div class="fw-bold">
              <span>السعر:</span>
              <span id="optPrice">0.00 ر.س</span>
            </div>
          </div>
          <div class="mt-3">
            <label class="form-label fw-bold" for="optNotes">ملاحظات للطبق (اختياري)</label>
            <input id="optNotes" class="form-control" maxlength="100" placeholder="بدون بصل، صوص أقل …">
          </div>
        </div>
        <div class="modal-footer">
          <button id="optAddBtn" class="btn btn-dark w-100 fw-bold" type="button">إضافة للسلة</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Templates -->
  <template id="dishTpl">
    <div class="dish" data-cat="">
      <img class="dish-img" alt="" width="240" height="240" loading="lazy"/>
      <div class="dish-body">
        <h6 class="title"></h6>
        <div class="text-secondary small mb-1 desc"></div>
        <div class="d-flex align-items-center justify-content-between">
          <div class="price"></div>
          <div class="tags"></div>
        </div>
        <!-- Option chips -->
        <div class="opt-chips"></div>
        <div class="add-wrap">
          <button class="add-btn" type="button" aria-label="أضف للسلة">أضف للسلة</button>
        </div>
      </div>
    </div>
  </template>

  <template id="cartLineTpl">
    <div class="line">
      <div class="d-flex align-items-center gap-2">
        <button class="btn btn-sm btn-outline-dark rounded-pill minus" aria-label="إنقاص">−</button>
        <strong class="qty" aria-live="polite">1</strong>
        <button class="btn btn-sm btn-dark rounded-pill plus" aria-label="زيادة">+</button>
      </div>
      <div class="flex-grow-1 text-truncate text-end">
        <div class="fw-bold name"></div>
        <div class="small text-secondary opt"></div>
        <div class="small text-secondary">× <span class="unit">0.00</span> ر.س</div>
      </div>
      <div class="text-nowrap fw-bold total">0.00 ر.س</div>
    </div>
  </template>

  <!-- JS libs -->
  <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/intlTelInputWithUtils.js"></script>

  <script>
  // ====== CONFIG: set to your deployed Web App URL ======
  const GAS_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycby9mzgWBlymqAxKk6I88ssuorkDy1RclJqQ62YrMmpqqIo9Iy84Mmh0OTfoUx85Jp-1JA/exec';
  // ======================================================

  window.addEventListener('DOMContentLoaded', () => {
    /* ---------- State ---------- */
    const state = { q:'', cat:'all', cart:{}, menu:[], lastOrder:null };
    const fmt = new Intl.NumberFormat('ar-SA', { style:'currency', currency:'SAR' });

    /* ---------- Utilities ---------- */
    function stableId(str){
      let h = 0;
      for (let i = 0; i < str.length; i++) { h = ((h << 5) - h) + str.charCodeAt(i); h |= 0; }
      return 'l_' + Math.abs(h).toString(36);
    }
    function imgFallback(el){
      el.src = 'data:image/svg+xml;utf8,'+encodeURIComponent(
        `<svg xmlns="http://www.w3.org/2000/svg" width="240" height="240"><rect width="100%" height="100%" fill="#f3f4f6"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#9ca3af" font-family="Arial" font-size="16">لا صورة</text></svg>`
      );
    }

    /* ---------- Stepper ---------- */
    const steps = ['menu','cart','data','thanks'];
    function setStep(active){
      const els = document.querySelectorAll('.stepper .step');
      els.forEach((el,idx)=>{
        const id = (el.getAttribute('href')||'').replace('#tab-','');
        el.classList.remove('active','done');
        if(id === active) el.classList.add('active');
        const activeIdx = steps.indexOf(active);
        if(idx < activeIdx) el.classList.add('done');
      });
    }
    function showTab(href){
      const a = document.querySelector(`[data-bs-toggle="tab"][href="${href}"]`);
      if(!a) return;
      bootstrap.Tab.getOrCreateInstance(a).show();
    }
    document.addEventListener('shown.bs.tab', (e) => {
      const href = e.target && e.target.getAttribute('href');
      if (!href) return;
      if (href === '#tab-menu')   setStep('menu');
      if (href === '#tab-cart')   setStep('cart');
      if (href === '#tab-data')   setStep('data');
      if (href === '#tab-thanks') setStep('thanks');
    });

    /* ---------- DOM refs ---------- */
    const grid = document.getElementById('grid');
    const dishTpl = document.getElementById('dishTpl');
    const chipsTop = document.getElementById('chips');
    const clearFilters = document.getElementById('clearFilters');
    const search = document.getElementById('q');
    const toasts = document.getElementById('toasts');

    const badge = document.getElementById('badge');
    const miniCount = document.getElementById('miniCount');
    const miniTotal = document.getElementById('miniTotal');
    const goCartBtn = document.getElementById('goCartBtn');
    const openCartBtn = document.getElementById('openCart');

    const cartList = document.getElementById('cartList');
    const cartLineTpl = document.getElementById('cartLineTpl');
    const cartTotal = document.getElementById('cartTotal');
    const toDataBtn = document.getElementById('toDataBtn');

    const nameEl   = document.getElementById('custName');
    const phoneEl  = document.getElementById('custPhone');
    const addrWrap = document.getElementById('addressWrap');
    const addrEl   = document.getElementById('address');
    const notesEl  = document.getElementById('notes');
    const segPick  = document.getElementById('segPickup');
    const segDel   = document.getElementById('segDelivery');
    const typeHint = document.getElementById('typeHint');
    const confirmBtn = document.getElementById('confirmBtn');

    const thOrderId = document.getElementById('thOrderId');
    const thTotal   = document.getElementById('thTotal');
    const thType    = document.getElementById('thType');
    const thBackMenu= document.getElementById('thBackMenu');
    const thBackCart= document.getElementById('thBackCart');

    /* ---------- Toast ---------- */
    function toast(msg, undoCb){
      const el = document.createElement('div');
      el.className='toast-msg';
      el.textContent = msg;
      if(undoCb){
        const u=document.createElement('button');
        u.className='btn btn-sm btn-light ms-2'; u.textContent='رجوع';
        u.onclick=()=>{ undoCb(); el.remove(); };
        el.appendChild(u);
      }
      toasts.appendChild(el);
      setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateY(-6px)'; setTimeout(()=>el.remove(), 180); }, 2200);
    }

    /* ---------- Fetch menu ---------- */
    async function fetchMenu() {
      if(!GAS_WEBAPP_URL){ console.warn('GAS_WEBAPP_URL not set'); return []; }
      try{
        const res = await fetch(GAS_WEBAPP_URL + '?action=menu.list', { method:'GET' });
        const json = await res.json();
        return json.ok ? (json.data || []) : [];
      }catch(e){
        console.error('menu.list failed', e);
        return [];
      }
    }

    /* ---------- Options Modal ---------- */
    const optModalEl = document.getElementById('optModal');
    const optModal = new bootstrap.Modal(optModalEl);
    const optTitle = document.getElementById('optTitle');
    const optSummary = document.getElementById('optSummary');
    const optForm = document.getElementById('optForm');
    const optPriceEl = document.getElementById('optPrice');
    const optQtyEl = document.getElementById('optQty');
    const optMinus = document.getElementById('optMinus');
    const optPlus  = document.getElementById('optPlus');
    const optNotes = document.getElementById('optNotes');
    const optAddBtn= document.getElementById('optAddBtn');

    let currentItem = null;
    let currentBase = 0;

    function buildOptionsUI(item){
      optForm.innerHTML = '';
      const schema = item.options; // ONLY from Sheet
      if (!schema || !schema.groups || !schema.groups.length) {
        const p = document.createElement('div');
        p.className = 'text-secondary small';
        p.textContent = 'لا خيارات إضافية لهذا الطبق.';
        optForm.appendChild(p);
        return;
      }
      schema.groups.forEach(group=>{
        const wrap = document.createElement('div');
        const label = document.createElement('div');
        label.className='fw-bold mb-1';
        label.textContent = group.label || group.key;
        wrap.appendChild(label);

        if(group.type === 'radio'){
          (group.items||[]).forEach((it, idx)=>{
            const id = `opt-${group.key}-${idx}`;
            const div = document.createElement('div');
            div.className='form-check';
            div.innerHTML = `
              <input class="form-check-input" type="radio" name="${group.key}" id="${id}" value="${it.value}" ${idx===0?'checked':''}>
              <label class="form-check-label" for="${id}">${it.label}${it.delta?` (+${it.delta} ر.س)`:''}</label>
            `;
            wrap.appendChild(div);
          });
        } else if(group.type === 'checkbox'){
          (group.items||[]).forEach((it, idx)=>{
            const id = `opt-${group.key}-${idx}`;
            const div = document.createElement('div');
            div.className='form-check';
            div.innerHTML = `
              <input class="form-check-input" type="checkbox" name="${group.key}" id="${id}" value="${it.value}">
              <label class="form-check-label" for="${id}">${it.label}${it.delta?` (+${it.delta} ر.س)`:''}</label>
            `;
            wrap.appendChild(div);
          });
        }
        optForm.appendChild(wrap);
      });
    }

    function selectedOptionsAndDelta(item){
      const schema = item.options;
      let delta = 0;
      const summary = [];
      const result = {};
      if (schema && schema.groups) {
        schema.groups.forEach(group=>{
          if (group.type === 'radio') {
            const chosen = optForm.querySelector(`input[name="${group.key}"]:checked`);
            if (chosen) {
              const val = chosen.value;
              result[group.key] = val;
              const meta = (group.items||[]).find(x=>x.value===val);
              if (meta) {
                delta += Number(meta.delta||0);
                summary.push(`${group.label||group.key}: ${meta.label}`);
              }
            }
          } else if (group.type === 'checkbox') {
            const list = [...optForm.querySelectorAll(`input[name="${group.key}"]:checked`)];
            result[group.key] = list.map(x=>x.value);
            list.forEach(ch=>{
              const meta = (group.items||[]).find(x=>x.value===ch.value);
              if (meta) delta += Number(meta.delta||0);
            });
            if (result[group.key] && result[group.key].length) {
              const labels = result[group.key].map(v=>{
                const m=(group.items||[]).find(x=>x.value===v); return m?m.label:v;
              }).join('، ');
              summary.push(`${group.label||group.key}: ${labels}`);
            }
          }
        });
      }
      return { delta, summary, result };
    }

    function updateOptPrice(){
      if(!currentItem) return;
      const { delta } = selectedOptionsAndDelta(currentItem);
      const unit = currentBase + delta;
      const qty = Math.max(1, Number(optQtyEl.value||1));
      optPriceEl.textContent = fmt.format(unit * qty);
    }

    optMinus.addEventListener('click', ()=>{ const n=Math.max(1, Number(optQtyEl.value||1)-1); optQtyEl.value=n; updateOptPrice(); });
    optPlus .addEventListener('click', ()=>{ const n=Math.max(1, Number(optQtyEl.value||1)+1); optQtyEl.value=n; updateOptPrice(); });
    optForm.addEventListener('change', updateOptPrice);
    optQtyEl.addEventListener('input', updateOptPrice);

    function applyPreselect(preselect, schema){
      if(!preselect || !schema) return;
      (schema.groups||[]).forEach(group=>{
        const val = preselect[group.key];
        if(val===undefined) return;
        if(group.type==='radio'){
          const input = optForm.querySelector(`input[name="${group.key}"][value="${val}"]`);
          if(input){ input.checked = true; }
        }else if(group.type==='checkbox'){
          const arr = Array.isArray(val)? val : [val];
          arr.forEach(v=>{
            const input = optForm.querySelector(`input[name="${group.key}"][value="${v}"]`);
            if(input){ input.checked = true; }
          });
        }
      });
    }

    function openOptions(item, preselect){
      currentItem = item;
      currentBase = Number(item.price||0);
      optTitle.textContent = `خيارات ${item.title}`;
      optSummary.textContent = item.desc || '';
      optQtyEl.value = 1;
      optNotes.value = '';
      buildOptionsUI(item);
      if(preselect){ applyPreselect(preselect, item.options); }
      updateOptPrice();
      optModal.show();
    }

    optAddBtn.addEventListener('click', ()=>{
      if(!currentItem) return;
      const { delta, summary, result } = selectedOptionsAndDelta(currentItem);
      const unit = currentBase + delta;
      const qty = Math.max(1, Number(optQtyEl.value||1));
      const notes = (optNotes.value||'').trim();
      const lineKey = JSON.stringify({ id: currentItem.id, opt: result, notes });
      const lineId = stableId(lineKey);
      const exists = state.cart[lineId];

      if (exists) {
        exists.qty += qty;
      } else {
        state.cart[lineId] = {
          lineId,
          id: currentItem.id,
          title: currentItem.title,
          basePrice: currentBase,
          unitPrice: unit,
          qty: qty,
          options: result,
          optionsText: summary.join(' • '),
          notes: notes
        };
      }
      bump(); renderCartList();
      toast(`أُضيف ${currentItem.title} ✅`);
      optModal.hide();
    });

    /* ---------- Render grid ---------- */
    function renderGrid(){
      grid.innerHTML='';
      const q = state.q.trim().toLowerCase();
      const list = state.menu.filter(d=>{
        const inCat = (state.cat==='all' || (d.cat||'')===state.cat);
        const inTxt = !q || [d.title||'',d.desc||''].join(' ').toLowerCase().includes(q);
        return inCat && inTxt;
      });

      if(list.length===0){
        const empty = document.createElement('div');
        empty.className='text-center text-secondary py-5';
        empty.textContent='لا توجد أطباق مطابقة — جرّب تصنيف آخر أو كلمة مختلفة';
        grid.appendChild(empty);
      }

      list.forEach(d=>{
        const node = dishTpl.content.firstElementChild.cloneNode(true);
        node.dataset.cat = d.cat || '';

        // Image (with fallback)
        const img = node.querySelector('.dish-img');
        img.alt = d.title || '';
        img.addEventListener('error', ()=>imgFallback(img));
        img.src = (d.img && d.img.startsWith('http')) ? d.img : (imgFallback(img), img.src);

        node.querySelector('.title').textContent = d.title || '—';
        node.querySelector('.desc').textContent = d.desc || '';
        node.querySelector('.price').textContent = fmt.format(Number(d.price||0));

        // Tags
        const tagsWrap = node.querySelector('.tags');
        (Array.isArray(d.tags)?d.tags:[]).forEach(t=>{
          const span=document.createElement('span');
          span.className='tag'; span.textContent=t;
          tagsWrap.appendChild(span);
        });

        // Option chips
        const optWrap = node.querySelector('.opt-chips');
        (function buildOptionChips(item){
          const schema = item.options;
          if(!schema || !schema.groups || !schema.groups.length) return;

          const chips = [];
          schema.groups.forEach(group=>{
            const items = group.items || [];
            items.forEach(it=>{
              const btn = document.createElement('button');
              btn.type='button';
              btn.className='chip sm';
              const delta = (it.delta && Number(it.delta) !== 0) ? ` (+${it.delta})` : '';
              btn.textContent = (group.label ? `${group.label}: ` : '') + `${it.label}${delta}`;
              btn.title = `اختر ${group.label || group.key} → ${it.label}`;
              btn.addEventListener('click', ()=>{
                const pre = {};
                if(group.type==='radio'){ pre[group.key] = it.value; }
                else if(group.type==='checkbox'){ pre[group.key] = [it.value]; }
                openOptions({ ...item }, pre);
              });
              chips.push(btn);
            });
          });

          const MAX = 6;
          chips.slice(0,MAX).forEach(b=>optWrap.appendChild(b));
          if(chips.length > MAX){
            const more = document.createElement('button');
            more.type='button';
            more.className='chip sm ghost';
            more.textContent = `+${chips.length - MAX}`;
            more.addEventListener('click', ()=> openOptions({ ...item }) );
            optWrap.appendChild(more);
          }
        })(d);

        node.querySelector('.add-btn').addEventListener('click', ()=> openOptions({ ...d }) );
        grid.appendChild(node);
      });

      clearFilters.classList.toggle('d-none', state.cat==='all' && !state.q.trim());
    }

    /* ---------- Search & chips (top) ---------- */
    let searchTimer=null;
    search.addEventListener('input', e=>{
      clearTimeout(searchTimer);
      searchTimer = setTimeout(()=>{ state.q=e.target.value; renderGrid(); }, 180);
    });
    clearFilters.addEventListener('click', ()=>{
      state.q=''; search.value=''; state.cat='all';
      document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
      document.querySelector('.chip[data-cat="all"]').classList.add('active');
      renderGrid();
    });
    chipsTop.addEventListener('click', e=>{
      const b = e.target.closest('.chip'); if(!b || b.id==='clearFilters') return;
      document.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      state.cat = b.dataset.cat; renderGrid();
    });

    /* ---------- Cart ---------- */
    function cartArr(){ return Object.values(state.cart); }
    function totals(){
      const arr = cartArr();
      return {
        count: arr.reduce((a,b)=>a + b.qty, 0),
        total: arr.reduce((a,b)=>a + b.qty * b.unitPrice, 0),
        arr
      };
    }
    function bump(){
      const t = totals();
      badge.textContent = t.count;
      miniCount.textContent = `${t.count} عنصر`;
      miniTotal.textContent = fmt.format(t.total);
      cartTotal.textContent = fmt.format(t.total);
      renderCartList();
      localStorage.setItem('hk_cart_v3', JSON.stringify(state.cart));

      const has = t.count>0;
      goCartBtn.classList.toggle('disabled', !has);
      goCartBtn.setAttribute('aria-disabled', String(!has));
      toDataBtn.classList.toggle('disabled', !has);
      toDataBtn.setAttribute('aria-disabled', String(!has));
    }
    const saved = localStorage.getItem('hk_cart_v3');
    if(saved){ try{ state.cart = JSON.parse(saved)||{}; }catch{} }

    function renderCartList(){
      cartList.innerHTML='';
      const {arr} = totals();
      if(arr.length===0){
        const p=document.createElement('p');
        p.className='text-secondary text-center my-4';
        p.textContent='السلة فارغة';
        cartList.appendChild(p);
        return;
      }
      arr.forEach(it=>{
        const row = cartLineTpl.content.firstElementChild.cloneNode(true);
        row.querySelector('.name').textContent = it.title;
        row.querySelector('.opt').textContent = [it.optionsText, it.notes].filter(Boolean).join(' • ');
        row.querySelector('.unit').textContent = Number(it.unitPrice||0).toFixed(2);
        row.querySelector('.qty').textContent  = it.qty;
        row.querySelector('.total').textContent= fmt.format(it.qty*it.unitPrice);
        row.querySelector('.minus').addEventListener('click', ()=>{
          if(!state.cart[it.lineId]) return;
          state.cart[it.lineId].qty--;
          if(state.cart[it.lineId].qty<=0) delete state.cart[it.lineId];
          bump();
        });
        row.querySelector('.plus').addEventListener('click',  ()=>{
          if(!state.cart[it.lineId]) return;
          state.cart[it.lineId].qty++;
          bump();
        });
        cartList.appendChild(row);
      });
    }

    // Step changes
    openCartBtn.addEventListener('click', ()=>{ showTab('#tab-cart'); renderCartList(); });
    goCartBtn.addEventListener('click', (e)=>{ if(!goCartBtn.classList.contains('disabled')){ e.preventDefault(); showTab('#tab-cart'); renderCartList(); }});
    toDataBtn.addEventListener('click', (e)=>{ if(!toDataBtn.classList.contains('disabled')){ e.preventDefault(); showTab('#tab-data'); }});

    /* ---------- Form & tel input ---------- */
    const iti = window.intlTelInput(phoneEl,{
      initialCountry:'sa', onlyCountries:['sa','ae','bh','kw','om','qa'],
      utilsScript:'https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/utils.js',
      separateDialCode:true
    });

    function setType(delivery){
      segPick.setAttribute('aria-pressed', String(!delivery));
      segDel.setAttribute('aria-pressed', String(delivery));
      addrWrap.style.display = delivery ? '' : 'none';
      typeHint.textContent = delivery ? 'التوصيل عادة 30–45 دقيقة حسب الموقع.' : 'الاستلام من المطعم أسرع (10–15 دقيقة).';
      if(delivery) setTimeout(()=>addrEl.focus(), 80);
    }
    segPick.addEventListener('click', ()=>setType(false));
    segDel.addEventListener('click', ()=>setType(true));
    setType(false);

    notesEl.addEventListener('input', ()=>{ document.getElementById('notesCount').textContent = (notesEl.value||'').length; });

    function validate(){
      const nameOk = (nameEl.value||'').trim().length>1;
      let phoneOk = false;
      try { phoneOk = iti.isValidNumber(); } catch (_e) { phoneOk = (phoneEl.value||'').trim().length>=8; }
      const delivery = segDel.getAttribute('aria-pressed')==='true';
      const addressOk = !delivery || (addrEl.value||'').trim().length>3;

      document.getElementById('err-name').classList.toggle('d-none', nameOk);
      document.getElementById('ok-phone').classList.toggle('d-none', !phoneOk);
      document.getElementById('err-phone').classList.toggle('d-none', phoneOk);
      document.getElementById('err-address').classList.toggle('d-none', addressOk);

      return nameOk && phoneOk && addressOk;
    }
    ['input','blur'].forEach(ev=>{
      nameEl.addEventListener(ev, validate);
      phoneEl.addEventListener(ev, ()=>setTimeout(validate, ev==='blur'?0:120));
      addrEl.addEventListener(ev, validate);
    });

    /* ---------- Submit to GAS ---------- */
    async function createOrder(payload) {
      if(!GAS_WEBAPP_URL) throw new Error('GAS_WEBAPP_URL not set');
      const res = await fetch(GAS_WEBAPP_URL + '?action=order.create', {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' }, // avoid CORS preflight
        body: JSON.stringify(payload)
      });
      return res.json();
    }

    const submitOrder = async () => {
      const t = totals();
      if(t.count===0){ toast('السلة فارغة'); return; }
      if(!validate()){ window.scrollTo({top:0,behavior:'smooth'}); return; }
      confirmBtn.disabled = true; confirmBtn.classList.add('disabled');
      try{
        let phoneNumber = phoneEl.value.trim();
        try { phoneNumber = iti.getNumber(); } catch (_e) {}
        const payload = {
          type: segDel.getAttribute('aria-pressed')==='true' ? 'delivery' : 'pickup',
          name: nameEl.value.trim(),
          phone: phoneNumber,
          address: addrEl.value.trim(),
          notes: notesEl.value.trim(),
          items: cartArr().map(x=>({
            lineId:x.lineId, id:x.id, title:x.title, qty:x.qty, price:x.unitPrice,
            options:x.options, optionsText:x.optionsText, lineNotes:x.notes
          }))
        };
        const res = await createOrder(payload);
        if (res && res.ok) {
          state.lastOrder = { id: res.orderId, total: res.totals && res.totals.total, type: payload.type };
          localStorage.setItem('hk_user_v1', JSON.stringify({ name: payload.name, phone: phoneEl.value, address: payload.address }));
          state.cart = {}; bump();
          thOrderId.textContent = state.lastOrder.id || '—';
          thTotal.textContent   = typeof state.lastOrder.total==='number' ? fmt.format(state.lastOrder.total) : '—';
          thType.textContent    = state.lastOrder.type==='delivery' ? 'نوع الطلب: توصيل' : 'نوع الطلب: استلام';
          showTab('#tab-thanks');
        } else {
          toast('تعذر إرسال الطلب، حاول لاحقًا'); console.error('order.create error', res);
        }
      } catch (err) {
        toast('خطأ في الاتصال بالخدمة'); console.error(err);
      } finally{
        confirmBtn.disabled = false; confirmBtn.classList.remove('disabled');
      }
    };
    confirmBtn.addEventListener('click', submitOrder);

    // Thanks → back actions
    thBackMenu.addEventListener('click', (e)=>{ e.preventDefault(); setStep('menu'); showTab('#tab-menu'); });
    thBackCart.addEventListener('click', (e)=>{ e.preventDefault(); showTab('#tab-cart'); });

    // Keyboard flow
    nameEl.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); phoneEl.focus(); }});
    phoneEl.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); (segDel.getAttribute('aria-pressed')==='true'?addrEl:notesEl).focus(); }});

    /* ---------- Prefill ---------- */
    try {
      const savedInfo = JSON.parse(localStorage.getItem('hk_user_v1') || '{}');
      if (savedInfo.name) nameEl.value = savedInfo.name;
      if (savedInfo.phone) phoneEl.value = savedInfo.phone;
      if (savedInfo.address) { addrEl.value = savedInfo.address; setType(true); }
    } catch (_e) {}

    /* ---------- Init ---------- */
    (async () => {
      setStep('menu');
      state.menu = await fetchMenu();
      if (!state.menu.length) setTimeout(()=>toast('لم يتم إعداد القائمة من الخلفية بعد'), 600);
      renderGrid(); bump(); renderCartList();
    })();
  });
  </script>
</body>
</html>
