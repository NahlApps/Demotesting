<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="tokyo">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Tiger 77 • 東京 | تايغر ٧٧</title>

  <!-- ================== RESILIENT ASSET LOADER (CDN → Local fallback) ================== -->
  <script>
    // Tiny helper to load <link> and <script> with fallback to local vendor files.
    (function () {
      const head = document.head;

      function addLink(href, attrs = {}) {
        const l = document.createElement('link');
        l.rel = 'stylesheet'; l.href = href;
        Object.assign(l, attrs);
        head.appendChild(l);
        return l;
      }
      function addScript(src, onload, onerror) {
        const s = document.createElement('script');
        s.src = src; s.async = false;
        s.onload = onload || null;
        s.onerror = onerror || null;
        head.appendChild(s);
        return s;
      }

      // Queued loaders
      window.AssetLoader = {
        addCssWithFallback(cdnHref, localHref) {
          // Some browsers don’t fire onerror for <link>. We inject a test CSS var.
          const testId = 'css-check-' + Math.random().toString(36).slice(2);
          const probe = document.createElement('style');
          probe.textContent = `:root{ --${testId}: 1 }`;
          head.appendChild(probe);

          addLink(cdnHref);
          // After a tick, verify if style var exists. If not, load local.
          setTimeout(() => {
            const hasVar = getComputedStyle(document.documentElement).getPropertyValue(`--${testId}`).trim() === '1';
            if (!hasVar && localHref) addLink(localHref);
            probe.remove();
          }, 300);
        },
        addJsWithFallback(cdnSrc, localSrc, testProp, cb) {
          addScript(cdnSrc, () => {
            // CDN loaded; if testProp exists or cb says ok, done.
            const ok = testProp ? !!window[testProp] : true;
            if (cb) cb(ok, 'cdn');
            if (!ok && localSrc) addScript(localSrc, () => cb && cb(true, 'local'));
          }, () => {
            // CDN failed → local
            if (localSrc) addScript(localSrc, () => cb && cb(true, 'local'));
          });
        }
      };
    })();
  </script>

  <!-- Fonts (degrade gracefully if blocked) -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800&family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet"/>

  <!-- Icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"
        onerror="this.remove()"/>

  <!-- CSS (CDN → local vendor fallback) -->
  <script>
    AssetLoader.addCssWithFallback(
      "https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css",
      "./vendor/bootstrap.min.css"
    );
    AssetLoader.addCssWithFallback(
      "https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css",
      "./vendor/select2.min.css"
    );
    AssetLoader.addCssWithFallback(
      "https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/css/intlTelInput.css",
      "./vendor/intlTelInput.css"
    );
  </script>

  <meta property="twitter:image" content="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Tiger77%20-%20Logo.png">
  <meta property="twitter:image:src" content="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Tiger77%20-%20Logo.png">
  <link rel="shortcut icon" href="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Tiger77%20-%20Logo.png" type="image/x-icon">

  <!-- ================== THEME CSS (Tokyo Neon / Zen) ================== -->
  <style>
    :root{
      --neon-cyan:#00E5FF; --neon-magenta:#FF2DAE; --neon-purple:#7A5CFF;
      --ink-900:#0A0C12; --ink-800:#121624; --ink-700:#1B2033;
      --p-900:#11162A; --p-800:#182041; --p-700:#223069; --p-600:#2D43A1; --p-500:#3A5AE6;
      --p-900-58: rgba(17,22,42,.82); --p-900-34: rgba(17,22,42,.58);
      --p-800-65: rgba(34,48,105,.65); --p-800-45: rgba(29,39,87,.45);
      --p-600-22: rgba(0,229,255,.18); --p-600-14: rgba(255,45,174,.16);
      --gold-600:#E4007F;
      --surface-000:#0D111B; --surface-card:rgba(255,255,255,.07); --border-300:rgba(255,255,255,.16);
      --radius-md:14px; --radius-pill:999px;
      --shadow-xs:0 2px 10px rgba(0,0,0,.25); --shadow-sm:0 10px 24px rgba(0,0,0,.35); --shadow-md:0 24px 64px rgba(0,0,0,.45);
      --ease:cubic-bezier(.22,.61,.36,1); --dur-xs:160ms; --dur-sm:220ms; --dur-md:460ms;
      --header-h:76px; --footer-h:118px;
      --page-bg:
        linear-gradient(180deg, rgba(0,229,255,.10), rgba(255,45,174,.10)),
        url("https://images.unsplash.com/photo-1540959733332-eab4deabeeaf?q=80&w=1600&auto=format&fit=crop") center/cover no-repeat fixed;
      --input-bg: rgba(10,12,18,.82); --input-bg-hover: rgba(14,18,26,.9);
      --input-border: rgba(255,255,255,.14);
      --input-border-hover: color-mix(in oklab, var(--neon-cyan) 26%, var(--input-border));
      --placeholder: rgba(235,240,255,.45);
    }
    html,body{height:100%}
    body{
      margin:0; color:#E9EDFF;
      font-family:'Cairo','Noto Sans JP',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;
      background:
        radial-gradient(1200px 600px at 80% -10%, rgba(255,45,174,.25), transparent 60%),
        radial-gradient(900px 500px at -10% 110%, rgba(0,229,255,.20), transparent 55%),
        var(--page-bg);
      min-height:100dvh; display:flex; flex-direction:column;
      padding-top:var(--header-h); padding-bottom:var(--footer-h);
      backdrop-filter: blur(0.5px);
    }
    header{
      position:fixed; inset-block-start:0; inset-inline:0; z-index:999;
      background:linear-gradient(0deg, rgba(13,17,27,.92), rgba(13,17,27,.92));
      border-bottom:1px solid rgba(255,255,255,.10); box-shadow:0 12px 30px rgba(0,0,0,.35); backdrop-filter: blur(8px);
    }
    .header-inner{ max-width:1120px; width:100%; margin:0 auto; padding:10px 12px; display:flex; align-items:center; gap:12px; justify-content:space-between; }
    .brand{ display:flex; align-items:center; gap:10px; padding:6px 10px; border-radius:12px; background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)); border:1px solid rgba(255,255,255,.12); box-shadow: inset 0 1px 0 rgba(255,255,255,.20), 0 8px 20px rgba(0,0,0,.35); }
    .brand img{ height:72px; filter: drop-shadow(0 0 18px rgba(0,229,255,.55)) drop-shadow(0 0 10px rgba(255,45,174,.35)); }
    .header-right{flex:1; display:flex; flex-direction:column; gap:6px}
    .mini-progress{display:flex; align-items:center; gap:10px; width:100%}
    .mini-progress .bar{flex:1; height:8px; background:rgba(255,255,255,.12); border-radius:999px; overflow:hidden}
    .mini-progress .bar>span{height:100%; width:0%; background: linear-gradient(90deg, var(--neon-cyan), var(--neon-purple), var(--neon-magenta)); box-shadow: 0 0 16px var(--neon-cyan), 0 0 24px var(--neon-magenta); transition:width var(--dur-md) var(--ease)}
    .mini-progress .step{font-weight:900; font-size:1rem; color:#fff; letter-spacing:.4px}
    .summary-chips{display:flex; flex-wrap:wrap; gap:6px; align-items:center}
    .chip{ display:inline-flex; align-items:center; gap:6px; max-width:100%; padding:6px 10px; border:1px solid rgba(255,255,255,.25); border-radius:999px; color:#fff; font-size:.85rem; background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06)); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; box-shadow: 0 4px 10px rgba(0,0,0,.25); }
    .chip.current{ box-shadow:0 0 0 2px rgba(255,255,255,.25) inset, 0 0 14px rgba(0,229,255,.35); }
    main{flex:1 0 auto; display:flex; justify-content:center; padding:8px 12px 0}
    #app{width:100%; max-width:1120px}
    .stage{position:relative; min-height:560px; padding:8px 0 20px}
    .page{ position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; gap:20px; padding:24px 12px 28px; overflow:auto; opacity:0; transform:translateY(12px) scale(.992); pointer-events:none; }
    .page.active{ pointer-events:auto; animation:pageIn var(--dur-md) var(--ease) both }
    .page.exit  { animation:pageOut var(--dur-sm) var(--ease) both }
    @keyframes pageIn{ from{opacity:0; transform:translateY(12px) scale(.992)} to{opacity:1; transform:translateY(0) scale(1)} }
    @keyframes pageOut{ from{opacity:1; transform:translateY(0) scale(1)} to{opacity:0; transform:translateY(14px) scale(.985)} }
    .page h1{ font-family:'Cairo','Noto Sans JP',sans-serif; font-size:1.45rem; font-weight:900; margin:0; text-align:center; letter-spacing:.2px; text-shadow: 0 0 18px rgba(0,229,255,.35); }
    .card{ background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05)); color:#E9EDFF; border-radius:14px; box-shadow:var(--shadow-md); padding:24px; width:100%; max-width:920px; backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,.12); }

    /* Inputs */
    .form-control, select, .select2-selection{
      background:var(--input-bg) !important; color:#fff !important;
      border:1px solid var(--input-border) !important; border-radius:14px!important;
      min-height:52px; text-align:center; font-size:16px;
      transition:border-color var(--dur-xs) var(--ease), box-shadow var(--dur-xs) var(--ease), background var(--dur-xs) var(--ease);
    }
    .form-control:hover, select:hover, .select2-selection:hover{ background:var(--input-bg-hover) !important; border-color:var(--input-border-hover) !important; }
    .form-control:focus, select:focus, .select2-container--open .select2-selection{
      background:var(--input-bg-hover) !important;
      border-color:var(--input-border-hover) !important;
      box-shadow:0 0 0 6px color-mix(in oklab, var(--neon-cyan) 18%, transparent), 0 0 0 2px color-mix(in oklab, var(--neon-magenta) 24%, transparent) inset !important;
      outline:none !important;
    }
    .form-label{margin-bottom:6px; font-size:.9rem; font-weight:800; color:#D8DEFF}
    .field-error{color:#FF6B6B; font-size:.85rem; margin-top:6px; display:none}

    /* Time slots */
    .time-grid{display:grid; grid-template-columns:repeat(2,1fr); gap:16px}
    @media (min-width:540px){ .time-grid{grid-template-columns:repeat(3,1fr)} }
    .time-option{ background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06)); color:#fff; font-weight:800; border:1px solid rgba(255,255,255,.14); border-radius:14px; padding:14px 10px; min-height:64px; box-shadow:var(--shadow-xs); transition:transform .16s var(--ease), box-shadow .16s var(--ease), background .16s var(--ease), outline-color .16s var(--ease); display:flex; flex-direction:column; align-items:center; justify-content:center; }
    .time-option:hover{transform:translateY(-2px); background:rgba(255,255,255,.12); box-shadow:var(--shadow-sm)}
    .time-option[aria-pressed="true"]{ outline:3px solid var(--neon-cyan); outline-offset:2px; background:linear-gradient(0deg, rgba(0,229,255,.15), rgba(255,45,174,.15)); box-shadow:0 0 0 3px rgba(255,45,174,.18); }

    /* Payment */
    .pay-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;align-items:stretch;width:min(100%,960px);margin-inline:auto}
    .pay-card{cursor:pointer;border:1px solid rgba(255,255,255,.16);background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));border-radius:14px;padding:14px;min-height:96px;display:flex;align-items:center;justify-content:center;transition:border-color .2s,box-shadow .2s,transform .05s,background-color .2s;outline:none;width:100%}
    .pay-card:hover{border-color:#cbd5e1;box-shadow:0 14px 34px rgba(0,0,0,.35);background-color:rgba(255,255,255,.12)}
    .pay-card[aria-checked="true"]{border-color:var(--neon-cyan);box-shadow:0 0 0 3px color-mix(in oklab, var(--neon-cyan) 28%, transparent), 0 18px 44px rgba(0,0,0,.45);}
    .pay-card__content{display:grid;grid-template-rows:auto auto;justify-items:center;align-items:center;gap:10px;text-align:center;color:#fff}
    .pay-card__img{width:min(180px,60%);max-height:40px;object-fit:contain;filter: drop-shadow(0 0 10px rgba(0,229,255,.35))}
    .pay-card__icon{font-size:28px;line-height:1}
    .pay-card__label{font-size:14px;color:#EEF2FF;font-weight:800}

    /* Service cards */
    .svc-grid{ display:grid; gap:14px; margin-top:8px; grid-template-columns:repeat(1,minmax(0,1fr)); }
    @media (min-width:560px){ .svc-grid{ grid-template-columns:repeat(2,minmax(0,1fr)); } }
    @media (min-width:992px){ .svc-grid{ grid-template-columns:repeat(3,minmax(0,1fr)); } }
    .svc-card{ background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06)); border:1px solid rgba(255,255,255,.14); border-radius:14px; padding:12px; display:flex; gap:12px; align-items:flex-start; cursor:pointer; outline:none; box-shadow:var(--shadow-xs); transition:transform .16s, box-shadow .16s, background .16s; min-height:110px; position:relative; color:#fff; }
    .svc-card:hover{ transform:translateY(-2px); box-shadow:var(--shadow-sm); background:rgba(255,255,255,.12) }
    .svc-card[aria-checked="true"]{ outline:3px solid var(--neon-magenta); outline-offset:2px; box-shadow:0 0 0 3px rgba(0,229,255,.18); }
    .svc-thumb{ width:88px;height:88px;flex:0 0 88px;border-radius:12px;overflow:hidden;background:#0F1424;border:1px solid rgba(255,255,255,.12); display:flex;align-items:center;justify-content:center; }
    .svc-thumb img{ width:100%;height:100%;object-fit:cover }
    .svc-title{ font-weight:900; font-size:1rem; color:#fff; margin:0 0 4px }
    .svc-cat{ background:#E4007F; color:#fff; border:0; padding:2px 8px; border-radius:999px; font-size:.75rem; display:inline-flex; gap:6px; align-items:center; white-space:nowrap; margin-inline-start:auto; }
    .svc-desc{ font-size:.9rem; color:#DCE3FF; opacity:.92; margin:0 0 8px; line-height:1.5; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden }
    .price-tag{ background:#1B2033; color:#CFE7FF; border:0; padding:4px 8px; border-radius:999px; font-size:.8rem; white-space:nowrap }
    .price-tag.alt{ background:#282F4C }
    .svc-cta{ position:absolute; inset-inline-end:10px; inset-block-end:10px; font-size:.85rem; color:#fff; opacity:.9; text-shadow:0 0 10px rgba(0,229,255,.6) }

    /* Footer */
    footer.sticky-nav{
      position:sticky; bottom:0; z-index:40;
      background: linear-gradient(0deg, rgba(16,20,32,.86), rgba(16,20,32,.86));
      border-top:1px solid rgba(255,255,255,.10); backdrop-filter:blur(12px);
    }
    .footer-inner{ max-width:1120px; width:100%; margin:0 auto; padding:12px; display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap}
    .btn-footer{ flex:1; border:1px solid rgba(255,255,255,.16); border-radius:14px; padding:16px 16px; min-height:56px; font-size:1rem; font-weight:900; background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06)); color:#fff; }
    .btn-footer.primary{background:linear-gradient(90deg, var(--neon-cyan), var(--neon-magenta)); color:#0B0D13; border-color:transparent}
    .btn-footer.hidden{visibility:hidden}
    .btn-footer.disabled{opacity:.6; pointer-events:none}

    /* Map container */
    #googleMap{width:100%;height:420px;border-radius:14px;overflow:hidden;border:1px solid rgba(255,255,255,.12)}
    .map-fallback{ display:none; gap:10px; align-items:center; }
    .map-fallback.show{ display:flex; }
  </style>
</head>

<body>
  <div id="toastWrap" style="position:fixed;top:10px;left:50%;transform:translateX(-50%);z-index:1050;display:flex;flex-direction:column;gap:8px"></div>

  <!-- Header -->
  <header id="siteHeader">
    <div class="header-inner">
      <div class="brand">
        <img id="brandLogo"
             alt="Tiger 77"
             src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Tiger77%20-%20Logo.png"
             onerror="handleLogoError(this)" />
      </div>
      <div class="header-right">
        <div class="mini-progress" aria-hidden="true">
          <div class="bar"><span id="miniBarFill" style="width:0%"></span></div>
          <div class="step" id="miniStepTitle">الترحيب</div>
        </div>
        <div id="summaryChips" class="summary-chips" aria-live="polite"></div>
      </div>
    </div>
  </header>

  <!-- Main pages (same workflow) -->
  <main>
    <div id="app">
      <div class="stage">
        <!-- PAGE 1: Welcome -->
        <section id="page1" class="page active">
          <h1>🗼 タイガー77 • Tiger 77 — أهلاً بكم في طوكيو ✨</h1>
          <div class="card text-center" style="max-width:860px">
            <p class="mb-0">ابدأ الآن — 次へ進んでサービスを選択</p>
          </div>
        </section>

        <!-- PAGE 2: Service / Area -->
        <section id="page2" class="page">
          <h1>🚙 أين نصل إليك؟ • どこでご希望ですか？</h1>
          <div class="card position-relative" id="servicesCard">
            <label class="form-label">اختيار المنطقة • エリア選択</label>
            <select id="area" style="width:100%"></select>
            <div class="field-error" id="err-area">يرجى اختيار المنطقة</div>

            <div class="row g-3 mt-3">
              <div class="col-12 col-md-6">
                <label class="form-label">التصنيف • カテゴリー</label>
                <select id="serviceCat" style="width:100%"></select>
                <div class="field-error" id="err-serviceCat">يرجى اختيار التصنيف</div>
              </div>

              <div class="col-12 col-md-6" hidden>
                <label class="form-label">الخدمة • サービス</label>
                <select id="service" style="width:100%" class="visually-hidden" tabindex="-1"></select>
                <div class="field-error" id="err-service">يرجى اختيار الخدمة</div>
              </div>

              <div class="col-12 col-md-6">
                <label class="form-label" for="numCars">عدد السيارات (حتى 5) • 台数（最大5台）</label>
                <select id="numCars" style="width:100%">
                  <option value="1" selected>1</option><option value="2">2</option><option value="3">3</option>
                  <option value="4">4</option><option value="5">5</option>
                </select>
                <div class="field-error" id="err-numCars">يرجى اختيار عدد السيارات</div>
              </div>

              <div class="col-12">
                <div id="serviceCards" class="svc-grid" role="radiogroup" aria-label="الخدمات المتاحة"></div>
                <div id="svcEmpty" class="text-center text-muted" style="display:none;padding:16px">لا توجد خدمات في هذا التصنيف</div>
                <div id="svcError" class="text-center" style="display:none;padding:16px">
                  <div class="mb-2 text-danger">تعذر تحميل بيانات الخدمات</div>
                  <button id="svcRetry" class="btn btn-outline-primary btn-sm">إعادة المحاولة</button>
                </div>
              </div>
            </div>

            <div id="servicesLoading" class="load-overlay" aria-hidden="true"
                 style="position:absolute; inset:0; background:rgba(13,17,27,.86); color:#fff; display:none; align-items:center; justify-content:center; gap:12px; border-radius:14px;">
              <div class="spinner-border text-info" role="status"></div>
              <strong>جاري تحميل الخدمات…</strong>
            </div>
          </div>
        </section>

        <!-- PAGE 3: Time -->
        <section id="page3" class="page">
          <h1>🕰️ متى تحب نجيك؟ • ご希望の時間は？</h1>
          <div class="card" id="timeCard">
            <div class="row g-3">
              <div class="col-12 col-md-5">
                <label class="form-label" for="date">التاريخ • 日付</label>
                <input id="date" type="date" class="form-control"/>
                <div class="field-error" id="err-date">يرجى اختيار تاريخ صحيح</div>
              </div>
              <div class="col-12 col-md-7 d-flex align-items-end justify-content-end">
                <div class="text-muted" id="timeCountHint" style="font-weight:800">0/1 وقت محدد</div>
              </div>
            </div>
            <div id="time-container" class="time-grid mt-3" role="group"></div>
            <div id="timeLoading" class="load-overlay"
                 style="position:absolute; inset:0; background:rgba(13,17,27,.86); color:#fff; display:none; align-items:center; justify-content:center; gap:12px; border-radius:14px;">
              <div class="spinner-border text-info" role="status"></div>
              <strong>جاري جلب المواعيد…</strong>
            </div>
          </div>
        </section>

        <!-- PAGE 4: Contact -->
        <section id="page4" class="page">
          <h1>👤 معلومات الاتصال • 連絡先</h1>
          <div class="card">
            <div class="row g-3">
              <div class="col-12 col-md-6">
                <label for="name" class="form-label">الاسم • お名前</label>
                <input id="name" type="text" class="form-control" placeholder="الاسم كما سيظهر في الفاتورة" autocomplete="name"/>
                <div class="field-error" id="err-name">يرجى إدخال الاسم</div>
              </div>
              <div class="col-12 col-md-6">
                <label for="mobile" class="form-label">رقم الجوال • 携帯番号</label>
                <input id="mobile" type="tel" class="form-control" placeholder="5XXXXXXXX" autocomplete="tel"/>
                <div class="field-error" id="err-mobile">الرجاء إدخال رقم جوال صحيح</div>
              </div>
            </div>
          </div>
        </section>

        <!-- PAGE 5: Payment -->
        <section id="page5" class="page">
          <h1>💴 طريقة الدفع • お支払い</h1>
          <div class="pay-grid" role="radiogroup" id="payGroup" aria-describedby="err-pay" >
            <label class="pay-card" role="radio" aria-checked="false" tabindex="0" style="grid-column:1/-1">
              <input type="radio" name="payingMethod" value="mada" class="visually-hidden" />
              <span class="pay-card__content">
                <img class="pay-card__img" src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/MADA%20LOGO.png" alt="Mada" />
                <span class="pay-card__label">مدى • Mada</span>
              </span>
            </label>
          </div>
          <div class="field-error" id="err-pay" role="alert">يرجى اختيار طريقة الدفع</div>
        </section>

        <!-- PAGE 6: Map (with no-Google fallback) -->
        <section id="page6" class="page">
          <h1>🗺️ الموقع على الخريطة • 位置</h1>
          <div class="card">
            <div class="map-search mb-3">
              <input id="mapSearch" class="form-control" type="text" placeholder="ابحث داخل السعودية • 住所/ランドマーク"/>
            </div>
            <div id="googleMap"></div>

            <!-- Fallback UI if Maps can't load -->
            <div id="mapFallback" class="map-fallback mt-3">
              <input id="manualLocation" class="form-control" placeholder="أدخل (lat,lng) أو العنوان"/>
              <button id="useManualLocation" class="btn btn-outline-primary" type="button">استخدم هذا الموقع</button>
            </div>
          </div>
          <small id="mapHint" class="text-muted d-block mt-2" style="text-align:center">اضغط على الخريطة أو اسحب العلامة لتحديد موقعك • 地図をタップまたはピンをドラッグ</small>
          <div class="field-error" id="err-map" style="text-align:center">الرجاء تحديد الموقع</div>
        </section>

        <!-- PAGE 7: Review -->
        <section id="page7" class="page">
          <h1>🔎 مراجعة الطلب • 最終確認</h1>
          <div class="card" style="max-width:820px">
            <p class="text-muted mb-3">راجع تفاصيل حجزك ثم اضغط "تأكيد الطلب"</p>

            <div class="d-flex justify-content-between py-2 border-bottom"><span>المنطقة</span><span class="fw-bold" id="rv-area">—</span></div>
            <div class="d-flex justify-content-between py-2 border-bottom"><span>الخدمة</span><span class="fw-bold" id="rv-service">—</span></div>
            <div class="d-flex justify-content-between py-2 border-bottom"><span>عدد السيارات</span><span class="fw-bold" id="rv-cars">—</span></div>
            <div class="d-flex justify-content-between py-2 border-bottom"><span>التاريخ</span><span class="fw-bold" id="rv-date">—</span></div>
            <div class="d-flex justify-content-between py-2 border-bottom"><span>الأوقات</span><span class="fw-bold" id="rv-times">—</span></div>
            <div class="d-flex justify-content-between py-2 border-bottom"><span>الاسم</span><span class="fw-bold" id="rv-name">—</span></div>
            <div class="d-flex justify-content-between py-2 border-bottom"><span>الجوال</span><span class="fw-bold" id="rv-mobile">—</span></div>
            <div class="d-flex justify-content-between py-2 border-bottom"><span>الإضافات</span><span class="fw-bold" id="rv-addons">—</span></div>
            <div class="d-flex justify-content-between py-2 border-bottom"><span>الدفع</span><span class="fw-bold" id="rv-pay">—</span></div>
            <div class="d-flex justify-content-between py-2 border-top">
              <span>الإجمالي</span><span class="fw-bold" id="rv-total">—</span>
            </div>

            <div class="d-flex gap-2 flex-wrap mt-3">
              <button class="btn btn-outline-secondary" type="button" data-edit-step="2">تعديل الخدمة</button>
              <button class="btn btn-outline-secondary" type="button" data-edit-step="3">تعديل الوقت</button>
              <button class="btn btn-outline-secondary" type="button" data-edit-step="4">تعديل البيانات</button>
              <button class="btn btn-outline-secondary" type="button" data-edit-step="5">تغيير الدفع</button>
              <button id="confirmOrder" class="btn btn-primary ms-auto" type="button">✅ تأكيد الطلب</button>
            </div>
          </div>
        </section>

        <!-- PAGE 8: Done -->
        <section id="page8" class="page">
          <h1>🌸 ありがとうございました • شكراً لكم</h1>
          <div class="card text-center" style="max-width:720px">
            <p class="mb-3">تم استلام طلبكم، وسنؤكد الموعد على واتساب قريبًا</p>
          </div>
        </section>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer id="siteFooter" class="sticky-nav">
    <div class="footer-inner">
      <div class="footer-brand">نحل • <a href="https://nahl.app" target="_blank" rel="noopener">Nahl.app</a></div>
      <div class="footer-actions" style="flex:1;gap:12px">
        <button id="footer-prev" type="button" class="btn-footer hidden">السابق</button>
        <button id="footer-next" type="button" class="btn-footer primary disabled" disabled>次へ • التالي</button>
        <div id="footer-wait" style="display:none; align-items:center; gap:10px; color:#fff; font-weight:800">
          <span class="spinner-border spinner-border-sm"></span>
          <span>يتم إرسال الطلب…</span>
        </div>
      </div>
    </div>
  </footer>

  <!-- ================== JS (CDN → local vendor fallback) ================== -->
  <script>
    AssetLoader.addJsWithFallback(
      "https://code.jquery.com/jquery-3.6.3.min.js",
      "./vendor/jquery.min.js",
      "jQuery"
    );
    AssetLoader.addJsWithFallback(
      "https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js",
      "./vendor/select2.min.js",
      null
    );
    AssetLoader.addJsWithFallback(
      "https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js",
      "./vendor/luxon.min.js",
      "luxon"
    );
    AssetLoader.addJsWithFallback(
      "https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/intlTelInputWithUtils.js",
      "./vendor/intlTelInput.min.js",
      null
    );
    AssetLoader.addJsWithFallback(
      "https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js",
      "./vendor/bootstrap.bundle.min.js",
      null
    );
  </script>

  <!-- ================== APP LOGIC (same workflow, trimmed + offline guards) ================== -->
  <script>
    // --------- Utilities / toast
    function showToast(type='info', msg=''){
      const wrap=document.getElementById('toastWrap');
      const div=document.createElement('div');
      div.style.minWidth='260px'; div.style.color='#fff'; div.style.padding='10px 14px';
      div.style.borderRadius='10px'; div.style.boxShadow='0 24px 64px rgba(0,0,0,.45)';
      div.style.background = type==='error' ? '#dc2626' : type==='success' ? '#16a34a' : '#0284c7';
      div.textContent=msg; wrap.appendChild(div);
      setTimeout(()=>{ div.style.opacity='0'; div.style.transform='translateY(-6px)'; setTimeout(()=>div.remove(), 180); }, 2400);
    }
    function handleLogoError(img){
      const fallbacks = [
        "https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20%20Soap/spong&Soap%20-%20logo.png",
        "https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20%26%20Soap/spong%26Soap%20-%20logo.png",
        "https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20%26%20Soap/logo.png"
      ];
      const i = Number(img.dataset.fidx||0);
      if (i < fallbacks.length){ img.dataset.fidx = String(i+1); img.src = fallbacks[i]; }
      else { img.style.display = 'none'; }
    }

    // --------- NAHL endpoints (unchanged)
    const APP_ID='6e6b8ca3-e69a-48de-8522-16a496cc5214';
    const base=`https://nahl-platform.vercel.app/api/app/AM/general/${APP_ID}`;
    const defaultLink2=`${base}/form`;
    const RESERVE_URL_PRIMARY  =`${defaultLink2}/reserveAppointment`;
    const RESERVE_URL_FALLBACK =`${base}/reserveAppointment`;

    let controllers=[]; function callContent2(path, cb, abortable=false, retries=2){
      let signal=''; if(abortable){ controllers.forEach(([c])=>c.abort()); controllers=[]; const controller=new AbortController(); signal=controller.signal; controllers.push([controller,signal]); }
      fetch(defaultLink2+path,{method:'GET',redirect:'follow',...(abortable&&{signal}),cache:'no-store'}).then(r=>{
        if(!r.ok) throw 0; return r.json();
      }).then(j=>cb(j)).catch(_=>{
        if(retries>0) setTimeout(()=>callContent2(path,cb,abortable,retries-1), 700);
        else cb({ok:false,data:[]});
      });
    }

    function sanitizeNahlPayload(n){
      const s = v => (v == null ? '' : String(v).trim());
      return { date:s(n.date), time:s(n.time), location:s(n.location), service:s(n.service), serviceCount:s(n.serviceCount||'1'),
               serviceCat:s(n.serviceCat), customerM:s(n.customerM), customerN:s(n.customerN),
               paymentMethod:s((n.paymentMethod||'').toLowerCase()), urlLocation:s(n.urlLocation),
               locationDescription:s(n.locationDescription), locale:'ar' };
    }
    async function postReservationOriginal(payload){
      const body=JSON.stringify(payload);
      const headers1={'Content-Type':'text/plain;charset=UTF-8','Accept':'application/json'};
      const headers2={'Content-Type':'application/json;charset=UTF-8','Accept':'application/json'};
      try{
        const r=await fetch(RESERVE_URL_PRIMARY,{method:'POST',headers:headers1,body});
        const t=await r.text(); let d=null; try{d=JSON.parse(t);}catch(_){}
        if(r.ok) return {ok:true,status:r.status,data:d||{},raw:t,url:RESERVE_URL_PRIMARY};
        if(r.status===415||r.status===406){
          const r2=await fetch(RESERVE_URL_PRIMARY,{method:'POST',headers:headers2,body}); const t2=await r2.text(); let d2=null; try{d2=JSON.parse(t2);}catch(_){}
          if(r2.ok) return {ok:true,status:r2.status,data:d2||{},raw:t2,url:RESERVE_URL_PRIMARY};
          if(r2.status!==404) return {ok:false,status:r2.status,data:d2,raw:t2,url:RESERVE_URL_PRIMARY};
        }
        if(r.status!==404) return {ok:false,status:r.status,data:d,raw:t,url:RESERVE_URL_PRIMARY};
      }catch(_){}
      try{
        const r=await fetch(RESERVE_URL_FALLBACK,{method:'POST',headers:headers1,body}); const t=await r.text(); let d=null; try{d=JSON.parse(t);}catch(_){}
        if(r.ok) return {ok:true,status:r.status,data:d||{},raw:t,url:RESERVE_URL_FALLBACK};
        const r2=await fetch(RESERVE_URL_FALLBACK,{method:'POST',headers:headers2,body}); const t2=await r2.text(); let d2=null; try{d2=JSON.parse(t2);}catch(_){}
        return {ok:r2.ok,status:r2.status,data:d2,raw:t2,url:RESERVE_URL_FALLBACK};
      }catch(e2){ return {ok:false,status:0,error:String(e2),url:RESERVE_URL_FALLBACK}; }
    }

    // --------- State
    const DateTime = window.luxon ? luxon.DateTime : null;
    const orderedPages=["page1","page2","page3","page4","page5","page6","page7","page8"];
    const STEPS_LABELS=["الترحيب","الخدمة","الوقت","البيانات","الدفع","الموقع","مراجعة","تم"];
    const STEP_GROUP_INDEX={page1:0,page2:1,page3:2,page4:3,page5:4,page6:5,page7:6,page8:7};

    let selectedTimes=[]; let servicesSheetCache=[]; let categoriesFromSheet=[];
    let itiPhone=null, positionUrl=""; let isSubmitting=false;
    let currentTimeFilter='all'; let selectedAddons=[];
    const nForm={date:'',time:'',location:'',service:'',serviceCount:'1',serviceCat:'',customerM:'',customerN:'',paymentMethod:'',urlLocation:'',locationDescription:'', locale:'ar'};

    function getActiveIndex(){ const id=document.querySelector('.page.active')?.id; return Math.max(0, orderedPages.indexOf(id)); }
    function showPage(idx){
      const cur=document.querySelector('.page.active'); const next=document.getElementById(orderedPages[idx]); if(!next||cur===next) return;
      if(cur){ cur.classList.remove('active'); cur.classList.add('exit'); }
      next.style.display='flex'; requestAnimationFrame(()=>{ next.classList.add('active'); setTimeout(()=>{ if(cur){cur.classList.remove('exit'); cur.style.display='none';} }, 240); });
      syncProgress(idx); renderSummary(next.id); updateNextAvailability(); if(next.id==='page7') populateReview();
    }
    function syncProgress(i){
      const pct=((i+1)/orderedPages.length)*100;
      document.getElementById('miniBarFill').style.width=pct+'%';
      document.getElementById('miniStepTitle').textContent=STEPS_LABELS[Math.min(i,STEPS_LABELS.length-1)];
      const prev=document.getElementById('footer-prev'); const next=document.getElementById('footer-next'); const wait=document.getElementById('footer-wait');
      const onThanks=(orderedPages[i]==='page8'); prev.classList.toggle('hidden', i===0 || onThanks); next.classList.toggle('hidden', onThanks); wait.style.display='none';
      next.textContent = (i===0) ? 'تخطي العرض' : (orderedPages[i]==='page7' ? 'تأكيد الطلب' : 'التالي');
    }
    function renderSummary(currentId){
      const wrap=document.getElementById('summaryChips'); if(!wrap) return;
      const currGroup=STEP_GROUP_INDEX[currentId] ?? 0; wrap.style.display = currGroup === 0 ? 'none' : 'flex'; if(currGroup===0){ wrap.innerHTML=''; return; }
      const areaTxt=$('#area').find(':selected').text()||''; const srvTxt=$('#service').find(':selected').text()||'';
      const dt=nForm.date || ''; const tmChip = selectedTimes.length ? (selectedTimes.length===1 ? selectedTimes[0] : `${selectedTimes.length} مواعيد`) : '';
      const pay=(nForm.paymentMethod||''); const locOk=!!positionUrl;
      const chips=[ {i:'fa-location-dot',t:'المنطقة',v:areaTxt,g:1}, {i:'fa-screwdriver-wrench',t:'الخدمة',v:srvTxt,g:1}, {i:'fa-car',t:'السيارات',v:String(nForm.serviceCount||'1'),g:1}, {i:'fa-clock',t:'الموعد',v:(dt && tmChip)?`${dt} • ${tmChip}`:'',g:2}, {i:'fa-credit-card',t:'الدفع',v:(pay?pay.toUpperCase():''),g:4}, {i:'fa-map-pin',t:'الموقع',v:(locOk?'تم التحديد':''),g:5} ];
      wrap.innerHTML=''; chips.filter(c=>c.v && c.g<=currGroup).forEach(c=>{ const el=document.createElement('div'); el.className='chip'+(c.g===currGroup?' current':''); el.innerHTML=`<i class="fa-solid ${c.i}"></i><span class="title">${c.t}:</span><span class="value">${c.v}</span>`; wrap.appendChild(el); });
    }

    function updateNextAvailability(){
      const i=getActiveIndex(); const nextBtn=document.getElementById('footer-next'); let enable=true;
      if(i===0){ enable=true; }
      else if(i===1){ enable=!!($('#area').val()&&$('#service').val()&&$('#numCars').val()); }
      else if(i===2){ const need = parseInt(nForm.serviceCount||'1',10); enable = selectedTimes.length === need; }
      else if(i===3){ const nameOk=($('#name').val()||'').trim().length>0; enable=nameOk && (window.intlTelInput ? (itiPhone && itiPhone.isValidNumber()) : true); }
      else if(i===4){ enable=!!(document.querySelector('#payGroup input:checked')); }
      else if(i===5){ enable=!!positionUrl; }
      nextBtn.disabled=!enable; nextBtn.classList.toggle('disabled',!enable);
    }

    // ---- Minimal data bootstrapping (works even if GAS/NAHL fail)
    const demoAreas=[{id:'JUBAIL',text:'الجبيل'},{id:'DAMMAM',text:'الدمام'}];
    const demoCats=['غسيل خارجي فقط','غسيل داخلي وخارجي'];
    const demoServices=[ // minimal placeholders
      {TS_service_id:'101',TS_service_arabic_name:'سيارة صغيرة • Small',TS_category_arabic_name:'غسيل خارجي فقط',TS_service_description_ar:'غسيل خارجي سريع ولمعان.',TS_price:'35',TS_image_url:'',TS_price_tags:'غسيل خارجي سريع'},
      {TS_service_id:'102',TS_service_arabic_name:'سيارة متوسطة • Medium',TS_category_arabic_name:'غسيل خارجي فقط',TS_service_description_ar:'غسيل خارجي ولمعان.',TS_price:'40',TS_image_url:'',TS_price_tags:'لمعة ممتازة'},
      {TS_service_id:'201',TS_service_arabic_name:'بريميوم كامل',TS_category_arabic_name:'غسيل داخلي وخارجي',TS_service_description_ar:'تنظيف داخلي وخارجي.',TS_price:'80',TS_image_url:'',TS_price_tags:'تنظيف مقاعد'}
    ];

    // ---- DOM Ready
    function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
    ready(function(){
      // Select2 init (with fallbacks if select2 failed to load)
      if (window.jQuery && $.fn.select2){
        $('#area').select2({ width:'100%', placeholder:'اختر المنطقة', dir:'rtl', data:demoAreas });
        $('#serviceCat').select2({ width:'100%', placeholder:'فئة الخدمة', dir:'rtl', data: demoCats.map(x=>({id:x,text:x})) });
        $('#service').select2({ width:'100%', placeholder:'الخدمة', dir:'rtl', minimumResultsForSearch:Infinity });
        $('#numCars').select2({ width:'100%', placeholder:'عدد السيارات', dir:'rtl', minimumResultsForSearch:Infinity });
      }else{
        // Native selects (fallback)
        const area = document.getElementById('area'); demoAreas.forEach(o=>{ const opt=new Option(o.text,o.id); area.add(opt); });
        const cat = document.getElementById('serviceCat'); demoCats.forEach(x=>cat.add(new Option(x,x)));
      }

      // Seed services cache (replace by GAS when available)
      servicesSheetCache = demoServices.slice();

      // Render default category/services
      const firstCat = demoCats[0];
      renderServiceCardsByCategory_FromSheet(firstCat);
      $('#serviceCat').val(firstCat).trigger('change');

      // Phone input (fallback valid check)
      if (window.intlTelInput){
        itiPhone = window.intlTelInput(document.querySelector('#mobile'), { initialCountry:'sa', onlyCountries:['sa','ae','bh','kw','om','qa'], separateDialCode:true, placeholderNumberType:'MOBILE' });
      }

      // Date
      const today = (DateTime ? DateTime.now().toFormat('yyyy-LL-dd') : new Date().toISOString().slice(0,10));
      $('#date').val(today).attr('min', today);

      // Events
      $('#numCars').on('change', function(){ nForm.serviceCount = String(Math.min(Math.max(parseInt(this.value||'1',10)||1,1),5)); updateNextAvailability(); });
      $('#name').on('input', function(){ nForm.customerN=this.value.trim(); updateNextAvailability(); });
      $('#mobile').on('blur input', function(){ updateNextAvailability(); });

      document.getElementById('footer-next').addEventListener('click', gotoNext);
      document.getElementById('footer-prev').addEventListener('click', () => { const i = getActiveIndex(); showPage(Math.max(i - 1, 0)); });

      // Payment cards choose
      document.querySelectorAll('#payGroup .pay-card').forEach(card=>{
        const input=card.querySelector('input'); const choose=()=>{ document.querySelectorAll('#payGroup .pay-card').forEach(c=>{ c.setAttribute('aria-checked','false'); c.querySelector('input').checked=false; }); card.setAttribute('aria-checked','true'); input.checked=true; nForm.paymentMethod=input.value; updateNextAvailability(); showPage(5); };
        card.addEventListener('click', choose); card.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){e.preventDefault(); choose();}});
      });

      // Try to hydrate real areas/cats/services from NAHL/GAS (best effort)
      callContent2(`/locations`, res => {
        const list = res?.data || [];
        if (list.length && window.jQuery && $.fn.select2) {
          $('#area').empty().select2({ data: list.map(l=>({id:l.id, text:l.TS_location_arabic_name})), width:'100%', placeholder:'اختر المنطقة', dir:'rtl' });
        }
      });
      // GAS services best-effort
      (function(){
        const url='https://script.google.com/macros/s/AKfycbwMXUFLd6th5C6cK7E999aTdHXuWHcUOq7KzGzxJE4RUaEt2tWNg98p98hXqYCTE-F7YQ/exec?action=serviceMetaAll&callback=GAS_CB&_='+(Date.now());
        window.GAS_CB = function(res){
          if (res?.ok && Array.isArray(res.data) && res.data.length){
            servicesSheetCache = res.data;
            const uniq=[...new Set(servicesSheetCache.map(r=>String(r.TS_category_arabic_name||'').trim()).filter(Boolean))];
            if (uniq.length && window.jQuery && $.fn.select2){
              $('#serviceCat').empty().select2({ data: uniq.map(n=>({id:n,text:n})), width:'100%', placeholder:'فئة الخدمة', dir:'rtl' });
              $('#serviceCat').val(uniq[0]).trigger('change');
            }
          }
        };
        const s=document.createElement('script'); s.src=url; s.async=true; s.onerror=function(){}; document.head.appendChild(s);
      })();

      // Map init (if Google fails, we show fallback UI)
      setTimeout(()=>{ if(!(window.google && google.maps)){ document.getElementById('mapFallback').classList.add('show'); } }, 2500);
      document.getElementById('useManualLocation').addEventListener('click', ()=>{
        const raw = (document.getElementById('manualLocation').value||'').trim();
        if (!raw){ showToast('error','أدخل موقعًا'); return; }
        // Accept "lat,lng" or any text (address)
        const m = raw.match(/^\s*(-?\d+(\.\d+)?)\s*,\s*(-?\d+(\.\d+)?)\s*$/);
        if (m){ positionUrl = `https://www.google.com/maps/search/?api=1&query=${m[1]},${m[3]}`; }
        else   { positionUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(raw)}`; }
        document.getElementById('mapHint').innerHTML = `تم اختيار الموقع: <strong>${raw}</strong>`;
        updateNextAvailability(); showToast('success','تم تعيين الموقع');
      });

      // Initial state
      renderSummary('page1'); syncProgress(0); nForm.serviceCount='1'; updateNextAvailability();
    });

    // ---- Service rendering (same as earlier, shortened)
    const arCurrency = Intl && Intl.NumberFormat ? new Intl.NumberFormat('ar-SA',{style:'currency',currency:'SAR'}) : null;
    function priceFormat(v){ try{return arCurrency?arCurrency.format(Number(v)||0): (String(v)+' ر.س');}catch(_){return String(v)} }
    function getServiceMeta(s){
      const img  = s.TS_image_url || '';
      const desc = s.TS_service_description_ar || '';
      const cat  = s.TS_category_arabic_name || '';
      const priceNumRaw = (s.TS_price != null && s.TS_price !== '') ? String(s.TS_price) : '';
      const priceNum    = priceNumRaw ? Number(priceNumRaw.replace(/[^\d.]/g,'')) : NaN;
      const priceText   = s.TS_price_text || '';
      let tags = [];
      if (!isNaN(priceNum)) tags.unshift(priceFormat(priceNum));
      else if (priceText)   tags.unshift(String(priceText));
      const extra = (s.TS_price_tags||'').split(/[\n,،|/]+/).map(x=>x.trim()).filter(Boolean);
      tags.push(...extra);
      return { img, desc, tags, category: cat };
    }
    function buildCardDOM(service, meta){
      const card=document.createElement('div'); card.className='svc-card'; card.setAttribute('role','radio'); card.setAttribute('tabindex','0'); card.dataset.serviceId=String(service.TS_service_id);
      const thumb=document.createElement('div'); thumb.className='svc-thumb';
      if(meta.img){ const img=document.createElement('img'); img.src=meta.img; img.alt=service.TS_service_arabic_name||('خدمة '+service.TS_service_id); img.onerror=()=>{thumb.textContent='🧽'}; thumb.appendChild(img); } else { thumb.textContent='🧽'; }
      const body=document.createElement('div'); body.style.flex='1 1 auto';
      const title=document.createElement('div'); title.className='svc-title'; title.textContent=service.TS_service_arabic_name||service.TS_service_id;
      const cat=document.createElement('span'); cat.className='svc-cat'; cat.textContent = (meta.category ? '🍡 '+meta.category : '');
      const head=document.createElement('div'); head.style.display='flex'; head.style.alignItems='center'; head.style.gap='8px'; head.appendChild(title); if(meta.category) head.appendChild(cat);
      const desc=document.createElement('p'); desc.className='svc-desc'; desc.textContent=meta.desc||'';
      const tags=document.createElement('div'); meta.tags.forEach((t,i)=>{ const chip=document.createElement('span'); chip.className='price-tag'+(i%2?' alt':''); chip.textContent=t; tags.appendChild(chip); });
      tags.style.display='flex'; tags.style.flexWrap='wrap'; tags.style.gap='6px';
      const cta=document.createElement('div'); cta.className='svc-cta'; cta.textContent='🗼';
      body.appendChild(head); body.appendChild(desc); body.appendChild(tags);
      card.appendChild(thumb); card.appendChild(body); card.appendChild(cta);
      card.addEventListener('click',()=>{ chooseServiceCard(card); });
      card.addEventListener('keydown',e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); chooseServiceCard(card);} });
      return card;
    }
    function chooseServiceCard(card){
      const id=card?.dataset?.serviceId; if(!id) return;
      $('#service').val(id).trigger('change'); nForm.service=id;
      document.querySelectorAll('#serviceCards .svc-card').forEach(c=>{ const sel=c===card; c.setAttribute('aria-checked', sel?'true':'false'); });
      renderSummary('page2'); updateNextAvailability(); showToast('success','تم اختيار الخدمة');
    }
    function renderServiceCardsByCategory_FromSheet(categoryName){
      const wrap=document.getElementById('serviceCards'); if(!wrap) return;
      wrap.innerHTML='';
      const list = servicesSheetCache.filter(s => String(s.TS_category_arabic_name||'').trim() === String(categoryName||'').trim());
      if(!list.length){ document.getElementById('svcEmpty').style.display='block'; return; }
      document.getElementById('svcEmpty').style.display='none';
      const $svc=$('#service'); $svc.empty();
      list.forEach(s=>{ const id=String(s.TS_service_id); const name=s.TS_service_arabic_name || `خدمة ${id}`; if ($svc.length) $svc.append(new Option(name, id, false, false)); const meta=getServiceMeta(s); wrap.appendChild(buildCardDOM(s, meta)); });
      const toSelect=String(list[0].TS_service_id); $('#service').val(toSelect).trigger('change'); nForm.service=toSelect;
      renderSummary('page2'); updateNextAvailability();
    }

    // ---- Navigation
    async function gotoNext(){
      const i=getActiveIndex(); const id=orderedPages[i];
      if(id==='page1'){ showPage(1); return; }
      if(id==='page2'){
        const ok = !!$('#area').val() && !!$('#serviceCat').val() && !!$('#service').val() && !!$('#numCars').val();
        if (!ok){ showToast('error','يرجى إكمال اختيار المنطقة/التصنيف/الخدمة/عدد السيارات'); return; }
        // Load demo times immediately
        const slots = ["18:00","19:00","20:00","21:00","22:00"];
        const container=document.getElementById('time-container'); container.innerHTML='';
        slots.forEach(hhmm=>{ const b=document.createElement('button'); b.type='button'; b.className='time-option'; b.setAttribute('dir','ltr'); b.textContent=hhmm; b.onclick=()=>{ const have=selectedTimes.indexOf(hhmm)>=0; const limit=parseInt(nForm.serviceCount||'1',10); if(have) selectedTimes=selectedTimes.filter(x=>x!==hhmm); else{ if(selectedTimes.length>=limit){showToast('error','وصلت للحد الأقصى'); return;} selectedTimes.push(hhmm);} [...container.children].forEach(x=>x.setAttribute('aria-pressed', selectedTimes.includes(x.textContent)?'true':'false')); updateNextAvailability(); }; container.appendChild(b); });
        showPage(2); return;
      }
      if(id==='page3'){
        const need=parseInt(nForm.serviceCount||'1',10); if(selectedTimes.length!==need){ showToast('error',`الرجاء اختيار ${need} وقت`); return; }
        nForm.date = document.getElementById('date').value || '';
        showPage(3); return;
      }
      if(id==='page4'){
        const nameOk=($('#name').val()||'').trim().length>0;
        const phoneOk = window.intlTelInput ? (itiPhone && itiPhone.isValidNumber()) : ($('#mobile').val()||'').trim().length>=8;
        if(!nameOk||!phoneOk){ showToast('error','تحقق من الاسم والجوال'); return; }
        nForm.customerN=$('#name').val().trim();
        nForm.customerM = (window.intlTelInput && itiPhone) ? itiPhone.getNumber().replace(/^\+/,'') : $('#mobile').val().trim();
        showPage(4); return;
      }
      if(id==='page5'){
        if(!nForm.paymentMethod){ document.getElementById('err-pay').style.display='block'; showToast('error','اختر طريقة الدفع'); return; }
        document.getElementById('err-pay').style.display='none';
        showPage(5); return;
      }
      if(id==='page6'){
        if(!positionUrl){ document.getElementById('err-map').style.display='block'; showToast('error','حدد الموقع'); return; }
        document.getElementById('err-map').style.display='none';
        showPage(6); return;
      }
      if(id==='page7'){
        await submitAllAppointments(); return;
      }
      showPage(Math.min(i+1, orderedPages.length-1));
    }

    function populateReview(){
      const area = $('#area').find(':selected').text() || '—';
      const srv  = $('#service').find(':selected').text() || '—';
      const cars = String(nForm.serviceCount||'1');
      const dateTxt = nForm.date || '—';
      const timesTxt = selectedTimes.length ? selectedTimes.join('، ') : '—';
      const name = ($('#name').val()||'').trim() || '—';
      const mobile = (window.intlTelInput && itiPhone && itiPhone.isValidNumber()) ? itiPhone.getNumber() : ($('#mobile').val()||'—');
      const addons = (selectedAddons && selectedAddons.length) ? selectedAddons.join('، ') : '—';
      const pay = (nForm.paymentMethod||'').toUpperCase() || '—';
      document.getElementById('rv-area').textContent=area;
      document.getElementById('rv-service').textContent=srv;
      document.getElementById('rv-cars').textContent=cars;
      document.getElementById('rv-date').textContent=dateTxt;
      document.getElementById('rv-times').textContent=timesTxt;
      document.getElementById('rv-name').textContent=name;
      document.getElementById('rv-mobile').textContent=mobile;
      document.getElementById('rv-addons').textContent=addons;
      document.getElementById('rv-pay').textContent=pay;
      document.getElementById('rv-total').textContent='—';
      document.getElementById('confirmOrder').onclick=submitAllAppointments;
    }

    async function submitAllAppointments(){
      const base = sanitizeNahlPayload(nForm);
      if (!base.date || !selectedTimes.length || !base.location || !base.service || !base.customerN || !base.customerM || !base.paymentMethod || !positionUrl){
        showToast('error','أكمل الحقول المطلوبة قبل الإرسال'); return;
      }
      if (isSubmitting) return; isSubmitting=true;
      document.getElementById('footer-next').style.display='none'; document.getElementById('footer-prev').style.display='none';
      document.getElementById('footer-wait').style.display='flex';
      let ok=true;
      for (const t of selectedTimes){
        const payload = { ...base, time:t, urlLocation: positionUrl };
        const r = await postReservationOriginal(payload);
        if(!(r.ok && r.data?.success)) ok=false;
      }
      if (ok){ showPage(7); showToast('success','تم إنشاء الحجوزات'); }
      else { showToast('error','تعذر إنشاء بعض الحجوزات'); document.getElementById('footer-next').style.display=''; document.getElementById('footer-prev').style.display=''; document.getElementById('footer-wait').style.display='none'; isSubmitting=false; }
    }

    // Small observer to keep footer progress happy
    (function observeStepChange(){
      const obs = new MutationObserver(()=>{ const i=getActiveIndex(); syncProgress(i); });
      obs.observe(document.querySelector('.stage'), { subtree:true, attributes:true, attributeFilter:['class'] });
    })();

    // Abort fetches on pagehide
    window.addEventListener('pagehide', () => {
      try { if (Array.isArray(controllers)) controllers.forEach(([c]) => { try { c.abort(); } catch(_){} }); } catch(_){}
    });
  </script>

  <!-- ================== Google Maps (best-effort). If blocked, fallback UI is used. ================== -->
  <script>
    // If the script fails to load (blocked), map fallback UI will stay visible.
    function initMap(){
      // If it loads, you can wire the full map here (omitted for brevity).
      // In many blocked environments, this callback never fires, so we rely on the manual fallback above.
    }
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBBHLoO038vsCovHN-SLUgAXqexlA2v0_4&callback=initMap&v=weekly&loading=async&libraries=places,geometry&language=ar&region=SA" async defer></script>
</body>
</html>
