<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>حجوزات المواعيد</title>

  <!-- UI libs already in your project -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800&display=swap" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/css/intlTelInput.css" rel="stylesheet"/>

  <style>
    :root{
      --brand-700:#01657A; --brand-600:#027A93; --brand-200:#BFE6F0; --brand-050:#F0FAFC;
      --ink-900:#0B2630; --ink-700:#224652; --surface-000:#FFF; --surface-100:#EDF3F6; --border-300:#D4E0E6;
      --radius-md:14px; --shadow-xs:0 2px 6px rgba(11,38,48,.07); --shadow-sm:0 3px 12px rgba(11,38,48,.09); --shadow-md:0 10px 28px rgba(11,38,48,.14);
      --ease:cubic-bezier(.22,.61,.36,1); --ease-decel:cubic-bezier(0.2,0,0,1); --ease-accel:cubic-bezier(0.3,1,0.8,1);
      --dur-xs:160ms; --dur-sm:220ms; --dur-md:460ms; --dur-lg:640ms;
      --fs-xxl:1.6rem; --fs-xl:1.375rem; --fs-md:1rem; --fs-sm:.9rem; --fw-bold:800;
      --sp-2:8px; --sp-3:12px; --sp-4:16px; --sp-5:20px; --sp-6:24px; --sp-7:32px;
      --header-h:76px; --footer-h:78px;
    }

    html,body{height:100%}
    body{
      margin:0; font-family:'Cairo',sans-serif; color:#fff;
      background:
        linear-gradient(180deg, rgba(11,38,48,.65), rgba(11,38,48,.35)),
        url("https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/lorenzo-hamers-n1SRvkP6bEk-unsplash%20(1).jpg") center/cover fixed;
      min-height:100vh; display:flex; flex-direction:column;
      padding-top:var(--header-h); padding-bottom:var(--footer-h);
    }

    header{position:sticky; top:0; z-index:50; height:var(--header-h); background:rgba(11,38,48,.36); backdrop-filter:blur(10px); border-bottom:1px solid rgba(255,255,255,.15); display:flex; align-items:center; justify-content:center;}
    .header-inner{max-width:1120px; width:100%; padding:0 var(--sp-3); display:flex; align-items:center; justify-content:space-between}
    .brand{display:flex; align-items:center; gap:10px}
    .brand img{height:54px; width:auto; object-fit:contain; filter:drop-shadow(0 6px 20px rgba(0,0,0,.25))}
    .mini-progress{display:flex; align-items:center; gap:var(--sp-3); width:60%}
    .mini-progress .bar{flex:1; height:8px; background:rgba(255,255,255,.25); border-radius:999px; overflow:hidden}
    .mini-progress .bar>span{display:block; height:100%; width:0%; background:linear-gradient(90deg, var(--brand-600), var(--brand-200)); transition:width var(--dur-md) var(--ease-decel)}
    .mini-progress .step{font-weight:var(--fw-bold); font-size:var(--fs-md)}

    main{flex:1 0 auto; display:flex; justify-content:center; padding:var(--sp-2) var(--sp-3) 0}
    #app{width:100%; max-width:1120px}

    .stage{position:relative; min-height:540px; padding:8px 0 20px}
    .page{position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; gap:var(--sp-5); padding:var(--sp-5) var(--sp-3) var(--sp-6); overflow:auto; opacity:0; transform:translateY(12px) scale(.992); pointer-events:none;}
    @media (prefers-reduced-motion: no-preference){
      .page.active{ pointer-events:auto; animation:pageIn var(--dur-md) var(--ease-decel) both; }
      .page.exit  { animation:pageOut var(--dur-sm) var(--ease-accel) both; }
    }
    @keyframes pageIn{ from{opacity:0; transform:translateY(12px) scale(.992)} to{opacity:1; transform:translateY(0) scale(1)} }
    @keyframes pageOut{ from{opacity:1; transform:translateY(0) scale(1)} to{opacity:0; transform:translateY(14px) scale(.985)} }
    .page h1{font-size:var(--fs-xl); font-weight:var(--fw-bold); margin:0; text-align:center}

    .card{background:#fff; color:#0B2630; border-radius:var(--radius-md); box-shadow:var(--shadow-md); padding:var(--sp-6); width:100%; max-width:920px}
    .form-control, select, .select2-selection{
      background:#fff; color:#0B2630; border:1px solid var(--border-300) !important; border-radius:var(--radius-md)!important;
      min-height:48px; text-align:center; font-size:var(--fs-md);
      transition:border-color var(--dur-xs) var(--ease), box-shadow var(--dur-xs) var(--ease);
    }
    .form-control:focus{ box-shadow:0 0 0 4px rgba(2,122,147,.12) }
    .select2-selection{height:48px !important; display:flex; align-items:center}
    .select2-selection__rendered{line-height:48px !important}

    .time-grid{display:grid; grid-template-columns:repeat(2,1fr); gap:var(--sp-4)}
    @media (min-width:540px){ .time-grid{grid-template-columns:repeat(3,1fr)} }
    .time-option{background:#fff; color:#0B2630; font-weight:var(--fw-bold); border:1px solid var(--border-300); border-radius:var(--radius-md); padding:14px 10px; min-height:56px; box-shadow:var(--shadow-xs); transition:transform var(--dur-xs) var(--ease), box-shadow var(--dur-xs) var(--ease), background var(--dur-xs) var(--ease); display:flex; flex-direction:column; align-items:center; justify-content:center;}
    .time-option:hover{transform:translateY(-2px); background:var(--brand-050); box-shadow:var(--shadow-sm)}
    .time-option:active{transform:translateY(0) scale(.995)}
    .time-option[aria-checked="true"]{outline:3px solid var(--brand-600); outline-offset:2px}

    .load-overlay{ position:absolute; inset:0; background:rgba(255,255,255,.85); color:#0B2630; display:none; align-items:center; justify-content:center; gap:12px; border-radius:var(--radius-md); }
    .load-overlay.show{display:flex; animation:fadeIn var(--dur-sm) var(--ease) both}

    .pay-grid{display:grid; grid-template-columns:1fr 1fr; gap:var(--sp-4); width:100%; max-width:920px}
    .pay-card{background:#fff; color:#0B2630; border:1px solid var(--border-300); border-radius:var(--radius-md); padding:var(--sp-6); display:flex; justify-content:center; align-items:center; gap:var(--sp-4); min-height:64px; cursor:pointer; transition:transform var(--dur-xs) var(--ease), box-shadow var(--dur-xs) var(--ease), background var(--dur-xs) var(--ease);}
    .pay-card:hover{transform:translateY(-2px); box-shadow:var(--shadow-sm); background:var(--brand-050)}
    .pay-card[aria-checked="true"]{outline:3px solid var(--brand-600); outline-offset:2px}

    footer.sticky-nav{ position:sticky; bottom:0; z-index:40; height:var(--footer-h); background:rgba(11,38,48,.45); backdrop-filter:blur(10px); border-top:1px solid rgba(255,255,255,.15); display:flex; align-items:center; justify-content:center; }
    .footer-inner{ max-width:1120px; width:100%; padding:8px 12px; display:flex; align-items:center; justify-content:space-between; }
    .footer-actions{display:flex; gap:12px}
    .btn-footer{ flex:1; border:1px solid var(--border-300); border-radius:var(--radius-md); padding:12px 16px; min-height:48px; font-size:var(--fs-md); font-weight:var(--fw-bold); background:#fff; color:#027A93; }
    .btn-footer.primary{background:#027A93; color:#fff; border-color:#027A93}
    .btn-footer.hidden{visibility:hidden}
    .btn-footer.disabled, .btn-footer:disabled{opacity:.6; pointer-events:none}
  </style>
</head>
<body>
  <!-- Toasts -->
  <div id="toastWrap" class="toast-wrap" aria-live="polite" aria-atomic="true" style="position:fixed;top:10px;left:50%;transform:translateX(-50%);z-index:1050"></div>

  <!-- Header -->
  <header>
    <div class="header-inner">
      <div class="mini-progress" aria-hidden="true">
        <div class="bar"><span id="miniBarFill" style="width:0%"></span></div>
        <div class="step" id="miniStepTitle">الترحيب</div>
      </div>
      <div class="brand">
        <img id="brandLogo" alt="Sponge &amp; Soap" src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20%20Soap/spong&Soap%20-%20logo.png" onerror="handleLogoError(this)"/>
        <strong id="brandText" style="display:none;color:#fff;font-weight:800">Sponge &amp; Soap</strong>
      </div>
    </div>
  </header>

  <!-- Body -->
  <main>
    <div id="app">
      <div class="stage">
        <!-- 1) Welcome -->
        <section id="page1" class="page active" aria-label="الترحيب">
          <h1 class="visually-hidden">عرض ترحيبي</h1>
          <div class="card text-center" style="background:transparent; box-shadow:none; padding:0;">
            <p class="mb-0" style="opacity:.9">أهلاً وسهلاً — للحجز اختر المنطقة والخدمة ثم الوقت</p>
          </div>
        </section>

        <!-- 2) Service & Location -->
        <section id="page2" class="page" aria-label="اختيار المنطقة والخدمة">
          <h1>وين تحب نجيك؟</h1>
          <div class="card position-relative" id="servicesCard">
            <label class="form-label">اختيار المنطقة</label>
            <select id="area" style="width:100%"></select>

            <div class="row g-3 mt-3">
              <div class="col-12 col-md-6">
                <label class="form-label">التصنيف</label>
                <select id="serviceCat" style="width:100%"></select>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label">الخدمة</label>
                <select id="service" style="width:100%"></select>
              </div>
              <div class="col-12">
                <label class="form-label">عدد السيارات</label>
                <select id="serviceCount" class="form-select">
                  <option value="1" selected>1</option><option value="2">2</option>
                  <option value="3">3</option><option value="4">4</option><option value="5">5</option>
                </select>
              </div>
            </div>

            <input id="departmentId" type="hidden"/>
            <small class="text-muted d-block mt-2">القسم: <span id="departmentBadge">—</span></small>

            <div id="servicesLoading" class="load-overlay">
              <div class="spinner-border text-info" role="status" aria-hidden="true"></div>
              <strong>جاري تحميل الخدمات…</strong>
            </div>
          </div>
        </section>

        <!-- 3) Time -->
        <section id="page4" class="page" aria-label="اختيار الموعد">
          <h1>متى تحب نجيك؟</h1>
          <div class="card position-relative">
            <div class="row g-3">
              <div class="col-12 col-md-5">
                <label class="form-label" for="date">التاريخ</label>
                <input id="date" type="date" class="form-control"/>
              </div>
            </div>
            <div class="position-relative mt-3">
              <div id="time-container" class="time-grid" role="radiogroup" aria-label="اختيار الوقت"></div>
              <div id="timeLoading" class="load-overlay">
                <div class="spinner-border text-info" role="status" aria-hidden="true"></div>
                <strong>جاري جلب المواعيد…</strong>
              </div>
            </div>
          </div>
        </section>

        <!-- 4) Contact -->
        <section id="page5" class="page" aria-label="معلومات الاتصال">
          <h1>معلومات الاتصال</h1>
          <div class="card">
            <div class="row g-3">
              <div class="col-12 col-md-6">
                <label for="name" class="form-label">الإسم</label>
                <input id="name" type="text" class="form-control" placeholder="اسمك الكريم" autocomplete="name"/>
              </div>
              <div class="col-12 col-md-6">
                <label for="mobile" class="form-label">رقم الجوال</label>
                <input id="mobile" type="tel" class="form-control" placeholder="+9665…" autocomplete="tel"/>
              </div>
            </div>
          </div>

          <h1>معلومات المركبة</h1>
          <div class="card">
            <div class="row g-3">
              <div class="col-12 col-md-4">
                <label class="form-label" for="carBrand">ماركة السيارة 🚘</label>
                <select id="carBrand" style="width:100%"></select>
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label" for="carName">اسم السيارة</label>
                <input id="carName" type="text" class="form-control" placeholder="كامري، إلنترا…"/>
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label" for="plateNumber">آخر 4 أرقام من اللوحة <span aria-hidden="true" style="color:#dc2626">*</span></label>
                <input id="plateNumber" type="text" inputmode="numeric" maxlength="4" class="form-control" placeholder="1234" required/>
                <small class="text-muted d-block mt-1" style="opacity:.85">نحتاج آخر ٤ أرقام للتأكيد فقط</small>
              </div>
              <input id="locationDescription" type="text" hidden/>
            </div>
          </div>

          <h1>طريقة الدفع</h1>
          <div class="pay-grid" id="payGroup" role="radiogroup" aria-label="طريقة الدفع">
            <label class="pay-card" tabindex="0" role="radio" aria-checked="false">
              <input type="radio" name="payingMethod" value="STC Pay" class="visually-hidden"/>
              <img src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/STC%20PAY%20LOGO.png" alt="STC Pay">
            </label>
            <label class="pay-card" tabindex="-1" role="radio" aria-checked="false">
              <input type="radio" name="payingMethod" value="Cash" class="visually-hidden"/>
              <strong>Cash</strong>
            </label>
            <label class="pay-card" style="grid-column:1/-1" tabindex="-1" role="radio" aria-checked="false">
              <input type="radio" name="payingMethod" value="MADA" class="visually-hidden"/>
              <img src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/MADA%20LOGO.png" alt="Mada">
            </label>
          </div>
        </section>

        <!-- 5) Map -->
        <section id="page6" class="page" aria-label="اختيار الموقع">
          <h1>الموقع على خريطة قوقل</h1>
          <div class="card">
            <div id="googleMap" style="width:100%;height:420px;border-radius:14px;overflow:hidden"></div>
          </div>
          <div class="card text-center">
            <button id="show-my-location" class="btn btn-outline-primary" type="button">إظهار موقعي</button>
          </div>
          <small id="mapHint" class="text-muted d-block mt-2" style="text-align:center">اضغط على الخريطة أو اسحب العلامة لتحديد موقعك</small>
        </section>

        <!-- 6) Done -->
        <section id="page7" class="page" aria-label="تم الحجز">
          <h1>شكراً لكم</h1>
          <div class="card text-center">
            <p class="mb-3" style="color:#224652">تم حجز الموعد، وراح نأكده لكم على الواتساب</p>
            <button id="rebook" class="btn btn-primary" type="button">🔁 حجز جديد</button>
          </div>
        </section>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="sticky-nav" aria-label="التنقل بين الخطوات">
    <div class="footer-inner">
      <div class="footer-actions">
        <button id="footer-prev" type="button" class="btn-footer hidden">السابق</button>
        <button id="footer-next" type="button" class="btn-footer primary disabled" disabled>التالي</button>
        <button id="page1-button" class="btn-footer primary">تخطي</button>
      </div>
    </div>
  </footer>

  <!-- JS libs -->
  <script src="https://code.jquery.com/jquery-3.6.3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/intlTelInputWithUtils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /* ---------------- Config ---------------- */
    const APP_ID = '33e0d05d-d771-46f4-a7e7-7c634b4e3a9e';
    const API_BASE = `https://nahl-platform.vercel.app/api/app/AM/general/${APP_ID}/form`;
    const URLS = {
      locations: `${API_BASE}/locations`,
      services:  (locId)=>`${API_BASE}/services?location=${encodeURIComponent(locId)}`,
      appointments: (date, locId, srvId)=>`${API_BASE}/appointments?startDate=${encodeURIComponent(date)}&location=${encodeURIComponent(locId)}${srvId?`&service=${encodeURIComponent(srvId)}`:''}`,
      reserve:   `${API_BASE}/reserveAppointment`
    };

    /* ---------------- Utilities ---------------- */
    function handleLogoError(img){
      const fallbacks = [
        "https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20%26%20Soap/logo.png",
        "https://dummyimage.com/180x54/027A93/ffffff.png&text=Sponge+%26+Soap"
      ];
      const i = Number(img.dataset.fidx||0);
      if (i < fallbacks.length){ img.dataset.fidx = String(i+1); img.src = fallbacks[i]; }
      else { img.style.display = 'none'; const txt = document.getElementById('brandText'); if (txt) txt.style.display = 'block'; }
    }

    function showToast(type='info', msg=''){
      const wrap=document.getElementById('toastWrap');
      const div=document.createElement('div');
      div.className='toast-msg '+(type==='error'?'bg-danger':type==='success'?'bg-success':'bg-info');
      div.style.cssText='min-width:260px;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 10px 28px rgba(11,38,48,.14)';
      div.textContent=msg; wrap.appendChild(div);
      setTimeout(()=>{ div.style.opacity='0'; div.style.transform='translateY(-6px)'; setTimeout(()=>div.remove(), 200); }, 2400);
    }

    const DateTime = luxon.DateTime;

    function setLoadingTimes(on){ document.getElementById('timeLoading').classList.toggle('show', !!on); }
    function setLoadingServices(on){ document.getElementById('servicesLoading')?.classList.toggle('show', !!on); }

    function getActiveIndex(){ const orderedPages=["page1","page2","page4","page5","page6","page7"]; const id=document.querySelector('.page.active')?.id; return Math.max(0, orderedPages.indexOf(id)); }
    function updateProgress(i){
      const orderedPages=["page1","page2","page4","page5","page6","page7"]; const steps=["الترحيب","الخدمة","الوقت","البيانات","الموقع","تم"];
      const pct=((i+1)/orderedPages.length)*100;
      document.getElementById('miniBarFill').style.width=pct+'%';
      document.getElementById('miniStepTitle').textContent=steps[Math.min(i,steps.length-1)];
    }
    function showPage(idx){
      const orderedPages=["page1","page2","page4","page5","page6","page7"];
      const cur=document.querySelector('.page.active'); const next=document.getElementById(orderedPages[idx]); if(!next||cur===next) return;
      if(cur){ cur.classList.remove('active'); cur.classList.add('exit'); }
      next.style.display='flex';
      requestAnimationFrame(()=>{ next.classList.add('active'); setTimeout(()=>{ if(cur){cur.classList.remove('exit'); cur.style.display='none';}}, 260); });
      updateProgress(idx); updateNextAvailability();
    }

    /* ---------------- State ---------------- */
    let selectedTime=null, positionUrl="";
    let servicesCache=null, categoriesCache=null, itiPhone=null;
    const nForm={date:'',time:'',location:'',service:'',serviceCount:'1',serviceCat:'',customerM:'',customerN:'',paymentMethod:'',urlLocation:'',locationDescription:'', departmentId:''};

    function updateNextAvailability(){
      const i = getActiveIndex();
      const nextBtn = document.getElementById('footer-next');
      let enable = true;
      if(i === 1){ // service/location
        enable = !!($('#area').val() && $('#service').val());
      } else if(i === 2){ // time
        enable = !!selectedTime;
      } else if(i === 3){ // contact
        const nameOk = $('#name').val().trim().length > 0;
        const phoneOk = (itiPhone && itiPhone.isValidNumber());
        const payOk = !!nForm.paymentMethod;
        const plateOk = ($('#plateNumber').val()||'').length === 4;
        enable = nameOk && phoneOk && payOk && plateOk;
      } else if(i === 4){ // map
        enable = !!positionUrl;
      }
      nextBtn.disabled = !enable;
      nextBtn.classList.toggle('disabled', !enable);
    }

    /* ---------------- Fetch helpers (with logs) ---------------- */
    async function getJSON(url, abortable=false){
      console.groupCollapsed('%c[GET]', 'color:#0ea5e9;font-weight:700', url);
      try{
        const res = await fetch(url, { method:'GET', cache:'no-store' });
        console.log('status:', res.status, res.statusText);
        const data = await res.json().catch(()=>null);
        console.log('payload:', data);
        console.groupEnd();
        if(!res.ok) throw new Error(`GET ${res.status}`);
        return data;
      }catch(e){
        console.error('[GET] failed:', e);
        console.groupEnd();
        throw e;
      }
    }

    async function postReservation(payload){
      const url = URLS.reserve;
      console.groupCollapsed('%c[POST reserve]', 'color:#a855f7;font-weight:700', url);
      console.log('payload:', payload);
      try{
        // Use text/plain so server `readBody()` returns a string and their JSON.parse succeeds.
        const res = await fetch(url, {
          method:'POST',
          headers:{ 'Content-Type':'text/plain;charset=UTF-8', 'Accept':'application/json' },
          body: JSON.stringify(payload),
          cache:'no-store',
          credentials:'omit',
          referrerPolicy:'no-referrer'
        });
        const raw = await res.text();
        let json=null; try{ json = JSON.parse(raw); } catch(_){}
        console.log('status:', res.status, res.statusText);
        console.log('raw:', raw);
        console.groupEnd();
        return { ok: res.ok, status: res.status, data: json, raw };
      }catch(err){
        console.error('[POST] network error:', err);
        console.groupEnd();
        return { ok:false, status:0, error:String(err) };
      }
    }

    /* ---------------- Services / Locations ---------------- */
    async function loadLocations(){
      setLoadingServices(true);
      const res = await getJSON(URLS.locations);
      const list = res?.data || [];
      console.groupCollapsed('%cLocations mapped','color:#16a34a;font-weight:700');
      console.table(list.map(x=>({ id:x.id, name:x.TS_location_arabic_name })));
      console.groupEnd();

      const ds = list.map(l=>({ id:l.id, text:l.TS_location_arabic_name }));
      $('#area').empty().select2({data:ds,width:'100%',placeholder:'اختر المنطقة', dir:'rtl'});
      if(ds.length){ $('#area').val(ds[0].id).trigger('change'); }
      setLoadingServices(false);
    }

    async function loadServices(locationId){
      setLoadingServices(true);
      const res = await getJSON(URLS.services(locationId));
      servicesCache = res?.data?.services || [];
      categoriesCache= res?.data?.servicesCat || [];

      console.groupCollapsed('%cServices/Categories','color:#f59e0b;font-weight:700');
      console.log('services:', servicesCache.length, 'categories:', categoriesCache.length);
      console.table((categoriesCache||[]).map(c=>({id:c.TS_category_id, name:c.TS_category_arabic_name})));
      console.groupEnd();

      const cats = categoriesCache.map(c=>({id:c.TS_category_id, text:c.TS_category_arabic_name}));
      $('#serviceCat').empty().select2({data:cats,width:'100%',placeholder:'التصنيف', dir:'rtl'});
      if(cats.length){ $('#serviceCat').val(cats[0].id).trigger('change'); }
      setLoadingServices(false);
    }

    function getDepartmentIdFromServiceId(sid){
      if(!sid) return '';
      const svc = (servicesCache || []).find(x => String(x.TS_service_id) === String(sid));
      let dep = svc?.TS_appintment_department_id ?? svc?.department_id ?? svc?.TS_department_id ?? '';
      if(dep) return String(dep);
      const catId = $('#serviceCat').val();
      const c = (categoriesCache||[]).find(k => String(k.TS_category_id) === String(catId));
      dep = c?.TS_appintment_department_id ?? c?.department_id ?? c?.TS_department_id ?? '';
      return dep ? String(dep) : '';
    }

    /* ---------------- Times (selected date only) ---------------- */
    let dayTimes = []; // [{label, actual12}]
    let timesLoaded = false;

    function parseTimeISOOrGuess(raw){
      // server sends ISO time-as-date like 1970-01-01T13:30:00.000Z
      let t = DateTime.fromISO(String(raw||''), { setZone:true });
      if (!t.isValid) t = DateTime.fromFormat(String(raw||''), 'HH:mm:ss', { setZone:true });
      if (!t.isValid) t = DateTime.fromFormat(String(raw||''), 'H:mm', { setZone:true });
      return t.isValid ? t : null;
    }

    async function fetchTimesForSelectedDate(){
      const dateEl = document.getElementById('date');
      const selectedISO = (dateEl.value || DateTime.now().toFormat('yyyy-LL-dd')).trim();
      const loc = $('#area').val(); const srv = $('#service').val();
      const timeContainer = document.getElementById('time-container');

      if(!loc || !srv){
        timeContainer.innerHTML = `<div style="grid-column:1/-1;justify-self:center" class="text-muted">اختر المنطقة والخدمة لعرض المواعيد</div>`;
        selectedTime = null; window.selectedTime=null; updateNextAvailability(); return;
      }

      setLoadingTimes(true);
      timeContainer.innerHTML = `
        <div class="spinner-border text-info" role="status" style="grid-column:1/-1;justify-self:center;"><span class="visually-hidden">Loading...</span></div>`;

      const url = URLS.appointments(selectedISO, loc, srv);
      const res = await getJSON(url).catch(e=>({data:{appointments:[]}}));
      const rows = res?.data?.appointments || [];

      console.groupCollapsed('%cAppointments raw','color:#027A93;font-weight:700');
      console.log('requested date:', selectedISO, 'location:', loc, 'service:', srv);
      console.table(rows.slice(0,40).map(r=>({
        date:r.TS_appointment_date, time:r.TS_appointment_time
      })));
      console.groupEnd();

      const now = DateTime.now(); // client local — server already filtered using app tz
      const list = [];
      rows.forEach(r=>{
        const d = DateTime.fromISO(r.TS_appointment_date, { setZone:true });
        if (!d.isValid || d.toISODate() !== selectedISO) return;
        const t = parseTimeISOOrGuess(r.TS_appointment_time);
        if(!t) return;

        // extra guard for "today": hide just-past slots
        if(selectedISO === now.toISODate()){
          const slot = now.set({ hour:t.hour, minute:t.minute, second:0 });
          if(slot < now.plus({minutes:3})) return;
        }

        list.push({ label: t.toLocaleString(DateTime.TIME_SIMPLE), actual12: t.toFormat('hh:mm a') });
      });

      // De-dup by actual12 & sort
      const seen=new Set();
      dayTimes = list.filter(x => { if(seen.has(x.actual12)) return false; seen.add(x.actual12); return true; })
                     .sort((a,b)=> a.actual12.localeCompare(b.actual12));
      timesLoaded = true;

      console.groupCollapsed('%cSlots (unique & sorted)','color:#10b981;font-weight:700');
      console.table(dayTimes);
      console.groupEnd();

      renderSelectedDateTimes(selectedISO);
      setLoadingTimes(false);
    }

    function renderSelectedDateTimes(selectedISO){
      const timeContainer = document.getElementById('time-container');
      timeContainer.innerHTML = '';

      if(!timesLoaded){
        timeContainer.innerHTML = `<div class="spinner-border text-info" role="status" style="grid-column:1/-1;justify-self:center;"></div>`;
        return;
      }
      if(!dayTimes.length){
        timeContainer.innerHTML = `<div style="grid-column:1/-1;justify-self:center" class="text-muted">لا توجد مواعيد متاحة</div>`;
        selectedTime = null; window.selectedTime=null; updateNextAvailability(); return;
      }

      dayTimes.forEach((t) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'time-option';
        btn.setAttribute('role','radio'); btn.setAttribute('aria-checked','false'); btn.setAttribute('dir','ltr');
        btn.textContent = t.label;
        btn.addEventListener('click', ()=>{
          [...timeContainer.children].forEach(el => el.setAttribute('aria-checked','false'));
          btn.setAttribute('aria-checked','true');
          const parsed = DateTime.fromFormat(t.actual12, 'h:mm a');
          nForm.date = selectedISO;
          nForm.time = parsed.isValid ? parsed.toFormat('HH:mm') : t.actual12;
          selectedTime = { ui: t.label, iso:nForm.time }; window.selectedTime = selectedTime;
          console.log('Selected time =>', selectedTime);
          updateNextAvailability();
        });
        timeContainer.appendChild(btn);
      });
    }

    /* ---------------- Init ---------------- */
    $(async function(){
      // date min=today
      const today = DateTime.now().toFormat('yyyy-LL-dd');
      $('#date').val(today).attr('min', today);
      $('#date').on('change', fetchTimesForSelectedDate);

      // selects
      $('#area').select2({width:'100%',placeholder:'اختر المنطقة', dir:'rtl'});
      $('#serviceCat').select2({width:'100%',placeholder:'التصنيف', dir:'rtl'});
      $('#service').select2({width:'100%',placeholder:'الخدمة', dir:'rtl'});
      $('#carBrand').select2({width:'100%',placeholder:'ماركة السيارة', dir:'rtl'});

      // phone
      itiPhone = window.intlTelInput(document.querySelector('#mobile'),{ initialCountry:'sa', onlyCountries:['sa','ae','bh','kw','om','qa'], utilsScript:'https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/utils.js' });

      // locations -> services
      await loadLocations();

      $('#area').on('change', async function(){
        nForm.location=this.value;
        await loadServices(this.value);
        updateNextAvailability();
      });

      $('#serviceCat').on('change', function(){
        nForm.serviceCat = this.value;
        const cid = Number(this.value);
        const items = (servicesCache||[])
          .filter(s=> Number(s.TS_category_id)===cid)
          .sort((a,b)=> a.TS_service_id - b.TS_service_id)
          .map(s=>({id:s.TS_service_id,text:s.TS_service_arabic_name}));
        $('#service').empty().select2({data:items,width:'100%',placeholder:'الخدمة', dir:'rtl'});
        if(items.length){ $('#service').val(items[0].id).trigger('change'); }
        updateNextAvailability();
      });

      $('#service').on('change', function(){
        nForm.service = this.value || '';
        const depId = getDepartmentIdFromServiceId(this.value);
        nForm.departmentId = depId;
        document.getElementById('departmentBadge').textContent = depId || '—';
        document.getElementById('departmentId').setAttribute('value', depId || '');
        // if already on time page, refetch with chosen service
        if(getActiveIndex()===2) fetchTimesForSelectedDate();
        updateNextAvailability();
      });

      // brands quick list
      const brands=["Toyota","Nissan","Hyundai","Kia","Honda","Lexus","BMW","Mercedes-Benz","Chevrolet","Ford","Mazda","Mitsubishi","Aston Martin","Other"].sort().map(b=>({id:b,text:b}));
      $('#carBrand').empty().select2({data:brands,width:'100%'});

      // payment radio
      const payCards = [...document.querySelectorAll('#payGroup .pay-card')];
      payCards.forEach((card, idx)=>{
        const input = card.querySelector('input');
        card.setAttribute('role','radio'); card.setAttribute('aria-checked','false'); card.setAttribute('tabindex', idx===0?'0':'-1');
        const choose = () => {
          payCards.forEach(c=>{ c.setAttribute('aria-checked','false'); c.setAttribute('tabindex','-1'); c.querySelector('input').checked=false; });
          card.setAttribute('aria-checked','true'); card.setAttribute('tabindex','0'); input.checked=true; nForm.paymentMethod=input.value; updateNextAvailability(); };
        card.addEventListener('click', choose);
        card.addEventListener('keydown', (e)=>{
          if(e.key==='Enter' || e.key===' '){ e.preventDefault(); choose(); }
        });
      });

      // validations
      $('#plateNumber').on('input', function(){ this.value = this.value.replace(/\D/g, '').slice(0,4); updateNextAvailability(); });
      $('#name, #mobile, #carName').on('input', updateNextAvailability);
      $('#serviceCount, #serviceCat, #service, #area').on('change', updateNextAvailability);

      // nav
      const orderedPages=["page1","page2","page4","page5","page6","page7"];
      function goto(i){ showPage(i); }
      $('#page1-button').on('click', ()=>goto(1));
      $('#footer-prev').on('click', ()=>{ const i=getActiveIndex(); showPage(Math.max(i-1,0)); });

      $('#footer-next').on('click', async ()=>{
        const i = getActiveIndex();
        const id = ["page1","page2","page4","page5","page6","page7"][i];

        if(id==='page2'){
          if(!$('#area').val()) return showToast('error','يرجى اختيار المنطقة');
          if(!$('#service').val()) return showToast('error','يرجى اختيار الخدمة');
          nForm.service=$('#service').val(); nForm.serviceCount=$('#serviceCount').val()||'1';
          showPage(2); // -> page4
          fetchTimesForSelectedDate();
          return;
        }
        if(id==='page4'){
          if(!selectedTime) return showToast('error','الرجاء اختيار وقت');
          showPage(3);
          return;
        }
        if(id==='page5'){
          const name=$('#name').val().trim();
          if(!name) { showToast('error','يرجى إدخال الاسم'); return; }
          if(!(itiPhone && itiPhone.isValidNumber())) { showToast('error','الرجاء إدخال رقم جوال صحيح'); return; }
          if(($('#plateNumber').val()||'').length !== 4) { showToast('error','رجاءً أدخل آخر ٤ أرقام من اللوحة'); return; }
          if(!nForm.paymentMethod){ showToast('error','يرجى اختيار طريقة الدفع'); return; }

          nForm.customerN = name;
          nForm.customerM = itiPhone.getNumber().replace(/^\+/, '');
          nForm.locationDescription = [$('#carBrand').val()||'', $('#carName').val()||'', $('#plateNumber').val()||''].filter(Boolean).join(', ');
          showPage(4);
          return;
        }
        if(id==='page6'){
          if(!positionUrl){ showToast('error','الرجاء تحديد الموقع على الخريطة'); return; }
          nForm.urlLocation=positionUrl;

          const payload = {
            date: nForm.date,
            time: nForm.time,
            location: nForm.location,
            service: nForm.service,
            serviceCount: nForm.serviceCount,
            serviceCat: nForm.serviceCat,
            customerM: nForm.customerM,
            customerN: nForm.customerN,
            paymentMethod: nForm.paymentMethod,
            urlLocation: nForm.urlLocation,
            locationDescription: nForm.locationDescription || '',
            locale: 'ar'
          };

          const r = await postReservation(payload);

          if(r.ok && r.data?.success){
            if(r.data?.otp){
              console.warn('[reserve] server returned otp:true but UI is OTP-free.');
              showToast('error','الخادم يطلب OTP — عطِّل خيار OTP في إعدادات التطبيق.');
              return;
            }
            showToast('success','تم إنشاء الحجز');
            showPage(5);
          }else{
            console.error('[reserve] failed:', r);
            const msg = r?.data?.msgAR
              || (r.status===404 ? 'تعذّر العثور على المسار /form/reserveAppointment'
                                 : r.status===0   ? 'تعذر الاتصال بالخادم (تحقق من CORS/الشبكة)'
                                                  : 'تعذر إنشاء الحجز');
            showToast('error', msg);
          }
          return;
        }

        showPage(Math.min(i+1, orderedPages.length-1));
      });

      // map
      initDateMin();
    });

    function initDateMin(){
      const today = DateTime.now().toFormat('yyyy-LL-dd');
      const el = document.getElementById('date');
      if(!el.value) el.value = today;
      el.setAttribute('min', today);
    }

    /* ---------------- Google Map ---------------- */
    let map, marker;
    function initMap(){
      const def={lat:26.34165524787632,lng:50.11524831545726};
      map=new google.maps.Map(document.getElementById('googleMap'),{center:def,zoom:12,disableDoubleClickZoom:true});
      marker=new google.maps.Marker({position:def,map,draggable:true,title:'اسحب أو اضغط لتحديد الموقع'});
      const setPos=(latLng,pan=false)=>{ if(!latLng) return; marker.setPosition(latLng); if(pan) map.panTo(latLng); map.setZoom(17); positionUrl=`https://www.google.com/maps/search/?api=1&query=${latLng.lat()},${latLng.lng()}`; document.getElementById('mapHint').innerHTML = `تم اختيار الموقع: <strong>${latLng.lat().toFixed(5)}, ${latLng.lng().toFixed(5)}</strong>`; updateNextAvailability(); };
      marker.addListener('dragend', ({latLng})=>setPos(latLng));
      map.addListener('click', ({latLng})=>setPos(latLng));
      const btn=document.getElementById('show-my-location');
      if(btn){
        btn.addEventListener('click', ()=>{
          if(!navigator.geolocation){ showToast('error','المتصفح لا يدعم تحديد الموقع'); return; }
          navigator.geolocation.getCurrentPosition(
            pos=>setPos(new google.maps.LatLng(pos.coords.latitude,pos.coords.longitude),true),
            err=>{ const msg = err?.message || 'رجاءً فعّل الـ GPS وأذونات الموقع'; showToast('error','تعذر تحديد موقعك: '+msg); },
            { enableHighAccuracy:true, timeout:10000, maximumAge:30000 }
          );
        });
      }
    }
    window.initMap = initMap;
  </script>

  <!-- Google Maps (async) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBBHLoO038vsCovHN-SLUgAXqexlA2v0_4&callback=initMap&v=weekly&loading=async" async defer></script>
</body>
</html>
