<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>حجز الخدمة — نحل</title>

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

  <!-- Minimal libs (Select2, Bootstrap, intlTelInput) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/css/intlTelInput.css" rel="stylesheet"/>

  <style>
/* ===== Design Tokens ===== */
:root{
  --brand-900:#004454; --brand-700:#01657A; --brand-600:#027A93; --brand-500:#2aa4bf;
  --brand-100:#e8f6fa; --brand-050:#f0fafc;
  --ink-900:#0b2630; --ink-700:#224652; --ink-500:#365563;
  --border-300:#d4e0e6; --border-200:#e5eff4;
  --glass:rgba(255,255,255,.92);

  --radius:14px; --radius-lg:18px; --pill:999px;
  --shadow-xs:0 2px 8px rgba(11,38,48,.07);
  --shadow-sm:0 8px 22px rgba(11,38,48,.10);
  --shadow-md:0 14px 40px rgba(11,38,48,.16);

  --header-h:76px; --footer-h:110px;
  --ease:cubic-bezier(.22,.61,.36,1);
  --dur:220ms;

  --bg:url("https://images.unsplash.com/photo-1556227760-2a0a1a7a02d2?q=80&w=2070&auto=format&fit=crop");
}

/* ===== Page Base ===== */
html,body{height:100%}
body{
  font-family:'Cairo',sans-serif; color:#fff; margin:0;
  background:
    linear-gradient(180deg, rgba(11,38,48,.64), rgba(11,38,48,.28)),
    var(--bg) center/cover no-repeat fixed;
  min-height:100dvh; display:flex; flex-direction:column;
  padding-top:var(--header-h); padding-bottom:var(--footer-h);
}

/* ===== Header ===== */
header{
  position:fixed; inset-block-start:0; inset-inline:0; z-index:1000;
  background:rgba(11,38,48,.36); border-bottom:1px solid rgba(255,255,255,.15);
  backdrop-filter:blur(10px);
}
.header-inner{
  max-width:1120px; margin:auto; padding:10px 12px;
  display:flex; align-items:center; justify-content:space-between; gap:12px;
}
.brand img{height:66px; width:auto; object-fit:contain; filter:drop-shadow(0 6px 20px rgba(0,0,0,.25));}
.mini-progress{display:flex; gap:8px; align-items:center; min-width:220px}
.mini-progress .bar{flex:1; height:8px; background:rgba(255,255,255,.25); border-radius:999px; overflow:hidden}
.mini-progress .bar>span{display:block; height:100%; width:0%; background:linear-gradient(90deg,#2aa4bf,#e8f6fa); transition:width .5s var(--ease)}
.summary-chips{display:flex; flex-wrap:wrap; gap:6px}

/* ===== Stage/Pages ===== */
main{flex:1 0 auto; display:flex; justify-content:center; padding:8px 12px 0}
#app{width:100%; max-width:1120px}
.stage{position:relative; min-height:560px; padding:8px 0 20px}
.page{
  position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; gap:18px;
  padding:24px 12px 28px; overflow:auto; opacity:0; transform:translateY(12px) scale(.992); pointer-events:none;
}
.page.active{ pointer-events:auto; animation:pageIn .4s var(--ease) both }
@keyframes pageIn{ from{opacity:0; transform:translateY(12px) scale(.992)} to{opacity:1; transform:translateY(0) scale(1)} }

.card{
  background:var(--glass); color:var(--ink-900); border-radius:var(--radius);
  border:1px solid var(--border-300); box-shadow:var(--shadow-md);
  width:100%; max-width:940px; padding:22px;
}

/* Form */
.form-label{font-weight:800; color:var(--ink-700); margin-bottom:6px}
.form-control, .select2-selection{
  min-height:50px; border-radius:12px!important; border-color:var(--border-300)!important;
}
.form-control:focus{ box-shadow:0 0 0 4px rgba(2,122,147,.12) }
.help{font-size:.9rem; color:var(--ink-500); opacity:.9}
.error{display:none; color:#dc2626; font-size:.9rem; margin-top:6px}
.error[data-show="true"]{display:block}

/* Tabs + Service Grid */
#srvTabs{ display:flex; gap:8px; overflow:auto; padding-bottom:2px }
.srv-tab{
  border:1px solid var(--border-300); border-radius:999px; padding:8px 12px; background:#fff;
  color:var(--ink-900); font-weight:800; white-space:nowrap; cursor:pointer;
}
.srv-tab[aria-selected="true"]{ background:var(--brand-600); color:#fff; border-color:var(--brand-600) }

#srvCards{ display:grid; grid-template-columns:1fr; gap:12px; margin-top:12px }
@media(min-width:560px){ #srvCards{ grid-template-columns:repeat(2,1fr) } }
@media(min-width:900px){ #srvCards{ grid-template-columns:repeat(3,1fr) } }

.srv-card{
  background:#fff; border:1px solid var(--border-300); border-radius:14px; overflow:hidden;
  display:flex; flex-direction:column; min-height:190px; box-shadow:var(--shadow-xs)
}
.srv-thumb{height:120px; background:#eef5f8 center/cover no-repeat; border-bottom:1px solid var(--border-300)}
.srv-body{padding:12px; display:flex; flex-direction:column; gap:8px; flex:1}
.srv-title{margin:0; font-weight:800}
.srv-meta{display:flex; gap:6px; flex-wrap:wrap}
.badge-chip{border:1px solid var(--border-300); border-radius:999px; padding:4px 8px; background:#fff; font-size:.85rem}
.badge-chip.pop{background:var(--brand-050); border-color:var(--brand-600)}
.srv-desc{font-size:.9rem; color:var(--ink-500)}
.srv-actions{margin-top:auto; display:flex; gap:8px; padding:12px; border-top:1px solid var(--border-300)}
.btn-add,.btn-remove{flex:1; min-height:44px; border-radius:12px; font-weight:800}
.btn-add{background:#fff; border:1px solid var(--border-300); color:var(--brand-700)}
.btn-add.selected{background:var(--brand-600); border-color:var(--brand-600); color:#fff}
.btn-remove{background:#fff; border:1px solid var(--border-300); color:var(--ink-900)}

/* Time */
.time-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(110px,1fr)); gap:10px}
.time-option{
  background:#fff; border:1px solid var(--border-300); border-radius:12px;
  min-height:44px; padding:10px 12px; font-weight:800; cursor:pointer
}
.time-option[aria-checked="true"]{ outline:3px solid var(--brand-600); outline-offset:2px; background:var(--brand-050) }

/* Footer Mini-cart */
footer.sticky{
  position:fixed; inset-inline:0; inset-block-end:0; z-index:1000;
  background:rgba(11,38,48,.36); border-top:1px solid rgba(255,255,255,.15); backdrop-filter:blur(8px);
}
.footer-inner{max-width:1120px; margin:auto; padding:10px 12px; display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center}
.footer-cart{
  background:var(--glass); color:var(--ink-900); border:1px solid var(--border-300); border-radius:12px; box-shadow:var(--shadow-sm);
  padding:10px 12px; min-width:0; display:flex; flex-direction:column; gap:4px
}
.fc-line{display:flex; justify-content:space-between; gap:8px; font-weight:800}
.fc-title,.fc-sub{overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
.btn-footer{min-height:48px; border-radius:12px; padding:10px 16px; font-weight:800; border:1px solid var(--border-300); background:#fff; color:var(--brand-700)}
.btn-footer.primary{background:var(--brand-600); border-color:var(--brand-600); color:#fff}
.btn-footer:disabled{opacity:.55; pointer-events:none}

/* Cart Drawer */
.backdrop{position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:1290; display:none; opacity:0; transition:opacity var(--dur) var(--ease)}
.backdrop.show{display:block; opacity:1}
.cart-drawer{
  position:fixed; inset-inline:0; inset-block-end:0; z-index:1300; background:#fff; color:var(--ink-900);
  border-top-left-radius:var(--radius-lg); border-top-right-radius:var(--radius-lg);
  box-shadow:0 -20px 60px rgba(11,38,48,.28); max-height:min(82vh,720px); transform:translateY(105%); transition:transform .45s var(--ease);
  display:flex; flex-direction:column
}
.cart-drawer.show{transform:translateY(0)}
.cart-head{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:12px 16px}
.cart-title{margin:0; font-weight:800; color:var(--ink-700)}
.cart-body{padding:0 16px 10px; overflow:auto}
.cart-row{display:flex; justify-content:space-between; align-items:center; gap:10px; padding:12px 0; border-bottom:1px dashed var(--border-200)}
.cart-row:last-child{border-bottom:0}
.qty{display:inline-flex; align-items:center; gap:8px; border:1px solid var(--border-300); border-radius:12px; padding:6px}
.qty button{width:36px; height:36px; border-radius:10px; border:1px solid var(--border-300); background:#fff; font-weight:800}
.qty .val{min-width:28px; text-align:center; font-weight:800}
.cart-breakdown{border:1px dashed var(--border-200); border-radius:12px; padding:12px; background:#fbfdfe}
.badge-addon{border:1px solid var(--border-300); border-radius:999px; padding:6px 10px; margin:2px; background:#fff; display:inline-flex; align-items:center; gap:6px}
.cart-actions{display:flex; gap:8px; padding:12px 16px 16px}
.cart-actions .btn{flex:1; min-height:48px; border-radius:12px; font-weight:800}
.cart-actions .secondary{background:#fff; border:1px solid var(--border-300)}
.cart-actions .danger{background:#fee2e2; border:1px solid #fecaca; color:#991b1b}

/* Addons Modal */
.modal-wrap{position:fixed; inset:0; z-index:1400; display:none}
.modal-wrap[aria-hidden="false"]{display:block}
.modal-backdrop{position:absolute; inset:0; background:rgba(0,0,0,.45)}
.modal-sheet{position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:min(92vw,520px); background:#fff; color:var(--ink-900); border-radius:16px; padding:16px; box-shadow:var(--shadow-md)}
.modal-title{font-weight:800; color:var(--ink-700); margin:0 0 10px}
.modal-body{display:flex; flex-wrap:wrap; gap:8px; max-height:56vh; overflow:auto}
.modal-actions{display:flex; gap:8px; justify-content:space-between; margin-top:12px}
.modal-actions .btn{min-height:44px; border-radius:10px; font-weight:800}
.modal-actions .secondary{background:#fff; border:1px solid var(--border-300)}
.modal-actions .primary{background:var(--brand-600); border:1px solid var(--brand-600); color:#fff}

/* Skeleton */
.skeleton{height:12px; background:linear-gradient(90deg,#eef5f8,#fff,#eef5f8); background-size:180% 100%; border-radius:8px; animation:s 1.2s var(--ease) infinite}
@keyframes s{0%{background-position:0 0}100%{background-position:-180% 0}}
  </style>
</head>
<body>
  <!-- Toasts -->
  <div id="toasts" style="position:fixed;top:10px;left:50%;transform:translateX(-50%);z-index:1500;display:flex;flex-direction:column;gap:8px" aria-live="assertive" aria-atomic="true"></div>

  <!-- ===== Header ===== -->
  <header>
    <div class="header-inner">
      <div class="brand">
        <img id="brandLogo" alt="Nahl"
          src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/NahlTimeProFrom/NahlTime%20Logo%20Design%20(2).png"
          onerror="this.style.display='none'"/>
      </div>
      <div class="header-right">
        <div class="mini-progress" aria-hidden="true">
          <div class="bar"><span id="miniBar"></span></div>
          <div id="miniStep" class="small">الترحيب</div>
        </div>
        <div id="summaryChips" class="summary-chips" aria-live="polite"></div>
      </div>
    </div>
  </header>

  <!-- ===== Main ===== -->
  <main>
    <div id="app">
      <div class="stage">

        <!-- Welcome -->
        <section id="page1" class="page active" aria-label="الترحيب">
          <h1>✨ نصل إليك — غسيل فاخر بلا انتظار</h1>
          <div class="card text-center">
            <p class="m-0">ابدأ بالمنطقة واختر الخدمة، ثم الوقت، وبعدها بياناتك والدفع والموقع.</p>
          </div>
        </section>

        <!-- Area + Services -->
        <section id="page2" class="page" aria-label="اختيار المنطقة والخدمة">
          <h1>المنطقة والخدمة</h1>
          <div class="card">
            <div class="row g-3">
              <div class="col-12">
                <label class="form-label" for="area">المنطقة</label>
                <select id="area" style="width:100%"></select>
                <div id="err-area" class="error">يرجى اختيار المنطقة</div>
                <div class="help mt-1">اختر المدينة التي سيتم تقديم الخدمة فيها</div>
              </div>
            </div>

            <!-- Category Tabs & Cards -->
            <div id="srvTabs" class="mt-3" role="tablist" aria-label="تصنيفات الخدمة"></div>
            <div id="srvCards" class="mt-2" role="list" aria-label="الخدمات"></div>

            <!-- Addons (desktop quick toggles) -->
            <div class="mt-3 d-none d-md-block">
              <div class="fw-bold mb-2"><i class="fa-solid fa-plus"></i> إضافات (اختياري)</div>
              <div id="addonChips" class="d-flex flex-wrap gap-2"></div>
            </div>

            <!-- Service description -->
            <div id="serviceDesc" class="mt-3" style="display:none">
              <div class="fw-bold mb-1"><i class="fa-regular fa-file-lines"></i> وصف الخدمة</div>
              <div id="serviceDescBody"></div>
            </div>
          </div>
        </section>

        <!-- Time -->
        <section id="page3" class="page" aria-label="اختيار الموعد">
          <h1>الموعد</h1>
          <div class="card">
            <div class="row g-3">
              <div class="col-12 col-md-5">
                <label class="form-label" for="date">التاريخ</label>
                <input id="date" type="date" class="form-control" aria-describedby="err-date"/>
                <div id="err-date" class="error">يرجى اختيار تاريخ صحيح</div>
              </div>
              <div class="col-12 col-md-7">
                <label class="form-label" for="timeFilter">فلترة الوقت</label>
                <select id="timeFilter" class="form-select">
                  <option value="all" selected>كل الأوقات</option>
                  <option value="morning">الصباح (06:00–11:00)</option>
                  <option value="afternoon">الظهر (11:00–16:00)</option>
                  <option value="evening">المساء (16:00–21:00)</option>
                  <option value="night">ليلًا (21:00–23:59)</option>
                </select>
              </div>
            </div>

            <div class="mt-3 position-relative">
              <div id="timeGrid" class="time-grid" role="radiogroup" aria-label="الأوقات المتاحة"></div>
              <div id="timeLoading" class="position-absolute top-50 start-50 translate-middle" style="display:none">
                <div class="spinner-border text-info" role="status" aria-hidden="true"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- Contact -->
        <section id="page4" class="page" aria-label="البيانات">
          <h1>بيانات العميل</h1>
          <div class="card">
            <div class="row g-3">
              <div class="col-12 col-md-6">
                <label for="name" class="form-label">الاسم</label>
                <input id="name" type="text" class="form-control" placeholder="الاسم كما سيظهر في الفاتورة" autocomplete="name"/>
                <div id="err-name" class="error">يرجى إدخال الاسم</div>
              </div>
              <div class="col-12 col-md-6">
                <label for="mobile" class="form-label">رقم الجوال</label>
                <input id="mobile" type="tel" class="form-control" placeholder="مثال 5XXXXXXXX" autocomplete="tel"/>
                <div id="err-mobile" class="error">رقم غير صالح — تأكد منه لو سمحت</div>
                <div class="help mt-1">نستخدمه لتأكيد الحجز عبر واتساب</div>
              </div>
            </div>
          </div>

          <h1>معلومات المركبة</h1>
          <div class="card">
            <div class="row g-3">
              <div class="col-12 col-md-4">
                <label class="form-label" for="carBrand">ماركة المركبة</label>
                <select id="carBrand" style="width:100%"></select>
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label" for="carModel">الفئة/الموديل</label>
                <input id="carModel" type="text" class="form-control" placeholder="مثال: LX 570"/>
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label" for="plate">رقم اللوحة (اختياري)</label>
                <input id="plate" type="text" class="form-control" placeholder="اختياري"/>
                <div class="help mt-1">يساعد الفريق في التعرف على المركبة سريعًا</div>
              </div>
            </div>
          </div>
        </section>

        <!-- Payment -->
        <section id="page5" class="page" aria-label="طريقة الدفع">
          <h1>طريقة الدفع</h1>
          <div class="card">
            <div id="payGroup" class="d-grid" style="grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); gap:10px" role="radiogroup" aria-label="الدفع">
              <label class="btn btn-light border d-flex align-items-center justify-content-center gap-2 py-3" tabindex="0" role="radio" aria-checked="false">
                <input type="radio" name="pay" value="stc pay" class="visually-hidden"/>
                <img src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/STC%20PAY%20LOGO.png" alt="STC Pay" style="max-height:26px">
              </label>
              <label class="btn btn-light border d-flex align-items-center justify-content-center gap-2 py-3" tabindex="-1" role="radio" aria-checked="false">
                <input type="radio" name="pay" value="cash" class="visually-hidden"/>
                <strong>كاش</strong>
              </label>
              <label class="btn btn-light border d-flex align-items-center justify-content-center gap-2 py-3" tabindex="-1" role="radio" aria-checked="false" style="grid-column:1/-1">
                <input type="radio" name="pay" value="mada" class="visually-hidden"/>
                <img src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/MADA%20LOGO.png" alt="Mada" style="max-height:26px">
              </label>
            </div>
            <div id="err-pay" class="error text-center">يرجى اختيار طريقة الدفع</div>
          </div>
        </section>

        <!-- Map -->
        <section id="page6" class="page" aria-label="الموقع على الخريطة">
          <h1>حدد الموقع</h1>
          <div class="card">
            <div class="position-relative mb-2">
              <input id="mapSearch" class="form-control" type="text" placeholder="ابحث عن عنوان داخل نطاق الخدمة"/>
              <i class="fa-solid fa-magnifying-glass" style="position:absolute;left:14px;top:50%;transform:translateY(-50%);color:#405a66"></i>
            </div>
            <div id="googleMap" style="width:100%; min-height:360px; border-radius:14px; border:1px solid var(--border-300)"></div>
            <div class="d-flex gap-2 mt-3">
              <button id="showMyLocation" class="btn btn-outline-primary flex-fill" type="button">إظهار موقعي</button>
              <button id="copyMapLink" class="btn btn-outline-secondary" type="button" title="نسخ رابط الموقع"><i class="fa-regular fa-copy"></i></button>
            </div>
            <div id="mapHint" class="help mt-2">اضغط على الخريطة أو اسحب العلامة لتحديد موقعك</div>
            <div id="err-map" class="error">الرجاء تحديد الموقع</div>
          </div>
        </section>

        <!-- Done -->
        <section id="page7" class="page" aria-label="تم">
          <h1>شكراً لك 🌟</h1>
          <div class="card text-center" style="max-width:720px">
            <p class="mb-3">استلمنا طلبك — سنؤكد الموعد عبر واتساب قريبًا.</p>
            <div id="thanks" class="text-start mx-auto" style="max-width:520px"></div>
            <div class="d-flex gap-2 justify-content-center mt-3 flex-wrap">
              <a id="waShare" class="btn btn-success" target="_blank" rel="noopener"><i class="fa-brands fa-whatsapp"></i> مشاركة</a>
              <button id="rebook" class="btn btn-primary" type="button">🔁 احجز نفس الخدمة</button>
            </div>
          </div>
        </section>

      </div>
    </div>
  </main>

  <!-- ===== Footer (Mini Cart + Nav) ===== -->
  <footer class="sticky">
    <div class="footer-inner">
      <div class="footer-cart" id="miniCart" aria-live="polite">
        <div class="fc-line">
          <span id="fc-title">السلة — لم يتم اختيار خدمة</span>
          <span id="fc-total">—</span>
        </div>
        <div id="fc-sub" class="fc-sub">اختر خدمة ثم أكمل الخطوات</div>
      </div>
      <div class="d-flex gap-2">
        <button id="openCart" class="btn-footer" type="button"><i class="fa-solid fa-basket-shopping"></i> السلة</button>
        <button id="prevBtn" class="btn-footer" type="button" style="display:none">السابق</button>
        <button id="nextBtn" class="btn-footer primary" type="button" disabled>ابدأ الآن</button>
      </div>
    </div>
  </footer>

  <!-- ===== Cart Drawer ===== -->
  <div id="backdrop" class="backdrop" aria-hidden="true"></div>
  <aside id="cart" class="cart-drawer" role="dialog" aria-modal="true" aria-labelledby="cartTitle" aria-hidden="true">
    <div class="cart-head">
      <h3 id="cartTitle" class="cart-title"><i class="fa-solid fa-basket-shopping"></i> السلة</h3>
      <div class="d-flex gap-2">
        <button id="clearCart" class="btn btn-sm danger" type="button" title="تفريغ السلة">تفريغ</button>
        <button id="closeCart" class="btn btn-sm btn-light" type="button" title="إغلاق"><i class="fa-solid fa-xmark"></i></button>
      </div>
    </div>
    <div id="cartBody" class="cart-body">
      <div class="text-muted">السلة فارغة — اختر خدمة من الأعلى.</div>
    </div>
    <div class="cart-actions">
      <button id="cartContinue" class="btn secondary" type="button">متابعة التسوق</button>
      <button id="cartConfirm" class="btn btn-primary" type="button">تأكيد الخدمة</button>
    </div>
  </aside>

  <!-- ===== Addons Modal ===== -->
  <div id="addonModal" class="modal-wrap" aria-hidden="true">
    <div class="modal-backdrop" data-close="1"></div>
    <div class="modal-sheet" role="dialog" aria-modal="true" aria-labelledby="addonTitle">
      <h3 id="addonTitle" class="modal-title"><i class="fa-solid fa-plus"></i> اختر إضافات (اختياري)</h3>
      <div id="addonList" class="modal-body"></div>
      <div class="modal-actions">
        <button id="addonCancel" class="btn secondary" type="button">إلغاء</button>
        <button id="addonApply" class="btn primary" type="button">تأكيد</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/intlTelInputWithUtils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
/* =========================
   CONFIG
   ========================= */
const APP_ID = '21eddbf5-efe5-4a5d-9134-b581717b17ff';
const GAS_BASE_URL = 'https://script.google.com/macros/s/REPLACE_WITH_YOUR_DEPLOYMENT_ID/exec'; // <-- replace
const USE_TABS_AND_CARDS = true;

/* =========================
   STATE
   ========================= */
const DateTime = luxon.DateTime;
const PAGES = ['page1','page2','page3','page4','page5','page6','page7'];
const STEP_LABELS = ['الترحيب','الخدمة','الوقت','البيانات','الدفع','الموقع','تم'];
const NEXT_LABEL = {page1:'ابدأ الآن',page2:'عرض المواعيد',page3:'بيانات العميل',page4:'اختيار الدفع',page5:'تحديد الموقع',page6:'تأكيد الحجز'};

let services=[], categories=[];
let activeCat=null, selectedServiceId=null;
let addonsOptions=[];
let selectedTime=null, times=[], timeFilter='all';
let map, marker, allowedPoly, positionUrl='';
let iti=null;

const form = {
  area:'', serviceCat:'', service:'', serviceCount:1,
  date:'', time:'', paymentMethod:'',
  customerN:'', customerM:'',
  carBrand:'', carModel:'', plate:'',
  addons:[]
};

/* =========================
   HELPERS
   ========================= */
const $id = id => document.getElementById(id);
function toast(type='info', text=''){
  const w=$id('toasts'); const el=document.createElement('div');
  el.style.cssText='min-width:260px;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 10px 28px rgba(11,38,48,.14)';
  el.style.background = type==='error'?'#dc2626':type==='success'?'#16a34a':'#0284c7';
  el.textContent=text; w.appendChild(el);
  setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateY(-6px)'; setTimeout(()=>el.remove(), 180); }, 2400);
}
function currency(n){ try{return new Intl.NumberFormat('ar-SA',{style:'currency',currency:'SAR'}).format(n);}catch(_){return n+' ر.س'} }
function parsePrice(s){ const n=Number(String(s||'').replace(/[^\d.]/g,'')); return Number.isFinite(n)?n:NaN; }
function setNextEnabled(on){ const b=$id('nextBtn'); b.disabled=!on; }
function updateProgress(){
  const i=getIndex(); $id('miniBar').style.width=((i+1)/PAGES.length*100)+'%';
  $id('miniStep').textContent=STEP_LABELS[i]||'';
  $id('prevBtn').style.display = i===0 || PAGES[i]==='page7' ? 'none' : '';
  const nb = $id('nextBtn'); nb.textContent = NEXT_LABEL[PAGES[i]] || 'التالي';
  // enable/disable
  let enable=true;
  if(i===0) enable=true;
  if(i===1) enable=!!(form.area && form.service);
  if(i===2) enable=!!selectedTime;
  if(i===3) enable=!!(form.customerN && (iti?.isValidNumber?.() ?? true));
  if(i===4) enable=!!form.paymentMethod;
  if(i===5) enable=!!positionUrl;
  setNextEnabled(enable);
}
function getIndex(){ const id=document.querySelector('.page.active')?.id; return Math.max(0, PAGES.indexOf(id)); }
function showPage(i){
  const cur=document.querySelector('.page.active');
  const nxt=$id(PAGES[i]); if(!nxt || cur===nxt) return;
  cur?.classList.remove('active'); cur?.setAttribute('aria-hidden','true');
  nxt.style.display='flex'; nxt.classList.add('active'); nxt.setAttribute('aria-hidden','false');
  if(cur) cur.style.display='none';
  updateProgress(); renderChips();
}
function renderChips(){
  const wrap=$id('summaryChips'); wrap.innerHTML='';
  const i=getIndex(); if(i===0) return;
  const chips=[];
  if(form.area){ chips.push({i:'fa-location-dot',t:'المنطقة',v=$('#area').find(':selected').text(), to:'page2'}); }
  if(form.service){ chips.push({i:'fa-screwdriver-wrench',t:'الخدمة',v=$('#serviceName').text()||$('#service').find(':selected').text(), to:'page2'}); }
  if(form.date && form.time){ chips.push({i:'fa-clock',t:'الوقت',v:`${form.date} • ${form.time}`, to:'page3'}); }
  if(form.customerN){ chips.push({i:'fa-user',t:'العميل',v:form.customerN, to:'page4'}); }
  if(form.paymentMethod){ chips.push({i:'fa-credit-card',t:'الدفع',v:form.paymentMethod.toUpperCase(), to:'page5'}); }
  if(positionUrl){ chips.push({i:'fa-map-pin',t:'الموقع',v:'تم التحديد', to:'page6'}); }
  chips.forEach(c=>{
    const el=document.createElement('div'); el.className='badge-chip'; el.style.cursor='pointer';
    el.innerHTML=`<i class="fa-solid ${c.i}"></i> <strong>${c.t}:</strong> ${c.v}`;
    el.onclick=()=>{ const idx=PAGES.indexOf(c.to); if(idx>=0) showPage(idx); };
    wrap.appendChild(el);
  });
}

/* =========================
   GAS FETCH
   ========================= */
async function api(route, params){
  const qs = new URLSearchParams({route, ...params});
  const url = `${GAS_BASE_URL}?${qs.toString()}`;
  const res = await fetch(url, {headers:{'Accept':'application/json'}});
  if(!res.ok) throw new Error('Network');
  return res.json();
}
async function loadServices(){
  try{
    const j = await api('services',{appId:APP_ID});
    services = Array.isArray(j?.data?.services)?j.data.services:[];
    categories = Array.isArray(j?.data?.servicesCat)?j.data.servicesCat:[];
    renderCategories(); renderCards(); updateMiniCart();
  }catch(e){ toast('error','تعذر تحميل الخدمات'); }
}
async function loadAddons(){
  try{
    const j=await api('additionalServices',{appId:APP_ID});
    addonsOptions = (Array.isArray(j?.data)?j.data:[]).map(x=>String(x?.label||'').trim()).filter(Boolean);
    renderAddonChips();
  }catch(e){ /* silent */ }
}
async function loadServiceDesc(idOrName){
  $id('serviceDesc').style.display='block';
  $id('serviceDescBody').innerHTML='<div class="skeleton" style="width:92%"></div><div class="skeleton" style="width:70%"></div><div class="skeleton" style="width:82%"></div>';
  try{
    const p={appId:APP_ID}; if(idOrName.id) p.serviceId=idOrName.id; else p.serviceName=idOrName.name;
    const j=await api('serviceDescription', p);
    const desc=j?.data?.description || '—';
    $id('serviceDescBody').innerHTML = `<p class="m-0" style="white-space:pre-wrap">${desc}</p>`;
  }catch(_){ $id('serviceDescBody').innerHTML = '<span class="text-muted">لا يوجد وصف</span>'; }
}

/* =========================
   UI: Categories & Cards
   ========================= */
function renderCategories(){
  const wrap=$id('srvTabs'); wrap.innerHTML='';
  if(!categories.length){ wrap.innerHTML='<span class="text-muted">لا توجد تصنيفات</span>'; return; }
  if(!activeCat) activeCat=String(categories[0].TS_category_id);
  categories.forEach(c=>{
    const b=document.createElement('button'); b.type='button'; b.className='srv-tab';
    b.setAttribute('role','tab'); b.setAttribute('aria-selected', String(activeCat)===String(c.TS_category_id));
    b.textContent=c.TS_category_arabic_name || ('تصنيف '+c.TS_category_id);
    b.onclick=()=>{ activeCat=String(c.TS_category_id); form.serviceCat=activeCat; renderCategories(); renderCards(); updateMiniCart(); };
    wrap.appendChild(b);
  });
}
function buildBadges(s){
  const list=[];
  if(String(s.TS_popular||'').toLowerCase()==='true') list.push({t:'الأكثر طلبًا',pop:true});
  if(s.TS_badges) String(s.TS_badges).split(',').map(x=>x.trim()).filter(Boolean).forEach(t=>list.push({t, pop:false}));
  return list;
}
function cardHTML(s, selected){
  const price=s.TS_price?`<span class="badge-chip"><i class="fa-solid fa-tag"></i> ${s.TS_price}</span>`:'';
  const dur=s.TS_duration?`<span class="badge-chip"><i class="fa-regular fa-clock"></i> ${s.TS_duration}</span>`:'';
  const badges=buildBadges(s).map(b=>`<span class="badge-chip ${b.pop?'pop':''}"><i class="fa-solid fa-star${b.pop?'':'-half-stroke'}"></i> ${b.t}</span>`).join('');
  const desc=(s.TS_short_desc||'').toString().trim();
  return `
  <article class="srv-card" role="listitem" aria-selected="${selected?'true':'false'}" data-id="${s.TS_service_id}">
    <div class="srv-thumb" style="${s.TS_thumb_url?`background-image:url('${s.TS_thumb_url}')`:''}"></div>
    <div class="srv-body">
      <h3 class="srv-title">${s.TS_service_arabic_name||('خدمة '+s.TS_service_id)}</h3>
      <div class="srv-meta">${price}${dur}</div>
      ${desc?`<p class="srv-desc">${desc}</p>`:''}
      <div>${badges}</div>
    </div>
    <div class="srv-actions">
      <button class="btn-add ${selected?'selected':''}" type="button">${selected?'تمت الإضافة ✓':'إضافة إلى السلة'}</button>
      ${selected?'<button class="btn-remove" type="button">إزالة</button>':''}
    </div>
  </article>`;
}
function renderCards(){
  const grid=$id('srvCards'); grid.innerHTML='';
  const list = services.filter(s=>String(s.TS_category_id)===String(activeCat));
  if(!list.length){ grid.innerHTML='<div class="text-muted">لا توجد خدمات في هذا التصنيف</div>'; return; }
  grid.innerHTML = list.map(s=>cardHTML(s, String(selectedServiceId)===String(s.TS_service_id))).join('');
  // Bind actions
  [...grid.querySelectorAll('.srv-card')].forEach(card=>{
    const id=card.dataset.id;
    const svc=services.find(x=>String(x.TS_service_id)===String(id));
    const selectBtn=card.querySelector('.btn-add');
    selectBtn.onclick=()=>{
      selectedServiceId=id; form.service=id; form.serviceCat=String(svc.TS_category_id||activeCat);
      $('#serviceName').remove(); const span=document.createElement('span'); span.id='serviceName'; span.textContent=svc.TS_service_arabic_name||('خدمة '+id); span.hidden=true; document.body.appendChild(span);
      renderCards(); updateMiniCart(); openCart(); loadServiceDesc({id});
    };
    const rm=card.querySelector('.btn-remove');
    if(rm) rm.onclick=()=>{ if(selectedServiceId===id){ selectedServiceId=null; form.service=''; $id('serviceDesc').style.display='none'; renderCards(); updateMiniCart(); } };
  });
}

/* =========================
   ADDONS
   ========================= */
function renderAddonChips(){
  const wrap=$id('addonChips'); wrap.innerHTML='';
  if(!addonsOptions.length){ wrap.innerHTML='<span class="text-muted">لا إضافات متاحة الآن</span>'; return; }
  addonsOptions.forEach(label=>{
    const b=document.createElement('button'); b.type='button'; b.className='badge-addon'; b.setAttribute('aria-pressed', form.addons.includes(label)?'true':'false');
    b.innerHTML=`<i class="fa-solid fa-circle-plus"></i> ${label}`;
    b.onclick=()=>{ const on=form.addons.includes(label); form.addons = on?form.addons.filter(x=>x!==label):[...form.addons,label]; b.setAttribute('aria-pressed', on?'false':'true'); updateMiniCart(); renderCart(); };
    wrap.appendChild(b);
  });
}
function openAddonModal(){
  const modal=$id('addonModal'), list=$id('addonList'); list.innerHTML='';
  if(!addonsOptions.length){ list.innerHTML='<span class="text-muted">لا إضافات</span>'; }
  addonsOptions.forEach(label=>{
    const btn=document.createElement('button'); btn.type='button'; btn.className='badge-addon';
    btn.setAttribute('aria-pressed', form.addons.includes(label)?'true':'false');
    btn.innerHTML=`<i class="fa-solid fa-circle-plus"></i> ${label}`;
    btn.onclick=()=>{ const on=btn.getAttribute('aria-pressed')==='true'; btn.setAttribute('aria-pressed', on?'false':'true'); };
    list.appendChild(btn);
  });
  modal.setAttribute('aria-hidden','false');
  $id('addonApply').onclick=()=>{
    const chosen=[...list.querySelectorAll('.badge-addon[aria-pressed="true"]')].map(x=>x.textContent.trim());
    form.addons=chosen; modal.setAttribute('aria-hidden','true'); renderCart(); updateMiniCart();
  };
  $id('addonCancel').onclick=()=> modal.setAttribute('aria-hidden','true');
  modal.querySelector('.modal-backdrop').onclick=()=> modal.setAttribute('aria-hidden','true');
}

/* =========================
   CART (drawer + mini)
   ========================= */
function openCart(){ $id('cart').classList.add('show'); $id('cart').setAttribute('aria-hidden','false'); $id('backdrop').classList.add('show'); }
function closeCart(){ $id('cart').classList.remove('show'); $id('cart').setAttribute('aria-hidden','true'); $id('backdrop').classList.remove('show'); }
$id('openCart').onclick=openCart; $id('closeCart').onclick=closeCart; $id('backdrop').onclick=closeCart;
$id('cartContinue').onclick=closeCart;
$id('clearCart').onclick=()=>{
  selectedServiceId=null; form.service=''; form.serviceCount=1; form.addons=[]; renderCards(); renderCart(); updateMiniCart(); closeCart(); toast('success','تم تفريغ السلة');
};
$id('cartConfirm').onclick=()=>{
  if(!form.service){ toast('error','اختر خدمة أولًا'); return; }
  closeCart(); showPage(2); // ensure we're on services step
  // Advance to time step for a smoother flow
  showPage(3); if($id('date').value) fetchTimes();
};

function renderCart(){
  const body=$id('cartBody');
  if(!form.service){ body.innerHTML='<div class="text-muted">السلة فارغة — اختر خدمة من الأعلى.</div>'; return; }
  const svc=services.find(s=>String(s.TS_service_id)===String(form.service));
  const title=svc?.TS_service_arabic_name || 'خدمة مختارة';
  const unit=parsePrice(svc?.TS_price); const hasPrice=Number.isFinite(unit);
  const qty=Number(form.serviceCount||1); const total=hasPrice?unit*qty:NaN;
  body.innerHTML = `
    <div class="cart-row">
      <div>
        <div class="fw-bold">${title}</div>
        <div class="text-muted small">الكمية</div>
      </div>
      <div class="qty" role="group" aria-label="عدد السيارات">
        <button type="button" id="qMinus" aria-label="نقص">−</button>
        <span class="val" id="qVal">${qty}</span>
        <button type="button" id="qPlus" aria-label="زيادة">+</button>
      </div>
    </div>
    <div class="pt-2">
      <div class="d-flex justify-content-between align-items-center mb-1">
        <div class="fw-bold"><i class="fa-solid fa-plus"></i> إضافات</div>
        <button id="editAddons" class="btn btn-sm btn-outline-secondary" type="button">تعديل</button>
      </div>
      <div id="cartAddons">${form.addons.length?form.addons.map(a=>`<span class="badge-addon"><i class="fa-solid fa-circle-check"></i> ${a}</span>`).join(' '):'<span class="text-muted">لا توجد إضافات</span>'}</div>
    </div>
    <div class="cart-breakdown mt-3">
      ${hasPrice?`
        <div class="d-flex justify-content-between"><span>سعر الوحدة</span><span>${currency(unit)}</span></div>
        <div class="d-flex justify-content-between"><span>الكمية</span><span>× ${qty}</span></div>
        <hr class="my-2"/>
        <div class="d-flex justify-content-between fw-bold"><span>الإجمالي</span><span>${currency(total)}</span></div>
        <small class="text-muted d-block mt-1">لا رسوم خفية — قد تُضاف رسوم موقع/وقت حسب التوافر</small>
      `:`<small class="text-muted">سعر الخدمة سيؤكد لاحقًا</small>`}
    </div>`;
  $id('qMinus').onclick=()=>{ form.serviceCount=Math.max(1, qty-1); renderCart(); updateMiniCart(); };
  $id('qPlus').onclick =()=>{ form.serviceCount=Math.min(5, qty+1); renderCart(); updateMiniCart(); };
  $id('editAddons').onclick=openAddonModal;
}
function updateMiniCart(){
  const tEl=$id('fc-title'), totalEl=$id('fc-total'), sub=$id('fc-sub');
  if(!form.service){ tEl.textContent='السلة — لم يتم اختيار خدمة'; totalEl.textContent='—'; sub.textContent='اختر خدمة ثم أكمل الخطوات'; setNextEnabled(PAGES[getIndex()]!=='page1'?true:false); return; }
  const svc=services.find(s=>String(s.TS_service_id)===String(form.service));
  tEl.textContent = svc?.TS_service_arabic_name || 'خدمة مختارة';
  const price=parsePrice(svc?.TS_price); const has=Number.isFinite(price);
  const total = has ? price*Number(form.serviceCount||1) : NaN;
  totalEl.textContent = has ? currency(total) : '—';
  sub.textContent = `× ${form.serviceCount}${form.addons.length?` • إضافات: ${form.addons.join('، ')}`:''}`;
  renderCart();
  updateProgress();
}

/* =========================
   TIME
   ========================= */
function genTimesFor(dateISO){
  // Demo slots each 30m 10:00-18:00
  const base=DateTime.fromISO(dateISO).set({hour:10,minute:0});
  const arr=[]; for(let i=0;i<16;i++){ const t=base.plus({minutes:i*30}); const mins=t.hour*60+t.minute; arr.push({label:t.toFormat('HH:mm'),h:t.hour,m:t.minute,mins}); }
  return arr;
}
function passFilter(mins){
  const toM=(h,m)=>h*60+m;
  if(timeFilter==='all') return true;
  if(timeFilter==='morning')   return mins>=toM(6,0)  && mins<toM(11,0);
  if(timeFilter==='afternoon') return mins>=toM(11,0) && mins<toM(16,0);
  if(timeFilter==='evening')   return mins>=toM(16,0) && mins<toM(21,0);
  if(timeFilter==='night')     return mins>=toM(21,0) && mins<toM(24,0);
  return true;
}
function renderTimes(){
  const grid=$id('timeGrid'); grid.innerHTML='';
  const list = times.filter(t=>passFilter(t.mins));
  if(!list.length){ grid.innerHTML='<div class="text-muted">لا توجد أوقات ضمن الفلتر المحدد</div>'; return; }
  list.forEach((t,idx)=>{
    const b=document.createElement('button'); b.type='button'; b.className='time-option'; b.setAttribute('role','radio'); b.textContent=t.label; b.setAttribute('aria-checked','false'); b.dir='ltr';
    b.onclick=()=>{
      [...grid.children].forEach(x=>x.setAttribute('aria-checked','false'));
      b.setAttribute('aria-checked','true');
      form.time = DateTime.fromObject({hour:t.h,minute:t.m}).toFormat('HH:mm'); selectedTime=form.time; updateProgress(); renderChips();
    };
    grid.appendChild(b);
    if(idx===0 && !selectedTime){ b.click(); }
  });
}
function fetchTimes(){
  if(!form.area || !form.service){ $id('timeGrid').innerHTML='<div class="text-muted">اختر المنطقة والخدمة أولًا</div>'; return; }
  $id('timeLoading').style.display='block';
  setTimeout(()=>{ times=genTimesFor(form.date||DateTime.now().toFormat('yyyy-LL-dd')); $id('timeLoading').style.display='none'; renderTimes(); }, 250);
}

/* =========================
   MAP (Google)
   ========================= */
let SA_BOUNDS={north:25.0500,south:24.3000,west:46.2000,east:47.1000}; let ALLOWED_POLY_PATH=[];
async function loadMapSettings(){
  try{
    const j=await api('mapSettings',{appId:APP_ID});
    if(j?.success){ SA_BOUNDS=j.data.SA_BOUNDS||SA_BOUNDS; ALLOWED_POLY_PATH=Array.isArray(j.data.ALLOWED_POLY_PATH)?j.data.ALLOWED_POLY_PATH:[]; }
  }catch(_){}
}
async function initMap(){
  await loadMapSettings();
  const def={lat:24.7136,lng:46.6753};
  map=new google.maps.Map($id('googleMap'),{
    center:def, zoom:12, disableDoubleClickZoom:true, mapTypeControl:false, fullscreenControl:true,
    restriction:{latLngBounds: SA_BOUNDS, strictBounds:false}
  });
  if(ALLOWED_POLY_PATH?.length>=3){
    allowedPoly = new google.maps.Polygon({map, paths: ALLOWED_POLY_PATH, strokeColor:'#027A93', strokeOpacity:.9, strokeWeight:1.5, fillColor:'#027A93', fillOpacity:.06});
  }
  marker=new google.maps.Marker({position:def,map,draggable:true,title:'حدد موقعك'});
  const setPos=(latLng,pan=false)=>{
    if(!latLng) return;
    if (allowedPoly && !google.maps.geometry.poly.containsLocation(latLng, allowedPoly)) { toast('error','خارج نطاق الخدمة'); return; }
    marker.setPosition(latLng); if(pan) map.panTo(latLng); map.setZoom(17);
    positionUrl=`https://www.google.com/maps/search/?api=1&query=${latLng.lat()},${latLng.lng()}`;
    $id('mapHint').innerHTML=`تم اختيار الموقع: <strong>${latLng.lat().toFixed(5)}, ${latLng.lng().toFixed(5)}</strong>`;
    updateProgress(); renderChips();
  };
  marker.addListener('dragend',({latLng})=>setPos(latLng));
  map.addListener('click',({latLng})=>setPos(latLng,true));

  const input=$id('mapSearch');
  const ac=new google.maps.places.Autocomplete(input,{fields:['geometry','name'], componentRestrictions:{country:'sa'}, strictBounds:true});
  ac.bindTo('bounds', map);
  ac.addListener('place_changed', ()=>{
    const place=ac.getPlace(); if(!place?.geometry) return; const loc=place.geometry.location;
    if (allowedPoly && !google.maps.geometry.poly.containsLocation(loc, allowedPoly)) { toast('error','خارج نطاق الخدمة'); return; }
    map.panTo(loc); map.setZoom(16); setPos(loc,true);
  });

  $id('showMyLocation').onclick=()=>{
    if(!navigator.geolocation){ toast('error','المتصفح لا يدعم تحديد الموقع'); return; }
    navigator.geolocation.getCurrentPosition(
      pos=>{ const here=new google.maps.LatLng(pos.coords.latitude,pos.coords.longitude);
        if (allowedPoly && !google.maps.geometry.poly.containsLocation(here, allowedPoly)) { toast('error','خارج نطاق الخدمة'); return; }
        setPos(here,true);
      },
      _=>toast('error','تعذر تحديد موقعك'), {enableHighAccuracy:true, timeout:10000, maximumAge:30000}
    );
  };
  $id('copyMapLink').onclick=async()=>{
    if(!positionUrl){ toast('error','اختر موقعًا أولاً'); return; }
    await navigator.clipboard.writeText(positionUrl); toast('success','تم نسخ رابط الموقع');
  };
}
window.initMap=initMap;

/* =========================
   INIT & BINDINGS
   ========================= */
$(function(){
  // Select2
  $('#area').select2({width:'100%',placeholder:'اختر المدينة', dir:'rtl'});
  $('#carBrand').select2({width:'100%',placeholder:'ماركة المركبة', dir:'rtl'});

  // Seed area (replace with your own areas feed if any)
  $('#area').empty().select2({data:[{id:'riyadh',text:'الرياض'},{id:'jeddah',text:'جدة'},{id:'dammam',text:'الدمام'}], width:'100%', placeholder:'اختر المدينة', dir:'rtl'})
    .val('riyadh').trigger('change');

  // Phone
  iti=window.intlTelInput($id('mobile'),{
    initialCountry:'sa', onlyCountries:['sa','ae','bh','kw','om','qa'],
    separateDialCode:true, placeholderNumberType:'MOBILE',
    utilsScript:'https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/utils.js'
  });

  // Area change triggers services fetch once
  $('#area').on('change', function(){ form.area=this.value; loadServices(); loadAddons(); updateProgress(); renderChips(); });

  // Date defaults
  const today=DateTime.now().toFormat('yyyy-LL-dd');
  $id('date').value=today; $id('date').min=today; form.date=today;
  $id('date').addEventListener('change', e=>{ form.date=e.target.value; selectedTime=null; fetchTimes(); updateProgress(); });
  $id('timeFilter').addEventListener('change', e=>{ timeFilter=e.target.value; renderTimes(); });

  // Customer inputs
  $id('name').addEventListener('input', e=>{ form.customerN=e.target.value.trim(); updateProgress(); renderChips(); });
  $id('mobile').addEventListener('input', ()=>{ updateProgress(); });

  // Vehicle inputs
  $('#carBrand').on('change', function(){ form.carBrand=this.value; });
  $id('carModel').addEventListener('input', e=>{ form.carModel=e.target.value; });
  $id('plate').addEventListener('input', e=>{ form.plate=e.target.value; });

  // Payment roving selection
  (function roving(group){
    const items=[...group.querySelectorAll('label[role="radio"]')];
    const set=(el)=>{ items.forEach(i=>{i.setAttribute('aria-checked','false'); i.setAttribute('tabindex','-1'); i.querySelector('input').checked=false; });
      el.setAttribute('aria-checked','true'); el.setAttribute('tabindex','0'); el.querySelector('input').checked=true; form.paymentMethod=el.querySelector('input').value; updateProgress(); renderChips(); };
    items.forEach((el,i)=>{ el.addEventListener('click',()=>set(el)); el.addEventListener('keydown',e=>{ if(e.key===' '||e.key==='Enter'){ e.preventDefault(); set(el);} }); if(i===0) el.setAttribute('tabindex','0'); });
    group.addEventListener('keydown', e=>{
      const i=items.indexOf(document.activeElement.closest('label[role="radio"]')); if(i<0) return;
      if(e.key==='ArrowLeft' || e.key==='ArrowUp'){ e.preventDefault(); items[Math.max(0,i-1)].focus(); }
      if(e.key==='ArrowRight'|| e.key==='ArrowDown'){ e.preventDefault(); items[Math.min(items.length-1,i+1)].focus(); }
    });
  })($id('payGroup'));

  // Footer nav
  $id('prevBtn').onclick=()=>{ const i=getIndex(); showPage(Math.max(0,i-1)); };
  $id('nextBtn').onclick=()=>{
    const i=getIndex();
    if(i===0){ showPage(1); return; }
    if(i===1){
      const ok=!!(form.area && form.service); $id('err-area').dataset.show = form.area?'false':'true';
      if(!ok){ toast('error','أكمل اختيار المنطقة والخدمة'); return; }
      showPage(2); fetchTimes(); return;
    }
    if(i===2){
      if(!selectedTime){ $id('err-date').dataset.show='true'; toast('error','اختر وقتًا مناسبًا'); return; }
      $id('err-date').dataset.show='false'; showPage(3); return;
    }
    if(i===3){
      const nameOk=!!form.customerN; const phoneOk= iti?.isValidNumber?.() ?? true;
      $id('err-name').dataset.show = nameOk?'false':'true';
      $id('err-mobile').dataset.show = phoneOk?'false':'true';
      if(!nameOk || !phoneOk){ toast('error','تحقق من الاسم ورقم الجوال'); return; }
      form.customerM = (iti?.getNumber?.()||'').replace(/^\+/,''); showPage(4); return;
    }
    if(i===4){
      if(!form.paymentMethod){ $id('err-pay').dataset.show='true'; toast('error','اختر طريقة الدفع'); return; }
      $id('err-pay').dataset.show='false'; showPage(5); return;
    }
    if(i===5){
      if(!positionUrl){ $id('err-map').dataset.show='true'; toast('error','حدد موقعك على الخريطة'); return; }
      $id('err-map').dataset.show='false';
      // Build Thanks summary
      const svc=services.find(s=>String(s.TS_service_id)===String(form.service));
      const unit=parsePrice(svc?.TS_price); const has=Number.isFinite(unit);
      const qty=Number(form.serviceCount||1); const total=has?unit*qty:NaN;
      $id('thanks').innerHTML = `
        <div class="d-flex justify-content-between py-2 border-bottom"><span>المنطقة</span><strong>${$('#area').find(':selected').text()}</strong></div>
        <div class="d-flex justify-content-between py-2 border-bottom"><span>الخدمة</span><strong>${svc?.TS_service_arabic_name||'—'}</strong></div>
        <div class="d-flex justify-content-between py-2 border-bottom"><span>الكمية</span><strong>× ${qty}</strong></div>
        <div class="d-flex justify-content-between py-2 border-bottom"><span>الوقت</span><strong>${form.date} • ${form.time}</strong></div>
        <div class="d-flex justify-content-between py-2 border-bottom"><span>الدفع</span><strong>${form.paymentMethod.toUpperCase()}</strong></div>
        <div class="d-flex justify-content-between py-2">${has?`<span>الإجمالي</span><strong>${currency(total)}</strong>`:'<span>السعر سيتم تأكيده</span>'}</div>`;
      const wa = encodeURIComponent(`طلب حجز:\nالخدمة: ${svc?.TS_service_arabic_name||''}\nالكمية: ${qty}\nالتاريخ: ${form.date} ${form.time}\nالدفع: ${form.paymentMethod}\nالموقع: ${positionUrl}`);
      $id('waShare').href = `https://wa.me/?text=${wa}`;
      showPage(6); return;
    }
  };

  // Mini-cart open
  $id('miniCart').onclick=openCart;

  // Initial pulls
  loadServices(); loadAddons(); updateProgress(); renderChips();

  // Quantity keyboard shortcut in cart
  document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeCart(); });

  // Rebook
  $id('rebook').onclick=()=>location.reload();

  // When user picks time filter or date initially, set times
  fetchTimes();
});

/* Expose for script tag */
window._nahl_debug_state = ()=>({form,selectedServiceId,services,categories,addonsOptions,positionUrl});
  </script>

  <!-- Google Maps (replace key) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&callback=initMap&v=weekly&loading=async&libraries=places,geometry&language=ar&region=SA" async defer></script>
</body>
</html>
