<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</title>

  <!-- UI libs -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800&display=swap" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/css/intlTelInput.css" rel="stylesheet"/>

  <style>
    :root{
      /* Brand */
      --brand-700:#015a6c; --brand-600:#027A93; --brand-200:#BFE6F0; --brand-050:#F0FAFC;

      /* Ink / Surfaces */
      --ink-900:#0B2630; --ink-800:#173944; --ink-700:#224652;
      --surface-000:#ffffff; --surface-100:#EDF3F6; --border-300:#D4E0E6;

      /* Shape */
      --radius-md:14px; --radius-pill:999px;
      --shadow-xs:0 2px 6px rgba(11,38,48,.08);
      --shadow-sm:0 3px 12px rgba(11,38,48,.12);
      --shadow-md:0 10px 28px rgba(11,38,48,.16);

      /* Motion */
      --ease:cubic-bezier(.22,.61,.36,1);
      --ease-decel:cubic-bezier(0.2,0,0,1);
      --ease-accel:cubic-bezier(0.3,1,0.8,1);
      --dur-xs:160ms; --dur-sm:220ms; --dur-md:460ms; --dur-lg:640ms;

      /* Type + spacing */
      --fs-xxl:1.6rem; --fs-xl:1.375rem; --fs-md:1rem; --fs-sm:.9rem; --fw-bold:800;
      --sp-2:8px; --sp-3:12px; --sp-4:16px; --sp-5:20px; --sp-6:24px; --sp-7:32px;

      /* Layout (ØªÙØ­Ø¯Ù‘ÙØ« Ø¨Ø±Ù…Ø¬ÙŠÙ‹Ø§) */
      --header-h:120px; --footer-h:78px;
    }

    html,body{height:100%}
    body{
      margin:0; font-family:'Cairo',sans-serif; color:#fff;
      background:
        linear-gradient(180deg, rgba(11,38,48,.65), rgba(11,38,48,.35)),
        url("https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/lorenzo-hamers-n1SRvkP6bEk-unsplash%20(1).jpg") center/cover fixed;
      min-height:100vh; display:flex; flex-direction:column;
      padding-top:var(--header-h); padding-bottom:var(--footer-h);
      color-scheme: light;
    }

    /* ---------- Header ---------- */
    header{
      position:sticky; top:0; z-index:50;
      background:rgba(11,38,48,.42); backdrop-filter:blur(10px);
      border-bottom:1px solid rgba(255,255,255,.18);
      display:flex; align-items:stretch; justify-content:center;
    }
    .header-inner{
      max-width:1120px; width:100%;
      padding:10px var(--sp-3) 12px;
      display:flex; flex-direction:column; gap:10px;
    }
    .header-top{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .brand{display:flex; align-items:center; gap:10px}
    .brand img{height:54px; width:auto; object-fit:contain; filter:drop-shadow(0 6px 20px rgba(0,0,0,.25))}
    .mini-progress{display:flex; align-items:center; gap:var(--sp-3); flex:1}
    .mini-progress .bar{flex:1; height:8px; background:rgba(255,255,255,.25); border-radius:999px; overflow:hidden}
    .mini-progress .bar>span{display:block; height:100%; width:0%; background:linear-gradient(90deg, var(--brand-600), var(--brand-200)); transition:width var(--dur-md) var(--ease-decel)}
    .mini-progress .step{font-weight:var(--fw-bold); font-size:var(--fs-md)}

    /* ---------- Header Summary (Ø´ÙØ§Ù) ---------- */
    .header-summary{ display:flex; justify-content:center }
    .summary-bar{
      display:flex; gap:8px; align-items:center; width:100%; max-width:1120px;
      background:transparent; border:0; box-shadow:none;
      flex-wrap:wrap;
    }
    .summary-bar .chip{
      display:inline-flex; align-items:center; gap:6px;
      background:#fff; border:1px solid var(--border-300); border-radius:999px;
      padding:6px 10px; font-size:.88rem; color:#0B2630; white-space:nowrap;
      box-shadow:var(--shadow-xs);
    }
    .summary-bar i{opacity:.85}
    @media (max-width:560px){
      .summary-bar{ gap:6px; }
      .summary-bar .chip{ flex:1 1 calc(50% - 6px); min-width:0; padding:6px 8px; font-size:.82rem; justify-content:center; }
      .summary-bar .chip b{ display:inline-block; max-width:12ch; overflow:hidden; text-overflow:ellipsis; }
    }
    @media (min-width:561px){
      .summary-bar{ flex-wrap:nowrap; overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:none; }
      .summary-bar::-webkit-scrollbar{ display:none }
    }

    /* ---------- Main ---------- */
    main{flex:1 0 auto; display:flex; justify-content:center; padding:var(--sp-2) var(--sp-3) 0}
    #app{width:100%; max-width:1120px}

    /* Pages */
    .stage{position:relative; min-height:540px; padding:8px 0 20px}
    .page{
      position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; gap:var(--sp-5);
      padding:var(--sp-5) var(--sp-3) var(--sp-6); overflow:auto; opacity:0; transform:translateY(12px) scale(.992);
      pointer-events:none;
    }
    @media (prefers-reduced-motion: no-preference){
      .page.active{ pointer-events:auto; animation:pageIn var(--dur-md) var(--ease-decel) both; }
      .page.exit  { animation:pageOut var(--dur-sm) var(--ease-accel) both; }
    }
    @keyframes pageIn{ from{opacity:0; transform:translateY(12px) scale(.992)} to{opacity:1; transform:translateY(0) scale(1)} }
    @keyframes pageOut{ from{opacity:1; transform:translateY(0) scale(1)} to{opacity:0; transform:translateY(14px) scale(.985)} }
    .page h1{font-size:var(--fs-xl); font-weight:var(--fw-bold); margin:0; text-align:center; color:var(--ink-900)}

    /* Cards + fields */
    .card{background:var(--surface-000); color:var(--ink-900); border-radius:var(--radius-md); box-shadow:var(--shadow-md); padding:var(--sp-6); width:100%; max-width:920px}
    .form-control, select, .select2-selection{
      background:var(--surface-000); color:var(--ink-900);
      border:1px solid var(--border-300) !important; border-radius:var(--radius-md)!important;
      min-height:48px; text-align:center; font-size:var(--fs-md);
      transition:border-color var(--dur-xs) var(--ease), box-shadow var(--dur-xs) var(--ease);
    }
    .form-control::placeholder{color:#6b7280}
    .form-control:focus{ border-color:#0891b2 !important; box-shadow:0 0 0 4px rgba(8,145,178,.2) }

    /* Select2 contrast fixes */
    .select2-container--default .select2-selection--single{
      background:#ffffff !important; border:1px solid var(--border-300) !important; border-radius:var(--radius-md)!important;
    }
    .select2-container--default .select2-selection--single .select2-selection__rendered{
      color:#0B2630 !important; line-height:48px !important; padding-inline:42px 42px !important;
    }
    .select2-container--default .select2-selection--single .select2-selection__placeholder{ color:#667085 !important; }
    .select2-container--default.select2-container--focus .select2-selection--single{
      border-color:#0891b2 !important; box-shadow:0 0 0 4px rgba(8,145,178,.2) !important;
    }
    .select2-container--default .select2-selection--single .select2-selection__arrow{ height:48px !important; }
    .select2-container--default .select2-selection--single .select2-selection__arrow b{
      border-color:#0B2630 transparent transparent transparent !important;
    }
    .select2-dropdown{
      background:#fff !important; color:#0B2630 !important;
      border:1px solid var(--border-300) !important; box-shadow:var(--shadow-sm);
    }
    .select2-container--default .select2-results__option{ color:#0B2630 !important; background:#fff !important; padding:10px 12px; }
    .select2-results__options{max-height:280px}
    .select2-container--default .select2-results__option--highlighted[aria-selected],
    .select2-container--default .select2-results__option--highlighted{ background:#E6F4F7 !important; color:#0B2630 !important; }
    .select2-container--default .select2-results__option[aria-selected="true"]{ background:#D8EEF3 !important; color:#0B2630 !important; }
    .select2-container--default .select2-results__option[aria-disabled="true"]{ color:#9aa7ad !important; }
    .select2-container--default .select2-selection--single[aria-disabled="true"],
    .select2-container--disabled .select2-selection--single{ background:#f5f7f9 !important; color:#6b7280 !important; opacity:.9; }

    /* Time grid */
    .time-grid{display:grid; grid-template-columns:repeat(2,1fr); gap:var(--sp-4)}
    @media (min-width:540px){ .time-grid{grid-template-columns:repeat(3,1fr)} }
    .time-option{
      background:#fff; color:#0B2630; font-weight:var(--fw-bold);
      border:1px solid var(--border-300); border-radius:var(--radius-md);
      padding:14px 10px; min-height:56px; box-shadow:var(--shadow-xs);
      transition:transform var(--dur-xs) var(--ease), box-shadow var(--dur-xs) var(--ease), background var(--dur-xs) var(--ease);
      display:flex; flex-direction:column; align-items:center; justify-content:center;
    }
    .time-option:hover{transform:translateY(-2px); background:var(--brand-050); box-shadow:var(--shadow-sm)}
    .time-option:active{transform:translateY(0) scale(.995)}
    .time-option[aria-checked="true"]{outline:3px solid var(--brand-600); outline-offset:2px}

    /* Overlays */
    .load-overlay{ position:absolute; inset:0; background:rgba(255,255,255,.9); color:#0B2630; display:none; align-items:center; justify-content:center; gap:12px; border-radius:var(--radius-md); }
    .load-overlay.show{display:flex; animation:fadeIn var(--dur-sm) var(--ease) both}
    @keyframes fadeIn{ from{opacity:0} to{opacity:1} }

    /* Payment */
    .pay-grid{display:grid; grid-template-columns:1fr 1fr; gap:var(--sp-4); width:100%; max-width:920px}
    .pay-card{
      background:#fff; color:#0B2630; border:1px solid var(--border-300); border-radius:var(--radius-md);
      padding:var(--sp-6); display:flex; justify-content:center; align-items:center; gap:var(--sp-4);
      min-height:64px; cursor:pointer; transition:transform var(--dur-xs) var(--ease), box-shadow var(--dur-xs) var(--ease), background var(--dur-xs) var(--ease);
    }
    .pay-card:hover{transform:translateY(-2px); box-shadow:var(--shadow-sm); background:var(--brand-050)}
    .pay-card:active{transform:translateY(0) scale(.995)}
    .pay-card img{max-width:120px; height:auto}
    .pay-card[aria-checked="true"]{outline:3px solid var(--brand-600); outline-offset:2px}

    /* Footer nav */
    footer.sticky-nav{ position:sticky; bottom:0; z-index:40; height:var(--footer-h); background:rgba(11,38,48,.55); backdrop-filter:blur(10px); border-top:1px solid rgba(255,255,255,.22); display:flex; align-items:center; justify-content:center; }
    .footer-inner{ max-width:1120px; width:100%; padding:8px 12px; display:flex; align-items:center; justify-content:space-between; }
    .footer-brand{ font-size:.95rem; color:#fff; opacity:.95 }
    .footer-actions{display:flex; gap:12px}
    .btn-footer{ flex:1; border:1px solid rgba(255,255,255,.28); border-radius:var(--radius-md); padding:12px 16px; min-height:48px; font-size:var(--fs-md); font-weight:var(--fw-bold); background:#ffffff; color:#015a6c; transition:transform var(--dur-xs) var(--ease), box-shadow var(--dur-xs) var(--ease), background var(--dur-xs) var(--ease), color var(--dur-xs) var(--ease), border-color var(--dur-xs) var(--ease); }
    .btn-footer:hover{transform:translateY(-2px); box-shadow:var(--shadow-sm)}
    .btn-footer:active{transform:translateY(0) scale(.995)}
    .btn-footer.primary{background:#015a6c; color:#fff; border-color:#015a6c}
    .btn-footer.hidden{visibility:hidden}
    .btn-footer.disabled, .btn-footer:disabled{opacity:.6; pointer-events:none}

    /* PPT Deck (Ø®Ù„ÙÙŠØ© Ø£ÙØªØ­) */
    .ppt-deck{
      position:relative; width:100%; max-width:860px; min-height:220px; margin:8px auto 0;
      overflow:hidden; border-radius:14px;
      background:linear-gradient(180deg, rgba(255,255,255,.92), rgba(244,250,252,.92));
      border:1px solid rgba(255,255,255,.55);
      box-shadow:var(--shadow-md);
    }
    .ppt-slide{ position:absolute; inset:0; padding:28px 18px; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; opacity:0; transform:translateY(10px) scale(.995); }
    .ppt-slide h2{ font-size:var(--fs-xxl); font-weight:800; color:var(--ink-900); margin:0 0 8px; letter-spacing:.2px }
    .ppt-slide p{ font-size:1.05rem; color:#33545f; margin:0; opacity:.92 }
    @media (prefers-reduced-motion: no-preference) {
      .ppt-slide.is-active{ animation: pptIn var(--dur-md) var(--ease-decel) both; }
      .ppt-slide.is-exiting{ animation: pptOut var(--dur-sm) var(--ease-accel) both; }
    }
    @keyframes pptIn{ from{opacity:0; transform:translateY(14px) scale(.985)} to{opacity:1; transform:none} }
    @keyframes pptOut{ from{opacity:1; transform:none} to{opacity:0; transform:translateY(-12px) scale(.992)} }

    /* Thank-you + CTA */
    .success-hero{display:flex;flex-direction:column;align-items:center;gap:14px;margin-bottom:10px}
    .success-icon{width:92px;height:92px;border-radius:50%;background:linear-gradient(135deg,var(--brand-600),#12b3cf);box-shadow:0 10px 24px rgba(2,122,147,.25), inset 0 0 0 6px rgba(255,255,255,.35);position:relative}
    .success-icon::after{content:"\f00c";font-family:"Font Awesome 6 Free";font-weight:900;color:#fff;position:absolute;inset:0;display:grid;place-items:center;font-size:40px;transform:scale(.7);opacity:0;animation:popIn .5s var(--ease-decel) .1s forwards}
    @keyframes popIn{to{transform:scale(1);opacity:1}}
    .thanks-title{font-size:1.35rem;font-weight:800;color:#0b2630;margin:0}
    .thanks-copy{color:#33545f;margin:0;opacity:.95}
    .rebook-btn{display:inline-flex;align-items:center;gap:10px;justify-content:center;background:linear-gradient(135deg,var(--brand-600),var(--brand-700));color:#fff;border:0;border-radius:999px;padding:14px 24px;min-height:52px;font-weight:800;font-size:1.05rem;letter-spacing:.2px;box-shadow:0 10px 24px rgba(2,122,147,.28);transition:transform var(--dur-xs) var(--ease), box-shadow var(--dur-xs) var(--ease), filter var(--dur-xs) var(--ease)}
    .rebook-btn:hover{transform:translateY(-2px);box-shadow:var(--shadow-md);filter:saturate(1.05)}
    .rebook-btn:active{transform:translateY(0) scale(.99)}
  </style>
</head>
<body>
  <!-- Toasts -->
  <div id="toastWrap" class="toast-wrap" aria-live="polite" aria-atomic="true"></div>

  <!-- Header -->
  <header>
    <div class="header-inner">
      <div class="header-top">
        <div class="mini-progress" aria-hidden="true">
          <div class="bar"><span id="miniBarFill" style="width:0%"></span></div>
          <div class="step" id="miniStepTitle">Ø§Ù„ØªØ±Ø­ÙŠØ¨</div>
        </div>
        <div class="brand">
          <img id="brandLogo" alt="Sponge &amp; Soap" src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20%20Soap/spong&Soap%20-%20logo.png" loading="eager" decoding="async" fetchpriority="high" onerror="handleLogoError(this)"/>
          <strong id="brandText" style="display:none;color:#fff;font-weight:800">Sponge &amp; Soap</strong>
        </div>
      </div>

      <!-- Summary chips -->
      <div class="header-summary">
        <div id="bookingSummary" class="summary-bar" aria-live="polite" role="list">
          <span class="chip" data-sum-chip="area"    role="listitem"><i class="fa-solid fa-location-dot"></i> <b id="sumArea">â€”</b></span>
          <span class="chip" data-sum-chip="service" role="listitem"><i class="fa-solid fa-screwdriver-wrench"></i> <b id="sumService">â€”</b></span>
          <span class="chip" data-sum-chip="date"    role="listitem"><i class="fa-regular fa-calendar"></i>   <b id="sumDate">â€”</b></span>
          <span class="chip" data-sum-chip="time"    role="listitem"><i class="fa-regular fa-clock"></i>      <b id="sumTime">â€”</b></span>
          <span class="chip" data-sum-chip="pay"     role="listitem"><i class="fa-regular fa-credit-card"></i> <b id="sumPay">â€”</b></span>
        </div>
      </div>
    </div>
  </header>

  <!-- Body -->
  <main>
    <div id="app">
      <div class="stage">
        <!-- 1) Welcome -->
        <section id="page1" class="page active" aria-label="Ø§Ù„ØªØ±Ø­ÙŠØ¨">
          <h1 class="visually-hidden">Ø¹Ø±Ø¶ ØªØ±Ø­ÙŠØ¨ÙŠ</h1>
          <div class="card text-center" style="background:transparent; box-shadow:none; padding:0;">
            <div id="pptDeck" class="ppt-deck" aria-live="polite">
              <div class="ppt-slide kb"><div class="ppt-hero"><h2>âœ¨ ØºØ³ÙŠÙ„ Ø¨Ø¯ÙˆÙ† Ø·ÙˆØ§Ø¨ÙŠØ±</h2><p>Ù†Ø¬ÙŠÙƒ Ù„ÙŠÙ† Ø¨Ø§Ø¨ Ø¨ÙŠØªÙƒ â€” Ø¬ÙˆØ¯Ø© ÙˆÙØ®Ø§Ù…Ø© Ø¨Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØµØºÙŠØ±Ø©</p></div></div>
              <div class="ppt-slide kb"><div class="ppt-hero"><h2>ğŸ§¼ Ø¹Ù†Ø§ÙŠØ© Ù…Ø¯Ø±ÙˆØ³Ø©</h2><p>ÙˆØ§ÙƒØ³ ÙŠØ­Ù…ÙŠ Ø§Ù„Ø³ÙŠØ§Ø±Ø© â€¢ ÙÙˆØ· Ù†Ø¸ÙŠÙØ© â€¢ Ø¥Ø³ÙÙ†Ø¬Ø© Ù„Ù„ÙƒÙØ±Ø§Øª</p></div></div>
              <div class="ppt-slide kb"><div class="ppt-hero"><h2>â±ï¸ Ø­Ø¬Ø² Ø³Ø±ÙŠØ¹</h2><p>Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø© ÙˆØ§Ù„Ø®Ø¯Ù…Ø© ÙˆØ§Ù„ÙˆÙ‚Øª â€” ÙˆØ§Ù„Ø¨Ø§Ù‚ÙŠ Ø¹Ù„ÙŠÙ†Ø§</p></div></div>
            </div>
          </div>
        </section>

        <!-- 2) Service & Location -->
        <section id="page2" class="page" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†Ø·Ù‚Ø© ÙˆØ§Ù„Ø®Ø¯Ù…Ø©">
          <h1>ÙˆÙŠÙ† ØªØ­Ø¨ Ù†Ø¬ÙŠÙƒØŸ</h1>

          <div class="card position-relative" id="servicesCard">
            <label class="form-label">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
            <select id="area" style="width:100%"></select>

            <div class="row g-3 mt-3">
              <div class="col-12 col-md-6">
                <label class="form-label">Ø§Ù„ØªØµÙ†ÙŠÙ</label>
                <select id="serviceCat" style="width:100%"></select>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label">Ø§Ù„Ø®Ø¯Ù…Ø©</label>
                <select id="service" style="width:100%"></select>
              </div>
              <div class="col-12">
                <label class="form-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</label>
                <select id="serviceCount" class="form-select">
                  <option value="1" selected>1</option><option value="2">2</option>
                  <option value="3">3</option><option value="4">4</option><option value="5">5</option>
                </select>
              </div>
            </div>

            <div id="servicesLoading" class="load-overlay">
              <div class="spinner-border text-info" role="status" aria-hidden="true"></div>
              <strong>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øªâ€¦</strong>
            </div>
          </div>
        </section>

        <!-- 3) Time -->
        <section id="page4" class="page" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ¹Ø¯">
          <h1>Ù…ØªÙ‰ ØªØ­Ø¨ Ù†Ø¬ÙŠÙƒØŸ</h1>
          <div class="card position-relative" id="timeCard">
            <div class="row g-3">
              <div class="col-12 col-md-5">
                <label class="form-label" for="date">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                <input id="date" type="date" class="form-control"/>
              </div>
            </div>

            <div class="position-relative mt-3">
              <div id="time-container" class="time-grid" role="radiogroup" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆÙ‚Øª"></div>
              <div id="timeLoading" class="load-overlay">
                <div class="spinner-border text-info" role="status" aria-hidden="true"></div>
                <strong>Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯â€¦</strong>
              </div>
            </div>
          </div>
        </section>

        <!-- 4) Contact -->
        <section id="page5" class="page" aria-label="Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„">
          <h1>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„</h1>
          <div class="card">
            <div class="row g-3">
              <div class="col-12 col-md-6 form-block">
                <label for="name" class="form-label">Ø§Ù„Ø¥Ø³Ù…</label>
                <input id="name" type="text" class="form-control" placeholder="Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ±ÙŠÙ…" autocomplete="name"/>
              </div>
              <div class="col-12 col-md-6 form-block">
                <label for="mobile" class="form-label">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
                <input id="mobile" type="tel" class="form-control" placeholder="+9665â€¦" autocomplete="tel"/>
              </div>
            </div>
          </div>

          <h1>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</h1>
          <div class="card">
            <div class="row g-3">
              <div class="col-12 col-md-4">
                <label class="form-label" for="carBrand">Ù…Ø§Ø±ÙƒØ© Ø§Ù„Ø³ÙŠØ§Ø±Ø© ğŸš˜</label>
                <select id="carBrand" style="width:100%"></select>
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label" for="carName">Ø§Ø³Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label>
                <input id="carName" type="text" class="form-control" placeholder="ÙƒØ§Ù…Ø±ÙŠØŒ Ø¥Ù„Ù†ØªØ±Ø§â€¦" autocomplete="off"/>
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label" for="plateNumber">Ø¢Ø®Ø± 4 Ø£Ø±Ù‚Ø§Ù… Ù…Ù† Ø§Ù„Ù„ÙˆØ­Ø© <span aria-hidden="true" style="color:#dc2626">*</span></label>
                <input id="plateNumber" type="text" inputmode="numeric" maxlength="4" class="form-control" placeholder="1234" required aria-required="true" autocomplete="off"/>
                <small class="text-muted d-block mt-1" style="opacity:.9">Ù†Ø­ØªØ§Ø¬ Ø¢Ø®Ø± Ù¤ Ø£Ø±Ù‚Ø§Ù… Ù„Ù„ØªØ£ÙƒÙŠØ¯ ÙÙ‚Ø·</small>
              </div>
              <input id="locationDescription" type="text" hidden/>
            </div>
          </div>

          <h1>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</h1>
          <div class="pay-grid" role="radiogroup" aria-label="Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹" id="payGroup">
            <label class="pay-card" tabindex="0" role="radio" aria-checked="false">
              <input type="radio" name="payingMethod" value="STC Pay" class="visually-hidden"/>
              <img src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/STC%20PAY%20LOGO.png" alt="STC Pay">
            </label>
            <label class="pay-card" tabindex="-1" role="radio" aria-checked="false">
              <input type="radio" name="payingMethod" value="Cash" class="visually-hidden"/>
              <strong>Cash</strong>
            </label>
            <label class="pay-card" style="grid-column:1/-1" tabindex="-1" role="radio" aria-checked="false">
              <input type="radio" name="payingMethod" value="MADA" class="visually-hidden"/>
              <img src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/MADA%20LOGO.png" alt="Mada">
            </label>
          </div>
        </section>

        <!-- 5) Map -->
        <section id="page6" class="page" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹">
          <h1>Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø®Ø±ÙŠØ·Ø© Ù‚ÙˆÙ‚Ù„</h1>
          <div class="card">
            <div id="googleMap" style="width:100%;height:420px;border-radius:14px;overflow:hidden"></div>
          </div>
          <div class="card text-center">
            <button id="show-my-location" class="btn btn-outline-primary" type="button">Ø¥Ø¸Ù‡Ø§Ø± Ù…ÙˆÙ‚Ø¹ÙŠ</button>
          </div>
          <small id="mapHint" class="text-muted d-block mt-2" style="text-align:center">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø£Ùˆ Ø§Ø³Ø­Ø¨ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ</small>
        </section>

        <!-- 6) Done -->
        <section id="page7" class="page" aria-label="ØªÙ… Ø§Ù„Ø­Ø¬Ø²">
          <div class="card text-center">
            <div class="success-hero">
              <div class="success-icon" aria-hidden="true"></div>
              <div>
                <h2 id="thanksTitle" class="thanks-title">ØªÙ… Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯Ùƒ Ø¨Ù†Ø¬Ø§Ø­ ğŸ‰</h2>
                <p id="thanksCopy" class="thanks-copy">Ø±Ø§Ø­ Ù†Ø±Ø³Ù„ Ù„Ùƒ Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ø®Ù„Ø§Ù„ Ø¯Ù‚Ø§Ø¦Ù‚.</p>
              </div>
            </div>
            <div id="thanksSummary" class="chips-wrap centered" aria-live="polite"></div>
            <div style="margin-top:18px">
              <button id="rebook" class="rebook-btn" type="button">
                <i class="fa-solid fa-rotate-right"></i> Ø§Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯Ù‹Ø§ Ø¢Ø®Ø±
              </button>
            </div>
          </div>
        </section>
      </div>
    </div>
  </main>

  <!-- Footer nav -->
  <footer class="sticky-nav" aria-label="Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø®Ø·ÙˆØ§Øª">
    <div class="footer-inner">
      <div class="footer-brand"><span>Ù†Ø­Ù„ â€¢ <a href="https://nahl.app" target="_blank" rel="noopener" style="color:#fff;text-decoration:none">Nahl.app</a></span></div>
      <div class="footer-actions">
        <button id="footer-prev" type="button" class="btn-footer hidden">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
        <button id="footer-next" type="button" class="btn-footer primary disabled" disabled>Ø§Ù„ØªØ§Ù„ÙŠ</button>
        <button id="page1-button" class="btn-footer primary">ØªØ®Ø·ÙŠ Ø§Ù„Ø¹Ø±Ø¶</button>
      </div>
    </div>
  </footer>

  <!-- JS libs -->
  <script src="https://code.jquery.com/jquery-3.6.3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/intlTelInputWithUtils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /* ---------------- Logo fallback ---------------- */
    function handleLogoError(img){
      const fallbacks = [
        "https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20%20Soap/spong&Soap%20-%20logo.png",
        "https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20%26%20Soap/spong%26Soap%20-%20logo.png",
        "https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20%26%20Soap/logo.png",
        "https://dummyimage.com/180x54/027A93/ffffff.png&text=Sponge+%26+Soap"
      ];
      const i = Number(img.dataset.fidx||0);
      if (i < fallbacks.length){ img.dataset.fidx = String(i+1); img.src = fallbacks[i]; }
      else { img.style.display = 'none'; const txt = document.getElementById('brandText'); if (txt) txt.style.display = 'block'; }
    }

    /* ---------------- API (Ù„Ø§ ØªØºÙŠÙŠØ± Ø®Ø§Ø¯Ù…ÙŠ) ---------------- */
    const defaultLink2 = `https://nahl-platform.vercel.app/api/app/AM/general/${'33e0d05d-d771-46f4-a7e7-7c634b4e3a9e'}/form`;
    const RESERVE_URL_PRIMARY   = `${defaultLink2}/reserveAppointment`;
    const RESERVE_URL_FALLBACK  = `${defaultLink2.replace(/\/form\/?$/,'')}/reserveAppointment`;

    let controllers=[];

    async function callContent2(path, cb, abortable=false, retries=3){
      let signal='';
      if(abortable){
        controllers.forEach(([c])=>c.abort()); controllers=[];
        const controller=new AbortController(); signal=controller.signal; controllers.push([controller,signal]);
      }
      try{
        await new Promise(r=>setTimeout(r, 200)); // UX debounce
        const res=await fetch(defaultLink2+path,{method:'GET',redirect:'follow',...(abortable&&{signal}), cache:'no-store'});
        if(!res.ok){
          if(retries>0) return callContent2(path,cb,abortable,retries-1);
          throw new Error('Network');
        }
        const json=await res.json(); cb(json);
      }catch(e){
        console.error('[GET] failed:', e);
        // Ù„Ùˆ ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹/Ø§Ù„Ø®Ø¯Ù…Ø§ØªØŒ Ø§Ø®ÙÙ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        if(String(path||'').includes('/locations') || String(path||'').includes('/services')){
          setLoadingServices(false);
        }
        if(!String(e).includes('AbortError') && retries>0)
          setTimeout(()=>callContent2(path,cb,abortable,retries-1),600);
      }
    }

    async function postReservationTry(url, payload, contentType='text/plain;charset=UTF-8'){
      try{
        const res = await fetch(url, {
          method:'POST', mode:'cors', cache:'no-store', credentials:'omit', referrerPolicy:'no-referrer',
          headers:{ 'Content-Type': contentType, 'Accept':'application/json' },
          body: JSON.stringify(payload)
        });
        const raw = await res.text();
        let data=null; try{ data = JSON.parse(raw); }catch(_){}
        return { ok: res.ok, status: res.status, data, raw };
      }catch(err){ return { ok:false, status:0, error:String(err) }; }
    }

    async function postReservation(payload){
      let r = await postReservationTry(RESERVE_URL_PRIMARY, payload, 'text/plain;charset=UTF-8');
      if(!r.ok && (r.status===415 || r.status===406 || r.status===0)){
        r = await postReservationTry(RESERVE_URL_PRIMARY, payload, 'application/json;charset=UTF-8');
      }
      if(!r.ok && r.status===404){
        r = await postReservationTry(RESERVE_URL_FALLBACK, payload, 'text/plain;charset=UTF-8');
      }
      return r;
    }

    /* ---------------- Toast ---------------- */
    function showToast(type='info', msg=''){
      const wrap=document.getElementById('toastWrap');
      const div=document.createElement('div');
      div.className='toast-msg '+(type==='error'?'toast-error':type==='success'?'toast-success':'toast-info');
      div.textContent=msg; wrap.appendChild(div);
      setTimeout(()=>{ div.style.opacity='0'; div.style.transform='translateY(-6px)'; setTimeout(()=>div.remove(), 180); }, 2400);
    }

    /* ---------------- STATE ---------------- */
    const DateTime=luxon.DateTime;
    const orderedPages=["page1","page2","page4","page5","page6","page7"];
    const STEPS_LABELS=["Ø§Ù„ØªØ±Ø­ÙŠØ¨","Ø§Ù„Ø®Ø¯Ù…Ø©","Ø§Ù„ÙˆÙ‚Øª","Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª","Ø§Ù„Ù…ÙˆÙ‚Ø¹","ØªÙ…"];
    let selectedTime=null, positionUrl="";
    let servicesCache=null, categoriesCache=null, itiPhone=null;

    const nForm={date:'',time:'',location:'',service:'',serviceCount:'1',serviceCat:'',customerM:'',customerN:'',paymentMethod:'',urlLocation:'',locationDescription:''};

    /* ---------------- Helpers ---------------- */
    function syncHeaderHeight(){
      const h = document.querySelector('header')?.offsetHeight || 120;
      document.documentElement.style.setProperty('--header-h', h+'px');
    }

    function hideOverlays(){
      document.getElementById('servicesLoading')?.classList.remove('show');
      document.getElementById('timeLoading')?.classList.remove('show');
    }

    function showPage(idx){
      const cur=document.querySelector('.page.active');
      const next=document.getElementById(orderedPages[idx]); if(!next||cur===next) return;
      if(cur && cur.id==='page1'){ stopWelcomeDeck(); }
      if(cur){ cur.classList.remove('active'); cur.classList.add('exit'); }
      next.style.display='flex';
      requestAnimationFrame(()=>{ next.classList.add('active'); setTimeout(()=>{ if(cur){cur.classList.remove('exit'); cur.style.display='none';} }, 260); });
      hideOverlays();          // ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø®ÙØ§Ø¡ Ø£ÙŠ Ø·Ø¨Ù‚Ø§Øª ØªØ­Ù…ÙŠÙ„
      syncProgress(idx);
      updateNextAvailability();
    }
    function getActiveIndex(){ const id=document.querySelector('.page.active')?.id; return Math.max(0, orderedPages.indexOf(id)); }
    function syncProgress(i){
      const pct=((i+1)/orderedPages.length)*100;
      document.getElementById('miniBarFill').style.width=pct+'%';
      document.getElementById('miniStepTitle').textContent=STEPS_LABELS[Math.min(i,STEPS_LABELS.length-1)];
      const prev=document.getElementById('footer-prev');
      const next=document.getElementById('footer-next');
      const start=document.getElementById('page1-button');
      const onWelcome = i===0;
      prev.classList.toggle('hidden', i === 0);
      next.classList.toggle('hidden', onWelcome);
      start.classList.toggle('hidden', !onWelcome);
      if(onWelcome){ start.textContent='ØªØ®Ø·ÙŠ Ø§Ù„Ø¹Ø±Ø¶'; }
      syncHeaderHeight();
    }

    function enforceDateMinToday(){
      const today = DateTime.now().toFormat('yyyy-LL-dd');
      const dateEl = document.getElementById('date');
      if(!dateEl) return;
      dateEl.setAttribute('min', today);
      if(!dateEl.value || dateEl.value < today) dateEl.value = today;
    }

    function setLoadingTimes(on){ document.getElementById('timeLoading').classList.toggle('show', !!on); }
    function setLoadingServices(on){ document.getElementById('servicesLoading').classList.toggle('show', !!on); }

    function validateMobile(){
      if(!itiPhone || !itiPhone.isValidNumber()){ showToast('error','Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ ØµØ­ÙŠØ­'); return false; }
      return true;
    }
    function validatePlate(){
      const el = document.getElementById('plateNumber');
      const ok = el.value && el.value.length === 4;
      if(!ok){ showToast('error','Ø±Ø¬Ø§Ø¡Ù‹ Ø£Ø¯Ø®Ù„ Ø¢Ø®Ø± Ù¤ Ø£Ø±Ù‚Ø§Ù… Ù…Ù† Ø§Ù„Ù„ÙˆØ­Ø©'); el.focus(); }
      return ok;
    }

    /* ---------------- Deck ---------------- */
    let deckTimers = []; let deckIndex = 0; let deckRunning = false;
    const SLIDE_MS = 2600; const GAP_MS = 180;
    function startWelcomeDeck(){
      const deck = document.getElementById('pptDeck'); if(!deck) return;
      const slides = Array.from(deck.querySelectorAll('.ppt-slide'));
      deckRunning = true; deckIndex = 0;
      slides[0]?.classList.add('is-active');
      const advance = ()=>{
        if(!deckRunning) return;
        const prev = deckIndex; deckIndex++;
        if(deckIndex>=slides.length){ stopWelcomeDeck(); showPage(1); return; }
        slides.forEach((s,i)=>{ s.classList.remove('is-active','is-exiting'); if(i===prev) s.classList.add('is-exiting'); if(i===deckIndex) s.classList.add('is-active'); });
        deckTimers.push(setTimeout(advance, SLIDE_MS + GAP_MS));
      };
      deckTimers.push(setTimeout(advance, SLIDE_MS + GAP_MS));
    }
    function stopWelcomeDeck(){ deckRunning = false; deckTimers.forEach(t=>clearTimeout(t)); deckTimers = []; }

    /* ---------------- TIMES ---------------- */
    let dayTimes = [];       // [{label, actual12}]
    let timesLoaded = false;

    document.getElementById('date').addEventListener('change', fetchTimesForSelectedDate);
    document.getElementById('service').addEventListener('change', () => { if (getActiveIndex() === 2) fetchTimesForSelectedDate(); });
    document.getElementById('area').addEventListener('change', () => { if (getActiveIndex() === 2) fetchTimesForSelectedDate(); });

    (function initDateMin(){
      const today = DateTime.now().toFormat('yyyy-LL-dd');
      const dateEl = document.getElementById('date');
      if (!dateEl.value) dateEl.value = today;
      dateEl.setAttribute('min', today);
    })();

    function parseTimeToLuxon(rawTime){
      let t = DateTime.fromISO(String(rawTime||'').trim(), { setZone:true });
      if (!t.isValid) t = DateTime.fromFormat(String(rawTime||''), 'HH:mm:ss', { setZone:true });
      if (!t.isValid) t = DateTime.fromFormat(String(rawTime||''), 'H:mm a',   { setZone:true });
      if (!t.isValid) t = DateTime.fromFormat(String(rawTime||''), 'H:mm',     { setZone:true });
      return t.isValid ? t : null;
    }
    function normalizeAvailability(r){
      const status = String(r.TS_status || r.status || r.TS_appointment_status || '').toLowerCase();
      const availableFlag = (typeof r.isAvailable === 'boolean') ? r.isAvailable : undefined;
      const booked   = Number(r.booked ?? r.TS_booked);
      const capacity = Number(r.capacity ?? r.TS_capacity);
      let remaining  = Number(r.remaining ?? r.TS_remaining);
      if (!Number.isFinite(remaining) && Number.isFinite(capacity) && Number.isFinite(booked)){
        remaining = capacity - booked;
      }
      const looksOpen =
        availableFlag === true ||
        ['available','open','free','empty','vacant','canceled'].includes(status) ||
        (Number.isFinite(remaining) ? remaining > 0 : (availableFlag !== false && !status));
      return { looksOpen, remaining, status, availableFlag };
    }

    function fetchTimesForSelectedDate(){
      const dateEl = document.getElementById('date');
      const timeContainer = document.getElementById('time-container');
      const loc = document.getElementById('area').value || '';
      const srv = document.getElementById('service').value || '';
      const selectedISO = (dateEl.value || DateTime.now().toFormat('yyyy-LL-dd')).trim();

      if (!loc || !srv) {
        timeContainer.innerHTML = `<div style="grid-column:1/-1;justify-self:center" class="text-muted">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø© ÙˆØ§Ù„Ø®Ø¯Ù…Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</div>`;
        window.selectedTime = null; selectedTime = null;
        updateNextAvailability?.();
        return;
      }

      dateEl.disabled = true;
      setLoadingTimes(true);
      timeContainer.innerHTML = `
        <div class="spinner-border text-info" role="status" style="grid-column:1/-1;justify-self:center;">
          <span class="visually-hidden">Loading...</span>
        </div>`;

      const now = DateTime.now().setZone('Asia/Riyadh');
      const isToday = selectedISO === now.toISODate();

      const qs = `/appointments?startDate=${encodeURIComponent(selectedISO)}&location=${encodeURIComponent(loc)}&service=${encodeURIComponent(srv)}&onlyAvailable=1`;

      callContent2(qs, (res) => {
        const rowsRaw = (res?.data?.appointments || []);

        const filtered = rowsRaw.filter(r => {
          const d = DateTime.fromISO(r.TS_appointment_date, { setZone: true });
          if (!d.isValid || d.toISODate() !== selectedISO) return false;

          const t = parseTimeToLuxon(r.TS_appointment_time);
          if (!t) return false;

          const { looksOpen } = normalizeAvailability(r);
          if (!looksOpen) return false;

          if (isToday) {
            const slot = now.set({ hour: t.hour, minute: t.minute, second: 0 });
            if (slot < now.plus({ minutes: 5 })) return false;
          }
          return true;
        });

        const list = filtered.map(r => {
          const t = parseTimeToLuxon(r.TS_appointment_time);
          return { label: t.toLocaleString(DateTime.TIME_SIMPLE), actual12: t.toFormat('hh:mm a') };
        });

        // De-dup & sort
        const seen = new Set();
        dayTimes = list
          .filter(x => { if (seen.has(x.actual12)) return false; seen.add(x.actual12); return true; })
          .sort((a,b)=> a.actual12.localeCompare(b.actual12));

        timesLoaded = true;
        renderSelectedDateTimes(selectedISO);
        dateEl.disabled = false;
        setLoadingTimes(false);
      }, true);
    }

    function renderSelectedDateTimes(selectedISO){
      const timeContainer = document.getElementById('time-container');
      timeContainer.innerHTML = '';

      if (!timesLoaded) {
        timeContainer.innerHTML = `
          <div class="spinner-border text-info" role="status" style="grid-column:1/-1;justify-self:center;">
            <span class="visually-hidden">Loading...</span>
          </div>`;
        return;
      }

      if (!dayTimes.length) {
        timeContainer.innerHTML = `
          <div style="grid-column:1/-1;justify-self:center" class="text-muted">
            Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ù…ØªØ§Ø­Ø©
          </div>`;
        window.selectedTime = null;
        selectedTime = null;
        updateNextAvailability?.();
        return;
      }

      dayTimes.forEach((t) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'time-option';
        btn.setAttribute('role','radio');
        btn.setAttribute('aria-checked','false');
        btn.setAttribute('dir','ltr');
        btn.textContent = t.label;

        btn.addEventListener('click', () => {
          [...timeContainer.children].forEach(el => el.setAttribute('aria-checked','false'));
          btn.setAttribute('aria-checked','true');

          const parsed = DateTime.fromFormat(t.actual12, 'h:mm a');
          nForm.date = selectedISO;
          nForm.time = parsed.isValid ? parsed.toFormat('HH:mm') : t.actual12;

          window.selectedTime = { ui: t.label, iso: nForm.time };
          selectedTime        = window.selectedTime; // gate Next
          updateNextAvailability?.();
        });

        timeContainer.appendChild(btn);
      });
    }

    /* ---------------- Init & bindings ---------------- */
    $(function(){
      enforceDateMinToday();
      const today=DateTime.now().toFormat('yyyy-LL-dd');
      $('#date').val(today).attr('min',today);

      $('#area').select2({width:'100%',placeholder:'Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©', dir:'rtl'});
      $('#serviceCat').select2({width:'100%',placeholder:'Ø§Ù„ØªØµÙ†ÙŠÙ', dir:'rtl'});
      $('#service').select2({width:'100%',placeholder:'Ø§Ù„Ø®Ø¯Ù…Ø©', dir:'rtl'});
      $('#carBrand').select2({width:'100%',placeholder:'Ù…Ø§Ø±ÙƒØ© Ø§Ù„Ø³ÙŠØ§Ø±Ø©', dir:'rtl'});

      itiPhone=window.intlTelInput(document.querySelector('#mobile'),{
        initialCountry:'sa', onlyCountries:['sa','ae','bh','kw','om','qa'],
        utilsScript:'https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/utils.js'
      });

      setLoadingServices(true);
      callContent2(`/locations`, res=>{
        const list=res?.data||[]; const ds=list.map(l=>({id:l.id,text:l.TS_location_arabic_name}));
        $('#area').empty().select2({data:ds,width:'100%'});
        setLoadingServices(false);                   // â† Ù„Ø§ ØªØªØ±Ùƒ overlay Ù…Ø¹Ù„Ù‘Ù‚Ø©
        if(ds.length){ $('#area').val(ds[0].id).trigger('change'); }
        else { showToast('error','Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§Ø·Ù‚ Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹'); }
      });

      $('#area').on('change', function(){
        nForm.location=this.value; setLoadingServices(true);
        callContent2(`/services?location=${encodeURIComponent(this.value)}`, res=>{
          servicesCache=res?.data?.services||[]; categoriesCache=res?.data?.servicesCat||[];
          const cats=categoriesCache.map(c=>({id:c.TS_category_id,text:c.TS_category_arabic_name}));
          $('#serviceCat').empty().select2({data:cats,width:'100%'});
          if(cats.length){ $('#serviceCat').val(cats[0].id).trigger('change'); }
          setLoadingServices(false);                 // â† Ø§Ø®ÙØ§Ø¡ overlay Ø¨Ø¹Ø¯ Ø§Ù„Ø®Ø¯Ù…Ø§Øª
          updateNextAvailability();
        }, true);
      });

      $('#serviceCat').on('change', function(){
        nForm.serviceCat=this.value; const cid=Number(this.value);
        const items=servicesCache?.filter(s=>Number(s.TS_category_id)===cid)?.sort((a,b)=>a.TS_service_id-b.TS_service_id)?.map(s=>({id:s.TS_service_id,text:s.TS_service_arabic_name}))||[];
        $('#service').empty().select2({data:items,width:'100%'});
        if(items.length){ $('#service').val(items[0].id).trigger('change'); }
        updateNextAvailability();
      });

      $('#service').on('change', function(){
        nForm.service = this.value || '';
        if(getActiveIndex()===2) document.getElementById('date').dispatchEvent(new Event('change'));
        updateNextAvailability();
      });

      const brands=["Toyota","Nissan","Hyundai","Kia","Honda","Lexus","BMW","Mercedes-Benz","Chevrolet","Ford","Mazda","Mitsubishi","Aston Martin","Other"].sort().map(b=>({id:b,text:b}));
      $('#carBrand').empty().select2({data:brands,width:'100%'});

      const payGroup = document.getElementById('payGroup');
      const payCards = [...payGroup.querySelectorAll('.pay-card')];
      payCards.forEach((card, idx)=>{
        const input = card.querySelector('input');
        card.setAttribute('role','radio'); card.setAttribute('aria-checked','false'); card.setAttribute('tabindex', idx===0?'0':'-1');
        const choose = () => {
          payCards.forEach(c=>{ c.setAttribute('aria-checked','false'); c.setAttribute('tabindex','-1'); c.querySelector('input').checked=false; });
          card.setAttribute('aria-checked','true'); card.setAttribute('tabindex','0'); input.checked=true; nForm.paymentMethod=input.value; updateNextAvailability(); };
        card.addEventListener('click', choose);
        card.addEventListener('keydown', (e)=>{
          if(e.key==='Enter' || e.key===' '){ e.preventDefault(); choose(); }
          if(['ArrowRight','ArrowDown','ArrowLeft','ArrowUp'].includes(e.key)){
            e.preventDefault();
            const i = payCards.indexOf(card);
            const nextI = (e.key==='ArrowRight'||e.key==='ArrowDown') ? Math.min(i+1,payCards.length-1) : Math.max(i-1,0);
            payCards[nextI].focus();
          }
        });
      });

      $('#plateNumber').on('input', function(){ this.value = this.value.replace(/\D/g, '').slice(0,4); updateNextAvailability(); });
      $('#name, #mobile, #carName').on('input', updateNextAvailability);
      $('#serviceCount, #serviceCat, #service, #area, #date').on('change', updateNextAvailability);

      $('#rebook').on('click', ()=>location.href='/');

      // initial progress + welcome
      syncProgress(0);
      startWelcomeDeck();
      renderSummary();
      syncHeaderHeight();
      window.addEventListener('resize', syncHeaderHeight);
    });

    // Footer nav + welcome Skip
    (function(){
      const $prev=document.getElementById('footer-prev');
      const $next=document.getElementById('footer-next');
      const $start=document.getElementById('page1-button');

      $start.addEventListener('click', ()=>{ stopWelcomeDeck(); showPage(1); });

      async function gotoNext(){
        const i=getActiveIndex(); const id=orderedPages[i];

        if(id==='page2'){
          if(!$('#area').val()){ showToast('error','ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©'); return; }
          if(!$('#service').val()){ showToast('error','ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø®Ø¯Ù…Ø©'); return; }
          nForm.service=$('#service').val(); nForm.serviceCount=$('#serviceCount').val()||'1';
          showPage(2); document.getElementById('date').dispatchEvent(new Event('change'));
          return;
        }

        if(id==='page4'){
          if(!selectedTime){ showToast('error','Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ÙˆÙ‚Øª'); return; }
          showPage(3); return;
        }

        if(id==='page5'){
          const name=$('#name').val().trim();
          if(!name){ showToast('error','ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù…'); document.getElementById('name').focus(); return; }
          if(!validateMobile()) return;
          if(!validatePlate()) return;
          if(!nForm.paymentMethod){ showToast('error','ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹'); return; }

          nForm.customerN=name;
          nForm.customerM=itiPhone.getNumber().replace(/^\+/, '');
          nForm.locationDescription=[$('#carBrand').val()||'', $('#carName').val()||'', $('#plateNumber').val()||''].filter(Boolean).join(', ');
          showPage(4);
          return;
        }

        if(id==='page6'){
          if(!positionUrl){ showToast('error','Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©'); return; }
          nForm.urlLocation=positionUrl;

          const payload = {
            date: nForm.date, time: nForm.time, location: nForm.location,
            service: nForm.service, serviceCount: nForm.serviceCount, serviceCat: nForm.serviceCat,
            customerM: nForm.customerM, customerN: nForm.customerN, paymentMethod: nForm.paymentMethod,
            urlLocation: nForm.urlLocation, locationDescription: nForm.locationDescription || '',
            locale: 'ar'
          };

          const r = await postReservation(payload);

          if(r.ok && r.data?.success){
            if(r.data?.otp){
              showToast('error','Ø§Ù„Ø®Ø§Ø¯Ù… ÙŠØ·Ù„Ø¨ Ø±Ù…Ø² ØªØ­Ù‚Ù‚ (OTP). Ø¹Ø·Ù‘Ù„ Ø®ÙŠØ§Ø± OTP ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.');
              return;
            }
            showToast('success','ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø¬Ø²');
            showPage(5);
            renderThankYou();
          } else {
            const msg = r?.data?.msgAR
              || (r.status===404 ? 'Ø§Ù„Ù…Ø³Ø§Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯: ØªØ£ÙƒØ¯ Ù…Ù† /form/reserveAppointment'
                                 : r.status===0   ? 'ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… (ØªØ­Ù‚Ù‚ Ù…Ù† CORS/Ø§Ù„Ø´Ø¨ÙƒØ©)'
                                                  : 'ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø¬Ø²');
            showToast('error', msg);
          }
          return;
        }

        showPage(Math.min(i+1, orderedPages.length-1));
      }

      $next.addEventListener('click', gotoNext);
      $prev.addEventListener('click', ()=>{ const i=getActiveIndex(); showPage(Math.max(i-1,0)); });
    })();

    document.addEventListener('DOMContentLoaded', ()=>{
      document.body.classList.add('intro-play');
      setTimeout(()=>document.body.classList.remove('intro-play'), 820);
      enforceDateMinToday();
      syncHeaderHeight();
    });

    function updateNextAvailability(){
      const i = getActiveIndex();
      const nextBtn = document.getElementById('footer-next');
      let enable = true;
      if(i === 1){ enable = !!($('#area').val() && $('#service').val()); }
      else if(i === 2){ enable = !!selectedTime; }
      else if(i === 3){
        const nameOk = $('#name').val().trim().length > 0;
        const phoneOk = (itiPhone && itiPhone.isValidNumber());
        const payOk = !!nForm.paymentMethod;
        const plateOk = ($('#plateNumber').val()||'').length === 4;
        enable = nameOk && phoneOk && payOk && plateOk;
      } else if(i === 4){ enable = !!positionUrl; }
      nextBtn.disabled = !enable;
      nextBtn.classList.toggle('disabled', !enable);
      renderSummary();
    }

    function renderSummary(){
      const areaTxt=$('#area').find(':selected').text()||'â€”';
      const svcTxt =$('#service').find(':selected').text()||'â€”';
      const dateTxt=$('#date').val()||'â€”';
      const timeTxt=(window.selectedTime?.ui||'â€”');
      const payTxt =(nForm.paymentMethod||'â€”');

      // Ù†ØµÙˆØµ
      document.getElementById('sumArea')?.textContent=areaTxt;
      document.getElementById('sumService')?.textContent=svcTxt;
      document.getElementById('sumDate')?.textContent=dateTxt;
      document.getElementById('sumTime')?.textContent=timeTxt;
      document.getElementById('sumPay')?.textContent=payTxt;

      // Tooltips Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª (Ø­Ø§Ø±Ø³ null)
      document.querySelector('[data-sum-chip="area"]')   ?.setAttribute('title', areaTxt);
      document.querySelector('[data-sum-chip="service"]')?.setAttribute('title', svcTxt);
      document.querySelector('[data-sum-chip="date"]')   ?.setAttribute('title', dateTxt);
      document.querySelector('[data-sum-chip="time"]')   ?.setAttribute('title', timeTxt);
      document.querySelector('[data-sum-chip="pay"]')    ?.setAttribute('title', payTxt);

      syncHeaderHeight?.();
    }

    function renderThankYou(){
      const first = (nForm.customerN||'').trim().split(' ')[0];
      document.getElementById('thanksTitle').textContent =
        first ? `ØªÙ… Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯Ùƒ Ø¨Ù†Ø¬Ø§Ø­ØŒ ${first}! ğŸ‰` : `ØªÙ… Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯Ùƒ Ø¨Ù†Ø¬Ø§Ø­ ğŸ‰`;
      document.getElementById('thanksCopy').textContent =
        'ÙˆØµÙ„Ù†Ø§ Ø·Ù„Ø¨ÙƒØŒ ÙˆØ³Ù†Ø±Ø³Ù„ Ù„Ùƒ Ø§Ù„ØªØ£ÙƒÙŠØ¯ ÙˆØ§Ù„Ù„ÙˆÙƒÙŠØ´Ù† Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ù‚Ø±ÙŠØ¨Ø§Ù‹.';
      const info = [
        {icon:'fa-location-dot',        text: $('#area').find(':selected').text()||'â€”'},
        {icon:'fa-screwdriver-wrench',  text: $('#service').find(':selected').text()||'â€”'},
        {icon:'fa-calendar-day',        text: nForm.date || $('#date').val() || 'â€”'},
        {icon:'fa-clock',               text: (window.selectedTime?.ui || 'â€”')},
        {icon:'fa-credit-card',         text: nForm.paymentMethod || 'â€”'}
      ];
      document.getElementById('thanksSummary').innerHTML =
        info.map(i=>`<span class="chip"><i class="fa-solid ${i.icon}"></i> ${i.text}</span>`).join('');
    }
  </script>

  <!-- Google Maps (async) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBBHLoO038vsCovHN-SLUgAXqexlA2v0_4&callback=initMap&v=weekly&loading=async" async defer></script>
  <script>
    /* Google Map init */
    let map, marker, positionUrl="";
    function initMap(){
      const def={lat:26.34165524787632,lng:50.11524831545726};
      map=new google.maps.Map(document.getElementById('googleMap'),{center:def,zoom:12,disableDoubleClickZoom:true});
      marker=new google.maps.Marker({position:def,map,draggable:true,title:'Ø§Ø³Ø­Ø¨ Ø£Ùˆ Ø§Ø¶ØºØ· Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹'});
      const setPos=(latLng,pan=false)=>{ if(!latLng) return; marker.setPosition(latLng); if(pan) map.panTo(latLng); map.setZoom(17); positionUrl=`https://www.google.com/maps/search/?api=1&query=${latLng.lat()},${latLng.lng()}`; document.getElementById('mapHint').innerHTML = `ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹: <strong>${latLng.lat().toFixed(5)}, ${latLng.lng().toFixed(5)}</strong>`; updateNextAvailability(); };
      marker.addListener('dragend', ({latLng})=>setPos(latLng));
      map.addListener?.('click', ({latLng})=>setPos(latLng));
      map.addListener?.('click', ({latLng})=>setPos(latLng));
      const btn=document.getElementById('show-my-location');
      if(btn){
        btn.addEventListener('click', ()=>{
          if(!navigator.geolocation){ showToast('error','Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹'); return; }
          navigator.geolocation.getCurrentPosition(
            pos=>setPos(new google.maps.LatLng(pos.coords.latitude,pos.coords.longitude),true),
            err=>{ const msg = err?.message || 'Ø±Ø¬Ø§Ø¡Ù‹ ÙØ¹Ù‘Ù„ Ø§Ù„Ù€ GPS ÙˆØ£Ø°ÙˆÙ†Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹'; showToast('error','ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ: '+msg); },
            { enableHighAccuracy:true, timeout:10000, maximumAge:30000 }
          );
        });
      }
    }
    window.initMap = initMap;
  </script>
</body>
</html>
