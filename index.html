<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#2563eb"/>
  <title>Nahl â€¢ Rate Experience</title>

  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&family=Inter:wght@400;600;800&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg:#f4f6f8; --card:#ffffff; --text:#1f2937; --muted:#6b7280;
      --primary:#2563eb; --primary-600:#1d4ed8; --accent:#F4CE14;
      --border:#e5e7eb; --chip:#eef2ff; --chip-text:#1e40af;
      --danger:#ef4444; --success:#16a34a; --focus:rgba(37,99,235,.35);
      --shadow:0 8px 24px rgba(0,0,0,.08); --radius:16px;
    }
    [dir="ltr"] body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    [dir="rtl"] body{font-family:Cairo,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);-webkit-tap-highlight-color:transparent}

    .wrap{max-width:760px;margin:0 auto;padding:20px 16px calc(88px + env(safe-area-inset-bottom))}
    header.site{display:flex;align-items:center;gap:12px;padding:16px;margin:8px 0 16px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
    .brand{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#ffd95c);display:grid;place-items:center;font-weight:800;color:#111827}
    .title{font-size:18px;font-weight:800}
    .subtitle{color:var(--muted);font-size:13px}

    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin:12px 0}
    h2.section{font-size:16px;margin:0 0 10px}
    label.lbl{display:block;font-size:13px;font-weight:700;margin-bottom:6px}
    .help{font-size:12px;color:var(--muted)}
    textarea,input[type="number"],input[type="text"]{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:#fff;font-size:15px;outline:none}
    textarea:focus,input:focus{border-color:var(--primary);box-shadow:0 0 0 4px var(--focus)}
    textarea{min-height:120px;resize:vertical}

    /* Accessible hidden (not display:none so radios stay focusable) */
    .sr-only{position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    /* Stars */
    fieldset.rating-fieldset{border:0;padding:0;margin:0}
    .stars{display:inline-flex;flex-direction:row-reverse;gap:6px}
    .stars input{position:absolute;opacity:0}
    .stars label{cursor:pointer;font-size:32px;line-height:1;color:#c7ced9;transition:transform .05s ease}
    .stars input:focus-visible + label{outline:2px solid var(--primary);outline-offset:2px;border-radius:6px}
    .stars label:hover,.stars label:hover ~ label{color:#ffd95c;transform:scale(1.04)}
    .stars input:checked ~ label{color:#f7c948}

    .chips{display:flex;flex-wrap:wrap;gap:10px}
    .chip{background:var(--chip);color:var(--chip-text);border:1px dashed #c7d2fe;padding:10px 14px;border-radius:999px;font-size:14px;cursor:pointer;user-select:none}
    .chip:focus-visible{outline:2px solid var(--primary);outline-offset:2px}
    .chip.active{background:#dbeafe;border-style:solid}

    .row{display:grid;gap:12px}
    @media (min-width:640px){.row.cols-2{grid-template-columns:1fr 1fr}}
    .likert{display:grid;gap:6px}
    .likert output{font-variant-numeric:tabular-nums;font-weight:700}

    .btns{display:flex;gap:10px;flex-wrap:wrap}
    .btn{border:1px solid transparent;padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:800;font-size:14px;min-height:48px}
    .btn.primary{background:var(--primary);color:#fff}
    .btn.primary:hover{background:var(--primary-600)}
    .btn.ghost{background:transparent;border-color:var(--border)}

    /* Sticky action bar for mobile */
    .actionbar{position:fixed;left:0;right:0;bottom:0;z-index:60;padding:12px 16px calc(12px + env(safe-area-inset-bottom));background:linear-gradient(to top, rgba(255,255,255,.98), rgba(255,255,255,.92));border-top:1px solid var(--border);backdrop-filter:saturate(1.2) blur(6px)}

    .toast{position:fixed;inset-inline:16px;bottom:calc(16px + env(safe-area-inset-bottom));z-index:70;display:none;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:var(--card);box-shadow:var(--shadow);font-size:14px}
    .toast.show{display:block}
    .toast.ok{border-color:#bbf7d0}
    .toast.err{border-color:#fecaca}

    footer.note{text-align:center;color:#6b7280;font-size:12px;margin-top:18px}

    /* Reveal animations (respects reduced motion) */
    @media (prefers-reduced-motion:no-preference){
      .reveal{opacity:0;transform:translateY(8px)}
      .reveal.show{opacity:1;transform:none;transition:opacity .45s ease, transform .45s ease}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="site reveal">
      <div class="brand" aria-hidden="true">N</div>
      <div>
        <div class="title" data-i18n="app_title">Ù‚ÙŠÙ‘Ù… ØªØ¬Ø±Ø¨ØªÙƒ</div>
        <div class="subtitle" data-i18n="app_subtitle">Ø§Ø³ØªØ¨ÙŠØ§Ù† Ø±Ø¶Ø§ Ø§Ù„Ø®Ø¯Ù…Ø© â€¢ Service satisfaction survey</div>
      </div>
    </header>

    <form id="rateForm" novalidate>
      <!-- Overall rating -->
      <section class="card reveal">
        <fieldset class="rating-fieldset" aria-required="true">
          <legend class="section" id="ratingLegend" data-i18n="overall_rating">Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù…</legend>
          <div class="stars" role="radiogroup" aria-labelledby="ratingLegend">
            <input class="sr-only" type="radio" id="star5" name="rating" value="5" required>
            <label for="star5" aria-label="5">â˜…</label>
            <input class="sr-only" type="radio" id="star4" name="rating" value="4">
            <label for="star4" aria-label="4">â˜…</label>
            <input class="sr-only" type="radio" id="star3" name="rating" value="3">
            <label for="star3" aria-label="3">â˜…</label>
            <input class="sr-only" type="radio" id="star2" name="rating" value="2">
            <label for="star2" aria-label="2">â˜…</label>
            <input class="sr-only" type="radio" id="star1" name="rating" value="1">
            <label for="star1" aria-label="1">â˜…</label>
          </div>
        </fieldset>
        <label class="lbl" for="reviewText">Ø§ÙƒØªØ¨ Ø±Ø£ÙŠÙƒ</label>
        <textarea id="reviewText" placeholder="Ø§ÙƒØªØ¨ Ø±Ø£ÙŠÙƒ Ù‡Ù†Ø§â€¦ / Write your review hereâ€¦" aria-label="Review" required></textarea>
        <p class="help">Ø§Ø®ØªØ± Ù…Ù† Ù†Ø¬Ù…Ø© Ø¥Ù„Ù‰ Ø®Ù…Ø³ Ù†Ø¬ÙˆÙ… â€¢ Choose 1â€“5 stars</p>
      </section>

      <!-- Quick tags -->
      <section class="card reveal">
        <h2 class="section">Ù…Ø§ Ø§Ù„Ø°ÙŠ Ø£Ø¹Ø¬Ø¨ÙƒØŸ</h2>
        <div class="chips" id="chipsRow"></div>
        <p class="help">Ø§Ù†Ù‚Ø± Ù„Ù„Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ Ø§Ù„Ø¥Ø²Ø§Ù„Ø© â€¢ Tap to add/remove</p>
      </section>

      <!-- Satisfaction details -->
      <section class="card reveal">
        <h2 class="section">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø¶Ø§</h2>
        <div class="row cols-2">
          <div class="likert">
            <label class="lbl" for="qQuality">Ø¬ÙˆØ¯Ø© Ø§Ù„ØªÙ†Ø¸ÙŠÙ</label>
            <input id="qQuality" type="range" min="1" max="5" step="1" value="4" oninput="this.nextElementSibling.value=this.value"/>
            <output>4</output>
            <span class="help">1 Ø³ÙŠØ¦Ø© Ø¬Ø¯Ù‹Ø§ â† 5 Ù…Ù…ØªØ§Ø²Ø©</span>
          </div>
          <div class="likert">
            <label class="lbl" for="qSpeed">Ø³Ø±Ø¹Ø© Ø§Ù„Ø®Ø¯Ù…Ø©</label>
            <input id="qSpeed" type="range" min="1" max="5" step="1" value="4" oninput="this.nextElementSibling.value=this.value"/>
            <output>4</output>
            <span class="help">1 Ø¨Ø·ÙŠØ¦Ø© Ø¬Ø¯Ù‹Ø§ â† 5 Ø³Ø±ÙŠØ¹Ø© Ø¬Ø¯Ù‹Ø§</span>
          </div>
          <div class="likert">
            <label class="lbl" for="qStaff">Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</label>
            <input id="qStaff" type="range" min="1" max="5" step="1" value="4" oninput="this.nextElementSibling.value=this.value"/>
            <output>4</output>
            <span class="help">1 Ø³ÙŠØ¦Ø© Ø¬Ø¯Ù‹Ø§ â† 5 Ù…Ù…ØªØ§Ø²Ø©</span>
          </div>
          <div class="likert">
            <label class="lbl" for="qValue">Ø§Ù„Ù‚ÙŠÙ…Ø© Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„Ø³Ø¹Ø±</label>
            <input id="qValue" type="range" min="1" max="5" step="1" value="4" oninput="this.nextElementSibling.value=this.value"/>
            <output>4</output>
            <span class="help">1 Ø³ÙŠØ¦Ø© Ø¬Ø¯Ù‹Ø§ â† 5 Ù…Ù…ØªØ§Ø²Ø©</span>
          </div>
        </div>
      </section>

      <!-- Loyalty -->
      <section class="card reveal">
        <h2 class="section">Ø§Ù„ÙˆÙ„Ø§Ø¡</h2>
        <div class="row cols-2">
          <div>
            <label class="lbl">Ù‡Ù„ Ø³ØªØ¹ÙˆØ¯ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ØŸ</label>
            <div class="chips" role="radiogroup">
              <label class="chip"><input type="radio" name="return" value="yes" checked style="margin-inline-end:.5rem"> Ù†Ø¹Ù…</label>
              <label class="chip"><input type="radio" name="return" value="no" style="margin-inline-end:.5rem"> Ù„Ø§</label>
            </div>
          </div>
          <div>
            <label class="lbl" for="nps">Ø§Ù„ØªÙˆØµÙŠØ© Ø¨Ù†Ø§ (0â€“10)</label>
            <input id="nps" type="number" inputmode="numeric" min="0" max="10" step="1" value="9" required/>
            <span class="help">0 Ù„Ù† Ø£ÙˆØµÙŠ Ø¥Ø·Ù„Ø§Ù‚Ù‹Ø§ â† 10 Ø£ÙˆØµÙŠ Ø¨Ù‚ÙˆØ©</span>
          </div>
        </div>
      </section>

      <!-- Actions (in-card for desktop) -->
      <section class="card reveal hide-on-mobile" id="inlineAction">
        <h2 class="section">Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</h2>
        <p class="help">Ø³ÙŠØªÙ… Ø­ÙØ¸ ØªÙ‚ÙŠÙŠÙ…Ùƒ Ù„Ø¯ÙŠÙ†Ø§ ÙÙ‚Ø·.</p>
        <div class="btns">
          <button id="btnSubmitTop" class="btn primary" type="submit">Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
          <button type="button" class="btn ghost" id="btnReset">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
        </div>
      </section>
    </form>

    <footer class="note reveal"><span>ØªØµÙ…ÙŠÙ… Ù†Ø­Ù„ â€¢ WCAG 2.2 Ø¬Ø§Ù‡Ø² â€¢ ÙŠØ¹Ù…Ù„ Ø¯ÙˆÙ† Ù…ÙƒØªØ¨Ø§Øª Ø®Ø§Ø±Ø¬ÙŠØ©</span></footer>
  </div>

  <!-- Sticky action bar (mobile-first) -->
  <div class="actionbar" id="actionbar">
    <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;max-width:760px;margin:0 auto">
      <div class="help" id="validityHint">Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø«Ù… Ø§Ø¶ØºØ· Ø­ÙØ¸</div>
      <div class="btns" style="margin-inline-start:auto">
        <button id="btnSubmit" class="btn primary" type="button">Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
      </div>
    </div>
  </div>

  <!-- Toast & Done -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>
  <div id="doneView" class="card" style="display:none; margin:16px;max-width:760px;margin-inline:auto">
    <h2 class="section">Ø´ÙƒØ±Ù‹Ø§ Ù„Ùƒ! âœ…</h2>
    <p class="help">ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… ØªÙ‚ÙŠÙŠÙ…Ùƒ. Ù†Ù‚Ø¯Ø± ÙˆÙ‚ØªÙƒ.</p>
    <div class="btns">
      <button class="btn" id="btnAnother">Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚ÙŠÙŠÙ… Ø¢Ø®Ø±</button>
    </div>
  </div>

  <script>
  (function(){
    'use strict';

    var DEBUG=false;
    var CONFIG={
      tags:[
        {ar:"Ø§Ù„Ø³Ø±Ø¹Ø©",en:"Speed"},
        {ar:"Ø§Ù„Ø¬ÙˆØ¯Ø©",en:"Quality"},
        {ar:"Ø§Ù„Ø³Ø¹Ø±",en:"Price"},
        {ar:"Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ†",en:"Staff"},
        {ar:"Ø¯Ù‚Ø© Ø§Ù„ÙˆØµÙˆÙ„",en:"Punctual (Mobile)"},
        {ar:"Ù†Ø¸Ø§ÙØ© Ø§Ù„Ø£Ø¯ÙˆØ§Øª",en:"Clean tools"},
        {ar:"Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø§Ø¡",en:"Gentle on paint"}
      ]
    };

    var I18N={
      ar:{
        app_title:"Ù‚ÙŠÙ‘Ù… ØªØ¬Ø±Ø¨ØªÙƒ",
        app_subtitle:"Ø§Ø³ØªØ¨ÙŠØ§Ù† Ø±Ø¶Ø§ Ø§Ù„Ø®Ø¯Ù…Ø© â€¢ Service satisfaction survey",
        overall_rating:"Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù…",
        write_review:"Ø§ÙƒØªØ¨ Ø±Ø£ÙŠÙƒ",
        review_placeholder:"Ø§ÙƒØªØ¨ Ø±Ø£ÙŠÙƒ Ù‡Ù†Ø§â€¦",
        what_you_liked:"Ù…Ø§ Ø§Ù„Ø°ÙŠ Ø£Ø¹Ø¬Ø¨ÙƒØŸ",
        tap_to_toggle:"Ø§Ù†Ù‚Ø± Ù„Ù„Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ Ø§Ù„Ø¥Ø²Ø§Ù„Ø©",
        satisfaction_details:"ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø¶Ø§",
        q_quality:"Ø¬ÙˆØ¯Ø© Ø§Ù„ØªÙ†Ø¸ÙŠÙ",
        q_speed:"Ø³Ø±Ø¹Ø© Ø§Ù„Ø®Ø¯Ù…Ø©",
        q_staff:"Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†",
        q_value:"Ø§Ù„Ù‚ÙŠÙ…Ø© Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„Ø³Ø¹Ø±",
        help_quality:"1 Ø³ÙŠØ¦Ø© Ø¬Ø¯Ù‹Ø§ â† 5 Ù…Ù…ØªØ§Ø²Ø©",
        help_speed:"1 Ø¨Ø·ÙŠØ¦Ø© Ø¬Ø¯Ù‹Ø§ â† 5 Ø³Ø±ÙŠØ¹Ø© Ø¬Ø¯Ù‹Ø§",
        loyalty:"Ø§Ù„ÙˆÙ„Ø§Ø¡",
        return_again:"Ù‡Ù„ Ø³ØªØ¹ÙˆØ¯ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ØŸ",
        yes:"Ù†Ø¹Ù…",
        no:"Ù„Ø§",
        nps_label:"Ø§Ù„ØªÙˆØµÙŠØ© Ø¨Ù†Ø§ (0â€“10)",
        nps_help:"0 Ù„Ù† Ø£ÙˆØµÙŠ Ø¥Ø·Ù„Ø§Ù‚Ù‹Ø§ â† 10 Ø£ÙˆØµÙŠ Ø¨Ù‚ÙˆØ©",
        submit_section:"Ø§Ù„Ø¥Ø±Ø³Ø§Ù„",
        submit_note:"Ø³ÙŠØªÙ… Ø­ÙØ¸ ØªÙ‚ÙŠÙŠÙ…Ùƒ Ù„Ø¯ÙŠÙ†Ø§ ÙÙ‚Ø·.",
        save_rating:"Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…",
        reset:"Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†",
        complete_required:"Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø«Ù… Ø§Ø¶ØºØ· Ø­ÙØ¸",
        ready_to_send:"Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¥Ø±Ø³Ø§Ù„",
        thanks_title:"Ø´ÙƒØ±Ù‹Ø§ Ù„Ùƒ! âœ…",
        thanks_body:"ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… ØªÙ‚ÙŠÙŠÙ…Ùƒ. Ù†Ù‚Ø¯Ø± ÙˆÙ‚ØªÙƒ.",
        send_another:"Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚ÙŠÙŠÙ… Ø¢Ø®Ø±",
        saving:"Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸â€¦",
        saved_success:"ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­",
        save_failed:"ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ÙØ¸",
        offline:"Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª",
        error_bad_link:"Ø®Ø·Ø£: Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ­ÙŠØ­ (Ø¨Ø¯ÙˆÙ† bookingId).",
        error_no_rating:"Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø¨Ø§Ù„Ù†Ø¬ÙˆÙ…",
        error_no_text:"Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù†ØµÙŠ",
        error_bad_nps:"Ù‚ÙŠÙ…Ø© NPS ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¨ÙŠÙ† 0 Ùˆ 10"
      },
      en:{
        app_title:"Rate your experience",
        app_subtitle:"Service satisfaction survey",
        overall_rating:"Overall rating",
        write_review:"Write your review",
        review_placeholder:"Type your review hereâ€¦",
        what_you_liked:"What did you like?",
        tap_to_toggle:"Tap to add/remove",
        satisfaction_details:"Satisfaction details",
        q_quality:"Cleaning quality",
        q_speed:"Service speed",
        q_staff:"Staff professionalism",
        q_value:"Value for money",
        help_quality:"1 Very poor â† 5 Excellent",
        help_speed:"1 Very slow â† 5 Very fast",
        loyalty:"Loyalty",
        return_again:"Would you return?",
        yes:"Yes",
        no:"No",
        nps_label:"Recommend us (0â€“10)",
        nps_help:"0 Wouldnâ€™t recommend â† 10 Highly recommend",
        submit_section:"Submit",
        submit_note:"Your rating is saved privately.",
        save_rating:"Save rating",
        reset:"Reset",
        complete_required:"Complete required fields, then Save",
        ready_to_send:"Ready to send",
        thanks_title:"Thank you! âœ…",
        thanks_body:"We received your feedback. We appreciate your time.",
        send_another:"Send another rating",
        saving:"Savingâ€¦",
        saved_success:"Saved successfully",
        save_failed:"Save failed",
        offline:"Youâ€™re offline",
        error_bad_link:"Invalid link (missing bookingId).",
        error_no_rating:"Please select a star rating",
        error_no_text:"Please write your review",
        error_bad_nps:"NPS must be between 0 and 10"
      }
    };

    function $(s,r){return (r||document).querySelector(s)}
    function $$(s,r){return Array.prototype.slice.call((r||document).querySelectorAll(s))}

    function showToast(msg, ok){
      if(ok===void 0) ok=true;
      var t=$('#toast'); if(!t) return;
      t.textContent=msg; t.className='toast show '+(ok?'ok':'err');
      setTimeout(function(){ t.classList.remove('show') }, 2500);
    }

    var io = new IntersectionObserver(function(entries){
      entries.forEach(function(e){ if(e.isIntersecting) e.target.classList.add('show') });
    }, {threshold:0.05});

    function hydrateTags(){
      var row=$('#chipsRow'); if(!row) return; row.innerHTML='';
      var lang=document.documentElement.lang||'ar';
      CONFIG.tags.forEach(function(t){
        var b=document.createElement('button');
        b.type='button'; b.className='chip'; b.setAttribute('aria-pressed','false'); b.textContent=(lang==='en'?t.en:t.ar);
        b.addEventListener('click', function(){
          var on=b.classList.toggle('active');
          b.setAttribute('aria-pressed', on ? 'true' : 'false');
        });
        row.appendChild(b);
      });
    }

    function getRating(){ var r=$$('input[name="rating"]').find(function(i){return i.checked}); return r?Number(r.value):0 }
    function getParam(name){ var u=new URL(window.location.href); return u.searchParams.get(name) }

    function collectPayload(){
      var chips=$$('.chip.active').map(function(ch){return ch.textContent});
      return {
        bookingId: getParam('bookingId') || '',
        ts: new Date().toISOString(),
        lang: document.documentElement.lang || 'ar',
        rating: getRating(),
        reviewText: ($('#reviewText') && $('#reviewText').value ? $('#reviewText').value.trim() : ''),
        tags: chips,
        q: {
          quality: Number($('#qQuality') && $('#qQuality').value || 0),
          speed:   Number($('#qSpeed') && $('#qSpeed').value || 0),
          staff:   Number($('#qStaff') && $('#qStaff').value || 0),
          value:   Number($('#qValue') && $('#qValue').value || 0)
        },
        wouldReturn: (function(){ var r=$$('input[name="return"]').find(function(i){return i.checked}); return r ? r.value : 'yes' })(),
        nps: Number($('#nps') && $('#nps').value || 0),
        client: { ua: navigator.userAgent }
      };
    }

    function saveToServer(payload){
      return fetch('/api/gas-proxy', {
        method:'POST',
        headers:{'Content-Type':'application/json','X-Requested-With':'XMLHttpRequest'},
        body: JSON.stringify({ action:'review.save', data: payload })
      }).then(function(res){
        return res.json().catch(function(){ return {} }).then(function(json){ return { status: res.status, ok: json.ok, error: json.error, id: json.id } });
      });
    }

    function validate(){
      var form=$('#rateForm');
      if(!getParam('bookingId')){ showToast(t('error_bad_link'), false); return false }
      if(form && !form.checkValidity()){ showToast(t('complete_required'), false); return false }
      if(!getRating()){ showToast(t('error_no_rating'), false); return false }
      var text = $('#reviewText') && $('#reviewText').value ? $('#reviewText').value.trim() : '';
      if(!text){ showToast(t('error_no_text'), false); return false }
      var nps = Number($('#nps') && $('#nps').value || 0);
      if(isNaN(nps) || nps<0 || nps>10){ showToast(t('error_bad_nps'), false); return false }
      return true;
    }

    function validateSoft(){
      var hasRating = !!getRating();
      var txt = $('#reviewText') && $('#reviewText').value ? $('#reviewText').value.trim() : '';
      var nps = $('#nps') && $('#nps').value;
      return hasRating && txt.length>0 && nps!=='';
    }

    function updateValidityHint(){
      var ok = validateSoft();
      var v = $('#validityHint'); if(v){ v.textContent = ok ? t('ready_to_send') : t('complete_required') }
    }

    function onSubmit(){
      if(!validate()) return;
      var btn=$('#btnSubmit'); var btnTop=$('#btnSubmitTop');
      [btn,btnTop].forEach(function(b){ if(b){ b.disabled=true; b.textContent=t('saving') } });
      saveToServer(collectPayload()).then(function(result){
        if(result && result.ok){
          showToast(t('saved_success'), true);
          var w=document.querySelector('.wrap'); if(w) w.style.display='none';
          var ab=$('#actionbar'); if(ab) ab.style.display='none';
          var dv=$('#doneView'); if(dv) dv.style.display='block';
        } else {
          showToast(t('save_failed') + ' â€¢ ' + (result && result.error ? result.error : 'Unknown error'), false);
          if(DEBUG) console.error(result);
        }
      }).catch(function(err){
        if(DEBUG) console.error(err);
        showToast(navigator.onLine ? t('save_failed') : t('offline'), false);
      }).finally(function(){
        [btn,btnTop].forEach(function(b){ if(b){ b.disabled=false; b.textContent=t('save_rating') } });
      });
    }

    function resetForm(){
      var f=$('#rateForm'); if(f) f.reset();
      $$('.chip.active').forEach(function(ch){ ch.classList.remove('active') });
      updateValidityHint();
    }

    function t(key){ var lang=document.documentElement.lang||'ar'; return (I18N[lang] && I18N[lang][key]) || key }

    function applyI18n(lang){
      document.documentElement.lang=lang;
      document.documentElement.dir=(lang==='ar')?'rtl':'ltr';
      var el;
      el=$('.title'); if(el) el.textContent=t('app_title');
      el=$('.subtitle'); if(el) el.textContent=t('app_subtitle');
      el=$('#ratingLegend'); if(el) el.textContent=t('overall_rating');
      el=$('label[for="reviewText"]'); if(el) el.textContent=t('write_review');
      el=$('#reviewText'); if(el) el.placeholder=t('review_placeholder');
      var tagsSec = $('#chipsRow'); if(tagsSec){ var s = tagsSec.closest('section'); if(s){ var h=s.querySelector('h2.section'); if(h) h.textContent=t('what_you_liked'); var hp=s.querySelector('.help'); if(hp) hp.textContent=t('tap_to_toggle') } }
      el=$('h2.section'); // not changing the first, handled above
      var satCard = (function(){ var cards=$$('#rateForm .card'); for(var i=0;i<cards.length;i++){ if(cards[i].querySelector('.likert')) return cards[i]; } return null })();
      if(satCard){ var h2=satCard.querySelector('h2.section'); if(h2) h2.textContent=t('satisfaction_details'); }
      el=$('label[for="qQuality"]'); if(el) el.textContent=t('q_quality');
      el=$('label[for="qSpeed"]'); if(el) el.textContent=t('q_speed');
      el=$('label[for="qStaff"]'); if(el) el.textContent=t('q_staff');
      el=$('label[for="qValue"]'); if(el) el.textContent=t('q_value');
      var q;
      q=$('#qQuality'); if(q && q.parentElement){ var hp1=q.parentElement.querySelector('.help'); if(hp1) hp1.textContent=t('help_quality') }
      q=$('#qSpeed'); if(q && q.parentElement){ var hp2=q.parentElement.querySelector('.help'); if(hp2) hp2.textContent=t('help_speed') }
      q=$('#qStaff'); if(q && q.parentElement){ var hp3=q.parentElement.querySelector('.help'); if(hp3) hp3.textContent=t('help_quality') }
      q=$('#qValue'); if(q && q.parentElement){ var hp4=q.parentElement.querySelector('.help'); if(hp4) hp4.textContent=t('help_quality') }
      var loyalty = (function(){ var cards=$$('#rateForm .card'); for(var i=0;i<cards.length;i++){ if(cards[i].querySelector('input[name="return"]')) return cards[i]; } return null })();
      if(loyalty){
        var h=loyalty.querySelector('h2.section'); if(h) h.textContent=t('loyalty');
        el=loyalty.querySelector('.lbl'); if(el) el.textContent=t('return_again');
        var yesInp=$('input[name="return"][value="yes"]'); if(yesInp && yesInp.parentElement){ yesInp.parentElement.lastChild.nodeValue=' '+t('yes') }
        var noInp=$('input[name="return"][value="no"]'); if(noInp && noInp.parentElement){ noInp.parentElement.lastChild.nodeValue=' '+t('no') }
        el=$('label[for="nps"]'); if(el) el.textContent=t('nps_label');
        var npsHelp=$('#nps') && $('#nps').parentElement ? $('#nps').parentElement.querySelector('.help') : null; if(npsHelp) npsHelp.textContent=t('nps_help');
      }
      var inline=$('#inlineAction'); if(inline){
        var sh=inline.querySelector('h2.section'); if(sh) sh.textContent=t('submit_section');
        var sp=inline.querySelector('.help'); if(sp) sp.textContent=t('submit_note');
        el=$('#btnSubmitTop'); if(el) el.textContent=t('save_rating');
        el=$('#btnReset'); if(el) el.textContent=t('reset');
      }
      el=$('#validityHint'); if(el) el.textContent=t('complete_required');
      el=$('#btnSubmit'); if(el) el.textContent=t('save_rating');
      var dv=$('#doneView'); if(dv){ var h2=dv.querySelector('h2.section'); if(h2) h2.textContent=t('thanks_title'); var hp=dv.querySelector('.help'); if(hp) hp.textContent=t('thanks_body'); }
      el=$('#btnAnother'); if(el) el.textContent=t('send_another');
      hydrateTags();
      var langBtn=$('#langToggle'); if(langBtn){ langBtn.textContent = (lang==='ar'?'EN':'AR') }
    }

    function setTheme(theme){
      var root=document.documentElement;
      if(theme==='dark'){ root.setAttribute('data-theme','dark') } else { root.removeAttribute('data-theme') }
      var thBtn=$('#themeToggle'); if(thBtn){ thBtn.textContent=(theme==='dark'?'â˜€ï¸':'ğŸŒ™') }
    }

    // INIT
    $$('.reveal').forEach(function(el){ io.observe(el) });
    hydrateTags();
    var storedTheme=localStorage.getItem('nahl.rate.theme');
    var prefersDark = false; try{ prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches }catch(e){}
    setTheme(storedTheme || (prefersDark ? 'dark' : 'light'));
    var storedLang=localStorage.getItem('nahl.rate.lang');
    var initialLang = storedLang || (document.documentElement.lang || 'ar');
    applyI18n(initialLang);

    var btnSubmit=$('#btnSubmit'); if(btnSubmit) btnSubmit.addEventListener('click', onSubmit);
    var form=$('#rateForm'); if(form) form.addEventListener('submit', function(e){ e.preventDefault(); onSubmit() });
    var btnReset=$('#btnReset'); if(btnReset) btnReset.addEventListener('click', function(){ resetForm(); showToast('â†º') });
    var btnAnother=$('#btnAnother'); if(btnAnother) btnAnother.addEventListener('click', function(){ location.reload() });
    var langToggle=$('#langToggle'); if(langToggle) langToggle.addEventListener('click', function(){ var next=(document.documentElement.lang==='ar'?'en':'ar'); localStorage.setItem('nahl.rate.lang', next); applyI18n(next) });
    var themeToggle=$('#themeToggle'); if(themeToggle) themeToggle.addEventListener('click', function(){ var isDark=document.documentElement.getAttribute('data-theme')==='dark'; var next=isDark?'light':'dark'; localStorage.setItem('nahl.rate.theme', next); setTheme(next) });
    ['input','change','keyup'].forEach(function(ev){ document.addEventListener(ev, updateValidityHint, true) });
    updateValidityHint();
  })();
</script>
</body>
</html>
