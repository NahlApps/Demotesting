<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />

  <title>حجوزات المواعيد</title>
  <meta name="title" content="حجوزات المواعيد" />
  <meta
    name="description"
    content="بنغسل سيارتك بخلطة خاصة مدعّمة بالواكس تحميها من الغبار والخدوش. فوطنا دايمًا نظيفة. ونستخدم إسفنجة مخصوصة للكفرات عشان نهتم بكل تفاصيل سيارتك. #غسيل_بدون_طوابير"
  />
  <meta itemprop="name" content="حجوزات المواعيد" />
  <meta
    itemprop="description"
    content="بنغسل سيارتك بخلطة خاصة مدعّمة بالواكس تحميها من الغبار والخدوش. فوطنا دايمًا نظيفة. ونستخدم إسفنجة مخصوصة للكفرات عشان نهتم بكل تفاصيل سيارتك. #غسيل_بدون_طوابير"
  />
  <meta
    itemprop="image"
    content="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/Logo%20-%20Sponge%20and%20Soap%20-%201.png"
  />

  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://www.spongnsoap.com" />
  <meta property="og:title" content="حجوزات المواعيد" />
  <meta
    property="og:description"
    content="بنغسل سيارتك بخلطة خاصة مدعّمة بالواكس تحميها من الغبار والخدوش. فوطنا دايمًا نظيفة. ونستخدم إسفنجة مخصوصة للكفرات عشان نهتم بكل تفاصيل سيارتك. #غسيل_بدون_طوابير"
  />
  <meta
    property="og:image"
    content="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/Logo%20-%20Sponge%20and%20Soap%20-%201.png"
  />

  <meta property="twitter:card" content="summary_large_image" />
  <meta property="twitter:url" content="https://www.spongnsoap.com" />
  <meta property="twitter:title" content="حجوزات المواعيد" />
  <meta
    property="twitter:description"
    content="بنغسل سيارتك بخلطة خاصة مدعّمة بالواكس تحميها من الغبار والخدوش. فوطنا دايمًا نظيفة. ونستخدم إسفنجة مخصوصة للكفرات عشان نهتم بكل تفاصيل سيارتك. #غسيل_بدون_طوابير"
  />
  <meta
    property="twitter:image"
    content="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/Logo%20-%20Sponge%20and%20Soap%20-%201.png"
  />

  <link
    rel="shortcut icon"
    type="image/png"
    href="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/Logo%20-%20Sponge%20and%20Soap%20-%201.png"
  />

  <!-- Libraries -->
  <script
    src="https://code.jquery.com/jquery-3.6.3.slim.min.js"
    integrity="sha256-ZwqZIVdD3iXNyGHbSYdsmWP//UBokj2FHAxKuSBKDSo="
    crossorigin="anonymous"
  ></script>

  <link
    href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
    rel="stylesheet"
  />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>

  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    rel="stylesheet"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap"
    rel="stylesheet"
  />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD"
    crossorigin="anonymous"
  />
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
    crossorigin="anonymous"
  ></script>

  <!-- intl-tel-input -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/css/intlTelInput.css"
  />
  <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/intlTelInputWithUtils.js"></script>

  <style>
    :root{
      --brand:#0394b6;
      --brand-600:#027790;
      --brand-50:#e7f5fa;
      --ink:#0f1419;
      --muted:#5b6b79;
      --bg:#48b5d0e0;
      --surface:#ffffff;
      --border:#E7EBEF;
      --radius:14px;
    }

    *{ box-sizing: border-box; }
    html,body{ height:100%; }
    body{
      margin:0; font-family:'Cairo', sans-serif; color:#fff;
      display:flex; align-items:center; justify-content:center;
      background: #6fc1d3; /* fallback */
    }
    .bg-image{
      position:fixed; inset:0; z-index:-1;
      background-image:url("https://www.dropbox.com/s/s9bxuykl0w49dqa/background2.jpg?raw=1");
      background-position:center; background-repeat:no-repeat; background-size:cover;
      filter: blur(8px);
    }

    /* Layout */
    #banner{ display:none; }
    #form{
      width:100vw; height:100vh; max-width:1000px; margin:auto;
      background: var(--bg);
      color:#fff; box-shadow: 0 0 5px 10px rgba(5, 28, 59, 0.35), 10px 0px 70px 0px rgba(5, 28, 59, 0.25);
      display:flex; flex-direction:column; align-items:center; justify-content:center;
    }
    #form-content{ width:100%; height:100%; display:flex; flex-direction:column; }
    .header{ text-align:center; padding-top:14px; }
    .header img{ width:220px; }

    /* Stepper */
    .stepper{ width:100%; max-width:900px; margin:8px auto 12px; padding:0 16px; }
    .stepper ol{ list-style:none; display:flex; gap:8px; padding:0; margin:0; }
    .stepper li{
      flex:1; text-align:center; font-size:.85rem; padding:8px;
      border-radius:999px; background:rgba(255,255,255,.65); color:#0f1419; border:1px solid var(--border);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .stepper li.active{ background:var(--brand); color:#fff; border-color:var(--brand); font-weight:700; }
    .stepper li.done{ background:#d9f3f9; color:#045368; border-color:#aee3ef; }

    /* Pages */
    #form-content > div[id^="page"]{
      flex:1; display:none; align-items:center; justify-content:center; flex-direction:column; padding:16px;
    }
    #page1{ display:flex; }
    h1{ margin:8px 0 10px; font-weight:700; }
    h2{ margin:6px 0 8px; font-weight:700; }

    .filter-button-wrap{ padding:10px; }
    .filter-button{
      align-items:center; background:#fff; color:var(--brand);
      border-radius:12px; border:0; font-weight:700; padding:14px 18px;
      box-shadow: 0 6px 20px rgba(18,18,18,.08);
      transition:.2s; min-width: 160px;
      touch-action: manipulation;
    }
    .filter-button:hover{ background:var(--brand); color:#fff; }
    .filter-button.primary{ background:var(--brand); color:#fff; }
    .filter-button.primary:hover{ background:var(--brand-600); }

    /* Lists & inputs */
    label{ font-size:.95rem; opacity:.95; margin:4px 0; }
    input, select{ text-align:center; }
    .form-control{ border-radius:12px; }

    /* Time slots */
    .time-date-box{ width:100%; max-width:900px; margin-top:16px; padding:10px; }
    .time-container{
      background:#fff; border-radius:18px; padding:16px;
      display:grid; grid-template-columns:repeat(3, 1fr); gap:12px;
      max-height: 23rem; overflow-y:auto;
    }
    .time-button{
      background:#fff; color:#121212; border:1px solid var(--border);
      border-radius:12px; padding:16px; font-weight:700; cursor:pointer;
      box-shadow:0 4px 16px rgba(18,18,18,.06);
      transition: box-shadow .2s, transform .05s;
      touch-action: manipulation;
    }
    .time-button:hover{ background:#f7fdff; }
    .time-button.selected{ outline:2px solid var(--brand); box-shadow:0 0 0 3px rgba(3,148,182,.15); }
    @keyframes pop { 0%{transform:scale(1)} 40%{transform:scale(.97)} 100%{transform:scale(1)} }
    .time-button:active{ animation: pop .18s ease-out; }

    .slot-bar{
      position: sticky; bottom: max(12px, env(safe-area-inset-bottom));
      display:none; gap:8px; width:100%; max-width:900px; margin:12px auto 0; padding:0 10px;
    }
    .slot-bar .filter-button{ flex:1; }
    .slot-bar .filter-button.secondary{ background:#fff; color:var(--brand); border:1px solid var(--brand); }

    /* Map shell / fallback */
    .map-shell{ width:100%; max-width:900px; border:1px solid var(--border); border-radius:16px; overflow:hidden; background:var(--brand-50); min-height: 280px; position:relative; }
    .map-shell.loading::after{
      content:"جارِ تحميل الخريطة…"; position:absolute; inset:0; display:flex; align-items:center; justify-content:center; color:#045368; font-weight:700;
    }
    .map-error{ color:#7f1d1d; background:#fee2e2; border:1px solid #fecaca; padding:10px; border-radius:10px; display:none; margin-top:8px; }

    /* Social speed-dial */
    .social-fab,
    .fab-menu a{
      position: fixed; left: auto; right: max(12px, env(safe-area-inset-right));
      width:56px; height:56px; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      color:#fff; text-decoration:none;
      background: rgba(34,34,34,.55); backdrop-filter: blur(6px);
      box-shadow: 0 8px 20px rgba(0,0,0,.35), 0 0 0 2px rgba(255,255,255,.10) inset;
      transition: transform .18s ease, box-shadow .18s ease, opacity .18s ease;
      z-index: 998;
    }
    .social-fab.fab-toggle{ bottom: max(16px, env(safe-area-inset-bottom)); }
    .fab-menu{
      position: fixed; right: max(12px, env(safe-area-inset-right));
      bottom: calc(max(16px, env(safe-area-inset-bottom)) + 64px);
      display:none; gap:10px; flex-direction:column; z-index:999;
    }
    .fab-menu a{ position:static; width:48px; height:48px; }
    .fab-menu a i{ font-size:1.2rem; }
    .fab-open .fab-menu{ display:flex; }
    .social-fab:hover{ transform: translateY(-2px); }

    /* Payment cards */
    .pay-grid{ display:flex; gap:12px; flex-wrap:wrap; }
    .pay-card{
      flex:1; min-width:160px; display:flex; align-items:center; justify-content:center;
      border:1px solid var(--border); border-radius:12px; background:#fff; padding:14px; min-height:72px; cursor:pointer; position:relative;
    }
    .pay-card input{ position:absolute; inset:0; opacity:0; }
    .pay-card.selected{ outline:2px solid var(--brand); box-shadow:0 0 0 3px rgba(3,148,182,.15); }
    .pay-note{ font-size:.8rem; color:#045368; text-align:center; margin-top:6px; }

    /* Chips section (car info) */
    .chip{ background: rgba(255, 255, 255, 0); color: #ffffff; padding: 8px; border-radius: 8px; }
    .chip input,.chip select{
      width:100%; max-width:100%;
      font-size:14px; padding:10px; border-radius:10px; border:1px solid var(--border);
      background:#ffffff; color:#37338d; box-shadow:0 1px 3px rgba(0, 0, 0, 0.06);
      text-align:center;
    }
    #locationDescription{ font-weight:bold; background:#e9ecef; color:#555; }

    /* Animations */
    .fadeIn{ animation: fadeIn .35s ease forwards; }
    .fadeOut{ animation: fadeOut .35s ease forwards; }
    @keyframes fadeIn{ from{opacity:0} to{opacity:1} }
    @keyframes fadeOut{ from{opacity:1} to{opacity:0} }

    /* Responsive */
    @media (max-width: 1000px){
      .time-container{ grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 560px){
      .time-container{ grid-template-columns: 1fr; }
      .filter-button{ width:100%; }
    }

    /* footer */
    footer{ text-align:center; color:#fff; opacity:.95; padding-bottom: max(16px, env(safe-area-inset-bottom)); }
    footer a{ color:#fff; text-decoration:none; border-bottom:1px dotted rgba(255,255,255,.4); }
  </style>
</head>
<body>
  <div class="bg-image"></div>

  <div id="form">
    <div id="form-content">
      <!-- Header -->
      <div class="header">
        <img src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/spong&Soap%20-%20logo.png" alt="Sponge & Soap">
      </div>

      <!-- Stepper -->
      <nav class="stepper" aria-label="Progress">
        <ol>
          <li data-step="1" class="active">المنطقة</li>
          <li data-step="2">الخدمة</li>
          <li data-step="3">الوقت</li>
          <li data-step="4">البيانات</li>
          <li data-step="5">الموقع</li>
          <li data-step="6">التأكيد</li>
        </ol>
      </nav>

      <!-- Page 1 -->
      <div id="page1" class="fadeIn" style="display:flex;">
        <div dir="rtl" style="text-align:center;line-height:2;">
          <h3 style="margin:0 0 12px;">
            ✨ واكس يحمي سيارتك<br>
            🧼 فوط نظيفة & لمعان مضمون<br>
            🛞 إسفنجة للكفرات<br><br>
            ... نهتم بكل التفاصيل
          </h3>
          <p style="margin: 6px 0 16px;">
            <span style="font-weight:bold; font-size:18px;">#غسيل_بدون_طوابير</span>
          </p>
        </div>
        <div class="filter-button-wrap">
          <button id="page1-button" class="filter-button primary">احجز موعدك</button>
        </div>
      </div>

      <!-- Page 2 (Location + Service) -->
      <div id="page2" class="fadeIn" style="display:none;">
        <h1>وين تحب نجيك ؟<br>اختيار المنطقة</h1>

        <form onsubmit="handleSubmit(event)" id="page2-form" style="width:100%;max-width:900px;">
          <div id="select2-container" style="position:relative; padding:0 16px;">
            <select id="area" class="js-example-basic-single" style="width:100%" required></select>
            <div id="page2-spinner" style=" position:absolute; top:0; left:50%; transform:translateX(-50%); display:none;">
              <div class="spinner-border" role="status" style="width:1.5rem;height:1.5rem;margin-top:12px;"></div>
            </div>
          </div>

          <label for="service" style="margin-top:16px;">الخدمة</label>
          <div style="position:relative; padding:0 16px;">
            <select id="service" style="width:100%;" required></select>
            <div id="page3-2-spinner" style="position:absolute; top:0; left:50%; transform:translateX(-50%); display:none;">
              <div class="spinner-border" role="status" style="width:1.5rem; height:1.5rem; margin-top:12px;"></div>
            </div>
          </div>
        </form>

        <div class="filter-button-wrap">
          <button id="page2-button" class="filter-button primary">التالي</button>
        </div>
      </div>

      <!-- Page 3 (hidden serviceCat/serviceCount – kept for compatibility) -->
      <div id="page3" class="fadeIn" style="display:none;">
        <form onsubmit="handleSubmit(event)" id="page3-form" style="width:100%;max-width:900px; padding: 0 16px;">
          <select id="serviceCat" style="display:none;"></select>
          <select id="serviceCount" style="display:none;">
            <option value="1" selected>1</option><option value="2">2</option><option value="3">3</option>
            <option value="4">4</option><option value="5">5</option><option value="6">6</option>
            <option value="7">7</option><option value="8">8</option><option value="9">9</option>
            <option value="10">10</option>
          </select>
        </form>

        <div id="page3-buttons">
          <div id="fail-alert-4" class="alert alert-danger" role="alert" style="display:none;margin-top:16px;">
            <span></span><br><span></span>
          </div>
          <button id="page3-button" class="filter-button primary" hidden>التالي</button>
          <button id="page3-return" class="filter-button" hidden>السابق</button>
        </div>
      </div>

      <!-- Page 4 (Date & Time) -->
      <div id="page4" class="fadeIn" style="display:none;">
        <h1>متى تحب نجيك ؟<br>اختيار الموعد</h1>
        <input type="date" id="date" class="form-control" style="text-align:center; width: 90%; max-width: 560px;">

        <div class="time-date-box">
          <div id="time-container" class="time-container"></div>

          <div id="fail-alert-3" class="alert alert-danger" role="alert" style="display:none;margin-top:16px;">
            <span></span><br><span></span>
          </div>

          <!-- Sticky confirm/cancel after choosing slot -->
          <div class="slot-bar" id="slotBar">
            <button class="filter-button primary" id="confirmSlot">متابعة</button>
            <button class="filter-button secondary" id="changeSlot">تغيير</button>
          </div>
        </div>

        <div class="filter-button-wrap">
          <button id="page4-return" class="filter-button">السابق</button>
        </div>
      </div>

      <!-- Page 5 (Contact & Car & Payment) -->
      <div id="page5" class="fadeIn" style="display:none;">
        <form onsubmit="handleSubmit(event)" id="page5-form" style="width:100%; max-width:900px; padding:0 16px;">
          <h2>معلومات الاتصال</h2>
          <label for="name">الإسم</label>
          <input id="name" class="form-control" type="text" required>

          <label for="mobile" style="margin-top:8px;">رقم الجوال</label>
          <div class="phoneCountry" style="color:#000;">
            <input type="tel" id="mobile" class="form-control">
          </div>

          <h2 style="margin-top:16px;">معلومات المركبة</h2>
          <div class="chip" style="margin-bottom:10px;">
            <select id="carBrand"></select>
          </div>

          <div style="display:flex; gap:12px; flex-wrap:wrap; margin-bottom:10px;">
            <div class="chip" style="flex:1; min-width:220px;">
              <input type="text" id="carName" placeholder="اسم السيارة (GT-R, كامري، إلنترا)" oninput="updateLocationDescription()">
            </div>
            <div class="chip" style="flex:1; min-width:220px;">
              <input type="text" id="plateNumber" maxlength="4" inputmode="numeric" pattern="^\\d{1,4}$" placeholder="رقم اللوحة (مثال: 1234)" required>
            </div>
          </div>

          <div hidden>
            <input type="text" id="locationDescription" readonly placeholder="ماركة السيارة, اسم السيارة, رقم اللوحة">
          </div>

          <h2 style="margin-top:8px;">طريقة الدفع</h2>
          <div class="pay-grid" id="payGrid">
            <label class="pay-card">
              <input type="radio" name="payingMethod" value="STC Pay" required>
              <img src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/STC%20PAY%20LOGO.png" alt="STC Pay" width="110" height="36">
            </label>
            <label class="pay-card">
              <input type="radio" name="payingMethod" value="Cash" required>
              <span style="font-weight:700; font-size:1.2rem;">Cash</span>
            </label>
            <label class="pay-card" style="flex-basis:100%;">
              <input type="radio" name="payingMethod" value="MADA" required>
              <img src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/MADA%20LOGO.png" alt="MADA" style="max-width:180px; height:auto;">
            </label>
          </div>
        </form>

        <div id="page5-buttons" class="filter-button-wrap" style="display:flex; gap:8px; width:100%; max-width:900px;">
          <button id="page5-button" class="filter-button primary" style="flex:1;">التالي</button>
          <button id="page5-return" class="filter-button" style="flex:1;">السابق</button>
        </div>
      </div>

      <!-- Page 6 (Map + Terms) -->
      <div id="page6" class="fadeIn" style="display:none;">
        <h1>الموقع على خريطة قوقل</h1>

        <input id="placeSearch" class="form-control" placeholder="ابحث بالعنوان أو اسم المكان" style="width:90%; max-width:560px; margin-bottom:8px;">

        <div class="map-shell loading" id="mapShell">
          <div id="googleMap" style="width:100%; height:400px;"></div>
        </div>
        <div class="map-error" id="mapError">تعذر تحميل الخريطة. تحقق من اتصالك أو من صلاحيات Google Maps API Key.</div>

        <p style="text-align:center; font-size:14px; color:#073b4c; margin:8px 0;">
          📍 قم بسحب المؤشر أو اضغط على "اظهار موقعي".<br>سيتم رفض الحجز إذا كان الموقع خارج نطاق الخدمة المحدد.
        </p>

        <div style="display:flex; gap:8px; width:100%; max-width:900px; padding:0 10px;">
          <button class="filter-button" id="show-my-location" style="flex:1;">اظهار موقعي</button>
          <button id="page6-button" class="filter-button primary" style="flex:1;">التالي</button>
          <button id="page6-return" class="filter-button" style="flex:1;">السابق</button>
        </div>

        <div id="page6-spinner" class="d-flex flex-column align-items-center mt-2" style="display:none;">
          <div class="spinner-border" role="status"></div>
          <span class="mt-2">جارِ تأكيد الحجز…</span>
        </div>

        <div id="fail-alert-5" class="alert alert-danger mt-3" role="alert" style="display:none;">
          <span></span><br><span></span>
        </div>

        <!-- Terms Modal -->
        <div class="modal fade" id="termsModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">الشروط والأحكام – مغسلة سيارات متنقلة</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
              </div>
              <div class="modal-body" style="text-align:right;">
                <ol style="padding-right: 1rem;">
                  <li><strong>الخدمات المقدمة</strong> – حسب الباقات المعروضة أو الاتفاق المسبق.</li>
                  <li><strong>الحجز</strong> – قد يتم تعديل/إلغاء الموعد مع إشعار العميل عند وجود ظرف طارئ.</li>
                  <li><strong>الدفع</strong> – قبل بدء الخدمة (تحويل، مدى، بطاقات، STC، Apple Pay، نقدًا).</li>
                  <li><strong>الإلغاء والاسترجاع</strong> – قبل 3 ساعات يُسترد/يُجدول، أقل من ذلك لا يحق الاسترجاع.</li>
                  <li><strong>مسؤولية المغسلة</strong> – جودة المواد؛ غير مسؤولة عن أعطال سابقة؛ تعويض عادل للضرر المباشر فقط.</li>
                  <li><strong>مسؤولية العميل</strong> – إخلاء السيارة من المتعلقات، وتوفير مكان مناسب وآمن.</li>
                  <li><strong>الوقت</strong> – المدة تقديرية؛ التأخير 15 دقيقة كحد أقصى ثم يعتبر الموعد لاغيًا.</li>
                  <li><strong>تعديلات الشروط</strong> – قابلة للتحديث؛ استخدام الخدمة قبولٌ لها.</li>
                  <li><strong>القانون</strong> – أنظمة المملكة العربية السعودية.</li>
                </ol>
                <div class="form-check mt-2">
                  <input class="form-check-input" type="checkbox" id="termsAccept">
                  <label class="form-check-label" for="termsAccept">أوافق على الشروط والأحكام</label>
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button class="btn btn-primary" id="confirmTerms" disabled>تأكيد ومتابعة</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Page 7 (Thanks) -->
      <div id="page7" class="fadeIn" style="display:none;">
        <h1>شكراً لكم</h1>
        <h2>تم حجز الموعد، وراح نأكده لكم على الواتساب</h2>
        <h3>متحمسين نجيكم!!</h3>
        <div class="filter-button-wrap">
          <button id="rebook" class="filter-button primary">🔁 حجز جديد</button>
        </div>
      </div>

      <!-- Footer -->
      <footer>
        <p>Sponge & Soap</p>
        <a target="_blank" href="https://www.instagram.com/nahl.app?igsh=Y3YyOW05MGI5bnNv&utm_source=qr">Made with Nahl Perfection</a>
      </footer>
    </div>
  </div>

  <!-- Social Speed-Dial -->
  <a href="#" class="social-fab fab-toggle" aria-label="روابط"><i class="fas fa-plus"></i></a>
  <div class="fab-menu" aria-hidden="true">
    <a target="_blank" href="https://www.tiktok.com/@sponge.soap_sa?_t=ZS-8zaj1CA4aJg&_r=1" aria-label="تيك توك"><i class="fab fa-tiktok"></i></a>
    <a target="_blank" href="https://www.instagram.com/sponge.soap_sa?igsh=MWRtOHI5OHZpbWpvdA==" aria-label="انستغرام"><i class="fab fa-instagram"></i></a>
    <a target="_blank" href="https://wa.me/966503668222" aria-label="واتساب"><i class="fab fa-whatsapp"></i></a>
  </div>

  <script>
    // =================== GLOBALS & HELPERS ===================
    const DateTime = luxon.DateTime;
    const defaultLink2 = `https://nahl-platform.vercel.app/api/app/AM/general/${'33e0d05d-d771-46f4-a7e7-7c634b4e3a9e'}/form`;

    // Progress stepper
    function setStep(n){
      document.querySelectorAll('.stepper li').forEach((li,i)=>{
        li.classList.remove('active','done');
        if (i < n-1) li.classList.add('done');
        if (i === n-1) li.classList.add('active');
      });
    }

    // Speed-dial
    document.addEventListener('click', (e)=>{
      const root = document.documentElement;
      if (e.target.closest('.fab-toggle')){
        root.classList.toggle('fab-open');
        e.preventDefault(); return;
      }
      if (!e.target.closest('.fab-menu')) root.classList.remove('fab-open');
    });

    // =================== PHONE INPUT ===================
    const phoneInput = document.querySelector("#mobile");
    const iti = window.intlTelInput(phoneInput, {
      utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/utils.js",
      countryOrder:["sa","qa"],
      initialCountry:"sa",
      onlyCountries:["sa","qa","ae","om","kw","bh"],
      excludeCountries:["il"],
      strictMode:true,
      i18n:{
        ae:"الإمارات العربية المتحدة", bh:"البحرين", kw:"الكويت", sa:"المملكة العربية السعودية",
      },
    });
    const errorMap = ["رقم غير صحيح","رمز دولة غير صحيح","المُدخل أقصر من المتوقع","المُدخل أطول من المتوقع","رقم غير صحيح"];
    function checkNumberValidity() {
      const number = document.getElementById("mobile");
      const phoneNumber = iti.getNumber().substring(1);
      if (isNaN(phoneNumber) || !iti.isValidNumber() || !phoneNumber){
        const msg = errorMap[iti.getValidationError()] || "رقم غير صحيح";
        number.setCustomValidity(msg); return false;
      }
      number.setCustomValidity(""); return true;
    }

    // =================== LOCAL STORAGE (Prefill) ===================
    try {
      document.getElementById("name").value = localStorage.getItem("name") || "";
      if(localStorage.getItem("mobile")){
        iti.setNumber("+"+ localStorage.getItem("mobile"));
      }
    } catch(e){}

    // =================== API WRAPPER ===================
    let controllers = [];
    async function callContent2(routText, callback, abortable = false, retries = 2){
      let signal = '';
      if (abortable) {
        controllers.forEach(([c])=>c.abort()); controllers = [];
        const controller = new AbortController(); signal = controller.signal; controllers.push([controller, signal]);
      }
      await new Promise(r=>setTimeout(r, 400)); // tiny debounce

      fetch(defaultLink2 + `${routText}`, {redirect:"follow", method:"GET", ...(abortable && {signal})})
      .then(async (res)=>{
        if(!res.ok){ if(retries>0){ return callContent2(routText, callback, abortable, retries-1); } throw new Error("Network error");}
        const j = await res.json(); callback(j);
      })
      .catch(err=>{
        if(!String(err.message).includes("aborted")){
          if(retries>0){ setTimeout(()=>callContent2(routText, callback, abortable, retries-1), 1200); }
          else console.log("Error:", err.message);
        }
      });
    }

    // =================== PAGE 2 (Locations + Services) ===================
    document.getElementById("page2-spinner").style.display = "block";
    callContent2(`/locations`, data=>{
      const select = $('#area');
      const options = (data?.data||[]).map(l=>({id: l.id, text: l.TS_location_arabic_name}));
      options.sort((a,b)=> a.id - b.id );
      select.select2({data: options, width: "100%"});
      document.getElementById("page2-spinner").style.display = "none";
      $('#area').trigger('change');
    });

    let services = [], serviceCategories = [];
    $("#area").on("change", ()=>{
      document.getElementById("page3-2-spinner").style.display = "block";
      $('#service').empty();
      callContent2(`/services?location=${document.getElementById("area").value}`, data=>{
        services = data?.data?.services || [];
        serviceCategories = data?.data?.servicesCat || [];

        // Build categories->services map for future use (kept hidden field for compatibility)
        const categoriesWithServices = {};
        services.forEach(s=>{
          const cid = s.TS_category_id;
          if(!categoriesWithServices[cid]){
            categoriesWithServices[cid] = {category: serviceCategories.find(c=>c.TS_category_id===cid), services:[], locations:new Set()};
          }
          categoriesWithServices[cid].services.push(s);
          s.location.forEach(loc=>categoriesWithServices[cid].locations.add(loc));
        });

        // Fill a flattened service list for this location
        const svcSelect = document.getElementById('service');
        const sorted = services.slice().sort((a,b)=> a.TS_service_id - b.TS_service_id);
        sorted.forEach(s=>{
          const opt = document.createElement('option');
          opt.value = s.TS_service_id;
          opt.textContent = s.TS_service_arabic_name || s.TS_service_english_name;
          svcSelect.appendChild(opt);
        });
        document.getElementById("page3-2-spinner").style.display = "none";
        // refresh appointments when service changes
        svcSelect.addEventListener('change', ()=> $('#date').trigger('change'));
        $('#date').trigger('change');
      }, true);
    });

    // =================== PAGE 4 (Date & Times) ===================
    const weekdays = ["الأحد","الإثنين","الثلاثاء","الأربعاء","الخميس","الجمعة","السبت"];
    document.getElementById("date").min = new Date().toLocaleDateString("fr-ca");
    document.getElementById("date").value = DateTime.now().toFormat('yyyy-MM-dd');

    let appointments = [[],[],[]], ActualTimes = [[],[],[]], timesLoaded=false;
    let selectedSlot = null, selectedSlotDate = null;

    function selectSlot(btn,time,date){
      document.querySelectorAll('.time-button').forEach(b=>b.classList.remove('selected'));
      btn.classList.add('selected');
      selectedSlot = time; selectedSlotDate = date;
      document.getElementById('slotBar').style.display = 'flex';
    }

    function timesSetter(index){
      const tc = document.getElementById("time-container"); tc.innerHTML = "";
      if(!appointments[index].length){
        tc.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:16px;">لا توجد مواعيد متاحة</div>`;
        return;
      }
      for (let y=0; y<appointments[index].length; y++){
        const tLabel = appointments[index][y];
        const tValue = ActualTimes[index][y];
        const d = DateTime.fromISO(document.getElementById('date').value).plus({days:index}).toFormat('yyyy-MM-dd');
        const b = document.createElement('button');
        b.className = 'time-button'; b.dir = 'ltr'; b.textContent = tLabel;
        b.onclick = ()=> selectSlot(b, tValue, d);
        tc.appendChild(b);
      }
    }

    document.getElementById('confirmSlot').onclick = ()=>{
      if (!selectedSlot) return;
      const parsedTime = DateTime.fromFormat(selectedSlot, "hh:mm a").toFormat("HH:mm");
      nForm.time = parsedTime; nForm.date = selectedSlotDate;
      // go next page
      document.getElementById("page4").style.display="none";
      document.getElementById("page5").style.display="flex";
      setStep(4);
    };
    document.getElementById('changeSlot').onclick = ()=>{
      selectedSlot = null; selectedSlotDate = null;
      document.getElementById('slotBar').style.display = 'none';
      document.querySelectorAll('.time-button').forEach(b=>b.classList.remove('selected'));
    };

    document.getElementById('date').onchange = ()=>{
      const dateEl = document.getElementById('date');
      dateEl.disabled = true;
      document.getElementById('time-container').innerHTML = `
        <div class="spinner-border" role="status" style="grid-column:1/-1; justify-self:center;"></div>
      `;
      ActualTimes = [[],[],[]]; appointments = [[],[],[]]; timesLoaded = false;

      const d1 = DateTime.fromISO(dateEl.value), d2 = d1.plus({days:1}), d3 = d1.plus({days:2});
      callContent2(`/appointments?startDate=${d1.toFormat('yyyy-MM-dd')}&location=${document.getElementById("area").value}&service=${document.getElementById("service").value}`, (data)=>{
        const recieved = data?.data?.appointments || [];
        const tempActual = [];
        for(let i=0;i<recieved.length;i++){
          const x = DateTime.fromISO(recieved[i]['TS_appointment_date'], { setZone:true });
          const y = DateTime.fromISO(recieved[i]['TS_appointment_time'], { setZone:true });
          recieved[i]['TS_appointment_date'] = x.toISODate();
          recieved[i]['TS_appointment_time'] = y.toLocaleString(DateTime.TIME_SIMPLE).replace(" "," ");
          tempActual[i] = y.toFormat('hh:mm a');
        }
        for(let i=0;i<recieved.length;i++){
          const d = recieved[i]["TS_appointment_date"];
          if (d === d1.toFormat('yyyy-MM-dd')){ appointments[0].push(recieved[i]['TS_appointment_time']); ActualTimes[0].push(tempActual[i]); }
          else if (d === d2.toFormat('yyyy-MM-dd')){ appointments[1].push(recieved[i]['TS_appointment_time']); ActualTimes[1].push(tempActual[i]); }
          else if (d === d3.toFormat('yyyy-MM-dd')){ appointments[2].push(recieved[i]['TS_appointment_time']); ActualTimes[2].push(tempActual[i]); }
        }
        timesLoaded = true;
        timesSetter(0); // render day 1 only to reduce jank
        dateEl.disabled = false;
      }, true);
    };

    // =================== PAGE 5 (Contact/Car/Payment) ===================
    // Car brands quick list
    const carBrands = ["Acura","Alfa Romeo","Aston Martin","Audi","Bentley","BMW","Bugatti","Buick","Cadillac","Chevrolet","Chrysler","Citroën","Dacia","Daewoo","Daihatsu","Dodge","Ferrari","Fiat","Ford","Genesis","GMC","Haval","Holden","Honda","Hummer","Hyundai","Infiniti","Isuzu","Jaguar","Jeep","Kia","Koenigsegg","Lada","Lamborghini","Lancia","Land Rover","Lexus","Lincoln","Lotus","Maserati","Maybach","Mazda","McLaren","Mercedes-Benz","Mercury","MG","Mini","Mitsubishi","Nissan","Opel","Pagani","Peugeot","Plymouth","Pontiac","Porsche","RAM","Renault","Rolls-Royce","Saab","Saturn","Scion","Seat","Skoda","Smart","SsangYong","Subaru","Suzuki","Tata","Tesla","Toyota","Volkswagen","Volvo","Wiesmann","Zotye"].sort();
    const brandSelect = document.getElementById('carBrand');
    brandSelect.innerHTML = `<option value="" disabled selected>🚘 ماركة السيارة</option>` + carBrands.map(b=>`<option value="${b}">${b}</option>`).join("");
    $(brandSelect).select2({placeholder:"اختر الماركة", allowClear:true, width:"100%"});

    function updateLocationDescription(){
      const carBrand = document.getElementById("carBrand").value || "";
      const carName = document.getElementById("carName").value || "";
      const plate = document.getElementById("plateNumber").value || "";
      document.getElementById("locationDescription").value = [carBrand, carName, plate].filter(Boolean).join(", ");
    }
    window.updateLocationDescription = updateLocationDescription;
    document.getElementById('plateNumber').addEventListener('input', function(){
      this.value = this.value.replace(/\D/g, '').slice(0,4);
      this.setCustomValidity('');
      updateLocationDescription();
    });

    // payment selection style
    document.querySelectorAll('.pay-card input[name="payingMethod"]').forEach(r=>{
      r.addEventListener('change', ()=>{
        document.querySelectorAll('.pay-card').forEach(c=>c.classList.remove('selected'));
        r.closest('.pay-card').classList.add('selected');
      });
    });

    // =================== STATE FORM ===================
    var nForm = {
      date:'', time:'', location:'', service:'', serviceCount:'1', serviceCat:'',
      customerM:'', customerN:'', paymentMethod:'', urlLocation:'', locationDescription:''
    };
    document.getElementById('page1-button').onclick = ()=>{
      document.getElementById("page1").style.display="none";
      document.getElementById("page2").style.display="flex";
      setStep(2);
    };

    document.getElementById('page2-button').onclick = ()=>{
      const area = document.getElementById("area");
      if (!area.value){ document.getElementById("page2-form").reportValidity(); return; }
      nForm.location = area.value;
      nForm.service = document.getElementById("service").value;
      document.getElementById("page2").style.display="none";
      document.getElementById("page4").style.display="flex"; // jump to pick time
      setStep(3);
    };

    document.getElementById('page4-return').onclick = ()=>{
      document.getElementById("page4").style.display="none";
      document.getElementById("page2").style.display="flex";
      setStep(2);
    };

    document.getElementById('page5-button').onclick = ()=>{
      const nameEl = document.getElementById("name");
      if(!nameEl.value.trim()){ nameEl.setCustomValidity("يُرجى ملء هذا الحقل"); document.getElementById("page5-form").reportValidity(); return; }
      if(!checkNumberValidity()){ document.getElementById("page5-form").reportValidity(); return; }

      nForm.customerN = nameEl.value.trim();
      nForm.customerM = iti.getNumber().substring(1);
      nForm.paymentMethod = document.querySelector('input[name="payingMethod"]:checked')?.value || '';
      updateLocationDescription();
      nForm.locationDescription = document.getElementById("locationDescription").value;

      document.getElementById("page5").style.display="none";
      document.getElementById("page6").style.display="flex";
      setStep(5);
    };
    document.getElementById('page5-return').onclick = ()=>{
      document.getElementById("page5").style.display="none";
      document.getElementById("page4").style.display="flex";
      setStep(3);
    };

    // =================== MAP & TERMS ===================
    let map, marker, infoWindow, polygon=null, position="", defaultLocation = { lat: 26.34165524787632, lng: 50.11524831545726 };
    const prePosition = "https://www.google.com/maps/search/?api=1&query=";

    function showBanner(msg, type='warn'){
      const id='topBanner';
      let el = document.getElementById(id);
      if(!el){ el = document.createElement('div'); el.id=id; document.getElementById('page6').prepend(el); }
      el.textContent = msg;
      el.style.cssText = `margin:10px 0;padding:10px;border-radius:10px;font-weight:700;
        ${type==='warn' ? 'color:#7a3b00;background:#fff7ed;border:1px solid #fed7aa;' : 'color:#065f46;background:#ecfdf5;border:1px solid #a7f3d0;'}
      `;
    }

    function validateAndSetPosition(latLng){
      if (polygon && !google.maps.geometry.poly.containsLocation(latLng, polygon)) {
        showBanner("⚠️ موقع خارج نطاق الخدمة، اختر موقعاً داخل المنطقة المحددة","warn");
        position = ""; return;
      }
      marker.setPosition(latLng);
      map.panTo(latLng);
      map.setZoom(17);
      position = `${prePosition}${latLng.lat()},${latLng.lng()}`;
      if(!infoWindow) infoWindow = new google.maps.InfoWindow();
      infoWindow.setContent("✅ تم تحديد موقعك هنا");
      infoWindow.open(map, marker);
    }
    window.validateAndSetPosition = validateAndSetPosition;

    function initAutocomplete(){
      if (!window.google?.maps?.places) return;
      const input = document.getElementById('placeSearch');
      const ac = new google.maps.places.Autocomplete(input, { fields:['geometry'] });
      ac.addListener('place_changed', ()=>{
        const p = ac.getPlace();
        if (!p?.geometry?.location) return;
        validateAndSetPosition(p.geometry.location);
      });
    }

    window.myMap = function(){
      try{
        map = new google.maps.Map(document.getElementById("googleMap"), {
          center: defaultLocation, zoom: 12, disableDoubleClickZoom: true,
        });
        infoWindow = new google.maps.InfoWindow();
        marker = new google.maps.Marker({ position: defaultLocation, map, draggable: true, title: "اضغط أو اسحب لتحديد الموقع" });
        marker.addListener("dragend", (e)=> validateAndSetPosition(e.latLng));
        map.addListener("click", (e)=> validateAndSetPosition(e.latLng));

        // simple areas (sample) – change via setBoundries()
        initAutocomplete();
        document.getElementById('mapShell').classList.remove('loading');
      }catch(err){
        document.getElementById('mapShell').classList.remove('loading');
        document.getElementById('mapError').style.display='block';
      }
    };

    // If Google script fails
    window.addEventListener('error', (e)=>{
      if (String(e?.target?.src||'').includes('maps.googleapis.com')){
        document.getElementById('mapShell').classList.remove('loading');
        document.getElementById('mapError').style.display='block';
      }
    }, true);

    function setBoundries(){
      const areaSelect = document.getElementById("area");
      const selectedArea = areaSelect.options[areaSelect.selectedIndex]?.text?.trim();
      let polygonCoords;
      if (selectedArea === "العزيزية"){
        polygonCoords = [
          { lng: 50.215045355428195, lat: 26.219724394350184 },
          { lng: 50.2135291654911,   lat: 26.1870383495685 },
          { lng: 50.137875179099595, lat: 26.069703060741347 },
          { lng: 50.10628808282646,  lat: 26.15001891083389 },
          { lng: 50.143828288837895, lat: 26.21660551929113 },
          { lng: 50.19603263782255,  lat: 26.21897351180097 },
        ];
      } else if (selectedArea === "أجيال - أرامكو"){
        polygonCoords = [
          { lng: 50.06256215323989, lat: 26.275519772515292 },
          { lng: 50.070562455580834, lat: 26.277608292466685 },
          { lng: 50.08514528516432,  lat: 26.257720425641132 },
          { lng: 50.06822454797902,  lat: 26.24524748257814 },
          { lng: 50.06115405632103,  lat: 26.262628935642045 },
          { lng: 50.05894452767791,  lat: 26.267950423932856 },
        ];
      } else if (selectedArea === "الدوحة و الدانة"){
        polygonCoords = [
          { lng: 50.11488540829821, lat: 26.341056543806932 },
          { lng: 50.136645122501264, lat: 26.353671078060277 },
          { lng: 50.14577577434936,  lat: 26.363004767230812 },
          { lng: 50.178697561294584, lat: 26.3329268498157454 },
          { lng: 50.17972636713662,  lat: 26.31448441448552 },
          { lng: 50.16468008169681,  lat: 26.29799900302895 },
        ];
      } else { polygonCoords = null; }

      if (polygon) polygon.setMap(null);
      if (polygonCoords){
        polygon = new google.maps.Polygon({
          paths: polygonCoords, strokeColor: "#ff0000", strokeOpacity: 0.35, strokeWeight: 2,
          fillColor: "#00ff00", fillOpacity: 0.08,
        });
        polygon.setMap(map);
      }
    }
    window.setBoundries = setBoundries;

    function detectMyLocation(){
      if (navigator.geolocation){
        navigator.geolocation.getCurrentPosition((pos)=>{
          const userPos = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
          if (polygon && !google.maps.geometry.poly.containsLocation(userPos, polygon)){
            showBanner("⚠️ عذرًا، موقعك خارج نطاق الخدمة","warn"); return;
          }
          validateAndSetPosition(userPos);
        }, ()=> handleLocationError(true));
      } else { handleLocationError(false); }
    }
    function handleLocationError(browserHasGeolocation){
      if(!infoWindow) infoWindow = new google.maps.InfoWindow();
      infoWindow.setPosition(map.getCenter());
      infoWindow.setContent(browserHasGeolocation ? "⚠️ تعذر الحصول على موقعك. يرجى السماح بالوصول للموقع." : "⚠️ جهازك لا يدعم تحديد الموقع.");
      infoWindow.open(map);
    }
    document.getElementById("show-my-location").addEventListener("click", detectMyLocation);
    $("#area").on("change", ()=> setBoundries());

    // Terms & Reserve flow
    document.getElementById('page6-button').onclick = ()=>{
      if (!position){
        showBanner("⚠️ الرجاء تحديد الموقع على الخريطة أولاً","warn"); return;
      }
      const modal = new bootstrap.Modal(document.getElementById('termsModal'));
      const cb = document.getElementById('termsAccept');
      const btn = document.getElementById('confirmTerms');
      cb.checked=false; btn.disabled=true;
      cb.onchange = ()=> btn.disabled = !cb.checked;
      modal.show();

      btn.onclick = ()=>{
        modal.hide();
        // Submit reservation
        document.getElementById("page6-spinner").style.display = "flex";
        const payload = {...nForm, urlLocation: position};
        fetch(defaultLink2 + `/reserveAppointment`, { method:'POST', body: JSON.stringify(payload) })
          .then(async (res)=>{
            document.getElementById("page6-spinner").style.display = "none";
            if(!res.ok){ const j = await res.json().catch(()=>({})); throw j; }
            // success
            // remember?
            if(confirm("ودك نتذكر بياناتك على هذا الجهاز لمرات قادمة؟")){
              localStorage.setItem("name", payload.customerN);
              localStorage.setItem("mobile", payload.customerM);
            } else{
              localStorage.removeItem("name"); localStorage.removeItem("mobile");
            }
            document.getElementById("page6").style.display="none";
            document.getElementById("page7").style.display="flex";
            setStep(6);
          })
          .catch(err=>{
            const msgAR = err?.msgAR || "عذرًا حصل خطأ غير متوقع الرجاء التواصل معنا";
            const fail = document.getElementById("fail-alert-3");
            document.getElementById("page6-spinner").style.display = "none";
            document.getElementById("page6").style.display="none";
            document.getElementById("page4").style.display="flex";
            fail.style.display = "block";
            fail.children[0].textContent = msgAR;
            $('#date').trigger('change');
            setStep(3);
          });
      };
    };
    document.getElementById('page6-return').onclick = ()=>{
      document.getElementById("page6").style.display="none";
      document.getElementById("page5").style.display="flex";
      setStep(4);
    };

    // Rebook
    document.getElementById("rebook").addEventListener("click", function () {
      window.location.href = "https://www.spongnsoap.com/";
    });

    // Prevent form default submit
    function handleSubmit(e){ e.preventDefault(); }
    window.handleSubmit = handleSubmit;
  </script>

  <!-- Google Maps (include places + geometry) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBBHLoO038vsCovHN-SLUgAXqexlA2v0_4&callback=myMap&libraries=geometry,places" async defer></script>
</body>
</html>
