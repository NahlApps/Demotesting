<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>نحل — حجوزات المواعيد</title>

  <!-- Icons/Fonts -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800&display=swap" rel="stylesheet"/>

  <!-- Light libs (keep minimal) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/css/intlTelInput.css" rel="stylesheet"/>

  <style>
    /* =========================
       Theme + Layout
       ========================= */
    :root{
      --brand-700:#01657A; --brand-600:#027A93; --brand-200:#BFE6F0; --brand-050:#F0FAFC;
      --ink-900:#0B2630; --surface:#ffffff; --border:#E6EDF2; --muted:#6b7280;
      --sale-red:#9f1f1f; --price-red:#b91c1c;
      --radius:16px; --radius-lg:20px; --shadow:0 10px 28px rgba(11,38,48,.14);
      --header-h:72px; --footer-h:118px;
      --page-bg:url("https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/NahlTimeProFrom/NahlDemoBG2.jpg");
    }

    html,body{height:100%}
    body{
      margin:0; font-family:'Cairo',sans-serif; color:#fff;
      background-color:#0B2630;
      background-image:linear-gradient(180deg, rgba(11,38,48,.58), rgba(11,38,48,.34)), var(--page-bg);
      background-position:center,center; background-size:cover,cover;
      min-height:100vh; min-height:100dvh; display:flex; flex-direction:column;
      padding-top:var(--header-h); padding-bottom:var(--footer-h);
    }
    @media (pointer:fine){ body{ background-attachment: scroll, fixed; } }

    header{ position:fixed; inset:0 0 auto 0; z-index:1000;
      background:rgba(11,38,48,.36); backdrop-filter:blur(10px);
      border-bottom:1px solid rgba(255,255,255,.15);}
    .header-inner{ max-width:1120px; margin:0 auto; padding:10px 12px; display:flex; align-items:center; gap:12px; justify-content:space-between; }
    .brand img{ height:64px; width:auto; filter:drop-shadow(0 6px 20px rgba(0,0,0,.25)); }

    main{ flex:1 0 auto; display:flex; justify-content:center; padding:8px 12px 0; }
    #app{width:100%; max-width:1120px}
    .page{ display:none; flex-direction:column; align-items:center; gap:16px; padding:18px 10px 24px; }
    .page.active{ display:flex; animation:fade .35s ease }
    @keyframes fade{ from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:translateY(0)} }

    /* Toasts */
    #toastWrap{ position:fixed; top:10px; left:50%; transform:translateX(-50%); z-index:1050; display:flex; flex-direction:column; gap:8px }
    .toast-item{ min-width:260px; color:#fff; padding:10px 14px; border-radius:12px; box-shadow:var(--shadow) }

    /* Card container */
    .card-pane{ background:rgba(255,255,255,.92); color:#0B2630; border-radius:var(--radius); box-shadow:var(--shadow); padding:18px; width:100%; max-width:980px; }

    /* Tabs */
    #srvTabs{ display:flex; gap:8px; overflow:auto; -webkit-overflow-scrolling:touch; }
    .srv-tab{ border:1px solid var(--border); border-radius:999px; padding:8px 12px; background:#fff; font-weight:800; white-space:nowrap; cursor:pointer }
    .srv-tab[aria-selected="true"]{ background:var(--brand-600); color:#fff; border-color:var(--brand-600) }

    /* === Grid like screenshot (2-up mobile, 3-up desktop) === */
    #srvCards{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:14px; margin-top:12px }
    @media(min-width:960px){ #srvCards{ grid-template-columns:repeat(3,minmax(0,1fr)) } }

    /* === Product Card === */
    .srv-card{ border:1px solid var(--border); border-radius:16px; overflow:hidden; background:#fff; color:#0B2630; box-shadow:0 6px 18px rgba(11,38,48,.10); }
    .srv-card:hover{ box-shadow:var(--shadow) }

    .srv-thumb{ position:relative; height:180px; background:#f5f7f8 center/cover no-repeat }
    .srv-ribbon{ position:absolute; top:10px; right:10px; background:var(--sale-red); color:#fff; font-weight:800; font-size:.8rem; padding:6px 10px; border-radius:12px }
    .srv-wish{ position:absolute; top:10px; left:10px; width:36px; height:36px; border-radius:50%; background:#fff; border:1px solid var(--border); display:flex; align-items:center; justify-content:center; cursor:pointer }
    .srv-wish i{ color:#b4bdc3 }
    .srv-wish[aria-pressed="true"] i{ color:var(--sale-red) }

    .srv-body{ padding:14px 14px 16px }
    .srv-title{ font-weight:800; font-size:1rem; margin:0 0 6px }
    .srv-price{ display:flex; gap:10px; align-items:baseline; margin:2px 0 8px }
    .srv-price .new{ color:var(--price-red); font-weight:800 }
    .srv-price .old{ color:#64748b; text-decoration:line-through }
    .srv-rating{ display:flex; align-items:center; gap:6px; color:#64748b; font-size:.9rem; margin-bottom:10px }
    .srv-rating i{ color:#f59e0b }
    .srv-desc{ color:#365563; font-size:.9rem }
    .clamp{ display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden }

    .add-cart-btn{ width:100%; min-height:44px; border-radius:14px; font-weight:800; border:2px solid var(--sale-red); color:var(--sale-red); background:#fff; display:flex; align-items:center; justify-content:center; gap:8px }
    .add-cart-btn.danger{ border-color:#334155; color:#334155 }

    /* Form controls */
    .form-control, select, .select2-selection{
      background:#fff; color:#0B2630; border:1px solid var(--border)!important; border-radius:14px!important;
      min-height:48px; text-align:center; font-size:16px;
    }
    .field-error{display:none; color:#dc2626; font-size:.85rem; margin-top:6px;}
    .field-error[data-show="true"]{display:block}

    /* Time grid */
    .time-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(110px,1fr)); gap:10px; }
    .time-option { border:1px solid var(--border); background:#fff; color:#0B2630; border-radius:12px; min-height:44px; padding:10px 12px; font-weight:800; cursor:pointer }
    .time-option[aria-checked="true"] { outline:3px solid var(--brand-600); outline-offset:2px; background:var(--brand-050) }

    /* Footer sticky cart */
    .sticky-nav{ position:fixed; inset:auto 0 0 0; background:rgba(11,38,48,.36); backdrop-filter:blur(8px); border-top:1px solid rgba(255,255,255,.15)}
    .footer-inner{ max-width:1120px; margin:0 auto; padding:10px 12px; display:grid; grid-template-columns:1fr auto; align-items:center; gap:10px; color:#fff }
    .footer-cart{ background:rgba(255,255,255,.92); color:#0B2630; border:1px solid var(--border); border-radius:12px; padding:10px 12px; box-shadow:0 6px 18px rgba(11,38,48,.10) }
    .btn-footer{ min-height:48px; border-radius:12px; padding:10px 16px; font-weight:800; background:#fff; color:var(--brand-600); border:1px solid var(--border) }
    .btn-footer.primary{ background:var(--brand-600); color:#fff; border-color:var(--brand-600) }
    .btn-footer.disabled, .btn-footer:disabled{ opacity:.6; pointer-events:none }

    /* Modal (add-ons) */
    .modal-wrap{ position:fixed; inset:0; display:none; z-index:1200 }
    .modal-wrap[aria-hidden="false"]{ display:block }
    .modal-backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.45); backdrop-filter:blur(2px) }
    .modal-sheet{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:min(92vw,520px); background:#fff; color:#0B2630; border-radius:18px; box-shadow:0 20px 60px rgba(11,38,48,.28); padding:16px }
    .addon-chip{ display:inline-flex; align-items:center; gap:8px; border:1px solid var(--border); background:#fff; border-radius:999px; padding:8px 12px; min-height:40px; cursor:pointer }
    .addon-chip[aria-pressed="true"]{ background:var(--brand-050); outline:2px solid var(--brand-600); outline-offset:2px }

    @media (max-width:640px){
      .srv-thumb{ height:160px }
      .modal-sheet{ width:96vw }
    }
  </style>
</head>

<body>
  <!-- Toasts -->
  <div id="toastWrap" aria-live="assertive" aria-atomic="true"></div>

  <!-- Header -->
  <header>
    <div class="header-inner">
      <div class="brand">
        <img id="brandLogo" alt="Nahl Time"
             src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Nahl%20Time%20Logo%20Design/NahlTime%20Logo%20Design%20(2).png"
             decoding="async"/>
      </div>
      <div class="mini-progress d-flex align-items-center gap-2">
        <div class="bar" style="flex:1; height:8px; background:rgba(255,255,255,.25); border-radius:999px"><span id="miniBarFill" style="display:block;height:100%;width:0%;background:linear-gradient(90deg, var(--brand-600), var(--brand-200));border-radius:999px"></span></div>
        <div id="miniStepTitle">الخدمة</div>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main>
    <div id="app">
      <!-- PAGE: Services -->
      <section id="pageServices" class="page active" aria-label="الخدمة">
        <h1 class="text-white">اختر خدمتك</h1>

        <div class="card-pane">
          <!-- Legacy selects for logic; tabs/cards for UX -->
          <div class="row g-3 mb-2">
            <div class="col-12 col-md-4">
              <label class="form-label" for="area">اختيار المنطقة</label>
              <select id="area" style="width:100%"></select>
              <div class="field-error" id="err-area">يرجى اختيار المنطقة</div>
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label" for="serviceCat">التصنيف</label>
              <select id="serviceCat" style="width:100%"></select>
              <div class="field-error" id="err-serviceCat">يرجى اختيار التصنيف</div>
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label" for="service">الخدمة</label>
              <select id="service" style="width:100%"></select>
              <div class="field-error" id="err-service">يرجى اختيار الخدمة</div>
            </div>
          </div>

          <!-- Tabs + Cards -->
          <div id="srvTabs" role="tablist" aria-label="التصنيفات"></div>
          <div id="srvCards" role="list" aria-label="الخدمات"></div>

          <!-- Loading -->
          <div id="servicesLoading" class="text-center py-3" style="display:none">
            <div class="spinner-border text-info" role="status" aria-hidden="true"></div>
            <div class="mt-2">جاري تحميل الخدمات…</div>
          </div>
        </div>
      </section>

      <!-- PAGE: Time -->
      <section id="pageTime" class="page" aria-label="الوقت">
        <h1 class="text-white">متى تحب نجيك؟</h1>
        <div class="card-pane">
          <div class="row g-3">
            <div class="col-12 col-md-5">
              <label class="form-label" for="date">التاريخ</label>
              <input id="date" type="date" class="form-control"/>
              <div class="field-error" id="err-date">يرجى اختيار تاريخ صحيح</div>
            </div>
            <div class="col-12 col-md-7">
              <label class="form-label" for="timeFilter">فلترة الوقت</label>
              <select id="timeFilter" class="form-select">
                <option value="all" selected>كل الأوقات</option>
                <option value="morning">الصباح (06:00–11:00)</option>
                <option value="afternoon">الظهيرة (11:00–16:00)</option>
                <option value="evening">المساء (16:00–21:00)</option>
                <option value="night">ليلًا (21:00–23:59)</option>
              </select>
            </div>
          </div>

          <div class="position-relative mt-3">
            <div id="time-container" class="time-grid" role="radiogroup" aria-label="اختيار الوقت"></div>
            <div id="timeLoading" class="load-overlay" style="display:none">
              <div class="spinner-border text-info" role="status" aria-hidden="true"></div>
              <strong>جاري جلب المواعيد…</strong>
            </div>
          </div>
        </div>
      </section>

      <!-- PAGE: Contact -->
      <section id="pageContact" class="page" aria-label="البيانات">
        <h1 class="text-white">معلومات الاتصال</h1>
        <div class="card-pane">
          <div class="row g-3">
            <div class="col-12 col-md-6">
              <label class="form-label" for="name">الاسم</label>
              <input id="name" type="text" class="form-control" placeholder="الاسم كما سيظهر في الفاتورة" autocomplete="name"/>
              <div class="field-error" id="err-name">يرجى إدخال الاسم</div>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label" for="mobile">رقم الجوال</label>
              <input id="mobile" type="tel" class="form-control" placeholder="5XXXXXXXX"/>
              <div class="field-error" id="err-mobile">يفضل إدخال رقم صحيح لتأكيد الحجز</div>
            </div>
          </div>
        </div>
      </section>

      <!-- PAGE: Pay -->
      <section id="pagePay" class="page" aria-label="الدفع">
        <h1 class="text-white">طريقة الدفع</h1>
        <div class="card-pane">
          <div class="pay-grid" role="radiogroup" aria-label="طريقة الدفع" id="payGroup" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px">
            <label class="pay-card" tabindex="0" role="radio" aria-checked="false" style="display:flex;align-items:center;justify-content:center;gap:8px;min-height:64px;border:1px solid var(--border);border-radius:14px;background:#fff">
              <input type="radio" name="payingMethod" value="stc pay" class="visually-hidden"/>
              <img src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/STC%20PAY%20LOGO.png" alt="STC Pay" style="max-height:28px">
            </label>
            <label class="pay-card" tabindex="-1" role="radio" aria-checked="false" style="display:flex;align-items:center;justify-content:center;gap:8px;min-height:64px;border:1px solid var(--border);border-radius:14px;background:#fff">
              <input type="radio" name="payingMethod" value="cash" class="visually-hidden"/>
              <strong>كاش</strong>
            </label>
            <label class="pay-card" tabindex="-1" role="radio" aria-checked="false" style="grid-column:1/-1;display:flex;align-items:center;justify-content:center;gap:8px;min-height:64px;border:1px solid var(--border);border-radius:14px;background:#fff">
              <input type="radio" name="payingMethod" value="mada" class="visually-hidden"/>
              <img src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/MADA%20LOGO.png" alt="Mada" style="max-height:28px">
            </label>
          </div>
          <div class="field-error" id="err-pay" style="text-align:center">يرجى اختيار طريقة الدفع</div>
          <small class="d-block text-center text-muted mt-2">مدفوعات آمنة — لا رسوم خفية</small>
        </div>
      </section>

      <!-- PAGE: Map -->
      <section id="pageMap" class="page" aria-label="الموقع">
        <h1 class="text-white">الموقع على خريطة قوقل</h1>
        <div class="card-pane">
          <div class="map-search position-relative">
            <input id="mapSearch" class="form-control" type="text" placeholder="ابحث داخل السعودية"/>
            <i class="fa-solid fa-magnifying-glass" style="position:absolute;left:14px;top:50%;transform:translateY(-50%);color:#405a66"></i>
          </div>
          <div id="googleMap" style="width:100%;min-height:360px;border-radius:14px;border:1px solid var(--border);margin-top:10px"></div>
          <div class="text-center mt-2">
            <button id="show-my-location" class="btn btn-outline-primary" type="button">إظهار موقعي</button>
          </div>
          <div class="field-error" id="err-map" style="text-align:center">الرجاء تحديد الموقع على الخريطة</div>
        </div>
      </section>

      <!-- PAGE: Done -->
      <section id="pageDone" class="page" aria-label="تم">
        <h1 class="text-white">شكراً لكم 🌟</h1>
        <div class="card-pane text-center" style="max-width:720px">
          <p class="mb-3" style="color:#224652">تم استلام طلبكم، وسنؤكد الموعد على واتساب قريبًا.</p>
          <div class="text-start mx-auto" style="max-width:520px">
            <div class="d-flex justify-content-between py-2 border-bottom"><span>المنطقة</span><strong id="ts-area">—</strong></div>
            <div class="d-flex justify-content-between py-2 border-bottom"><span>الخدمة</span><strong id="ts-service">—</strong></div>
            <div class="d-flex justify-content-between py-2 border-bottom"><span>الموعد</span><strong id="ts-dt">—</strong></div>
            <div class="d-flex justify-content-between py-2"><span>طريقة الدفع</span><strong id="ts-pay">—</strong></div>
          </div>
          <div class="d-flex gap-2 justify-content-center mt-3 flex-wrap">
            <a id="ts-whatsapp" class="btn btn-success" target="_blank" rel="noopener"><i class="fa-brands fa-whatsapp"></i> مشاركة عبر واتساب</a>
            <button id="rebook" class="btn btn-primary" type="button" style="min-height:52px;font-weight:800;border-radius:12px;padding:12px 18px">🔁 احجز نفس الخدمة</button>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- Footer: mini-cart + next/prev -->
  <footer class="sticky-nav">
    <div class="footer-inner">
      <div id="footer-cart" class="footer-cart" aria-live="polite">
        <div class="d-flex justify-content-between fw-bold">
          <span id="fc-title">السلة — لم يتم اختيار خدمة</span>
          <span id="fc-total">—</span>
        </div>
        <div class="text-muted" id="fc-sub">اختر خدمة ثم أكمل الخطوات</div>
      </div>

      <div class="footer-actions d-flex align-items-center gap-2">
        <button id="footer-prev" type="button" class="btn-footer">السابق</button>
        <button id="footer-next" type="button" class="btn-footer primary disabled" disabled>التالي</button>
        <div id="footer-wait" class="d-none align-items-center gap-2">
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          <span>يتم إرسال الطلب…</span>
        </div>
      </div>
    </div>
  </footer>

  <!-- Add-ons Modal (the ONLY place add-ons appear) -->
  <div id="addonModal" class="modal-wrap" aria-hidden="true">
    <div class="modal-backdrop" data-close="1"></div>
    <div class="modal-sheet" role="dialog" aria-modal="true" aria-labelledby="addonTitle">
      <h3 id="addonTitle" class="m-0 fw-bold" style="color:#224652"><i class="fa-solid fa-plus"></i> اختر خدمات إضافية (اختياري)</h3>
      <div id="addonList" class="mt-2" style="display:flex; flex-wrap:wrap; gap:8px; max-height:56vh; overflow:auto"></div>
      <div class="d-flex gap-2 justify-content-between mt-3">
        <button type="button" id="addonCancel" class="btn btn-light" style="min-height:44px;border-radius:10px; border:1px solid var(--border)">لا شكرًا</button>
        <button type="button" id="addonApply" class="btn btn-primary" style="min-height:44px;border-radius:10px;background:var(--brand-600);border:1px solid var(--brand-600)">تأكيد الإضافات</button>
      </div>
    </div>
  </div>

  <!-- libs -->
  <script src="https://code.jquery.com/jquery-3.6.3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/intlTelInputWithUtils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  (function(){
    "use strict";

    /* ---------- CONFIG ---------- */
    const APP_ID='21eddbf5-efe5-4a5d-9134-b581717b17ff';
    // TODO: replace with your deployed web app URL
    const GAS_BASE_URL='https://script.google.com/macros/s/AKfycbwS_M7E6AbdpSq1NTzCheQGcqb7q_imLKrMINu_E3ulAactmJNARCG10dYKb4s80IOD/exec';

    /* ---------- SMALL UTILS ---------- */
    const DateTime=luxon.DateTime;
    const $ = window.jQuery;
    function escapeHTML(s){ return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[m])); }
    function showToast(type='info', msg=''){
      const wrap=document.getElementById('toastWrap');
      const div=document.createElement('div');
      div.className='toast-item';
      div.style.background= type==='error' ? '#dc2626' : type==='success' ? '#16a34a' : '#0284c7';
      div.textContent=msg; wrap.appendChild(div);
      setTimeout(()=>{ div.style.opacity='0'; div.style.transform='translateY(-6px)'; setTimeout(()=>div.remove(), 180); }, 2400);
    }
    function currency(n){ try{ return new Intl.NumberFormat('ar-SA',{style:'currency',currency:'SAR'}).format(n); }catch(_){ return n+' ر.س'; } }
    function parsePrice(val){ const n = Number(String(val).replace(/[^\d.]/g,'')); return Number.isFinite(n)?n:NaN; }

    /* ---------- STATE ---------- */
    let servicesCache=[], categoriesCache=[];
    let activeCatId=null, selectedServiceId=null;
    let itiPhone=null;
    let dayTimes=[], selectedTime=null, currentTimeFilter='all', lastSelectedISO='';
    const nForm={date:'',time:'',location:'',service:'',serviceCount:'1',serviceCat:'',customerM:'',customerN:'',paymentMethod:'',urlLocation:'',locationDescription:'', addons:[], locale:'ar'};

    /* ---------- RENDER HELPERS ---------- */
    function updateFooterCartSummary(){
      const titleEl=document.getElementById('fc-title');
      const totalEl=document.getElementById('fc-total');
      const subEl=document.getElementById('fc-sub');
      const qty=Number(document.getElementById('serviceCount')?.value||1); // kept for compatibility
      const svc = servicesCache.find(s=> String(s.TS_service_id)===String(selectedServiceId));

      if(!svc){
        titleEl.textContent='السلة — لم يتم اختيار خدمة';
        totalEl.textContent='—';
        subEl.textContent='اختر خدمة ثم أكمل الخطوات';
        return;
      }
      const title=svc.TS_service_arabic_name || ('خدمة '+selectedServiceId);
      const price=parsePrice(svc.TS_price);
      titleEl.textContent=title;
      totalEl.textContent= Number.isFinite(price) ? currency(price*qty) : '—';
      const addonsTxt=(nForm.addons.length?(' • إضافات: '+nForm.addons.join('، ')):'');
      subEl.textContent='الكمية × '+qty+addonsTxt;
    }
    function setProgress(stepIndex){
      const steps=['الخدمة','الوقت','البيانات','الدفع','الموقع','تم'];
      const pct=((stepIndex+1)/steps.length)*100;
      document.getElementById('miniBarFill').style.width=pct+'%';
      document.getElementById('miniStepTitle').textContent=steps[stepIndex]||steps.at(-1);
    }
    function showPage(id){
      document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      const idx=['pageServices','pageTime','pageContact','pagePay','pageMap','pageDone'].indexOf(id);
      setProgress(Math.max(0,idx));
      updateNextAvailability();
    }
    function updateNextAvailability(){
      const active=document.querySelector('.page.active')?.id;
      const nextBtn=document.getElementById('footer-next');
      let enable=false;
      if(active==='pageServices') enable=!!(document.getElementById('service').value);
      if(active==='pageTime') enable=!!selectedTime;
      if(active==='pageContact'){ enable = (document.getElementById('name').value||'').trim().length>0; }
      if(active==='pagePay') enable=!!(nForm.paymentMethod);
      if(active==='pageMap') enable=!!(nForm.urlLocation);
      nextBtn.disabled=!enable; nextBtn.classList.toggle('disabled',!enable);
    }

    /* ---------- GAS FETCHERS ---------- */
    async function gasGet(paramsObj, timeoutMs=10000){
      const url = GAS_BASE_URL + '?' + new URLSearchParams(paramsObj).toString();
      const controller=new AbortController();
      const t=setTimeout(()=>controller.abort(), timeoutMs);
      try{
        const res=await fetch(url,{method:'GET',mode:'cors',cache:'no-store',headers:{'Accept':'application/json'},signal:controller.signal});
        const data=await res.json().catch(()=>null);
        clearTimeout(t);
        return {ok:res.ok, data};
      }catch(e){ clearTimeout(t); return {ok:false, error:String(e)}; }
    }

    /* ---------- SERVICES UI ---------- */
    function buildBadges(s){
      const badges=[]; const txt=String(s.TS_badges||'');
      if(txt){ txt.split(',').map(b=>b.trim()).filter(Boolean).forEach(b=>badges.push(b)); }
      return badges;
    }
    function serviceCardTemplate(s, selected){
      const id=String(s.TS_service_id);
      const title=s.TS_service_arabic_name || ('خدمة '+id);
      const thumb=s.TS_thumb_url || '';
      const desc=(s.TS_short_desc || '').toString().trim();

      const priceNew=(s.TS_price?String(s.TS_price):'').trim();
      let priceOld='';
      const m=/\bold[:=]\s*([\d.]+)/i.exec(String(s.TS_badges||'')); if(m){ priceOld=m[1]+' ر.س'; }

      let ribbon='';
      const btxt=String(s.TS_badges||'');
      const rMatch=btxt.match(/(عرض[^,]{0,8}|خصم\s*\d+%|اليوم الوطني)/);
      if(rMatch){ ribbon=rMatch[0]; }
      else if(String(s.TS_popular||'').toLowerCase()==='true'){ ribbon='الأكثر طلبًا'; }

      return `
        <div class="srv-card" role="listitem" aria-selected="${selected?'true':'false'}" data-id="${id}">
          <div class="srv-thumb" style="${thumb?`background-image:url('${thumb}')`:''}">
            ${ribbon?`<div class="srv-ribbon">${escapeHTML(ribbon)}</div>`:''}
            <button type="button" class="srv-wish" aria-pressed="false" title="مفضلة"><i class="fa-regular fa-heart"></i></button>
          </div>
          <div class="srv-body">
            <h3 class="srv-title">${escapeHTML(title)}</h3>
            <div class="srv-price">
              ${priceOld?`<span class="old">${escapeHTML(priceOld)}</span>`:''}
              ${priceNew?`<span class="new">${escapeHTML(priceNew)}</span>`:''}
            </div>
            <div class="srv-rating"><i class="fa-solid fa-star"></i><span>5</span></div>
            ${desc?`<div class="srv-desc clamp">${escapeHTML(desc)}</div>`:''}
            ${selected
              ? '<button class="btn-remove add-cart-btn danger" type="button">إزالة من السلة</button>'
              : '<button class="btn-add add-cart-btn" type="button">إضافة للسلة <i class="fa-solid fa-lock"></i></button>'}
          </div>
        </div>`;
    }
    function renderCategoryTabs(cats){
      const wrap=document.getElementById('srvTabs'); wrap.innerHTML='';
      if(!cats.length){ wrap.textContent='لا توجد تصنيفات'; return; }
      cats.forEach(c=>{
        const b=document.createElement('button');
        b.className='srv-tab'; b.type='button'; b.setAttribute('role','tab');
        b.dataset.id=c.TS_category_id;
        b.textContent=c.TS_category_arabic_name || ('تصنيف '+c.TS_category_id);
        b.setAttribute('aria-selected', String(c.TS_category_id)===String(activeCatId));
        b.onclick=()=>{ activeCatId=String(c.TS_category_id); renderCategoryTabs(cats); renderServiceCards(); };
        wrap.appendChild(b);
      });
    }
    function renderServiceCards(){
      const grid=document.getElementById('srvCards'); grid.innerHTML='';
      const list=servicesCache.filter(s=> String(s.TS_category_id)===String(activeCatId));
      if(!list.length){ grid.innerHTML='<div class="text-muted">لا توجد خدمات ضمن هذا التصنيف</div>'; return; }
      grid.innerHTML=list.map(s=>serviceCardTemplate(s, String(selectedServiceId)===String(s.TS_service_id))).join('');
      grid.querySelectorAll('.srv-card').forEach(card=>{
        const id=card.dataset.id;
        const addBtn=card.querySelector('.btn-add');
        const rmBtn=card.querySelector('.btn-remove');
        const wish=card.querySelector('.srv-wish');

        addBtn && addBtn.addEventListener('click', ()=>{
          selectedServiceId=id;
          $('#serviceCat').val(activeCatId).trigger('change.select2');
          $('#service').val(id).trigger('change.select2');
          nForm.serviceCat=String(activeCatId);
          nForm.service=String(id);
          renderServiceCards(); updateFooterCartSummary(); updateNextAvailability();
          openAddonModal();
        });

        rmBtn && rmBtn.addEventListener('click', ()=>{
          if(selectedServiceId===id){
            selectedServiceId=null; nForm.service='';
            $('#service').val(null).trigger('change.select2');
            renderServiceCards(); updateFooterCartSummary(); updateNextAvailability();
          }
        });

        wish && wish.addEventListener('click', ()=>{
          const on = wish.getAttribute('aria-pressed')==='true';
          wish.setAttribute('aria-pressed', on?'false':'true');
          const i=wish.querySelector('i'); if(i){ i.classList.toggle('fa-regular', on); i.classList.toggle('fa-solid', !on); }
        });
      });
    }

    /* ---------- Add-ons Modal ---------- */
    function openAddonModal(){
      const modal=document.getElementById('addonModal');
      const list=document.getElementById('addonList');
      list.innerHTML='<span class="text-muted">...تحميل</span>';
      modal.setAttribute('aria-hidden','false');

      gasGet({route:'additionalServices', appId:APP_ID}).then(res=>{
        const arr = (res.ok && res.data && res.data.success && Array.isArray(res.data.data)) ? res.data.data : [];
        if(!arr.length){ list.innerHTML='<span class="text-muted">لا توجد خدمات إضافية</span>'; return; }
        list.innerHTML='';
        arr.forEach(x=>{
          const label=String(x.label||'').trim(); if(!label) return;
          const b=document.createElement('button');
          b.type='button'; b.className='addon-chip'; b.setAttribute('aria-pressed', nForm.addons.includes(label)?'true':'false');
          b.textContent=label;
          b.onclick=()=>{ const on=b.getAttribute('aria-pressed')==='true'; b.setAttribute('aria-pressed', on?'false':'true'); };
          list.appendChild(b);
        });
      });

      document.getElementById('addonApply').onclick=()=>{
        const chosen=[...list.querySelectorAll('.addon-chip[aria-pressed="true"]')].map(x=>x.textContent.trim());
        nForm.addons=chosen; updateFooterCartSummary(); modal.setAttribute('aria-hidden','true');
      };
      const close=()=> modal.setAttribute('aria-hidden','true');
      document.getElementById('addonCancel').onclick=close;
      modal.querySelector('.modal-backdrop').onclick=close;
      document.addEventListener('keydown', function esc(e){ if(e.key==='Escape'){ close(); document.removeEventListener('keydown',esc); }});
    }

    /* ---------- Times ---------- */
    function timeInMins(h,m){ return h*60+m }
    function passesFilter(mins){
      if(currentTimeFilter==='all') return true;
      if(currentTimeFilter==='morning')   return mins>=timeInMins(6,0) && mins<timeInMins(11,0);
      if(currentTimeFilter==='afternoon') return mins>=timeInMins(11,0)&& mins<timeInMins(16,0);
      if(currentTimeFilter==='evening')   return mins>=timeInMins(16,0)&& mins<timeInMins(21,0);
      if(currentTimeFilter==='night')     return mins>=timeInMins(21,0)&& mins<timeInMins(24,0);
      return true;
    }
    function renderSelectedDateTimes(selectedISO){
      const wrap=document.getElementById('time-container'); wrap.innerHTML='';
      const view = dayTimes.filter(x=>passesFilter(x.mins)).sort((a,b)=>a.mins-b.mins);
      if(!view.length){ wrap.innerHTML='<div class="text-muted" style="grid-column:1/-1;justify-self:center">لا توجد مواعيد ضمن الفلتر</div>'; return; }
      view.forEach(t=>{
        const btn=document.createElement('button');
        btn.type='button'; btn.className='time-option'; btn.setAttribute('role','radio'); btn.setAttribute('aria-checked','false'); btn.setAttribute('dir','ltr');
        btn.textContent=t.label;
        btn.onclick=()=>{
          [...wrap.children].forEach(el=>el.setAttribute('aria-checked','false'));
          btn.setAttribute('aria-checked','true');
          nForm.date=selectedISO; nForm.time=t.h.toString().padStart(2,'0')+':'+t.m.toString().padStart(2,'0');
          selectedTime={ui:t.label,iso:nForm.time}; updateNextAvailability();
        };
        wrap.appendChild(btn);
      });
      // preselect earliest
      wrap.querySelector('button')?.click();
    }
    async function fetchTimes(){
      const dateEl=document.getElementById('date');
      const selectedISO=(dateEl.value||DateTime.now().toFormat('yyyy-LL-dd')).trim();
      lastSelectedISO=selectedISO;
      const loc=$('#area').val()||''; const srv=$('#service').val()||'';
      const wrap=document.getElementById('time-container');

      if(!loc||!srv){ wrap.innerHTML='<div class="text-muted" style="grid-column:1/-1;justify-self:center">اختر المنطقة والخدمة لعرض المواعيد</div>'; selectedTime=null; updateNextAvailability(); return; }

      document.getElementById('timeLoading').style.display='flex';
      // Replace this with your own source. Here we just simulate slots each 30m from 8 to 18.
      const list=[];
      for(let h=8; h<=18; h++){ list.push({h, m:0, label: String(h).padStart(2,'0')+':00', mins:h*60}); list.push({h, m:30, label: String(h).padStart(2,'0')+':30', mins:h*60+30}); }
      dayTimes=list;
      renderSelectedDateTimes(selectedISO);
      document.getElementById('timeLoading').style.display='none';
    }

    /* ---------- MAPS ---------- */
    let map, marker, autocomplete, allowedPoly;
    let SA_BOUNDS = { north: 25.0500, south: 24.3000, west: 46.2000, east: 47.1000 };
    let ALLOWED_POLY_PATH = [];
    async function loadMapSettings(){
      const r=await gasGet({route:'mapSettings', appId:APP_ID});
      if(r.ok && r.data && r.data.success && r.data.data){
        const d=r.data.data;
        if(d.SA_BOUNDS){ SA_BOUNDS=d.SA_BOUNDS; }
        if(Array.isArray(d.ALLOWED_POLY_PATH)){ ALLOWED_POLY_PATH=d.ALLOWED_POLY_PATH; }
      }
    }
    async function initMap(){
      await loadMapSettings();
      const def={lat:24.7136,lng:46.6753};
      map=new google.maps.Map(document.getElementById('googleMap'),{
        center:def, zoom:12, mapTypeControl:false, fullscreenControl:true,
        restriction:{latLngBounds: SA_BOUNDS, strictBounds:false}
      });
      if(Array.isArray(ALLOWED_POLY_PATH) && ALLOWED_POLY_PATH.length>=3){
        allowedPoly = new google.maps.Polygon({
          map, paths: ALLOWED_POLY_PATH, strokeColor:'#027A93', strokeOpacity:.9, strokeWeight:1.5, fillColor:'#027A93', fillOpacity:.05
        });
      }
      marker=new google.maps.Marker({position:def,map,draggable:true,title:'اسحب أو اضغط لتحديد الموقع'});
      const setPos=(latLng)=>{
        marker.setPosition(latLng); map.panTo(latLng); map.setZoom(17);
        nForm.urlLocation=`https://www.google.com/maps/search/?api=1&query=${latLng.lat()},${latLng.lng()}`;
        updateNextAvailability();
      };
      marker.addListener('dragend',({latLng})=>setPos(latLng));
      map.addListener('click',({latLng})=>setPos(latLng));

      const input=document.getElementById('mapSearch');
      const opts={ fields:['geometry','name'], componentRestrictions:{country:'sa'}, strictBounds:true };
      autocomplete=new google.maps.places.Autocomplete(input, opts);
      autocomplete.bindTo('bounds', map);
      autocomplete.addListener('place_changed', ()=>{
        const place=autocomplete.getPlace(); if(!place?.geometry) return;
        setPos(place.geometry.location);
      });

      document.getElementById('show-my-location').onclick=()=>{
        if(!navigator.geolocation){ showToast('error','المتصفح لا يدعم تحديد الموقع'); return; }
        navigator.geolocation.getCurrentPosition(
          pos=>setPos(new google.maps.LatLng(pos.coords.latitude,pos.coords.longitude)),
          _=>showToast('error','تعذر تحديد موقعك'),
          { enableHighAccuracy:true, timeout:10000, maximumAge:30000 }
        );
      };
    }
    // Expose for Google callback
    window.initMap = initMap;

    /* ---------- INIT ---------- */
    $(function(){
      // Select2 setup
      $('#area').select2({width:'100%',placeholder:'اختر المنطقة', dir:'rtl'});
      $('#serviceCat').select2({width:'100%',placeholder:'فئة الخدمة', dir:'rtl'});
      $('#service').select2({width:'100%',placeholder:'الخدمة', dir:'rtl'});
      $('#area, #serviceCat, #service').on('select2:open', ()=>{$('.select2-search__field').attr('dir','rtl');});

      // Phone input
      const mobileEl=document.getElementById('mobile');
      if(mobileEl){
        itiPhone=window.intlTelInput(mobileEl,{ initialCountry:'sa', onlyCountries:['sa','ae','bh','kw','om','qa'], separateDialCode:true, placeholderNumberType:'MOBILE', utilsScript:'https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/utils.js' });
        $('#mobile').on('blur', ()=>{ const ok=itiPhone && itiPhone.isValidNumber(); document.getElementById('err-mobile').dataset.show = ok ? 'false' : 'true'; updateNextAvailability(); });
      }

      // Load locations (simplified single value, you can populate from your platform if needed)
      $('#area').empty().select2({data:[{id:'الرياض',text:'الرياض'}], width:'100%', placeholder:'اختر المنطقة', dir:'rtl'});
      $('#area').val('الرياض').trigger('change');

      // Load services from GAS when area changes
      $('#area').on('change', async function(){
        nForm.location=this.value;
        document.getElementById('servicesLoading').style.display='';
        const r=await gasGet({route:'services', appId:APP_ID});
        document.getElementById('servicesLoading').style.display='none';
        if(!(r.ok && r.data && r.data.success)){ showToast('error','تعذر تحميل الخدمات'); return; }
        servicesCache = Array.isArray(r.data.data.services)? r.data.data.services : [];
        categoriesCache = Array.isArray(r.data.data.servicesCat)? r.data.data.servicesCat : [];
        const cats=categoriesCache.map(c=>({id:c.TS_category_id,text:c.TS_category_arabic_name}));
        $('#serviceCat').empty().select2({data:cats,width:'100%',placeholder:'فئة الخدمة', dir:'rtl'});
        if(cats.length){ $('#serviceCat').val(cats[0].id).trigger('change'); }
        activeCatId=cats.length?String(cats[0].id):null;
        renderCategoryTabs(categoriesCache);
        renderServiceCards();
        updateNextAvailability();
      });

      $('#serviceCat').on('change', function(){
        nForm.serviceCat=this.value;
        const cid=String(this.value||'');
        const items=servicesCache.filter(s=>String(s.TS_category_id)===cid).map(s=>({id:s.TS_service_id,text:s.TS_service_arabic_name}));
        $('#service').empty().select2({data:items,width:'100%',placeholder:'الخدمة', dir:'rtl'});
        if(items.length){ $('#service').val(items[0].id).trigger('change'); }
        activeCatId=cid; renderCategoryTabs(categoriesCache); renderServiceCards(); updateNextAvailability();
      });

      $('#service').on('change', function(){
        nForm.service=this.value||''; selectedServiceId = this.value || null;
        renderServiceCards(); updateFooterCartSummary(); updateNextAvailability();
      });

      // Date/time
      const today=DateTime.now().toFormat('yyyy-LL-dd');
      $('#date').val(today).attr('min',today).on('change', fetchTimes);
      $('#timeFilter').on('change', function(){ currentTimeFilter=this.value; renderSelectedDateTimes(lastSelectedISO); });

      // Steps navigation
      document.getElementById('footer-prev').onclick=()=>{
        const order=['pageServices','pageTime','pageContact','pagePay','pageMap','pageDone'];
        const i=order.indexOf(document.querySelector('.page.active')?.id); showPage(order[Math.max(0,i-1)]);
      };
      document.getElementById('footer-next').onclick=()=>{
        const order=['pageServices','pageTime','pageContact','pagePay','pageMap','pageDone'];
        const id=document.querySelector('.page.active')?.id; const i=order.indexOf(id);

        if(id==='pageServices'){
          const ok=!!$('#service').val(); document.getElementById('err-service').dataset.show=ok?'false':'true';
          document.getElementById('err-serviceCat').dataset.show=$('#serviceCat').val()?'false':'true';
          if(!ok) return showToast('error','يرجى اختيار الخدمة');
          showPage('pageTime'); fetchTimes(); return;
        }
        if(id==='pageTime'){ if(!selectedTime){ showToast('error','اختر وقتًا'); return; } showPage('pageContact'); return; }
        if(id==='pageContact'){
          const nameOk=($('#name').val()||'').trim().length>0;
          document.getElementById('err-name').dataset.show=nameOk?'false':'true';
          if(!nameOk) return;
          nForm.customerN=$('#name').val().trim();
          nForm.customerM= itiPhone?.getNumber?.()?.replace(/^\+/, '') || ($('#mobile').val()||'').replace(/\D/g,'');
          showPage('pagePay'); return;
        }
        if(id==='pagePay'){
          if(!nForm.paymentMethod){ document.getElementById('err-pay').dataset.show='true'; return; }
          document.getElementById('err-pay').dataset.show='false'; showPage('pageMap'); return;
        }
        if(id==='pageMap'){
          if(!nForm.urlLocation){ document.getElementById('err-map').dataset.show='true'; return; }
          document.getElementById('err-map').dataset.show='false';
          // Show "Done"
          document.getElementById('ts-area').textContent = $('#area').find(':selected').text()||'—';
          document.getElementById('ts-service').textContent = $('#service').find(':selected').text()||'—';
          document.getElementById('ts-dt').textContent = (nForm.date||today) + (selectedTime?(' • '+selectedTime.iso):'');
          document.getElementById('ts-pay').textContent = (nForm.paymentMethod||'').toUpperCase()||'—';
          const waMsg = encodeURIComponent(`تم إرسال طلب حجز: \nالخدمة: ${$('#service').find(':selected').text()}\nالتاريخ: ${nForm.date} ${nForm.time}\nالرابط: ${location.href}`);
          document.getElementById('ts-whatsapp').href = `https://wa.me/?text=${waMsg}`;
          showPage('pageDone');
          return;
        }
      };

      // Payment roving selection
      (function installPayRoving(){
        const group=document.getElementById('payGroup'); if(!group) return;
        const items=[...group.querySelectorAll('.pay-card')];
        const setActive=(el)=>{
          items.forEach(i=>{ i.setAttribute('aria-checked','false'); i.setAttribute('tabindex','-1'); i.querySelector('input').checked=false; });
          el.setAttribute('aria-checked','true'); el.setAttribute('tabindex','0');
          const input=el.querySelector('input'); if(input){ input.checked=true; nForm.paymentMethod=input.value; updateNextAvailability(); }
        };
        items.forEach((el,i)=>{ if(i===0) el.setAttribute('tabindex','0'); else el.setAttribute('tabindex','-1'); el.addEventListener('click',()=>setActive(el)); });
        group.addEventListener('keydown', e=>{
          const cur=document.activeElement.closest('.pay-card'); if(!cur) return;
          const idx=items.indexOf(cur);
          if(e.key==='ArrowLeft'||e.key==='ArrowUp'){ e.preventDefault(); items[Math.max(0,idx-1)].focus(); }
          if(e.key==='ArrowRight'||e.key==='ArrowDown'){ e.preventDefault(); items[Math.min(items.length-1,idx+1)].focus(); }
          if(e.key===' '||e.key==='Enter'){ e.preventDefault(); setActive(cur); }
        }, {passive:false});
      })();

      // Name / phone inputs
      $('#name').on('input', updateNextAvailability);

      // Initial progress
      setProgress(0);
      updateFooterCartSummary();
      updateNextAvailability();

      // Rebook
      $('#rebook').on('click', ()=>location.reload());
    });

  })();
  </script>

  <!-- Google Maps (Places + Geometry) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBBHLoO038vsCovHN-SLUgAXqexlA2v0_4&callback=initMap&v=weekly&loading=async&libraries=places,geometry&language=ar&region=SA" async defer></script>
</body>
</html>
