<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Primary Meta Tags -->
    <title>حجوزات المواعيد</title>
    <meta name="title" content="حجوزات المواعيد">
    <meta name="description" content="1. بنغسل سيارتك بخلطة خاصة مدعّمة بالواكس تحميها من الغبار والخدوش. 2. فوطنا دايمًا نظيفة. 3. ونستخدم إسفنجة مخصوصة للكفرات عشان نهتم بكل تفاصيل سيارتك. #غسيل_بدون_طوابير">

    <!-- Google / Search Engine Tags -->
    <meta itemprop="name" content="حجوزات المواعيد">
    <meta itemprop="description" content="1. بنغسل سيارتك بخلطة خاصة مدعّمة بالواكس تحميها من الغبار والخدوش. 2. فوطنا دايمًا نظيفة. 3. ونستخدم إسفنجة مخصوصة للكفرات عشان نهتم بكل تفاصيل سيارتك. #غسيل_بدون_طوابير">
    <meta itemprop="image" content="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/Logo%20-%20Sponge%20and%20Soap%20-%201.png">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://www.spongnsoap.com">
    <meta property="og:title" content="حجوزات المواعيد">
    <meta property="og:description" content="1. بنغسل سيارتك بخلطة خاصة مدعّمة بالواكس تحميها من الغبار والخدوش. 2. فوطنا دايمًا نظيفة. 3. ونستخدم إسفنجة مخصوصة للكفرات عشان نهتم بكل تفاصيل سيارتك. #غسيل_بدون_طوابير">
    <meta property="og:image" content="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/Logo%20-%20Sponge%20and%20Soap%20-%201.png">
    <meta property="og:image:src" content="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/Logo%20-%20Sponge%20and%20Soap%20-%201.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://www.spongnsoap.com">
    <meta property="twitter:title" content="حجوزات المواعيد">
    <meta property="twitter:description" content="1. بنغسل سيارتك بخلطة خاصة مدعّمة بالواكس تحميها من الغبار والخدوش. 2. فوطنا دايمًا نظيفة. 3. ونستخدم إسفنجة مخصوصة للكفرات عشان نهتم بكل تفاصيل سيارتك. #غسيل_بدون_طوابير">
    <meta property="twitter:image" content="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/Logo%20-%20Sponge%20and%20Soap%20-%201.png">
    <meta property="twitter:image:src" content="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/Logo%20-%20Sponge%20and%20Soap%20-%201.png">
    <link rel="shortcut icon" href="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/Logo%20-%20Sponge%20and%20Soap%20-%201.png" type="image/x-icon">

    <meta name="keywords" content="المدينة,المنورة,الشرقية,القطيف,الخبر,الدمام,سيهات,car,سيارة,mobile,موبيل,موبايل,لكزس,lexus,واش,wash,car wash,غسيل,غسيل_بدون_طوابير,طابور,بدون,طوابير,موسم,داخلي,خارجي,نظيف,تلميع,تظليل,clean,internal,حجز,موعد,reserve,appointment,ticket,work,عمل,riyad,dahran,dhahran,تنظيف,نظافة,بخار,ماء,ماي,مويه,صابون,نحل,nahl,nahl.app,أزرق,نيلي,Blue,Last clean,اسفجنة وصابون,sponge, soap, spongnsoap,spongensoap,اخر نظافة,مايكلين">
    <meta name="robots" content="index, follow">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="language" content="Arabic">

    <script src="https://code.jquery.com/jquery-3.6.3.slim.min.js" integrity="sha256-ZwqZIVdD3iXNyGHbSYdsmWP//UBokj2FHAxKuSBKDSo=" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <!-- date-fns -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <!-- luxon -->
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Tinos:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>

    <!-- country codes -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/css/intlTelInput.css">
    <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/intlTelInputWithUtils.js"></script>

    <style>
      @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
      body,html{margin:0;height:100%;font-family:'Cairo',sans-serif;position:fixed;width:100vw;height:100vh;}
      input,select{text-align:center;}
      body{display:flex;flex-direction:row;flex-wrap:wrap;align-items:center;justify-content:center;background-size:cover;}
      .bg-image{position:absolute;width:100%;z-index:-1;background-image:url("https://www.dropbox.com/s/s9bxuykl0w49dqa/background2.jpg?raw=1");filter:blur(8px);-webkit-filter:blur(8px);height:100%;background-position:center;background-repeat:no-repeat;background-size:cover;}
      h1{margin-bottom:5.3%;}
      #banner,#form{flex-basis:50%;height:100%;}
      #form{display:flex;flex-direction:column;align-items:center;justify-content:center;background:#48b5d0e0;color:#ffffff;box-shadow:0 0 5px 10px rgba(5,28,59,.981),10px 0px 70px 0px rgba(5,28,59,.426);}
      #form-content{width:100%;overflow:auto;flex-basis:100%;display:flex;flex-direction:column;justify-content:space-between;}
      #form-content #page1,#form-content #page2,#form-content #page3,#form-content #page4,#form-content #page5,#form-content #page6,#form-content #page7{text-align:center;display:flex;flex-direction:column;align-items:center;z-index:2;position:relative;justify-content:space-evenly;height:auto;}
      #page1,#page2,#page3,#page4,#page5,#page6,#page7{justify-content:space-evenly;height:100%;}
      #page1,#page2,#page4,#page5,#page6,#page7{height:70%;}
      .header{z-index:2;text-align:center;color:#ffffff;font-weight:bold;flex-basis:10%;margin:0;padding:0;padding-top:10%;}
      .header h1{vertical-align:-webkit-baseline-middle;display:inline-block;margin:0;padding:0;font-size:40px;}
      .header img{width:220px;}
      .header-grid1{display:flex;flex-direction:row;align-items:flex-end;justify-content:center;}
      .header-grid3{display:flex;flex-direction:row;align-items:flex-end;justify-content:flex-end;}
      .header-grid2{display:flex;flex-direction:row;align-items:flex-end;justify-content:center;font-size:10px;}
      .social{width:100%!important;}
      a.nostyle:link,a.nostyle:visited{text-decoration:inherit;color:inherit;cursor:auto;}
      .radio-buttons{align-items:center;background-color:#fff;border-radius:12px;box-shadow:transparent 0 0 0 3px,rgba(18,18,18,.1) 0 6px 20px;box-sizing:border-box;color:#40bfb7;cursor:pointer;display:inline-flex;justify-content:center;outline:none;padding:1rem 1.2rem;text-align:center;text-decoration:none;transition:box-shadow .2s,-webkit-box-shadow .2s;border:0;user-select:none;-webkit-user-select:none;touch-action:manipulation;width:50%;}
      .radios:checked+img,.radios:checked+h2,.radios:checked+svg{background:linear-gradient(45deg,rgba(137,137,137,1) 0%,rgba(84,108,156,1) 100%);color:#493a68;}
      .radio-label{width:80%;}
      .filter-button{align-items:center;background-color:#ffffff;border-radius:12px;box-shadow:transparent 0 0 0 3px,rgba(18,18,18,.1) 0 6px 20px;box-sizing:border-box;color:#0394b6;cursor:pointer;display:inline-flex;font-family:'Cairo',sans-serif;font-size:1.2rem;font-weight:700;justify-content:center;line-height:1;margin:0;outline:none;padding:1rem 1.2rem;text-align:center;text-decoration:none;transition:box-shadow .2s,-webkit-box-shadow .2s;white-space:nowrap;border:0;user-select:none;-webkit-user-select:none;touch-action:manipulation;}
      .filter-button-wrap{max-width:250px;padding:1rem;position:relative;background:linear-gradient(to right,#d3d3d3,#0394b6);padding:3px;border-radius:15px;}
      .filter-button:hover{background-color:#0394b6;color:#f5f5f5;}
      .time-date-box{display:flex;flex-direction:column;border-radius:10px;width:100%;margin-top:30px;padding:10px;}
      #time-date-header{border-radius:12px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.1);border:none;}
      .time-date-header{display:flex;flex-direction:row;justify-content:stretch;align-items:center;color:black;}
      .time-date-header div{padding-top:15px;padding-bottom:15px;background-color:white;flex-basis:33.333%;box-shadow:transparent 0 0 0 3px,rgba(18,18,18,.1) 0 6px 20px;transition:all 1s;cursor:pointer;}
      .time-date-header div:hover{background-color:#0394b6;color:#f5f5f5;}
      .time-date-header .choosed{background-color:#0394b6;color:#f5f5f5;}
      .spinner-border{border-color:#0394b6;border-right-color:transparent;}
      #department-spinner{color:#0394b6;}
      .time-container{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;justify-content:space-evenly;align-content:start;align-items:start;background-color:white;height:23rem;overflow-y:auto;}
      .time-button{align-items:center;background-color:#fff;border-radius:12px;box-shadow:transparent 0 0 0 3px,rgba(18,18,18,.1) 0 6px 20px;box-sizing:border-box;color:#121212;cursor:pointer;display:inline-flex;flex:1 1 auto;font-family:Inter,sans-serif;font-size:1rem;font-weight:700;justify-content:center;line-height:1;margin:3%;outline:none;padding:1.5rem 1.2rem;text-align:center;text-decoration:none;transition:box-shadow .2s,-webkit-box-shadow .2s;white-space:nowrap;border:0;user-select:none;-webkit-user-select:none;touch-action:manipulation;align-self:start;flex-grow:0;}
      a{color:#ffffff;text-decoration:none;}
      .time-button:hover{background-color:#0394b6;color:#f5f5f5;}
      #date{padding:2rem;}
      form input{margin:3%;}
      .banner-content{display:flex;flex-direction:column;justify-content:center;align-items:center;height:100%;}
      .banner-content-holder{display:flex;flex-direction:column;align-items:center;height:50%;justify-content:center;}
      @-webkit-keyframes fadeOut{0%{opacity:1;}100%{opacity:0;}}@keyframes fadeOut{0%{opacity:1;}100%{opacity:0;}}
      .fadeOut{animation:fadeOut 1s forwards;}
      @keyframes fadeIn{0%{opacity:0;}100%{opacity:1;}}
      .fadeIn{animation:fadeIn 1s forwards;}
      #select2-container{width:100%!important;}
      .instagram-button,.tiktok-button,.whatsapp-button{position:fixed;left:15px;z-index:99;background-color:#0000;border-radius:50px;color:#fff;text-decoration:none;width:50px;height:50px;font-size:30px;display:flex;flex-direction:column;justify-content:center;align-items:center;animation:effect 5s ease-in;}
      .instagram-button{bottom:74px;}
      .tiktok-button{bottom:133px;}
      .whatsapp-button{bottom:15px;}
      .instagram-button:hover,.tiktok-button:hover,.whatsapp-button:hover{width:55px;height:55px;font-size:35px;}
      .page6-contact{margin:2% 20% 0 20%;font-size:smaller;display:none;}
      @keyframes effect{20%,100%{width:50px;height:50px;font-size:30px;}0%,10%{width:55px;height:55px;font-size:35px;}5%{width:50px;height:50px;font-size:30px;}}
      svg{left:-0%;width:47%;}
      @media only screen and (max-width:1000px){#banner{position:absolute;display:none;flex-basis:0%;filter:blur(7px);} .banner-content{z-index:-1;} #form{flex-basis:100%;} .banner-content-holder{width:100%;height:100%;} svg{left:-3%;width:100%;} svg g path{fill:#d6d6d6;} #time-container{display:grid;grid-template-columns:1fr 1fr 1fr;flex-direction:row;flex-wrap:wrap;} .radio-buttons{width:60%;}}
      @media only screen and (max-width:450px){#date{padding-top:0.5rem;padding-bottom:2rem;} .radio-buttons{width:80%;}}
      @media only screen and (max-height:775px){#page3{padding-top:10%;margin-bottom:10%;} #page5,#page4{padding-top:10%;margin-bottom:10%;} #page1,#page2{margin-bottom:10%;height:60%;} #page6,#page7{height:50%;} .radio-buttons{width:80%;}}
      #service,#serviceCat{margin:3%;}
      input:focus{outline:none;}
      .select2-selection__rendered{line-height:32px!important;}
      .select2-selection{height:37px!important;}
      #page6-resend{position:relative;background:linear-gradient(45deg,rgba(73,58,104,1) 0%,rgba(64,191,184,1) 100%);transition:all 1s;}
      #page6-resend:hover{transition:all 1s;color:rgb(43 37 57);}
      #page6-resend span{z-index:3;}
      #page6-resend:after{position:absolute;content:'';top:0;left:0;width:100%;height:100%;border-radius:12px;background-image:linear-gradient(45deg,rgba(64,191,184,1) 0%,rgba(73,58,104,1) 100%);transition:opacity .5s ease-out;z-index:2;opacity:0;}
      #page6-resend:hover:after{opacity:1;}
      .iti{width:100%;}
      #chip-container{display:flex;justify-content:center;gap:15px;flex-wrap:wrap;margin-top:20px;}
      body{font-family:'Cairo',sans-serif;background-color:#f5f5f5;display:flex;justify-content:center;align-items:center;height:100vh;margin:0;}
      .form-container{display:flex;flex-direction:column;gap:5px;width:100%;max-width:400px;}
      .chip{background:rgba(255,255,255,0);color:#ffffff;padding:8px;border-radius:8px;box-shadow:0 0 6px rgba(55,51,141,0);display:flex;flex-direction:column;align-items:center;transition:transform .2s ease-in-out;}
      .chip:hover{transform:scale(1.01);}
      .chip label{font-size:12px;font-weight:600;margin-bottom:3px;text-align:center;}
      .chip select,.chip input{width:100%;max-width:280px;font-size:12px;padding:4px;border-radius:6px;border:none;text-align:center;background:#ffffff;color:#37338d;box-shadow:0 1px 3px rgba(0,0,0,0.1);transition:box-shadow .3s ease-in-out;}
      .chip select:focus,.chip input:focus{box-shadow:0 0 4px rgba(244,206,20,.7);outline:none;}
      #locationDescription{font-weight:bold;background:rgba(233,236,239,1);color:#555;font-size:12px;padding:4px;}
      #drag-instructions{position:absolute;top:20px;left:50%;transform:translateX(-50%);background:rgba(255,255,255,0.9);padding:8px 12px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.2);text-align:center;font-size:14px;color:#333;z-index:9999;animation:fadeIn .5s ease-in-out;}
      #drag-instructions img{width:40px;height:auto;margin-bottom:4px;animation:moveHand 1.5s infinite alternate ease-in-out;}
      #drag-icon{font-size:40px;display:block;margin:0 auto 4px;animation:moveHand 1.5s infinite alternate ease-in-out;}
      @keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
      @keyframes moveHand{from{transform:translateX(0);}to{transform:translateX(15px);}}
      .rebook-button{background:linear-gradient(135deg,#0394b6,#48b5d0);color:#ffffff;font-size:1.2rem;padding:.8em 2em;border-radius:12px;border:none;box-shadow:0 4px 12px rgba(3,148,182,.3);transition:all .3s ease-in-out;font-family:'Cairo',sans-serif;font-weight:bold;letter-spacing:.5px;}
      .rebook-button:hover{background:linear-gradient(135deg,#027790,#32a5bc);transform:scale(1.05);box-shadow:0 6px 18px rgba(3,148,182,.5);cursor:pointer;}
      :root{--fab-size:56px;--fab-bg:rgba(34,34,34,.55);}
      .social-fab{position:fixed;left:15px;z-index:999;width:var(--fab-size);height:var(--fab-size);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;text-decoration:none;background:var(--fab-bg);backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);box-shadow:0 8px 20px rgba(0,0,0,.35),0 0 0 2px rgba(255,255,255,.10) inset;transition:transform .18s ease,box-shadow .18s ease,opacity .18s ease;will-change:transform,box-shadow;}
      .social-fab i{font-size:1.4rem;filter:drop-shadow(0 2px 4px rgba(0,0,0,.4));}
      .whatsapp-button{bottom:15px;--brand:#25D366;}
      .instagram-button{bottom:74px;--brand:#E1306C;}
      .tiktok-button{bottom:133px;--brand:#69C9D0;}
      .social-fab:hover,.social-fab:focus-visible{transform:translateY(-2px);box-shadow:0 12px 26px rgba(0,0,0,.45),0 0 0 2px var(--brand) inset,0 0 14px var(--brand);outline:none;}
      .social-fab:focus-visible{outline:3px solid var(--brand);outline-offset:3px;}
      @media (prefers-reduced-motion:reduce){.social-fab{transition:none;}}
    </style>
</head>
<body>
  <div class="bg-image"></div>

  <div id="banner">
    <div class="banner-content">
      <div class="banner-content-holder">
        <img style="margin-left:20px;margin-right:20px;width:111%;" src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/Logo%20-%20Sponge%20and%20Soap%20-%201.png" alt="Sponge & Soap" />
        <svg id="visual" viewBox="0 0 900 600" width="500" height="600" xmlns="http://www.w3.org/2000/svg" version="1.1" style="position:absolute;z-index:-1;">
          <g transform="translate(460.6560045766935 330.46230543970523)">
            <path id="blob1" d="M179.7 -253.3C226.1 -213.6 252.4 -152 270.9 -89.4C289.4 -26.7 300.2 37.2 279.3 87.5C258.5 137.8 205.9 174.5 154.1 198.3C102.3 222.1 51.1 233.1 -3.7 238.2C-58.6 243.3 -117.2 242.6 -161.4 216.3C-205.6 190 -235.5 138.1 -265.6 78.5C-295.8 18.9 -326.2 -48.5 -304.9 -94.5C-283.7 -140.5 -210.7 -165 -151.3 -200.6C-91.8 -236.1 -45.9 -282.5 10.3 -296.8C66.6 -311 133.2 -293 179.7 -253.3" fill="#ffffffd4"></path>
          </g>
          <g transform="translate(412.8686509605503 289.1871898626427)" style="visibility:hidden;">
            <path id="blob2" d="M137.5 -199C174.6 -162.2 198.8 -117.3 233.1 -63.5C267.5 -9.7 312.1 53.1 300 99.7C287.9 146.3 219.2 176.7 159.8 209.6C100.3 242.4 50.2 277.7 -5.5 285.3C-61.1 292.8 -122.3 272.6 -159.5 232.5C-196.8 192.5 -210.1 132.6 -219 77.7C-227.9 22.8 -232.4 -27.1 -220.8 -74.5C-209.2 -122 -181.6 -167 -142.1 -203C-102.7 -239 -51.3 -266 -0.6 -265.2C50.2 -264.4 100.3 -235.7 137.5 -199" fill="#ffffffd4"></path>
          </g>
        </svg>
      </div>
    </div>
  </div>

  <div id="form">
    <div id="form-content">
      <div class="header">
        <div class="header-grid1">
          <img src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/spong&Soap%20-%20logo.png" alt="Sponge & Soap" />
        </div>

        <div class="header-grid2" style="display:none;">
          <a class="nostyle" href="https://www.spongnsoap.com">
            <span style="color:#ffffff;">www.</span>
            <span style="font-weight:bold;">SpongNSoap</span>
            <span style="font-weight:normal;">.com</span>
          </a>

          <div class="header-grid3">
            <a target="_blank" style="width:13%!important;margin-right:5px;" href="">
              <img class="social" src="" alt="" />
            </a>
            <a target="_blank" style="width:13%!important;" href="">
              <img class="social" src="https://www.dropbox.com/scl/fi/6nhtxruo0qctgwjtzgh51/tik-tok.png?rlkey=b9rvg0uqadhhsckrmu9krxdo5&st=zkobmg85&raw=1" alt="TikTok" />
            </a>
            <a target="_blank" style="width:13%!important;margin-right:5px;" href="">
              <img class="social" src="https://www.dropbox.com/scl/fi/yuw8zd98282knix18bgpi/instagram.png?rlkey=ti0e1hqs2bx5lyfyqkbe1qw42&st=4pwkthmh&raw=1" alt="Instagram" />
            </a>
            <span style="padding-left:5px;">@SpongeSoap6</span>
          </div>
        </div>
      </div>

      <!-- Page 1 -->
      <div id="page1" style="display:flex;">
        <div>
          <h3 style="text-align:center;line-height:2;">
            ✨ واكس يحمي سيارتك<br />
            🧼 فوط نظيفة & لمعان مضمون<br />
            🛞 إسفنجة للكفرات<br /><br />
            ... نهتم بكل التفاصيل
          </h3>
          <p style="text-align:center;margin-top:10px;">
            <span style="font-weight:bold;font-size:18px;">#غسيل_بدون_طوابير</span>
          </p>
        </div>
        <div class="filter-button-wrap">
          <button id="page1-button" class="filter-button">احجز موعدك</button>
        </div>
      </div>

      <!-- Page 2 -->
      <div id="page2" class="fadeIn" style="display:none;">
        <h1>وين تحب نجيك ؟<br />اختيار المنطقة</h1>
        <form onsubmit="handleSubmit(event)" id="page2-form" action="" style="width:100%;">
          <div id="select2-container" style="position:relative;">
            <select id="area" class="js-example-basic-single" style="width:80%" onchange="setBoundries()" required></select>
            <div id="page2-spinner" style="position:absolute;top:0;left:47.6%;display:none;">
              <div class="spinner-border" role="status" style="width:1.5rem;height:1.5rem;margin-top:19%;"><span class="sr-only">Loading...</span></div>
            </div>
          </div>

          <label for="service">الخدمة</label>
          <div style="position:relative;">
            <select id="service" type="text" style="width:90%;" required></select>
            <div id="page3-2-spinner" style="position:absolute;top:0;left:47.6%;">
              <div class="spinner-border" role="status" style="width:1.5rem;height:1.5rem;margin-top:19%;"><span class="sr-only">Loading...</span></div>
            </div>
          </div>
        </form>

        <div class="filter-button-wrap">
          <button id="page2-button" class="filter-button">التالي</button>
        </div>
      </div>

      <!-- Page 3 -->
      <div id="page3" class="fadeIn" style="display:none;">
        <div id="page3-wait" style="display:none;position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:10;">
          <div class="spinner-border text-light" role="status"><span class="visually-hidden">Loading...</span></div>
          <p style="color:#fff;margin-top:1em;font-size:1.2em;">جاري جلب المواعيد…</p>
        </div>

        <form onsubmit="handleSubmit(event)" id="page3-form" action="" style="display:flex;flex-direction:column;width:100%;padding:3%;">
          <label for="serviceCat" style="display:none;">صنف الخدمة</label>
          <div style="position:relative;display:none;">
            <select id="serviceCat" type="text" style="width:100%;" required></select>
            <div id="page3-1-spinner" style="position:absolute;top:0;left:47.6%;">
              <div class="spinner-border" role="status" style="width:1.5rem;height:1.5rem;margin-top:19%;"><span class="sr-only">Loading...</span></div>
            </div>
          </div>

          <label for="serviceCount" style="display:none;">عدد السيارات</label>
          <select id="serviceCount" type="text" style="width:100%;display:none;" required>
            <option value="1" selected>1</option><option value="2">2</option><option value="3">3</option>
            <option value="4">4</option><option value="5">5</option><option value="6">6</option>
            <option value="7">7</option><option value="8">8</option><option value="9">9</option>
            <option value="10">10</option>
          </select>
        </form>

        <div id="page3-buttons">
          <div id="fail-alert-4" class="alert alert-danger" role="alert" style="display:none;margin-top:30px;margin-bottom:0;">
            <span></span><br /><span></span>
          </div>
          <button id="page3-button" class="filter-button" style="margin-top:30px" hidden>التالي</button>
          <button id="page3-return" class="filter-button" style="margin-top:30px" hidden>السابق</button>
        </div>
      </div>

      <!-- Page 4 -->
      <div id="page4" class="fadeIn" style="display:none;">
        <h1>متى تحب نجيك ؟<br />اختيار الموعد</h1>
        <input type="date" id="date" name="date" class="date form-control" style="text-align:center;width:50%;vertical-align:middle;" />
        <div class="time-date-box">
          <div id="time-date-header" class="time-date-header" hidden>
            <div id="dayHeader1" class="choosed" style="border-radius:0px 10px 0px 0px;">
              <span id="day1">sunday</span><br /><span id="day1date">02\11\2013</span>
            </div>
            <div id="dayHeader2">
              <span id="day2">monday</span><br /><span id="day2date">02\12\2013</span>
            </div>
            <div id="dayHeader3" style="border-radius:10px 0px 0px 0px;">
              <span id="day3">tuesday</span><br /><span id="day3date">02\13\2013</span>
            </div>
          </div>

          <div id="time-container" class="time-container"></div>

          <div id="fail-alert-3" class="alert alert-danger" role="alert" style="display:none;margin-top:30px;margin-bottom:0;">
            <span></span><br /><span></span>
          </div>
        </div>

        <div class="filter-button-wrap">
          <button id="page4-return" class="filter-button">السابق</button>
        </div>
      </div>

      <!-- Page 5 -->
      <div id="page5" class="fadeIn" style="display:none;">
        <form onsubmit="handleSubmit(event)" id="page5-form" action="" style="display:flex;flex-direction:column;">
          <h2>معلومات الاتصال</h2>
          <label for="name">الإسم</label>
          <input id="name" type="text" required />
          <label for="mobile">رقم الجوال</label>
          <div class="phoneCountry" style="color:black;margin:3%;">
            <input type="tel" id="mobile" style="width:100%;" />
          </div>

          <h2></h2>
          <h2>معلومات المركبة</h2>
          <div class="chip" style="position:relative;margin-bottom:1em;">
            <select id="carBrand" onchange="updateLocationDescription()" style="width:100%;padding:.6em;font-size:1em;border:1px solid #ccc;border-radius:4px;">
              <option value="" disabled selected>🚘 ماركة السيارة</option>
              <option value="Other">Other</option>
            </select>
          </div>

          <div style="display:flex;gap:1em;margin-bottom:1em;flex-wrap:wrap;">
            <div class="chip" style="flex:1;position:relative;">
              <input type="text" id="carName" placeholder="اسم السيارة (GT-R, كامري، إلنترا)" oninput="updateLocationDescription()" style="width:100%;padding:.6em;font-size:1em;border:1px solid #ccc;border-radius:4px;" />
            </div>
            <div class="chip" style="flex:1;position:relative;">
              <input type="text" id="plateNumber" maxlength="4" placeholder="🔢 رقم اللوحة (مثال: 1234)" oninput="updateLocationDescription()" inputmode="numeric" pattern="^\d{1,4}$" required style="width:100%;padding:.6em;font-size:1em;border:1px solid #ccc;border-radius:4px;" />
            </div>
          </div>

          <div hidden>
            <input type="text" id="locationDescription" readonly placeholder="ماركة السيارة, اسم السيارة, رقم اللوحة" style="width:100%;padding:.6em;font-size:1em;border:1px solid #ccc;border-radius:4px;" />
          </div>

          <h2>طريقة الدفع</h2>
          <div style="display:flex;flex-direction:row-reverse;justify-content:space-evenly;align-content:center;align-items:center;">
            <div style="flex-grow:1;flex-basis:0;height:100%;">
              <label for="Cash" class="radio-label" style="position:relative;height:100%;">
                <input style="position:absolute;opacity:0;width:50%;margin:0;height:100%;padding:0;" type="radio" name="payingMethod" class="radios" id="card" value="Cash" required />
                <img class="radio-buttons" src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/CASH%20LOGO.png" alt="Cash" width="125" />
              </label>
            </div>
            <div style="flex-grow:1;flex-basis:0;height:100%;">
              <label for="Telr-Online" class="radio-label" style="position:relative;height:100%;">
                <input style="position:absolute;opacity:0;width:50%;margin:0;height:100%;padding:0;" type="radio" name="payingMethod" class="radios" id="card2" value="Telr-Online" required />
                <img class="radio-buttons" src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/STC%20PAY%20LOGO.png" alt="STC Pay / Online" width="125" />
              </label>
            </div>
            <div style="flex-grow:1;flex-basis:0;">
              <label for="Telr-Online" class="radio-label" style="position:relative;">
                <input style="position:absolute;opacity:0;width:50%;margin:0;height:100%;padding:0;" type="radio" name="payingMethod" class="radios" id="card3" value="Telr-Online" required />
                <img class="radio-buttons" src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/MADA%20LOGO.png" alt="MADA" width="125" />
              </label>
            </div>
          </div>
        </form>

        <div id="page5-buttons">
          <div id="fail-alert-4" class="alert alert-danger" role="alert" style="display:none;margin-top:30px;margin-bottom:0;">
            <span></span><br /><span></span>
          </div>
          <button id="page5-button" class="filter-button" style="margin-top:30px;">التالي</button>
          <button id="page5-return" class="filter-button" style="margin-top:30px;">السابق</button>
        </div>
      </div>

      <!-- Page 6 -->
      <div id="page6" class="fadeIn" style="display:none;">
        <label for="googleMap" style="font-size:1.5em;">الموقع على خريطة قوقل</label>

        <div id="drag-instructions">
          <i class="fas fa-hand-point-right" id="drag-icon"></i>
          <p>📍 اسحب الخريطة لتغيير الموقع</p>
        </div>

        <div id="googleMap" style="width:100%;height:400px;margin:3% 0;color:#493a68;"></div>

        <p style="text-align:center;font-size:14px;color:#333;margin-bottom:10px;">
          📍 <strong>قم بسحب المؤشر أو اضغط على اظهار موقعي</strong>
        </p>

        <button class="filter-button" id="show-my-location" style="border-radius:0;width:100%;margin-bottom:1em;">
          اظهار موقعي
        </button>

        <form onsubmit="handleSubmit(event)" id="page6-form" action="" style="display:flex;flex-direction:column;width:100%;padding-bottom:3%;"></form>

        <div id="page6-buttons">
          <div id="fail-alert-5" class="alert alert-danger" role="alert" style="display:none;margin:30px 0 0;">
            <span></span><br /><span></span>
          </div>

          <button id="page6-button" class="filter-button" style="margin-top:30px;width:100%;">التالي</button>
          <button id="page6-return" class="filter-button" style="margin-top:30px;width:100%;">السابق</button>

          <div id="page6-spinner" style="display:none;flex-direction:column;align-items:center;margin-top:1em;">
            <span class="mt-3"></span>
            <div class="spinner-border" role="status" style="display:none;margin-top:30px;">
              <span class="sr-only">Loading...</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Page 7 -->
      <div id="page7" class="fadeIn" style="display:none;">
        <h1>شكرا لكم</h1>
        <h2>تم حجز الموعد، وراح نأكده لكم على الواتساب</h2>
        <h3>متحمسين نجيكم!!</h3>

        <div class="filter-button-wrap">
          <button id="rebook" class="filter-button rebook-button">🔁 حجز جديد</button>
        </div>
      </div>

      <footer style="text-align:center;margin-top:20px;">
        <p>Sponge & Soap</p>
        <a target="_blank" href="https://www.instagram.com/nahl.app?igsh=Y3YyOW05MGI5bnNv&utm_source=qr">
          <p>Made with Nahl Perfection</p>
        </a>
      </footer>
    </div>
  </div>

  <!-- Social FABs -->
  <a target="_blank" href="https://wa.me/966503668222" class="social-fab whatsapp-button" aria-label="تواصل عبر واتساب">
    <i class="fab fa-whatsapp" aria-hidden="true"></i>
  </a>
  <a target="_blank" href="https://www.instagram.com/sponge.soap_sa?igsh=MWRtOHI5OHZpbWpvdA==" class="social-fab instagram-button" aria-label="تابعنا على إنستغرام">
    <i class="fab fa-instagram" aria-hidden="true"></i>
  </a>
  <a target="_blank" href="https://www.tiktok.com/@sponge.soap_sa?_t=ZS-8zaj1CA4aJg&_r=1" class="social-fab tiktok-button" aria-label="تابعنا على تيك توك">
    <i class="fab fa-tiktok" aria-hidden="true"></i>
  </a>

  <!-- ===================== TERMS MODAL ===================== -->
  <div class="modal fade" id="termsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">الشروط والأحكام – مغسلة سيارات متنقلة</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
        </div>
        <div class="modal-body" style="text-align:right;">
          <ol style="padding-right:1rem;">
            <li><strong>الخدمات المقدمة</strong>
              <ul><li>تقدم المغسلة خدمات غسيل وتنظيف السيارات وفق الباقات المعروضة على الموقع أو حسب الاتفاق المسبق.</li></ul>
            </li>
            <li><strong>حجز المواعيد</strong>
              <ul>
                <li>يتم الحجز عبر الموقع أو من خلال التواصل المباشر.</li>
                <li>يحق للمغسلة تعديل أو إلغاء الموعد في حال وجود ظرف طارئ مع إشعار العميل.</li>
              </ul>
            </li>
            <li><strong>الدفع</strong>
              <ul>
                <li>يتم الدفع عبر الوسائل المتاحة (تحويل بنكي، مدى، بطاقة إئتمانية، STC Bank، Apple Pay، نقدًا).</li>
                <li>يجب سداد المبلغ كاملاً قبل بدء الخدمة. وفي حال عدم السداد يحق للمغسلة إلغاء الموعد.</li>
              </ul>
            </li>
            <li><strong>إلغاء الخدمة واسترجاع المبلغ</strong>
              <ul>
                <li>في حال إلغاء الحجز قبل 3 ساعات من الموعد، يحق للعميل استرداد المبلغ أو إعادة جدولة الموعد.</li>
                <li>لا يحق للعميل طلب استرداد المبلغ أو جدولة الموعد في حال تم الإلغاء خلال أقل من 3 ساعات.</li>
              </ul>
            </li>
            <li><strong>مسؤولية المغسلة</strong>
              <ul>
                <li>تلتزم المغسلة بتقديم الخدمة بأفضل جودة ممكنة باستخدام مواد آمنة.</li>
                <li>المغسلة غير مسؤولة عن أي أعطال ميكانيكية أو كهربائية أو تلفيات سابقة في السيارة.</li>
                <li>في حال وقوع ضرر ناتج عن خطأ مباشر من فريق العمل، تتحمل المغسلة مسؤولية تعويض عادل يقتصر على قيمة الضرر المباشر.</li>
              </ul>
            </li>
            <li><strong>مسؤولية العميل</strong>
              <ul>
                <li>يجب على العميل إزالة أو إخلاء السيارة من أي متعلقات شخصية أو ثمينة قبل بدء الخدمة.</li>
                <li>المغسلة غير مسؤولة عن فقدان أو تلف أي أغراض شخصية تُترك داخل السيارة.</li>
                <li>توفير مكان مناسب وآمن لإتمام الخدمة (موقف، تصريح دخول، إلخ).</li>
              </ul>
            </li>
            <li><strong>الوقت والتأخير</strong>
              <ul>
                <li>مدة الخدمة تقريبية وقد تختلف حسب حالة السيارة.</li>
                <li>يلتزم العميل بالتواجد في الموقع بالوقت المحدد، والتأخير عن الموعد كحد اقصى 15 دقيقة ويعتبر الموعد لاغيًا بعد هذه المدة.</li>
              </ul>
            </li>
            <li><strong>التعديلات على الشروط والأحكام</strong>
              <ul>
                <li>تحتفظ المغسلة بحق تعديل أو تحديث هذه الشروط والأحكام في أي وقت.</li>
                <li>تعتبر موافقة العميل على الخدمة قبولًا لهذه الشروط والأحكام.</li>
              </ul>
            </li>
            <li><strong>القانون المعمول به</strong>
              <ul><li>تخضع هذه الشروط والأحكام لأنظمة وقوانين المملكة العربية السعودية.</li></ul>
            </li>
          </ol>
          <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" id="termsAccept" />
            <label class="form-check-label" for="termsAccept">أوافق على الشروط والأحكام</label>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
          <button class="btn btn-primary" id="confirmTerms" disabled>تأكيد ومتابعة</button>
        </div>
      </div>
    </div>
  </div>
  <!-- =================== /TERMS MODAL =================== -->

<script>
/* ===================== CONFIG ===================== */
const DateTime = luxon.DateTime;
// GAS endpoint (Apps Script web app)
const APPS_SCRIPT_BASE = "https://script.google.com/macros/s/AKfycbxjr5D045PGkIKP1BQjaJ33pMbzq8aQRsH7T9qgiaUFLoCpVmGZ0n1D_cUTmbIP_wcJ/exec";
// Your backend
const defaultLink2 = `https://nahl-platform.vercel.app/api/app/AM/general/${'33e0d05d-d771-46f4-a7e7-7c634b4e3a9e'}/form`;

/* ===================== PHONE INPUT ===================== */
const input = document.querySelector("#mobile");
const countryCodeInput = window.intlTelInput(input, {
  utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/utils.js",
  countryOrder:["sa","qa"],
  initialCountry:"sa",
  onlyCountries:["sa","qa","ae","om","kw","bh"],
  excludeCountries:["il"],
  strictMode:true,
  i18n:{ sa:"المملكة العربية السعودية" },
});
const errorMap = ["رقم غير صحيح","رمز دولة غير صحيح","المُدخل أقصر من المتوقع","المُدخل أطول من المتوقع","رقم غير صحيح"];

/* ===================== PERSISTED USER ===================== */
try {
  document.getElementById("name").value = localStorage.getItem("name") || "";
  if(localStorage.getItem("mobile")){
    countryCodeInput.setNumber("+"+ localStorage.getItem("mobile"));
  }
} catch(e){}

/* ===================== GLOBAL STATE ===================== */
document.getElementById("date").setAttribute("min", new Date().toLocaleDateString("fr-ca"));
const acceptedHourdiff = 1;
const acceptedMindiff = 30;

let services, serviceCategories;
let controllers = [];
let appointments = [[],[],[]];
let ActualTimes = [[],[],[]];
let timesLoaded = false;

var formData = [];
var nForm = {
  date:'',
  time:'',
  location:'',
  service:'',
  serviceCount:'',
  serviceCat:'',
  customerM:'',
  customerN:'',
  paymentMethod:'',
  urlLocation:'',
  locationDescription:''
};

/* ===================== HELPERS ===================== */
function handleSubmit(e){ e.preventDefault(); }
function getParam(name){ const u = new URL(location.href); return u.searchParams.get(name); }
function addService(element){
  element.classList.toggle("active");
  let selectedServices = [];
  document.querySelectorAll(".chip.active").forEach(chip => selectedServices.push(chip.textContent.trim()));
  document.getElementById("locationDescription").value = selectedServices.join(", ");
}

/* ===================== API CALLERS (to your backend) ===================== */
async function callContent2(routText, callback, abortable=false, retries=3){
  let signal='';
  if(abortable){
    if(controllers.length>0){
      for(const c of controllers){ c[0].abort(); }
      controllers=[];
    }
    const controller=new AbortController();
    signal=controller.signal;
    controllers.push([controller,signal]);
  }
  await new Promise(r=>setTimeout(r,1000));
  fetch(defaultLink2 + `${routText}`, {
    redirect:"follow",
    method:"GET",
    ...(abortable && {signal})
  }).then(async (response)=>{
    if(!response.ok){
      if(retries>0) return callContent2(routText, callback, abortable, retries-1);
      else throw new Error('Network response was not ok');
    }
    const jsonresponse = await response.json();
    callback(jsonresponse);
  }).catch(err=>{
    console.log("Error:"+err);
    if(!err.message.includes("aborted")){
      setTimeout(()=>{
        if(retries>0) return callContent2(routText, callback, abortable, retries-1);
      },2000);
    }
  });
}

/* ===================== LOAD LOCATIONS ===================== */
document.getElementById("page2-spinner").style.display="block";
callContent2(`/locations`,(data)=>{
  let locations=data.data || [];
  let selectData=[];
  for(let i=0;i<locations.length;i++){
    selectData[i]={id:locations[i]["id"], text:locations[i]["TS_location_arabic_name"]};
  }
  selectData.sort((a,b)=>a.id-b.id);
  $('.js-example-basic-single').select2({data:selectData,width:"90%"});
  $('#area').trigger('change');
  document.getElementById("page2-spinner").style.display="none";
});

/* ===================== DATE / TIME ===================== */
let day1=DateTime.now();
let day2=day1.plus({days:1});
let day3=day1.plus({days:2});
let dates=[day1,day2,day3];

let weekdays=["الأحد","الإثنين","الثلاثاء","الأربعاء","الخميس","الجمعة","السبت","الأحد"];

document.getElementById('date').onchange = () => {
  const serviceEl = document.getElementById("service");
  const serviceId = (serviceEl && serviceEl.value) ? String(serviceEl.value).trim() : "";

  // If service is not chosen, don’t call the API
  if (!serviceId) {
    document.getElementById('time-container').innerHTML = `
      <div style="grid-column:1 / -1; text-align:center; padding:1rem;">
        يرجى اختيار الخدمة أولاً
      </div>`;
    document.getElementById('date').disabled = false;
    return;
  }

  document.getElementById('date').disabled = true;
  $("#time-container").empty();
  document.getElementById('time-container').innerHTML = `
    <div id="department-spinner" class="spinner-border" role="status" style="grid-column-start: span 3; justify-self: center;">
      <span class="sr-only">Loading...</span>
    </div>`;

  ActualTimes = [[],[],[]];
  appointments = [[],[],[]];
  timesLoaded = false;

  let day1 = luxon.DateTime.fromISO(document.getElementById('date').value);
  let day2 = day1.plus({days:1});
  let day3 = day1.plus({days:2});

  for (let i = 1; i <= 3; i++) {
    const d = i === 1 ? day1 : i === 2 ? day2 : day3;
    document.getElementById(`day${i}`).innerText = weekdays[d.weekday];
    document.getElementById(`day${i}date`).innerText = d.toFormat('yyyy-MM-dd');
  }

  const areaId = document.getElementById("area").value;
  const url =
    `/appointments?startDate=${encodeURIComponent(day1.toFormat('yyyy-MM-dd'))}` +
    `&location=${encodeURIComponent(areaId)}` +
    `&service=${encodeURIComponent(serviceId)}`;

  callContent2(url, (data) => {
    document.getElementById('time-container').innerHTML = `
      <div id="department-spinner" class="spinner-border" role="status" style="grid-column-start: span 3; justify-self: center;">
        <span class="sr-only">Loading...</span>
      </div>`;

    appointments = [[],[],[]];

    const recieved = data?.data?.appointments || [];
    const tempActualTimes = [];

    for (let i = 0; i < recieved.length; i++) {
      const x = luxon.DateTime.fromISO(recieved[i]['TS_appointment_date'], { setZone: true });
      const y = luxon.DateTime.fromISO(recieved[i]['TS_appointment_time'], { setZone: true });
      recieved[i]['TS_appointment_date'] = x.toISODate();
      recieved[i]['TS_appointment_time'] = y.toLocaleString(luxon.DateTime.TIME_SIMPLE).replace(" ", " ");
      tempActualTimes[i] = y.toFormat('hh:mm a');
    }

    const d1 = day1.toFormat('yyyy-MM-dd');
    const d2 = day2.toFormat('yyyy-MM-dd');
    const d3 = day3.toFormat('yyyy-MM-dd');

    for (let i = 0; i < recieved.length; i++) {
      const r = recieved[i];
      if (r.TS_appointment_date === d1) {
        appointments[0].push(r.TS_appointment_time);
        ActualTimes[0].push(tempActualTimes[i]);
      } else if (r.TS_appointment_date === d2) {
        appointments[1].push(r.TS_appointment_time);
        ActualTimes[1].push(tempActualTimes[i]);
      } else if (r.TS_appointment_date === d3) {
        appointments[2].push(r.TS_appointment_time);
        ActualTimes[2].push(tempActualTimes[i]);
      }
    }

    timesLoaded = true;

    // KEEP YOUR ORIGINAL METHOD: render all three headers/days as before
    // If your original code used timesSetter with header clicks, call it initially:
    timesSetter(0);

    document.getElementById('date').disabled = false;
  }, true);
};

document.getElementById('date').value=DateTime.now().toFormat('yyyy-MM-dd');

function timesSetter(index) {
  const timeContainer = document.getElementById("time-container");
  timeContainer.innerHTML = "";

  if (appointments[index].length === 0) {
    timeContainer.innerHTML = `
      <div id="department-spinner" class="" role="status" style="grid-column-start: span 3; justify-self: center;">
        <span>لا توجد مواعيد متاحة</span>
      </div>`;
    return;
  }

  const dayDate = document.getElementById('day' + (index + 1) + 'date').innerText;

  for (let y = 0; y < appointments[index].length; y++) {
    const btn = document.createElement('button');
    btn.className = 'time-button';
    btn.dir = 'ltr';
    btn.textContent = appointments[index][y];

    const actual = ActualTimes[index][y];
    btn.addEventListener('click', () => choosedDate(actual, dayDate, 4));

    timeContainer.appendChild(btn);
  }
}


for(let i=1;i<=3;i++){
  document.getElementById(`day${i}`).innerText=weekdays[dates[i-1].weekday];
  document.getElementById(`day${i}date`).innerText=dates[i-1].toFormat('yyyy-MM-dd');
}

/* ===================== NAVIGATION (NEXT buttons) ===================== */
for(let i=1;i<7;i++){
  if(i===4) continue; // time is picked by button, not by "next" here

  let pb1=document.getElementById(`page${i}-button`);
  let p1=document.getElementById(`page${i}`);
  let p2=document.getElementById(`page${i+1}`);

  if(i===1){
    pb1.onclick=()=>{
      p1.classList.remove("fadeIn"); p1.classList.add("fadeOut");
      p2.classList.remove("fadeOut"); p2.classList.add("fadeIn");
      setTimeout(()=>{p1.style.display="none"; p2.style.display="flex";},1000);
    };
  }
  else if(i===2){
    pb1.onclick=()=>{
      const field1=document.getElementById("area");
      if(!field1.value){
        alert("الرجاء اختيار المنطقة");
        document.getElementById("page2-form").reportValidity();
        return;
      }
      nForm.location=document.getElementById("area").value;
      p1.classList.remove("fadeIn"); p1.classList.add("fadeOut");
      p2.classList.remove("fadeOut"); p2.classList.add("fadeIn");
      setTimeout(()=>{p1.style.display="none"; p2.style.display="flex";},1000);
    };
  }
  else if(i===3){
    pb1.onclick=()=>{
      // unused because we jump from selecting time
    };
  }
  else if(i===5){
    // PAGE 5 NEXT -> always go to map (payment moved to page 6)
    pb1.onclick=()=>{
      const field1=document.getElementById("name");
      const form=document.getElementById("page5-form");

      // name
      if(field1.value.trim()===""){
        field1.setCustomValidity("يُرجى ملئ هذا الحقل");
        form.reportValidity();
        return;
      } else field1.setCustomValidity("");

      // phone
      if(!checkNumberValidity()){
        form.reportValidity();
        return;
      }

      const payingMethod=document.querySelector('input[name="payingMethod"]:checked')?.value || "";
      nForm.paymentMethod=payingMethod;
      nForm.customerN=document.getElementById("name").value.trim();
      nForm.customerM=countryCodeInput.getNumber().substring(1);

      p1.classList.remove("fadeIn"); p1.classList.add("fadeOut");
      p2.classList.remove("fadeOut"); p2.classList.add("fadeIn");
      setTimeout(()=>{p1.style.display="none"; p2.style.display="flex";},1000);
    };
  }
  else if(i===6){
    // handled in terms modal confirm (below)
  }
  else{
    if(pb1){
      pb1.onclick=()=>{
        p1.classList.remove("fadeIn"); p1.classList.add("fadeOut");
        p2.classList.remove("fadeOut"); p2.classList.add("fadeIn");
        setTimeout(()=>{p1.style.display="none"; p2.style.display="flex";},1000);
      };
    }
  }
}

/* ===================== BACK buttons ===================== */
for(let i=3;i<7;i++){
  let pb1=document.getElementById(`page${i}-return`);
  let p1=document.getElementById(`page${i}`);
  let p2=(i===4)?document.getElementById(`page2`):document.getElementById(`page${i-1}`);
  if(pb1){
    pb1.onclick=()=>{
      p1.classList.remove("fadeIn"); p1.classList.add("fadeOut");
      p2.classList.remove("fadeOut"); p2.classList.add("fadeIn");
      setTimeout(()=>{p1.style.display="none"; p2.style.display="flex";},1000);
    };
  }
}

/* ===================== TIME PICK ===================== */
function choosedDate(time,date,i){
  formData[2]=date;
  formData[3]=time;
  nForm.date=date;
  let parsedTime=DateTime.fromFormat(time,"h:mm a");
  nForm.time=parsedTime.toFormat("HH:mm");

  // go to page 5
  const p1=document.getElementById(`page${i}`);
  const p2=document.getElementById(`page${i+1}`);
  p1.classList.remove("fadeIn"); p1.classList.add("fadeOut");
  p2.classList.remove("fadeOut"); p2.classList.add("fadeIn");
  setTimeout(()=>{p1.style.display="none"; p2.style.display="flex";},1000);
}

/* ===================== VALIDATION ===================== */
function checkNumberValidity(){
  const number=document.getElementById("mobile");
  const phoneNumber=countryCodeInput.getNumber().substring(1);
  const region=countryCodeInput.getSelectedCountryData().dialCode;
  if(isNaN(phoneNumber) || !countryCodeInput.isValidNumber() || phoneNumber===""){
    const msg=errorMap[countryCodeInput.getValidationError()] || "رقم غير صحيح";
    number.setCustomValidity(msg);
    return false;
  }
  // (kept your conditional – if any special case)
  number.setCustomValidity("");
  return true;
}

/* ===================== SERVICES ===================== */
$("#area").on("change",()=>{
  document.getElementById("page3-1-spinner").style.display="block";
  document.getElementById("page3-2-spinner").style.display="block";
  document.getElementById('serviceCat').innerHTML='';
  document.getElementById('service').innerHTML='';
  callContent2(`/services?location=${document.getElementById("area").value}`,(data)=>{
    services=data.data.services;
    serviceCategories=data.data.servicesCat;

    const categoriesWithServices={};
    services.forEach(s=>{
      const categoryID=s.TS_category_id;
      if(!categoriesWithServices[categoryID]){
        categoriesWithServices[categoryID]={category: serviceCategories.find(cat=>cat.TS_category_id===categoryID), services:[], locations:new Set()};
      }
      categoriesWithServices[categoryID].services.push(s);
      s.location.forEach(loc=>categoriesWithServices[categoryID].locations.add(loc));
    });
    servicesDropdownLoader2(categoriesWithServices);
    document.getElementById("page3-1-spinner").style.display="none";
    document.getElementById("page3-2-spinner").style.display="none";
  }, true);
  $('#date').trigger('change');
});

function servicesDropdownLoader2(data) {
  const categoriesID = Object.keys(data);
  const categoriesNames = [];
  for (const id of categoriesID) {
    categoriesNames.push(locale === "en"
      ? data[id].category.TS_category_english_name
      : data[id].category.TS_category_arabic_name
    );
  }
  add_dropdown_list(categoriesNames, categoriesID, "serviceCat", "disabled", "servicesCat");

  document.getElementById("service").innerHTML = "";

  document.getElementById('serviceCat').addEventListener('change', function () {
    const currentCategory = document.getElementById("serviceCat").value;
    const sorted = data[currentCategory].services.slice().sort((a,b)=>a.TS_service_id - b.TS_service_id);

    const myServicesID = [];
    const myServiceNames = [];
    for (const s of sorted) {
      myServicesID.push(s.TS_service_id);
      myServiceNames.push(locale === "en" ? s.TS_service_english_name : s.TS_service_arabic_name);
    }
    add_dropdown_list(myServiceNames, myServicesID, "service", "disabled", "services");
  });

  // Fetch ONLY when a concrete service is selected by the user
  document.getElementById('service').addEventListener('change', function(){
    if (this.value) {
      // now we have a service, refresh available appointments
      document.getElementById('date').dispatchEvent(new Event('change'));
    }
  });

  // Do NOT auto trigger date change here (prevents &service=)
}

function add_dropdown_list(show_list,value_list,element_id){
  var parentElement=document.getElementById(element_id);
  parentElement.innerHTML="";
  var opti=document.createElement("option");
  opti.text=show_list[0]; opti.value=value_list[0]; opti.setAttribute("selected","selected");
  parentElement.appendChild(opti);
  for(let i=1;i<value_list.length;i++){
    var opt=document.createElement("option");
    opt.text=show_list[i]; opt.value=value_list[i];
    parentElement.appendChild(opt);
  }
  const event=new Event('change');
  parentElement.dispatchEvent(event);
}

/* ===================== CAR INFO ===================== */
document.getElementById('plateNumber').addEventListener('input', function(){
  this.value=this.value.replace(/\D/g,'').slice(0,4);
  this.setCustomValidity('');
  updateLocationDescription();
});
function updateLocationDescription(){
  const carBrand=document.getElementById("carBrand").value || "";
  const carName=document.getElementById("carName").value || "";
  const plateNumber=document.getElementById("plateNumber").value || "";
  const description=[carBrand,carName,plateNumber].filter(Boolean).join(", ");
  document.getElementById("locationDescription").value=description;
}
const carBrands=["Acura","Alfa Romeo","Aston Martin","Audi","Bentley","BMW","Bugatti","Buick","Cadillac","Chevrolet","Chrysler","Citroën","Dacia","Daewoo","Daihatsu","Dodge","Ferrari","Fiat","Ford","Genesis","GMC","Haval","Holden","Honda","Hummer","Hyundai","Infiniti","Isuzu","Jaguar","Jeep","Kia","Koenigsegg","Lada","Lamborghini","Lancia","Land Rover","Lexus","Lincoln","Lotus","Maserati","Maybach","Mazda","McLaren","Mercedes-Benz","Mercury","MG","Mini","Mitsubishi","Nissan","Opel","Pagani","Peugeot","Plymouth","Pontiac","Porsche","RAM","Renault","Rolls-Royce","Saab","Saturn","Scion","Seat","Skoda","Smart","SsangYong","Subaru","Suzuki","Tata","Tesla","Toyota","Volkswagen","Volvo","Wiesmann","Zotye"];
carBrands.sort().forEach(brand=>$('#carBrand').append(`<option value="${brand}">${brand}</option>`));
$(document).ready(function(){ $('#carBrand').select2({placeholder:"Select a car brand",allowClear:true}); });

/* ===================== AUTO MOVE PAGE3 -> PAGE4 (optional) ===================== */
;(function(){
  const page3=document.getElementById('page3');
  const nextBtn=document.getElementById('page3-button');
  if(!page3||!nextBtn) return;
  const obs=new MutationObserver(()=>{
    if(page3.style.display==='flex'){
      setTimeout(()=>nextBtn.click(),5000);
    }
  });
  obs.observe(page3,{attributes:true,attributeFilter:['style']});
})();

/* ===================== REBOOK ===================== */
document.getElementById("rebook")?.addEventListener("click",()=>{ window.location.href="https://www.spongnsoap.com/"; });

/* ===================== GOOGLE MAPS ===================== */
let map,infoWindow,marker,polygon=null;
let position="";
const prePosition="https://www.google.com/maps/search/?api=1&query=";
let defaultLocation={lat:26.34165524787632,lng:50.11524831545726};

function myMap(){
  map=new google.maps.Map(document.getElementById("googleMap"),{
    center:defaultLocation, zoom:12, disableDoubleClickZoom:true
  });
  infoWindow=new google.maps.InfoWindow();
  marker=new google.maps.Marker({
    position:defaultLocation,map:map,draggable:true,title:"اضغط أو اسحب لتحديد الموقع",
  });
  marker.addListener("dragend", e=>validateAndSetPosition(e.latLng));
  map.addListener("click", e=>validateAndSetPosition(e.latLng));
  map.addListener("dblclick", e=>{ e.stop(); validateAndSetPosition(e.latLng); });

  let pressTimer;
  map.addListener("mousedown", e=>{ pressTimer=setTimeout(()=>validateAndSetPosition(e.latLng),600); });
  map.addListener("mouseup", ()=>clearTimeout(pressTimer));
  map.addListener("touchstart", e=>{ pressTimer=setTimeout(()=>validateAndSetPosition(e.latLng),600); });
  map.addListener("touchend", ()=>clearTimeout(pressTimer));

  const dragHint=document.getElementById("drag-instructions");
  setTimeout(()=>{ dragHint.style.display="none"; },5000);
  map.addListener("dragstart",()=>{ dragHint.style.display="none"; });
}
window.myMap = myMap;
function validateAndSetPosition(latLng){
  if(polygon && !google.maps.geometry.poly.containsLocation(latLng,polygon)){
    alert("⚠️ عذرًا، موقعك خارج نطاق الخدمة");
    position="";
    infoWindow.setContent("🚫 موقع خارج الخدمة");
    infoWindow.open(map);
    return;
  }
  marker.setPosition(latLng);
  map.panTo(latLng);
  map.setZoom(17);
  position = `${prePosition}${latLng.lat()},${latLng.lng()}`;
  infoWindow.setContent("✅ تم تحديث موقعك هنا");
  infoWindow.open(map,marker);
}

function setBoundries(){
  const selectedArea = $("#area option:selected").text().trim();
  let APP_Location, polygonCoords;

  if(selectedArea==="العزيزية - الخبر"){
    APP_Location={north:26.237892901838705,south:26.15102181049713,west:50.090294685184475,east:50.234894203935546};
    polygonCoords=[
      {lng:50.215045355428195,lat:26.219724394350184},
      {lng:50.2135291654911,lat:26.1870383495685},
      {lng:50.137875179099595,lat:26.069703060741347},
      {lng:50.10628808282646,lat:26.15001891083389},
      {lng:50.143828288837895,lat:26.21660551929113},
      {lng:50.19603263782255,lat:26.21897351180097},
    ];
  } else if(selectedArea==="أجيال - أرامكو"){
    APP_Location={north:26.289037271670438,south:26.237817336683204,west:50.05143566513406,east:50.096905737932595};
    polygonCoords=[
      {lng:50.06256215323989,lat:26.275519772515292},
      {lng:50.070562455580834,lat:26.277608292466685},
      {lng:50.08514528516432,lat:26.257720425641132},
      {lng:50.06822454797902,lat:26.24524748257814},
      {lng:50.06115405632103,lat:26.262628935642045},
      {lng:50.05894452767791,lat:26.267950423932856},
    ];
  } else if(selectedArea==="الدوحة و الدانة"){
    APP_Location={north:26.37969652644046,south:26.277002257490476,west:50.11899625151807,east:50.195753733969404};
    polygonCoords=[
      {lng:50.11488540829821,lat:26.341056543806932},
      {lng:50.136645122501264,lat:26.353671078060277},
      {lng:50.14577577434936,lat:26.363004767230812},
      {lng:50.178697561294584,lat:26.3329268498157454},
      {lng:50.17972636713662,lat:26.31448441448552},
      {lng:50.16468008169681,lat:26.29799900302895},
    ];
  } else {
    alert("⚠️ المنطقة غير معرفة، يرجى الاختيار الصحيح");
    return;
  }

  defaultLocation={ lat:(APP_Location.north+APP_Location.south)/2, lng:(APP_Location.east+APP_Location.west)/2 };
  if(polygon) polygon.setMap(null);
  polygon=new google.maps.Polygon({
    paths:polygonCoords, strokeColor:"#ff0000", strokeOpacity:0.4, strokeWeight:2, fillColor:"#00ff00", fillOpacity:0.1
  });
  polygon.setMap(map);
  map.setCenter(defaultLocation);
  map.setZoom(14);
  marker.setPosition(defaultLocation);
  position=`${prePosition}${defaultLocation.lat},${defaultLocation.lng}`;
}

function detectMyLocation(){
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition((pos)=>{
      const userPos=new google.maps.LatLng(pos.coords.latitude,pos.coords.longitude);
      if(polygon && !google.maps.geometry.poly.containsLocation(userPos,polygon)){
        alert("⚠️ عذرًا، موقعك خارج نطاق الخدمة");
        return;
      }
      marker.setPosition(userPos);
      map.panTo(userPos);
      map.setZoom(17);
      position=`${prePosition}${pos.coords.latitude},${pos.coords.longitude}`;
      infoWindow.close();
    },()=>handleLocationError(true));
  } else {
    handleLocationError(false);
  }
}
document.addEventListener("DOMContentLoaded",()=>{
  const locationBtn=document.getElementById("show-my-location");
  if(locationBtn){ locationBtn.addEventListener("click",detectMyLocation); }
});
function handleLocationError(browserHasGeolocation){
  infoWindow.setPosition(map.getCenter());
  infoWindow.setContent(browserHasGeolocation ? "⚠️ تعذر الحصول على موقعك. يرجى السماح بالوصول للموقع." : "⚠️ جهازك لا يدعم تحديد الموقع.");
  infoWindow.open(map);
}

/* ===================== PAYMENT (Option A) ===================== */
/* Create Telr/MADA session using URL-encoded body (no headers -> no preflight) */
async function startTelrPaymentOptionA(order){
  // persist order until user returns from gateway
  sessionStorage.setItem("pendingOrder", JSON.stringify(order));

  const form = new URLSearchParams();
  form.set("fn","createTelrMadaSession");
  form.set("date", order.date || "");
  form.set("time", order.time || "");
  form.set("areaId", order.location || order.areaId || "");
  form.set("serviceId", order.service || order.serviceId || "");
  form.set("serviceCount", order.serviceCount || "");
  form.set("customerName", order.customerName || order.customerN || "");
  form.set("customerMobile", order.customerMobile || order.customerM || "");
  form.set("carDesc", order.locationDescription || order.carDesc || "");
  const successUrl = location.origin + location.pathname + "?payment=success";
  const cancelUrl  = location.origin + location.pathname + "?payment=cancel";
  form.set("successUrl", successUrl);
  form.set("cancelUrl", cancelUrl);

  const res = await fetch(APPS_SCRIPT_BASE, { method:"POST", body: form });
  let j;
  try { j = await res.json(); }
  catch(e){ alert("تعذر قراءة استجابة بوابة الدفع."); return false; }

  if(!j.success || !j.redirect_url){
    alert(j.message || "تعذر فتح بوابة الدفع.");
    return false;
  }
  if(j.order_id) sessionStorage.setItem("payment_order_id", j.order_id);
  location.href = j.redirect_url;
  return true;
}

/* After payment success -> finalize reservation with your backend, then show Page 7 */
async function finalizeAfterPaymentIfNeeded(){
  const p = getParam("payment");
  if(p!=="success") return;

  const saved = sessionStorage.getItem("pendingOrder");
  if(!saved) return;

  try{
    const order = JSON.parse(saved);
    // ensure map page is visible (optional)
    const p6=document.getElementById("page6");
    const p7=document.getElementById("page7");
    if(p6) { p6.style.display="flex"; }

    const resp = await fetch(defaultLink2 + "/reserveAppointment", {
      method:"POST",
      body: JSON.stringify(order),
      redirect:"follow"
    });
    if(!resp.ok) throw new Error("reserve failed");
    const j = await resp.json();
    if(!j.success) throw new Error("reserve not success");

    // go to thank you
    if(p6&&p7){
      p6.classList.remove("fadeIn"); p6.classList.add("fadeOut");
      p7.classList.remove("fadeOut"); p7.classList.add("fadeIn");
      setTimeout(()=>{ p6.style.display="none"; p7.style.display="flex"; },1000);
    }

    if(confirm("عزيزنا/عزيزتنا, ودك نتذكر بياناتك على هذا الجهاز لتسهيل الغسلات الجاية ؟")){
      localStorage.setItem("name", order.customerName || order.customerN || "");
      localStorage.setItem("mobile", order.customerMobile || order.customerM || "");
    } else {
      localStorage.removeItem("name"); localStorage.removeItem("mobile");
    }
  }catch(e){
    console.error(e);
    alert("تم الدفع بنجاح لكن تعذر تأكيد الحجز تلقائياً. تواصل معنا لإكماله.");
  }finally{
    sessionStorage.removeItem("pendingOrder");
    sessionStorage.removeItem("payment_order_id");
  }
}

/* Wire Terms modal confirm (Page 6) to branch CASH vs ONLINE */
document.addEventListener("DOMContentLoaded",()=>{
  // handle payment cancel
  const status=getParam("payment");
  if(status==="cancel"){ alert("تم إلغاء عملية الدفع."); }
  finalizeAfterPaymentIfNeeded();

  // page 5 -> map next already handled

  // Show terms modal on page6 "التالي"
  const page6Next=document.getElementById('page6-button');
  if(page6Next){
    page6Next.onclick=()=>{
      if(!position){ alert("الرجاء تحديد الموقع"); return; }

      const termsModalEl=document.getElementById('termsModal');
      const termsModal=new bootstrap.Modal(termsModalEl);
      const acceptCheckbox=document.getElementById('termsAccept');
      const confirmBtn=document.getElementById('confirmTerms');
      acceptCheckbox.checked=false; confirmBtn.disabled=true;
      acceptCheckbox.onchange=()=>{ confirmBtn.disabled=!acceptCheckbox.checked; };
      termsModal.show();

      confirmBtn.onclick=async ()=>{
        termsModal.hide();

        // fill latest location vals
        nForm.urlLocation=position;
        nForm.locationDescription=document.getElementById("locationDescription")?.value || "";

        const payingMethod = nForm.paymentMethod || document.querySelector('input[name="payingMethod"]:checked')?.value || "Cash";

        if(payingMethod==="Telr-Online"){
          try{
            await startTelrPaymentOptionA(nForm); // redirect to gateway; we stop flow here
          }catch(e){
            console.error(e);
            alert("حدث خطأ أثناء إنشاء عملية الدفع.");
          }
          return;
        }

        // CASH → reserve immediately
        const pageSpinner=document.getElementById(`page6-spinner`);
        const pb1=document.getElementById(`page6-button`);
        const backBtn=document.getElementById(`page6-return`);
        const failAlert=document.getElementById(`fail-alert-5`);
        pageSpinner.style.display="flex";
        pageSpinner.children[1].style.display="block";
        pb1.style.display="none"; backBtn.style.display="none"; failAlert.style.display="none";

        fetch(defaultLink2 + `/reserveAppointment`, {
          redirect:"follow", method:"POST", body: JSON.stringify(nForm)
        }).then(async (response)=>{
          pageSpinner.style.display='none';
          pageSpinner.children[1].style.display="none";
          if(!response.ok) throw Object.assign(new Error('reserve error'), {response});
          const rj = await response.json();
          if(rj.success){
            const p6=document.getElementById("page6");
            const p7=document.getElementById("page7");
            p6.classList.remove("fadeIn"); p6.classList.add("fadeOut");
            p7.classList.remove("fadeOut"); p7.classList.add("fadeIn");
            setTimeout(()=>{
              p6.style.display="none"; p7.style.display="flex";
              if(confirm(`عزيزنا/عزيزتنا, ودك نتذكر بياناتك على هذا الجهاز لتسهيل الغسلات الجاية ؟`)){
                localStorage.setItem("name", document.getElementById("name").value);
                localStorage.setItem("mobile", countryCodeInput.getNumber().substring(1));
              }else{
                localStorage.removeItem("name"); localStorage.removeItem("mobile");
              }
            },1000);
          } else {
            throw new Error("reserve not success");
          }
        }).catch(async err=>{
          console.log("Error:",err.message);
          try{
            const ej = await err.response.json();
            const failAlert3=document.getElementById(`fail-alert-3`);
            failAlert3.style.display="block";
            failAlert3.children[0].innerHTML = ej.msgAR || "عذرًا حصل خطأ غير متوقع الرجاء التواصل معنا";
          }catch(e){}
          document.getElementById('date').dispatchEvent(new Event('change'));
          pb1.style.display="inline-block"; backBtn.style.display="inline-block";
        });
      };
    };
  }
});

/* ===================== MISC ===================== */
document.getElementById("date").setAttribute("dir", (navigator.language||"").includes("ar")?"rtl":"ltr");

document.getElementById("page1-button").onclick=()=>{
  const p1=document.getElementById('page1');
  const p2=document.getElementById('page2');
  p1.classList.remove("fadeIn"); p1.classList.add("fadeOut");
  p2.classList.remove("fadeOut"); p2.classList.add("fadeIn");
  setTimeout(()=>{p1.style.display="none"; p2.style.display="flex";},1000);
};
</script>

<!-- Google Maps (geometry for polygon) -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBBHLoO038vsCovHN-SLUgAXqexlA2v0_4&callback=myMap&libraries=geometry" async defer></script>
</body>
</html>
