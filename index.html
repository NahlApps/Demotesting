<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>حجوزات المواعيد – Sponge & Soap</title>
  <meta name="description" content="غسيل سيارات متنقل بدون طوابير – احجز موعدك الآن. واكس حماية، فوط نظيفة، إسفنجة للكفرات. #غسيل_بدون_طوابير" />
  <meta name="robots" content="index, follow" />

  <!-- Open Graph -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="حجوزات المواعيد – Sponge & Soap" />
  <meta property="og:description" content="غسيل سيارات متنقل بدون طوابير – احجز موعدك الآن." />
  <meta property="og:image" content="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/Logo%20-%20Sponge%20and%20Soap%20-%201.png" />
  <meta property="og:url" content="https://www.spongnsoap.com" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="حجوزات المواعيد – Sponge & Soap" />
  <meta name="twitter:description" content="غسيل سيارات متنقل بدون طوابير – احجز موعدك الآن." />
  <meta name="twitter:image" content="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/Logo%20-%20Sponge%20and%20Soap%20-%201.png" />

  <link rel="icon" href="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/Logo%20-%20Sponge%20and%20Soap%20-%201.png" />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet" />

  <!-- Bootstrap (CSS only) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet" integrity="sha384-nN9q5O8S5b3GQ0Vn5w55zN6Xk9r3c0K7v8k3o3M2gZ1x8W+f8y1T6sS9b4b0x2WC" crossorigin="anonymous"/>

  <!-- Intl-Tel-Input CSS (inputs step only; JS loaded lazily later) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/css/intlTelInput.css">

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <style>
    :root{
      --brand-700:#0394b6;
      --brand-600:#0aa2c0;
      --brand-500:#48b5d0;
      --ink-900:#0b1a2b;
      --ink-700:#1f2d3d;
      --ink-500:#55657a;
      --bg-50:#f7fbfc;
      --bg-100:#e6f5f9;
      --ok:#00a67a;
      --danger:#e64b4b;
      --radius:14px;
      --shadow:0 10px 24px rgba(0,0,0,.12);
    }
    *{ box-sizing:border-box }
    html,body{height:100%}
    body{
      font-family:'Cairo',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background: linear-gradient(180deg, #6ec7d9 0%, #8fd3e4 100%) fixed;
      color:#fff;
      margin:0;
      overflow-x:hidden;
    }
    /* Main shell */
    .app{
      min-height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:32px 16px 120px; /* bottom for sticky bar */
    }
    .card-shell{
      width:min(920px, 100%);
      background:rgba(255,255,255,.16);
      border:1px solid rgba(255,255,255,.15);
      backdrop-filter: blur(8px);
      border-radius:24px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-head{
      padding:18px 20px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
    }
    .brand img{ width:42px; height:42px; border-radius:10px; object-fit:contain }
    .brand b{ font-weight:800; font-size:18px }

    /* Stepper */
    .stepper{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .step-pill{
      background:rgba(255,255,255,.25);
      color:#fff;
      border:none;
      padding:8px 14px;
      border-radius:999px;
      font-weight:700;
      outline:none;
      transition: .2s ease;
      box-shadow:inset 0 0 0 2px rgba(255,255,255,.18);
    }
    .step-pill[aria-current="step"]{
      background:#fff; color:var(--brand-700);
      box-shadow:inset 0 0 0 2px #fff;
    }
    .step-pill:focus-visible{ outline:3px solid #fff; outline-offset:2px }

    /* Title & summary */
    .stage{
      padding:8px 20px 0;
    }
    .stage h1{
      font-size:28px; font-weight:800; margin:8px 0 4px;
    }
    .summary{
      display:flex; flex-wrap:wrap; gap:8px; margin:8px 0 0;
    }
    .chip{
      background: rgba(255,255,255,.28);
      padding:6px 10px; border-radius:999px;
      color:#fff; font-weight:600; font-size:13px;
      display:inline-flex; align-items:center; gap:6px;
    }
    .chip button{
      background:transparent; border:0; color:#fff; font-size:12px; padding:0 0 0 4px;
    }

    /* Content area */
    .content{
      background:#fff;
      color:var(--ink-900);
      border-radius:20px 20px 0 0;
      padding:18px;
      min-height:520px;
    }
    .pane{ display:none }
    .pane.active{ display:block }

    /* Inputs */
    .field{ margin-bottom:16px }
    .field label{
      display:block; margin-bottom:8px; color:#0b2540; font-weight:700;
    }
    .control{
      position:relative;
    }
    .control input[type="text"],
    .control input[type="tel"],
    .control input[type="date"],
    .control select,
    .control textarea{
      width:100%;
      padding:14px 16px;
      border-radius:14px;
      border:1px solid #e7eef3;
      background:#fff;
      color:#0b2540;
      font-weight:600;
      box-shadow: 0 1px 0 rgba(0,0,0,.02);
    }
    .control input:focus,
    .control select:focus,
    .control textarea:focus{
      outline:3px solid #c6eef9; border-color:#b6e6f3;
    }
    .hint{ font-size:12px; color:#6a7b8b; margin-top:6px }
    .error{ color:var(--danger); font-size:12px; margin-top:6px; display:none }
    .control.invalid .error{ display:block }

    /* Time grid */
    .times{
      display:grid; grid-template-columns:repeat(1,1fr); gap:12px;
    }
    @media (min-width:560px){ .times{ grid-template-columns:repeat(2,1fr) } }
    @media (min-width:900px){ .times{ grid-template-columns:repeat(3,1fr) } }
    .time-btn{
      padding:18px; border-radius:16px; border:1px solid #ebf0f4;
      background:#f9fbfc; font-weight:800; text-align:center;
    }
    .time-btn:hover{ background:#eef7fb }
    .time-btn[aria-pressed="true"]{
      background:#e5f7fb; border-color:#c8ecf6; box-shadow:inset 0 0 0 2px #90daec;
    }

    /* Payment cards */
    .pay-grid{ display:grid; grid-template-columns:1fr; gap:12px }
    @media (min-width:720px){ .pay-grid{ grid-template-columns:1fr 1fr } }
    .pay-card{
      border:2px solid #eef2f6; border-radius:16px; background:#fff;
      display:flex; align-items:center; justify-content:center;
      min-height:120px; padding:18px; position:relative; cursor:pointer;
      transition: .18s ease;
    }
    .pay-card input{ position:absolute; inset:0; opacity:.00001; cursor:pointer }
    .pay-card:has(input:focus-visible){ outline:3px solid #9de7f6; outline-offset:3px }
    .pay-card:has(input:checked){
      border-color:#9de7f6; box-shadow:inset 0 0 0 3px #c9f1f8;
      background:#f7feff;
    }
    .pay-card img{ max-height:44px; object-fit:contain }
    .pay-card .txt{ font-weight:800; font-size:22px }

    /* Date picker wrapper */
    .date-wrap{ display:flex; justify-content:center }
    .date-wrap input{ max-width:420px; text-align:center }

    /* Map area */
    .map-wrap{ border-radius:16px; overflow:hidden; border:1px solid #e7eef3 }
    #googleMap{ width:100%; height:380px; }
    .map-hint{ color:#3a4651; font-weight:600; margin:8px 0 0 }

    /* Sticky nav bar */
    .sticky-cta{
      position:fixed; inset-inline:0; bottom:0; z-index:50;
      background:rgba(255,255,255,.94);
      border-top:1px solid #e9eef3;
      backdrop-filter: blur(8px);
    }
    .sticky-cta .inner{
      max-width:920px; margin-inline:auto; padding:10px 16px;
      display:flex; align-items:center; gap:10px;
    }
    .btn-brand{
      background:var(--brand-700); color:#fff; border:none;
      padding:14px 18px; border-radius:14px; font-weight:800; flex:1;
    }
    .btn-brand:disabled{ opacity:.5; cursor:not-allowed }
    .btn-ghost{
      background:#fff; color:var(--brand-700); border:1px solid #cfeaf2;
      padding:14px 18px; border-radius:14px; font-weight:800; flex:1;
    }
    .btn-ghost:focus-visible, .btn-brand:focus-visible{ outline:3px solid #9de7f6; outline-offset:2px }

    /* Social fabs */
    .fabs{ position:fixed; left:16px; bottom:96px; display:flex; flex-direction:column; gap:12px; z-index:60 }
    .fab{
      --size:54px;
      width:var(--size); height:var(--size); border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      color:#fff; background:rgba(34,34,34,.55);
      box-shadow:0 8px 20px rgba(0,0,0,.35), inset 0 0 0 2px rgba(255,255,255,.1);
      backdrop-filter: blur(6px);
    }
    .fab:focus-visible{ outline:3px solid #fff; outline-offset:3px }

    /* Footer */
    footer{
      text-align:center; color:#e6f6fb; font-weight:600; padding:12px 8px 16px;
    }
    footer a{ color:#fff; text-decoration:underline dotted }
    /* Loading overlay */
    .overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.35);
      display:none; align-items:center; justify-content:center; z-index:1000;
    }
    .overlay.show{ display:flex }
    .spinner{ width:46px; height:46px; border-radius:50%; border:4px solid #fff; border-top-color:transparent; animation:spin .8s linear infinite }
    @keyframes spin{ to{ transform:rotate(360deg) } }
  </style>
</head>

<body>
  <div class="app">
    <div class="card-shell" role="application" aria-labelledby="pageTitle">
      <div class="card-head">
        <div class="brand">
          <img loading="lazy" src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/spong&Soap%20-%20logo.png" alt="Sponge & Soap" />
          <b>Sponge & Soap</b>
        </div>
        <nav class="stepper" aria-label="مراحل الحجز">
          <button class="step-pill" type="button" data-step="1" aria-current="step">الخدمة</button>
          <button class="step-pill" type="button" data-step="2">الوقت</button>
          <button class="step-pill" type="button" data-step="3">البيانات</button>
          <button class="step-pill" type="button" data-step="4">الموقع</button>
          <button class="step-pill" type="button" data-step="5">التأكيد</button>
        </nav>
      </div>

      <div class="stage">
        <h1 id="pageTitle" aria-live="polite">احجز موعدك</h1>
        <div class="summary" aria-live="polite">
          <span class="chip" id="sum-location" hidden><i class="fa-solid fa-location-dot"></i><span></span><button type="button" data-goto="1" aria-label="تعديل المنطقة">تعديل</button></span>
          <span class="chip" id="sum-service" hidden><i class="fa-solid fa-sparkles"></i><span></span><button type="button" data-goto="1" aria-label="تعديل الخدمة">تعديل</button></span>
          <span class="chip" id="sum-date" hidden><i class="fa-regular fa-calendar"></i><span></span><button type="button" data-goto="2" aria-label="تعديل التاريخ">تعديل</button></span>
          <span class="chip" id="sum-time" hidden><i class="fa-regular fa-clock"></i><span></span><button type="button" data-goto="2" aria-label="تعديل الوقت">تعديل</button></span>
        </div>
      </div>

      <div class="content">
        <!-- STEP 1: Location & Service -->
        <section class="pane active" id="step1" aria-labelledby="title1">
          <h2 id="title1" class="visually-hidden">اختيار المنطقة والخدمة</h2>

          <div class="field">
            <label for="area">المنطقة</label>
            <div class="control">
              <select id="area" class="form-select" required aria-describedby="areaHint areaErr"></select>
              <div class="hint" id="areaHint">اختر المنطقة التي ترغب بخدمتك فيها.</div>
              <div class="error" id="areaErr">الرجاء اختيار المنطقة.</div>
            </div>
          </div>

          <div class="row g-3">
            <div class="col-md-6">
              <div class="field">
                <label for="serviceCat">صنف الخدمة</label>
                <div class="control">
                  <select id="serviceCat" class="form-select" required aria-describedby="catErr"></select>
                  <div class="error" id="catErr">الرجاء اختيار الصنف.</div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="field">
                <label for="service">الخدمة</label>
                <div class="control">
                  <select id="service" class="form-select" required aria-describedby="serviceErr"></select>
                  <div class="error" id="serviceErr">الرجاء اختيار الخدمة.</div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- STEP 2: Date & Time -->
        <section class="pane" id="step2" aria-labelledby="title2">
          <h2 id="title2" class="visually-hidden">اختيار التاريخ والوقت</h2>

          <div class="date-wrap field">
            <label class="w-100" for="date">التاريخ</label>
            <div class="control w-100">
              <input id="date" type="date" class="form-control" required aria-describedby="dateErr" />
              <div class="error" id="dateErr">الرجاء اختيار التاريخ.</div>
            </div>
          </div>

          <div class="field">
            <label>الأوقات المتاحة</label>
            <div id="time-wrap" class="times" role="grid" aria-label="قائمة الأوقات">
              <!-- buttons injected -->
            </div>
            <div class="text-center mt-3" id="no-slots" hidden>
              <div class="alert alert-warning mb-2">لا توجد أوقات متاحة لهذا اليوم.</div>
              <button type="button" class="btn btn-outline-primary" id="next-day">اعرض اليوم التالي</button>
            </div>
          </div>
        </section>

        <!-- STEP 3: Contact & Car -->
        <section class="pane" id="step3" aria-labelledby="title3">
          <h2 id="title3" class="visually-hidden">معلومات الاتصال والمركبة</h2>

          <div class="row g-3">
            <div class="col-md-6">
              <div class="field">
                <label for="name">الاسم</label>
                <div class="control" id="nameWrap">
                  <input id="name" type="text" inputmode="text" autocomplete="name" required aria-describedby="nameErr" />
                  <div class="error" id="nameErr">الرجاء إدخال الاسم.</div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="field">
                <label for="mobile">رقم الجوال</label>
                <div class="control" id="phoneWrap">
                  <input id="mobile" type="tel" inputmode="tel" required aria-describedby="phoneErr" />
                  <div class="error" id="phoneErr">الرجاء إدخال رقم جوال صحيح.</div>
                </div>
              </div>
            </div>
          </div>

          <hr class="my-3" />

          <h3 class="fw-bold mb-3">معلومات المركبة</h3>

          <div class="row g-3">
            <div class="col-md-6">
              <div class="field">
                <label for="carBrand">ماركة السيارة</label>
                <div class="control">
                  <select id="carBrand" class="form-select" aria-label="اختر ماركة السيارة">
                    <option value="" selected disabled>اختر</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="field">
                <label for="carName">اسم السيارة</label>
                <div class="control">
                  <input id="carName" type="text" placeholder="كامري، إلنترا، GT-R..." />
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="field">
                <label for="plateNumber">رقم اللوحة</label>
                <div class="control" id="plateWrap">
                  <input id="plateNumber" type="text" inputmode="numeric" pattern="^\d{1,4}$" maxlength="4" placeholder="مثال: 1234" aria-describedby="plateErr"/>
                  <div class="hint">أرقام فقط (حتى ٤ خانات).</div>
                  <div class="error" id="plateErr">الرجاء إدخال رقم لوحة صحيح (حتى ٤ أرقام).</div>
                </div>
              </div>
            </div>
          </div>

          <hr class="my-3"/>

          <h3 class="fw-bold mb-3">طريقة الدفع</h3>
          <div class="pay-grid" role="radiogroup" aria-label="طريقة الدفع">
            <label class="pay-card">
              <input type="radio" name="pay" value="STC Pay" required />
              <img loading="lazy" src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/STC%20PAY%20LOGO.png" alt="STC Pay">
            </label>
            <label class="pay-card">
              <input type="radio" name="pay" value="Cash" />
              <span class="txt">Cash</span>
            </label>
            <label class="pay-card" style="grid-column:1 / -1">
              <input type="radio" name="pay" value="MADA" />
              <img loading="lazy" src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/MADA%20LOGO.png" alt="مدى (MADA)">
            </label>
          </div>
        </section>

        <!-- STEP 4: Map & address -->
        <section class="pane" id="step4" aria-labelledby="title4">
          <h2 id="title4" class="visually-hidden">الموقع على خريطة قوقل</h2>

          <div class="field">
            <label for="mapSearch">ابحث بالعنوان أو اسم المكان</label>
            <div class="control">
              <input id="mapSearch" type="text" placeholder="مثال: الخبر، الراكة..." aria-describedby="mapHint">
              <div class="hint" id="mapHint">يمكنك السحب على الخريطة أو استخدام “اظهار موقعي”.</div>
            </div>
          </div>

          <div class="map-wrap mb-2">
            <div id="googleMap" role="region" aria-label="الخريطة"></div>
          </div>
          <p class="map-hint"><strong>ملاحظة:</strong> لا يمكن إتمام الحجز إذا كان الموقع خارج نطاق الخدمة المحدد.</p>
          <div class="text-end">
            <button type="button" class="btn btn-outline-primary" id="btnLocate"><i class="fa-solid fa-location-crosshairs"></i> اظهار موقعي</button>
          </div>
        </section>

        <!-- STEP 5: Thank you -->
        <section class="pane" id="step5" aria-labelledby="title5">
          <h2 id="title5" class="visually-hidden">تأكيد الحجز</h2>
          <div class="text-center py-5">
            <h3 class="fw-bold">تم استلام طلبك 🎉</h3>
            <p class="mt-2">سنؤكد الموعد عبر الواتساب.</p>
            <button type="button" id="rebook" class="btn btn-outline-primary mt-3">🔁 حجز جديد</button>
          </div>
        </section>
      </div>

      <footer>
        <div>Sponge & Soap</div>
        <a href="https://www.instagram.com/nahl.app?igsh=Y3YyOW05MGI5bnNv&utm_source=qr" target="_blank" rel="noopener">Made with Nahl Perfection</a>
      </footer>
    </div>
  </div>

  <!-- Sticky CTA -->
  <div class="sticky-cta" role="region" aria-label="أزرار التنقل">
    <div class="inner">
      <button type="button" class="btn-ghost" id="btnPrev">السابق</button>
      <button type="button" class="btn-brand" id="btnNext">التالي</button>
    </div>
  </div>

  <!-- Social FABs -->
  <div class="fabs" aria-hidden="true">
    <a class="fab" style="--brand:#69C9D0" target="_blank" href="https://www.tiktok.com/@sponge.soap_sa?_t=ZS-8zaj1CA4aJg&_r=1" aria-label="تيك توك"><i class="fab fa-tiktok"></i></a>
    <a class="fab" style="--brand:#E1306C" target="_blank" href="https://www.instagram.com/sponge.soap_sa?igsh=MWRtOHI5OHZpbWpvdA==" aria-label="إنستغرام"><i class="fab fa-instagram"></i></a>
    <a class="fab" style="--brand:#25D366" target="_blank" href="https://wa.me/966503668222" aria-label="واتساب"><i class="fab fa-whatsapp"></i></a>
  </div>

  <!-- Loading overlay -->
  <div class="overlay" id="overlay"><div class="spinner" role="status" aria-label="جاري التحميل"></div></div>

  <!-- Deps (JS): Bootstrap bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous" defer></script>
  <!-- dayjs + luxon (defer) -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js" defer></script>
  <!-- jQuery for Select2 (deferred usage) -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js" defer></script>
  <!-- Select2 CSS (kept) + JS lazy later -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">

  <script>
  /**********************
   * CONFIG / CONSTANTS *
   **********************/
  const DateTime = window.luxon ? window.luxon.DateTime : null;
  const overlay = () => document.getElementById('overlay').classList.toggle('show');

  // Keep your original backend base (works like first version)
  const API_BASE = `https://nahl-platform.vercel.app/api/app/AM/general/${'33e0d05d-d771-46f4-a7e7-7c634b4e3a9e'}`;
  const ROUTE_FORM = `${API_BASE}/form`;
  const ACCEPTED_MIN_DIFF = 30; // keep as reference if needed

  // State
  const state = {
    step: 1,
    locationId: null,
    serviceCatId: null,
    serviceId: null,
    dateISO: null,
    timeDisplay: null,
    timeISO: null,
    name: '',
    phoneE164: '',
    brand: '',
    carName: '',
    plate: '',
    pay: '',
    mapUrl: '',
    polygon: null,
    map: null,
    marker: null,
    infoWindow: null
  };

  const els = {
    stepper: document.querySelectorAll('.step-pill'),
    panes: [...document.querySelectorAll('.pane')],
    next: document.getElementById('btnNext'),
    prev: document.getElementById('btnPrev'),
    title: document.getElementById('pageTitle'),
    sumLocation: document.getElementById('sum-location'),
    sumService: document.getElementById('sum-service'),
    sumDate: document.getElementById('sum-date'),
    sumTime: document.getElementById('sum-time'),

    area: document.getElementById('area'),
    serviceCat: document.getElementById('serviceCat'),
    service: document.getElementById('service'),
    date: document.getElementById('date'),
    timeWrap: document.getElementById('time-wrap'),
    noSlots: document.getElementById('no-slots'),
    nextDay: document.getElementById('next-day'),

    name: document.getElementById('name'),
    mobile: document.getElementById('mobile'),
    carBrand: document.getElementById('carBrand'),
    carName: document.getElementById('carName'),
    plate: document.getElementById('plateNumber'),

    btnLocate: document.getElementById('btnLocate'),
    rebook: document.getElementById('rebook'),
  };

  /**************
   * UTIL FUNCS *
   **************/
  function showStep(n){
    state.step = n;
    els.panes.forEach(p => p.classList.toggle('active', p.id === `step${n}`));
    els.stepper.forEach(b => b.setAttribute('aria-current', +b.dataset.step === n ? 'step' : 'false'));
    const titles = {
      1:'اختر المنطقة والخدمة',
      2:'متى تحب نجيك؟',
      3:'معلومات الاتصال والمركبة',
      4:'الموقع على خريطة قوقل',
      5:'تم الحجز'
    };
    els.title.textContent = titles[n];
    els.prev.style.visibility = n === 1 ? 'hidden' : 'visible';
    els.next.textContent = n === 5 ? 'إنهاء' : (n === 4 ? 'تأكيد' : 'التالي');

    // Lazy-load heavy deps when entering relevant steps
    if(n === 3){ ensureIntlTelInput(); ensureSelect2(); }
    if(n === 4){ ensureGoogleMaps(); }

    // Disable "التالي" if step requires selection first
    validateStep(n);
  }

  function validateStep(n){
    let ok = true;
    if(n === 1){
      ok = !!els.area.value && !!els.serviceCat.value && !!els.service.value;
    } else if(n === 2){
      ok = !!state.timeDisplay && !!state.dateISO;
    } else if(n === 3){
      ok = !!els.name.value.trim() && phoneApi && phoneApi.isValidNumber();
    } else if(n === 4){
      ok = !!state.mapUrl;
    }
    els.next.disabled = !ok;
  }

  // Fetch helper with retries
  async function getJSON(url, { signal } = {}, retries = 2){
    try{
      const res = await fetch(url, { method:'GET', redirect:'follow', signal });
      if(!res.ok) throw new Error('bad status');
      return await res.json();
    }catch(e){
      if(retries>0) return getJSON(url, { signal }, retries-1);
      throw e;
    }
  }
  async function postJSON(url, body){
    const res = await fetch(url, { method:'POST', body: JSON.stringify(body), redirect:'follow' });
    if(!res.ok){
      const data = await res.json().catch(()=>({}));
      throw new Error(data?.msgAR || 'حدث خطأ غير متوقع');
    }
    return res.json();
  }

  function updateSummary(){
    // location & service
    if(state.locationId){
      const txt = els.area.options[els.area.selectedIndex]?.textContent || '';
      els.sumLocation.hidden = false;
      els.sumLocation.querySelector('span').textContent = txt;
    }
    if(state.serviceId){
      const sc = els.serviceCat.options[els.serviceCat.selectedIndex]?.textContent || '';
      const s = els.service.options[els.service.selectedIndex]?.textContent || '';
      els.sumService.hidden = false;
      els.sumService.querySelector('span').textContent = `${sc} • ${s}`;
    }
    // date & time
    if(state.dateISO){
      els.sumDate.hidden = false;
      els.sumDate.querySelector('span').textContent = state.dateISO;
    }
    if(state.timeDisplay){
      els.sumTime.hidden = false;
      els.sumTime.querySelector('span').textContent = state.timeDisplay;
    }
  }

  /********************
   * STEP 1: Services *
   ********************/
  let aborter = null;
  async function loadLocations(){
    document.getElementById('area').innerHTML = '';
    const data = await getJSON(`${ROUTE_FORM}/locations`);
    const list = (data?.data || {}).data || data?.data || [];
    const frag = document.createDocumentFragment();
    list.sort((a,b)=>a.id-b.id).forEach(loc=>{
      const opt = document.createElement('option');
      opt.value = loc.id;
      opt.textContent = loc.TS_location_arabic_name;
      frag.appendChild(opt);
    });
    els.area.appendChild(frag);
    // trigger services for first area
    if(list.length){ els.area.dispatchEvent(new Event('change')); }
  }

  async function loadServicesForArea(){
    const id = els.area.value;
    if(!id) return;
    // show loading
    els.serviceCat.innerHTML = '';
    els.service.innerHTML = '';
    const data = await getJSON(`${ROUTE_FORM}/services?location=${id}`);
    const services = data?.data?.services || [];
    const cats = data?.data?.servicesCat || [];

    // Build mapping
    const map = {};
    services.forEach(s=>{
      const cid = s.TS_category_id;
      (map[cid] ||= { cat: cats.find(c=>c.TS_category_id===cid), items: [] }).items.push(s);
    });

    // Fill categories
    const cf = document.createDocumentFragment();
    Object.keys(map).forEach(cid=>{
      const o = document.createElement('option');
      o.value = cid;
      o.textContent = map[cid].cat?.TS_category_arabic_name || `صنف ${cid}`;
      cf.appendChild(o);
    });
    els.serviceCat.appendChild(cf);

    // Fill services for first category
    fillServices(map, els.serviceCat.value);

    // On category change
    els.serviceCat.onchange = ()=> fillServices(map, els.serviceCat.value);

    function fillServices(m, cid){
      els.service.innerHTML = '';
      const frag = document.createDocumentFragment();
      (m[cid]?.items || [])
        .sort((a,b)=>a.TS_service_id-b.TS_service_id)
        .forEach(s=>{
          const o = document.createElement('option');
          o.value = s.TS_service_id;
          o.textContent = s.TS_service_arabic_name;
          frag.appendChild(o);
        });
      els.service.appendChild(frag);
      // state
      state.locationId = els.area.value;
      state.serviceCatId = els.serviceCat.value;
      state.serviceId = els.service.value;
      updateSummary();
      validateStep(1);
    }
  }

  els.area.addEventListener('change', async ()=>{
    overlay();
    try{ await loadServicesForArea(); }
    finally{ overlay(); }
  });

  els.serviceCat.addEventListener('change', ()=>{
    state.serviceCatId = els.serviceCat.value;
    updateSummary(); validateStep(1);
  });
  els.service.addEventListener('change', ()=>{
    state.serviceId = els.service.value;
    updateSummary(); validateStep(1);
  });

  /***********************
   * STEP 2: Date & time *
   ***********************/
  function initDateMin(){
    const now = DateTime.now().set({hour:0,minute:0,second:0,millisecond:0});
    els.date.min = now.toFormat('yyyy-LL-dd');
    els.date.value = now.toFormat('yyyy-LL-dd');
    state.dateISO = els.date.value;
  }
  async function loadSlots(){
    els.timeWrap.innerHTML = '';
    els.noSlots.hidden = true;

    const start = state.dateISO;
    const loc = state.locationId;
    const srv = state.serviceId;
    if(!start || !loc || !srv) return;

    const json = await getJSON(`${ROUTE_FORM}/appointments?startDate=${start}&location=${loc}&service=${srv}`);
    const list = json?.data?.appointments || [];

    if(!list.length){
      els.noSlots.hidden = false;
      validateStep(2);
      return;
    }

    const frag = document.createDocumentFragment();
    const actuals = [];
    list.forEach(x=>{
      const d = DateTime.fromISO(x.TS_appointment_time, { setZone:true });
      const display = d.toLocaleString(DateTime.TIME_SIMPLE);
      const iso = d.toFormat('HH:mm');
      actuals.push([display, iso]);

      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'time-btn';
      btn.textContent = display;
      btn.setAttribute('role','button');
      btn.setAttribute('aria-pressed', 'false');
      btn.addEventListener('click', ()=>{
        [...els.timeWrap.querySelectorAll('.time-btn')].forEach(b=>b.setAttribute('aria-pressed','false'));
        btn.setAttribute('aria-pressed','true');
        state.timeDisplay = display;
        state.timeISO = iso;
        updateSummary();
        validateStep(2);
        // auto-continue after short delay
        setTimeout(()=> showStep(3), 300);
      });
      frag.appendChild(btn);
    });
    els.timeWrap.appendChild(frag);
  }

  els.date.addEventListener('change', ()=>{
    state.dateISO = els.date.value;
    updateSummary();
    overlay(); loadSlots().finally(()=>overlay());
  });

  els.nextDay.addEventListener('click', ()=>{
    const d = DateTime.fromISO(state.dateISO).plus({days:1});
    els.date.value = d.toFormat('yyyy-LL-dd');
    els.date.dispatchEvent(new Event('change'));
  });

  /******************************
   * STEP 3: Contact & ITI/Select2
   ******************************/
  let phoneApi = null;
  function ensureIntlTelInput(){
    if(phoneApi) return;
    const script = document.createElement('script');
    script.src = "https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/intlTelInputWithUtils.js";
    script.onload = ()=>{
      phoneApi = window.intlTelInput(els.mobile, {
        utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/utils.js",
        initialCountry:"sa",
        onlyCountries:["sa","qa","ae","om","kw","bh"],
        excludeCountries:["il"],
        strictMode:true,
      });
      els.mobile.addEventListener('input', ()=> validateStep(3));
    };
    document.body.appendChild(script);
  }
  function ensureSelect2(){
    if(window.jQuery && jQuery.fn.select2) return;
    const s = document.createElement('script');
    s.src = "https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js";
    s.onload = ()=>{
      $('#carBrand').select2({ width:'100%', placeholder:'اختر' });
    };
    document.body.appendChild(s);
  }

  // Populate brands once
  const brands = ["Acura","Alfa Romeo","Aston Martin","Audi","Bentley","BMW","Bugatti","Buick","Cadillac","Chevrolet","Chrysler","Citroën","Dacia","Daewoo","Daihatsu","Dodge","Ferrari","Fiat","Ford","Genesis","GMC","Haval","Honda","Hyundai","Infiniti","Isuzu","Jaguar","Jeep","Kia","Lamborghini","Lancia","Land Rover","Lexus","Lincoln","Lotus","Maserati","Maybach","Mazda","McLaren","Mercedes-Benz","MG","Mini","Mitsubishi","Nissan","Opel","Peugeot","Porsche","RAM","Renault","Rolls-Royce","Seat","Skoda","Smart","SsangYong","Subaru","Suzuki","Tata","Tesla","Toyota","Volkswagen","Volvo"];
  function fillBrands(){
    const frag = document.createDocumentFragment();
    brands.sort().forEach(b=>{
      const o = document.createElement('option');
      o.value = b; o.textContent = b;
      frag.appendChild(o);
    });
    els.carBrand.appendChild(frag);
  }
  fillBrands();

  // Field validations
  els.name.addEventListener('input', ()=> validateStep(3));
  els.plate.addEventListener('input', (e)=>{
    e.target.value = e.target.value.replace(/\D/g,'').slice(0,4);
  });

  // Payment
  document.querySelectorAll('input[name="pay"]').forEach(r=>{
    r.addEventListener('change', ()=>{
      state.pay = r.value;
      validateStep(3);
    });
  });

  /*****************
   * STEP 4: MAPS  *
   *****************/
  let mapsLoaded = false;
  function ensureGoogleMaps(){
    if(mapsLoaded) return;
    mapsLoaded = true;
    const script = document.createElement('script');
    script.src = "https://maps.googleapis.com/maps/api/js?key=AIzaSyBBHLoO038vsCovHN-SLUgAXqexlA2v0_4&libraries=geometry,places&callback=__onMapsReady";
    script.async = true; script.defer = true;
    window.__onMapsReady = initMap;
    document.body.appendChild(script);
  }

  function initMap(){
    const center = { lat: 26.34165524787632, lng: 50.11524831545726 };
    state.map = new google.maps.Map(document.getElementById('googleMap'),{
      center, zoom: 13, gestureHandling:'greedy'
    });
    state.infoWindow = new google.maps.InfoWindow();

    // Marker
    state.marker = new google.maps.Marker({ position:center, map: state.map, draggable:true });
    google.maps.event.addListener(state.marker, 'dragend', (e)=> setPosition(e.latLng));

    // Click to set
    state.map.addListener('click', (e)=> setPosition(e.latLng));

    // Search box
    const input = document.getElementById('mapSearch');
    const searchBox = new google.maps.places.SearchBox(input);
    searchBox.addListener('places_changed', ()=>{
      const place = searchBox.getPlaces()?.[0];
      if(!place?.geometry?.location) return;
      state.map.panTo(place.geometry.location);
      state.map.setZoom(16);
      state.marker.setPosition(place.geometry.location);
      setPosition(place.geometry.location);
    });

    // Example polygon by selected area (dynamic when area changes)
    buildPolygonForArea();
  }

  function setPosition(latLng){
    if(state.polygon && !google.maps.geometry.poly.containsLocation(latLng, state.polygon)){
      state.infoWindow.setPosition(latLng);
      state.infoWindow.setContent("⚠️ خارج نطاق الخدمة");
      state.infoWindow.open(state.map);
      state.mapUrl = '';
      validateStep(4);
      return;
    }
    state.marker.setPosition(latLng);
    state.map.panTo(latLng);
    state.map.setZoom(17);
    state.mapUrl = `https://www.google.com/maps/search/?api=1&query=${latLng.lat()},${latLng.lng()}`;
    state.infoWindow.close();
    validateStep(4);
  }

  function buildPolygonForArea(){
    if(!window.google || !state.map) return;
    if(state.polygon) { state.polygon.setMap(null); state.polygon = null; }
    const selectedArea = els.area.options[els.area.selectedIndex]?.text?.trim();

    let coords = null;
    if(selectedArea === "العزيزية"){
      coords = [
        { lng: 50.215045355428195, lat: 26.219724394350184 },
        { lng: 50.2135291654911,   lat: 26.1870383495685 },
        { lng: 50.137875179099595, lat: 26.069703060741347 },
        { lng: 50.10628808282646,  lat: 26.15001891083389 },
        { lng: 50.143828288837895, lat: 26.21660551929113 },
        { lng: 50.19603263782255,  lat: 26.21897351180097 },
      ];
    } else if(selectedArea === "أجيال - أرامكو"){
      coords = [
        { lng: 50.06256215323989, lat: 26.275519772515292 },
        { lng: 50.070562455580834, lat: 26.277608292466685 },
        { lng: 50.08514528516432,  lat: 26.257720425641132 },
        { lng: 50.06822454797902,  lat: 26.24524748257814 },
        { lng: 50.06115405632103,  lat: 26.262628935642045 },
        { lng: 50.05894452767791,  lat: 26.267950423932856 },
      ];
    } else if(selectedArea === "الدوحة و الدانة"){
      coords = [
        { lng: 50.11488540829821, lat: 26.341056543806932 }, 
        { lng: 50.136645122501264, lat: 26.353671078060277 }, 
        { lng: 50.14577577434936,  lat: 26.363004767230812 }, 
        { lng: 50.178697561294584,  lat: 26.3329268498157454 }, 
        { lng: 50.17972636713662,  lat: 26.31448441448552 },
        { lng: 50.16468008169681,  lat: 26.29799900302895 }, 
      ];
    }
    if(coords){
      state.polygon = new google.maps.Polygon({
        paths: coords,
        strokeColor: "#ff0000",
        strokeOpacity: 0.35,
        strokeWeight: 2,
        fillColor: "#00ff00",
        fillOpacity: 0.08,
      });
      state.polygon.setMap(state.map);
    }
  }

  els.btnLocate?.addEventListener('click', ()=>{
    if(!navigator.geolocation){
      alert("جهازك لا يدعم تحديد الموقع."); return;
    }
    navigator.geolocation.getCurrentPosition((pos)=>{
      const ll = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
      state.map.panTo(ll);
      state.marker.setPosition(ll);
      setPosition(ll);
    }, ()=>{
      alert("تعذر الحصول على موقعك. يرجى السماح بالوصول للموقع.");
    });
  });

  /****************
   * NAVIGATION   *
   ****************/
  els.next.addEventListener('click', async ()=>{
    if(state.step === 1){
      // require fields
      if(!els.area.value){ document.getElementById('areaErr').style.display='block'; return; }
      state.locationId = els.area.value;
      state.serviceCatId = els.serviceCat.value;
      state.serviceId = els.service.value;
      updateSummary();
      showStep(2);
      overlay(); await loadSlots(); overlay();
    } else if(state.step === 2){
      if(!state.timeDisplay){ document.getElementById('dateErr').style.display='block'; return; }
      showStep(3);
    } else if(state.step === 3){
      // gather & validate
      if(!els.name.value.trim()){ document.getElementById('nameErr').style.display='block'; return; }
      if(!phoneApi || !phoneApi.isValidNumber()){ document.getElementById('phoneErr').style.display='block'; return; }
      state.name = els.name.value.trim();
      state.phoneE164 = phoneApi.getNumber().substring(1);
      state.brand = els.carBrand.value || '';
      state.carName = els.carName.value || '';
      state.plate = els.plate.value || '';
      state.pay = document.querySelector('input[name="pay"]:checked')?.value || '';
      if(!state.pay){ alert("الرجاء اختيار طريقة الدفع."); return; }
      showStep(4);
    } else if(state.step === 4){
      if(!state.mapUrl){ alert("الرجاء تحديد الموقع داخل نطاق الخدمة."); return; }
      // Submit
      overlay();
      try{
        const payload = {
          date: state.dateISO,
          time: state.timeISO,
          location: state.locationId,
          service: state.serviceId,
          serviceCount: 1,
          serviceCat: state.serviceCatId,
          customerM: state.phoneE164,
          customerN: state.name,
          paymentMethod: state.pay,
          urlLocation: state.mapUrl,
          locationDescription: [state.brand, state.carName, state.plate].filter(Boolean).join(', ')
        };
        await postJSON(`${ROUTE_FORM}/reserveAppointment`, payload);
        // remember small details (consent implied like old flow: tweak if you want modal)
        try{
          localStorage.setItem('name', state.name);
          localStorage.setItem('mobile', state.phoneE164);
        }catch(_){}
        showStep(5);
      }catch(e){
        alert(e.message || "عذرًا حصل خطأ غير متوقع الرجاء التواصل معنا");
        // bounce back to time if server rejected slot
        showStep(2);
        overlay(); await loadSlots(); overlay();
      }finally{
        overlay();
      }
    } else if(state.step === 5){
      window.location.href = "https://www.spongnsoap.com/";
    }
  });

  els.prev.addEventListener('click', ()=>{
    if(state.step>1) showStep(state.step-1);
  });

  // Summary chips jump
  document.querySelectorAll('.summary .chip button').forEach(btn=>{
    btn.addEventListener('click', ()=> showStep(+btn.dataset.goto || 1));
  });

  // Rebook CTA
  els.rebook?.addEventListener('click', ()=> window.location.reload());

  /**************
   * BOOT       *
   **************/
  async function boot(){
    // Load saved
    try{
      const nm = localStorage.getItem('name'); if(nm) els.name.value = nm;
      const ph = localStorage.getItem('mobile');
      if(ph){ ensureIntlTelInput(); setTimeout(()=> phoneApi?.setNumber(`+${ph}`), 600); }
    }catch(_){}
    // Init date
    initDateMin();
    // Load locations/services
    overlay(); await loadLocations(); overlay();
    updateSummary();
    showStep(1);
  }
  document.addEventListener('DOMContentLoaded', boot);
  // when area changes and user later visits map, rebuild polygon
  document.getElementById('area').addEventListener('change', ()=> buildPolygonForArea());

  </script>
</body>
</html>
