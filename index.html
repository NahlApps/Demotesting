<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <title>حجوزات المواعيد</title>

  <!-- Meta -->
  <meta name="title" content="حجوزات المواعيد"/>
  <meta name="description" content="✨ واكس يحمي سيارتك • 🧼 فوط نظيفة • 🛞 إسفنجة للكفرات — نهتم بكل التفاصيل. #غسيل_بدون_طوابير"/>
  <meta name="keywords" content="غسيل سيارات, حجز موعد, المنطقة الشرقية, الخبر, الدمام, سيهات, القطيف, غسيل متنقل, sponge & soap, nahl"/>

  <!-- OpenGraph / Twitter -->
  <meta property="og:type" content="website"/>
  <meta property="og:url" content="https://www.spongnsoap.com"/>
  <meta property="og:title" content="حجوزات المواعيد"/>
  <meta property="og:description" content="✨ واكس يحمي سيارتك • 🧼 فوط نظيفة • 🛞 إسفنجة للكفرات — نهتم بكل التفاصيل."/>
  <meta property="og:image" content="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/Logo%20-%20Sponge%20and%20Soap%20-%201.png"/>
  <meta property="twitter:card" content="summary_large_image"/>

  <link rel="icon" href="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/Logo%20-%20Sponge%20and%20Soap%20-%201.png"/>

  <!-- Fonts + UI libs -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/css/intlTelInput.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <style>
    :root{
      --brand:#0394b6;
      --brand-2:#48b5d0;
      --ink:#073b4c;
      --bg:#e9f7fb;
      --card:#ffffff;
      --muted:#7a8994;
      --danger:#b42318;
      --ok:#13795b;
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:'Cairo',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:#73c7d7;
      color:#fff;
      display:flex;
      align-items:stretch;
      justify-content:center;
      min-height:100vh;
    }
    a{color:inherit; text-decoration:none}

    /* Shell */
    #form{
      width:100%;
      max-width:1100px;
      background:linear-gradient(180deg,rgba(3,148,182,.92), rgba(72,181,208,.92)), url("https://www.dropbox.com/s/s9bxuykl0w49dqa/background2.jpg?raw=1") center/cover no-repeat;
      box-shadow:0 40px 90px rgba(5,28,59,.35);
      padding-bottom:24px;
      overflow:hidden;
      border-radius:0;
    }
    .header{
      text-align:center;
      padding:32px 12px 8px;
    }
    .header img{ width:190px }
    .header h1{ font-size:36px; margin:10px 0 0 }

    /* Steps indicator (compact) */
    .steps{
      display:flex; gap:8px; justify-content:center; flex-wrap:wrap; padding:8px 12px 4px;
    }
    .step-pill{
      background:rgba(255,255,255,.25); color:#fff;
      padding:8px 14px; border-radius:999px; font-weight:700; font-size:.95rem
    }
    .step-pill.active{ background:#0587a6 }

    /* Section pages */
    .page{
      display:none; flex-direction:column; align-items:center; gap:12px;
      padding:12px 10px 16px;
    }
    .page h1{font-size:30px; font-weight:800; text-align:center; margin:8px 0 6px}
    .page h2{font-size:22px; font-weight:800; margin:12px 0 6px}
    .page h3{font-size:18px; font-weight:700; margin:6px 0 12px}
    .card-pane{
      background:var(--card); color:#022b3a;
      width:calc(100% - 28px); max-width:900px;
      border-radius:var(--radius);
      box-shadow:0 12px 28px rgba(0,0,0,.09);
      padding:16px;
    }

    /* Buttons */
    .actions{display:flex; gap:10px; width:100%; max-width:900px; padding:8px 14px}
    .filter-button{
      flex:1;
      background:#fff; color:var(--brand); font-weight:800;
      border:0; border-radius:12px; padding:14px 16px;
      box-shadow:0 6px 20px rgba(0,0,0,.12);
      transition:.15s;
    }
    .filter-button:hover{ transform:translateY(-1px) }
    .filter-button.primary{ background:var(--brand); color:#fff }
    .filter-button:disabled{ opacity:.6; cursor:not-allowed }

    /* Select2 & inputs */
    .form-control, select, .select2-selection{
      border-radius:12px!important; text-align:center; border:0!important;
      box-shadow:0 2px 0 rgba(0,0,0,.05)!important;
    }
    .select2-selection{ height:44px!important; display:flex; align-items:center; }
    .select2-selection__rendered{ line-height:44px!important; width:100% }
    .select2-container{ width:100%!important }

    /* Time grid */
    .time-container{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px }
    .time-button{
      background:#fff; color:#022b3a; font-weight:800;
      border:0; border-radius:14px; padding:18px 10px;
      box-shadow:0 4px 14px rgba(0,0,0,.08);
    }
    .time-button:hover{ background:#e6f7fb }

    /* Helpers & errors */
    .helper {font-size:.85rem;color:#073b4c;opacity:.9;margin-top:4px}
    .error-msg {font-size:.85rem;color:#7a1d1d;background:#fee; border:1px solid #fcc; padding:6px 8px;border-radius:8px;display:none;margin-top:6px}
    .form-row {width:100%; max-width:900px; padding:0 16px; margin-bottom:12px}

    /* Payment */
    .pay-grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; padding:6px 16px; max-width:900px; width:100% }
    .pay-card{
      background:#fff; color:#022b3a; border-radius:12px; padding:18px; display:flex; justify-content:center; align-items:center; gap:10px;
      box-shadow:0 6px 16px rgba(0,0,0,.08); cursor:pointer; position:relative; overflow:hidden;
    }
    .pay-card input{ position:absolute; inset:0; opacity:0; cursor:pointer }
    .pay-card::after{ content:""; position:absolute; inset:0; border:2px solid transparent; border-radius:12px; transition:.15s }
    .pay-card.selected::after{ border-color:var(--brand) }
    .pay-card img{ max-width:120px; height:auto }

    .remember-wrap{display:flex;align-items:center;gap:8px;margin:6px 16px 2px; color:#073b4c}

    /* Map */
    #googleMap{ width:100%; height:430px; border-radius:14px; overflow:hidden }
    .map-shell{ position:relative }
    .map-shell.loading::after{
      content:""; position:absolute; inset:0; background:rgba(255,255,255,.55) url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 100 100"><circle cx="50" cy="50" r="32" stroke="%230394b6" stroke-width="8" fill="none" stroke-dasharray="50 180"><animateTransform attributeName="transform" type="rotate" dur="0.8s" repeatCount="indefinite" from="0 50 50" to="360 50 50"/></circle></svg>') center/72px no-repeat;
    }
    .addr-chip{
      display:flex; align-items:center; gap:8px; background:#fff; color:#045368;
      border:1px dashed #aee3ef; padding:8px 12px; border-radius:12px; margin:6px 16px 10px; max-width:900px; width:calc(100% - 32px)
    }
    .poly-hint{
      margin:6px 16px; padding:8px 10px; border-radius:10px; color:#7a3b00;
      background:#fff7ed; border:1px solid #fed7aa; max-width:900px;
    }
    .poly-error{
      margin:6px 16px; padding:8px 10px; border-radius:10px; color:#7f1d1d;
      background:#fee2e2; border:1px solid #fecaca; display:none; max-width:900px;
    }

    /* Social fabs (kept but moved if screen small) */
    .social-fab{
      position:fixed; left:15px; z-index:999; width:56px; height:56px; border-radius:50%;
      display:flex; align-items:center; justify-content:center; color:#fff; text-decoration:none;
      background:rgba(34,34,34,.55); backdrop-filter:blur(6px); -webkit-backdrop-filter:blur(6px);
      box-shadow:0 8px 20px rgba(0,0,0,.35), 0 0 0 2px rgba(255,255,255,.10) inset;
      transition:transform .18s ease, box-shadow .18s ease;
    }
    .social-fab:hover{ transform:translateY(-2px) }
    .whatsapp-button{ bottom: 15px }
    .instagram-button{ bottom: 74px }
    .tiktok-button{ bottom: 133px }

    @media (max-width: 920px){
      .time-container{ grid-template-columns:repeat(2,1fr) }
    }
    @media (max-width: 520px){
      .time-container{ grid-template-columns:1fr }
    }
  </style>
</head>
<body>

  <div id="form">
    <!-- Header -->
    <div class="header">
      <img src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/spong&Soap%20-%20logo.png" alt="Sponge & Soap"/>
    </div>

    <!-- Step pills -->
    <div class="steps">
      <div class="step-pill active" id="s1">الخدمة</div>
      <div class="step-pill" id="s2">الوقت</div>
      <div class="step-pill" id="s3">البيانات</div>
      <div class="step-pill" id="s4">الموقع</div>
      <div class="step-pill" id="s5">التأكيد</div>
    </div>

    <!-- PAGES -->
    <!-- Page 1: Hero -->
    <section id="page1" class="page" style="display:flex">
      <h1>✨ واكس يحمي سيارتك</h1>
      <h3>🧼 فوط نظيفة & لمعان مضمون<br/>🛞 إسفنجة للكفرات<br/>… نهتم بكل التفاصيل</h3>

      <div class="actions">
        <button id="page1-button" class="filter-button primary">احجز موعدك</button>
      </div>
    </section>

    <!-- Page 2: المنطقة + الخدمة -->
    <section id="page2" class="page">
      <h1>وين تحب نجيك؟<br/>اختيار المنطقة والخدمة</h1>

      <div class="card-pane">
        <div class="mb-2">
          <label class="form-label">المنطقة</label>
          <select id="area" class="js-example-basic-single"></select>
        </div>

        <div class="row g-2">
          <div class="col-12 col-md-6">
            <label class="form-label">القسم</label>
            <select id="serviceCat" class="form-control"></select>
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label">الخدمة</label>
            <select id="service" class="form-control"></select>
          </div>
        </div>

        <div class="mt-2">
          <label class="form-label">عدد السيارات</label>
          <select id="serviceCount" class="form-control">
            <option selected value="1">1</option>
            <option value="2">2</option><option value="3">3</option><option value="4">4</option>
            <option value="5">5</option><option value="6">6</option><option value="7">7</option>
            <option value="8">8</option><option value="9">9</option><option value="10">10</option>
          </select>
        </div>
      </div>

      <div class="actions">
        <button id="page2-button" class="filter-button primary">التالي</button>
      </div>
    </section>

    <!-- Page 3: (auto) fetch times -> Go to Page 4 -->
    <section id="page3" class="page">
      <div class="card-pane" style="text-align:center">
        <div class="spinner-border text-light" role="status"></div>
        <p class="mt-3">جاري جلب المواعيد…</p>
      </div>
      <div class="actions">
        <button id="page3-return" class="filter-button">السابق</button>
        <button id="page3-button" class="filter-button primary">التالي</button>
      </div>
    </section>

    <!-- Page 4: التاريخ + الأوقات -->
    <section id="page4" class="page">
      <h1>متى تحب نجيك؟<br/>اختيار الموعد</h1>

      <div class="card-pane">
        <input type="date" id="date" class="form-control mb-3" style="max-width:400px; margin-inline:auto"/>

        <div id="time-container" class="time-container"></div>

        <div id="fail-alert-3" class="alert alert-danger mt-3" style="display:none"></div>
      </div>

      <div class="actions">
        <button id="page4-return" class="filter-button">السابق</button>
      </div>
    </section>

    <!-- Page 5: معلومات الاتصال (Improved) -->
    <section id="page5" class="page">
      <h1>معلومات الاتصال</h1>

      <form id="page5-form" onsubmit="return false;" style="width:100%; max-width:900px">

        <div class="form-row">
          <label for="name" class="form-label">الإسم</label>
          <input id="name" class="form-control" type="text" autocomplete="name" inputmode="text" autocapitalize="words" required>
          <div class="helper">أكتب اسمك الأول والأخير.</div>
          <div id="err-name" class="error-msg"></div>
        </div>

        <div class="form-row">
          <label for="mobile" class="form-label">رقم الجوال</label>
          <div><input id="mobile" type="tel" class="form-control" autocomplete="tel" inputmode="tel" required></div>
          <div class="helper">صيغة السعودية: 05XXXXXXXX</div>
          <div id="err-mobile" class="error-msg"></div>
        </div>

        <h2 class="mt-2">معلومات المركبة</h2>

        <div class="form-row">
          <label for="carBrand" class="form-label">ماركة السيارة</label>
          <select id="carBrand" class="form-control"></select>
          <div class="helper">اختر الماركة من القائمة أو اكتب للبحث.</div>
        </div>

        <div class="form-row" style="display:flex; gap:12px; flex-wrap:wrap;">
          <div style="flex:1; min-width:220px;">
            <label for="carName" class="form-label">اسم السيارة</label>
            <input type="text" id="carName" class="form-control" placeholder="مثل: كامري، إلنترا" autocomplete="on" inputmode="text" oninput="updateLocationDescription()">
          </div>
          <div style="flex:1; min-width:220px;">
            <label for="plateNumber" class="form-label">رقم اللوحة</label>
            <input type="text" id="plateNumber" class="form-control" maxlength="4" inputmode="numeric" pattern="^\\d{1,4}$" required placeholder="1234">
            <div class="helper">أرقام فقط (حتى 4 خانات).</div>
            <div id="err-plate" class="error-msg"></div>
          </div>
        </div>

        <input type="text" id="locationDescription" hidden readonly>

        <h2 class="mt-2">طريقة الدفع</h2>
        <div id="payGrid" class="pay-grid">
          <label class="pay-card">
            <input type="radio" name="payingMethod" value="STC Pay" required/>
            <img src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/STC%20PAY%20LOGO.png" alt="STC Pay"/>
          </label>
          <label class="pay-card">
            <input type="radio" name="payingMethod" value="Cash" required/>
            <span style="font-weight:800; font-size:1.2rem;">Cash</span>
          </label>
          <label class="pay-card" style="grid-column:1 / -1;">
            <input type="radio" name="payingMethod" value="MADA" required/>
            <img src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/MADA%20LOGO.png" alt="MADA" style="max-width:180px"/>
          </label>
        </div>

        <div class="remember-wrap">
          <input type="checkbox" id="rememberMe"/>
          <label for="rememberMe" style="margin:0">تذكّر بياناتي على هذا الجهاز للحجوزات القادمة</label>
        </div>
      </form>

      <div class="actions">
        <button id="page5-return" class="filter-button">السابق</button>
        <button id="page5-button" class="filter-button primary">التالي</button>
      </div>
    </section>

    <!-- Page 6: الخريطة (Improved) -->
    <section id="page6" class="page">
      <h1>الموقع على خريطة قوقل</h1>

      <div class="addr-chip" id="addressPreview" style="display:none;">
        <i class="fa-solid fa-location-dot"></i>
        <span id="addressText">—</span>
      </div>

      <div class="card-pane map-shell loading" id="mapShell">
        <div class="mb-2">
          <input id="placeSearch" class="form-control" placeholder="ابحث بالعنوان أو اسم المكان" />
        </div>
        <div id="googleMap"></div>
        <div id="mapError" class="alert alert-danger mt-2" style="display:none">تعذر تحميل الخريطة. جرّب إعادة التحميل.</div>
      </div>

      <div class="poly-hint">يجب أن يكون موقعك داخل النطاق المحدد. سيظهر تحذير إذا خرجت عن الحدود.</div>
      <div class="poly-error" id="polyError">الموقع الحالي خارج نطاق الخدمة. انقل الدبوس إلى داخل المنطقة.</div>

      <div class="actions">
        <button id="page6-return" class="filter-button">السابق</button>
        <button id="show-my-location" class="filter-button">اظهار موقعي</button>
        <button id="page6-button" class="filter-button primary" disabled>التالي</button>
      </div>

      <div id="page6-spinner" class="d-flex flex-column align-items-center" style="display:none">
        <div class="spinner-border text-light mt-1" role="status"></div>
        <span class="mt-2">جار تأكيد الحجز…</span>
      </div>
      <div id="fail-alert-5" class="alert alert-danger mt-3" style="display:none"></div>
    </section>

    <!-- Page 7: نجاح -->
    <section id="page7" class="page">
      <h1>شكراً لكم</h1>
      <h3>تم حجز الموعد، وراح نأكده لكم على الواتساب</h3>
      <div class="actions">
        <button id="rebook" class="filter-button primary">🔁 حجز جديد</button>
      </div>
    </section>

    <!-- Footer -->
    <footer class="text-center mt-2" style="opacity:.95">
      <div>Sponge & Soap</div>
      <a target="_blank" href="https://www.instagram.com/nahl.app">Made with Nahl Perfection</a>
    </footer>
  </div>

  <!-- Social FABs (kept) -->
  <a target="_blank" href="https://wa.me/966503668222" class="social-fab whatsapp-button" aria-label="واتساب"><i class="fab fa-whatsapp"></i></a>
  <a target="_blank" href="https://www.instagram.com/sponge.soap_sa" class="social-fab instagram-button" aria-label="إنستغرام"><i class="fab fa-instagram"></i></a>
  <a target="_blank" href="https://www.tiktok.com/@sponge.soap_sa" class="social-fab tiktok-button" aria-label="تيك توك"><i class="fab fa-tiktok"></i></a>

  <!-- Terms Modal -->
  <div class="modal fade" id="termsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">الشروط والأحكام</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
        </div>
        <div class="modal-body">
          <p>بالضغط على "تأكيد ومتابعة" أنت توافق على شروط خدمة المغسلة وسياسة الإلغاء والتعويض…</p>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="termsAccept">
            <label class="form-check-label" for="termsAccept">أوافق على الشروط</label>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
          <button class="btn btn-primary" id="confirmTerms" disabled>تأكيد ومتابعة</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Libs -->
  <script src="https://code.jquery.com/jquery-3.6.3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/intlTelInputWithUtils.js"></script>

  <script>
    // ---------- Config ----------
    const DateTime = luxon.DateTime;
    const defaultLink2 = `https://nahl-platform.vercel.app/api/app/AM/general/33e0d05d-d771-46f4-a7e7-7c634b4e3a9e/form`;

    // ---------- State ----------
    let nForm = {
      date:'', time:'', location:'', service:'', serviceCount:'', serviceCat:'',
      customerM:'', customerN:'', paymentMethod:'', urlLocation:'', locationDescription:''
    };
    let appointments=[[],[],[]], ActualTimes=[[],[],[]], timesLoaded=false;
    let day1=DateTime.now(), day2=day1.plus({days:1}), day3=day1.plus({days:2});
    let polygon=null, map=null, marker=null, infoWindow=null, geocoder=null;
    let defaultLocation={lat: 26.34165524787632, lng: 50.11524831545726};
    let position="", insideServiceArea=false, submitting=false;

    // ---------- Helpers ----------
    function setStep(ix){
      document.querySelectorAll('.step-pill').forEach((p,i)=> p.classList.toggle('active', i<=ix-1));
    }

    function showPage(id){
      document.querySelectorAll('.page').forEach(p=> p.style.display='none');
      document.getElementById(id).style.display='flex';
      window.scrollTo({top:0, behavior:'smooth'});
    }

    function setNextEnabled(can){
      const btn = document.getElementById('page6-button');
      btn.disabled = !can;
      btn.style.opacity = can ? '1' : '.6';
    }

    // ---------- Page 1 ----------
    document.getElementById('page1-button').onclick = ()=>{ showPage('page2'); setStep(1); };

    // ---------- Load Locations/Services ----------
    async function callContent2(path, cb, abortable=false, retries=3){
      try{
        const res = await fetch(defaultLink2 + path, {method:'GET'});
        if(!res.ok) throw new Error('bad');
        cb(await res.json());
      }catch(e){
        if(retries>0) return callContent2(path, cb, abortable, retries-1);
        console.warn('API error:', e);
      }
    }

    // locations
    $('.js-example-basic-single').select2({ width:'100%', placeholder:'اختر المنطقة' });
    callContent2('/locations', data=>{
      const sel = $('#area'); sel.empty();
      (data?.data||[]).forEach(loc=> sel.append(new Option(loc.TS_location_arabic_name, loc.id)));
      sel.trigger('change');
    });

    // Services by location
    $('#area').on('change', ()=>{
      callContent2(`/services?location=${$('#area').val()}`, data=>{
        const cats = data?.data?.servicesCat || [];
        const svcs = data?.data?.services || [];
        const catById = {}; cats.forEach(c=> catById[c.TS_category_id]=c);

        // fill cat
        const catSel = $('#serviceCat'); const svcSel = $('#service');
        catSel.empty(); svcSel.empty();
        const grouped = {};
        svcs.forEach(s=>{
          if(!grouped[s.TS_category_id]) grouped[s.TS_category_id] = [];
          grouped[s.TS_category_id].push(s);
        });
        Object.keys(grouped).forEach(cid=>{
          const c = catById[cid];
          catSel.append(new Option(c.TS_category_arabic_name, cid));
        });
        catSel.trigger('change');

        catSel.off('change').on('change', ()=>{
          const cid = catSel.val();
          svcSel.empty();
          (grouped[cid]||[]).sort((a,b)=> a.TS_service_id-b.TS_service_id)
            .forEach(s=> svcSel.append(new Option(s.TS_service_arabic_name, s.TS_service_id)));
          svcSel.trigger('change');
        });

        // prime values
        $('#serviceCat').trigger('change');
      });
    });

    // ---------- Page 2 -> 3 ----------
    document.getElementById('page2-button').onclick = ()=>{
      const area = $('#area').val(), cat=$('#serviceCat').val(), svc=$('#service').val();
      if(!area || !cat || !svc){ alert('رجاءً اختر المنطقة والخدمة.'); return; }
      nForm.location=area; nForm.serviceCat=cat; nForm.service=svc; nForm.serviceCount=$('#serviceCount').val();
      showPage('page3'); setStep(2);

      // fetch appointments for selected date (today default)
      const d = DateTime.now().toFormat('yyyy-MM-dd');
      document.getElementById('date').value = d;
      loadAppointmentsFor(d);
      // auto-advance after load (same as قبل)
      setTimeout(()=> document.getElementById('page3-button').click(), 1200);
    };

    // ---------- Page 3 -> 4 ----------
    document.getElementById('page3-return').onclick = ()=> showPage('page2');
    document.getElementById('page3-button').onclick = ()=> { showPage('page4'); setStep(2); };

    // ---------- Appointments ----------
    function loadAppointmentsFor(isoDate){
      const area=$('#area').val(), svc=$('#service').val();
      $('#time-container').innerHTML='';
      callContent2(`/appointments?startDate=${isoDate}&location=${area}&service=${svc}`, data=>{
        appointments=[[],[],[]]; ActualTimes=[[],[],[]];
        const list = data?.data?.appointments || [];
        list.forEach(rec=>{
          const d = DateTime.fromISO(rec.TS_appointment_date, { setZone:true }).toISODate();
          const t = DateTime.fromISO(rec.TS_appointment_time, { setZone:true });
          const human = t.toLocaleString(DateTime.TIME_SIMPLE).replace(' ', ' ');
          const machine = t.toFormat('hh:mm a');
          const d1 = DateTime.fromISO(isoDate);
          const d2 = d1.plus({days:1}).toISODate();
          const d3 = d1.plus({days:2}).toISODate();
          if(d===isoDate){ appointments[0].push(human); ActualTimes[0].push(machine); }
          else if(d===d2){ appointments[1].push(human); ActualTimes[1].push(machine); }
          else if(d===d3){ appointments[2].push(human); ActualTimes[2].push(machine); }
        });
        timesLoaded=true;
        renderDay(0, isoDate);
      });
    }

    function renderDay(index, baseISO){
      const c = document.getElementById('time-container');
      c.innerHTML='';
      const arr = appointments[index];
      if(!arr.length){ c.innerHTML='<div class="text-center text-muted">لا توجد مواعيد متاحة</div>'; return; }
      arr.forEach((human,i)=>{
        const btn = document.createElement('button');
        btn.className='time-button';
        btn.dir='ltr';
        btn.textContent=human;
        btn.onclick=()=> choosedDate(ActualTimes[index][i], DateTime.fromISO(baseISO).plus({days:index}).toISODate(), 4);
        c.appendChild(btn);
      });
    }

    document.getElementById('date').setAttribute('min', DateTime.now().toFormat('yyyy-MM-dd'));
    document.getElementById('date').addEventListener('change', (e)=>{
      const iso = e.target.value;
      loadAppointmentsFor(iso);
    });

    function choosedDate(time12, dateISO, pageIndex){
      const t = DateTime.fromFormat(time12, "h:mm a");
      nForm.date = dateISO;
      nForm.time = t.toFormat('HH:mm');
      showPage('page5'); setStep(3);
    }

    // ---------- Page 4 back ----------
    document.getElementById('page4-return').onclick = ()=> showPage('page2');

    // ---------- Intl Tel Input ----------
    const phoneInput = document.querySelector('#mobile');
    const iti = window.intlTelInput(phoneInput,{
      utilsScript:"https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/utils.js",
      initialCountry:"sa",
      onlyCountries:["sa","qa","ae","om","kw","bh"],
      excludeCountries:["il"],
      countryOrder:["sa","qa"],
      strictMode:true,
      i18n:{ ae:"الإمارات العربية المتحدة", bh:"البحرين", kw:"الكويت", sa:"المملكة العربية السعودية" }
    });

    const errorMap=["رقم غير صحيح","رمز دولة غير صحيح","المُدخل أقصر من المتوقع","المُدخل أطول من المتوقع","رقم غير صحيح"];

    function checkNumberValidity(){
      const phoneNumber = iti.getNumber().substring(1);
      if(isNaN(phoneNumber) || !iti.isValidNumber() || !phoneNumber){
        const msg = errorMap[iti.getValidationError()] || "رقم غير صحيح";
        document.getElementById('err-mobile').style.display='block';
        document.getElementById('err-mobile').textContent=msg;
        return false;
      }
      document.getElementById('err-mobile').style.display='none';
      return true;
    }

    // ---------- Page 5 UX ----------
    const errName=document.getElementById('err-name');
    const errPlate=document.getElementById('err-plate');

    document.getElementById('name').addEventListener('input', e=>{
      if(e.target.value.trim().length<2){ errName.style.display='block'; errName.textContent='رجاءً أدخل اسمًا صحيحًا.'; }
      else errName.style.display='none';
    });

    document.getElementById('plateNumber').addEventListener('input', function(){
      this.value = this.value.replace(/\D/g,'').slice(0,4);
      if(!/^\d{1,4}$/.test(this.value)){ errPlate.style.display='block'; errPlate.textContent='أدخل من 1 إلى 4 أرقام.'; }
      else errPlate.style.display='none';
      updateLocationDescription();
    });

    // car brands
    const carBrands=["Acura","Alfa Romeo","Aston Martin","Audi","Bentley","BMW","Bugatti","Buick","Cadillac","Chevrolet","Chrysler","Citroën","Dacia","Daewoo","Daihatsu","Dodge","Ferrari","Fiat","Ford","Genesis","GMC","Haval","Holden","Honda","Hummer","Hyundai","Infiniti","Isuzu","Jaguar","Jeep","Kia","Koenigsegg","Lada","Lamborghini","Lancia","Land Rover","Lexus","Lincoln","Lotus","Maserati","Maybach","Mazda","McLaren","Mercedes-Benz","Mercury","MG","Mini","Mitsubishi","Nissan","Opel","Pagani","Peugeot","Plymouth","Pontiac","Porsche","RAM","Renault","Rolls-Royce","Saab","Saturn","Scion","Seat","Skoda","Smart","SsangYong","Subaru","Suzuki","Tata","Tesla","Toyota","Volkswagen","Volvo","Wiesmann","Zotye"].sort();
    const carBrandSel = $('#carBrand'); carBrandSel.empty();
    carBrandSel.append(new Option('اختر...', '', true, true));
    carBrands.forEach(b=> carBrandSel.append(new Option(b, b)));
    carBrandSel.select2({ placeholder:'اختر الماركة', allowClear:true });

    function updateLocationDescription(){
      const brand=$('#carBrand').val()||'';
      const name=$('#carName').val()||'';
      const plate=$('#plateNumber').val()||'';
      const desc=[brand,name,plate].filter(Boolean).join(', ');
      document.getElementById('locationDescription').value=desc;
    }

    // payment visuals
    document.querySelectorAll('.pay-card input[name="payingMethod"]').forEach(r=>{
      r.addEventListener('change', ()=>{
        document.querySelectorAll('.pay-card').forEach(c=>c.classList.remove('selected'));
        r.closest('.pay-card').classList.add('selected');
      });
    });

    // prefill remember
    try{
      if(localStorage.getItem('remember')==='1'){
        document.getElementById('rememberMe').checked=true;
        if(localStorage.getItem('name')) document.getElementById('name').value = localStorage.getItem('name');
        if(localStorage.getItem('mobile')) iti.setNumber('+'+localStorage.getItem('mobile'));
      }
    }catch(_){}

    document.getElementById('page5-return').onclick = ()=> showPage('page4');

    document.getElementById('page5-button').onclick = ()=>{
      const nameEl=document.getElementById('name');
      if(nameEl.value.trim().length<2){ errName.style.display='block'; errName.textContent='رجاءً أدخل اسمًا صحيحًا.'; return; }
      if(!checkNumberValidity()) return;

      nForm.customerN = nameEl.value.trim();
      nForm.customerM = iti.getNumber().substring(1);
      nForm.paymentMethod = document.querySelector('input[name="payingMethod"]:checked')?.value || '';

      updateLocationDescription();
      nForm.locationDescription = document.getElementById('locationDescription').value;

      try{
        if(document.getElementById('rememberMe').checked){
          localStorage.setItem('name', nForm.customerN);
          localStorage.setItem('mobile', nForm.customerM);
          localStorage.setItem('remember','1');
        }else{
          localStorage.removeItem('name'); localStorage.removeItem('mobile'); localStorage.setItem('remember','0');
        }
      }catch(_){}

      showPage('page6'); setStep(4);
    };

    // ---------- Map ----------
    const prePosition = "https://www.google.com/maps/search/?api=1&query=";

    window.myMap = function(){
      try{
        setNextEnabled(false);
        map = new google.maps.Map(document.getElementById("googleMap"), {
          center: defaultLocation, zoom: 12, disableDoubleClickZoom: true,
          mapTypeControl:true, streetViewControl:false, fullscreenControl:false
        });
        infoWindow = new google.maps.InfoWindow();
        marker = new google.maps.Marker({ position: defaultLocation, map, draggable:true, title:"اضغط أو اسحب لتحديد الموقع" });
        marker.addListener("dragend", (e)=> validateAndSetPosition(e.latLng));
        map.addListener("click", (e)=> validateAndSetPosition(e.latLng));

        // Places autocomplete
        if (google?.maps?.places){
          const ac = new google.maps.places.Autocomplete(document.getElementById('placeSearch'), { fields:['geometry'] });
          ac.addListener('place_changed', ()=>{
            const p = ac.getPlace();
            if (!p?.geometry?.location) return;
            validateAndSetPosition(p.geometry.location);
          });
        }

        document.getElementById('mapShell').classList.remove('loading');
      }catch(err){
        document.getElementById('mapShell').classList.remove('loading');
        document.getElementById('mapError').style.display='block';
      }
    };

    function updateAddressPreview(latLng){
      if(!geocoder && window.google) geocoder = new google.maps.Geocoder();
      if(!geocoder) return;

      geocoder.geocode({ location: latLng }, (results, status)=>{
        const prev = document.getElementById('addressPreview');
        const text = document.getElementById('addressText');
        if(status === 'OK' && results && results[0]){
          text.textContent = results[0].formatted_address;
          prev.style.display = 'flex';
        }else{
          text.textContent = 'تم تعيين الموقع';
          prev.style.display = 'flex';
        }
      });
    }

    function validateAndSetPosition(latLng){
      const polyErr = document.getElementById('polyError');
      insideServiceArea = !polygon || google.maps.geometry.poly.containsLocation(latLng, polygon);
      if(!insideServiceArea){ polyErr.style.display='block'; setNextEnabled(false); }
      else{ polyErr.style.display='none'; setNextEnabled(true); }

      marker.setPosition(latLng);
      map.panTo(latLng);
      map.setZoom(17);
      position = `${prePosition}${latLng.lat()},${latLng.lng()}`;
      if(!infoWindow) infoWindow=new google.maps.InfoWindow();
      infoWindow.setContent(insideServiceArea ? "✅ تم تحديد موقعك هنا" : "⚠️ خارج نطاق الخدمة");
      infoWindow.open(map, marker);
      updateAddressPreview(latLng);
    }
    window.validateAndSetPosition = validateAndSetPosition;

    function setBoundries(){
      const selectedArea = $('#area option:selected').text().trim();
      let polygonCoords=null;

      if (selectedArea==="العزيزية"){
        polygonCoords = [
          { lng: 50.215045355428195, lat: 26.219724394350184 },
          { lng: 50.2135291654911,   lat: 26.1870383495685 },
          { lng: 50.137875179099595, lat: 26.069703060741347 },
          { lng: 50.10628808282646,  lat: 26.15001891083389 },
          { lng: 50.143828288837895, lat: 26.21660551929113 },
          { lng: 50.19603263782255,  lat: 26.21897351180097 },
        ];
      } else if (selectedArea==="أجيال - أرامكو"){
        polygonCoords = [
          { lng: 50.06256215323989, lat: 26.275519772515292 },
          { lng: 50.070562455580834, lat: 26.277608292466685 },
          { lng: 50.08514528516432,  lat: 26.257720425641132 },
          { lng: 50.06822454797902,  lat: 26.24524748257814 },
          { lng: 50.06115405632103,  lat: 26.262628935642045 },
          { lng: 50.05894452767791,  lat: 26.267950423932856 },
        ];
      } else if (selectedArea==="الدوحة و الدانة"){
        polygonCoords = [
          { lng: 50.11488540829821, lat: 26.341056543806932 },
          { lng: 50.136645122501264, lat: 26.353671078060277 },
          { lng: 50.14577577434936,  lat: 26.363004767230812 },
          { lng: 50.178697561294584, lat: 26.3329268498157454 },
          { lng: 50.17972636713662,  lat: 26.31448441448552 },
          { lng: 50.16468008169681,  lat: 26.29799900302895 },
        ];
      }

      if (polygon) polygon.setMap(null);
      if (polygonCoords){
        polygon = new google.maps.Polygon({
          paths: polygonCoords,
          strokeColor:"#0ea5e9", strokeOpacity:.9, strokeWeight:2.5,
          fillColor:"#38bdf8", fillOpacity:.12,
        });
        polygon.setMap(map);
      }
      setNextEnabled(false);
      document.getElementById('addressPreview').style.display='none';
    }
    window.setBoundries=setBoundries;

    // When area changes (any page)
    $('#area').on('change', ()=>{ if(map) setBoundries(); });

    // locate me
    function detectMyLocation(){
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition((pos)=>{
          const userPos = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
          validateAndSetPosition(userPos);
        }, ()=> handleLocationError(true));
      }else handleLocationError(false);
    }
    document.getElementById('show-my-location').addEventListener('click', detectMyLocation);

    function handleLocationError(browserHasGeolocation){
      if(!infoWindow) infoWindow=new google.maps.InfoWindow();
      infoWindow.setPosition(map.getCenter());
      infoWindow.setContent(browserHasGeolocation ? "⚠️ تعذر الحصول على موقعك. يرجى السماح بالوصول للموقع." : "⚠️ جهازك لا يدعم تحديد الموقع.");
      infoWindow.open(map);
    }

    // Page 6 buttons
    document.getElementById('page6-return').onclick = ()=> showPage('page5');

    document.getElementById('page6-button').onclick = ()=>{
      if(submitting) return;
      if (!position || !insideServiceArea){
        alert("حدّد موقعًا داخل نطاق الخدمة أولاً."); return;
      }
      const modal = new bootstrap.Modal(document.getElementById('termsModal'));
      const cb = document.getElementById('termsAccept');
      const btn = document.getElementById('confirmTerms');
      cb.checked=false; btn.disabled=true; cb.onchange=()=> btn.disabled=!cb.checked;
      modal.show();
      btn.onclick = ()=>{
        modal.hide();
        submitReservation();
      };
    };

    function submitReservation(){
      submitting=true; setNextEnabled(false);
      document.getElementById("page6-spinner").style.display="flex";
      nForm.urlLocation = position;

      fetch(defaultLink2 + `/reserveAppointment`, { method:'POST', body: JSON.stringify(nForm) })
        .then(async res=>{
          submitting=false; document.getElementById("page6-spinner").style.display="none";
          if(!res.ok){ const j=await res.json().catch(()=>({})); throw j; }
          showPage('page7'); setStep(5);
        })
        .catch(err=>{
          submitting=false; document.getElementById("page6-spinner").style.display="none";
          const msgAR = err?.msgAR || "عذرًا حصل خطأ غير متوقع الرجاء التواصل معنا";
          const fail = document.getElementById("fail-alert-5");
          fail.style.display='block'; fail.textContent = msgAR;
          showPage('page4'); setStep(2);
          $('#date').trigger('change');
        });
    }

    // Rebook
    document.getElementById('rebook').onclick = ()=> location.href = "https://www.spongnsoap.com/";

    // Prime today
    document.getElementById('date').value = DateTime.now().toFormat('yyyy-MM-dd');
  </script>

  <!-- Google Maps (with places + geometry for polygon & containsLocation) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBBHLoO038vsCovHN-SLUgAXqexlA2v0_4&callback=myMap&libraries=places,geometry" async defer></script>
</body>
</html>
