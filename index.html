<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>حجوزات المواعيد</title>

  <!-- Icons / Fonts -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800&display=swap" rel="stylesheet"/>

  <!-- Bootstrap (used for modal if you add one later) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <!-- Select2 -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

  <!-- intl-tel-input -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/css/intlTelInput.css">

  <style>
  /* -----------------------------
     Design Tokens (sizing tuned)
  ----------------------------- */
  :root{
    --brand:#028aa7;
    --brand-2:#48b5d0;
    --ink:#062d3a;
    --bg:#e9f7fb;
    --card:#ffffff;

    --radius:14px;
    --shadow-lg:0 24px 64px rgba(5,28,59,.22);
    --shadow-md:0 10px 28px rgba(5,28,59,.14);
    --shadow-sm:0 6px 16px rgba(5,28,59,.10);
    --transition:.28s cubic-bezier(.22,.61,.36,1);

    --header-h:56px;
    --footer-h:72px;
  }
  @media (min-width:576px){
    :root{ --header-h:64px; --footer-h:74px; }
  }
  @media (min-width:992px){
    :root{ --header-h:72px; --footer-h:78px; }
  }

  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{
    margin:0;
    font-family:'Cairo', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background:
      linear-gradient(180deg, rgba(2,138,167,.92), rgba(72,181,208,.92)),
      url("https://www.dropbox.com/s/s9bxuykl0w49dqa/background2.jpg?raw=1") center/cover no-repeat fixed;
    color:#fff;
    min-height:100vh;
    display:flex;
    flex-direction:column;
    padding-top:var(--header-h);
    padding-bottom:var(--footer-h);
  }

  /* ======= HEADER ======= */
  header{
    position:sticky; top:0; z-index:50;
    display:flex; justify-content:center; align-items:center;
    height:var(--header-h);
    background:rgba(2, 56, 70, .38);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-bottom:1px solid rgba(255,255,255,.15);
    box-shadow:0 10px 30px rgba(0,0,0,.12);
  }
  header .container{
    max-width:1120px; width:100%; padding:0 12px;
    display:flex; align-items:center; justify-content:space-between;
  }
  header .brand{
    display:flex; align-items:center; gap:10px;
  }
  header .brand img{
    width:136px; filter: drop-shadow(0 6px 20px rgba(0,0,0,.25));
  }
  @media (min-width:576px){ header .brand img{ width:160px } }
  @media (min-width:992px){ header .brand img{ width:180px } }

  header .mini-progress{
    display:flex; align-items:center; gap:10px; min-width:160px; width:46%;
  }
  .mini-progress .bar{
    flex:1; height:5px; background:rgba(255,255,255,.25); border-radius:999px; overflow:hidden;
  }
  @media (min-width:992px){ .mini-progress .bar{ height:6px } }
  .mini-progress .bar > span{
    display:block; height:100%; width:0%;
    background:linear-gradient(90deg,#00b7d6,#48b5d0);
    transition:width var(--transition);
  }
  .mini-progress .step{ font-weight:800; font-size:.9rem; color:#fff; white-space:nowrap }
  @media (min-width:576px){ .mini-progress .step{ font-size:1rem } }

  /* ======= MAIN ======= */
  main{
    flex:1 0 auto;
    display:flex;
    justify-content:center;
    align-items:stretch;
    padding:8px 10px 0;
  }
  #app{ width:100%; max-width:1120px }

  /* Steps */
  .steps-wrap{ padding:6px 14px 0 }
  .steps{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; padding:0; margin:0; list-style:none }
  .step-pill{
    background:rgba(255,255,255,.25); color:#fff; font-weight:800;
    font-size:.9rem; padding:8px 12px; border-radius:999px; transition:var(--transition);
  }
  @media (min-width:576px){ .step-pill{ font-size:1rem; padding:8px 14px } }
  .step-pill.active{ background:#056e86; box-shadow:inset 0 -2px 0 rgba(255,255,255,.15) }
  .progress-line{ height:5px; background:rgba(255,255,255,.25); border-radius:999px; overflow:hidden; width:calc(100% - 32px); margin:8px auto 0 }
  @media (min-width:992px){ .progress-line{ height:6px } }
  .progress-line > span{ display:block; height:100%; width:0%; background:linear-gradient(90deg,#00b7d6,#48b5d0); border-radius:999px; transition:width var(--transition) }

  /* Stage / pages */
  .stage{ position:relative; min-height:520px; padding:8px 0 16px }
  .page{
    display:flex; flex-direction:column; align-items:center; gap:12px;
    padding:14px 10px 18px;
    opacity:0; transform:translateY(14px) scale(.99);
    pointer-events:none;
    transition:opacity var(--transition), transform var(--transition);
    position:absolute; inset:0; overflow:auto;
  }
  .page.active{ opacity:1; transform:translateY(0) scale(1); pointer-events:auto; position:relative }
  .page.exit{ opacity:0; transform:translateY(18px) scale(.985) }

  /* Typography scale */
  .page h1{ font-size:28px; font-weight:800; text-align:center; margin:6px 0 4px }
  .page h2{ font-size:22px; font-weight:800; margin:10px 0 6px }
  .page h3{ font-size:18px; font-weight:700; margin:2px 0 8px }
  @media (min-width:576px){
    .page h1{ font-size:30px }
    .page h2{ font-size:24px }
    .page h3{ font-size:19px }
  }
  @media (min-width:992px){ .page h1{ font-size:32px } }

  /* Cards & controls */
  .card-pane{
    width:calc(100% - 24px); max-width:900px; background:var(--card); color:#022b3a;
    border-radius:var(--radius); padding:16px; box-shadow:var(--shadow-md);
  }
  .form-control, select, .select2-selection{
    border-radius:12px!important; text-align:center; border:0!important;
    box-shadow:0 2px 0 rgba(0,0,0,.05)!important; min-height:48px; font-size:1rem;
  }
  .select2-selection{ height:48px!important; display:flex; align-items:center }
  .select2-selection__rendered{ line-height:48px!important }

  .time-container{ display:grid; grid-template-columns:repeat(2,1fr); gap:10px }
  @media (min-width:576px){ .time-container{ grid-template-columns:repeat(3,1fr) } }
  .time-option{
    background:#fff; color:#022b3a; font-weight:800; border:0; border-radius:14px; padding:16px 10px;
    min-height:48px; font-size:1rem; box-shadow:var(--shadow-sm); transition:var(--transition);
  }
  .time-option[aria-checked="true"]{ outline:3px solid var(--brand) }
  .time-option:hover{ transform:translateY(-1px); background:#e9fbff }

  .pay-grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; padding:6px 0; max-width:900px; width:100% }
  .pay-card{
    background:#fff; color:#022b3a; border-radius:12px; padding:16px; display:flex; justify-content:center; align-items:center; gap:10px;
    min-height:64px; box-shadow:var(--shadow-sm); cursor:pointer; position:relative; overflow:hidden; transition:var(--transition);
    outline:2px solid transparent;
  }
  .pay-card[aria-checked="true"]{ outline-color:var(--brand) }
  .pay-card:hover{ transform:translateY(-2px) }
  .pay-card img{ max-width:120px; height:auto }

  /* Map */
  #googleMap{ width:100%; height:400px; border-radius:14px; overflow:hidden }
  @media (min-width:576px){ #googleMap{ height:430px } }
  .map-shell{ position:relative }
  .poly-error{ margin-top:8px; padding:8px 10px; border-radius:10px; color:#7f1d1d; background:#fee2e2; border:1px solid #fecaca; display:none }

  /* ======= FOOTER (sticky) ======= */
  footer.sticky-nav{
    position:sticky; bottom:0; z-index:40;
    height:var(--footer-h);
    background:rgba(2, 56, 70, .45);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-top:1px solid rgba(255,255,255,.15);
    box-shadow:0 -10px 30px rgba(0,0,0,.12);
    display:flex; align-items:center; justify-content:center;
  }
  .footer-inner{
    max-width:1120px; width:100%; padding:8px 12px;
    display:flex; gap:10px; align-items:center;
  }
  .footer-actions{ display:flex; gap:10px; flex:1 }
  .btn-footer{
    flex:1; border:0; border-radius:12px; padding:12px 16px;
    min-height:48px; font-size:1rem; font-weight:800;
    box-shadow:var(--shadow-sm); transition:var(--transition);
    background:#ffffff; color:var(--brand);
  }
  .btn-footer.primary{ background:var(--brand); color:#fff }
  .btn-footer:disabled{ opacity:.6; cursor:not-allowed }
  .footer-brand{ display:none; align-items:center; gap:8px; color:#e0f5fb; font-weight:700 }
  @media (min-width:992px){ .footer-brand{ display:flex } }

  /* Hide page-local nav buttons (we use footer only) */
  [id^="page"][id$="-button"],
  [id^="page"][id$="-return"]{
    display:none !important;
  }
  #footer-next.is-confirm{ background:#0f766e; }

  /* Social FABs offset from footer */
  .social-fab{
    position:fixed; left:15px; z-index:999; width:54px; height:54px; border-radius:50%;
    display:flex; align-items:center; justify-content:center; color:#fff; text-decoration:none;
    background:rgba(34,34,34,.55); backdrop-filter:blur(6px);
    box-shadow:0 8px 20px rgba(0,0,0,.35), 0 0 0 2px rgba(255,255,255,.10) inset;
    transition:transform .18s ease, box-shadow .18s ease;
  }
  .social-fab:hover{ transform:translateY(-2px) }
  .whatsapp-button{ bottom:calc(var(--footer-h) + 14px) }
  .instagram-button{ bottom:calc(var(--footer-h) + 74px) }
  .tiktok-button{ bottom:calc(var(--footer-h) + 134px) }

  .visually-hidden{
    position:absolute!important; height:1px; width:1px; overflow:hidden; clip:rect(1px,1px,1px,1px);
    white-space:nowrap; border:0; padding:0; margin:-1px
  }
  </style>
</head>
<body>

  <!-- ===== Header ===== -->
  <header>
    <div class="container">
      <div class="mini-progress">
        <div class="bar" aria-hidden="true"><span style="width:14%"></span></div>
        <div class="step">الخدمة</div>
      </div>
      <div class="brand">
        <img src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/spong&Soap%20-%20logo.png" alt="Sponge &amp; Soap" />
      </div>
    </div>
  </header>

  <!-- ===== Body ===== -->
  <main>
    <div id="app">
      <!-- Steps -->
      <div class="steps-wrap">
        <ul class="steps" aria-label="خطوات الحجز">
          <li class="step-pill active">الخدمة</li>
          <li class="step-pill">الوقت</li>
          <li class="step-pill">البيانات</li>
          <li class="step-pill">الموقع</li>
          <li class="step-pill">التأكيد</li>
        </ul>
        <div class="progress-line"><span style="width:14%"></span></div>
      </div>

      <!-- Stage -->
      <div class="stage">

        <!-- Page 1: Intro / CTA -->
        <section id="page1" class="page active" aria-label="الترحيب">
          <h1>✨ واكس يحمي سيارتك</h1>
          <div class="card-pane" style="text-align:center">
            <p style="margin:0 0 14px">🧼 فوط نظيفة &nbsp;•&nbsp; لمعان مضمون &nbsp;•&nbsp; 🛞 إسفنجة للكفرات</p>
            <button id="page1-button" class="btn btn-primary" type="button">احجز موعدك</button>
          </div>
        </section>

        <!-- Page 2: Location + Service -->
        <section id="page2" class="page" aria-label="اختيار المنطقة والخدمة">
          <h1>وين تحب نجيك؟</h1>
          <div class="card-pane">
            <label class="form-label">اختيار المنطقة</label>
            <select id="area" class="js-example-basic-single" style="width:100%"></select>
          </div>

          <div class="card-pane">
            <label class="form-label">الخدمة</label>
            <select id="serviceCat" style="width:100%"></select>
            <div style="height:8px"></div>
            <select id="service" style="width:100%"></select>
            <div style="height:8px"></div>
            <label class="form-label">عدد السيارات</label>
            <select id="serviceCount" style="width:100%">
              <option value="1" selected>1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
            </select>
          </div>

          <!-- hidden nav buttons kept for compatibility -->
          <button id="page2-button" type="button" class="visually-hidden">التالي</button>
          <button id="page2-return" type="button" class="visually-hidden">السابق</button>
        </section>

        <!-- Page 3: Loading/Intermediary (auto) -->
        <section id="page3" class="page" aria-label="جلب المواعيد">
          <h2>جاري جلب المواعيد…</h2>
          <div class="card-pane" style="text-align:center">
            <div class="spinner-border text-info" role="status"><span class="visually-hidden">Loading…</span></div>
          </div>
          <button id="page3-button" type="button" class="visually-hidden">التالي</button>
          <button id="page3-return" type="button" class="visually-hidden">السابق</button>
        </section>

        <!-- Page 4: Pick date/time -->
        <section id="page4" class="page" aria-label="اختيار الموعد">
          <h1>متى تحب نجيك؟</h1>
          <div class="card-pane">
            <input id="date" type="date" class="form-control" />
          </div>
          <div class="card-pane">
            <div id="time-container" class="time-container"></div>
            <div id="fail-alert-3" class="poly-error"></div>
          </div>
          <button id="page4-return" type="button" class="visually-hidden">السابق</button>
        </section>

        <!-- Page 5: Contact + Vehicle + Payment -->
        <section id="page5" class="page" aria-label="معلومات الاتصال">
          <h1>معلومات الاتصال</h1>
          <div class="card-pane">
            <label class="form-label">الإسم</label>
            <input id="name" type="text" class="form-control" placeholder="اسمك الكريم" />
            <div style="height:8px"></div>
            <label class="form-label">رقم الجوال</label>
            <input id="mobile" type="tel" class="form-control" />
          </div>

          <h2>معلومات المركبة</h2>
          <div class="card-pane">
            <label class="form-label">ماركة السيارة 🚘</label>
            <select id="carBrand" style="width:100%"></select>
            <div style="height:8px"></div>
            <label class="form-label">اسم السيارة</label>
            <input id="carName" type="text" class="form-control" placeholder="كامري، إلنترا ..." />
            <div style="height:8px"></div>
            <label class="form-label">رقم اللوحة</label>
            <input id="plateNumber" type="text" inputmode="numeric" maxlength="4" class="form-control" placeholder="مثال: 1234" />
            <input id="locationDescription" type="text" hidden />
          </div>

          <h2>طريقة الدفع</h2>
          <div class="pay-grid">
            <label class="pay-card" tabindex="0">
              <input type="radio" name="payingMethod" value="STC Pay" class="visually-hidden" />
              <img src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/STC%20PAY%20LOGO.png" alt="STC Pay">
            </label>
            <label class="pay-card" tabindex="0">
              <input type="radio" name="payingMethod" value="Cash" class="visually-hidden" />
              <span style="font-weight:800">Cash</span>
            </label>
            <label class="pay-card" style="grid-column:1 / -1" tabindex="0">
              <input type="radio" name="payingMethod" value="MADA" class="visually-hidden" />
              <img src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/MADA%20LOGO.png" alt="Mada">
            </label>
          </div>

          <button id="page5-button" type="button" class="visually-hidden">التالي</button>
          <button id="page5-return" type="button" class="visually-hidden">السابق</button>
        </section>

        <!-- Page 6: Map -->
        <section id="page6" class="page" aria-label="اختيار الموقع">
          <h1>الموقع على خريطة قوقل</h1>
          <div class="card-pane map-shell">
            <div id="googleMap"></div>
            <div id="polyError" class="poly-error">عذرًا، موقعك خارج نطاق الخدمة</div>
          </div>
          <div class="card-pane" style="text-align:center">
            <button id="show-my-location" class="btn btn-outline-primary" type="button" style="min-height:44px">اظهار موقعي</button>
          </div>

          <button id="page6-button" type="button" class="visually-hidden">التالي</button>
          <button id="page6-return" type="button" class="visually-hidden">السابق</button>
        </section>

        <!-- Page 7: Thank you -->
        <section id="page7" class="page" aria-label="تم الحجز">
          <h1>شكراً لكم</h1>
          <div class="card-pane" style="text-align:center">
            <p style="margin:0 0 6px">تم حجز الموعد، وراح نأكده لكم على الواتساب</p>
            <button id="rebook" class="btn btn-primary" type="button">🔁 حجز جديد</button>
          </div>
        </section>

      </div>
    </div>
  </main>

  <!-- ===== Footer (ONE navigation method) ===== -->
  <footer class="sticky-nav" id="footer-nav" aria-label="التنقل بين خطوات الحجز">
    <div class="footer-inner">
      <div class="footer-actions" style="width:100%">
        <button id="footer-prev" type="button" class="btn-footer">السابق</button>
        <button id="footer-next" type="button" class="btn-footer primary">التالي</button>
      </div>
      <div class="footer-brand" aria-hidden="true">
        <img src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/Logo%20-%20Sponge%20and%20Soap%20-%201.png" alt="" style="height:28px">
        <span>Sponge &amp; Soap</span>
      </div>
    </div>
  </footer>

  <!-- Social FABs -->
  <a target="_blank" href="https://www.tiktok.com/@sponge.soap_sa?_t=ZS-8zaj1CA4aJg&_r=1" class="social-fab tiktok-button" aria-label="تابعنا على تيك توك"><i class="fab fa-tiktok"></i></a>
  <a target="_blank" href="https://www.instagram.com/sponge.soap_sa?igsh=MWRtOHI5OHZpbWpvdA==" class="social-fab instagram-button" aria-label="تابعنا على إنستغرام"><i class="fab fa-instagram"></i></a>
  <a target="_blank" href="https://wa.me/966503668222" class="social-fab whatsapp-button" aria-label="تواصل عبر واتساب"><i class="fab fa-whatsapp"></i></a>

  <!-- ===== Scripts ===== -->
  <script src="https://code.jquery.com/jquery-3.6.3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/intlTelInputWithUtils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // =========== Minimal demo data (replace with your APIs) ===========
    const demoLocations = [
      { id: 1, text: "الدوحة و الدانة" },
      { id: 2, text: "أجيال - أرامكو" },
      { id: 3, text: "العزيزية" },
    ];
    const demoCats = [
      { id: "basic", ar: "غسيل خارجي" },
      { id: "full",  ar: "غسيل متكامل" }
    ];
    const demoServices = {
      "basic":[ {id:101, ar:"خارجي سريع"}, {id:102, ar:"خارجي مع واكس"} ],
      "full":[  {id:201, ar:"داخلي + خارجي"}, {id:202, ar:"داخلي عميق + خارجي"} ]
    };

    // ========== Enhance controls ==========
    $(function(){
      // Area
      $('#area').select2({ data: demoLocations, width: '100%', placeholder:'اختر المنطقة' });
      // Categories
      $('#serviceCat').select2({ data: demoCats.map(c=>({id:c.id,text:c.ar})), width:'100%', placeholder:'نوع الخدمة' })
        .on('change', function(){
          const id = this.value;
          const items = (demoServices[id]||[]).map(s=>({id:s.id, text:s.ar}));
          $('#service').empty().select2({ data:items, width:'100%', placeholder:'الخدمة' });
        });
      $('#service').select2({ width:'100%', placeholder:'الخدمة' });

      // Car brands
      const brands = ["Toyota","Nissan","Hyundai","Kia","Lexus","Aston Martin","BMW","Mercedes-Benz","Honda","Mazda","Audi"].sort();
      $('#carBrand').select2({ data: brands.map(b=>({id:b,text:b})), width:'100%', placeholder:'ماركة السيارة' });

      // Phone
      const iti = window.intlTelInput(document.querySelector("#mobile"), {
        initialCountry:"sa",
        onlyCountries:["sa","ae","bh","kw","om","qa"],
        utilsScript:"https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/utils.js"
      });

      // Date default
      const DateTime = luxon.DateTime;
      document.getElementById('date').value = DateTime.now().toFormat('yyyy-LL-dd');

      // Demo time slots
      const times = ["9:15 PM","10:30 PM","11:45 PM"];
      const $tc = document.getElementById('time-container');
      function renderTimes(){
        $tc.innerHTML = "";
        times.forEach(t=>{
          const b = document.createElement('button');
          b.className = "time-option";
          b.type = "button";
          b.setAttribute('role','radio');
          b.textContent = t;
          b.addEventListener('click', ()=>{
            [...$tc.children].forEach(x=>x.setAttribute('aria-checked','false'));
            b.setAttribute('aria-checked','true');
            // mimic choosing and moving on (your real flow would set nForm etc.)
            setTimeout(()=>document.getElementById('page4-return').click(), 1); // keep compatibility
          });
          $tc.appendChild(b);
        });
      }
      renderTimes();

      // Payment card radio UX
      document.querySelectorAll('.pay-card').forEach(card=>{
        card.addEventListener('click', ()=>{
          document.querySelectorAll('.pay-card').forEach(c=>{
            c.setAttribute('aria-checked','false');
            c.querySelector('input[type="radio"]').checked = false;
          });
          card.setAttribute('aria-checked','true');
          card.querySelector('input[type="radio"]').checked = true;
        });
      });

      // Rebook demo
      document.getElementById('rebook').addEventListener('click', ()=>location.href='/');
    });

    // ========== Minimal page flow (keeps IDs for compatibility) ==========
    const orderedPages = ["page1","page2","page3","page4","page5","page6","page7"];
    function showPage(idx){
      const current = document.querySelector('.page.active');
      const next = document.getElementById(orderedPages[idx]);
      if(!next || current===next) return;
      if(current){
        current.classList.remove('active');
        current.classList.add('exit');
      }
      next.style.display='flex';
      requestAnimationFrame(()=>{
        next.classList.add('active');
        setTimeout(()=>{ if(current){ current.classList.remove('exit'); current.style.display='none'; } }, 280);
      });
      syncProgress(idx);
    }
    function getActiveIndex(){
      const id = document.querySelector('.page.active')?.id;
      return Math.max(0, orderedPages.indexOf(id));
    }
    function syncProgress(i){
      const pct = ((i+1)/orderedPages.length)*100;
      document.querySelectorAll(".mini-progress .bar > span, .progress-line > span").forEach(el=>el.style.width = pct + "%");
      document.querySelectorAll(".step-pill").forEach((pill, idx)=>pill.classList.toggle("active", idx===i));
      // Footer labels
      const prev = document.getElementById('footer-prev');
      const next = document.getElementById('footer-next');
      prev.disabled = (i===0);
      next.textContent = (i>=orderedPages.length-1) ? "إنهاء" : (i===orderedPages.length-2 ? "تأكيد" : "التالي");
      next.classList.toggle('is-confirm', i>=orderedPages.length-2);
    }

    // Initial state
    window.addEventListener('load', ()=>syncProgress(getActiveIndex()));

    // Hook internal (hidden) per-page buttons to keep compatibility
    document.getElementById('page1-button').addEventListener('click', ()=>showPage(1));
    document.getElementById('page2-button').addEventListener('click', ()=>showPage(2));
    document.getElementById('page3-button').addEventListener('click', ()=>showPage(3));
    document.getElementById('page4-return').addEventListener('click', ()=>showPage(5)); // when time chosen go to next page
    document.getElementById('page5-button').addEventListener('click', ()=>showPage(6));
    document.getElementById('page6-button').addEventListener('click', ()=>showPage(6)); // confirm to 7

    // Footer controls (ONE method)
    (function footerNav(){
      const $prev = document.getElementById("footer-prev");
      const $next = document.getElementById("footer-next");

      function goNext(){
        const i = getActiveIndex();
        const nextIndex = Math.min(i+1, orderedPages.length-1);

        // Try page-specific hidden button first (keeps your logic)
        const pageEl = document.getElementById(orderedPages[i]);
        const tryClick = sel => { const el = pageEl.querySelector(sel); if(el){ el.click(); return true; } return false; };
        if (!tryClick(`#${orderedPages[i]}-button`) && i!==3 && i!==4){ // some steps use return for move
          showPage(nextIndex);
        }
        setTimeout(()=>syncProgress(getActiveIndex()), 320);
      }
      function goPrev(){
        const i = getActiveIndex();
        const prevIndex = Math.max(i-1, 0);
        const pageEl = document.getElementById(orderedPages[i]);
        const tryClick = sel => { const el = pageEl.querySelector(sel); if(el){ el.click(); return true; } return false; };
        if (!tryClick(`#${orderedPages[i]}-return`)){
          showPage(prevIndex);
        }
        setTimeout(()=>syncProgress(getActiveIndex()), 320);
      }
      $next.addEventListener('click', goNext);
      $prev.addEventListener('click', goPrev);
    })();

    // ====== Google Map (basic center/marker; add your polygon if needed) ======
    let map, marker, positionUrl = "";
    function initMap(){
      const defaultLocation = { lat: 26.34165524787632, lng: 50.11524831545726 };
      map = new google.maps.Map(document.getElementById("googleMap"), {
        center: defaultLocation, zoom: 12, disableDoubleClickZoom: true
      });
      marker = new google.maps.Marker({
        position: defaultLocation, map, draggable:true, title:"اسحب أو اضغط لتحديد الموقع"
      });
      marker.addListener("dragend", (e)=>setPosition(e.latLng));
      map.addListener("click", (e)=>setPosition(e.latLng));

      document.getElementById('show-my-location').addEventListener('click', ()=>{
        if(navigator.geolocation){
          navigator.geolocation.getCurrentPosition((pos)=>{
            const p = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            setPosition(p, true);
          });
        }
      });
    }
    function setPosition(latLng, pan){
      marker.setPosition(latLng);
      if(pan) map.panTo(latLng);
      map.setZoom(17);
      positionUrl = `https://www.google.com/maps/search/?api=1&query=${latLng.lat||latLng.lat()},${latLng.lng||latLng.lng()}`;
      document.getElementById('polyError').style.display = "none"; // plug your polygon check here
    }
    window.initMap = initMap;

    // 🔗 YOUR EXISTING FLOW LOGIC HERE
    // Keep your nForm object, API calls, validations, and hidden #pageN-button / #pageN-return clicks.
    // The sticky footer will trigger those hidden buttons so your logic runs as-is.
  </script>

  <!-- Google Maps (geometry optional if you add polygon service areas) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBBHLoO038vsCovHN-SLUgAXqexlA2v0_4&callback=initMap" async defer></script>
</body>
</html>
