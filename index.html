<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>حجوزات المواعيد</title>

  <!-- External UI libs -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800&display=swap" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/css/intlTelInput.css" rel="stylesheet"/>

  <style>
    /* ===========================
       THEME TOKENS (WCAG 2.2 AA)
       =========================== */
    :root{
      /* Brand */
      --brand-700:#01657A; --brand-600:#027A93; --brand-200:#BFE6F0; --brand-050:#F0FAFC;

      /* Neutral */
      --ink-900:#0B2630; --ink-700:#224652; --ink-500:#557784;
      --surface-000:#FFFFFF; --surface-050:#F7F9FA; --surface-100:#EDF3F6; --border-300:#D4E0E6;
      --scrim-500:rgba(11,38,48,.52);

      /* States */
      --success-600:#18794E; --success-050:#EEF9F3;
      --warning-700:#8A5700; --warning-050:#FFF7E6;
      --error-650:#B42318;  --error-050:#FEECEC;
      --info-650:#1E5F8A;   --info-050:#E9F5FC;

      /* Elevation & radii */
      --radius-sm:10px; --radius-md:14px; --radius-lg:18px; --radius-pill:999px;
      --shadow-sm:0 2px 8px rgba(11,38,48,.08);
      --shadow-md:0 10px 28px rgba(11,38,48,.14);
      --shadow-lg:0 22px 48px rgba(11,38,48,.18);

      /* Motion */
      --ease:cubic-bezier(.22,.61,.36,1);
      --t-quick:.18s var(--ease);
      --t-med:.28s var(--ease);

      /* Type scale */
      --fs-2xl: clamp(1.6rem, 2vw + 1rem, 2.2rem);
      --fs-xl: 1.375rem; --fs-lg:1.125rem; --fs-md:1rem; --fs-sm:.9rem;
      --fw-reg:400; --fw-bold:800;

      /* Spacing (8pt) */
      --sp-1:4px; --sp-2:8px; --sp-3:12px; --sp-4:16px; --sp-5:20px;
      --sp-6:24px; --sp-7:32px; --sp-8:40px;

      /* Layout bars */
      --header-h:76px; --footer-h:78px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:'Cairo',sans-serif; color:#fff;
      background:
        linear-gradient(180deg, rgba(11,38,48,.65), rgba(11,38,48,.35)),
        url("https://www.dropbox.com/s/s9bxuykl0w49dqa/background2.jpg?raw=1") center/cover fixed;
      min-height:100vh; display:flex; flex-direction:column;
      padding-top:var(--header-h); padding-bottom:var(--footer-h);
    }

    /* ===== Header ===== */
    header{
      position:sticky; top:0; z-index:50; height:var(--header-h);
      background:rgba(11,38,48,.36); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px);
      border-bottom:1px solid rgba(255,255,255,.15); box-shadow:0 10px 30px rgba(0,0,0,.12);
      display:flex; align-items:center; justify-content:center;
    }
    .header-inner{max-width:1120px; width:100%; padding:0 var(--sp-3); display:flex; align-items:center; justify-content:space-between}
    .brand{display:flex; align-items:center; gap:var(--sp-2)}
    .brand img{height:60px; width:auto; object-fit:contain; filter:drop-shadow(0 6px 20px rgba(0,0,0,.25));}
    @media (max-width:520px){ .brand img{height:52px} }

    .mini-progress{display:flex; align-items:center; gap:var(--sp-3); width:56%}
    .mini-progress .step{font-weight:var(--fw-bold); font-size:var(--fs-md)}
    .mini-progress .bar{flex:1; height:8px; background:rgba(255,255,255,.25); border-radius:999px; overflow:hidden}
    .mini-progress .bar>span{display:block; height:100%; width:14%; background:linear-gradient(90deg, var(--brand-600), var(--brand-200)); transition:width var(--t-med)}

    /* ===== Main ===== */
    main{flex:1 0 auto; display:flex; justify-content:center; padding:var(--sp-2) var(--sp-3) 0}
    #app{width:100%; max-width:1120px}

    .steps-wrap{padding:var(--sp-2) var(--sp-3) 0}
    .steps{display:flex; gap:var(--sp-2); flex-wrap:wrap; justify-content:center; list-style:none; margin:0; padding:0}
    .step-pill{background:rgba(255,255,255,.25); color:#fff; font-weight:var(--fw-bold); font-size:var(--fs-md); padding:8px 14px; border-radius:var(--radius-pill)}
    .step-pill.active{background:var(--brand-700)}
    .progress-line{height:8px; background:rgba(255,255,255,.25); border-radius:999px; overflow:hidden; width:calc(100% - 28px); margin:var(--sp-2) auto 0}
    .progress-line>span{display:block; height:100%; width:14%; background:linear-gradient(90deg, var(--brand-600), var(--brand-200)); transition:width var(--t-med)}

    .stage{position:relative; min-height:540px; padding:var(--sp-2) 0 var(--sp-3)}
    .page{
      position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; gap:var(--sp-3);
      padding:var(--sp-4) var(--sp-3) var(--sp-5); overflow:auto; opacity:0; transform:translateY(14px) scale(.99);
      pointer-events:none; transition:opacity var(--t-med), transform var(--t-med);
    }
    .page.active{position:relative; opacity:1; transform:translateY(0) scale(1); pointer-events:auto}
    .page.exit{opacity:0; transform:translateY(18px) scale(.985)}

    .page h1{font-size:var(--fs-xl); font-weight:var(--fw-bold); margin:0; text-align:center}

    .card{background:var(--surface-000); color:var(--ink-900); border-radius:var(--radius-md); box-shadow:var(--shadow-md); padding:var(--sp-6); width:100%; max-width:920px}

    /* Inputs & Selects */
    .form-control, select, .select2-selection{
      background:var(--surface-000); color:var(--ink-900);
      border:1px solid var(--border-300) !important; border-radius:var(--radius-md)!important;
      min-height:48px; text-align:center; font-size:var(--fs-md);
    }
    .select2-selection{height:48px !important; display:flex; align-items:center}
    .select2-selection__rendered{line-height:48px !important}

    .form-control:focus{
      border-color:var(--brand-600) !important; box-shadow:0 0 0 3px var(--brand-200) !important; outline:0;
    }

    /* Time options */
    .time-grid{display:grid; grid-template-columns:repeat(2,1fr); gap:var(--sp-3)}
    @media (min-width:540px){ .time-grid{grid-template-columns:repeat(3,1fr)} }
    .time-option{
      background:var(--surface-000); color:var(--ink-900); font-weight:var(--fw-bold);
      border:1px solid var(--border-300); border-radius:var(--radius-md); padding:14px 10px; min-height:48px;
      box-shadow:var(--shadow-sm); transition:var(--t-quick);
    }
    .time-option:hover{transform:translateY(-1px); background:var(--brand-050)}
    .time-option[aria-checked="true"]{outline:3px solid var(--brand-600); outline-offset:2px}

    /* Payment */
    .pay-grid{display:grid; grid-template-columns:1fr 1fr; gap:var(--sp-3); width:100%; max-width:920px}
    .pay-card{
      background:var(--surface-000); color:var(--ink-900);
      border:1px solid var(--border-300); border-radius:var(--radius-md);
      padding:var(--sp-5); display:flex; justify-content:center; align-items:center; gap:var(--sp-3);
      min-height:64px; cursor:pointer; transition:var(--t-quick);
    }
    .pay-card img{max-width:120px; height:auto}
    .pay-card:hover{box-shadow:var(--shadow-sm)}
    .pay-card[aria-checked="true"]{outline:3px solid var(--brand-600); outline-offset:2px}

    /* Map */
    #googleMap{width:100%; height:420px; border-radius:var(--radius-md); overflow:hidden}
    .helper-error{margin-top:var(--sp-2); padding:var(--sp-2) var(--sp-3); border-radius:var(--radius-sm); color:var(--error-650); background:var(--error-050); border:1px solid #F9D3D0; display:none}

    /* Buttons */
    .btn-primary{background:var(--brand-600); color:#fff; border:0; border-radius:var(--radius-md); font-weight:var(--fw-bold)}
    .btn-primary:hover{background:var(--brand-700)}
    .btn-outline-primary{color:var(--brand-600); border:1px solid var(--brand-600); border-radius:var(--radius-md); font-weight:var(--fw-bold)}
    .btn-outline-primary:hover{background:var(--brand-050)}

    /* Footer nav */
    footer.sticky-nav{
      position:sticky; bottom:0; z-index:40; height:var(--footer-h);
      background:rgba(11,38,48,.45); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px);
      border-top:1px solid rgba(255,255,255,.15); box-shadow:0 -10px 30px rgba(0,0,0,.12);
      display:flex; align-items:center; justify-content:center;
    }
    .footer-inner{max-width:1120px; width:100%; padding:var(--sp-2) var(--sp-3); display:flex; gap:var(--sp-3); align-items:center}
    .footer-actions{display:flex; gap:var(--sp-3); width:100%}
    .btn-footer{
      flex:1; border:1px solid var(--border-300); border-radius:var(--radius-md);
      padding:12px 16px; min-height:48px; font-size:var(--fs-md); font-weight:var(--fw-bold);
      background:var(--surface-000); color:var(--brand-600); box-shadow:var(--shadow-sm); transition:var(--t-quick);
    }
    .btn-footer.primary{background:var(--brand-600); color:#fff; border-color:var(--brand-600)}
    .btn-footer:disabled{opacity:.6; cursor:not-allowed}

    /* Hide any page-local nav buttons (we use footer only) */
    [id^="page"][id$="-button"], [id^="page"][id$="-return"]{display:none!important}

    /* Social FABs */
    .social-fab{position:fixed; left:15px; z-index:999; width:54px; height:54px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#fff; text-decoration:none; background:rgba(34,34,34,.55); backdrop-filter:blur(6px); box-shadow:0 8px 20px rgba(0,0,0,.35), 0 0 0 2px rgba(255,255,255,.10) inset; transition:transform .18s}
    .social-fab:hover{transform:translateY(-2px)}
    .whatsapp-button{bottom:calc(var(--footer-h) + 14px)}
    .instagram-button{bottom:calc(var(--footer-h) + 74px)}
    .tiktok-button{bottom:calc(var(--footer-h) + 134px)}

    .visually-hidden{position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px);white-space:nowrap;border:0;padding:0;margin:-1px}

    /* =========================
       Mobile field (intl-tel-input) – unified sizing
       ========================= */
    .form-block { margin-bottom: var(--sp-4); }
    .form-label {
      display:inline-block; margin-bottom:var(--sp-2);
      font-size:var(--fs-sm); font-weight:var(--fw-bold); color:var(--ink-700);
    }
    .iti { width: 100% !important; } /* wrapper */
    #mobile.form-control{
      min-height:48px; height:48px; line-height:48px; text-align:center;
      border-radius:var(--radius-md); border:1px solid var(--border-300);
      background:var(--surface-000); color:var(--ink-900); font-size:var(--fs-md);
    }
    #mobile.form-control:focus{
      border-color:var(--brand-600);
      box-shadow:0 0 0 3px var(--brand-200); outline:0;
    }
    /* RTL: flag & dial on the right */
    html[dir="rtl"] .iti--allow-dropdown .iti__flag-container { right:0; left:auto; }
    html[dir="rtl"] .iti--allow-dropdown input#mobile.form-control { padding-right:62px; padding-left:12px; text-align:center; }
    /* LTR fallback */
    html[dir="ltr"] .iti--allow-dropdown .iti__flag-container { left:0; right:auto; }
    html[dir="ltr"] .iti--allow-dropdown input#mobile.form-control { padding-left:62px; padding-right:12px; }
    .iti__flag-container .iti__selected-flag{ height:48px; padding-inline:10px; }
    .iti__selected-dial-code{ font-weight:700; }
    .field-hint{ margin-top:6px; font-size:.85rem; color:var(--error-650); display:none; }
    @media (max-width:480px){ #mobile.form-control{ font-size:.95rem; } }
  </style>
</head>
<body>

  <!-- ========== HEADER ========== -->
  <header>
    <div class="header-inner">
      <div class="mini-progress" aria-hidden="true">
        <div class="bar"><span style="width:14%"></span></div>
        <div class="step">الخدمة</div>
      </div>
      <div class="brand">
        <img alt="Sponge & Soap" src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20Soap/spong&Soap%20-%20logo.png"/>
      </div>
    </div>
  </header>

  <!-- ========== BODY ========== -->
  <main>
    <div id="app">
      <div class="steps-wrap">
        <ul class="steps" aria-label="خطوات الحجز">
          <li class="step-pill active">الخدمة</li>
          <li class="step-pill">الوقت</li>
          <li class="step-pill">البيانات</li>
          <li class="step-pill">الموقع</li>
          <li class="step-pill">التأكيد</li>
        </ul>
        <div class="progress-line"><span style="width:14%"></span></div>
      </div>

      <div class="stage">
        <!-- Page 1: Intro -->
        <section id="page1" class="page active" aria-label="الترحيب">
          <h1>✨ غسيل بدون طوابير</h1>
          <div class="card text-center">
            <p class="mb-3" style="color:var(--ink-700)">واكس يحمي سيارتك • فوط نظيفة • إسفنجة للكفرات</p>
            <button id="page1-button" class="btn btn-primary" type="button">احجز موعدك</button>
          </div>
        </section>

        <!-- Page 2: Location + Service -->
        <section id="page2" class="page" aria-label="اختيار المنطقة والخدمة">
          <h1>وين تحب نجيك؟</h1>

          <div class="card">
            <label class="form-label">اختيار المنطقة</label>
            <select id="area" class="js-example-basic-single" style="width:100%"></select>
          </div>

          <div class="card">
            <div class="row g-3">
              <div class="col-12 col-md-6">
                <label class="form-label">التصنيف</label>
                <select id="serviceCat" style="width:100%"></select>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label">الخدمة</label>
                <select id="service" style="width:100%"></select>
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label">عدد السيارات</label>
                <select id="serviceCount" class="form-select">
                  <option value="1" selected>1</option>
                  <option value="2">2</option><option value="3">3</option>
                  <option value="4">4</option><option value="5">5</option>
                </select>
              </div>
            </div>
          </div>
        </section>

        <!-- Page 3: Loading times -->
        <section id="page3" class="page" aria-label="جلب المواعيد">
          <h1>جاري جلب المواعيد…</h1>
          <div class="card text-center">
            <div class="spinner-border text-info" role="status"><span class="visually-hidden">Loading…</span></div>
          </div>
        </section>

        <!-- Page 4: Times -->
        <section id="page4" class="page" aria-label="اختيار الموعد">
          <h1>متى تحب نجيك؟</h1>
          <div class="card">
            <label class="form-label">التاريخ</label>
            <input id="date" type="date" class="form-control"/>
          </div>
          <div class="card">
            <div id="time-container" class="time-grid"></div>
            <div id="fail-alert-3" class="helper-error"></div>
          </div>
        </section>

        <!-- Page 5: Contact -->
        <section id="page5" class="page" aria-label="معلومات الاتصال">
          <h1>معلومات الاتصال</h1>
          <div class="card">
            <div class="row g-3">
              <div class="col-12 col-md-6 form-block">
                <label for="name" class="form-label">الإسم</label>
                <input id="name" type="text" class="form-control" placeholder="اسمك الكريم"/>
              </div>

              <!-- Updated Mobile field (size & label unified) -->
              <div class="col-12 col-md-6 form-block">
                <label for="mobile" class="form-label">رقم الجوال</label>
                <input id="mobile" type="tel" class="form-control" placeholder="+9665…"/>
                <div id="mobileHint" class="field-hint">الرجاء إدخال رقم جوال صالح</div>
              </div>
            </div>
          </div>

          <h1>معلومات المركبة</h1>
          <div class="card">
            <div class="row g-3">
              <div class="col-12 col-md-4">
                <label class="form-label">ماركة السيارة 🚘</label>
                <select id="carBrand" style="width:100%"></select>
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label">اسم السيارة</label>
                <input id="carName" type="text" class="form-control" placeholder="كامري، إلنترا…"/>
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label">رقم اللوحة</label>
                <input id="plateNumber" type="text" inputmode="numeric" maxlength="4" class="form-control" placeholder="1234"/>
              </div>
              <input id="locationDescription" type="text" hidden/>
            </div>
          </div>

          <h1>طريقة الدفع</h1>
          <div class="pay-grid">
            <label class="pay-card" tabindex="0">
              <input type="radio" name="payingMethod" value="STC Pay" class="visually-hidden"/>
              <img src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/STC%20PAY%20LOGO.png" alt="STC Pay">
            </label>
            <label class="pay-card" tabindex="0">
              <input type="radio" name="payingMethod" value="Cash" class="visually-hidden"/>
              <strong>Cash</strong>
            </label>
            <label class="pay-card" style="grid-column:1/-1" tabindex="0">
              <input type="radio" name="payingMethod" value="MADA" class="visually-hidden"/>
              <img src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/MADA%20LOGO.png" alt="Mada">
            </label>
          </div>
        </section>

        <!-- Page 6: Map -->
        <section id="page6" class="page" aria-label="اختيار الموقع">
          <h1>الموقع على خريطة قوقل</h1>
          <div class="card">
            <div id="googleMap"></div>
            <div id="polyError" class="helper-error">الرجاء تحديد الموقع</div>
          </div>
          <div class="card text-center">
            <button id="show-my-location" class="btn btn-outline-primary" type="button">إظهار موقعي</button>
          </div>
        </section>

        <!-- Page 7: Done -->
        <section id="page7" class="page" aria-label="تم الحجز">
          <h1>شكراً لكم</h1>
          <div class="card text-center">
            <p class="mb-3" style="color:var(--ink-700)">تم حجز الموعد، وراح نأكده لكم على الواتساب</p>
            <button id="rebook" class="btn btn-primary" type="button">🔁 حجز جديد</button>
          </div>
        </section>
      </div>
    </div>
  </main>

  <!-- ========== FOOTER (sticky nav) ========== -->
  <footer class="sticky-nav" aria-label="التنقل بين الخطوات">
    <div class="footer-inner">
      <div class="footer-actions">
        <button id="footer-prev" type="button" class="btn-footer">السابق</button>
        <button id="footer-next" type="button" class="btn-footer primary">التالي</button>
      </div>
    </div>
  </footer>

  <!-- Social FABs -->
  <a target="_blank" class="social-fab tiktok-button" aria-label="تيك توك" href="https://www.tiktok.com/@sponge.soap_sa?_t=ZS-8zaj1CA4aJg&_r=1"><i class="fab fa-tiktok"></i></a>
  <a target="_blank" class="social-fab instagram-button" aria-label="إنستغرام" href="https://www.instagram.com/sponge.soap_sa?igsh=MWRtOHI5OHZpbWpvdA=="><i class="fab fa-instagram"></i></a>
  <a target="_blank" class="social-fab whatsapp-button" aria-label="واتساب" href="https://wa.me/966503668222"><i class="fab fa-whatsapp"></i></a>

  <!-- JS libs -->
  <script src="https://code.jquery.com/jquery-3.6.3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/intlTelInputWithUtils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /* =========================
       API (original endpoints)
       ========================= */
    const defaultLink2 = `https://nahl-platform.vercel.app/api/app/AM/general/${'33e0d05d-d771-46f4-a7e7-7c634b4e3a9e'}/form`;

    let controllers = [];
    async function callContent2(path, cb, abortable=false, retries=3){
      let signal = '';
      if (abortable){
        if (controllers.length){ controllers.forEach(([c])=>c.abort()); controllers=[]; }
        const controller = new AbortController(); signal=controller.signal;
        controllers.push([controller, signal]);
      }
      try{
        const res = await fetch(defaultLink2 + path, {method:'GET', redirect:'follow', ...(abortable && {signal})});
        if(!res.ok){ if(retries>0) return callContent2(path, cb, abortable, retries-1); throw new Error('Network error'); }
        const json = await res.json(); cb(json);
      }catch(e){
        if(!String(e.message).includes('aborted')){
          if(retries>0) return setTimeout(()=>callContent2(path, cb, abortable, retries-1), 800);
          console.error('API error:', e);
        }
      }
    }

    /* =========================
       STATE
       ========================= */
    const DateTime = luxon.DateTime;
    const orderedPages = ["page1","page2","page3","page4","page5","page6","page7"];
    let selectedTime = null;
    let positionUrl = "";
    let servicesCache = null;
    let categoriesCache = null;
    let itiPhone = null;

    const nForm = {
      date:'', time:'', location:'', service:'', serviceCount:'1',
      serviceCat:'', customerM:'', customerN:'', paymentMethod:'',
      urlLocation:'', locationDescription:''
    };

    /* Mobile inline validation helper */
    function validateMobileInline() {
      const mobileEl = document.getElementById('mobile');
      const mobileHint = document.getElementById('mobileHint');
      if (itiPhone && !itiPhone.isValidNumber()) {
        mobileEl.setAttribute('aria-invalid', 'true');
        mobileHint.style.display = 'block';
        return false;
      }
      mobileEl.removeAttribute('aria-invalid');
      mobileHint.style.display = 'none';
      return true;
    }

    /* =========================
       UI HELPERS
       ========================= */
    function showPage(idx){
      const current = document.querySelector('.page.active');
      const next = document.getElementById(orderedPages[idx]);
      if(!next || current===next) return;
      if(current){ current.classList.remove('active'); current.classList.add('exit'); }
      next.style.display='flex';
      requestAnimationFrame(()=>{
        next.classList.add('active');
        setTimeout(()=>{ if(current){ current.classList.remove('exit'); current.style.display='none'; } }, 280);
      });
      syncProgress(idx);
    }
    function getActiveIndex(){
      const id = document.querySelector('.page.active')?.id;
      return Math.max(0, orderedPages.indexOf(id));
    }
    function syncProgress(i){
      const pct = ((i+1)/orderedPages.length)*100;
      document.querySelectorAll(".mini-progress .bar>span, .progress-line>span").forEach(el=>el.style.width = pct+"%");
      const labels = ["الخدمة","الوقت","البيانات","الموقع","التأكيد","انتهى","انتهى"];
      document.querySelector(".mini-progress .step").textContent = labels[Math.min(i,labels.length-1)];
      document.querySelectorAll(".step-pill").forEach((pill,idx)=>pill.classList.toggle("active", idx===i));
      const prev = document.getElementById('footer-prev');
      const next = document.getElementById('footer-next');
      prev.disabled = (i===0);
      next.textContent = (i>=orderedPages.length-2) ? "تأكيد" : "التالي";
      if(i===orderedPages.length-1){ next.textContent = "إنهاء"; }
    }

    function renderTimes(list){
      const cont = document.getElementById('time-container');
      cont.innerHTML = "";
      selectedTime = null;
      if(!list || !list.length){
        cont.innerHTML = '<div class="text-center text-muted" style="grid-column:1/-1;padding:10px 0">لا توجد مواعيد متاحة</div>';
        return;
      }
      list.forEach(t=>{
        const b = document.createElement('button');
        b.className='time-option'; b.type='button'; b.setAttribute('role','radio'); b.textContent=t.ui;
        b.onclick=()=>{
          [...cont.children].forEach(x=>x.setAttribute('aria-checked','false'));
          b.setAttribute('aria-checked','true');
          selectedTime = t; // {ui, iso}
          nForm.time = t.iso.slice(0,5);
        };
        cont.appendChild(b);
      });
    }

    /* =========================
       LOAD & INIT
       ========================= */
    $(function(){
      // date defaults & min
      const today = DateTime.now().toFormat('yyyy-LL-dd');
      $('#date').val(today).attr('min', today);

      // selects
      $('#area').select2({width:'100%', placeholder:'اختر المنطقة'});
      $('#serviceCat').select2({width:'100%', placeholder:'التصنيف'});
      $('#service').select2({width:'100%', placeholder:'الخدمة'});
      $('#carBrand').select2({width:'100%', placeholder:'ماركة السيارة'});

      // phone input (keep instance)
      itiPhone = window.intlTelInput(document.querySelector("#mobile"), {
        initialCountry:"sa",
        onlyCountries:["sa","ae","bh","kw","om","qa"],
        utilsScript:"https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/utils.js"
      });

      // Inline validation hooks
      const mobileEl = document.getElementById('mobile');
      mobileEl.addEventListener('blur', validateMobileInline);
      mobileEl.addEventListener('input', () => {
        if (mobileEl.getAttribute('aria-invalid') === 'true') validateMobileInline();
      });

      // CTA
      document.getElementById('page1-button').addEventListener('click', ()=>showPage(1));

      // Locations
      callContent2(`/locations`, (res)=>{
        const list = res?.data || [];
        const ds = list.map(l=>({id:l.id, text:l.TS_location_arabic_name}));
        $('#area').empty().select2({data:ds, width:'100%'});
        if(ds.length){ $('#area').val(ds[0].id).trigger('change'); }
      });

      // On area change -> services & categories
      $('#area').on('change', function(){
        nForm.location = this.value;
        callContent2(`/services?location=${encodeURIComponent(this.value)}`, (res)=>{
          servicesCache = res?.data?.services || [];
          categoriesCache = res?.data?.servicesCat || [];
          const cats = categoriesCache.map(c=>({id:c.TS_category_id, text:c.TS_category_arabic_name}));
          $('#serviceCat').empty().select2({data:cats, width:'100%'});
          if(cats.length){ $('#serviceCat').val(cats[0].id).trigger('change'); }
        }, true);
      });

      // Category -> services
      $('#serviceCat').on('change', function(){
        nForm.serviceCat = this.value;
        const catId = Number(this.value);
        const items = servicesCache
          ?.filter(s=>Number(s.TS_category_id)===catId)
          ?.sort((a,b)=>a.TS_service_id-b.TS_service_id)
          ?.map(s=>({id:s.TS_service_id, text:s.TS_service_arabic_name})) || [];
        $('#service').empty().select2({data:items, width:'100%'});
        if(items.length){ $('#service').val(items[0].id).trigger('change'); }
      });

      // Date change -> refresh times (if on page4)
      $('#date').on('change', function(){
        if(getActiveIndex()===3){ fetchAndRenderTimes(); }
      });

      // Car brands
      const brands = ["Toyota","Nissan","Hyundai","Kia","Honda","Lexus","BMW","Mercedes-Benz","Chevrolet","Ford","Mazda","Mitsubishi","Aston Martin","Other"]
        .sort().map(b=>({id:b,text:b}));
      $('#carBrand').empty().select2({data:brands, width:'100%'});

      // Payment selection
      document.querySelectorAll('.pay-card').forEach(card=>{
        card.addEventListener('click', ()=>{
          document.querySelectorAll('.pay-card').forEach(c=>{
            c.setAttribute('aria-checked','false');
            c.querySelector('input[type="radio"]').checked=false;
          });
          card.setAttribute('aria-checked','true');
          card.querySelector('input[type="radio"]').checked=true;
          nForm.paymentMethod = card.querySelector('input[type="radio"]').value;
        });
      });

      // Rebook
      document.getElementById('rebook').addEventListener('click', ()=>location.href='/');
    });

    /* =========================
       TIMES (API)
       ========================= */
    function fetchAndRenderTimes(){
      const startDate = document.getElementById('date').value || DateTime.now().toFormat('yyyy-LL-dd');
      const loc = document.getElementById('area').value;
      const srv = document.getElementById('service').value;

      document.getElementById('time-container').innerHTML =
        '<div class="text-center" style="grid-column:1/-1"><div class="spinner-border text-info" role="status"><span class="visually-hidden">Loading…</span></div></div>';

      callContent2(`/appointments?startDate=${startDate}&location=${encodeURIComponent(loc)}&service=${encodeURIComponent(srv)}`, (res)=>{
        const appts = res?.data?.appointments || [];
        const items = appts.map(a=>{
          const t = luxon.DateTime.fromISO(a.TS_appointment_time, { setZone:true });
          return { ui: t.toLocaleString(luxon.DateTime.TIME_SIMPLE), iso: t.toFormat('HH:mm') };
        });
        renderTimes(items);
      }, true);
    }

    /* =========================
       FOOTER NAV
       ========================= */
    (function footerNav(){
      const $prev = document.getElementById("footer-prev");
      const $next = document.getElementById("footer-next");

      $next.addEventListener('click', async ()=>{
        const i = getActiveIndex();
        const id = orderedPages[i];

        if(id==="page1"){ showPage(1); return; }

        if(id==="page2"){
          if(!nForm.location || !document.getElementById('service').value){ return; }
          nForm.service = document.getElementById('service').value;
          nForm.serviceCount = document.getElementById('serviceCount').value || '1';
          showPage(2);            // page3 loading
          fetchAndRenderTimes();  // fetch times
          setTimeout(()=>showPage(3), 350);
          return;
        }

        if(id==="page3"){ showPage(3); return; } // to page4

        if(id==="page4"){
          if(!selectedTime){
            const e = document.getElementById('fail-alert-3');
            e.textContent='الرجاء اختيار وقت.'; e.style.display='block';
            return;
          }else{
            document.getElementById('fail-alert-3').style.display='none';
          }
          nForm.date = document.getElementById('date').value;
          showPage(4); return;
        }

        if(id==="page5"){
          // gather + validate
          const name = document.getElementById('name').value.trim();
          if(!name) return;

          if(!validateMobileInline()) return;

          nForm.customerN = name;
          nForm.customerM = itiPhone.getNumber().replace(/^\+/, '');
          nForm.locationDescription = [
            $('#carBrand').val()||'',
            document.getElementById('carName').value||'',
            document.getElementById('plateNumber').value||''
          ].filter(Boolean).join(', ');

          // payment required
          if(!nForm.paymentMethod) return;

          showPage(5); return;
        }

        if(id==="page6"){
          if(!positionUrl){
            const e = document.getElementById('polyError');
            e.textContent='الرجاء تحديد الموقع'; e.style.display='block';
            return;
          }
          nForm.urlLocation = positionUrl;

          try{
            const res = await fetch(defaultLink2 + '/reserveAppointment', {
              method:'POST', redirect:'follow', headers:{'Content-Type':'application/json'},
              body: JSON.stringify(nForm)
            });
            if(!res.ok){ throw new Error('Bad response'); }
            const json = await res.json();
            if(json?.success){ showPage(6); } else { throw new Error('Reservation failed'); }
          }catch(e){
            showPage(3);
            const err = document.getElementById('fail-alert-3');
            err.style.display='block';
            err.textContent='عذرًا حصل خطأ غير متوقع الرجاء المحاولة لاحقًا';
          }
          return;
        }

        // default forward
        showPage(Math.min(i+1, orderedPages.length-1));
      });

      $prev.addEventListener('click', ()=>{
        const i = getActiveIndex();
        showPage(Math.max(i-1,0));
      });
    })();

    /* =========================
       GOOGLE MAP
       ========================= */
    let map, marker;
    function initMap(){
      const def = { lat:26.34165524787632, lng:50.11524831545726 };
      map = new google.maps.Map(document.getElementById("googleMap"), {center:def, zoom:12, disableDoubleClickZoom:true});
      marker = new google.maps.Marker({position:def, map, draggable:true, title:"اسحب أو اضغط لتحديد الموقع"});
      const setPos = (latLng, pan=false)=>{
        marker.setPosition(latLng);
        if(pan) map.panTo(latLng);
        map.setZoom(17);
        positionUrl = `https://www.google.com/maps/search/?api=1&query=${latLng.lat()},${latLng.lng()}`;
        document.getElementById('polyError').style.display='none';
      };
      marker.addListener("dragend", e=>setPos(e.latLng));
      map.addListener("click", e=>setPos(e.latLng));
      document.getElementById('show-my-location').addEventListener('click', ()=>{
        if(navigator.geolocation){
          navigator.geolocation.getCurrentPosition(pos=>{
            setPos(new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude), true);
          });
        }
      });
    }
    window.initMap = initMap;

    // Ensure min date is today on load (fallback)
    document.addEventListener('DOMContentLoaded', ()=>{
      const today = DateTime.now().toFormat('yyyy-LL-dd');
      document.getElementById("date").setAttribute("min", today);
    });
  </script>

  <!-- Replace key if required -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBBHLoO038vsCovHN-SLUgAXqexlA2v0_4&callback=initMap" async defer></script>
</body>
</html>
