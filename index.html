<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Maison Hikari â€¢ Ø§Ù„Ø·Ù„Ø¨</title>

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

  <!-- Bootstrap & Intl Tel Input -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/css/intlTelInput.css" rel="stylesheet"/>

  <meta name="theme-color" content="#0A0A0A">
  <meta name="description" content="Maison Hikari â€” Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†">

  <style>
    :root{
      --bg:#FAFAFA; --ink:#0B0D13; --muted:#6B7280; --rule:#EAEAEA;
      --brand:#111; --chip:#F2F2F2; --chip-ink:#111;
      --radius:14px; --radius-pill:999px; --shadow:0 10px 30px rgba(0,0,0,.08);
      --ease:cubic-bezier(.22,.61,.36,1);
      --focus:#0A0A0A;
      --header-h:64px; /* updated by JS */
      --ok:#16a34a; --warn:#f97316; --bad:#dc2626;
    }
    html,body{height:100%}
    body{
      font-family:'Cairo',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--ink); background:var(--bg); display:flex; flex-direction:column;
      -webkit-tap-highlight-color:transparent; line-height:1.6;
    }

    /* A11y focus */
    :where(button, a, .chip):focus-visible{
      outline:3px solid color-mix(in oklab, var(--focus) 45%, white);
      outline-offset:2px;
    }
    .chip:focus-visible{ box-shadow:0 0 0 3px rgba(0,0,0,.12); }

    /* Active micro-interaction */
    .btn:active{ transform:translateY(1px); }

    /* Header */
    .app-header{position:sticky;top:0;z-index:70;background:#fff;border-bottom:1px solid var(--rule);backdrop-filter:saturate(1.15) blur(6px)}
    .brand{font-weight:900}
    .cart-btn{position:relative;min-width:46px;min-height:46px;border-radius:var(--radius-pill);border:1px solid var(--rule);background:#fff}
    .cart-badge{position:absolute;top:-6px;inset-inline-start:-6px;background:#111;color:#fff;border-radius:999px;font-size:.75rem;padding:2px 7px;font-weight:900;box-shadow:0 6px 16px rgba(0,0,0,.18)}

    /* Stepper */
    .stepper.nav{gap:8px;align-items:center;overflow:auto;padding:8px 0;border-bottom:1px solid var(--rule)}
    .step.nav-link{display:flex;align-items:center;gap:8px;font-weight:800;color:#6b7280;white-space:nowrap}
    .step .dot{width:28px;height:28px;border-radius:999px;border:2px solid #d1d5db;display:inline-grid;place-items:center;font-size:.9rem}
    .step.active{color:#111}
    .step.active .dot{border-color:#111;color:#111}
    .step.done{color:#16a34a}
    .step.done .dot{border-color:#16a34a;color:#16a34a}
    .step .sep{width:24px;height:2px;background:#e5e7eb}

    /* Top chips & search */
    .chips-wrap{position:sticky;top:calc(var(--header-h));z-index:60;background:#fff;border-bottom:1px solid var(--rule);padding:10px 0}
    .chip{background:var(--chip);color:var(--chip-ink);border:1px solid var(--rule);border-radius:var(--radius-pill);padding:10px 14px;font-weight:800;font-size:.95rem;min-height:44px;transition:all .18s var(--ease)}
    .chip.active{background:#111;color:#fff;border-color:#111}
    .pill-clear{background:#fff;border:1px dashed #bbb}
    .searchbox{border:1px solid var(--rule);border-radius:var(--radius-pill);overflow:hidden;background:#fff}
    .searchbox input{border:0;padding:12px 16px;min-height:46px}

    /* Sticky category label */
    .sticky-cat{
      position:sticky; top:calc(var(--header-h) + 58px); z-index:40; background:#fff;
      border-bottom:1px dashed var(--rule); padding:6px 0 8px; font-weight:800; color:#374151;
    }

    /* Menu */
    main{flex:1 1 auto;display:flex;flex-direction:column}
    .menu-grid{display:grid;gap:14px;grid-template-columns:repeat(1,minmax(0,1fr))}
    @media(min-width:640px){.menu-grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media(min-width:992px){.menu-grid{grid-template-columns:repeat(3,minmax(0,1fr))}}

    /* New Card (image top 16:9) */
    .dish{background:#fff;border:1px solid var(--rule);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);display:flex;flex-direction:column}
    .dish-img{width:100%;aspect-ratio:16/9;object-fit:cover;display:block;background:#f3f4f6}
    .dish-body{padding:12px 12px 14px}
    .dish h6{font-weight:900;margin:0 0 4px}
    .price{font-weight:900}
    .badges{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
    .badges .left{display:flex;gap:6px;flex-wrap:wrap}
    .b{border:1px solid var(--rule);border-radius:999px;padding:3px 8px;font-size:.75rem;font-weight:800}
    .b.hot{border-color:#fecaca;color:#b91c1c;background:#fff5f5}
    .b.new{border-color:#fde68a;color:#b45309;background:#fffbeb}
    .b.best{border-color:#bbf7d0;color:#166534;background:#f0fdf4}
    .b.vegan{border-color:#86efac;color:#166534;background:#f0fdf4}
    .tags{display:flex;flex-wrap:wrap;gap:6px}
    .tag{border:1px solid var(--rule);border-radius:999px;padding:4px 8px;font-size:.8rem;color:#555}
    .more-tags{font-size:.8rem;color:#6b7280}
    .add-wrap{margin-top:10px}
    .add-btn{width:100%;min-height:46px;border-radius:999px;border:1px solid #111;background:#111;color:#fff;font-weight:900}
    .soldout{opacity:.55; filter:grayscale(.2); position:relative}
    .soldout::after{
      content:'ØºÙŠØ± Ù…ØªÙˆÙØ± Ø§Ù„ÙŠÙˆÙ…'; position:absolute; inset:auto 10px 10px auto;
      background:#111;color:#fff; border-radius:999px; padding:6px 10px; font-weight:900; font-size:.85rem
    }

    /* Skeletons */
    .skel{background:linear-gradient(90deg,#eee 25%,#f5f5f5 37%,#eee 63%);background-size:400% 100%;animation:sk 1.2s infinite}
    @keyframes sk{0%{background-position:100% 0}100%{background-position:0 0}}
    .dish.skeleton .dish-img{width:100%;aspect-ratio:16/9}
    .dish.skeleton .dish-body > *{height:14px;margin:10px 0;border-radius:6px}

    /* Cards & forms */
    .cart-card,.card-paper{background:#fff;border:1px solid var(--rule);border-radius:var(--radius);box-shadow:var(--shadow)}
    .line{display:flex;align-items:center;gap:10px;justify-content:space-between;padding:10px 0;border-bottom:1px dashed var(--rule)}
    .seg{display:inline-grid;grid-auto-flow:column;gap:8px;background:#F6F6F6;padding:6px;border-radius:999px;border:1px solid var(--rule)}
    .seg button{background:#fff;border:1px solid var(--rule);border-radius:999px;padding:11px 16px;min-height:46px;font-weight:900}
    .seg button[aria-pressed="true"]{background:#0A0A0A;color:#fff;border-color:#0A0A0A}
    #etaBadge{background:#E6F6FE;color:#0369A1;padding:4px 10px;border-radius:999px;font-weight:800}
    .inp-wrap{position:relative}
    .inp-wrap .ico{position:absolute;inset-inline-start:12px;inset-block-start:50%;transform:translateY(-50%);color:#6b7280;pointer-events:none}
    .pad-icon{padding-inline-start:42px}
    .form-control,.form-select{min-height:56px}

    /* Mini bar */
    .mini-bar{
      position:sticky;bottom:0;z-index:55;background:#0A0A0A;color:#fff;
      padding:10px 12px;border-top:1px solid rgba(255,255,255,.12);
      padding-bottom:calc(14px + env(safe-area-inset-bottom));
    }
    .mini-btn{min-height:52px;border-radius:999px;font-weight:900}

    /* Toast & helpers */
    #toasts{position:fixed;inset-block-start:14px;left:50%;transform:translateX(-50%);z-index:200;display:flex;flex-direction:column;gap:8px}
    .toast-msg{background:#111;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 14px 40px rgba(0,0,0,.25);font-weight:800;transition:transform .18s var(--ease),opacity .18s var(--ease)}
    .spacer{height:18vh}

    /* Thank page extras */
    .ticket{font-weight:900; letter-spacing:2px; font-size:1.35rem; background:#0A0A0A; color:#fff; padding:.4rem .8rem; border-radius:10px;}
    .pill{display:inline-flex; align-items:center; gap:.5rem; border:1px dashed #cbd5e1; padding:.35rem .7rem; border-radius:999px; font-weight:800; font-size:.9rem; color:#475569; background:#f8fafc;}
    .copy-btn{border:1px solid #e5e7eb; border-radius:10px; padding:.35rem .6rem; background:#fff;}

    /* Overlays (App loading + Submit loading) */
    .overlay{
      position:fixed; inset:0; z-index:999; display:none;
      align-items:center; justify-content:center; text-align:center;
      background:rgba(255,255,255,.92); backdrop-filter:blur(6px) saturate(1.1);
    }
    .overlay.show{ display:flex; }
    .overlay .box{
      background:#fff; border:1px solid var(--rule); border-radius:16px;
      padding:18px 20px; box-shadow:var(--shadow); min-width:220px;
    }
    .overlay .msg{ margin-top:.5rem; color:#555; font-weight:800 }

    /* Cart recommendations */
    .reco{border-top:1px dashed var(--rule); padding-top:12px; margin-top:8px}
    .reco h6{font-weight:900; margin:0 0 8px; font-size:.95rem}
    .reco .chip{background:#f4f4f5;border-color:#e4e4e7}
  </style>
</head>
<body>
  <!-- App Loading Overlay -->
  <div id="appLoading" class="overlay" aria-live="polite" aria-busy="true">
    <div class="box">
      <div class="spinner-border" role="status" aria-label="Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„"></div>
      <div class="msg">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©â€¦</div>
    </div>
  </div>

  <!-- Submit/Confirm Overlay -->
  <div id="submitLoading" class="overlay" aria-live="polite" aria-busy="true">
    <div class="box">
      <div class="spinner-border" role="status" aria-label="Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©"></div>
      <div class="msg">Ø¬Ø§Ø±Ù ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨â€¦</div>
    </div>
  </div>

  <!-- Toasts -->
  <div id="toasts" aria-live="polite" aria-atomic="true"></div>

  <!-- Header -->
  <header class="app-header">
    <div class="container py-2 d-flex align-items-center justify-content-between gap-2">
      <div class="d-flex align-items-center gap-3">
        <img src="https://images.unsplash.com/photo-1544025162-d76694265947?q=80&w=120&auto=format&fit=crop" alt="" width="44" height="44" style="border-radius:12px;object-fit:cover" loading="lazy">
        <div>
          <div class="brand">Maison Hikari</div>
          <small class="text-secondary">Ø§Ù„ÙŠØ§Ø¨Ø§Ù†ÙŠ Ø§Ù„Ù…Ø¹Ø§ØµØ±</small>
        </div>
      </div>

      <button id="openCart" class="cart-btn px-3" aria-label="Ø§Ù„Ø³Ù„Ø© (Ø§Ù„Ø®Ø·ÙˆØ© 2)">
        <i class="fa-solid fa-bag-shopping"></i>
        <span id="badge" class="cart-badge" aria-live="polite">0</span>
      </button>
    </div>

    <!-- Stepper -->
    <div class="container">
      <div class="nav stepper" aria-label="Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø·Ù„Ø¨" role="tablist">
        <a class="nav-link step active" data-step="menu"   data-bs-toggle="tab" href="#tab-menu"   role="tab"><span class="dot">1</span> Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©  <span class="sep"></span></a>
        <a class="nav-link step"          data-step="cart"   data-bs-toggle="tab" href="#tab-cart"   role="tab"><span class="dot">2</span> Ø§Ù„Ø³Ù„Ø©   <span class="sep"></span></a>
        <a class="nav-link step"          data-step="data"   data-bs-toggle="tab" href="#tab-data"   role="tab"><span class="dot">3</span> Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª<span class="sep"></span></a>
        <a class="nav-link step"          data-step="thanks" data-bs-toggle="tab" href="#tab-thanks" role="tab"><span class="dot">4</span> ØªÙ…Ù‘</a>
      </div>
    </div>
  </header>

  <main>
    <div class="tab-content flex-1">

      <!-- 1) MENU -->
      <section id="tab-menu" class="tab-pane fade show active">
        <div class="chips-wrap">
          <div class="container">
            <div class="row g-2 align-items-center">
              <div class="col-12 col-lg-8">
                <div id="chips" class="d-flex flex-nowrap gap-2 overflow-auto pb-1" aria-label="ØªØµÙ†ÙŠÙØ§Øª">
                  <button class="chip active" data-cat="all">Ø§Ù„ÙƒÙ„</button>
                  <button class="chip" data-cat="sushi">Ø³ÙˆØ´ÙŠ</button>
                  <button class="chip" data-cat="don">Ø¯ÙˆÙ†</button>
                  <button class="chip" data-cat="meat">Ù„Ø­ÙˆÙ…</button>
                  <button class="chip" data-cat="drinks">Ù…Ø´Ø±ÙˆØ¨Ø§Øª</button>
                  <button id="clearFilters" class="chip pill-clear d-none" type="button">Ù…Ø³Ø­ Ø§Ù„ØªØµÙÙŠØ©</button>
                </div>
              </div>
              <div class="col-12 col-lg-4">
                <div class="searchbox d-flex" role="search">
                  <input id="q" type="search" class="form-control" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø·Ø¨Ù‚ â€¦ (Ø³Ø§Ù„Ù…ÙˆÙ†ØŒ ÙˆØ§Ø¬ÙŠÙˆâ€¦)" autocomplete="off" aria-label="Ø¨Ø­Ø«"/>
                  <button class="btn" aria-label="Ø¨Ø­Ø«"><i class="fa-solid fa-magnifying-glass"></i></button>
                </div>
              </div>
            </div>
            <div class="container sticky-cat"><span id="catNow">Ø§Ù„ÙƒÙ„</span></div>
          </div>
        </div>

        <!-- Menu grid -->
        <div class="container py-3">
          <div id="grid" class="menu-grid" aria-live="polite"></div>
          <div class="spacer"></div>
        </div>

        <!-- Mini checkout bar -->
        <div class="mini-bar">
          <div class="container d-flex align-items-center gap-2">
            <div class="flex-grow-1">
              <div class="d-flex align-items-baseline gap-2">
                <strong id="miniCount" aria-live="polite" aria-atomic="true">0 Ø¹Ù†ØµØ±</strong>
                <span class="text-white-50">â€¢</span>
                <strong id="miniTotal" aria-live="polite" aria-atomic="true">0.00 Ø±.Ø³</strong>
              </div>
              <small class="text-white-50" id="miniProgress">Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© ÙˆØ±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„ ØªÙØ¶Ø§Ù Ù„Ø§Ø­Ù‚Ø§Ù‹</small>
            </div>
            <a id="goCartBtn" href="#tab-cart" class="btn btn-light mini-btn text-dark disabled" aria-disabled="true">Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø³Ù„Ø©</a>
          </div>
        </div>
      </section>

      <!-- 2) CART -->
      <section id="tab-cart" class="tab-pane fade">
        <div class="container py-3">
          <div class="cart-card p-3 p-md-4">
            <h5 class="mb-3"><i class="fa-solid fa-bag-shopping"></i> Ø§Ù„Ø³Ù„Ø©</h5>
            <div id="cartList" class="mb-3"></div>

            <div class="reco" id="recoBox" hidden>
              <h6>Ù…Ù†Ø§Ø³Ø¨ Ù…Ø¹ Ø§Ø®ØªÙŠØ§Ø±Ùƒ</h6>
              <div id="recoChips" class="d-flex flex-wrap gap-2"></div>
            </div>

            <div class="d-flex justify-content-between border-top pt-3">
              <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
              <strong id="cartTotal">0.00 Ø±.Ø³</strong>
            </div>

            <div class="d-flex gap-2 mt-3">
              <a href="#tab-menu" class="btn btn-outline-dark flex-fill py-3 fw-bold" data-go="menu">Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</a>
              <a id="toDataBtn" href="#tab-data" class="btn btn-dark flex-fill py-3 fw-bold disabled" aria-disabled="true" data-go="data">Ù…ØªØ§Ø¨Ø¹Ø©</a>
            </div>
          </div>
        </div>
      </section>

      <!-- 3) CUSTOMER INFO -->
      <section id="tab-data" class="tab-pane fade">
        <div class="container py-4">
          <div class="d-flex align-items-center gap-2 mb-3">
            <div class="seg" aria-label="Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨">
              <button id="segPickup" class="btn" aria-pressed="true" type="button">Ø§Ø³ØªÙ„Ø§Ù…</button>
              <button id="segDelivery" class="btn" aria-pressed="false" type="button">ØªÙˆØµÙŠÙ„</button>
            </div>
            <span id="etaBadge">ETA ~ 15</span>
          </div>

          <div class="card-paper p-3 p-md-4">
            <div class="row g-3">
              <div class="col-12 col-md-6">
                <label class="form-label fw-bold" for="custName">Ø§Ù„Ø§Ø³Ù…</label>
                <div class="inp-wrap">
                  <i class="fa-regular fa-user ico"></i>
                  <input id="custName" class="form-control pad-icon" placeholder="Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„" autocomplete="name"/>
                </div>
                <div id="err-name" class="text-danger small d-none mt-2">ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù…</div>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label fw-bold" for="custPhone">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
                <input id="custPhone" class="form-control" type="tel" placeholder="5XXXXXXXX" inputmode="tel" autocomplete="tel"/>
                <div id="ok-phone" class="text-success small d-none mt-2">Ø±Ù‚Ù… ØµØ­ÙŠØ­ âœ…</div>
                <div id="err-phone" class="text-danger small d-none mt-2">Ø±Ù‚Ù… ØºÙŠØ± ØµØ§Ù„Ø­</div>
              </div>

              <div class="col-12" id="addressWrap" style="display:none">
                <label class="form-label fw-bold" for="address">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                <div class="inp-wrap">
                  <i class="fa-solid fa-location-dot ico"></i>
                  <input id="address" class="form-control pad-icon" placeholder="Ø§Ù„Ø­ÙŠØŒ Ø§Ù„Ø´Ø§Ø±Ø¹ØŒ Ø¹Ù„Ø§Ù…Ø© Ù…Ù…ÙŠØ²Ø©" autocomplete="street-address"/>
                </div>
                <div id="err-address" class="text-danger small d-none mt-2">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù„Ù„ØªÙˆØµÙŠÙ„</div>
                <div class="mt-2 text-secondary small">
                  <i class="fa-regular fa-clock"></i>
                  <span id="typeHint">Ø§Ù„ØªÙˆØµÙŠÙ„ Ø¹Ø§Ø¯Ø© 30â€“45 Ø¯Ù‚ÙŠÙ‚Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹.</span>
                </div>
              </div>

              <div class="col-12">
                <label class="form-label fw-bold" for="notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <textarea id="notes" class="form-control" maxlength="140" placeholder="Ù„Ø§ Ø«Ù„Ø¬ØŒ Ø­Ø§Ø±ØŒ Ø¨Ø¯ÙˆÙ† Ø¨ØµÙ„ â€¦"></textarea>
                <div class="d-flex small text-secondary mt-2">
                  <span>Ù„Ù† ÙŠØªÙ… Ø§Ù„Ø®ØµÙ… Ø§Ù„Ø¢Ù† â€” Ø³ÙŠØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</span>
                  <span class="ms-auto">(<span id="notesCount">0</span>/140)</span>
                </div>
              </div>
            </div>
          </div>

          <div class="d-flex gap-2 mt-3">
            <a href="#tab-cart" class="btn btn-outline-dark flex-fill py-3 fw-bold" data-go="cart">Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø³Ù„Ø©</a>
            <button id="confirmBtn" class="btn btn-dark flex-fill py-3 fw-bold" aria-label="ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</button>
          </div>

          <div class="mt-3 small text-secondary d-flex gap-2 align-items-center">
            <i class="fa-brands fa-whatsapp"></i>
            <a class="link-dark" target="_blank" rel="noopener" href="https://wa.me/966509027172">Ù…Ø­ØªØ§Ø¬ Ù…Ø³Ø§Ø¹Ø¯Ø©ØŸ ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</a>
          </div>
        </div>
        <div class="spacer"></div>
      </section>

      <!-- 4) THANK YOU -->
      <section id="tab-thanks" class="tab-pane fade">
        <div class="container py-5">
          <div class="card-paper p-4 text-center">
            <div class="display-6 mb-2">ğŸ‰ Ø´ÙƒØ±Ø§Ù‹ Ù„Ø·Ù„Ø¨Ùƒ</div>
            <p class="text-secondary mb-4">ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­</p>

            <!-- Ticket & summary -->
            <div class="d-flex flex-column align-items-center gap-3">
              <div class="ticket" id="thTicket">----</div>
              <div class="d-inline-flex flex-wrap gap-2 justify-content-center">
                <span class="pill"><i class="fa-regular fa-calendar"></i><span id="thDate">â€”</span></span>
                <span class="pill"><strong>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</strong>&nbsp;<span id="thOrderId">â€”</span></span>
                <span class="pill"><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong>&nbsp;<span id="thTotal">â€”</span></span>
                <span class="pill" id="thType">â€”</span>
              </div>
              <div class="d-flex gap-2 mt-1">
                <button type="button" id="copyTicket" class="copy-btn"><i class="fa-regular fa-copy"></i> Ù†Ø³Ø® Ø§Ù„ØªØ°ÙƒØ±Ø©</button>
                <button type="button" id="copySummary" class="copy-btn"><i class="fa-regular fa-clipboard"></i> Ù†Ø³Ø® Ø§Ù„Ù…Ù„Ø®Øµ</button>
              </div>
            </div>

            <div class="mt-4 d-flex gap-2 justify-content-center">
              <a href="#tab-menu" id="thBackMenu" class="btn btn-dark" data-go="menu">Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</a>
              <a href="#tab-cart" id="thBackCart" class="btn btn-outline-dark" data-go="cart">Ø¹Ø±Ø¶ Ø§Ù„Ø³Ù„Ø©</a>
            </div>
          </div>
        </div>
      </section>

    </div>
  </main>

  <!-- Options Modal -->
  <div class="modal fade" id="optModal" tabindex="-1" aria-labelledby="optTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title fw-bold" id="optTitle">Ø®ÙŠØ§Ø±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Ø¥ØºÙ„Ø§Ù‚"></button>
        </div>
        <div class="modal-body">
          <div id="optSummary" class="mb-2 text-secondary small"></div>
          <div id="optForm" class="vstack gap-3"></div>
          <div class="d-flex align-items-center justify-content-between mt-3">
            <div class="input-group" style="width:150px">
              <button class="btn btn-outline-dark" id="optMinus" type="button" aria-label="Ø¥Ù†Ù‚Ø§Øµ">âˆ’</button>
              <input id="optQty" class="form-control text-center" type="number" min="1" step="1" value="1">
              <button class="btn btn-dark" id="optPlus" type="button" aria-label="Ø²ÙŠØ§Ø¯Ø©">+</button>
            </div>
            <div class="fw-bold">
              <span>Ø§Ù„Ø³Ø¹Ø±:</span>
              <span id="optPrice">0.00 Ø±.Ø³</span>
            </div>
          </div>
          <div class="mt-3">
            <label class="form-label fw-bold" for="optNotes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„Ù„Ø·Ø¨Ù‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input id="optNotes" class="form-control" maxlength="100" placeholder="Ø¨Ø¯ÙˆÙ† Ø¨ØµÙ„ØŒ ØµÙˆØµ Ø£Ù‚Ù„ â€¦">
          </div>
        </div>
        <div class="modal-footer">
          <button id="optAddBtn" class="btn btn-dark w-100 fw-bold" type="button">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Templates -->
  <template id="catHeaderTpl">
    <div class="card-paper p-2 px-3" data-cat-header="">
      <strong></strong>
    </div>
  </template>

  <template id="dishTpl">
    <div class="dish" data-cat="">
      <img class="dish-img" alt="" width="1200" height="675" loading="lazy"/>
      <div class="dish-body">
        <div class="badges">
          <div class="left"></div>
          <div class="price"></div>
        </div>
        <h6 class="title"></h6>
        <div class="text-secondary small mb-1 desc"></div>
        <div class="d-flex align-items-center justify-content-between">
          <div class="tags"></div>
        </div>
        <div class="add-wrap">
          <button class="add-btn" type="button" aria-label="Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©">Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©</button>
        </div>
      </div>
    </div>
  </template>

  <template id="cartLineTpl">
    <div class="line">
      <div class="d-flex align-items-center gap-2">
        <button class="btn btn-sm btn-outline-dark rounded-pill minus" aria-label="Ø¥Ù†Ù‚Ø§Øµ">âˆ’</button>
        <strong class="qty" aria-live="polite">1</strong>
        <button class="btn btn-sm btn-dark rounded-pill plus" aria-label="Ø²ÙŠØ§Ø¯Ø©">+</button>
      </div>
      <div class="flex-grow-1 text-truncate text-end">
        <div class="fw-bold name"></div>
        <div class="small text-secondary">Ã— <span class="unit">0.00</span> Ø±.Ø³</div>
      </div>
      <div class="text-nowrap fw-bold total">0.00 Ø±.Ø³</div>
    </div>
  </template>

  <!-- JS libs -->
  <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/intlTelInputWithUtils.js"></script>

  <script>
  const GAS_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxyGwCUJRwjVfJDtq5bxqN9Thm_KU4zOfNiNt0ENtW2jbDonr_yp3W2xDZCNXkmSHZNLw/exec';
  const FREE_SHIP = 79; // Ù…Ø«Ø§Ù„ ØªÙˆØµÙŠÙ„ Ù…Ø¬Ø§Ù†ÙŠ

  window.addEventListener('DOMContentLoaded', () => {
    const state = { q:'', cat:'all', cart:{}, menu:[], lastOrder:null, unlockThanks:false, active:'menu' };
    const fmt = new Intl.NumberFormat('ar-SA', { style:'currency', currency:'SAR' });

    /* ===== Helpers ===== */
    function stableId(str){ let h=0; for(let i=0;i<str.length;i++){ h=((h<<5)-h)+str.charCodeAt(i); h|=0;} return 'l_'+Math.abs(h).toString(36); }
    function imgFallback(el){
      el.src='data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="675"><rect width="100%" height="100%" fill="#f3f4f6"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#9ca3af" font-family="Arial" font-size="28">Ù„Ø§ ØµÙˆØ±Ø©</text></svg>`);
    }
    function showOverlay(id, show){ const el=document.getElementById(id); if(!el) return; el.classList.toggle('show', !!show); }
    function toast(msg){
      const box=document.getElementById('toasts'); const el=document.createElement('div');
      el.className='toast-msg'; el.textContent=msg; box.appendChild(el);
      setTimeout(()=>{el.style.opacity='0'; el.style.transform='translateY(-6px)'; setTimeout(()=>el.remove(),180);},2200);
    }

    /* ===== Dynamic header height (for sticky chips offset) ===== */
    const headerEl = document.querySelector('.app-header');
    function setHeaderHeightVar(){
      const h = headerEl?.getBoundingClientRect().height || 64;
      document.documentElement.style.setProperty('--header-h', `${Math.round(h)}px`);
    }
    window.addEventListener('resize', setHeaderHeightVar, {passive:true});
    setHeaderHeightVar();

    /* ===== Stepper / FSM (guards) ===== */
    const steps=['menu','cart','data','thanks'];
    function setStep(active){
      state.active = active;
      document.querySelectorAll('.stepper .step').forEach((el,idx)=>{
        const id=el.dataset.step;
        el.classList.remove('active','done'); if(id===active) el.classList.add('active');
        const activeIdx=steps.indexOf(active); if(idx<activeIdx) el.classList.add('done');
      });
    }
    function showTab(href){ const a=document.querySelector(`[data-bs-toggle="tab"][href="${href}"]`); if(a) bootstrap.Tab.getOrCreateInstance(a).show(); }
    document.addEventListener('shown.bs.tab', e=>{
      const href=e.target && e.target.getAttribute('href'); if(!href) return;
      if(href==='#tab-menu') setStep('menu');
      if(href==='#tab-cart') setStep('cart');
      if(href==='#tab-data') setStep('data');
      if(href==='#tab-thanks') setStep('thanks');
      history.replaceState(null, '', href);
    });

    function cartCount(){ return Object.values(state.cart).reduce((a,b)=>a+b.qty,0); }
    function canGo(target){
      if(target==='menu') return true;
      if(target==='cart') return cartCount()>0;
      if(target==='data') return cartCount()>0;
      if(target==='thanks') return state.unlockThanks === true;
      return false;
    }
    function safeGo(target){
      if(!canGo(target)){
        if(target==='cart' || target==='data') toast('Ø£Ø¶ÙÙ Ø¹Ù†Ø§ØµØ± Ù„Ù„Ø³Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹');
        else if(target==='thanks') toast('Ø£ÙƒÙ…Ù„ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ Ø£ÙˆÙ„Ø§Ù‹');
        else toast('ØªÙ†Ù‚Ù‘Ù„ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­');
        showTab('#tab-'+state.active);
        return false;
      }
      showTab('#tab-'+target);
      return true;
    }
    // Intercept stepper/tab clicks
    document.querySelectorAll('.stepper [data-bs-toggle="tab"]').forEach(a=>{
      a.addEventListener('click', (e)=>{
        e.preventDefault();
        const target = a.dataset.step || (a.getAttribute('href')||'').replace('#tab-','');
        safeGo(target);
      });
      a.addEventListener('show.bs.tab', (e)=>{
        const target = a.dataset.step || (a.getAttribute('href')||'').replace('#tab-','');
        if(!canGo(target)){ e.preventDefault(); }
      });
    });
    // Guard CTA links
    document.body.addEventListener('click', (e)=>{
      const a = e.target.closest('a[href^="#tab-"],[data-go]');
      if(!a) return;
      const to = (a.dataset.go) ? a.dataset.go : (a.getAttribute('href')||'').replace('#tab-','');
      if(['menu','cart','data','thanks'].includes(to)){
        e.preventDefault();
        safeGo(to);
      }
    });
    // Hash nav
    function enforceHashOnLoad(){
      const hash = (location.hash||'#tab-menu').replace('#tab-','');
      if(!canGo(hash)) {
        const fallback = state.unlockThanks ? 'thanks' : (cartCount()>0 ? 'data' : 'menu');
        showTab('#tab-'+fallback);
      } else {
        showTab('#tab-'+hash);
      }
    }
    window.addEventListener('hashchange', ()=> {
      const hash = (location.hash||'').replace('#tab-','');
      if(['menu','cart','data','thanks'].includes(hash)){
        if(!safeGo(hash)) return;
      }
    });

    /* ===== DOM refs ===== */
    const grid=document.getElementById('grid');
    const dishTpl=document.getElementById('dishTpl');
    const catHeaderTpl=document.getElementById('catHeaderTpl');
    const chipsTop=document.getElementById('chips');
    const clearFilters=document.getElementById('clearFilters');
    const search=document.getElementById('q');
    const badge=document.getElementById('badge');
    const miniCount=document.getElementById('miniCount');
    const miniTotal=document.getElementById('miniTotal');
    const miniProgress=document.getElementById('miniProgress');
    const goCartBtn=document.getElementById('goCartBtn');
    const openCartBtn=document.getElementById('openCart');
    const cartList=document.getElementById('cartList');
    const cartLineTpl=document.getElementById('cartLineTpl');
    const cartTotal=document.getElementById('cartTotal');
    const toDataBtn=document.getElementById('toDataBtn');
    const nameEl=document.getElementById('custName');
    const phoneEl=document.getElementById('custPhone');
    const addrWrap=document.getElementById('addressWrap');
    const addrEl=document.getElementById('address');
    const notesEl=document.getElementById('notes');
    const segPick=document.getElementById('segPickup');
    const segDel=document.getElementById('segDelivery');
    const typeHint=document.getElementById('typeHint');
    const confirmBtn=document.getElementById('confirmBtn');
    const thOrderId=document.getElementById('thOrderId');
    const thTotal=document.getElementById('thTotal');
    const thType=document.getElementById('thType');
    const thTicket=document.getElementById('thTicket');
    const thDate=document.getElementById('thDate');
    const catNow = document.getElementById('catNow');
    const recoBox = document.getElementById('recoBox');
    const recoChips = document.getElementById('recoChips');

    /* ===== Data & fetch ===== */
    async function fetchMenu(){
      if(!GAS_WEBAPP_URL) return [];
      try{ const r=await fetch(GAS_WEBAPP_URL+'?action=menu.list'); const j=await r.json(); return j.ok?(j.data||[]):[]; }
      catch(e){ console.error(e); return []; }
    }

    /* ===== Modal: options ===== */
    const optModal=new bootstrap.Modal(document.getElementById('optModal'));
    const optForm=document.getElementById('optForm');
    const optPriceEl=document.getElementById('optPrice');
    const optQtyEl=document.getElementById('optQty');
    let currentItem=null, currentBase=0;

    function buildOptionsUI(item){
      optForm.innerHTML=''; const schema=item.options;
      if(!schema || !schema.groups || !schema.groups.length){
        const p=document.createElement('div'); p.className='text-secondary small'; p.textContent='Ù„Ø§ Ø®ÙŠØ§Ø±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·Ø¨Ù‚.'; optForm.appendChild(p); return;
      }
      schema.groups.forEach(group=>{
        const wrap=document.createElement('div');
        const label=document.createElement('div'); label.className='fw-bold mb-1'; label.textContent=group.label||group.key; wrap.appendChild(label);
        if(group.type==='radio'){
          (group.items||[]).forEach((it,idx)=>{
            const id=`opt-${group.key}-${idx}`;
            const div=document.createElement('div'); div.className='form-check';
            div.innerHTML=`<input class="form-check-input" type="radio" name="${group.key}" id="${id}" value="${it.value}" ${idx===0?'checked':''}>
              <label class="form-check-label" for="${id}">${it.label}${it.delta?` (+${it.delta} Ø±.Ø³)`:''}</label>`;
            wrap.appendChild(div);
          });
        }else if(group.type==='checkbox'){
          (group.items||[]).forEach((it,idx)=>{
            const id=`opt-${group.key}-${idx}`;
            const div=document.createElement('div'); div.className='form-check';
            div.innerHTML=`<input class="form-check-input" type="checkbox" name="${group.key}" id="${id}" value="${it.value}">
              <label class="form-check-label" for="${id}">${it.label}${it.delta?` (+${it.delta} Ø±.Ø³)`:''}</label>`;
            wrap.appendChild(div);
          });
        }
        optForm.appendChild(wrap);
      });
    }

    function selectedOptionsAndDelta(item){
      const schema=item.options; let delta=0; const summary=[]; const result={};
      if(schema && schema.groups){
        schema.groups.forEach(group=>{
          if(group.type==='radio'){
            const chosen=optForm.querySelector(`input[name="${group.key}"]:checked`);
            if(chosen){ const val=chosen.value; result[group.key]=val;
              const meta=(group.items||[]).find(x=>x.value===val); if(meta){ delta+=Number(meta.delta||0); summary.push(`${group.label||group.key}: ${meta.label}`); } }
          } else if(group.type==='checkbox'){
            const list=[...optForm.querySelectorAll(`input[name="${group.key}"]:checked`)];
            result[group.key]=list.map(x=>x.value);
            list.forEach(ch=>{ const meta=(group.items||[]).find(x=>x.value===ch.value); if(meta) delta+=Number(meta.delta||0); });
            if(result[group.key].length){
              const labels=result[group.key].map(v=>{ const m=(group.items||[]).find(x=>x.value===v); return m?m.label:v; }).join('ØŒ ');
              summary.push(`${group.label||group.key}: ${labels}`);
            }
          }
        });
      }
      return { delta, summary, result };
    }
    function updateOptPrice(){ if(!currentItem) return; const {delta}=selectedOptionsAndDelta(currentItem); const unit=currentBase+delta; const qty=Math.max(1,Number(optQtyEl.value||1)); optPriceEl.textContent=fmt.format(unit*qty); }
    document.getElementById('optMinus').onclick=()=>{ optQtyEl.value=Math.max(1,Number(optQtyEl.value||1)-1); updateOptPrice(); };
    document.getElementById('optPlus').onclick =()=>{ optQtyEl.value=Math.max(1,Number(optQtyEl.value||1)+1); updateOptPrice(); };
    optForm.addEventListener('change', updateOptPrice); optQtyEl.addEventListener('input', updateOptPrice);

    function openOptions(item){
      currentItem=item; currentBase=Number(item.price||0);
      document.getElementById('optTitle').textContent=`Ø®ÙŠØ§Ø±Ø§Øª ${item.title}`;
      document.getElementById('optSummary').textContent=item.desc||'';
      document.getElementById('optQty').value=1;
      document.getElementById('optNotes').value='';
      buildOptionsUI(item); updateOptPrice(); optModal.show();
    }

    /* Required options validation */
    function validateRequiredOptions(schema){
      if(!schema || !schema.groups) return {ok:true};
      for(const g of schema.groups){
        if(!g.required) continue;
        if(g.type === 'radio'){
          const chosen = optForm.querySelector(`input[name="${g.key}"]:checked`);
          if(!chosen) return {ok:false, msg:`ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø±: ${g.label||g.key}`};
        } else if(g.type === 'checkbox'){
          const any = optForm.querySelectorAll(`input[name="${g.key}"]:checked`).length>0;
          if(!any) return {ok:false, msg:`ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø¹Ù†ØµØ± ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù…Ù†: ${g.label||g.key}`};
        }
      }
      return {ok:true};
    }

    function addLine(item, qty=1){
      const lineKey=JSON.stringify({id:item.id,opt:null,notes:''});
      const lineId=stableId(lineKey);
      if(state.cart[lineId]) state.cart[lineId].qty+=qty;
      else state.cart[lineId]={lineId, id:item.id, title:item.title, basePrice:Number(item.price||0), unitPrice:Number(item.price||0), qty, options:null, optionsText:'', notes:''};
      bump();
      toast(`Ø£ÙØ¶ÙŠÙ ${item.title} âœ…`);
    }

    function addOrCustomize(item){
      const hasGroups = item.options?.groups?.length > 0;
      const hasRequired = !!item.options?.groups?.some(g=>g.required);
      if(!hasGroups){ addLine(item, 1); return; }
      if(!hasRequired){ addLine(item, 1); toast('Ø£ÙØ¶ÙŠÙ â€” ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ®ØµÙŠØµ Ù…Ù† Ø§Ù„Ø³Ù„Ø©'); return; }
      openOptions(item);
    }

    document.getElementById('optAddBtn').onclick=()=>{
      if(!currentItem) return;
      const v = validateRequiredOptions(currentItem.options);
      if(!v.ok){ toast(v.msg); return; }

      const {delta, summary, result}=selectedOptionsAndDelta(currentItem);
      const unit=currentBase+delta; const qty=Math.max(1,Number(optQtyEl.value||1));
      const notes=(document.getElementById('optNotes').value||'').trim();
      const lineKey=JSON.stringify({id:currentItem.id,opt:result,notes});
      const lineId=stableId(lineKey); const exists=state.cart[lineId];
      if(exists){ exists.qty+=qty; } else {
        state.cart[lineId]={ lineId, id:currentItem.id, title:currentItem.title, basePrice:currentBase, unitPrice:unit, qty, options:result, optionsText:summary.join(' â€¢ '), notes };
      }
      bump(); renderCartList(); toast(`Ø£ÙØ¶ÙŠÙ ${currentItem.title} âœ…`); optModal.hide();
    };

    /* ===== Grid ===== */
    function byCat(a,b){ return (a.cat||'').localeCompare(b.cat||''); }
    function renderCatHeader(label){
      const node=catHeaderTpl.content.firstElementChild.cloneNode(true);
      node.querySelector('strong').textContent=label;
      node.dataset.catHeader = label;
      return node;
    }

    function renderGrid(){
      grid.innerHTML='';
      const q=(state.q||'').trim().toLowerCase();
      const filtered=state.menu.filter(d=>{
        const inCat=(state.cat==='all'||(d.cat||'')===state.cat);
        const inTxt=!q||[d.title||'',d.desc||''].join(' ').toLowerCase().includes(q);
        return inCat && inTxt;
      }).sort(byCat);

      if(filtered.length===0){
        const empty=document.createElement('div'); empty.className='text-center text-secondary py-5';
        empty.innerHTML='Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø·Ø¨Ø§Ù‚ Ù…Ø·Ø§Ø¨Ù‚Ø© â€” Ø¬Ø±Ù‘Ø¨ ØªØµÙ†ÙŠÙ Ø¢Ø®Ø± Ø£Ùˆ ÙƒÙ„Ù…Ø© Ù…Ø®ØªÙ„ÙØ©<br/><br/><strong>Ø§Ù„Ø£ÙƒØ«Ø± Ø·Ù„Ø¨Ù‹Ø§</strong>';
        grid.appendChild(empty);
      }

      let lastCat=null;
      filtered.forEach(d=>{
        if(d.cat!==lastCat){
          grid.appendChild(renderCatHeader(catLabel(d.cat)));
          lastCat=d.cat;
        }
        grid.appendChild(renderDishCard(d));
      });

      clearFilters.classList.toggle('d-none', state.cat==='all' && !state.q.trim());
      observeHeaders();
    }

    function catLabel(key){
      const map={sushi:'Ø³ÙˆØ´ÙŠ', don:'Ø¯ÙˆÙ†', meat:'Ù„Ø­ÙˆÙ…', drinks:'Ù…Ø´Ø±ÙˆØ¨Ø§Øª'};
      return map[key] || 'Ø§Ù„Ù‚Ø³Ù…';
    }

    function renderDishCard(d){
      const node=dishTpl.content.firstElementChild.cloneNode(true);
      node.dataset.cat = d.cat||'';
      const img=node.querySelector('.dish-img');
      img.alt=d.title||''; img.addEventListener('error',()=>imgFallback(img));
      if(d.img && /^https?:\/\//.test(d.img)) img.src=d.img; else imgFallback(img);

      const left=node.querySelector('.badges .left');
      (d.badges||[]).slice(0,2).forEach(b=>{
        const s=document.createElement('span'); s.className='b';
        if(/Ø­Ø§Ø±|hot/i.test(b)) s.classList.add('hot');
        if(/Ø¬Ø¯ÙŠØ¯|new/i.test(b)) s.classList.add('new');
        if(/Ø§Ù„Ø£ÙƒØ«Ø±|best/i.test(b)) s.classList.add('best');
        if(/Ù†Ø¨Ø§ØªÙŠ|vegan/i.test(b)) s.classList.add('vegan');
        s.textContent=b; left.appendChild(s);
      });
      node.querySelector('.price').textContent=fmt.format(Number(d.price||0));
      node.querySelector('.title').textContent=d.title||'â€”';
      node.querySelector('.desc').textContent=d.desc||'';

      const tagsWrap=node.querySelector('.tags');
      const tags = Array.isArray(d.tags)?d.tags:[];
      tags.slice(0,2).forEach(t=>{ const span=document.createElement('span'); span.className='tag'; span.textContent=t; tagsWrap.appendChild(span); });
      if(tags.length>2){ const more=document.createElement('span'); more.className='more-tags'; more.textContent=`+${tags.length-2}`; tagsWrap.appendChild(more); }

      const btn=node.querySelector('.add-btn');
      btn.addEventListener('click', ()=> addOrCustomize({...d}) );

      if(d.available===false){
        node.classList.add('soldout');
        btn.disabled=true; btn.classList.add('disabled'); btn.textContent='ØºÙŠØ± Ù…ØªÙˆÙØ±';
      }

      return node;
    }

    /* Sticky "current category" label using intersection observers */
    let headerObserver=null;
    function observeHeaders(){
      catNow.textContent = state.cat==='all' ? 'Ø§Ù„ÙƒÙ„' : catLabel(state.cat);
      if(headerObserver) headerObserver.disconnect();
      const options={root:document.querySelector('#tab-menu .container.py-3'), rootMargin:'-20% 0px -70% 0px', threshold:0};
      headerObserver=new IntersectionObserver((entries)=>{
        const vis = entries.filter(e=>e.isIntersecting).sort((a,b)=>a.boundingClientRect.top - b.boundingClientRect.top);
        if(vis[0]){ const label = vis[0].target.querySelector('strong')?.textContent || 'Ø§Ù„Ù‚Ø³Ù…'; catNow.textContent = label; }
      }, options);
      document.querySelectorAll('[data-cat-header]').forEach(h=>headerObserver.observe(h));
    }

    /* Skeletons while loading menu */
    function renderSkeleton(n=6){
      grid.innerHTML='';
      for(let i=0;i<n;i++){
        const d=document.createElement('div'); d.className='dish skeleton';
        d.innerHTML=`<div class="dish-img skel"></div><div class="dish-body">
          <div class="skel" style="width:60%"></div>
          <div class="skel" style="width:90%"></div>
          <div class="skel" style="width:40%"></div>
          <div class="skel" style="width:100%;height:42px;border-radius:999px"></div>
        </div>`;
        grid.appendChild(d);
      }
    }

    /* ===== Filters ===== */
    let searchTimer=null;
    search.addEventListener('input', e=>{ clearTimeout(searchTimer); searchTimer=setTimeout(()=>{ state.q=e.target.value; renderGrid(); },180); });
    clearFilters.addEventListener('click', ()=>{ state.q=''; search.value=''; state.cat='all'; document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active')); document.querySelector('.chip[data-cat="all"]').classList.add('active'); renderGrid(); });
    chipsTop.addEventListener('click', e=>{ const b=e.target.closest('.chip'); if(!b||b.id==='clearFilters') return; document.querySelectorAll('.chip').forEach(x=>x.classList.remove('active')); b.classList.add('active'); state.cat=b.dataset.cat; renderGrid(); });

    /* ===== Cart, totals, free-ship progress, recommendations ===== */
    function cartArr(){ return Object.values(state.cart); }
    function totals(){ const arr=cartArr(); return { count:arr.reduce((a,b)=>a+b.qty,0), total:arr.reduce((a,b)=>a+b.qty*b.unitPrice,0), arr }; }
    function updateProgress(total){
      if(total<=0){ miniProgress.textContent='Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© ÙˆØ±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„ ØªÙØ¶Ø§Ù Ù„Ø§Ø­Ù‚Ø§Ù‹'; return; }
      const need = Math.max(0, FREE_SHIP - total);
      miniProgress.textContent = need>0 ? `ØªØ¨Ù‚Ù‰ ${need.toFixed(2)} Ø±.Ø³ Ù„Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ ğŸ` : `ğŸ Ø­ØµÙ„Øª Ø¹Ù„Ù‰ ØªÙˆØµÙŠÙ„ Ù…Ø¬Ø§Ù†ÙŠ`;
    }
    function bump(){
      const t=totals();
      badge.textContent=t.count; miniCount.textContent=`${t.count} Ø¹Ù†ØµØ±`; miniTotal.textContent=fmt.format(t.total); cartTotal.textContent=fmt.format(t.total);
      renderCartList(); localStorage.setItem('hk_cart_v3', JSON.stringify(state.cart));
      const has=t.count>0; goCartBtn.classList.toggle('disabled',!has); goCartBtn.setAttribute('aria-disabled',String(!has)); toDataBtn.classList.toggle('disabled',!has); toDataBtn.setAttribute('aria-disabled',String(!has));
      updateProgress(t.total);
      renderRecommendations();
    }
    const saved=localStorage.getItem('hk_cart_v3'); if(saved){ try{ state.cart=JSON.parse(saved)||{}; }catch{} }

    function renderCartList(){
      cartList.innerHTML='';
      const {arr}=totals();
      if(arr.length===0){ const p=document.createElement('p'); p.className='text-secondary text-center my-4'; p.textContent='Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©'; cartList.appendChild(p); recoBox.hidden=true; return; }
      arr.forEach(it=>{
        const row=cartLineTpl.content.firstElementChild.cloneNode(true);
        row.querySelector('.name').textContent=it.title;
        row.querySelector('.unit').textContent=Number(it.unitPrice||0).toFixed(2);
        row.querySelector('.qty').textContent=it.qty;
        row.querySelector('.total').textContent=fmt.format(it.qty*it.unitPrice);
        row.querySelector('.minus').addEventListener('click', ()=>{ if(!state.cart[it.lineId]) return; state.cart[it.lineId].qty--; if(state.cart[it.lineId].qty<=0) delete state.cart[it.lineId]; bump(); });
        row.querySelector('.plus').addEventListener('click',  ()=>{ if(!state.cart[it.lineId]) return; state.cart[it.lineId].qty++; bump(); });
        cartList.appendChild(row);
      });
    }

    function pickRecommendations(){
      // very light heuristic: if any sushi in cart â†’ suggest drinks; if drinksâ†’ suggest sushi/don
      const arr = cartArr();
      const hasSushi = arr.some(l=> (state.menu.find(m=>m.id===l.id)?.cat)==='sushi');
      const hasDrinks = arr.some(l=> (state.menu.find(m=>m.id===l.id)?.cat)==='drinks');
      let pool = [];
      if(hasSushi) pool = state.menu.filter(m=>m.cat==='drinks');
      else if(hasDrinks) pool = state.menu.filter(m=>m.cat==='sushi' || m.cat==='don');
      else pool = state.menu.filter(m=>m.badges?.some(b=>/Ø§Ù„Ø£ÙƒØ«Ø±|best/i.test(b)));
      return pool.slice(0,6);
    }
    function renderRecommendations(){
      const {count}=totals();
      const recos = count ? pickRecommendations() : [];
      if(!recos.length){ recoBox.hidden=true; return; }
      recoBox.hidden=false; recoChips.innerHTML='';
      recos.forEach(r=>{
        const b=document.createElement('button');
        b.className='chip'; b.textContent = r.title + ' â€¢ ' + fmt.format(Number(r.price||0));
        b.addEventListener('click', ()=> addOrCustomize(r));
        recoChips.appendChild(b);
      });
    }

    openCartBtn.addEventListener('click', ()=>{ safeGo('cart'); renderCartList(); });

    /* ===== Form & phone ===== */
    const iti=window.intlTelInput(phoneEl,{
      initialCountry:'sa',
      preferredCountries:['sa','ae'],
      onlyCountries:['sa','ae','bh','kw','om','qa'],
      nationalMode:true,
      autoPlaceholder:'aggressive',
      utilsScript:'https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/utils.js',
      separateDialCode:true
    });
    function setType(delivery){ segPick.setAttribute('aria-pressed',String(!delivery)); segDel.setAttribute('aria-pressed',String(delivery)); addrWrap.style.display=delivery?'':'none'; typeHint.textContent=delivery?'Ø§Ù„ØªÙˆØµÙŠÙ„ Ø¹Ø§Ø¯Ø© 30â€“45 Ø¯Ù‚ÙŠÙ‚Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹.':'Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù† Ø§Ù„Ù…Ø·Ø¹Ù… Ø£Ø³Ø±Ø¹ (10â€“15 Ø¯Ù‚ÙŠÙ‚Ø©).'; if(delivery) setTimeout(()=>addrEl.focus(),80); }
    segPick.onclick=()=>setType(false); segDel.onclick=()=>setType(true); setType(false);
    notesEl.addEventListener('input', ()=>{ document.getElementById('notesCount').textContent=(notesEl.value||'').length; });

    function validate(){
      const nameOk=(nameEl.value||'').trim().length>1;
      let phoneOk=false; try{ phoneOk=iti.isValidNumber(); }catch(_){ phoneOk=(phoneEl.value||'').trim().length>=8; }
      const delivery=segDel.getAttribute('aria-pressed')==='true';
      const addressOk=!delivery || (addrEl.value||'').trim().length>3;
      document.getElementById('err-name').classList.toggle('d-none',nameOk);
      document.getElementById('ok-phone').classList.toggle('d-none',!phoneOk);
      document.getElementById('err-phone').classList.toggle('d-none',phoneOk);
      document.getElementById('err-address').classList.toggle('d-none',addressOk);
      return nameOk && phoneOk && addressOk;
    }
    ['input','blur'].forEach(ev=>{
      nameEl.addEventListener(ev, validate);
      phoneEl.addEventListener(ev, ()=>setTimeout(validate, ev==='blur'?0:120));
      addrEl.addEventListener(ev, validate);
    });

    /* ===== Thank page helpers (Daily 4-digit Ticket) ===== */
    function todayKey(){
      const d=new Date(); const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }
    function nextDailyTicketLocal(){
      const key = todayKey();
      const savedDay = localStorage.getItem('hk_ticket_day');
      let seq = Number(localStorage.getItem('hk_ticket_seq')||0);
      if(savedDay !== key){ seq = 0; }
      seq = (seq % 9999) + 1;
      localStorage.setItem('hk_ticket_day', key);
      localStorage.setItem('hk_ticket_seq', String(seq));
      return String(seq).padStart(4,'0');
    }
    function setThankDate(value){
      if(value){ thDate.textContent = value; return; }
      const d=new Date();
      thDate.textContent = d.toLocaleDateString('ar-SA', { weekday:'short', year:'numeric', month:'2-digit', day:'2-digit' });
    }
    async function copy(text){
      try{ await navigator.clipboard.writeText(text); toast('ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…'); }catch{ toast('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ù†Ø³Ø®'); }
    }

    async function createOrder(payload){
      const r=await fetch(GAS_WEBAPP_URL+'?action=order.create',{ method:'POST', headers:{'Content-Type':'text/plain'}, body:JSON.stringify(payload) });
      return r.json();
    }

    function renderThanks({orderId, totals, payload, ticket4, ticketDate}){
      const t4 = (ticket4 && String(ticket4).padStart(4,'0')) || nextDailyTicketLocal();
      thTicket.textContent = t4;
      setThankDate(ticketDate);

      thOrderId.textContent = orderId || 'â€”';
      thTotal.textContent = typeof totals?.total === 'number' ? fmt.format(totals.total) : 'â€”';
      thType.textContent = payload.type==='delivery'?'Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨: ØªÙˆØµÙŠÙ„':'Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨: Ø§Ø³ØªÙ„Ø§Ù…';

      document.getElementById('copyTicket').onclick = ()=>copy(`ØªØ°ÙƒØ±Ø© ${t4} â€¢ ${ticketDate||todayKey()}`);
      // WhatsApp summary: ticket ONLY
      document.getElementById('copySummary').onclick = ()=>{
        const txt = `Ø·Ù„Ø¨ Maison Hikari
ØªØ°ÙƒØ±Ø©: ${t4} â€” ${thDate.textContent.trim()}
Ø§Ù„Ù†ÙˆØ¹: ${payload.type==='delivery'?'ØªÙˆØµÙŠÙ„':'Ø§Ø³ØªÙ„Ø§Ù…'}
Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${thTotal.textContent}`;
        copy(txt);
      };
    }

    function reviewText(t, payload){
      const items = t.arr.map(x=>`â€¢ ${x.title} Ã—${x.qty} â€” ${x.unitPrice.toFixed(2)} Ø±.Ø³`).join('\n');
      const addr = payload.type==='delivery' ? `\nØ§Ù„Ø¹Ù†ÙˆØ§Ù†: ${payload.address}` : '';
      return `Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨:
Ø§Ù„Ø§Ø³Ù…: ${payload.name}
Ø§Ù„Ø¬ÙˆØ§Ù„: ${payload.phone}
Ø§Ù„Ù†ÙˆØ¹: ${payload.type==='delivery'?'ØªÙˆØµÙŠÙ„':'Ø§Ø³ØªÙ„Ø§Ù…'}${addr}
Ø§Ù„Ø¹Ù†Ø§ØµØ±:
${items}
Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${t.total.toFixed(2)} Ø±.Ø³
ØªØ£ÙƒÙŠØ¯ØŸ`;
    }

    /* ===== Confirm & finish (with SUBMIT overlay) ===== */
    confirmBtn.onclick=async()=>{
      const t=totals();
      if(t.count===0){ toast('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©'); safeGo('menu'); return; }
      if(!validate()){ window.scrollTo({top:0,behavior:'smooth'}); toast('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©'); return; }

      let phone=phoneEl.value.trim(); try{ phone=iti.getNumber(); }catch(_){}
      const payload={ type: segDel.getAttribute('aria-pressed')==='true'?'delivery':'pickup', name:nameEl.value.trim(), phone, address:addrEl.value.trim(), notes:notesEl.value.trim(),
        items: cartArr().map(x=>({ lineId:x.lineId, id:x.id, title:x.title, qty:x.qty, price:x.unitPrice, options:x.options, optionsText:x.optionsText, lineNotes:x.notes })) };

      if(!confirm(reviewText(t, payload))) return;

      confirmBtn.disabled=true; confirmBtn.classList.add('disabled');
      showOverlay('submitLoading', true);
      try{
        const res=await createOrder(payload);
        if(res && res.ok){
          localStorage.setItem('hk_user_v1', JSON.stringify({name:payload.name, phone:phoneEl.value, address:payload.address}));
          state.cart={}; bump();

          renderThanks({ orderId:res.orderId, totals:res.totals||{}, payload, ticket4:res.ticket4, ticketDate:res.ticketDate });

          state.unlockThanks = true;
          safeGo('thanks');
        } else {
          toast('ØªØ¹Ø°Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§'); console.error(res);
        }
      } catch(err){ toast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø¯Ù…Ø©'); console.error(err); }
      finally{
        confirmBtn.disabled=false; confirmBtn.classList.remove('disabled');
        showOverlay('submitLoading', false);
      }
    };

    /* ===== Prefill & INIT (with APP LOADING overlay + skeletons) ===== */
    try{
      const savedInfo=JSON.parse(localStorage.getItem('hk_user_v1')||'{}');
      if(savedInfo.name) nameEl.value=savedInfo.name;
      if(savedInfo.phone) phoneEl.value=savedInfo.phone;
      if(savedInfo.address){ addrEl.value=savedInfo.address; setType(true); }
    }catch(_){}

    (async()=>{
      setStep('menu');
      showOverlay('appLoading', true);
      renderSkeleton(6);
      let hideTimer = setTimeout(()=>showOverlay('appLoading', false), 10000);
      state.menu=await fetchMenu();
      if(!state.menu.length) setTimeout(()=>toast('Ù„Ù… ÙŠØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…Ù† Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¨Ø¹Ø¯'),600);
      renderGrid(); bump(); renderCartList(); enforceHashOnLoad();
      showOverlay('appLoading', false);
      clearTimeout(hideTimer);
    })();
  });
  </script>
</body>
</html>
