<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Maison Hikari â€¢ Ø§Ù„Ø·Ù„Ø¨</title>

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

  <!-- Bootstrap & Intl Tel Input -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/css/intlTelInput.css" rel="stylesheet"/>

  <meta name="theme-color" content="#141414" />
  <meta name="description" content="Maison Hikari â€” Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†" />

  <style>
    :root{
      --charcoal:#141414;     /* page bg */
      --porcelain:#F3F3F3;    /* cards bg */
      --ink-dark:#EDEBE6;     /* text on dark */
      --ink:#111;             /* text on light */
      --gold:#D4AF37;         /* brand/CTA */
      --rule-dark:rgba(255,255,255,.12);
      --rule:rgba(0,0,0,.12);
      --radius:14px; --radius-pill:999px; --shadow:0 10px 30px rgba(0,0,0,.25);
      --topbar-h:56px; --chips-h:0px;
    }
    html,body{height:100%}
    html{scroll-behavior:smooth}
    body{
      font-family:'Cairo',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--charcoal); color:var(--ink-dark);
      display:flex; flex-direction:column; -webkit-tap-highlight-color:transparent;
    }

    /* Header */
    .app-header{position:sticky;top:0;z-index:70;background:#181818;border-bottom:1px solid var(--rule-dark);backdrop-filter:saturate(1.05) blur(6px)}
    .brand{font-weight:900}
    .cart-btn{position:relative;min-width:44px;min-height:44px;border-radius:var(--radius-pill);border:1px solid var(--rule-dark);background:transparent;color:#fff}
    .cart-badge{position:absolute;top:-6px;inset-inline-start:-6px;background:var(--gold);color:#141414;border-radius:999px;font-size:.75rem;padding:2px 7px;font-weight:900;box-shadow:0 6px 16px rgba(0,0,0,.4)}

    /* Chips (sticky under header) */
    .chips-wrap{
      position:sticky; top:var(--topbar-h); z-index:60;
      background:#1b1b1b; border-bottom:1px solid var(--rule-dark);
      transition: box-shadow .18s ease;
    }
    body.scrolled .chips-wrap{ box-shadow:0 8px 24px rgba(0,0,0,.35); }
    #chips{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; padding:10px 0; }
    .chip{ background:#F2F2F2; color:#111; border:1px solid var(--rule); border-radius:var(--radius-pill); padding:10px 14px; font-weight:800; min-height:44px; flex:0 0 auto; }
    .chip.active{ background:var(--gold); color:#141414; border-color:var(--gold); }
    .pill-clear{ background:transparent; color:#fff; border:1px dashed var(--rule-dark); }

    .searchbox{display:flex;align-items:center;gap:6px;border:1px solid var(--rule-dark);border-radius:var(--radius-pill);background:#0e0e0e;padding-inline:8px}
    .searchbox input{border:0;min-height:46px;color:#fff;background:transparent;padding:10px 14px;width:240px}

    /* Sections */
    .menu-section{scroll-margin-top: calc(var(--topbar-h) + var(--chips-h) + 12px); padding-top:8px;}
    .sec-title{margin:12px 0;font-weight:900;color:#fff}

    /* Menu cards */
    .menu-grid{display:grid;gap:14px;grid-template-columns:repeat(1,minmax(0,1fr))}
    @media(min-width:640px){.menu-grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media(min-width:992px){.menu-grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
    .dish{background:var(--porcelain);color:var(--ink);border:1px solid var(--rule);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);display:flex;flex-direction:column}
    .dish-img{width:100%;aspect-ratio:16/9;object-fit:cover;background:#e9e6df}
    .dish-body{padding:12px 12px 14px}
    .price{font-weight:900;color:var(--gold)}
    .tag{background:#eee;border:1px solid var(--rule);border-radius:999px;padding:4px 8px;font-size:.8rem;margin-inline-start:6px}
    .add-btn{width:100%;min-height:46px;border-radius:999px;border:1px solid var(--gold);background:var(--gold);color:#141414;font-weight:900}

    /* Cards/forms */
    .card-paper,.cart-card{background:var(--porcelain);color:var(--ink);border:1px solid var(--rule);border-radius:var(--radius);box-shadow:var(--shadow)}
    .line{display:flex;align-items:center;gap:10px;justify-content:space-between;padding:10px 0;border-bottom:1px dashed var(--rule)}

    /* Mini bar */
    .mini-bar{position:sticky;bottom:0;z-index:55;background:#101010;color:#fff;padding:10px 12px;border-top:1px solid var(--rule-dark);padding-bottom:calc(14px + env(safe-area-inset-bottom))}
    .mini-btn{min-height:52px;border-radius:999px;font-weight:900}

    /* Toast */
    #toasts{position:fixed;inset-block-start:14px;left:50%;transform:translateX(-50%);z-index:200;display:flex;flex-direction:column;gap:8px}
    .toast-msg{background:#171717;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 14px 40px rgba(0,0,0,.5);font-weight:800;border:1px solid var(--rule-dark)}

    /* Overlays */
    .overlay{position:fixed; inset:0; z-index:999; display:none; align-items:center; justify-content:center; text-align:center; background:rgba(20,20,20,.9); backdrop-filter:blur(6px); color:#fff}
    .overlay.show{display:flex}
    .overlay .box{background:#fff;color:#111;border:1px solid var(--rule);border-radius:16px;padding:18px 20px;box-shadow:var(--shadow);min-width:220px}
    .overlay .msg{margin-top:.5rem;color:#444;font-weight:800}

    /* Focus */
    :where(a,button,[role="button"],input,select,textarea):focus-visible{
      outline:2px solid var(--gold); outline-offset:2px; box-shadow:0 0 0 4px rgba(212,175,55,.25);
    }
  </style>
</head>
<body>
  <!-- Overlays -->
  <div id="appLoading" class="overlay" aria-live="polite" aria-busy="true">
    <div class="box">
      <div class="spinner-border text-warning" role="status" aria-label="Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„"></div>
      <div class="msg">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©â€¦</div>
    </div>
  </div>
  <div id="submitLoading" class="overlay" aria-live="polite" aria-busy="true">
    <div class="box">
      <div class="spinner-border text-warning" role="status" aria-label="Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©"></div>
      <div class="msg">Ø¬Ø§Ø±Ù ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨â€¦</div>
    </div>
  </div>
  <div id="toasts" aria-live="polite" aria-atomic="true"></div>

  <!-- Header -->
  <header class="app-header" id="topbar">
    <div class="container py-2 d-flex align-items-center justify-content-between gap-2">
      <div class="d-flex align-items-center gap-3">
        <img src="https://images.unsplash.com/photo-1544025162-d76694265947?q=80&w=120&auto=format&fit=crop" alt="" width="44" height="44" style="border-radius:12px;object-fit:cover" loading="lazy">
        <div>
          <div class="brand">Maison Hikari</div>
          <small class="text-secondary" style="color:#c9c6bf !important">Ø§Ù„ÙŠØ§Ø¨Ø§Ù†ÙŠ Ø§Ù„Ù…Ø¹Ø§ØµØ±</small>
        </div>
      </div>
      <button id="openCart" class="cart-btn px-3" aria-label="Ø§Ù„Ø³Ù„Ø© (Ø§Ù„Ø®Ø·ÙˆØ© 2)">
        <i class="fa-solid fa-bag-shopping"></i>
        <span id="badge" class="cart-badge" aria-live="polite">0</span>
      </button>
    </div>
  </header>

  <!-- Chips + Search (sticky) -->
  <div class="chips-wrap" id="chipsWrap">
    <div class="container">
      <div id="chips" aria-label="ØªØµÙ†ÙŠÙØ§Øª">
        <button class="chip active" data-target="#topOfMenu">Ø§Ù„ÙƒÙ„</button>
        <button class="chip" data-target="#sec-sushi">Ø³ÙˆØ´ÙŠ</button>
        <button class="chip" data-target="#sec-don">Ø¯ÙˆÙ†</button>
        <button class="chip" data-target="#sec-meat">Ù„Ø­ÙˆÙ…</button>
        <button class="chip" data-target="#sec-drinks">Ù…Ø´Ø±ÙˆØ¨Ø§Øª</button>

        <div class="ms-auto" style="min-width:260px;flex:1 1 260px">
          <div class="searchbox d-flex" role="search" aria-label="Ø¨Ø­Ø«">
            <input id="q" type="search" class="form-control" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø·Ø¨Ù‚ â€¦ (Ø³Ø§Ù„Ù…ÙˆÙ†ØŒ ÙˆØ§Ø¬ÙŠÙˆâ€¦)" autocomplete="off" aria-label="Ø¨Ø­Ø«"/>
            <button class="btn" aria-label="Ø¨Ø­Ø«"><i class="fa-solid fa-magnifying-glass"></i></button>
          </div>
        </div>

        <button id="clearFilters" class="chip pill-clear d-none" type="button">Ù…Ø³Ø­ Ø§Ù„ØªØµÙÙŠØ©</button>
      </div>
    </div>
  </div>

  <!-- Content -->
  <main id="topOfMenu">
    <div class="tab-content flex-1">
      <!-- MENU -->
      <section id="tab-menu" class="tab-pane fade show active">
        <div class="container py-3" id="menuContainer">
          <div id="menuSections"></div>
          <p id="emptyMsg" class="text-secondary text-center my-5 d-none" style="color:#c9c6bf !important">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø·Ø¨Ø§Ù‚ Ù…Ø·Ø§Ø¨Ù‚Ø© â€” Ø¬Ø±Ù‘Ø¨ ÙƒÙ„Ù…Ø© Ø¨Ø­Ø« Ù…Ø®ØªÙ„ÙØ©</p>
          <div style="height:18vh"></div>
        </div>

        <!-- Mini checkout bar -->
        <div class="mini-bar">
          <div class="container d-flex align-items-center gap-2">
            <div class="flex-grow-1">
              <div class="d-flex align-items-baseline gap-2">
                <strong id="miniCount" aria-live="polite" aria-atomic="true">0 Ø¹Ù†ØµØ±</strong>
                <span class="text-white-50">â€¢</span>
                <strong id="miniTotal" aria-live="polite" aria-atomic="true">0.00 Ø±.Ø³</strong>
              </div>
              <small class="text-white-50" id="miniHint">Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© ÙˆØ±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„ ØªÙØ¶Ø§Ù Ù„Ø§Ø­Ù‚Ø§Ù‹</small>
            </div>
            <a id="goCartBtn" href="#tab-cart" class="btn btn-light mini-btn text-dark disabled" aria-disabled="true">Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø³Ù„Ø©</a>
          </div>
        </div>
      </section>

      <!-- CART -->
      <section id="tab-cart" class="tab-pane fade">
        <div class="container py-3">
          <div class="cart-card p-3 p-md-4">
            <h5 class="mb-3"><i class="fa-solid fa-bag-shopping"></i> Ø§Ù„Ø³Ù„Ø©</h5>
            <div id="cartList" class="mb-3"></div>
            <div class="d-flex justify-content-between border-top pt-3" style="border-color:var(--rule)!important">
              <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span> <strong id="cartTotal">0.00 Ø±.Ø³</strong>
            </div>
            <div class="d-flex gap-2 mt-3">
              <a href="#tab-menu" class="btn btn-outline-dark flex-fill py-3 fw-bold" data-go="menu">Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</a>
              <a id="toDataBtn" href="#tab-data" class="btn btn-dark flex-fill py-3 fw-bold disabled" aria-disabled="true" data-go="data">Ù…ØªØ§Ø¨Ø¹Ø©</a>
            </div>
          </div>
        </div>
      </section>

      <!-- CUSTOMER DATA -->
      <section id="tab-data" class="tab-pane fade">
        <div class="container py-4">
          <div class="card-paper p-3 p-md-4">
            <div class="row g-3">
              <div class="col-12 col-md-6">
                <label class="form-label fw-bold" for="custName">Ø§Ù„Ø§Ø³Ù…</label>
                <input id="custName" class="form-control" placeholder="Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„" autocomplete="name" required/>
                <div id="err-name" class="text-danger small d-none mt-2">ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù…</div>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label fw-bold" for="custPhone">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
                <input id="custPhone" class="form-control" type="tel" placeholder="5XXXXXXXX" inputmode="tel" autocomplete="tel" required/>
                <div id="ok-phone" class="text-success small d-none mt-2">Ø±Ù‚Ù… ØµØ­ÙŠØ­ âœ…</div>
                <div id="err-phone" class="text-danger small d-none mt-2">Ø±Ù‚Ù… ØºÙŠØ± ØµØ§Ù„Ø­</div>
              </div>
              <div class="col-12" id="addressWrap" style="display:none">
                <label class="form-label fw-bold" for="address">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                <input id="address" class="form-control" placeholder="Ø§Ù„Ø­ÙŠØŒ Ø§Ù„Ø´Ø§Ø±Ø¹ØŒ Ø¹Ù„Ø§Ù…Ø© Ù…Ù…ÙŠØ²Ø©" autocomplete="street-address"/>
                <div id="err-address" class="text-danger small d-none mt-2">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù„Ù„ØªÙˆØµÙŠÙ„</div>
                <div class="mt-2 small" style="color:#4a4741"><i class="fa-regular fa-clock"></i> Ø§Ù„ØªÙˆØµÙŠÙ„ Ø¹Ø§Ø¯Ø© 30â€“45 Ø¯Ù‚ÙŠÙ‚Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹.</div>
              </div>
              <div class="col-12">
                <label class="form-label fw-bold" for="notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <textarea id="notes" class="form-control" maxlength="140" placeholder="Ù„Ø§ Ø«Ù„Ø¬ØŒ Ø­Ø§Ø±ØŒ Ø¨Ø¯ÙˆÙ† Ø¨ØµÙ„ â€¦"></textarea>
                <div class="d-flex small mt-2" style="color:#4a4741">
                  <span>Ù†Ø­Ø§ÙˆÙ„ ØªÙ†ÙÙŠØ° ØªÙØ¶ÙŠÙ„Ø§ØªÙƒ Ø¨Ù‚Ø¯Ø± Ø§Ù„Ø¥Ù…ÙƒØ§Ù†</span>
                  <span class="ms-auto">(<span id="notesCount">0</span>/140)</span>
                </div>
              </div>
            </div>
          </div>

          <div class="d-flex gap-2 mt-3">
            <a href="#tab-cart" class="btn btn-outline-dark flex-fill py-3 fw-bold" data-go="cart">Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø³Ù„Ø©</a>
            <button id="confirmBtn" class="btn btn-dark flex-fill py-3 fw-bold" aria-label="ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</button>
          </div>
        </div>
        <div style="height:18vh"></div>
      </section>

      <!-- THANKS -->
      <section id="tab-thanks" class="tab-pane fade">
        <div class="container py-5">
          <div class="card-paper p-4 text-center">
            <div class="display-6 mb-2" style="color:#141414">ğŸ‰ Ø´ÙƒØ±Ø§Ù‹ Ù„Ø·Ù„Ø¨Ùƒ</div>
            <p class="mb-4" style="color:#4a4741">ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­</p>
            <div class="d-flex flex-column align-items-center gap-3">
              <div class="ticket" id="thTicket" style="font-weight:900;letter-spacing:2px;font-size:1.35rem;background:#141414;color:#fff;padding:.4rem .8rem;border-radius:10px;">----</div>
              <div class="d-inline-flex flex-wrap gap-2 justify-content:center">
                <span class="badge bg-light text-dark border"><i class="fa-regular fa-calendar"></i> <span id="thDate">â€”</span></span>
                <span class="badge bg-light text-dark border"><strong>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</strong>&nbsp;<span id="thOrderId">â€”</span></span>
                <span class="badge bg-light text-dark border"><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong>&nbsp;<span id="thTotal">â€”</span></span>
                <span class="badge bg-light text-dark border" id="thType">â€”</span>
              </div>
              <div class="d-flex gap-2 mt-1">
                <button type="button" id="copyTicket" class="btn btn-outline-dark btn-sm"><i class="fa-regular fa-copy"></i> Ù†Ø³Ø® Ø§Ù„ØªØ°ÙƒØ±Ø©</button>
                <button type="button" id="copySummary" class="btn btn-outline-dark btn-sm"><i class="fa-regular fa-clipboard"></i> Ù†Ø³Ø® Ø§Ù„Ù…Ù„Ø®Øµ</button>
              </div>
            </div>
            <div class="d-flex gap-2 justify-content-center mt-3">
              <a href="#tab-menu" id="thBackMenu" class="btn btn-dark" data-go="menu">Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</a>
              <a href="#tab-cart" id="thBackCart" class="btn btn-outline-dark" data-go="cart">Ø¹Ø±Ø¶ Ø§Ù„Ø³Ù„Ø©</a>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- Options Modal -->
  <div class="modal fade" id="optModal" tabindex="-1" aria-labelledby="optTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title fw-bold" id="optTitle">Ø®ÙŠØ§Ø±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Ø¥ØºÙ„Ø§Ù‚"></button>
        </div>
        <div class="modal-body">
          <div id="optSummary" class="mb-2 small" style="color:#4a4741"></div>
          <div id="optForm" class="vstack gap-3"></div>
          <div class="d-flex align-items-center justify-content-between mt-3">
            <div class="input-group" style="width:160px">
              <button class="btn btn-outline-dark" id="optMinus" type="button" aria-label="Ø¥Ù†Ù‚Ø§Øµ">âˆ’</button>
              <input id="optQty" class="form-control text-center" type="number" min="1" step="1" value="1">
              <button class="btn btn-dark" id="optPlus" type="button" aria-label="Ø²ÙŠØ§Ø¯Ø©">+</button>
            </div>
            <div class="fw-bold"><span>Ø§Ù„Ø³Ø¹Ø±:</span> <span id="optPrice" style="color:var(--gold)">0.00 Ø±.Ø³</span></div>
          </div>
          <div class="mt-3">
            <label class="form-label fw-bold" for="optNotes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„Ù„Ø·Ø¨Ù‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input id="optNotes" class="form-control" maxlength="100" placeholder="Ø¨Ø¯ÙˆÙ† Ø¨ØµÙ„ØŒ ØµÙˆØµ Ø£Ù‚Ù„ â€¦">
          </div>
        </div>
        <div class="modal-footer">
          <button id="optAddBtn" class="btn btn-dark w-100 fw-bold" type="button">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Templates -->
  <template id="dishTpl">
    <div class="dish" data-cat="">
      <img class="dish-img" alt="" width="1200" height="675" loading="lazy" decoding="async" fetchpriority="low"/>
      <div class="dish-body">
        <div class="d-flex align-items-center justify-content-between mb-1">
          <strong class="price"></strong>
          <div class="tags"></div>
        </div>
        <h6 class="title"></h6>
        <div class="small mb-1 desc"></div>
        <div class="add-wrap">
          <button class="add-btn" type="button" aria-label="Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©">Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©</button>
        </div>
      </div>
    </div>
  </template>

  <template id="cartLineTpl">
    <div class="line">
      <div class="d-flex align-items-center gap-2">
        <button class="btn btn-sm btn-outline-dark rounded-pill minus" aria-label="Ø¥Ù†Ù‚Ø§Øµ">âˆ’</button>
        <strong class="qty" aria-live="polite">1</strong>
        <button class="btn btn-sm btn-dark rounded-pill plus" aria-label="Ø²ÙŠØ§Ø¯Ø©">+</button>
      </div>
      <div class="flex-grow-1 text-truncate text-end">
        <div class="fw-bold name"></div>
        <div class="small">Ã— <span class="unit">0.00</span> Ø±.Ø³</div>
      </div>
      <div class="text-nowrap fw-bold total">0.00 Ø±.Ø³</div>
    </div>
  </template>

  <!-- JS libs -->
  <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/intlTelInputWithUtils.js"></script>

  <!-- App -->
  <script>
  const GAS_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxyGwCUJRwjVfJDtq5bxqN9Thm_KU4zOfNiNt0ENtW2jbDonr_yp3W2xDZCNXkmSHZNLw/exec';
  const FREE_SHIP = 79;

  /* ===== Fallback MENU (so items always show even if backend is empty) ===== */
  const MENU_FALLBACK = [
    { id:'s1', cat:'sushi', title:'Ø³ÙˆØ´ÙŠ Ø³Ù„Ù…ÙˆÙ† ÙƒÙ„Ø§Ø³ÙŠÙƒ', desc:'Ù„ÙØ§Ø¦Ù Ø³Ù„Ù…ÙˆÙ† Ø·Ø§Ø²Ø¬ Ù…Ø¹ Ø®ÙŠØ§Ø± ÙˆØµÙˆØµ Ø®Ø§Øµ', price:32, img:'https://images.unsplash.com/photo-1553621042-f6e147245754?q=80&w=1200&auto=format&fit=crop', tags:['Ø·Ø§Ø²Ø¬','Ø´Ø¹Ø¨ÙŠ'] },
    { id:'s2', cat:'meat',  title:'ÙˆØ§Ø¬ÙŠÙˆ Ø³ØªÙŠÙƒ Ø¯ÙˆÙ†',    desc:'Ø´Ø±Ø§Ø¦Ø­ ÙˆØ§Ø¬ÙŠÙˆ Ø¹Ù„Ù‰ Ø£Ø±Ø² Ø¨Ù†ÙƒÙ‡Ø© ÙŠØ§Ø¨Ø§Ù†ÙŠØ©', price:69, img:'https://images.unsplash.com/photo-1558036117-15d82a90b9b4?q=80&w=1200&auto=format&fit=crop', tags:['ÙˆØ§Ø¬Ùˆ','Ù…Ø´Ø¨Ø¹'] },
    { id:'d1', cat:'don',   title:'ÙƒØ§ØªØ³Ùˆ Ø¯ÙˆÙ†',         desc:'Ø¯Ø¬Ø§Ø¬ Ù…Ù‚Ø±Ù…Ø´ Ù…Ø¹ ØµÙˆØµ Ø¯Ø§Ø´ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø±Ø²', price:44, img:'https://images.unsplash.com/photo-1559847844-5315695dada6?q=80&w=1200&auto=format&fit=crop', tags:['Ù…Ù‚Ø±Ù…Ø´'] },
    { id:'dr1', cat:'drinks',title:'Ø´Ø§ÙŠ Ù…Ø«Ù„Ø¬ ÙŠÙˆØ²Ùˆ',    desc:'Ù…Ù†Ø¹Ø´ Ù…Ø¹ Ù„Ù…Ø³Ø© Ø­Ù…Ø¶ÙŠØ©', price:12, img:'https://images.unsplash.com/photo-1546177461-5e01050dd8c6?q=80&w=1200&auto=format&fit=crop', tags:['Ù…Ù†Ø¹Ø´'] },
  ];

  /* ===== Options Sheet (from your data) -> normalized to groups per item ===== */
  const OPTIONS_SHEET = [
    {ItemId:'s1',GroupKey:'size',GroupLabel:'Ø§Ù„Ø­Ø¬Ù…',GroupType:'radio',Required:'TRUE',ItemValue:'regular',ItemLabel:'Ø¹Ø§Ø¯ÙŠ',Delta:'0',GroupOrder:'1',ItemOrder:'1',Active:'TRUE'},
    {ItemId:'s1',GroupKey:'size',GroupLabel:'Ø§Ù„Ø­Ø¬Ù…',GroupType:'radio',Required:'TRUE',ItemValue:'large', ItemLabel:'ÙƒØ¨ÙŠØ±',Delta:'12',GroupOrder:'1',ItemOrder:'2',Active:'TRUE'},
    {ItemId:'s1',GroupKey:'extras',GroupLabel:'Ø¥Ø¶Ø§ÙØ§Øª',GroupType:'checkbox',Required:'',ItemValue:'wasabi',ItemLabel:'ÙˆØ§Ø³Ø§Ø¨ÙŠ',Delta:'2',GroupOrder:'2',ItemOrder:'1',Active:'TRUE'},
    {ItemId:'s1',GroupKey:'extras',GroupLabel:'Ø¥Ø¶Ø§ÙØ§Øª',GroupType:'checkbox',Required:'',ItemValue:'ginger',ItemLabel:'Ø²Ù†Ø¬Ø¨ÙŠÙ„',Delta:'1',GroupOrder:'2',ItemOrder:'2',Active:'TRUE'},
    {ItemId:'s2',GroupKey:'doneness',GroupLabel:'Ø¯Ø±Ø¬Ø© Ø§Ù„Ù†Ø¶Ø¬',GroupType:'radio',Required:'TRUE',ItemValue:'m', ItemLabel:'Ù…ÙŠØ¯ÙŠÙ…',Delta:'0',GroupOrder:'1',ItemOrder:'1',Active:'TRUE'},
    {ItemId:'s2',GroupKey:'doneness',GroupLabel:'Ø¯Ø±Ø¬Ø© Ø§Ù„Ù†Ø¶Ø¬',GroupType:'radio',Required:'TRUE',ItemValue:'mw',ItemLabel:'Ù…ÙŠØ¯ÙŠÙ… ÙˆÙŠÙ„',Delta:'0',GroupOrder:'1',ItemOrder:'2',Active:'TRUE'},
    {ItemId:'s2',GroupKey:'extras',GroupLabel:'Ø¥Ø¶Ø§ÙØ§Øª',GroupType:'checkbox',Required:'',ItemValue:'egg',ItemLabel:'Ø¨ÙŠØ¶ Ø£ÙˆÙ†Ø³Ù†',Delta:'6',GroupOrder:'2',ItemOrder:'1',Active:'TRUE'},
    {ItemId:'s2',GroupKey:'extras',GroupLabel:'Ø¥Ø¶Ø§ÙØ§Øª',GroupType:'checkbox',Required:'',ItemValue:'truffle',ItemLabel:'ØªØ±ÙÙ„',Delta:'18',GroupOrder:'2',ItemOrder:'2',Active:'TRUE'},
  ];
  function buildOptionsMap(rows){
    const map = {};
    rows.filter(r=>String(r.Active).toLowerCase()==='true').forEach(r=>{
      const id = r.ItemId;
      map[id] = map[id] || { groups:[] };
      let g = map[id].groups.find(x=>x.key===r.GroupKey);
      if(!g){
        g = {
          key: r.GroupKey,
          label: r.GroupLabel || r.GroupKey,
          type: (r.GroupType||'radio').toLowerCase()==='checkbox'?'checkbox':'radio',
          required: String(r.Required||'').toLowerCase()==='true',
          order: Number(r.GroupOrder||99),
          items:[]
        };
        map[id].groups.push(g);
      }
      g.items.push({
        value: r.ItemValue, label: r.ItemLabel||r.ItemValue,
        delta: Number(r.Delta||0), order: Number(r.ItemOrder||99)
      });
    });
    // sort groups/items
    for(const id in map){
      map[id].groups.sort((a,b)=>a.order-b.order);
      map[id].groups.forEach(gr=>gr.items.sort((a,b)=>a.order-b.order));
    }
    return map;
  }
  const OPTIONS_MAP = buildOptionsMap(OPTIONS_SHEET);

  window.addEventListener('DOMContentLoaded', () => {
    const state = { q:'', cart:{}, menu:[], unlockThanks:false, active:'menu' };
    const fmt = new Intl.NumberFormat('ar-SA', { style:'currency', currency:'SAR' });

    /* Sticky helpers */
    const topbarEl   = document.getElementById('topbar');
    const chipsWrap  = document.getElementById('chipsWrap');
    const setStickyVars = () => {
      const topH = Math.round(topbarEl?.getBoundingClientRect().height ?? 56);
      const chipsH = Math.round(chipsWrap?.getBoundingClientRect().height ?? 0);
      document.documentElement.style.setProperty('--topbar-h', topH + 'px');
      document.documentElement.style.setProperty('--chips-h', chipsH + 'px');
    };
    window.addEventListener('resize', setStickyVars, {passive:true});
    window.addEventListener('scroll', ()=>document.body.classList.toggle('scrolled', window.scrollY>6), {passive:true});

    /* Simple tab switcher */
    const tabs=['menu','cart','data','thanks'];
    function canGo(t){ if(t==='menu') return true; if(t==='cart'||t==='data') return cartCount()>0; if(t==='thanks') return state.unlockThanks; return false;}
    function switchTab(to){
      if(!tabs.includes(to)) return;
      if(!canGo(to)){ toast(to==='thanks'?'Ø£ÙƒÙ…Ù„ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ Ø£ÙˆÙ„Ø§Ù‹':'Ø£Ø¶ÙÙ Ø¹Ù†Ø§ØµØ± Ù„Ù„Ø³Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹'); return; }
      document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('show','active'));
      document.getElementById('tab-'+to)?.classList.add('show','active');
      history.replaceState(null,'','#tab-'+to);
      setStickyVars();
    }
    document.body.addEventListener('click', (e)=>{
      const a=e.target.closest('a[href^="#tab-"],[data-go]');
      if(!a) return;
      e.preventDefault();
      const to=a.dataset.go||(a.getAttribute('href')||'').replace('#tab-','');
      switchTab(to);
    });
    document.getElementById('openCart').addEventListener('click', ()=>switchTab('cart'));

    /* DOM refs */
    const chips = document.getElementById('chips');
    const clearFilters=document.getElementById('clearFilters');
    const search=document.getElementById('q');
    const sectionsRoot=document.getElementById('menuSections');
    const emptyMsg=document.getElementById('emptyMsg');
    const dishTpl=document.getElementById('dishTpl');
    const cartList=document.getElementById('cartList');
    const cartLineTpl=document.getElementById('cartLineTpl');
    const badge=document.getElementById('badge');
    const miniCount=document.getElementById('miniCount');
    const miniTotal=document.getElementById('miniTotal');
    const miniHint=document.getElementById('miniHint');
    const goCartBtn=document.getElementById('goCartBtn');
    const toDataBtn=document.getElementById('toDataBtn');
    const cartTotal=document.getElementById('cartTotal');

    /* Fetch Menu with robust fallbacks */
    async function fetchMenu(){
      try{
        const r = await fetch(GAS_WEBAPP_URL+'?action=menu.list', {cache:'no-store'});
        const j = await r.json();
        // Accept several shapes: {ok:true,data:[...]}, {menu:[...]}, or direct []
        let arr = [];
        if (j && Array.isArray(j.data)) arr = j.data;
        else if (j && Array.isArray(j.menu)) arr = j.menu;
        else if (Array.isArray(j)) arr = j;
        // ensure minimal fields exist + attach options from sheet if available
        arr = (arr||[]).map(item => ({
          id:item.id || item.ID || item.sku || cryptoRandomId(),
          cat:(item.cat || item.category || 'sushi').toLowerCase(),
          title:item.title || item.name || 'â€”',
          desc:item.desc || item.description || '',
          price:Number(item.price ?? item.Price ?? 0),
          img:item.img || item.image || '',
          tags:item.tags || []
        }));
        return arr.length ? arr : MENU_FALLBACK.slice();
      } catch(e){
        console.warn('fetchMenu failed, using fallback', e);
        return MENU_FALLBACK.slice();
      }
    }
    function cryptoRandomId(){
      try{ return 'it_'+crypto.getRandomValues(new Uint32Array(1))[0].toString(36) }catch{ return 'it_'+Math.random().toString(36).slice(2) }
    }

    /* Categories order */
    const ORDERED_CATS = [
      {key:'sushi',  label:'Ø³ÙˆØ´ÙŠ',  id:'sec-sushi'},
      {key:'don',    label:'Ø¯ÙˆÙ†',    id:'sec-don'},
      {key:'meat',   label:'Ù„Ø­ÙˆÙ…',   id:'sec-meat'},
      {key:'drinks', label:'Ù…Ø´Ø±ÙˆØ¨Ø§Øª',id:'sec-drinks'}
    ];
    function groupByCat(menu){
      const groups = {};
      menu.forEach(d=>{ const key=(d.cat||'').toLowerCase(); (groups[key] ||= []).push(d); });
      return groups;
    }
    function imgFallback(el){
      el.src='data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="675"><rect width="100%" height="100%" fill="#e9e6df"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#8b877e" font-family="Arial" font-size="28">Ù„Ø§ ØµÙˆØ±Ø©</text></svg>`);
    }

    /* Render sections */
    function renderSections(){
      const q=(state.q||'').trim().toLowerCase();
      const groups = groupByCat(state.menu);
      sectionsRoot.innerHTML='';
      let totalMatches=0;

      ORDERED_CATS.forEach(({key,label,id})=>{
        const items = (groups[key] || []).filter(d=>{
          const inTxt = !q || [d.title||'',d.desc||''].join(' ').toLowerCase().includes(q);
          return inTxt;
        });
        if(!items.length) return;

        const sec = document.createElement('section');
        sec.className = 'menu-section';
        sec.id = id;

        const title = document.createElement('h5');
        title.className = 'sec-title';
        title.textContent = label;
        sec.appendChild(title);

        const grid = document.createElement('div');
        grid.className = 'menu-grid';

        items.forEach(d=>{
          const node=dishTpl.content.firstElementChild.cloneNode(true);
          node.dataset.cat = key;

          const img=node.querySelector('.dish-img');
          img.alt=d.title||''; img.addEventListener('error',()=>imgFallback(img));
          if(d.img && /^https?:\/\//.test(d.img)) img.src=d.img; else imgFallback(img);

          node.querySelector('.title').textContent=d.title||'â€”';
          node.querySelector('.desc').textContent=d.desc||'';
          node.querySelector('.price').textContent=fmt.format(Number(d.price||0));
          const tags=node.querySelector('.tags');
          (d.tags||[]).slice(0,3).forEach(t=>{ const s=document.createElement('span'); s.className='tag'; s.textContent=t; tags.appendChild(s); });

          // If item has options in OPTIONS_MAP -> open modal; else add directly
          node.querySelector('.add-btn').addEventListener('click', ()=> {
            const opts = OPTIONS_MAP[d.id];
            if (opts && Array.isArray(opts.groups) && opts.groups.length){
              openOptions({ ...d, options: opts });
            } else {
              addLine(d,1);
            }
          });

          grid.appendChild(node);
        });

        sec.appendChild(grid);
        sectionsRoot.appendChild(sec);
        totalMatches += items.length;
      });

      // If filter returns nothing at all, tell user
      emptyMsg.classList.toggle('d-none', totalMatches>0);
      clearFilters.classList.toggle('d-none', !state.q.trim());

      setStickyVars();
    }

    /* Chips click -> scroll */
    chips.addEventListener('click',(e)=>{
      const b=e.target.closest('.chip[data-target]');
      if(!b) return;
      document.querySelector(b.dataset.target)?.scrollIntoView({behavior:'smooth', block:'start'});
      chips.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
      b.classList.add('active');
    });

    /* Search */
    let t=null;
    search.addEventListener('input', e=>{
      clearTimeout(t);
      t=setTimeout(()=>{ state.q=e.target.value||''; renderSections(); }, 160);
    });
    clearFilters.addEventListener('click', ()=>{
      state.q=''; search.value='';
      renderSections();
      document.getElementById('topOfMenu').scrollIntoView({behavior:'smooth',block:'start'});
    });

    /* Cart */
    function stableId(str){ let h=0; for(let i=0;i<str.length;i++){ h=((h<<5)-h)+str.charCodeAt(i); h|=0;} return 'l_'+Math.abs(h).toString(36); }
    function cartArr(){ return Object.values(state.cart); }
    function totals(){ const arr=cartArr(); return {count:arr.reduce((a,b)=>a+b.qty,0), total:arr.reduce((a,b)=>a+b.qty*b.unitPrice,0), arr}; }
    function bump(){
      const t=totals();
      badge.textContent=t.count; miniCount.textContent=`${t.count} Ø¹Ù†ØµØ±`; miniTotal.textContent=fmt.format(t.total); cartTotal.textContent=fmt.format(t.total);
      const need=Math.max(0, FREE_SHIP - t.total);
      miniHint.textContent = need>0 ? `ØªØ¨Ù‚Ù‰ ${fmt.format(need)} Ù„Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ ğŸ` : `ğŸ Ø­ØµÙ„Øª Ø¹Ù„Ù‰ ØªÙˆØµÙŠÙ„ Ù…Ø¬Ø§Ù†ÙŠ`;
      localStorage.setItem('hk_cart_v3', JSON.stringify(state.cart));
      const has=t.count>0; goCartBtn.classList.toggle('disabled',!has); goCartBtn.setAttribute('aria-disabled',String(!has)); toDataBtn.classList.toggle('disabled',!has); toDataBtn.setAttribute('aria-disabled',String(!has));
      renderCartList();
    }
    function addLine(item, qty=1, optionsPkg){
      const key=stableId(JSON.stringify({id:item.id, price:item.price, opt:optionsPkg||null}));
      const exist=state.cart[key];
      const unit = Number(item.price||0) + Number(optionsPkg?.delta||0);
      if(exist) exist.qty+=qty;
      else state.cart[key]={lineId:key, id:item.id, title:item.title, unitPrice:unit, qty, optionsText:optionsPkg?.summary||''};
      bump(); toast(`Ø£ÙØ¶ÙŠÙ ${item.title} âœ…`);
    }
    function renderCartList(){
      cartList.innerHTML='';
      const {arr}=totals();
      if(!arr.length){ const p=document.createElement('p'); p.className='text-secondary text-center my-4'; p.style.color='#4a4741'; p.textContent='Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©'; cartList.appendChild(p); return; }
      arr.forEach(it=>{
        const row=cartLineTpl.content.firstElementChild.cloneNode(true);
        row.querySelector('.name').textContent=it.title + (it.optionsText ? ' â€” ' + it.optionsText : '');
        row.querySelector('.unit').textContent=Number(it.unitPrice||0).toFixed(2);
        row.querySelector('.qty').textContent=it.qty;
        row.querySelector('.total').textContent=fmt.format(it.qty*it.unitPrice);
        row.querySelector('.minus').addEventListener('click', ()=>{ if(state.cart[it.lineId].qty>1) state.cart[it.lineId].qty--; else delete state.cart[it.lineId]; bump(); });
        row.querySelector('.plus').addEventListener('click',  ()=>{ state.cart[it.lineId].qty++; bump(); });
        cartList.appendChild(row);
      });
    }
    const saved=localStorage.getItem('hk_cart_v3'); if(saved){ try{ state.cart=JSON.parse(saved)||{}; }catch{} }

    /* Toast */
    function toast(msg){
      const box=document.getElementById('toasts'); const el=document.createElement('div'); el.className='toast-msg'; el.textContent=msg;
      box.appendChild(el); setTimeout(()=>{el.style.opacity='0'; el.style.transform='translateY(-6px)'; setTimeout(()=>el.remove(),180);},2200);
    }

    /* ===== Options Modal Wiring ===== */
    const optModal = new bootstrap.Modal(document.getElementById('optModal'));
    const optForm  = document.getElementById('optForm');
    const optPriceEl=document.getElementById('optPrice');
    const optQtyEl  =document.getElementById('optQty');
    const optSummary= document.getElementById('optSummary');
    let currentItem=null, currentBase=0;

    function buildOptionsUI(groups){
      optForm.innerHTML='';
      groups.forEach(group=>{
        const wrap=document.createElement('div');
        const label=document.createElement('div'); label.className='fw-bold mb-1'; label.textContent=group.label+(group.required?' *':''); wrap.appendChild(label);

        if(group.type==='radio'){
          group.items.forEach((it,idx)=>{
            const id=`${group.key}-${idx}-${Date.now()}`;
            const div=document.createElement('div'); div.className='form-check';
            div.innerHTML=`<input class="form-check-input" type="radio" name="${group.key}" id="${id}" value="${it.value}" ${idx===0?'checked':''}>
              <label class="form-check-label" for="${id}">${it.label}${it.delta?` (+${it.delta} Ø±.Ø³)`:''}</label>`;
            wrap.appendChild(div);
          });
        } else { // checkbox
          group.items.forEach((it,idx)=>{
            const id=`${group.key}-${idx}-${Date.now()}`;
            const div=document.createElement('div'); div.className='form-check';
            div.innerHTML=`<input class="form-check-input" type="checkbox" name="${group.key}" id="${id}" value="${it.value}">
              <label class="form-check-label" for="${id}">${it.label}${it.delta?` (+${it.delta} Ø±.Ø³)`:''}</label>`;
            wrap.appendChild(div);
          });
        }
        optForm.appendChild(wrap);
      });
    }
    function parseSelected(groups){
      let delta=0; const summary=[];
      const result={};
      groups.forEach(group=>{
        if(group.type==='radio'){
          const chosen=optForm.querySelector(`input[name="${group.key}"]:checked`);
          if(chosen){
            const meta=group.items.find(x=>x.value===chosen.value);
            if(meta){ delta+=Number(meta.delta||0); summary.push(`${group.label}: ${meta.label}`); }
            result[group.key]=chosen.value;
          } else if(group.required && group.items[0]){
            const meta=group.items[0]; delta+=Number(meta.delta||0);
            summary.push(`${group.label}: ${meta.label}`); result[group.key]=meta.value;
          }
        } else {
          const list=[...optForm.querySelectorAll(`input[name="${group.key}"]:checked`)];
          result[group.key]=list.map(x=>x.value);
          list.forEach(ch=>{ const m=group.items.find(x=>x.value===ch.value); if(m) delta+=Number(m.delta||0); });
          if(result[group.key].length){
            const labels=result[group.key].map(v=>{ const m=group.items.find(x=>x.value===v); return m?m.label:v; }).join('ØŒ ');
            summary.push(`${group.label}: ${labels}`);
          }
        }
      });
      return {delta, summary: summary.join(' â€¢ '), result};
    }
    function updateOptPrice(){
      if(!currentItem) return;
      const {delta} = parseSelected(currentItem.options.groups);
      const unit=currentBase + delta;
      const qty=Math.max(1, Number(optQtyEl.value||1));
      optPriceEl.textContent = new Intl.NumberFormat('ar-SA',{style:'currency',currency:'SAR'}).format(unit*qty);
    }
    document.getElementById('optMinus').onclick=()=>{ optQtyEl.value=Math.max(1,Number(optQtyEl.value||1)-1); updateOptPrice(); };
    document.getElementById('optPlus').onclick =()=>{ optQtyEl.value=Math.max(1,Number(optQtyEl.value||1)+1); updateOptPrice(); };
    optForm.addEventListener('change', updateOptPrice);
    optQtyEl.addEventListener('input', updateOptPrice);

    function openOptions(item){
      currentItem=item; currentBase=Number(item.price||0);
      document.getElementById('optTitle').textContent=`Ø®ÙŠØ§Ø±Ø§Øª ${item.title}`;
      optSummary.textContent=item.desc||'';
      optQtyEl.value=1; document.getElementById('optNotes').value='';
      buildOptionsUI(item.options.groups);
      updateOptPrice();
      optModal.show();
    }
    document.getElementById('optAddBtn').onclick=()=>{
      if(!currentItem) return;
      const {delta, summary, result} = parseSelected(currentItem.options.groups);
      const qty=Math.max(1, Number(optQtyEl.value||1));
      const notes=(document.getElementById('optNotes').value||'').trim();
      addLine(currentItem, qty, {delta, summary, result, notes});
      optModal.hide();
    };

    /* Data form + confirm (minimal) */
    const segPickBtn=null, segDelBtn=null; // simplified (pickup only)
    const nameEl=document.getElementById('custName');
    const phoneEl=document.getElementById('custPhone');
    const notesEl=document.getElementById('notes');
    const confirmBtn=document.getElementById('confirmBtn');
    const iti=window.intlTelInput(phoneEl,{ initialCountry:'sa', onlyCountries:['sa','ae','bh','kw','om','qa'], separateDialCode:true });

    notesEl.addEventListener('input', ()=>{ document.getElementById('notesCount').textContent=(notesEl.value||'').length; });
    function validate(){
      const nameOk=(nameEl.value||'').trim().length>1;
      let phoneOk=false; try{ phoneOk=iti.isValidNumber(); }catch(_){ phoneOk=(phoneEl.value||'').trim().length>=8; }
      document.getElementById('err-name').classList.toggle('d-none',nameOk);
      document.getElementById('ok-phone').classList.toggle('d-none',!phoneOk);
      document.getElementById('err-phone').classList.toggle('d-none',phoneOk);
      return nameOk && phoneOk;
    }
    ['input','blur'].forEach(ev=>{
      nameEl.addEventListener(ev, validate);
      phoneEl.addEventListener(ev, ()=>setTimeout(validate, ev==='blur'?0:120));
    });

    async function createOrder(payload){
      try{
        const r=await fetch(GAS_WEBAPP_URL+'?action=order.create',{ method:'POST', headers:{'Content-Type':'text/plain'}, body:JSON.stringify(payload) });
        return await r.json();
      }catch{ return {ok:false}; }
    }
    const thOrderId=document.getElementById('thOrderId');
    const thTotal=document.getElementById('thTotal');
    const thType=document.getElementById('thType');
    const thTicket=document.getElementById('thTicket');
    const thDate=document.getElementById('thDate');
    function todayKey(){
      const d=new Date(); const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }
    function setThankDate(){ const d=new Date(); thDate.textContent=d.toLocaleDateString('ar-SA',{ weekday:'short', year:'numeric', month:'2-digit', day:'2-digit'}); }
    function nextDailyTicketLocal(){
      const key=todayKey(); const savedDay=localStorage.getItem('hk_ticket_day'); let seq=Number(localStorage.getItem('hk_ticket_seq')||0);
      if(savedDay!==key) seq=0; seq=(seq%9999)+1; localStorage.setItem('hk_ticket_day',key); localStorage.setItem('hk_ticket_seq',String(seq)); return String(seq).padStart(4,'0');
    }
    async function copy(text){ try{ await navigator.clipboard.writeText(text); toast('ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…'); }catch{ toast('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ù†Ø³Ø®'); } }

    confirmBtn.onclick=async()=>{
      const t=totals();
      if(t.count===0){ toast('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©'); switchTab('menu'); return; }
      if(!validate()){ window.scrollTo({top:0,behavior:'smooth'}); toast('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©'); return; }

      let phone=phoneEl.value.trim(); try{ phone=iti.getNumber(); }catch(_){}
      const payload={
        type:'pickup',
        name: nameEl.value.trim(), phone, address:'', notes: notesEl.value.trim(),
        items: t.arr.map(x=>({ id:x.id, title:x.title, qty:x.qty, price:x.unitPrice, optionsText:x.optionsText }))
      };

      confirmBtn.disabled=true;
      document.getElementById('submitLoading').classList.add('show');
      try{
        const res=await createOrder(payload);
        // Even if backend fails, show local ticket to unblock UX
        const orderId = (res && res.ok && res.orderId) ? res.orderId : ('L-' + Math.random().toString(36).slice(2,8).toUpperCase());
        thOrderId.textContent = orderId;
        thTotal.textContent = fmt.format(t.total);
        thType.textContent  = 'Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨: Ø§Ø³ØªÙ„Ø§Ù…';
        thTicket.textContent = nextDailyTicketLocal(); setThankDate();
        document.getElementById('copyTicket').onclick = ()=>copy(`ØªØ°ÙƒØ±Ø© ${thTicket.textContent} â€¢ ${todayKey()}`);
        document.getElementById('copySummary').onclick = ()=>copy(`Ø·Ù„Ø¨ Maison Hikari\nØªØ°ÙƒØ±Ø©: ${thTicket.textContent}\n${thType.textContent}\nØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${thTotal.textContent}`);
        state.cart={}; bump();
        state.unlockThanks = true; switchTab('thanks');
      } finally{
        confirmBtn.disabled=false;
        document.getElementById('submitLoading').classList.remove('show');
      }
    };

    /* INIT */
    (async()=>{
      document.getElementById('appLoading').classList.add('show');
      state.menu = await fetchMenu();
      // Attach options to matching items from OPTIONS_MAP
      state.menu = state.menu.map(it => (OPTIONS_MAP[it.id] ? {...it, options: OPTIONS_MAP[it.id]} : it));
      renderSections(); bump(); setStickyVars();
      document.getElementById('appLoading').classList.remove('show');
    })();
  });
  </script>
</body>
</html>
